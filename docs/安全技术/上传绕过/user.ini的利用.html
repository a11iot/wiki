<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="userini的利用"><span class="csDE05BCC">user.ini</span><span class="csECDA2D3">的利用</span></a></h1>
		<h2 class="cs868C439D">
			<a name="前言"><span class="cs83F14626">前言</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在前段时间</span><span class="cs8926E06">SUCTF 2019</span><span class="cs9C1B1871">的比赛中做了一道名为</span><span class="cs8926E06">CheckIn</span><span class="cs9C1B1871">的文件上传题，学到了一种新的利用姿势</span><span class="cs8926E06">&mdash;&mdash;.user.ini</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">原题的链接已经失效了，但</span><span class="cs8926E06">SU</span><span class="cs9C1B1871">的师傅们把题目源码贴在</span><span class="cs8926E06">GitHub</span><span class="cs9C1B1871">上了（感谢师傅们！！），如果想尝试的话可以下载源码复现，在这里放一下地址：</span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="https://github.com/team-su/SUCTF-2019"><span class="cs4B51D5E4">https://github.com/team-su/SUCTF-2019</span></a></span></p><h2 class="cs868C439D">
			<a name="checkin题目分析"><span class="csB2D98684">CheckIn</span><span class="cs83F14626">题目分析</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先我们来看一下题目，首页就是一个简单的上传界面：</span></p><p class="cs40DD2BC9"><span><img src="安全技术/上传绕过/user.ini%e7%9a%84%e5%88%a9%e7%94%a8_files/image0.png" width="560" height="192" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们先上传一个</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件试一下，显然是</span><span class="cs8926E06">illegal</span><span class="cs9C1B1871">的</span></p><p class="cs40DD2BC9"><span><img src="安全技术/上传绕过/user.ini%e7%9a%84%e5%88%a9%e7%94%a8_files/image1.png" width="560" height="452" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">经过</span><span class="cs8926E06">fuzz</span><span class="cs9C1B1871">发现修改</span><span class="cs8926E06">content-type</span><span class="cs9C1B1871">和利用特殊扩展名</span><span class="cs8926E06">php5</span><span class="cs9C1B1871">、</span><span class="cs8926E06">pht</span><span class="cs9C1B1871">等都没有成功（当然也不会这么简单</span><span class="cs8926E06">233</span><span class="cs9C1B1871">）</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后我们把扩展名改为</span><span class="cs8926E06">aaa</span><span class="cs9C1B1871">试一下会怎样，发现回显：</span><span class="cs8926E06">&lt;? in contents!</span><span class="cs9C1B1871">，那么就是说文件内容不能包含</span><span class="cs8926E06">&lt;?</span><span class="cs9C1B1871">喽，但我们此时知道它是黑名单过滤了。</span></p><p class="cs40DD2BC9"><span><img src="安全技术/上传绕过/user.ini%e7%9a%84%e5%88%a9%e7%94%a8_files/image2.png" width="560" height="449" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们再把文件内容换一下，发现回显：</span><span class="cs8926E06">exif_imagetype:not image!</span><span class="cs9C1B1871">，猜测后端应该调用了</span><span class="cs8926E06">php</span><span class="cs9C1B1871">的</span><span class="cs8926E06">exif_imagetype()</span><span class="cs9C1B1871">函数，这个很好绕过，添加图片文件头就可以了</span></p><p class="cs40DD2BC9"><span><img src="安全技术/上传绕过/user.ini%e7%9a%84%e5%88%a9%e7%94%a8_files/image3.png" width="560" height="450" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们添加最简单的</span><span class="cs8926E06">gif</span><span class="cs9C1B1871">文件头</span><span class="cs8926E06">GIF89a</span><span class="cs9C1B1871">，发现上传成功（注意看该文件夹下还有一个</span><span class="cs8926E06">index.php</span><span class="cs9C1B1871">，当时没有注意，但在后面有大用处）</span></p><p class="cs40DD2BC9"><span><img src="安全技术/上传绕过/user.ini%e7%9a%84%e5%88%a9%e7%94%a8_files/image4.png" width="560" height="450" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们先来捋一下思路：</span></p><p class="cs3A447A38"><span class="cs9FB05234">-&gt; </span><span class="cs7FFD2630">上传过滤为黑名单，但</span><span class="cs9FB05234">php</span><span class="cs7FFD2630">脚本文件应该是无法上传的</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">-&gt; </span><span class="cs7FFD2630">存在文件头过滤，需要添加图片文件的文件头</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">-&gt; </span><span class="cs7FFD2630">文件的内容不能包含</span><span class="cs9FB05234">&lt;?</span><span class="cs7FFD2630">，但可以上传</span><span class="cs9FB05234">&lt;script language=&#39;php&#39;&gt;&lt;scirpt&gt;</span><span class="cs7FFD2630">类型的图片马来绕过</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">既然是黑名单过滤而且可以上传图片马，那我们首先想到的肯定是传一个</span><span class="cs8926E06">.htaccess</span><span class="cs9C1B1871">上去来将图片马解析为</span><span class="cs8926E06">php</span><span class="cs9C1B1871">，而这种方法经过尝试发现失败了。。。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">看了一下服务器是</span><span class="cs8926E06">nginx 1.10.3</span><span class="cs9C1B1871">，似乎版本较高，不存在解析漏洞。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">随后在网上看到了一篇</span><span class="cs8926E06">p</span><span class="cs9C1B1871">牛的文章，讲的是利用</span><span class="cs8926E06">.user.ini</span><span class="cs9C1B1871">来上传</span><span class="cs8926E06">php</span><span class="cs9C1B1871">后门</span></p><h2 class="cs868C439D">
			<a name="userini"><span class="csB2D98684">.user.ini</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们先在</span><span class="cs8926E06">php</span><span class="cs9C1B1871">手册上看一下对</span><span class="cs8926E06">.user.ini</span><span class="cs9C1B1871">的介绍：</span></p><p class="cs40DD2BC9"><span><img src="安全技术/上传绕过/user.ini%e7%9a%84%e5%88%a9%e7%94%a8_files/image5.png" width="560" height="217" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">大致意思就是：我们指定一个文件（如</span><span class="cs8926E06">a.jpg</span><span class="cs9C1B1871">），那么该文件就会被包含在要执行的</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件中（如</span><span class="cs8926E06">index.php</span><span class="cs9C1B1871">），类似于在</span><span class="cs8926E06">index.php</span><span class="cs9C1B1871">中插入一句：</span><span class="cs8926E06">require(./a.jpg);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这两个设置的区别只是在于</span><span class="cs8926E06">auto_prepend_file</span><span class="cs9C1B1871">是在文件前插入；</span><span class="cs8926E06">auto_append_file</span><span class="cs9C1B1871">在文件最后插入（当文件调用的有</span><span class="cs8926E06">exit()</span><span class="cs9C1B1871">时该设置无效）</span></p><h2 class="cs868C439D">
			<a name="寻找突破getflag"><span class="cs83F14626">寻找突破</span><span class="csB2D98684">getflag</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">看过</span><span class="cs8926E06">.user.ini</span><span class="cs9C1B1871">的分析后我们的思路应该比较清晰了，我们可以上传一个这样的</span><span class="cs8926E06">.user.ini</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">GIF89a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">auto_prepend_file=a.jpg</span></p><p class="cs40DD2BC9"><span><img src="安全技术/上传绕过/user.ini%e7%9a%84%e5%88%a9%e7%94%a8_files/image6.png" width="560" height="195" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此时我们注意到上传目录下还有一个</span><span class="cs8926E06">index.php</span><span class="cs9C1B1871">，我们正好需要该目录下有一个可执行</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件，那这简直暴露了考点就是</span><span class="cs8926E06">.user.ini</span><span class="cs9C1B1871">，看来这个思路应该是可行的</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后再上传一个这样的图片马</span><span class="cs8926E06">a.jpg</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">GIF89a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;script language=&#39;php&#39;&gt;system(&#39;cat /flag&#39;);&lt;/script&gt;</span></p><p class="cs40DD2BC9"><span><img src="安全技术/上传绕过/user.ini%e7%9a%84%e5%88%a9%e7%94%a8_files/image7.png" width="560" height="451" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后，我们访问</span><span class="cs8926E06"><a class="cs508254C" href="http://192.168.177.152:9021/uploads/6683eb5bfa1174bd139499256f60b7ab/index.php"><span class="cs4B51D5E4">http://192.168.177.152:9021/uploads/6683eb5bfa1174bd139499256f60b7ab/index.php</span></a></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">即可得到</span><span class="cs8926E06">flag</span></p><h2 class="cs868C439D">
			<a name="userini实战利用的可能性"><span class="csB2D98684">.user.ini</span><span class="cs83F14626">实战利用的可能性</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">综上所述</span><span class="cs8926E06">.user.ini</span><span class="cs9C1B1871">的利用条件如下：</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">服务器脚本语言为</span><span class="cs8926E06">PHP </span><span class="cs9C1B1871">服务器使用</span><span class="cs8926E06">CGI</span><span class="cs9C1B1871">／</span><span class="cs8926E06">FastCGI</span><span class="cs9C1B1871">模式</span><span class="cs8926E06"> </span><span class="cs9C1B1871">上传目录下要有可执行的</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件</span><span class="cs8926E06"> </span><span class="cs9C1B1871">从这来看</span><span class="cs8926E06">.user.ini</span><span class="cs9C1B1871">要比</span><span class="cs8926E06">.htaccess</span><span class="cs9C1B1871">的应用范围要广一些，毕竟</span><span class="cs8926E06">.htaccess</span><span class="cs9C1B1871">只能用于</span><span class="cs8926E06">Apache</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但仔细推敲我们就会感到</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">上传目录下要有可执行的</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">这个要求在文件上传中也比较苛刻，应该没有天才开发者会把上传文件放在主目录或者把</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件放在上传文件夹。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但也不是全无办法，如果我们根据实际情况配合其他漏洞使用可能会有奇效，前段时间我遇到一个</span><span class="cs8926E06">CMS</span><span class="cs9C1B1871">对上传时的路径没有检测</span><span class="cs8926E06">../</span><span class="cs9C1B1871">，因此导致文件可被上传至任意目录，这种情况下我们就很有可能可以利用</span><span class="cs8926E06">.user.ini</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">除此之外，把</span><span class="cs8926E06">.user.ini</span><span class="cs9C1B1871">利用在隐藏后门上应该是个很好的利用方法，我们在存在</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件的目录下留下</span><span class="cs8926E06">.user.ini</span><span class="cs9C1B1871">和我们的图片马，这样就达</span></p></body>
</html>
