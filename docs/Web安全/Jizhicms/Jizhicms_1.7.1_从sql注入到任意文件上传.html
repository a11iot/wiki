<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="jizhicms-171-从sql注入到任意文件上传"><span class="csDE05BCC">Jizhicms 1.7.1 </span><span class="csECDA2D3">从</span><span class="csDE05BCC">sql</span><span class="csECDA2D3">注入到任意文件上传</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Jizhicms 1.7.1</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">从回显可以明确的看到这是一个报错注入，如果没有回显报错的话，为了查看是否进行了</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">语句的拼接可以去查看</span><span class="cs8926E06">mysql</span><span class="cs9C1B1871">的</span><span class="cs8926E06">log</span><span class="cs9C1B1871">日志</span><span class="cs8926E06">,</span><span class="cs9C1B1871">可以通过</span><span class="cs8926E06">Navicat</span><span class="cs9C1B1871">的日志功能去查看</span><span class="cs8926E06"><br/><img src="Web安全/Jizhicms/Jizhicms%201.7.1%20%e4%bb%8esql%e6%b3%a8%e5%85%a5%e5%88%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image0.png" width="560" height="58" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">在对</span><span class="cs8926E06">CMS</span><span class="cs9C1B1871">不是很熟悉的情况下可以通过搜索关键字来定位大概的漏洞位置，</span><span class="cs8926E06">customurl</span><span class="cs9C1B1871">成功的引起了我的注意，这是表的名字，经过简单判断，定位到函数位置为</span><span class="cs8926E06"><br/>/Home/c/HomeController.php</span><span class="cs9C1B1871">中</span><span class="cs8926E06">342-355</span><span class="cs9C1B1871">行中，用户传入参数</span><span class="cs8926E06">url</span><span class="cs9C1B1871">然后进入到</span><span class="cs8926E06">find</span><span class="cs9C1B1871">函数中处理</span><span class="cs8926E06"><br/><img src="Web安全/Jizhicms/Jizhicms%201.7.1%20%e4%bb%8esql%e6%b3%a8%e5%85%a5%e5%88%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image1.png" width="560" height="237" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">跟进到</span><span class="cs8926E06">find</span><span class="cs9C1B1871">函数中，位于</span><span class="cs8926E06">/FrPHP/lib/Model.php</span><span class="cs9C1B1871">，</span><span class="cs8926E06">find</span><span class="cs9C1B1871">函数主要去调用</span><span class="cs8926E06">findAll</span><span class="cs9C1B1871">函数去拼接执行</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">语句</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function find($where=null,$order=null,$fields=null,$limit=1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $record = $this-&gt;findAll($where, $order, $fields, 1) ){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return array_pop($record);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return FALSE;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里看代码看的头疼，为了直观展示代码的执行过程可以用</span><span class="cs8926E06">phpstorm</span><span class="cs9C1B1871">配合</span><span class="cs8926E06">xdebug</span><span class="cs9C1B1871">的方式去调试</span><span class="cs8926E06">php</span><span class="cs9C1B1871">代码，可以看到将我们传入的参数直接带入查询，然后调用</span><span class="cs8926E06">getArray</span><span class="cs9C1B1871">函数去执行</span><span class="cs8926E06"><br/><img src="Web安全/Jizhicms/Jizhicms%201.7.1%20%e4%bb%8esql%e6%b3%a8%e5%85%a5%e5%88%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image2.png" width="560" height="236" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">public function findAll($conditions=null,$order=null,$fields=null,$limit=null)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.....</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.....</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!empty($limit))$where .= &quot; LIMIT {$limit}&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fields = empty($fields) ? &quot;*&quot; : $fields;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$table = self::$table;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql = &quot;SELECT {$fields} FROM {$table} {$where}&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $this-&gt;db-&gt;getArray($sql);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06"> /FrPHP/db/DBholder.php</span><span class="cs9C1B1871">中</span><span class="cs8926E06">, getArray</span><span class="cs9C1B1871">函数调用</span><span class="cs8926E06">query</span><span class="cs9C1B1871">函数，如果有错误将输出错误信息</span><span class="cs8926E06"><br/><img src="Web安全/Jizhicms/Jizhicms%201.7.1%20%e4%bb%8esql%e6%b3%a8%e5%85%a5%e5%88%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image3.png" width="560" height="385" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在接下来发现该</span><span class="cs8926E06">CMS</span><span class="cs9C1B1871">允许上传的文件类型是保存在数据库中的</span><span class="cs8926E06"><br/><img src="Web安全/Jizhicms/Jizhicms%201.7.1%20%e4%bb%8esql%e6%b3%a8%e5%85%a5%e5%88%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image4.png" width="560" height="44" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">通过数据库写入到缓存文件，在使用时从缓存文件中去看上传的类型是不是缓存文件中允许的，如果是则允许上传。那可以通过</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入漏洞更新下数据库，写入允许上传的后缀</span><span class="cs8926E06">php,</span><span class="cs9C1B1871">即可实现</span><span class="cs8926E06">getshell<br/><img src="Web安全/Jizhicms/Jizhicms%201.7.1%20%e4%bb%8esql%e6%b3%a8%e5%85%a5%e5%88%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image5.png" width="560" height="110" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">然后登陆后台清空缓存让网站重新获得新的缓存，然后上传</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件。看到上传成功了</span><span class="cs8926E06"><br/><img src="Web安全/Jizhicms/Jizhicms%201.7.1%20%e4%bb%8esql%e6%b3%a8%e5%85%a5%e5%88%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image6.png" width="560" height="265" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">既然是代码审计，我们也来跟下网站获取上传类型的方式</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">在</span><span class="cs8926E06">/A/c/CommonController.php </span><span class="cs9C1B1871">中</span><span class="cs8926E06">uploads</span><span class="cs9C1B1871">函数中是从</span><span class="cs8926E06">webconf</span><span class="cs9C1B1871">中获得的</span><span class="cs8926E06">fileType</span><span class="cs9C1B1871">的值</span></p><p class="cs3A447A38"><span class="cs9FB05234">$fileType = $this-&gt;webconf[&#39;fileType&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(strpos($fileType,strtolower($pix))===false){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data[&#39;error&#39;] = &nbsp;&quot;Error: </span><span class="cs7FFD2630">文件类型不允许上传！</span><span class="cs9FB05234">&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data[&#39;code&#39;] = 1002;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JsonReturn($data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">webconf</span><span class="cs9C1B1871">函数位于</span><span class="cs8926E06">/Conf/Functions.php</span><span class="cs9C1B1871">中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">通过调用</span><span class="cs8926E06">getCache</span><span class="cs9C1B1871">函数来获取相关的值</span></p><p class="cs3A447A38"><span class="cs9FB05234">function webConf($str=null){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//v1.3 </span><span class="cs7FFD2630">取消文件存储</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//$web_config = include(APP_PATH.&#39;Conf/webconf.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$webconfig = getCache(&#39;webconfig&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">getCache</span><span class="cs9C1B1871">函数位于</span><span class="cs8926E06">/FrPHP/common/Functions.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">function getCache($str=false){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!$str){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">获取</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$s = md5($str).&#39;frphp&#39;.md5($str);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cache_file_data = APP_PATH.&#39;cache/data/&#39;.$s.&#39;.php&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!file_exists($cache_file_data)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$last_time = filemtime($cache_file_data);//</span><span class="cs7FFD2630">创建文件时间</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$res = file_get_contents($cache_file_data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$res = substr($res,14);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$data = json_decode($res,true);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(($data[&#39;frcache_time&#39;]+$last_time)&lt;time() &amp;&amp; $data[&#39;frcache_time&#39;]&gt;=0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unlink($cache_file_data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $data[&#39;frcache_data&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">getCache</span><span class="cs9C1B1871">从</span><span class="cs8926E06">/cache/data/</span><span class="cs9C1B1871">中获取相关的值</span><span class="cs8926E06"> </span><span class="cs9C1B1871">缓存文件的名字为</span><span class="cs8926E06">md5(webconfig).&#39;frphp&#39;.md5(webconfig)<br/></span><span class="cs9C1B1871">可以看到已经成功缓存</span><span class="cs8926E06">,php</span><span class="cs9C1B1871">为允许上传的类型</span><span class="cs8926E06"><br/><img src="Web安全/Jizhicms/Jizhicms%201.7.1%20%e4%bb%8esql%e6%b3%a8%e5%85%a5%e5%88%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image7.png" width="560" height="134" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7775#toc-2</span></p></body>
</html>
