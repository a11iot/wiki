<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="phpcms-v960-任意文件上传"><span class="csDE05BCC">Phpcms v9.6.0 </span><span class="csECDA2D3">任意文件上传</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Phpcms v9.6.0</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">这个漏洞存在于用户注册处。这里有一个可控变量</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$_POST[&#39;info&#39;]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">传入了</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">member_input</span><span class="cs8926E06"> </span><span class="cs9C1B1871">类的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">get</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法中，跟进该方法。</span><span class="cs8926E06">(</span><span class="cs9C1B1871">下图对应文件位置：</span><span class="cs8926E06">phpcms/modules/member/index.php)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.0%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image0.png" width="560" height="170" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">get</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法中，我们发现</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$data</span><span class="cs8926E06"> </span><span class="cs9C1B1871">变量来自</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$_POST[&#39;info&#39;]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，并且我们可以调用</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">member_input</span><span class="cs8926E06"> </span><span class="cs9C1B1871">类的所有方法（对应下图</span><span class="cs8926E06"> </span><span class="csE3F655E4">第</span><span class="cs5BEC2C28">47-48</span><span class="csE3F655E4">行</span><span class="cs8926E06"> </span><span class="cs9C1B1871">代码）。</span><span class="cs8926E06">(</span><span class="cs9C1B1871">下图对应文件位置：</span><span class="cs8926E06">caches/caches_model/caches_data/member_input.class.php)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.0%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image1.png" width="560" height="325" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">看了一下</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">member_input</span><span class="cs8926E06"> </span><span class="cs9C1B1871">类的所有方法，只有一个</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">editor</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法比较好利用，而本次漏洞正是利用到这个方法。在这个方法中，调用了</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">attachment</span><span class="cs8926E06"> </span><span class="cs9C1B1871">类的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">download</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法。</span><span class="cs8926E06">(</span><span class="cs9C1B1871">下图对应文件位置：</span><span class="cs8926E06">caches/caches_model/caches_data/member_input.class.php)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.0%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image2.png" width="560" height="235" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">download</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法中，程序先使用正则对图片</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">URL</span><span class="cs8926E06"> </span><span class="cs9C1B1871">进行匹配，其中</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">$ext</span><span class="cs8926E06"> </span><span class="cs9C1B1871">只允许为</span><span class="cs5BEC2C28">gif|jpg|jpeg|bmp|png</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，而我们使用</span><span class="cs8926E06"> <a class="cs508254C" href="http://xxxx/1.php?a.jpg"><span class="csD1E291E2">http://xxxx/1.php?a.jpg</span></a></span><span class="cs8926E06"> </span><span class="cs9C1B1871">或者</span><span class="cs8926E06"> <a class="cs508254C" href="http://xxxx/1.php#a.jpg"><span class="csD1E291E2">http://xxxx/1.php#a.jpg</span></a></span><span class="cs8926E06"> </span><span class="cs9C1B1871">即可绕过正则。</span><span class="cs8926E06">(</span><span class="cs9C1B1871">下图对应文件位置：</span><span class="cs8926E06">phpcms/libs/classes/attachment.class.php)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.0%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image3.png" width="560" height="196" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着又使用</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">fillurl</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法对匹配到的远程图片地址进行处理，其实就是将</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">#</span><span class="cs8926E06"> </span><span class="cs9C1B1871">号之后的字符全部去除，例如</span><span class="cs8926E06"> <a class="cs508254C" href="http://xxxx/1.php#a.jpg"><span class="csD1E291E2">http://xxxx/1.php#a.jpg</span></a></span><span class="cs8926E06"> </span><span class="cs9C1B1871">会被处理成</span><span class="cs8926E06"> <a class="cs508254C" href="http://xxxx/1.php"><span class="csD1E291E2">http://xxxx/1.php</span></a></span><span class="cs8926E06"> </span><span class="cs9C1B1871">。</span><span class="cs8926E06">(</span><span class="cs9C1B1871">下图对应文件位置：</span><span class="cs8926E06">phpcms/libs/classes/attachment.class.php)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.0%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image4.png" width="560" height="244" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">fillurl</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法处理后，又回到了</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">download</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法。程序直接调用</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">copy</span><span class="cs8926E06"> </span><span class="cs9C1B1871">函数将远程文件复制到本地（对应下图</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">161</span><span class="cs8926E06"> </span><span class="cs9C1B1871">行代码），远程文件名可预测，后缀名为上边处理后的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">URL</span><span class="cs8926E06"> </span><span class="cs9C1B1871">文件名后缀，即</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">php</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，最终导致</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">getshell</span><span class="cs8926E06"> </span><span class="cs9C1B1871">。其中</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">webshell</span><span class="cs8926E06"> </span><span class="cs9C1B1871">地址为</span><span class="cs8926E06"> <a class="cs508254C" href="http://website/uploadfile/date('Y/md/')/date('Ymdhis').rand(100"><span class="csD1E291E2">http://website/uploadfile/date(&#39;Y/md/&#39;)/date(&#39;Ymdhis&#39;).rand(100</span></a></span><span class="cs5BEC2C28">, 999).&#39;.&#39;.$fileext</span><span class="cs8926E06"> </span><span class="cs9C1B1871">。</span><span class="cs8926E06">(</span><span class="cs9C1B1871">下图对应文件位置：</span><span class="cs8926E06">phpcms/libs/classes/attachment.class.php)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.0%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image5.png" width="560" height="284" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后我们再来看一下在官方发布的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">PHPCMS v9.6.1</span><span class="cs8926E06"> </span><span class="cs9C1B1871">中是如何修复这个漏洞的，代码具体如下。可以明确看到，在官方补丁中，对</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">fileext($file)</span><span class="cs8926E06"> </span><span class="cs9C1B1871">获取到的文件后缀进行了黑名单校验。虽然暂时不能直接上传</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">shell</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，但是还是可以上传图片马。如果</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">CMS</span><span class="cs8926E06"> </span><span class="cs9C1B1871">存在任意文件包含或任意文件名修改的漏洞，同样还是可以</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">getshell</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，这里最好再对远程图片的内容进行校验下比较好。</span><span class="cs8926E06">(</span><span class="cs9C1B1871">下图对应文件位置：</span><span class="cs8926E06">phpcms/libs/classes/attachment.class.php</span><span class="cs9C1B1871">，左半图为</span><span class="cs8926E06">PHPCMSv9.6.0</span><span class="cs9C1B1871">，右半图为</span><span class="cs8926E06">PHPCMSv9.6.1)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.0%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image6.png" width="560" height="208" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">实际上，单这个补丁中的正则来说，是可以绕过的，例如：</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">.php%7f</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，</span><span class="cs8926E06">Windows</span><span class="cs9C1B1871">下会将非法字符替换成空，但是其实后续还有一系列的问题，导致我没绕过。本以为要挖到</span><span class="cs8926E06">0day</span><span class="cs9C1B1871">了，我傻乐了半天：</span><span class="cs8926E06">)</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://xz.aliyun.com/t/5730"><span class="cs4B51D5E4">https://xz.aliyun.com/t/5730</span></a></span></p></body>
</html>
