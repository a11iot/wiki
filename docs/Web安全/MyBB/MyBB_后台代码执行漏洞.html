<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="mybb-后台代码执行漏洞"><span class="csDE05BCC">MyBB </span><span class="csECDA2D3">后台代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先全局搜索</span><span class="cs8926E06">inclued</span><span class="cs9C1B1871">函数，在</span><span class="cs9FB05234">\mybb\admin\modules\config\languages.php</span><span class="cs9C1B1871">页面的</span><span class="cs8926E06">432</span><span class="cs9C1B1871">行发现</span><span class="cs8926E06">include</span><span class="cs9C1B1871">函数：</span><span class="cs8926E06">@include $editfile;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="228" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">该函数包含</span><span class="cs9FB05234">editfile</span><span class="cs9C1B1871">文件，进行查看该文件来源，可以看到</span><span class="cs8926E06">418</span><span class="cs9C1B1871">行该文件由</span><span class="cs8926E06">folder</span><span class="cs9C1B1871">文件夹和</span><span class="cs8926E06">file</span><span class="cs9C1B1871">文件拼接，其中</span><span class="cs8926E06">408</span><span class="cs9C1B1871">行看到</span><span class="cs8926E06">file</span><span class="cs9C1B1871">文件由</span><span class="cs8926E06">post</span><span class="cs9C1B1871">请求提交，接下来查看</span><span class="cs8926E06">folder</span><span class="cs9C1B1871">文件夹来源</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="230" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过该文件</span><span class="cs8926E06">84</span><span class="cs9C1B1871">行看到</span><span class="cs8926E06">foler</span><span class="cs9C1B1871">文件夹为</span><span class="cs9FB05234">MYBB_ROOT.&quot;inc/languages/&quot;.$editlang.&quot;/&quot;</span><span class="cs9C1B1871">，接下来查看</span><span class="cs8926E06">editlang</span><span class="cs9C1B1871">变量，通过</span><span class="cs8926E06">89</span><span class="cs9C1B1871">行看到判断该文件名后缀为</span><span class="cs8926E06">php</span><span class="cs9C1B1871">的文件是否存在，然后查看该文件下辖的</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件只有</span><span class="cs8926E06">english</span><span class="cs9C1B1871">文件，猜测</span><span class="cs8926E06">editlang</span><span class="cs9C1B1871">为</span><span class="cs8926E06">english</span><span class="cs9C1B1871">，稍后验证，该变量会通过</span><span class="cs8926E06">post</span><span class="cs9C1B1871">请求输入</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="221" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">现在文件的目录结构分析完毕，接下来查看该漏洞页面的接口位置：由于该文件目录为</span><span class="cs9FB05234">\mybb\admin\modules\config\languages.php</span><span class="cs9C1B1871">，因此，入口为</span><span class="cs8926E06">config</span><span class="cs9C1B1871">模板的</span><span class="cs8926E06">language</span><span class="cs9C1B1871">方法中，其中控制器为</span><span class="cs8926E06">edit</span><span class="cs9C1B1871">，从</span><span class="cs8926E06">369</span><span class="cs9C1B1871">行可以看到，同时</span><span class="cs8926E06">408</span><span class="cs9C1B1871">行看到</span><span class="cs8926E06">post</span><span class="cs9C1B1871">请求中输入</span><span class="cs8926E06">file</span><span class="cs9C1B1871">文件</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="322" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="290" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此我们查看该页面</span><span class="cs8926E06">uri</span><span class="cs9C1B1871">大概为以下样子：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/mybb/admin/index.php?module=config-languages&amp;action=edit</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">现在进行分析，该目录为</span><span class="cs9FB05234">inc/languages/english</span><span class="cs9C1B1871">，因此我们需要向该文件夹下进行上传一个图片，因此我们需要将上传文件目录修改为该文件夹，现在分析如何修改该文件夹：</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">通过对头像上传文件夹进行跟踪，发现在</span><span class="cs9FB05234">function_upload.php</span><span class="cs9C1B1871">的</span><span class="cs8926E06">222</span><span class="cs9C1B1871">行，该文件夹由全局变量</span><span class="cs8926E06">settings</span><span class="cs9C1B1871">控制</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="308" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">对该变量进行跟踪，</span><span class="cs9FB05234">$mybb-&gt;settings[&#39;avataruploadpath&#39;]</span><span class="cs9C1B1871">，发现对</span><span class="cs8926E06">$mybb-&gt;settings[&#39;uploadspath&#39;]</span><span class="cs9C1B1871">变量的控制就需要对文件进行修改进行查询，针对关键函数进行搜索：</span><span class="cs9FB05234">$db-&gt;update_query(&quot;settings&quot;</span><span class="cs9C1B1871">发现在</span><span class="cs9FB05234">\mybb\admin\modules\config\settings.php</span><span class="cs9C1B1871">文件下</span><span class="cs8926E06">1101</span><span class="cs9C1B1871">行：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="266" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过</span><span class="cs8926E06">value</span><span class="cs9C1B1871">和</span><span class="cs8926E06">name</span><span class="cs9C1B1871">变量进行更新，其中</span><span class="cs8926E06">value</span><span class="cs9C1B1871">变量是从</span><span class="cs8926E06">post</span><span class="cs9C1B1871">请求中的</span><span class="cs9FB05234">upsetting</span><span class="cs9C1B1871">数组中进行获取其</span><span class="cs8926E06">name</span><span class="cs9C1B1871">变量的值：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="264" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们跟踪</span><span class="cs9FB05234">avataruploadpath</span><span class="cs9C1B1871">变量，进行搜索，有</span><span class="cs8926E06">1042</span><span class="cs9C1B1871">行定义数组，而</span><span class="cs9FB05234">avataruploadpath</span><span class="cs9C1B1871">为数组中的参数，同时也有</span><span class="cs8926E06">post</span><span class="cs9C1B1871">请求的</span><span class="cs9FB05234">upsetting</span><span class="cs9C1B1871">数组进行输入</span><span class="cs8926E06">:</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image8.png" width="560" height="278" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">现在寻找数据传入方式，发现</span><span class="cs8926E06">action</span><span class="cs9C1B1871">方法为</span><span class="cs9FB05234">change</span><span class="cs9C1B1871">，请求方式为</span><span class="cs9FB05234">post</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image9.png" width="560" height="271" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过该页面</span><span class="cs8926E06">17</span><span class="cs9C1B1871">行，发现页面在</span><span class="cs8926E06">index</span><span class="cs9C1B1871">页面下调用的模板为</span><span class="cs8926E06">config</span><span class="cs9C1B1871">下的</span><span class="cs9FB05234">setting</span><span class="cs9C1B1871">模板：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image10.png" width="560" height="255" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此我们构建的页面就可以为这样，从该页面进行传入数据</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org/mybb/admin/index.php?module=config-settings&amp;action=change</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">通过上传头像（上传的头像图片小于</span><span class="cs8926E06">1kb</span><span class="cs9C1B1871">，因为网站会进行压缩，将</span><span class="cs8926E06">php</span><span class="cs9C1B1871">脚本破坏，因此制作木马要保证大小小于</span><span class="cs8926E06">1kb</span><span class="cs9C1B1871">，已做好的图片放在了附件中）</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">通过修改</span><span class="cs8926E06">setting</span><span class="cs9C1B1871">中的</span><span class="cs9FB05234">avataruploadpath</span><span class="cs9C1B1871">值为</span><span class="cs9FB05234">./inc/languages/english</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">修改</span><span class="cs9FB05234">avataruploadpath</span><span class="cs9C1B1871">值为</span><span class="cs9FB05234">./inc/languages/English</span><span class="cs9C1B1871">，查看所有的</span><span class="cs8926E06">settins</span><span class="cs9C1B1871">变量：</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">链接：</span><span class="cs8926E06">http://www.0-sec.org/mybb/admin/index.php?module=config-settings&amp;action=change</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image11.png" width="560" height="336" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">找到</span><span class="cs8926E06">**</span><span class="cs9FB05234">Avatar Upload Path</span><span class="cs8926E06">**</span><span class="cs9C1B1871">并修改</span><span class="cs9FB05234">./inc/languages/english</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image12.png" width="560" height="339" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过上传头像图片：</span><span class="cs8926E06"><br/>http://www.0-sec.org/mybb/admin/index.php?module=user-users&amp;action=edit&amp;uid=1#tab_avatar<br/></span><span class="cs9C1B1871">勾选去掉当前头像</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image13.png" width="560" height="297" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">点击</span><span class="cs8926E06">save user<br/></span><span class="cs9C1B1871">发现文件已经上传成功，并且</span><span class="cs9FB05234">avataruploadpath</span><span class="cs9C1B1871">也修改成功，下面进行包含操作，访问</span><span class="cs8926E06">url</span><span class="cs9C1B1871">：</span><span class="cs8926E06">http://www.0-sec.org/mybb/admin/index.php?module=config-languages&amp;action=edit&amp;lang=english<br/>Config</span><span class="cs9C1B1871">模块下的</span><span class="cs8926E06">languages</span><span class="cs9C1B1871">下，</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image14.png" width="560" height="326" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因为该页面包含需要</span><span class="cs8926E06">post</span><span class="cs9C1B1871">请求，并且控制器入口为</span><span class="cs8926E06">edit</span><span class="cs9C1B1871">，因此我们进行</span><span class="cs8926E06">edit</span><span class="cs9C1B1871">，随便点一个</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件进行编辑：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image15.png" width="560" height="326" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="csE3F655E4">什么都不用更改</span><span class="cs9C1B1871">，点击</span><span class="cs8926E06">save languagefile</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image16.png" width="560" height="283" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">bp</span><span class="cs9C1B1871">抓包：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image17.png" width="560" height="116" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">将</span><span class="cs8926E06">file</span><span class="cs9C1B1871">变量改为我们的头像图片文件名，名字可以从这里看到</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image18.png" width="560" height="289" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过邮件查看图片链接：</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">右键复制链接打开可以看到文件名为</span><span class="cs9FB05234">avatar_1.jpg</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image19.png" width="560" height="143" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后放包发现该代码执行成功，</span><span class="cs8926E06">phpinfo()</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image20.png" width="560" height="280" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">测试一句话木马</span><span class="cs8926E06">eval($_GET[&#39;a&#39;]);</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image21.png" width="560" height="312" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">测试成功</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">文件上传后，包含后图像文件会损坏，所以需要执行完命令，创建一个新的</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">文件，然后通过</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">进行验证</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">文件存在</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">写一句话木马到网站，请使用</span><span class="cs8926E06">muma.jpg,</span><span class="cs9C1B1871">然后包含，会在</span><span class="cs8926E06">/mybb/admin</span><span class="cs9C1B1871">生成</span><span class="cs8926E06">shell.php,</span><span class="cs9C1B1871">一句话木马密码为</span><span class="cs8926E06">a</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MyBB/MyBB%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image22.png" width="560" height="309" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="文中附件下载链接"><span class="csD6CA00D2">文中附件下载链接</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs8926E06">http://wiki.0-sec.org/download/Mybb_pic.7z</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7213#toc-2</span></p></body>
</html>
