<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="微擎-08-后台任意文件删除"><span class="csECDA2D3">微擎</span><span class="csDE05BCC"> 0.8 </span><span class="csECDA2D3">后台任意文件删除</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">微擎</span><span class="cs8926E06"> 0.8</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞入口文件为</span><span class="cs8926E06"> web/source/site/category.ctrl.php </span><span class="cs9C1B1871">，我们可以看到下图</span><span class="cs8926E06"> 14</span><span class="cs9C1B1871">行</span><span class="cs8926E06"> </span><span class="cs9C1B1871">处调用了</span><span class="cs8926E06"> file_delete </span><span class="cs9C1B1871">函数，而这是一个文件删除相关操作，我们可以看一下该函数的具体定义。下图是入口文件代码：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image0.png" width="560" height="317" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">file_delete </span><span class="cs9C1B1871">这一函数可以在</span><span class="cs8926E06"> framework/function/file.func.php </span><span class="cs9C1B1871">文件中找到，该方法功能用于检测文件是否存在，如果存在，则删除文件。但是查看上下文发现，程序并没有对文件名</span><span class="cs8926E06"> $file </span><span class="cs9C1B1871">变量进行过滤，所以文件名就可以存在类似</span><span class="cs8926E06"> ../ </span><span class="cs9C1B1871">这种字符，这样也就引发任意文件删除漏洞，</span><span class="cs8926E06">file_delete </span><span class="cs9C1B1871">函数代码如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image1.png" width="560" height="205" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">现在我们在回溯回去，看看</span><span class="cs8926E06"> $file </span><span class="cs9C1B1871">变量从何处来。实际上，上图的</span><span class="cs8926E06"> $file </span><span class="cs9C1B1871">变量对应的是</span><span class="cs8926E06"> $row[&#39;icon&#39;] </span><span class="cs9C1B1871">的值，也就是说如果我们可以控制</span><span class="cs8926E06"> $row[&#39;icon&#39;] </span><span class="cs9C1B1871">的值，就可以删除任意文件。那么我们来看看</span><span class="cs8926E06"> $row </span><span class="cs9C1B1871">变量从何而来。该变量就在我们刚刚分析的第一张图片中</span><span class="cs8926E06">( web/source/site/category.ctrl.php </span><span class="cs9C1B1871">文件</span><span class="cs8926E06">)</span><span class="cs9C1B1871">，该值为变量</span><span class="cs8926E06"> $navs </span><span class="cs9C1B1871">中的元素值，具体代码如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image2.png" width="560" height="141" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们再往上看，即可找到</span><span class="cs8926E06"> $navs </span><span class="cs9C1B1871">变量的取值情况。可以看到</span><span class="cs8926E06"> $navs </span><span class="cs9C1B1871">变量的是是重数据库</span><span class="cs8926E06"> site_nav </span><span class="cs9C1B1871">表中取出的，包含了</span><span class="cs8926E06"> icon </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> id </span><span class="cs9C1B1871">两个字段，具体代码如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$navs = pdo_fetchall(&quot;SELECT icon, id FROM &quot;.tablename(&#39;site_nav&#39;).&quot; WHERE id IN (SELECT nid FROM &quot;.tablename(&#39;site_category&#39;).&quot; WHERE id = {$id} OR parentid = &#39;$id&#39;)&quot;, array(), &#39;id&#39;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">现在我们要做的，就是找找看数据库中的这两个字段是否可以被用户控制。我们继续往前查找，发现了如下代码：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image3.png" width="560" height="155" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">site_nav </span><span class="cs9C1B1871">表中的数据，对应的是</span><span class="cs8926E06"> $nav </span><span class="cs9C1B1871">变量。我们继续往上寻找</span><span class="cs8926E06"> $nav </span><span class="cs9C1B1871">变量，发现</span><span class="cs8926E06"> $nav[&#39;icon&#39;] </span><span class="cs9C1B1871">变量是从</span><span class="cs8926E06"> $_GPC[&#39;iconfile&#39;] </span><span class="cs9C1B1871">来的，即可被用户控制</span><span class="cs8926E06">( </span><span class="cs9C1B1871">下图</span><span class="cs8926E06"> </span><span class="cs9C1B1871">第</span><span class="cs8926E06">21</span><span class="cs9C1B1871">行</span><span class="cs8926E06"> )</span><span class="cs9C1B1871">。这里的</span><span class="cs8926E06"> $nav[&#39;icon&#39;] </span><span class="cs9C1B1871">变量，其实就是我们文章开头分析的传入</span><span class="cs8926E06"> file_delete </span><span class="cs9C1B1871">函数的参数，具体代码如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image4.png" width="560" height="334" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">由于</span><span class="cs8926E06"> $nav[&#39;icon&#39;] </span><span class="cs9C1B1871">变量可被用户控制，程序有没有对其进行消毒处理，直接就传入了</span><span class="cs8926E06"> file_delete </span><span class="cs9C1B1871">函数，最终导致了文件删除漏洞。至此，我们分析完了整个漏洞的发生过程，接下看看如何进行攻击。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">##</span><span class="cs9C1B1871">漏洞验证</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">访问</span><span class="cs8926E06">url</span><span class="cs9C1B1871">，点击管理公众号：</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org/web/index.php?c=account&amp;a=display</span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image0.jpg" width="560" height="80" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">找到分类设置，点击添加文章分类。这里对应的</span><span class="cs8926E06">url</span><span class="cs9C1B1871">为：</span><span class="cs8926E06">http://www.0-sec.org/web/index.php?c=site&amp;a=category</span><span class="cs9C1B1871">，实际上表示</span><span class="cs8926E06"> site </span><span class="cs9C1B1871">控制器的</span><span class="cs8926E06"> category </span><span class="cs9C1B1871">模块，即对应</span><span class="cs8926E06"> category.ctrl.php </span><span class="cs9C1B1871">文件。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image1.jpg" width="560" height="245" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">选择对应的内容，进入</span><span class="cs8926E06"> if($isnav) </span><span class="cs9C1B1871">判断：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image2.jpg" width="560" height="180" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在上传图标位置输入要删除文件的路径</span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image3.jpg" width="560" height="119" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们建立</span><span class="cs8926E06"> delete.txt </span><span class="cs9C1B1871">文件，用于测试任意文件删除：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image4.jpg" width="560" height="69" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image5.jpg" width="560" height="116" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们点击删除时，就会调用</span><span class="cs8926E06"> file_delete </span><span class="cs9C1B1871">函数，同时就会删除掉我们插入到数据库中的图片名：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/微擎/%e5%be%ae%e6%93%8e%200.8%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%a0%e9%99%a4_files/image6.jpg" width="560" height="107" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这个类型任意文件删除有点类似于二次注入，在添加分类时先把要删除的文件名称插入到数据库中，然后点击删除分类时，会从数据库中取出要删除的文件名。</span></p></body>
</html>
