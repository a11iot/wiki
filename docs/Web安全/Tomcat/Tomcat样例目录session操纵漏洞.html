<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="tomcat样例目录session操纵漏洞"><span class="csDE05BCC">Tomcat</span><span class="csECDA2D3">样例目录</span><span class="csDE05BCC">session</span><span class="csECDA2D3">操纵漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">Apache tomcat</span><span class="cs9C1B1871">中，有一个默认的</span><span class="cs8926E06">example</span><span class="cs9C1B1871">示例目录，该</span><span class="cs8926E06">example</span><span class="cs9C1B1871">目录中存着众多的样例，其中</span><span class="cs8926E06">/examples/servlets/servlet/SessionExample </span><span class="cs9C1B1871">允许用户对</span><span class="cs8926E06">Session</span><span class="cs9C1B1871">进行操作。由于</span><span class="cs8926E06">Session</span><span class="cs9C1B1871">是存储在服务器端的用于验证用户身份的东西。所以，理论上，只要我们可以操控</span><span class="cs8926E06">Session</span><span class="cs9C1B1871">，就可以伪造任意用户身份信息。</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">如图，是</span><span class="cs8926E06">Apache tomcat </span><span class="cs9C1B1871">网站根目录下的文件夹，默认是有一个</span><span class="cs8926E06">examples</span><span class="cs9C1B1871">目录的</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat%e6%a0%b7%e4%be%8b%e7%9b%ae%e5%bd%95session%e6%93%8d%e7%ba%b5%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="263" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这是</span><span class="cs8926E06">examples</span><span class="cs9C1B1871">目录下的文件</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat%e6%a0%b7%e4%be%8b%e7%9b%ae%e5%bd%95session%e6%93%8d%e7%ba%b5%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="226" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们访问该</span><span class="cs8926E06">SessionExample</span><span class="cs9C1B1871">页面，该页面可以对</span><span class="cs8926E06">Session</span><span class="cs9C1B1871">进行操控，本来该页面是</span><span class="cs8926E06">Apache tomcat</span><span class="cs9C1B1871">用来给开发者操纵</span><span class="cs8926E06">Session</span><span class="cs9C1B1871">示例的页面。但是，如果实际生产环境中不删除该页面的话，可能存在伪造任意用户身份的漏洞。</span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="http://127.0.0.1:8080/examples/servlets/servlet/SessionExample"><span class="cs4B51D5E4">http://127.0.0.1:8080/examples/servlets/servlet/SessionExample</span></a></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat%e6%a0%b7%e4%be%8b%e7%9b%ae%e5%bd%95session%e6%93%8d%e7%ba%b5%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="459" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">那么我们来看看</span><span class="cs8926E06">SessionExample</span><span class="cs9C1B1871">页面是如何通过接收用户输入的值，来对</span><span class="cs8926E06">Session</span><span class="cs9C1B1871">进行控制的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">表单部分代码，接收用户输入的</span><span class="cs8926E06">Name</span><span class="cs9C1B1871">和</span><span class="cs8926E06">Value</span><span class="cs9C1B1871">值。</span></p><p class="cs3A447A38"><span class="cs9FB05234">out.println(&quot;&lt;P&gt;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.print(&quot;&lt;form action=\&quot;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.print(response.encodeURL(&quot;SessionExample&quot;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.print(&quot;\&quot; &quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(&quot;method=POST&gt;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(rb.getString(&quot;sessions.dataname&quot;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(&quot;&lt;input type=text size=20 name=dataname&gt;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(&quot;&lt;br&gt;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(rb.getString(&quot;sessions.datavalue&quot;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(&quot;&lt;input type=text size=20 name=datavalue&gt;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(&quot;&lt;br&gt;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(&quot;&lt;input type=submit&gt;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(&quot;&lt;/form&gt;&quot;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">核心代码，将接收的用户输入的</span><span class="cs8926E06">Name</span><span class="cs9C1B1871">和</span><span class="cs8926E06">Value</span><span class="cs9C1B1871">值写入到</span><span class="cs8926E06">Session</span><span class="cs9C1B1871">中</span></p><p class="cs3A447A38"><span class="cs9FB05234">HttpSession session = request.getSession(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(rb.getString(&quot;sessions.id&quot;) + &quot; &quot; +session.getId());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(&quot;&lt;br&gt;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(rb.getString(&quot;sessions.created&quot;) + &quot; &quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(new Date(session.getCreationTime()) +&quot;&lt;br&gt;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(rb.getString(&quot;sessions.lastaccessed&quot;) + &quot;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">out.println(new Date(session.getLastAccessedTime()));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">String dataName = request.getParameter(&quot;dataname&quot;);//</span><span class="cs7FFD2630">获取</span><span class="cs9FB05234">dataname</span><span class="cs7FFD2630">参数的值</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">String dataValue = request.getParameter(&quot;datavalue&quot;);//</span><span class="cs7FFD2630">获取</span><span class="cs9FB05234">datavalue</span><span class="cs7FFD2630">参数的值</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if (dataName != null &amp;&amp; dataValue != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;session.setAttribute(dataName, dataValue);//</span><span class="cs7FFD2630">将</span><span class="cs9FB05234">dataname</span><span class="cs7FFD2630">和</span><span class="cs9FB05234">datavalue</span><span class="cs7FFD2630">写入</span><span class="cs9FB05234">session</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">也就是说，用户通过表单提交</span><span class="cs8926E06">Name</span><span class="cs9C1B1871">和</span><span class="cs8926E06">Value</span><span class="cs9C1B1871">参数，然后通过</span><span class="cs8926E06">request.getParameter</span><span class="cs9C1B1871">（）函数获取这两个参数的值，再通过</span><span class="cs8926E06">session.setAttribute() </span><span class="cs9C1B1871">函数将</span><span class="cs8926E06">Name</span><span class="cs9C1B1871">和</span><span class="cs8926E06">Value</span><span class="cs9C1B1871">的值写入</span><span class="cs8926E06">Session</span><span class="cs9C1B1871">中。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat%e6%a0%b7%e4%be%8b%e7%9b%ae%e5%bd%95session%e6%93%8d%e7%ba%b5%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="535" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="漏洞示例"><span class="csD6CA00D2">漏洞示例</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们先来编写</span><span class="cs8926E06"> login.jsp </span><span class="cs9C1B1871">、</span><span class="cs8926E06">login_check.jsp </span><span class="cs9C1B1871">、</span><span class="cs8926E06"> index.jsp </span><span class="cs9C1B1871">这三个页面，通过这三个页面来模拟一般网站身份验证的过程。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">login.jsp</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;form action=login_check.jsp method=&quot;POST&quot; &gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">用户名</span><span class="cs9FB05234">: &lt;input type=&quot;text&quot;name=&quot;username&quot;&gt;&lt;br&gt; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">密码</span><span class="cs9FB05234">: &lt;input type=&quot;text&quot; name=&quot;password&quot;&gt;&lt;br&gt; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;inputtype=&quot;submit&quot; value=&quot;</span><span class="cs7FFD2630">登录</span><span class="cs9FB05234">&quot;&gt;&lt;br&gt; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;form&gt;</span></p><p class="cs40DD2BC9"><span class="cs8926E06">login_check.jsp</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;% </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(request.getParameter(&quot;username&quot;) != null &amp;&amp; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.getParameter(&quot;password&quot;)!= null) { &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String username =request.getParameter(&quot;username&quot;); </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String password =request.getParameter(&quot;password&quot;); </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">验证身份</span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (username.equals(&quot;admin&quot;)&amp;&amp; password.equals(&quot;admin&quot;)) { &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;session.setAttribute(&quot;login&quot;,&quot;admin&quot;); </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.sendRedirect(&quot;index.jsp&quot;); </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else { </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.sendRedirect(&quot;login.jsp&quot;); </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">%&gt;</span></p><p class="cs40DD2BC9"><span class="cs8926E06">index.jsp</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp;&lt;% </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;if(session.getAttribute(&quot;login&quot;)!= null &amp;&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;((String)session.getAttribute(&quot;login&quot;)).equals(&quot;admin&quot;)){ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out.println(&quot;Login&quot;); </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.sendRedirect(&quot;login.jsp&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">%&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们直接打开网站后台，即</span><span class="cs8926E06"> index.jsp</span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="http://127.0.0.1:8080/examples/index.jsp"><span class="cs4B51D5E4">http://127.0.0.1:8080/examples/index.jsp</span></a></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat%e6%a0%b7%e4%be%8b%e7%9b%ae%e5%bd%95session%e6%93%8d%e7%ba%b5%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="135" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">发现被重定向到</span><span class="cs8926E06">login.jsp</span><span class="cs9C1B1871">了。因为我们没有登录，所以被重定向到了登录页面</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">打开</span><span class="cs8926E06">SessionExample</span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="http://127.0.0.1:8080/examples/servlets/servlet/SessionExample"><span class="cs4B51D5E4">http://127.0.0.1:8080/examples/servlets/servlet/SessionExample</span></a></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">Name of Session Attribute: </span><span class="cs9C1B1871">里输入</span><span class="cs8926E06"> login</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">Value of Session Attribute:</span><span class="cs9C1B1871">里输入</span><span class="cs8926E06"> admin <img src="Web安全/Tomcat/Tomcat%e6%a0%b7%e4%be%8b%e7%9b%ae%e5%bd%95session%e6%93%8d%e7%ba%b5%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="432" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">提交后显示</span><span class="cs8926E06">login=admin</span><span class="cs9C1B1871">已经写入</span><span class="cs8926E06">session</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat%e6%a0%b7%e4%be%8b%e7%9b%ae%e5%bd%95session%e6%93%8d%e7%ba%b5%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="542" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">再次打开</span><span class="cs8926E06">index.jsp</span><span class="cs9C1B1871">，显示成功登录</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat%e6%a0%b7%e4%be%8b%e7%9b%ae%e5%bd%95session%e6%93%8d%e7%ba%b5%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="124" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">注：但是在现实生产环境中，我们很难知道服务器后端的</span><span class="cs8926E06">Session</span><span class="cs9C1B1871">中是通过什么参数</span><span class="cs8926E06">(Name)</span><span class="cs9C1B1871">和值</span><span class="cs8926E06">(Value)</span><span class="cs9C1B1871">来判断用户登录状态的。所以就是我们根本很难利用该页面来进行任意用户伪造，只是说理论上是可行的。</span></p></body>
</html>
