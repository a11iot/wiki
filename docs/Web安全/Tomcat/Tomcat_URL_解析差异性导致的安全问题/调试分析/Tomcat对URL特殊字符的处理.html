<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h3 class="cs868C439D">
			<a name="tomcat对url特殊字符的处理"><span class="csD1E291E2">Tomcat</span><span class="csD6CA00D2">对</span><span class="csD1E291E2">URL</span><span class="csD6CA00D2">特殊字符的处理</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">这里我们先来调试分析下</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">是如何对请求</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">中不同的特殊字符作不同的处理的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">经过调试分析，得知</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">是在</span><span class="cs8926E06">CoyoteAdapter.service()</span><span class="cs9C1B1871">函数上对请求</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">进行解析处理的，直接在这里打上断点，此时的函数调用栈如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">service:452, CoyoteAdapter (org.apache.catalina.connector)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">process:1195, AbstractHttp11Processor (org.apache.coyote.http11)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">process:654, AbstractProtocol$AbstractConnectionHandler (org.apache.coyote)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:317, JIoEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">runWorker:1142, ThreadPoolExecutor (java.util.concurrent)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:617, ThreadPoolExecutor$Worker (java.util.concurrent)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:745, Thread (java.lang)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">CoyoteAdapter.service()</span><span class="cs9C1B1871">函数中，会调用</span><span class="cs8926E06">postParseRequest()</span><span class="cs9C1B1871">函数来解析</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">请求内容：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat_URL_解析差异性导致的安全问题/调试分析/Tomcat%e5%af%b9URL%e7%89%b9%e6%ae%8a%e5%ad%97%e7%ac%a6%e7%9a%84%e5%a4%84%e7%90%86_files/image0.png" width="560" height="287" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06">postParseRequest()</span><span class="cs9C1B1871">函数中，其中先后调用</span><span class="cs8926E06">parsePathParameters()</span><span class="cs9C1B1871">和</span><span class="cs8926E06">normalize()</span><span class="cs9C1B1871">函数对请求内容进行解析处理：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat_URL_解析差异性导致的安全问题/调试分析/Tomcat%e5%af%b9URL%e7%89%b9%e6%ae%8a%e5%ad%97%e7%ac%a6%e7%9a%84%e5%a4%84%e7%90%86_files/image1.png" width="560" height="235" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里我们先跟进</span><span class="cs8926E06">parsePathParameters()</span><span class="cs9C1B1871">函数，先是寻找</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">中是否存在</span><span class="cs9FB05234">;</span><span class="cs9C1B1871">号，找到的话才会进入下面的</span><span class="cs8926E06">if</span><span class="cs9C1B1871">代码逻辑：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat_URL_解析差异性导致的安全问题/调试分析/Tomcat%e5%af%b9URL%e7%89%b9%e6%ae%8a%e5%ad%97%e7%ac%a6%e7%9a%84%e5%a4%84%e7%90%86_files/image2.png" width="560" height="96" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果找到了</span><span class="cs9FB05234">;</span><span class="cs9C1B1871">号，在</span><span class="cs8926E06">if</span><span class="cs9C1B1871">代码逻辑中后面的循环体会将</span><span class="cs9FB05234">;xxx/</span><span class="cs9C1B1871">中的分号与斜杠之间的字符串以及分号本身都去掉，我们访问</span><span class="cs9FB05234">http://localhost:8080/urltest/;mi1k7ea/index.jsp</span><span class="cs9C1B1871">再试下，就可以进入该代码逻辑调试看到（代码中</span><span class="cs8926E06">ASCII</span><span class="cs9C1B1871">码</span><span class="cs8926E06">59</span><span class="cs9C1B1871">是</span><span class="cs9FB05234">;</span><span class="cs9C1B1871">，</span><span class="cs8926E06">47</span><span class="cs9C1B1871">是</span><span class="cs9FB05234">/</span><span class="cs9C1B1871">）：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat_URL_解析差异性导致的安全问题/调试分析/Tomcat%e5%af%b9URL%e7%89%b9%e6%ae%8a%e5%ad%97%e7%ac%a6%e7%9a%84%e5%a4%84%e7%90%86_files/image3.png" width="560" height="467" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">由此可知，</span><span class="cs8926E06">parsePathParameters()</span><span class="cs9C1B1871">函数是对</span><span class="cs9FB05234">;xxx/</span><span class="cs9C1B1871">这种形式进行处理的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着，跟进</span><span class="cs8926E06">normalize()</span><span class="cs9C1B1871">函数，该函数是对经过</span><span class="cs8926E06">parsePathParameters()</span><span class="cs9C1B1871">函数处理过后的请求</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">进行标准化处理。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">先看到这段代码，</span><span class="cs8926E06">ASCII</span><span class="cs9C1B1871">码</span><span class="cs8926E06">92</span><span class="cs9C1B1871">表示</span><span class="cs9FB05234">\</span><span class="cs9C1B1871">，当匹配到时将其替换为</span><span class="cs8926E06">ASCII</span><span class="cs9C1B1871">码为</span><span class="cs8926E06">47</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">/</span><span class="cs9C1B1871">；当匹配到</span><span class="cs8926E06">ASCII</span><span class="cs9C1B1871">码</span><span class="cs8926E06">0</span><span class="cs9C1B1871">即空字符时，直接返回</span><span class="cs8926E06">false</span><span class="cs9C1B1871">无法成功解析：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat_URL_解析差异性导致的安全问题/调试分析/Tomcat%e5%af%b9URL%e7%89%b9%e6%ae%8a%e5%ad%97%e7%ac%a6%e7%9a%84%e5%a4%84%e7%90%86_files/image4.png" width="560" height="389" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">往下是这段循环，判断是否有连续的</span><span class="cs9FB05234">/</span><span class="cs9C1B1871">，存在的话则循环删除掉多余的</span><span class="cs9FB05234">/</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat_URL_解析差异性导致的安全问题/调试分析/Tomcat%e5%af%b9URL%e7%89%b9%e6%ae%8a%e5%ad%97%e7%ac%a6%e7%9a%84%e5%a4%84%e7%90%86_files/image5.png" width="560" height="408" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着往下看，这段循环就是对</span><span class="cs9FB05234">./</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">../</span><span class="cs9C1B1871">这些特殊字符进行处理，如果这两个字符串都找不到则直接返回</span><span class="cs8926E06">true</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat_URL_解析差异性导致的安全问题/调试分析/Tomcat%e5%af%b9URL%e7%89%b9%e6%ae%8a%e5%ad%97%e7%ac%a6%e7%9a%84%e5%a4%84%e7%90%86_files/image6.png" width="560" height="164" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里尝试下添加</span><span class="cs9FB05234">/./</span><span class="cs9C1B1871">访问的处理，看到找到之后是直接将其去掉然后继续放行：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat_URL_解析差异性导致的安全问题/调试分析/Tomcat%e5%af%b9URL%e7%89%b9%e6%ae%8a%e5%ad%97%e7%ac%a6%e7%9a%84%e5%a4%84%e7%90%86_files/image7.png" width="560" height="298" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里尝试下添加</span><span class="cs9FB05234">/../</span><span class="cs9C1B1871">访问的处理，看到找到后是会进行往前目录层级的回溯处理再拼接到上面某一层目录形成新的</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/Tomcat_URL_解析差异性导致的安全问题/调试分析/Tomcat%e5%af%b9URL%e7%89%b9%e6%ae%8a%e5%ad%97%e7%ac%a6%e7%9a%84%e5%a4%84%e7%90%86_files/image8.png" width="560" height="542" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">由此可知，</span><span class="cs8926E06">normalize()</span><span class="cs9C1B1871">函数对经过经过</span><span class="cs8926E06">parsePathParameters()</span><span class="cs9C1B1871">函数过滤过</span><span class="cs9FB05234">;xxx/</span><span class="cs9C1B1871">的</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">请求内容进标准化处理，具体为将连续的多个</span><span class="cs9FB05234">/</span><span class="cs9C1B1871">给删除掉只保留一个、将</span><span class="cs9FB05234">/./</span><span class="cs9C1B1871">删除掉、将</span><span class="cs9FB05234">/../</span><span class="cs9C1B1871">进行跨目录拼接处理，最后返回处理后的</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">路径。</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">结论</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">对</span><span class="cs9FB05234">/;xxx/</span><span class="cs9C1B1871">以及</span><span class="cs9FB05234">/./</span><span class="cs9C1B1871">的处理是包容的、对</span><span class="cs9FB05234">/../</span><span class="cs9C1B1871">会进行跨目录拼接处理。</span></p></body>
</html>
