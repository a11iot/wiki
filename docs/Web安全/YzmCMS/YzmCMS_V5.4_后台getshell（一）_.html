<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="yzmcms-v54-后台getshell一"><span class="csDE05BCC">YzmCMS V5.4 </span><span class="csECDA2D3">后台</span><span class="csDE05BCC">getshell</span><span class="csECDA2D3">（一）</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">YzmCMS V5.4</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">发现的第一个问题出现在缓存文件写入函数处，文件为</span><span class="cs9FB05234">yzmphp/core/class/cache_file.class.php</span><span class="cs9C1B1871">，函数名为</span><span class="cs9FB05234">_fileputcontents</span></p><p class="cs40DD2BC9"><span><img src="Web安全/YzmCMS/YzmCMS%20V5.4%20%e5%90%8e%e5%8f%b0getshell%ef%bc%88%e4%b8%80%ef%bc%89%20_files/image0.png" width="560" height="202" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到，补丁在原先的</span><span class="cs9FB05234">$contents</span><span class="cs9C1B1871">前拼接了一段</span><span class="cs9FB05234">\n</span><span class="cs9C1B1871">，而如果要进入序列化的代码，需要</span><span class="cs9FB05234">$this-&gt;config[&#39;mode&#39;]</span><span class="cs9C1B1871">为</span><span class="cs8926E06">1</span><span class="cs9C1B1871">，然后就是正常的写入文件。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">调用这个函数的是同类下的</span><span class="cs9FB05234">set</span><span class="cs9C1B1871">函数</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function set($id, $data, $cachelife = 0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cache &nbsp;= array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cache[&#39;contents&#39;] = $data;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cache[&#39;expire&#39;] &nbsp;&nbsp;= $cachelife === 0 ? 0 : SYS_TIME + $cachelife;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cache[&#39;mtime&#39;] &nbsp;&nbsp;&nbsp;= SYS_TIME;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!is_dir($this-&gt;config[&#39;cache_dir&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@mkdir($this-&gt;config[&#39;cache_dir&#39;], 0777, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file = $this-&gt;_file($id);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $this-&gt;_fileputcontents($file, $cache);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而这个类</span><span class="cs9FB05234">cache_file</span><span class="cs9C1B1871">在</span><span class="cs9FB05234">cache_factory</span><span class="cs9C1B1871">中被实例化。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在文件</span><span class="cs9FB05234">yzmphp/core/class/cache_factory.class.php</span><span class="cs9C1B1871">中可以看到</span></p><p class="cs3A447A38"><span class="cs9FB05234">public static function get_instance() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(self::$instances==null){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$instances = new self();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(C(&#39;cache_type&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case &#39;file&#39; :</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yzm_base::load_sys_class(&#39;cache_file&#39;,&#39;&#39;,0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$class = &#39;cache_file&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$config = C(&#39;file_config&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case &#39;redis&#39; : </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yzm_base::load_sys_class(&#39;cache_redis&#39;,&#39;&#39;,0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$class = &#39;cache_redis&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$config = C(&#39;redis_config&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case &#39;memcache&#39; : </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yzm_base::load_sys_class(&#39;cache_memcache&#39;,&#39;&#39;,0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$class = &#39;cache_memcache&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$config = C(&#39;memcache_config&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default :</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yzm_base::load_sys_class(&#39;cache_file&#39;,&#39;&#39;,0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$class = &#39;cache_file&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self::$config = C(&#39;file_config&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return self::$instances;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这三个类提供了相同的功能，使用者可以通过配置来选择其中的某一个类，默认配置下便是</span><span class="cs9FB05234">cache_file</span><span class="cs9C1B1871">类。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而系统中通过</span><span class="cs9FB05234">cache_factory</span><span class="cs9C1B1871">类来实例化缓存类的函数是在</span><span class="cs9FB05234">yzmphp/core/function/global.func.php</span><span class="cs9C1B1871">中的</span><span class="cs9FB05234">setcache</span></p><p class="cs3A447A38"><span class="cs9FB05234">function setcache($name, $data, $timeout=0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;yzm_base::load_sys_class(&#39;cache_factory&#39;,&#39;&#39;,0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cache = cache_factory::get_instance()-&gt;get_cache_instances();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $cache-&gt;set($name, $data, $timeout);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以传给</span><span class="cs9FB05234">setcache</span><span class="cs9C1B1871">的第一个参数将作为文件名的一部分</span><span class="cs8926E06">(</span><span class="cs9C1B1871">后缀为</span><span class="cs8926E06">php)</span><span class="cs9C1B1871">，第二个参数将成为文件内容的一部分。缓存配置相同的情况下，文件名路径不变，只要传递的内容可控就可以写入代码从而</span><span class="cs8926E06">getshell</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而对</span><span class="cs9FB05234">setcache</span><span class="cs9C1B1871">的调用有多处，其中有一些是不能用的，因为会过滤尖括号，比如</span><span class="cs9FB05234">wechat</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">urlrule</span><span class="cs9C1B1871">模块，最后我通过用户自定义配置成功写入代码。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在文件</span><span class="cs9FB05234">commom/function/system.func.php</span><span class="cs9C1B1871">中有</span></p><p class="cs3A447A38"><span class="cs9FB05234">function get_config($key = &#39;&#39;){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!$configs = getcache(&#39;configs&#39;)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data = D(&#39;config&#39;)-&gt;where(array(&#39;status&#39;=&gt;1))-&gt;select();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configs = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($data as $val){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$configs[$val[&#39;name&#39;]] = $val[&#39;value&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setcache(&#39;configs&#39;, $configs);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!$key){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $configs;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return array_key_exists($key, $configs) ? $configs[$key] : &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">setcache</span><span class="cs9C1B1871">的第二个参数是从数据库中</span><span class="cs9FB05234">config</span><span class="cs9C1B1871">表读取的，因此找到一个写入该表的接口，再使得</span><span class="cs9FB05234">get_config</span><span class="cs9C1B1871">函数被调用即可。调用</span><span class="cs9FB05234">get_config</span><span class="cs9C1B1871">比较简单，因为这个函数是用于获取配置的，很多地方都用到了，只要刷新页面即可。所以重点是找到可用的写入接口。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在文件</span><span class="cs9FB05234">application/admin/controller/system_manage.class.php</span><span class="cs9C1B1871">中就有一个可用的接口</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function user_config_add() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($_POST[&#39;dosubmit&#39;])){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$config = D(&#39;config&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$res = $config-&gt;where(array(&#39;name&#39; =&gt; $_POST[&#39;name&#39;]))-&gt;find();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($res) return_json(array(&#39;status&#39;=&gt;0,&#39;message&#39;=&gt;&#39;</span><span class="cs7FFD2630">配置名称已存在！</span><span class="cs9FB05234">&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(empty($_POST[&#39;value&#39;])) &nbsp;return_json(array(&#39;status&#39;=&gt;0,&#39;message&#39;=&gt;&#39;</span><span class="cs7FFD2630">配置值不能为空！</span><span class="cs9FB05234">&#39;));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_POST[&#39;type&#39;] = 99;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(in_array($_POST[&#39;fieldtype&#39;], array(&#39;select&#39;,&#39;radio&#39;))){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_POST[&#39;setting&#39;] = array2string(explode(&#39;|&#39;, rtrim($_POST[&#39;setting&#39;], &#39;|&#39;)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_POST[&#39;setting&#39;] = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($config-&gt;insert($_POST)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delcache(&#39;configs&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return_json(array(&#39;status&#39;=&gt;1,&#39;message&#39;=&gt;L(&#39;operation_success&#39;)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return_json(array(&#39;status&#39;=&gt;0,&#39;message&#39;=&gt;L(&#39;data_not_modified&#39;)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include $this-&gt;admin_tpl(&#39;user_config_add&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到</span><span class="cs8926E06">post</span><span class="cs9C1B1871">过来的值被直接</span><span class="cs8926E06">insert</span><span class="cs9C1B1871">到了</span><span class="cs9FB05234">config</span><span class="cs9C1B1871">表</span><span class="cs8926E06">(</span><span class="cs9C1B1871">如果</span><span class="cs8926E06">insert</span><span class="cs9C1B1871">的第二个参数为</span><span class="cs8926E06">true</span><span class="cs9C1B1871">则会进行过滤</span><span class="cs8926E06">)</span><span class="cs9C1B1871">，所以这个接口就可以用于写入代码。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">因为安装以后的默认配置中的</span><span class="cs9FB05234">file_config</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">mode</span><span class="cs9C1B1871">为</span><span class="cs8926E06">2</span><span class="cs9C1B1871">，所以在我们发现的第一个函数</span><span class="cs9FB05234">_fileputcontents</span><span class="cs9C1B1871">中是不会进入序列化代码的阶段，在进行写入以前，我们需要手动修改配置文件</span><span class="cs9FB05234">common/config/config.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">//</span><span class="cs7FFD2630">缓存类型为</span><span class="cs9FB05234">file</span><span class="cs7FFD2630">缓存时的配置项</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;file_config&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; array (</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cache_dir&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; YZMPHP_PATH.&#39;cache/chche_file/&#39;, &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">缓存文件目录</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;suffix&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; &#39;.cache.php&#39;, &nbsp;//</span><span class="cs7FFD2630">缓存文件后缀</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;mode&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; &#39;1&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">缓存格式：</span><span class="cs9FB05234">mode 1 </span><span class="cs7FFD2630">为</span><span class="cs9FB05234">serialize</span><span class="cs7FFD2630">序列化</span><span class="cs9FB05234">, mode 2 </span><span class="cs7FFD2630">为保存为可执行文件</span><span class="cs9FB05234">array</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;),</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">将该处的</span><span class="cs9FB05234">mode</span><span class="cs9C1B1871">改为</span><span class="cs9FB05234">1</span><span class="cs9C1B1871">保存即可</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后使用</span><span class="cs9FB05234">yzmcms/yzmcms</span><span class="cs9C1B1871">登陆后台，来到系统管理的自定义配置处</span></p><p class="cs40DD2BC9"><span><img src="Web安全/YzmCMS/YzmCMS%20V5.4%20%e5%90%8e%e5%8f%b0getshell%ef%bc%88%e4%b8%80%ef%bc%89%20_files/image1.png" width="560" height="279" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后添加配置，写入代码即可。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/YzmCMS/YzmCMS%20V5.4%20%e5%90%8e%e5%8f%b0getshell%ef%bc%88%e4%b8%80%ef%bc%89%20_files/image2.png" width="560" height="282" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/YzmCMS/YzmCMS%20V5.4%20%e5%90%8e%e5%8f%b0getshell%ef%bc%88%e4%b8%80%ef%bc%89%20_files/image3.png" width="560" height="107" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">添加以后去查看缓存文件夹</span><span class="cs9FB05234">cache/chche_file</span><span class="cs9C1B1871">，可以看到</span><span class="cs9FB05234">configs.cache.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">直接在浏览器打开</span></p><p class="cs40DD2BC9"><span><img src="Web安全/YzmCMS/YzmCMS%20V5.4%20%e5%90%8e%e5%8f%b0getshell%ef%bc%88%e4%b8%80%ef%bc%89%20_files/image4.png" width="560" height="298" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7231#toc-5</span></p></body>
</html>
