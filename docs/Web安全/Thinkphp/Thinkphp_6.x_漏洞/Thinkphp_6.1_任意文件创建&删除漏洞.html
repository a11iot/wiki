<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csFE4DF89B{text-align:left;margin:2pt 0pt 2pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="thinkphp-61-任意文件创建删除漏洞"><span class="csDE05BCC">Thinkphp 6.1 </span><span class="csECDA2D3">任意文件创建</span><span class="csDE05BCC">&amp;</span><span class="csECDA2D3">删除漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞允许攻击者在启用</span><span class="cs8926E06">session</span><span class="cs9C1B1871">的目标环境下创建任意文件以及删除任意文件（仅</span><span class="cs8926E06">Windows</span><span class="cs9C1B1871">下），在特定情况下还可以</span><span class="cs8926E06">getshell</span><span class="cs9C1B1871">。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">ThinkPHP&lt;6.0.2</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="环境搭建"><span class="csD6CA00D2">环境搭建</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">ThinkPHP6.0.1+PHP7.2+Windows</span></p><p class="cs3A447A38"><span class="cs9FB05234">composer create-project topthink/think tp6.0.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs7FFD2630">修改</span><span class="cs9FB05234">json</span><span class="cs7FFD2630">后</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">composer update</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="csFE4DF89B"><span class="csE3F655E4">开启</span><span class="cs5BEC2C28">session</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs8926E06">middleware.php</span><span class="cs9C1B1871">中添加</span></p><p class="cs3A447A38"><span class="cs9FB05234">\think\middleware\SessionInit::class</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="csFE4DF89B"><span class="csE3F655E4">控制器</span></li></ol>
		<p class="cs3A447A38"><span class="cs9FB05234">public function session(){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;session(&#39;name&#39;, &#39;&lt;?php phpinfo();?&gt;&#39;);#</span><span class="cs7FFD2630">模拟写入内容可控</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$SessionName = config(&#39;session.name&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$SessionID = cookie($SessionName);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo $SessionID;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">官方修复</span><span class="cs9FB05234">vendor/topthink/framework/src/think/session/Store.php</span><span class="cs9C1B1871">中</span><span class="cs9FB05234">setId()</span><span class="cs9C1B1871">方法</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在修复之前，参数</span><span class="cs8926E06">id</span><span class="cs9C1B1871">为</span><span class="cs8926E06">32</span><span class="cs9C1B1871">位时直接将其值赋值给</span><span class="cs8926E06">$this-&gt;id</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%206.1%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba&%e5%88%a0%e9%99%a4%e6%bc%8f%e6%b4%9e_files/image0.jpg" width="560" height="194" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">回溯该方法调用情况，在</span><span class="cs9FB05234">vendor/topthink/framework/src/think/middleware/SessionInit.php</span><span class="cs9C1B1871">中发现调用</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">同时从图中可知</span><span class="cs8926E06">$sessionId</span><span class="cs9C1B1871">的值来源途径之一为</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中获取，而</span><span class="cs8926E06">$cookieName</span><span class="cs9C1B1871">默认值为</span><span class="cs8926E06">&rdquo;PHPSESSID&rdquo;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%206.1%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba&%e5%88%a0%e9%99%a4%e6%bc%8f%e6%b4%9e_files/image1.jpg" width="560" height="348" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9FB05234">handle()</span><span class="cs9C1B1871">方法作用是初始化</span><span class="cs8926E06">session</span><span class="cs9C1B1871">，在下面发现</span><span class="cs8926E06">end()</span><span class="cs9C1B1871">方法，在响应过程中一定会触发</span><span class="cs8926E06">end()</span><span class="cs9C1B1871">方法，因为在框架入口文件</span><span class="cs8926E06">index.php</span><span class="cs9C1B1871">中已经写明：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%206.1%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba&%e5%88%a0%e9%99%a4%e6%bc%8f%e6%b4%9e_files/image2.jpg" width="560" height="462" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">end()</span><span class="cs9C1B1871">中存在</span><span class="cs8926E06">save()</span><span class="cs9C1B1871">方法：</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function end(Response $response)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;session-&gt;save();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">save()</span><span class="cs9C1B1871">位于</span><span class="cs9FB05234">vendor/topthink/framework/src/think/session/Store.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此处</span><span class="cs8926E06">$sessionId</span><span class="cs9C1B1871">值可来源于</span><span class="cs8926E06">cookie[&lsquo;PHPSESSID&rsquo;]</span><span class="cs9C1B1871">，可控，但</span></p><p class="cs40DD2BC9"><span class="cs8926E06">$this-&gt;data</span><span class="cs9C1B1871">可决定创建文件或删除文件，经过调试得知，其值来源于程序写入</span><span class="cs8926E06">session</span><span class="cs9C1B1871">的值，例如：</span></p><p class="cs3A447A38"><span class="cs9FB05234">session(&quot;PHPSESSID&quot;,&quot;admin&quot;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">则</span><span class="cs8926E06">$this-&gt;data</span><span class="cs9C1B1871">值为</span><span class="cs8926E06">&rdquo;admin&rdquo;</span><span class="cs9C1B1871">，因此如果写入</span><span class="cs8926E06">session</span><span class="cs9C1B1871">可控，则可写入任意内容文件。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%206.1%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba&%e5%88%a0%e9%99%a4%e6%bc%8f%e6%b4%9e_files/image3.jpg" width="560" height="533" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">写入</span><span class="cs8926E06">write()</span><span class="cs9C1B1871">和创建文件</span><span class="cs8926E06">delete()</span><span class="cs9C1B1871">均是接口方法</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%206.1%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba&%e5%88%a0%e9%99%a4%e6%bc%8f%e6%b4%9e_files/image4.jpg" width="560" height="166" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在程序处理过程中肯定会涉及其他类，因此搜索实现了该接口的类，发现：</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">vendor/topthink/framework/src/think/session/driver/File.php</span><span class="cs9C1B1871">符合条件</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%206.1%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba&%e5%88%a0%e9%99%a4%e6%bc%8f%e6%b4%9e_files/image5.jpg" width="560" height="134" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%206.1%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba&%e5%88%a0%e9%99%a4%e6%bc%8f%e6%b4%9e_files/image6.jpg" width="560" height="158" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在上文</span><span class="cs8926E06">write()</span><span class="cs9C1B1871">方法中，文件名</span><span class="cs8926E06">$filename</span><span class="cs9C1B1871">经过了</span><span class="cs8926E06">getFIleName()</span><span class="cs9C1B1871">的处理，而该方法会在传入参数前添加</span><span class="cs8926E06">&rdquo;sess_&rdquo;</span><span class="cs9C1B1871">，也就是说文件名后部分可控，这是比较重要的一个点。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%206.1%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba&%e5%88%a0%e9%99%a4%e6%bc%8f%e6%b4%9e_files/image7.jpg" width="560" height="327" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">**</span><span class="cs9C1B1871">任意文件删除：</span><span class="cs8926E06">**</span><span class="cs9C1B1871">删除</span><span class="cs8926E06">public</span><span class="cs9C1B1871">目录下</span><span class="cs8926E06">aaaaaaaaaaa.php</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">需开启</span><span class="cs8926E06">session</span><span class="cs9C1B1871">，且仅</span><span class="cs8926E06">Windows</span><span class="cs9C1B1871">下可行</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%206.1%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba&%e5%88%a0%e9%99%a4%e6%bc%8f%e6%b4%9e_files/image8.jpg" width="560" height="198" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="csE3F655E4">文件写入</span><span class="cs9C1B1871">：</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">要求开启</span><span class="cs8926E06">session</span><span class="cs9C1B1871">，且写入</span><span class="cs8926E06">session</span><span class="cs9C1B1871">可控</span></p><p class="cs3A447A38"><span class="cs9FB05234">session(&#39;name&#39;, &#39;&lt;?php phpinfo();?&gt;&#39;);</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%206.1%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba&%e5%88%a0%e9%99%a4%e6%bc%8f%e6%b4%9e_files/image9.jpg" width="560" height="129" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%206.1%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba&%e5%88%a0%e9%99%a4%e6%bc%8f%e6%b4%9e_files/image10.jpg" width="560" height="97" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">写入和删除文件时的测试：</span></p><p class="cs3A447A38"><span class="cs9FB05234">#</span><span class="cs7FFD2630">以下均可行，系统将</span><span class="cs9FB05234">sess_</span><span class="cs7FFD2630">视作一个目录</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">file_put_contents(&quot;D:\tp6.0.1\runtime\session\sess_/../../../public/aa.php&quot;,1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include &quot;D:\tp6.0.1\runtime\session\sess_/../../../public/aa.php&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#unlink()</span><span class="cs7FFD2630">有区别：</span><span class="cs9FB05234">Windows</span><span class="cs7FFD2630">下可行</span><span class="cs9FB05234">,Linux</span><span class="cs7FFD2630">下无法识别目录</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">unlink(&quot;D:\tp6.0.1\runtime\session\sess_/../../../public/aa.php&quot;)#</span><span class="cs7FFD2630">成功删除</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">unlink(&quot;/var/www/html/runtime\session\sess_/../../../public/aa.php&quot;)#</span><span class="cs7FFD2630">删除失败</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">http://pines404.online/2020/01/21/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/ThinkPHP/ThinkPHP6.0.1%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E5%92%8C%E5%88%A0%E9%99%A4%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</span></p></body>
</html>
