<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="thinkphp--602-session-id未作过滤导致getshell"><span class="csDE05BCC">Thinkphp &lt; 6.0.2 session id</span><span class="csECDA2D3">未作过滤导致</span><span class="csDE05BCC">getshell</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Thinkphp &lt; 6.0.2</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">通过</span><span class="cs8926E06">diff github</span><span class="cs9C1B1871">上面的</span><span class="cs8926E06">6.0.1</span><span class="cs9C1B1871">和</span><span class="cs8926E06">6.0.2</span><span class="cs9C1B1871">的代码可以发现，</span><span class="cs8926E06">6.0.1</span><span class="cs9C1B1871">在设置</span><span class="cs9FB05234">session id</span><span class="cs9C1B1871">时未对值进行</span><span class="cs9FB05234">ctype_alnum()</span><span class="cs9C1B1871">校验，从而导致可以传入任意字符。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%20_%206.0.2%20session%20id%e6%9c%aa%e4%bd%9c%e8%bf%87%e6%bb%a4%e5%af%bc%e8%87%b4getshell_files/image0.png" width="560" height="305" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">传入任意字符会有什么危害？一般来说程序可能会以</span><span class="cs8926E06">session id</span><span class="cs9C1B1871">作为文件名来创建对应的</span><span class="cs8926E06">session</span><span class="cs9C1B1871">文件，但是到目前为止这只是猜测。看一下保存</span><span class="cs8926E06">session</span><span class="cs9C1B1871">是怎么写的。</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function save(): void</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;clearFlashData();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$sessionId = $this-&gt;getId();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!empty($this-&gt;data)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data = $this-&gt;serialize($this-&gt;data);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;handler-&gt;write($sessionId, $data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;handler-&gt;delete($sessionId);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;init = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">先获取</span><span class="cs8926E06">sessionid</span><span class="cs9C1B1871">，然后作为第一个参数传入</span><span class="cs9FB05234">$this-&gt;handler-&gt;write()</span><span class="cs9C1B1871">。</span><span class="cs9FB05234">$this-&gt;handler</span><span class="cs9C1B1871">在构造函数中被初始化</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function __construct($name, SessionHandlerInterface $handler, array $serialize = null)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;name &nbsp;&nbsp;&nbsp;= $name;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;handler = $handler;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!empty($serialize)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;serialize = $serialize;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;setId();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看出</span><span class="cs9FB05234">$handler</span><span class="cs9C1B1871">的类型是</span><span class="cs9FB05234">SessionHandlerInterface</span><span class="cs9C1B1871">，全局发现这是一个接口，实现这个接口的类有两个，一个是</span><span class="cs9FB05234">File</span><span class="cs9C1B1871">，一个是</span><span class="cs9FB05234">Cache</span><span class="cs9C1B1871">。这里以</span><span class="cs9FB05234">File</span><span class="cs9C1B1871">类为例，我们跟进它的</span><span class="cs9FB05234">write()</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function write(string $sessID, string $sessData): bool</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$filename = $this-&gt;getFileName($sessID, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$data &nbsp;&nbsp;&nbsp;&nbsp;= $sessData;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($this-&gt;config[&#39;data_compress&#39;] &amp;&amp; function_exists(&#39;gzcompress&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">数据压缩</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data = gzcompress($data, 3);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $this-&gt;writeFile($filename, $data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里先通过第一个参数（也就是</span><span class="cs8926E06">session id</span><span class="cs9C1B1871">）来构造</span><span class="cs9FB05234">$filename</span><span class="cs9C1B1871">，然后判断是否需要对</span><span class="cs8926E06">session</span><span class="cs9C1B1871">数据进行压缩，默认是不需要的，最后</span><span class="cs8926E06">return</span><span class="cs9C1B1871">时调用</span><span class="cs9FB05234">$this-&gt;writeFile()</span><span class="cs9C1B1871">。先看看文件名是如何构造的，跟进</span><span class="cs9FB05234">$this-&gt;getFileName()</span></p><p class="cs3A447A38"><span class="cs9FB05234">protected function getFileName(string $name, bool $auto = false): string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($this-&gt;config[&#39;prefix&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name = $this-&gt;config[&#39;prefix&#39;] . DIRECTORY_SEPARATOR . &#39;sess_&#39; . $name;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name = &#39;sess_&#39; . $name;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$filename = $this-&gt;config[&#39;path&#39;] . $name;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $filename;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里直接将第一个参数拼接到路径的最后。跟进之前的</span><span class="cs9FB05234">$this-&gt;writeFile()</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">protected function writeFile($path, $content): bool</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return (bool) file_put_contents($path, $content, LOCK_EX);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">刺激了，这里直接保存了文件。纵观全局，由于程序未对</span><span class="cs8926E06">session id</span><span class="cs9C1B1871">进行危险字符判断，只要将</span><span class="cs8926E06">session id</span><span class="cs9C1B1871">写为类似于</span><span class="cs9FB05234">xxxx.php</span><span class="cs9C1B1871">的格式，即可导致</span><span class="cs8926E06">session</span><span class="cs9C1B1871">保存成</span><span class="cs9FB05234">.php</span><span class="cs9C1B1871">文件，从而</span><span class="cs8926E06">getshell</span><span class="cs9C1B1871">。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">通过全局搜索</span><span class="cs9FB05234">setId</span><span class="cs9C1B1871">发现在</span><span class="cs9FB05234">think/middleware/SessionInit.php:handle():L59</span><span class="cs9C1B1871">发生了调用。</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function handle($request, Closure $next)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// Session</span><span class="cs7FFD2630">初始化</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$varSessionId = $this-&gt;app-&gt;config-&gt;get(&#39;session.var_session_id&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cookieName &nbsp;&nbsp;= $this-&gt;session-&gt;getName();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($varSessionId &amp;&amp; $request-&gt;request($varSessionId)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sessionId = $request-&gt;request($varSessionId);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sessionId = $request-&gt;cookie($cookieName);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($sessionId) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;session-&gt;setId($sessionId);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">由于</span><span class="cs9FB05234">session.var_session_id</span><span class="cs9C1B1871">默认是空，这里的</span><span class="cs9FB05234">$sessionId</span><span class="cs9C1B1871">的值由</span><span class="cs9FB05234">$request-&gt;cookie($cookieName)</span><span class="cs9C1B1871">获得，</span><span class="cs9FB05234">$cookieName</span><span class="cs9C1B1871">经过跟进后发现默认是</span><span class="cs8926E06">PHPSESSID</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%20_%206.0.2%20session%20id%e6%9c%aa%e4%bd%9c%e8%bf%87%e6%bb%a4%e5%af%bc%e8%87%b4getshell_files/image1.png" width="560" height="233" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此我们只要设置</span><span class="cs8926E06">Cookie</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">PHPSESSID</span><span class="cs9C1B1871">的值为</span><span class="cs8926E06">1234567890123456789012345678.php</span><span class="cs9C1B1871">即可。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们在</span><span class="cs8926E06">index</span><span class="cs9C1B1871">控制器中添加如下</span><span class="cs8926E06">action</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function testsession2(){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$username = Request::get(&#39;name&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Session::set(&#39;username&#39;, $username);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return &#39;hi&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">用于获取</span><span class="cs8926E06">name</span><span class="cs9C1B1871">参数，并将之设置到</span><span class="cs8926E06">session</span><span class="cs9C1B1871">中。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">访问</span><span class="cs8926E06">url</span><span class="cs9C1B1871">：</span><span class="cs9FB05234">http://127.0.0.1/tp6/public/index.php/index/testsession2?name=</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%20_%206.0.2%20session%20id%e6%9c%aa%e4%bd%9c%e8%bf%87%e6%bb%a4%e5%af%bc%e8%87%b4getshell_files/image2.png" width="560" height="144" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">访问</span><span class="cs8926E06">session</span><span class="cs9C1B1871">文件，一般位于项目根目录下的</span><span class="cs9FB05234">./runtime/session/</span><span class="cs9C1B1871">文件夹下，也就是</span><span class="cs9FB05234">/runtime/session/sess_1234567890123456789012345678.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Thinkphp/Thinkphp_6.x_漏洞/Thinkphp%20_%206.0.2%20session%20id%e6%9c%aa%e4%bd%9c%e8%bf%87%e6%bb%a4%e5%af%bc%e8%87%b4getshell_files/image3.png" width="560" height="275" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://xz.aliyun.com/t/7109"><span class="cs4B51D5E4">https://xz.aliyun.com/t/7109</span></a></span></p></body>
</html>
