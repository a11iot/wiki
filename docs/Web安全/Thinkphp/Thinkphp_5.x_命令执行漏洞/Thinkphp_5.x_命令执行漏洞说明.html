<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="thinkphp-5x-命令执行漏洞说明"><span class="csDE05BCC">Thinkphp 5.x </span><span class="csECDA2D3">命令执行漏洞说明</span></a></h1>
		<p class="cs40DD2BC9"><span class="csE3F655E4">先简单说明一下吧，</span><span class="cs5BEC2C28">5.x</span><span class="csE3F655E4">我们这里罗列了目前碰到的全部</span><span class="cs5BEC2C28">tp</span><span class="csE3F655E4">系列的对应版本漏洞，我在这里简要说明一下，不看别后悔</span></p><p class="cs6FD73CFB"><span class="cs8926E06">tp</span><span class="cs9C1B1871">框架系列中，</span><span class="cs8926E06">5.0.x </span><span class="cs9C1B1871">跟</span><span class="cs8926E06"> 5.1.x </span><span class="cs9C1B1871">中，各个系列里的</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">是几乎为通用的</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">比如</span><span class="cs8926E06"> 5.0.1</span><span class="cs9C1B1871">中某个</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">在</span><span class="cs8926E06">5.0.3</span><span class="cs9C1B1871">中也是可以用的，也就是说当我们碰到</span><span class="cs8926E06">5.0.8</span><span class="cs9C1B1871">的时候，可以尝试用</span><span class="cs8926E06">5.0.1 </span><span class="cs9C1B1871">或</span><span class="cs8926E06"> 5.0.5</span><span class="cs9C1B1871">等</span><span class="cs8926E06"> 5.0.x </span><span class="cs9C1B1871">系列的</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">去尝试使用，</span></p><p class="cs6FD73CFB"><span class="cs8926E06">5.1.x </span><span class="cs9C1B1871">系列同理</span></p><h2 class="cs868C439D">
			<a name="执行流程"><span class="cs83F14626">执行流程：</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先发起请求</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">开始路由检测</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">获取</span><span class="cs8926E06">pathinfo</span><span class="cs9C1B1871">信息</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">路由匹配</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">开始路由解析</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">获得模块、控制器、操作方法调度信息</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">开始路由调度</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">解析模块和类名</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">组建命名空间</span><span class="cs8926E06">&gt;</span><span class="cs9C1B1871">查找并加载类</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">实例化控制器并调用操作方法</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">构建响应对象</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">响应输出</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">日志保存</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">程序运行结束</span></p><h2 class="cs868C439D">
			<a name="漏洞原因"><span class="cs83F14626">漏洞原因：</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">路由控制不严谨，默认不开启强制路由，从而可以任意调用</span><span class="cs8926E06">Thinkphp</span><span class="cs9C1B1871">的类库</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">主要有俩种方法，</span><span class="cs5BEC2C28">1.Request</span><span class="csE3F655E4">中的变量覆盖导致</span><span class="cs5BEC2C28">RCE 2.</span><span class="csE3F655E4">路由控制不严谨导致的</span><span class="cs5BEC2C28">RCE</span></p><h2 class="cs868C439D">
			<a name="request中的变量覆盖导致rce"><span class="csB2D98684">Request</span><span class="cs83F14626">中的变量覆盖导致</span><span class="csB2D98684">RCE</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">版本名</span><span class="cs8926E06"> </span><span class="cs9C1B1871">是否可被攻击</span><span class="cs8926E06"> </span><span class="cs9C1B1871">攻击条件</span><span class="cs8926E06"><br/>5.0.0 </span><span class="cs9C1B1871">否</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无</span><span class="cs8926E06"><br/>5.0.1 </span><span class="cs9C1B1871">否</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无</span><span class="cs8926E06"><br/>5.0.2 </span><span class="cs9C1B1871">否</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无</span><span class="cs8926E06"><br/>5.0.3 </span><span class="cs9C1B1871">否</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无</span><span class="cs8926E06"><br/>5.0.4 </span><span class="cs9C1B1871">否</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无</span><span class="cs8926E06"><br/>5.0.5 </span><span class="cs9C1B1871">否</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无</span><span class="cs8926E06"><br/>5.0.6 </span><span class="cs9C1B1871">否</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无</span><span class="cs8926E06"><br/>5.0.7 </span><span class="cs9C1B1871">否</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无</span><span class="cs8926E06"><br/>5.0.8 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无需开启</span><span class="cs8926E06">debug<br/>5.0.9 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无需开启</span><span class="cs8926E06">debug<br/>5.0.10 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无需开启</span><span class="cs8926E06">debug<br/>5.0.11 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无需开启</span><span class="cs8926E06">debug<br/>5.0.12 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无需开启</span><span class="cs8926E06">debug<br/>5.0.13 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">需开启</span><span class="cs8926E06">debug<br/>5.0.14 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">需开启</span><span class="cs8926E06">debug<br/>5.0.15 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">需开启</span><span class="cs8926E06">debug<br/>5.0.16 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">需开启</span><span class="cs8926E06">debug<br/>5.0.17 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">需开启</span><span class="cs8926E06">debug<br/>5.0.18 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">需开启</span><span class="cs8926E06">debug<br/>5.0.19 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">需开启</span><span class="cs8926E06">debug<br/>5.0.20 </span><span class="cs9C1B1871">否</span><span class="cs8926E06"> </span><span class="cs9C1B1871">无</span><span class="cs8926E06"><br/>5.0.21 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">需开启</span><span class="cs8926E06">debug<br/>5.0.22 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">需开启</span><span class="cs8926E06">debug<br/>5.0.23 </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">需开启</span><span class="cs8926E06">debug</span></p><h2 class="cs868C439D">
			<a name="路由控制不严谨导致的rce"><span class="cs83F14626">路由控制不严谨导致的</span><span class="csB2D98684">RCE</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">5.0.23--5.1.31</span><span class="cs9C1B1871">版本</span></p><h2 class="cs868C439D">
			<a name="补充"><span class="cs83F14626">补充</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">由于受</span><span class="cs8926E06">windows</span><span class="cs9C1B1871">系统的影响，会导致部分</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">在</span><span class="cs8926E06">windows</span><span class="cs9C1B1871">主机无法使用</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">并且由于</span><span class="cs8926E06">windows</span><span class="cs9C1B1871">自动加载类加载不到想要的类文件，所以能够下手的就是在框架加载的时候已经加载的类。</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">5.1</span><span class="csE3F655E4">是下面这些：</span></p><p class="cs3A447A38"><span class="cs9FB05234">think\Loader </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Composer\Autoload\ComposerStaticInit289837ff5d5ea8a00f5cc97a07c04561</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Error </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Container</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\App </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Env </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Config </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Hook </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Facade</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\facade\Env</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">env</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Db</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Lang </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Request </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Log </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\log\driver\File</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\facade\Route</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">route</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Route </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\route\Rule</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\route\RuleGroup</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\route\Domain</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\route\RuleItem</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\route\RuleName</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\route\Dispatch</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\route\dispatch\Url</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\route\dispatch\Module</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Middleware</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Cookie</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\View</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\view\driver\Think</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Template</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\template\driver\File</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Session</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Debug</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Cache</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\cache\Driver</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\cache\driver\File</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">5.0 </span><span class="csE3F655E4">的有：</span></p><p class="cs3A447A38"><span class="cs9FB05234">think\Route</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Config</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Error</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\App</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Request</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Hook</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Env</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Lang</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Log</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Loader</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">两个版本公有的是：</span></p><p class="cs3A447A38"><span class="cs9FB05234">think\Route </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Loader </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Error </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\App </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Env </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Config </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Hook </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Lang </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Request </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">think\Log</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">本想找出两个版本共有的利用类和方法，但由于类文件大多被重写了，所以没耐住性子一一去找（菜）</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以，</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">为上述类的利用方法，是可以兼容</span><span class="cs8926E06">windows</span><span class="cs9C1B1871">和</span><span class="cs8926E06">linux</span><span class="cs9C1B1871">多个平台的，兼容多个平台有什么用呢？插件批量可以减少误判等，一条</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">通用，一把梭多好。</span></p></body>
</html>
