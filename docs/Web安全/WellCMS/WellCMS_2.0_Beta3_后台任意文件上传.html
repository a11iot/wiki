<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="wellcms-20-beta3-后台任意文件上传"><span class="csDE05BCC">WellCMS 2.0 Beta3 </span><span class="csECDA2D3">后台任意文件上传</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">根据漏洞定位代码文件：</span><span class="cs8926E06">route/attach.php</span><span class="cs9C1B1871">，代码如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if ($action == &#39;create&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_start.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;user_login_check();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_check_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$backstage = param(2, 0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$width = param(&#39;width&#39;, 0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$height = param(&#39;height&#39;, 0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$is_image = param(&#39;is_image&#39;, 0); // </span><span class="cs7FFD2630">图片</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$name = param(&#39;name&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$data = param_base64(&#39;data&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$mode = param(&#39;mode&#39;, 0); // </span><span class="cs7FFD2630">上传类型</span><span class="cs9FB05234"> 1</span><span class="cs7FFD2630">主图</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$filetype = param(&#39;filetype&#39;); // </span><span class="cs7FFD2630">压缩图片后缀</span><span class="cs9FB05234">jpeg jpg png</span><span class="cs7FFD2630">等</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$convert = param(&#39;convert&#39;, 0); // </span><span class="cs7FFD2630">图片转换压缩</span><span class="cs9FB05234"> = 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$n = param(&#39;n&#39;, 0); // </span><span class="cs7FFD2630">对应主图赋值</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$type = param(&#39;type&#39;, 0); // type = 0</span><span class="cs7FFD2630">则按照</span><span class="cs9FB05234">SESSION</span><span class="cs7FFD2630">数组附件数量统计，</span><span class="cs9FB05234">type = 1</span><span class="cs7FFD2630">则按照传入的</span><span class="cs9FB05234">n</span><span class="cs7FFD2630">数值</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_before.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">允许的文件后缀名</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//$types = include _include(APP_PATH.&#39;conf/attach.conf.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//$allowtypes = $types[&#39;all&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;empty($group[&#39;allowattach&#39;]) AND $gid != 1 AND message(2, &#39;</span><span class="cs7FFD2630">您无权上传</span><span class="cs9FB05234">&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_center.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;empty($data) AND message(1, lang(&#39;data_is_empty&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//$data = base64_decode_file_data($data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$size = strlen($data);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$size &gt; 20480000 AND message(1, lang(&#39;filesize_too_large&#39;, array(&#39;maxsize&#39; =&gt; &#39;20M&#39;, &#39;size&#39; =&gt; $size)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_file_ext_start.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">获取文件后缀名</span><span class="cs9FB05234"> 111.php.shtmll</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ext = file_ext($name, 7);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$filetypes = include APP_PATH . &#39;conf/attach.conf.php&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_file_ext_before.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">主图必须为图片</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($is_image == 1 &amp;&amp; $mode == 1 &amp;&amp; !in_array($ext, $filetypes[&#39;image&#39;])) message(1, lang(&#39;well_up_picture_error&#39;));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_file_ext_center.php</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">如果文件后缀不在规定范围内</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">改变后缀名</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//!in_array($ext, $filetypes[&#39;all&#39;]) AND $ext = &#39;_&#39; . $ext;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!in_array($ext, $filetypes[&#39;all&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ext = &#39;_&#39; . $ext;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// CMS</span><span class="cs7FFD2630">上传图片</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t == 1 AND $convert == 1 AND $is_image == 1 AND $ext = $filetype;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_file_ext_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tmpanme = $uid . &#39;_&#39; . xn_rand(15) . &#39;.&#39; . $ext;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_tmpanme_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tmpfile = $conf[&#39;upload_path&#39;] . &#39;tmp/&#39; . $tmpanme;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_tmpfile_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tmpurl = $conf[&#39;upload_url&#39;] . &#39;tmp/&#39; . $tmpanme;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_tmpurl_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$filetype = attach_type($name, $filetypes);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_save_before.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;file_put_contents($tmpfile, $data) OR message(1, lang(&#39;write_to_file_failed&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_save_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">保存到</span><span class="cs9FB05234"> session</span><span class="cs7FFD2630">，发帖成功以后，关联到帖子。</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// save attach information to session, associate to post after create thread.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">抛弃之前的</span><span class="cs9FB05234"> $_SESSION </span><span class="cs7FFD2630">数据，重新启动</span><span class="cs9FB05234"> session</span><span class="cs7FFD2630">，降低</span><span class="cs9FB05234"> session </span><span class="cs7FFD2630">并发写入的问题</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// Discard the previous $_SESSION data, restart the session, reduce the problem of concurrent session write</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sess_restart();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;empty($t) AND empty($_SESSION[&#39;tmp_files&#39;]) AND $_SESSION[&#39;tmp_files&#39;] = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$t == 1 AND empty($_SESSION[&#39;tmp_website_files&#39;]) AND $_SESSION[&#39;tmp_website_files&#39;] = array();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// type = 0</span><span class="cs7FFD2630">则按照</span><span class="cs9FB05234">SESSION</span><span class="cs7FFD2630">数组附件数量统计，</span><span class="cs9FB05234">type = 1</span><span class="cs7FFD2630">则按照传入的</span><span class="cs9FB05234">n</span><span class="cs7FFD2630">数值</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;empty($type) AND $n = ($t == 1) ? count($_SESSION[&#39;tmp_website_files&#39;]) : count($_SESSION[&#39;tmp_files&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$filesize = filesize($tmpfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$attach = array(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;backstage&#39; =&gt; $backstage, // 0</span><span class="cs7FFD2630">前台</span><span class="cs9FB05234"> 1</span><span class="cs7FFD2630">后台</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;url&#39; =&gt; $backstage ? &#39;../&#39; . $tmpurl : &#39;&#39; . $tmpurl,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;path&#39; =&gt; $tmpfile,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;orgfilename&#39; =&gt; $name,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;filetype&#39; =&gt; $filetype,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;filesize&#39; =&gt; $filesize,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;width&#39; =&gt; $width,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;height&#39; =&gt; $height,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;isimage&#39; =&gt; $is_image,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;downloads&#39; =&gt; 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;aid&#39; =&gt; &#39;_&#39; . $n</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_array_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($mode == 1) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// hook attach_create_thumbnail_beofre.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_SESSION[&#39;tmp_thumbnail&#39;] = $attach;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// hook attach_create_thumbnail_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// hook attach_create_website_files_beofre.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 0 BBS 1 CMS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t == 1 ? $_SESSION[&#39;tmp_website_files&#39;][$n] = $attach : $_SESSION[&#39;tmp_files&#39;][$n] = $attach;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// hook attach_create_website_files_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_session_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unset($attach[&#39;path&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_end.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;message(0, $attach);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">大致流程：</span><span class="cs8926E06"><br/>1</span><span class="cs9C1B1871">、</span><span class="cs8926E06"> </span><span class="cs9C1B1871">首先，接受相关参数，将</span><span class="cs8926E06">filetype</span><span class="cs9C1B1871">自行设置成</span><span class="cs8926E06">&ldquo;php&rdquo;</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$data = param_base64(&#39;data&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$filetype = param(&#39;filetype&#39;); /</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2</span><span class="cs9C1B1871">、</span><span class="cs8926E06"> </span><span class="cs9C1B1871">进行逻辑判断：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (!in_array($ext, $filetypes[&#39;all&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ext = &#39;_&#39; . $ext;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// CMS</span><span class="cs7FFD2630">上传图片</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$t == 1 AND $convert == 1 AND $is_image == 1 AND $ext = $filetype;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">3</span><span class="cs9C1B1871">、</span><span class="cs8926E06"> </span><span class="cs9C1B1871">最后成功写入：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$tmpanme = $uid . &#39;_&#39; . xn_rand(15) . &#39;.&#39; . $ext;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_tmpanme_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tmpfile = $conf[&#39;upload_path&#39;] . &#39;tmp/&#39; . $tmpanme;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_tmpfile_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$tmpurl = $conf[&#39;upload_url&#39;] . &#39;tmp/&#39; . $tmpanme;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_tmpurl_after.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$filetype = attach_type($name, $filetypes);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// hook attach_create_save_before.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;file_put_contents($tmpfile, $data) OR message(1, lang(&#39;write_to_file_failed&#39;));</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">第一步，登陆该</span><span class="cs8926E06">CMS</span><span class="cs9C1B1871">后台：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/WellCMS/WellCMS%202.0%20Beta3%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image0.png" width="560" height="215" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第二步，进入</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">后台管理</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">，定位利用点，点击下图红框中图片进行上传：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/WellCMS/WellCMS%202.0%20Beta3%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image1.png" width="560" height="264" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">上传并抓取数据包：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/WellCMS/WellCMS%202.0%20Beta3%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image2.png" width="560" height="220" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第三步，修改</span><span class="cs8926E06">post</span><span class="cs9C1B1871">包中</span><span class="cs8926E06">&ldquo;filetype&rdquo;</span><span class="cs9C1B1871">参数类型为</span><span class="cs8926E06">&ldquo;php&rdquo;</span><span class="cs9C1B1871">；经分析</span><span class="cs8926E06"> &ldquo;data&rdquo;</span><span class="cs9C1B1871">参数为</span><span class="cs8926E06">base64</span><span class="cs9C1B1871">加密，这里我们将测试数据</span><span class="cs8926E06">&ldquo;&rdquo;</span><span class="cs9C1B1871">经过</span><span class="cs8926E06">base64</span><span class="cs9C1B1871">加密等构造，形成</span><span class="cs8926E06">&ldquo;data&rdquo;</span><span class="cs9C1B1871">参数的数据：</span><span class="cs8926E06">data%3Aimage%2Fjpeg%3Bbase64%2CPD9waHAgcGhwaW5mbygpOz8%2B</span><span class="cs9C1B1871">，最后数据包放行，返回成功上传为</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件的路径：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/WellCMS/WellCMS%202.0%20Beta3%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image3.png" width="560" height="165" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后，尝试访问，成功：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/WellCMS/WellCMS%202.0%20Beta3%20%e5%90%8e%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0_files/image4.png" width="560" height="318" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7284</span></p></body>
</html>
