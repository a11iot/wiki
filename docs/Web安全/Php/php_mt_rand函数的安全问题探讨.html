<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs98083A41{color:#000000;background-color:transparent;font-family:MS Gothic;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="php-mtrand函数的安全问题探讨"><span class="csDE05BCC">php mt_rand</span><span class="csECDA2D3">函数的安全问题探讨</span></a></h1>
		<h2 class="cs868C439D">
			<a name="mtrand-函数的安全性问题"><span class="csB2D98684">mt_rand() </span><span class="cs83F14626">函数的安全性问题</span></a></h2>
		<p class="cs3A447A38"><span class="cs9FB05234">php -r &#39;echo getrandmax().&quot;\n&quot;.mt_getrandmax().&quot;\n&quot;; echo (pow(2,31)-1).&quot;\n&quot;;&#39;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Php/php%20mt_rand%e5%87%bd%e6%95%b0%e7%9a%84%e5%ae%89%e5%85%a8%e9%97%ae%e9%a2%98%e6%8e%a2%e8%ae%a8_files/image0.png" width="560" height="111" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在我的</span><span class="cs8926E06"> linux 64 </span><span class="cs9C1B1871">位系统中</span><span class="cs8926E06">,rand() </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> mt_rand() </span><span class="cs9C1B1871">产生的最大随机数都是</span><span class="cs8926E06">2147483647, </span><span class="cs9C1B1871">正好是</span><span class="cs8926E06"> 2^31-1 , </span><span class="cs9C1B1871">也就是说随机播种的种子也是在这个范围中</span><span class="cs8926E06">,0 &ndash; 2147483647 </span><span class="cs9C1B1871">的这个范围是允许我们进行爆破的</span><span class="cs8926E06">. </span><span class="cs9C1B1871">但是用</span><span class="cs8926E06"> php</span><span class="cs9C1B1871">爆破比较慢</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里放一个爆破</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">的</span><span class="cs8926E06">d</span><span class="cs9C1B1871">地址</span></p><p class="cs40DD2BC9"><span class="cs8926E06">php_mt_seed</span><span class="cs9C1B1871">爆破程序</span><span class="cs8926E06"> <a class="cs508254C" href="https://github.com/ianxtianxt/php-mt_rand"><span class="cs4B51D5E4">https://github.com/ianxtianxt/php-mt_rand</span></a></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">下面演示一下它的用法</span><span class="cs8926E06">:</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Php/php%20mt_rand%e5%87%bd%e6%95%b0%e7%9a%84%e5%ae%89%e5%85%a8%e9%97%ae%e9%a2%98%e6%8e%a2%e8%ae%a8_files/image1.png" width="560" height="295" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在例子中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我没有自己播种种子</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而是让</span><span class="cs8926E06">php</span><span class="cs9C1B1871">自动去播种一个种子并产生一个随机数</span><span class="cs8926E06">,</span><span class="cs9C1B1871">然后用</span><span class="cs8926E06"> php_mt_seed </span><span class="cs9C1B1871">这个工具把产生的随机数作为参数</span><span class="cs8926E06">,</span><span class="cs9C1B1871">去爆破种子</span><span class="cs8926E06">,</span><span class="cs9C1B1871">最后的得到了四个结果</span><span class="cs8926E06">. </span><span class="cs9C1B1871">经过验证</span><span class="cs8926E06">,</span><span class="cs9C1B1871">四个结果都是对的</span><span class="cs8926E06">.</span><span class="cs9C1B1871">都会产生这样的一个随机数</span><span class="cs8926E06">.</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是还有一个疑问</span><span class="cs8926E06">,</span><span class="cs9C1B1871">就是</span><span class="cs8926E06"> php manual </span><span class="cs9C1B1871">中说</span><span class="cs8926E06">,</span><span class="cs9C1B1871">自动播种种子是指</span><span class="cs8926E06">:</span><span class="cs9C1B1871">在每次调用</span><span class="cs8926E06"> mt_rand()</span><span class="cs9C1B1871">函数之前都播种一次种子呢</span><span class="cs8926E06">,</span><span class="cs9C1B1871">还是多次调用</span><span class="cs8926E06"> mt_rand()</span><span class="cs9C1B1871">函数之前</span><span class="cs8926E06">,</span><span class="cs9C1B1871">只播种一次种子呢</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这对于我们能否猜到产生的随机数序列至关重要</span><span class="cs8926E06">.</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">看下面的测试</span><span class="cs8926E06">:</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Php/php%20mt_rand%e5%87%bd%e6%95%b0%e7%9a%84%e5%ae%89%e5%85%a8%e9%97%ae%e9%a2%98%e6%8e%a2%e8%ae%a8_files/image2.png" width="560" height="319" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在测试中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">在没有进行手工播种的情况下产生两个连续的随机数</span><span class="cs8926E06">,</span><span class="cs9C1B1871">然后去爆破种子</span><span class="cs8926E06">,</span><span class="cs9C1B1871">得到了四个可能种子</span><span class="cs8926E06">,</span><span class="cs9C1B1871">经过测试发现其中一个种子产生的随机数序列和预期的相同</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所以可以猜想在</span><span class="cs8926E06">php</span><span class="cs9C1B1871">中产生一系列的随机数时</span><span class="cs8926E06">,</span><span class="cs9C1B1871">只进行了一次播种</span><span class="cs8926E06">!</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">那请考虑下面代码的安全性</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function wp_generate_password($length = 12, $special_chars = true) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$chars = &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if ( $special_chars )</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$chars .= &#39;!@#$%^&amp;*()&#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;$password = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for ( $i = 0; $i &lt; $length; $i++ )</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$password .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return $password;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$key = wp_generate_password(16, false);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;[*] This is a key for public:&quot;.$key.&quot;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$private = wp_generate_password(10,false);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;[*] Create a private key which you don&#39;t know:&quot;.$private.&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们是否可以根据公开的</span><span class="cs8926E06">key,</span><span class="cs9C1B1871">猜到</span><span class="cs8926E06"> $private </span><span class="cs9C1B1871">呢</span><span class="cs8926E06">?</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">运行一次上面的代码</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">njctf$ php mtRand.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] This is a key for public:uS66FDD9LCR62UV3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] Create a private key which you don\&#39;t know:t3JSUHzYAv</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">下面演示破解过程</span><span class="cs8926E06">,</span><span class="cs9C1B1871">首先获得</span><span class="cs8926E06">public key</span><span class="cs9C1B1871">在每一位在字符串中的位置</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$str = &quot;uS66FDD9LCR62UV3&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$randStr = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">for($i=0;$i&lt;strlen($str);$i++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;$pos = strpos($randStr,$str[$i]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;echo $pos.&quot; &quot;.$pos.&quot; &quot;.&quot;0 &quot;.(strlen($randStr)-1).&quot; &quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;//</span><span class="cs7FFD2630">整理成方便</span><span class="cs9FB05234"> php_mt_seed </span><span class="cs7FFD2630">测试的格式</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;//php_mt_seed VALUE_OR_MATCH_MIN [MATCH_MAX [RANGE_MIN RANGE_MAX]]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后用</span><span class="cs8926E06"> php_mt_seed </span><span class="cs9C1B1871">进行破解</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这个需要的时间还是挺长的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">几分钟左右</span><span class="cs8926E06">.</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Php/php%20mt_rand%e5%87%bd%e6%95%b0%e7%9a%84%e5%ae%89%e5%85%a8%e9%97%ae%e9%a2%98%e6%8e%a2%e8%ae%a8_files/image3.png" width="560" height="76" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">已经成功的破解了一个</span><span class="cs8926E06">seed,</span><span class="cs9C1B1871">下面看这个</span><span class="cs8926E06">seed</span><span class="cs9C1B1871">对不对</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function wp_generate_password($length = 12, $special_chars = true) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$chars = &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if ( $special_chars )</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$chars .= &#39;!@#$%^&amp;*()&#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;$password = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for ( $i = 0; $i &lt; $length; $i++ )</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$password .= substr($chars, mt_rand(0, strlen($chars) - 1), 1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return $password;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">mt_srand(4030923041); //</span><span class="cs7FFD2630">手工添加了这个种子</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$key = wp_generate_password(16, false);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;[*] This is a key for public:&quot;.$key.&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$private = wp_generate_password(10,false);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;[*] Create a private key which you don&#39;t know:&quot;.$private.&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟刚才的结果一模一样</span><span class="cs8926E06"> :</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Php/php%20mt_rand%e5%87%bd%e6%95%b0%e7%9a%84%e5%ae%89%e5%85%a8%e9%97%ae%e9%a2%98%e6%8e%a2%e8%ae%a8_files/image4.png" width="560" height="107" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这样就说明了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我们只需要拿到</span><span class="cs8926E06">public key,</span><span class="cs9C1B1871">就可以预测到</span><span class="cs8926E06">private key </span><span class="cs9C1B1871">的值了</span><span class="cs8926E06">.</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是在有的一些环境中，</span><span class="cs8926E06">public key</span><span class="cs9C1B1871">可能在</span><span class="cs8926E06">private key</span><span class="cs9C1B1871">之后产生，但是知道</span><span class="cs8926E06">private key</span><span class="cs9C1B1871">的位数</span><span class="cs8926E06"> </span><span class="cs9C1B1871">怎么预测</span><span class="cs8926E06">private key</span><span class="cs9C1B1871">呢？</span><span class="cs8926E06"> </span><span class="cs9C1B1871">强大的</span><span class="cs8926E06">php_mt_seed_4.0,</span><span class="cs9C1B1871">支持一些统配的写法，把未知的都写成参数</span><span class="cs8926E06"> 0 0 0 0 </span><span class="cs9C1B1871">就可以了</span><span class="cs8926E06">php_mt_seed</span><span class="cs9C1B1871">详细的使用说明。它就会跳过前面的</span><span class="cs8926E06">mt_rand()</span><span class="cs9C1B1871">的一些输出，直接匹配后面的：</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">下面测试我们获得了</span><span class="cs8926E06">private key</span><span class="cs9C1B1871">，来猜测</span><span class="cs8926E06">public key</span><span class="cs9C1B1871">的情况。</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> # mtRand.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$str = &quot;t3JSUHzYAv&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$randStr = &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">for($i=0;$i&lt;strlen($str);$i++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;$pos = strpos($randStr,$str[$i]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;echo $pos.&quot; &quot;.$pos.&quot; &quot;.&quot;0 &quot;.(strlen($randStr)-1).&quot; &quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;//</span><span class="cs7FFD2630">整理成方便</span><span class="cs9FB05234"> php_mt_seed </span><span class="cs7FFD2630">测试的格式</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;//php_mt_seed VALUE_OR_MATCH_MIN [MATCH_MAX [RANGE_MIN RANGE_MAX]]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">下面就开始破解：</span></p><p class="cs3A447A38"><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;Desktop echo &nbsp;$(python -c &quot;print &#39;0 &#39;*64&quot;) $(php mtRand.php) | xargs &nbsp;&nbsp;~/script/php_mt_seed-4.0/php_mt_seed</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Pattern: SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP SKIP EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62 EXACT-FROM-62</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Version: 3.0.7 to 5.2.0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Found 0, trying 0xfc000000 - 0xffffffff, speed 65.2 Mseeds/s</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Version: 5.2.1+</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Found 0, trying 0xf0000000 - 0xf1ffffff, speed 5.5 Mseeds/s</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">seed = 0xf0430121 = 4030923041 (PHP 5.2.1 to 7.0.x; HHVM)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Found 1, trying 0xfe000000 - 0xffffffff, speed 5.5 Mseeds/s</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Found 1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到破解得到的</span><span class="cs8926E06">seed</span><span class="cs9C1B1871">和之前的一样。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接下来看一个</span><span class="cs8926E06"> njctf</span><span class="cs9C1B1871">中的一个例子</span><span class="cs8926E06">,</span><span class="cs9C1B1871">只贴部分关键代码</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function random_str($length = &quot;32&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$set = array(&quot;a&quot;, &quot;A&quot;, &quot;b&quot;, &quot;B&quot;, &quot;c&quot;, &quot;C&quot;, &quot;d&quot;, &quot;D&quot;, &quot;e&quot;, &quot;E&quot;, &quot;f&quot;, &quot;F&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;g&quot;, &quot;G&quot;, &quot;h&quot;, &quot;H&quot;, &quot;i&quot;, &quot;I&quot;, &quot;j&quot;, &quot;J&quot;, &quot;k&quot;, &quot;K&quot;, &quot;l&quot;, &quot;L&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;m&quot;, &quot;M&quot;, &quot;n&quot;, &quot;N&quot;, &quot;o&quot;, &quot;O&quot;, &quot;p&quot;, &quot;P&quot;, &quot;q&quot;, &quot;Q&quot;, &quot;r&quot;, &quot;R&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;s&quot;, &quot;S&quot;, &quot;t&quot;, &quot;T&quot;, &quot;u&quot;, &quot;U&quot;, &quot;v&quot;, &quot;V&quot;, &quot;w&quot;, &quot;W&quot;, &quot;x&quot;, &quot;X&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;y&quot;, &quot;Y&quot;, &quot;z&quot;, &quot;Z&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$str = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for ($i = 1; $i &lt;= $length; ++$i) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ch = mt_rand(0, count($set) - 1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str .= $set[$ch];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $str;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">session_start();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$seed = rand(0,999999999);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">mt_srand($seed);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$ss = mt_rand();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$hash = md5(session_id() . $ss);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">setcookie(&#39;SESSI0N&#39;, $hash, time() + 3600);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$filename = &#39;./uP1O4Ds/&#39; . random_str() . &#39;_&#39; . $_FILES[&#39;file-upload-field&#39;][&#39;name&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们的目标是猜测出</span><span class="cs8926E06">filename. </span><span class="cs9C1B1871">这里</span><span class="cs8926E06"> $seed </span><span class="cs9C1B1871">是</span><span class="cs8926E06"> rand(0,999999999)</span><span class="cs9C1B1871">生成的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我们不知道</span><span class="cs8926E06">,</span><span class="cs9C1B1871">但是</span><span class="cs8926E06">$hash = md5(session_id() . $ss);</span><span class="cs9C1B1871">我们却是知道的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">在</span><span class="cs8926E06"> cookie</span><span class="cs9C1B1871">的</span><span class="cs8926E06">SESSION</span><span class="cs9C1B1871">中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当把</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中的</span><span class="cs8926E06"> PHPSESSID </span><span class="cs9C1B1871">设为空的时候</span><span class="cs8926E06">,session_id()</span><span class="cs9C1B1871">就也是空了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">通过结</span><span class="cs8926E06">hash,</span><span class="cs9C1B1871">就可以获得</span><span class="cs8926E06"> mt_rand() </span><span class="cs9C1B1871">产生的第一个随机数</span><span class="cs8926E06">,</span><span class="cs9C1B1871">然后用</span><span class="cs8926E06"> php_mt_seed</span><span class="cs9C1B1871">这工工具爆破种子</span><span class="cs8926E06">,</span><span class="cs9C1B1871">就可以直接算出文件名了</span><span class="cs8926E06">.</span></p><p class="cs40DD2BC9"><span class="cs8926E06">rand() </span><span class="cs9C1B1871">函数的安全性问题</span><span class="cs8926E06"> rand() </span><span class="cs9C1B1871">函数在产生随机数的时候没有调用</span><span class="cs8926E06"> srand(),</span><span class="cs9C1B1871">则产生的随机数是有规律可询的</span><span class="cs8926E06">. </span><span class="cs9C1B1871">具体的说明请看这里</span><span class="cs8926E06"><a class="cs508254C" href="http://www.sjoerdlangkemper.nl/2016/02/11/cracking-php-rand/"><span class="cs4B51D5E4">http://www.sjoerdlangkemper.nl/2016/02/11/cracking-php-rand/</span></a></span><span class="cs8926E06"> </span><span class="cs9C1B1871">产生的随机数可以用下面这个公式预测</span><span class="cs8926E06"> : state[i] = state[i-3] + state[i-31] (</span><span class="cs9C1B1871">一般预测值可能比实际值要差</span><span class="cs8926E06">1) </span><span class="cs9C1B1871">写下面测试代码</span><span class="cs8926E06">,</span><span class="cs9C1B1871">验证一下</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$randStr = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for($i=0;$i&lt;50;$i++){ &nbsp;//</span><span class="cs7FFD2630">先产生</span><span class="cs9FB05234"> 32</span><span class="cs7FFD2630">个随机数</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$randStr[$i]=rand(0,30);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($i&gt;=31) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo &nbsp;&quot;$randStr[$i]=(&quot;.$randStr[$i-31].&quot;+&quot;.$randStr[$i-3].&quot;) mod 31&quot;.&quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">看一下结果</span><span class="cs8926E06">:</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Php/php%20mt_rand%e5%87%bd%e6%95%b0%e7%9a%84%e5%ae%89%e5%85%a8%e9%97%ae%e9%a2%98%e6%8e%a2%e8%ae%a8_files/image5.png" width="560" height="378" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">发现预测的值</span><span class="cs8926E06">,</span><span class="cs9C1B1871">基本都是对的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这样就可以根据之前生成的随机数</span><span class="cs8926E06">,</span><span class="cs9C1B1871">预</span></p></body>
</html>
