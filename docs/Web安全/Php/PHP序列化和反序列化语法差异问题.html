<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
		</style>
	</head>
	<body>
		<h2 class="cs868C439D">
			<a name="php序列化和反序列化语法差异问题"><span class="csB2D98684">PHP</span><span class="cs83F14626">序列化和反序列化语法差异问题</span></a></h2>
		<h2 class="cs868C439D">
			<a name="介绍"><span class="cs83F14626">介绍</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">官方文档中介绍</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">序列化和反序列化如下：</span></p><p class="cs3A447A38"><span class="cs7FFD2630">所有</span><span class="cs9FB05234">php</span><span class="cs7FFD2630">里面的值都可以使用函数</span><span class="cs9FB05234">serialize()</span><span class="cs7FFD2630">来返回一个包含字节流的字符串来表示。</span><span class="cs9FB05234">unserialize()</span><span class="cs7FFD2630">函数能够重新把字符串变回</span><span class="cs9FB05234">php</span><span class="cs7FFD2630">原来的值。</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">序列化一个对象将会保存对象的所有变量，但是不会保存对象的方法，只会保存类的名字。</span><span class="cs8926E06"><br/><br/></span><span class="cs7FFD2630">为了能够</span><span class="cs9FB05234">unserialize()</span><span class="cs7FFD2630">一个对象，这个对象的类必须已经定义过。如果序列化类</span><span class="cs9FB05234">A</span><span class="cs7FFD2630">的一个对象，将会返回一个跟类</span><span class="cs9FB05234">A</span><span class="cs7FFD2630">相关，而且包含了对象所有变量值的字符串。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">简单说序列化是对象转化字符串的过程，反序列化是字符串还原对象的过程。</span></p><p class="cs3A447A38"><span class="cs8926E06">&nbsp;</span></p><h2 class="cs868C439D">
			<a name="环境"><span class="cs83F14626">环境</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">文章中所述内容使用环境如下</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">PHP7.3.1</span><span class="cs7FFD2630">、</span><span class="cs9FB05234">SDK</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">VSCode</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">C++</span><span class="cs7FFD2630">和</span><span class="cs9FB05234">C</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">环境配置建议参考：《</span><span class="cs8926E06">WINDOWS</span><span class="cs9C1B1871">下用</span><span class="cs8926E06">VSCODE</span><span class="cs9C1B1871">调试</span><span class="cs8926E06">PHP7</span><span class="cs9C1B1871">源代码》</span><span class="cs8926E06"><a class="cs508254C" href="https://www.jianshu.com/p/29bc0443***6"><span class="cs4B51D5E4">https://www.jianshu.com/p/29bc0443</span><span class="csBF12A472">*</span><span class="cs4B51D5E4">6</span></a></span><span class="cs8926E06"> (</span><span class="cs9C1B1871">作者经过几小时尝试后找到最全的版本</span><span class="cs8926E06">)</span></p><p class="cs3A447A38"><span class="cs8926E06">&nbsp;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在网上公开参数反序列化执行流程已经非常详细，但是对于一些细节地方有一些不足，其中就包括序列化和反序列化之间的语法差异问题</span></p><h2 class="cs868C439D">
			<a name="差异问题"><span class="cs83F14626">差异问题</span></a></h2>
		<h4 class="cs868C439D">
			<a name="序列化"><span class="cs6EDCDAE2">序列化</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们通过编译</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">内核源码分析，发现</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">序列化在默认情况下在对象转换中加入</span><span class="cs8926E06">:{</span><span class="cs9C1B1871">和</span><span class="cs8926E06">}</span><span class="cs9C1B1871">用来拼接成字符串。</span></p><p class="cs3A447A38"><span class="cs9FB05234">[var.c]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Line:882</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">static void php_var_serialize_intern()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Line:896</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if (ce-&gt;serialize(struc, &amp;serialized_data, &amp;serialized_length, (zend_serialize_data *)var_hash) == SUCCESS) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smart_str_appendl(buf, &quot;C:&quot;, 2);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smart_str_append_unsigned(buf, ZSTR_LEN(Z_OBJCE_P(struc)-&gt;name));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smart_str_appendl(buf, &quot;:\&quot;&quot;, 2);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smart_str_append(buf, Z_OBJCE_P(struc)-&gt;name);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smart_str_appendl(buf, &quot;\&quot;:&quot;, 2);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smart_str_append_unsigned(buf, serialized_length);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smart_str_appendl(buf, &quot;:{&quot;, 2);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smart_str_appendl(buf, (char *) serialized_data, serialized_length);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;smart_str_appendc(buf, &#39;}&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Line:952</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">smart_str_appendl(buf, &quot;:{&quot;, 2);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Line:995</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">smart_str_appendc(buf, &#39;}&#39;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">咱们来看上面这段代码，</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">会使用</span><span class="cs8926E06">smart_str_appendl</span><span class="cs9C1B1871">为序列化字符串前后拼接</span><span class="cs8926E06">:{</span><span class="cs9C1B1871">和</span><span class="cs8926E06">}</span><span class="cs9C1B1871">，从</span><span class="cs8926E06">var.c</span><span class="cs9C1B1871">的第</span><span class="cs8926E06">882</span><span class="cs9C1B1871">行开始进入序列化逻辑。在第</span><span class="cs8926E06">896</span><span class="cs9C1B1871">行进行序列化字符串拼接，第</span><span class="cs8926E06">952</span><span class="cs9C1B1871">行和第</span><span class="cs8926E06">995</span><span class="cs9C1B1871">行，对于内嵌方法进行拼接。</span></p><h4 class="cs868C439D">
			<a name="反序列化"><span class="cs6EDCDAE2">反序列化</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">反序列化是将序列化的字符串，按照一定语法规则进行转化还原。</span></p><p class="cs3A447A38"><span class="cs9FB05234">[var_unserialize.c]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Line:655</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">static int php_var_unserialize_internal()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Line:674</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;YYCTYPE yych;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;static const unsigned char yybm[] = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;128, 128, 128, 128, 128, 128, 128, 128, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;128, 128, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, &nbsp;&nbsp;0, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ((YYLIMIT - YYCURSOR) &lt; 7) YYFILL(7);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;yych = *YYCURSOR;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;switch (yych) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;C&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;O&#39;: &nbsp;&nbsp;&nbsp;goto yy4;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;N&#39;: &nbsp;&nbsp;&nbsp;goto yy5;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;R&#39;: &nbsp;&nbsp;&nbsp;goto yy6;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;S&#39;: &nbsp;&nbsp;&nbsp;goto yy7;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;a&#39;: &nbsp;&nbsp;&nbsp;goto yy8;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;b&#39;: &nbsp;&nbsp;&nbsp;goto yy9;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;d&#39;: &nbsp;&nbsp;&nbsp;goto yy10;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;i&#39;: &nbsp;&nbsp;&nbsp;goto yy11;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;o&#39;: &nbsp;&nbsp;&nbsp;goto yy12;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;r&#39;: &nbsp;&nbsp;&nbsp;goto yy13;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;s&#39;: &nbsp;&nbsp;&nbsp;goto yy14;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case &#39;}&#39;: &nbsp;&nbsp;&nbsp;goto yy15;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;default: &nbsp;&nbsp;&nbsp;goto yy2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Line:776</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">yy15:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;++YYCURSOR;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;/* this is the case where we have less data than planned */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;php_error_docref(NULL, E_NOTICE, &quot;Unexpected end of serialized data&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return 0; /* not sure if it should be 0 or 1 here? */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过内核代码能够看到第</span><span class="cs8926E06">655</span><span class="cs9C1B1871">行进入反序列化，反序列化是利用词法扫描，判断各项符号转换对应对象。能够看到反序列化中对于</span><span class="cs8926E06">}</span><span class="cs9C1B1871">进行了处理，处理中只是对计数器加一并没有其他操作。</span></p><p class="cs3A447A38"><span class="cs8926E06">&nbsp;</span></p><h2 class="cs868C439D">
			<a name="实际作用"><span class="cs83F14626">实际作用</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">反序列化语法的差异，对于安全防护设备判断反序列化产生很大的影响。在</span><span class="cs8926E06">Snort</span><span class="cs9C1B1871">中，有段规则如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">alert tcp any any -&gt; any [80,8080,443] (uricontent:&quot;.php&quot;; pcre:&quot;/\{\w:.+?\}/&quot;; sid:1; msg:php_serialize;)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在攻击载荷中可以使用大多数字符代替</span><span class="cs8926E06">{},</span><span class="cs9C1B1871">从而导致规则失效。</span></p><p class="cs3A447A38"><span class="cs8926E06">&nbsp;</span></p><h2 class="cs868C439D">
			<a name="总结"><span class="cs83F14626">总结</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在红队攻击中可以利用</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">序列化和反序列化语法差异，从而达到绕过防护的目的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在蓝队防御中建议考虑定义中所述</span><span class="cs7FFD2630">不会保存对象的方法，只会保存类的名字。</span><span class="cs9C1B1871">，拦截保存类的名字，以及语法中相同的字符</span></p></body>
</html>
