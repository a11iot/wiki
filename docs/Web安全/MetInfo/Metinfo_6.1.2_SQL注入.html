<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="metinfo-612-sql注入"><span class="csDE05BCC">Metinfo 6.1.2 SQL</span><span class="csECDA2D3">注入</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞文件：</span><span class="cs8926E06">/var/www/html/metinfo6.1.2/app/system/message/web/message.class.php </span><span class="cs9C1B1871">漏洞函数：</span><span class="cs8926E06">add 37-51</span><span class="cs9C1B1871">行</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function add($info) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global $_M;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$_M[form][id]){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;$message=DB::get_one(&quot;select * from {$_M[table][column]} where module= 7 and lang =&#39;{$_M[form][lang]}&#39;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;$_M[form][id]=$message[id];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$met_fd_ok=DB::get_one(&quot;select * from {$_M[table][config]} where lang =&#39;{$_M[form][lang]}&#39; and &nbsp;name= &#39;met_fd_ok&#39; and columnid = {$_M[form][id]}&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$_M[config][met_fd_ok]= $met_fd_ok[value];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!$_M[config][met_fd_ok])okinfo(&#39;javascript:history.back();&#39;,&quot;{$_M[word][Feedback5]}&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($_M[config][met_memberlogin_code]){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!load::sys_class(&#39;pin&#39;, &#39;new&#39;)-&gt;check_pin($_M[&#39;form&#39;][&#39;code&#39;])){</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;okinfo(-1, $_M[&#39;word&#39;][&#39;membercode&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞触发点：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$met_fd_ok=DB::get_one(&quot;select * from {$_M[table][config]} where lang =&#39;{$_M[form][lang]}&#39; and &nbsp;name= &#39;met_fd_ok&#39; and columnid = {$_M[form][id]}&quot;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">由于无单引号过滤导致</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">注入，这个时候尝试注入发现关键词全被替换了，无法注入。于是查看</span><span class="cs8926E06">__controler</span><span class="cs9C1B1871">函数发现调用了父类的初始化函数。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">class feedback extends web</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06">web</span><span class="cs9C1B1871">类，没有对用户传入的数据进行过滤等操作，却初始化了</span><span class="cs8926E06">common</span><span class="cs9C1B1871">类</span></p><p class="cs40DD2BC9"><span class="cs8926E06">class web extends common</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">查看</span><span class="cs8926E06">Common</span><span class="cs9C1B1871">类的初始化函数发现了问题所在</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function __construct() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global $_M;//</span><span class="cs7FFD2630">全局数组</span><span class="cs9FB05234">$_M</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ob_start();//</span><span class="cs7FFD2630">开启缓存</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;load_mysql();//</span><span class="cs7FFD2630">数据库连接</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;load_form();//</span><span class="cs7FFD2630">表单过滤</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;load_lang();//</span><span class="cs7FFD2630">加载语言配置</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;load_config_global();//</span><span class="cs7FFD2630">加载全站配置数据</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;load_url_site();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;load_config_lang();//</span><span class="cs7FFD2630">加载当前语言配置数据</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;load_url();//</span><span class="cs7FFD2630">加载</span><span class="cs9FB05234">url</span><span class="cs7FFD2630">数据</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟踪</span><span class="cs8926E06"> $this&rarr;load_form() </span><span class="cs9C1B1871">函数</span></p><p class="cs3A447A38"><span class="cs9FB05234">protected function load_form() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global $_M;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_M[&#39;form&#39;] =array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;isset($_REQUEST[&#39;GLOBALS&#39;]) &amp;&amp; exit(&#39;Access Error&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($_COOKIE as $_key =&gt; $_value) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_key{0} != &#39;_&#39; &amp;&amp; $_M[&#39;form&#39;][$_key] = daddslashes($_value);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($_POST as $_key =&gt; $_value) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_key{0} != &#39;_&#39; &amp;&amp; $_M[&#39;form&#39;][$_key] = daddslashes($_value);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($_GET as $_key =&gt; $_value) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_key{0} != &#39;_&#39; &amp;&amp; $_M[&#39;form&#39;][$_key] = daddslashes($_value);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(is_numeric($_M[&#39;form&#39;][&#39;lang&#39;])){//</span><span class="cs7FFD2630">伪静态兼容</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_M[&#39;form&#39;][&#39;page&#39;] = $_M[&#39;form&#39;][&#39;lang&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_M[&#39;form&#39;][&#39;lang&#39;] = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($_M[&#39;form&#39;][&#39;metid&#39;] == &#39;list&#39;){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_M[&#39;form&#39;][&#39;list&#39;] = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_M[&#39;form&#39;][&#39;metid&#39;] = $_M[&#39;form&#39;][&#39;page&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_M[&#39;form&#39;][&#39;page&#39;] = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!preg_match(&#39;/^[0-9A-Za-z]+$/&#39;, $_M[&#39;form&#39;][&#39;lang&#39;]) &amp;&amp; $_M[&#39;form&#39;][&#39;lang&#39;]){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo &quot;No data in the database,please reinstall.&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">把</span><span class="cs8926E06">COOKIE</span><span class="cs9C1B1871">、</span><span class="cs8926E06">POST</span><span class="cs9C1B1871">、</span><span class="cs8926E06">GET </span><span class="cs9C1B1871">传入</span><span class="cs8926E06"> daddslashes</span><span class="cs9C1B1871">函数进行过滤</span></p><p class="cs3A447A38"><span class="cs9FB05234">function daddslashes($string, $force = 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!defined(&#39;MAGIC_QUOTES_GPC&#39;) &amp;&amp; define(&#39;MAGIC_QUOTES_GPC&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_magic_quotes_gpc());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!MAGIC_QUOTES_GPC || $force) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(is_array($string)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($string as $key =&gt; $val) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$string[$key] = daddslashes($val, $force);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!defined(&#39;IN_ADMIN&#39;)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$string = trim(addslashes(sqlinsert($string)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$string = trim(addslashes($string));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $string;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里判断是否开启了</span><span class="cs8926E06">get_magic_quotes_gpc() </span><span class="cs9C1B1871">如果没开启或者</span><span class="cs8926E06"> $force !=0 </span><span class="cs9C1B1871">就进入过滤。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">然而最重要的环节在这里</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp; &nbsp;&nbsp;if(!defined(&#39;IN_ADMIN&#39;)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$string = trim(addslashes(sqlinsert($string)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$string = trim(addslashes($string));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">判断</span><span class="cs8926E06"> IN_ADMIN </span><span class="cs9C1B1871">常量是否已经定义了，如果没定义就使用</span><span class="cs8926E06">$string = trim(addslashes(sqlinsert($string)));</span><span class="cs9C1B1871">来过滤我们的值</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而如果定义了就使用</span><span class="cs8926E06">$string = trim(addslashes($string));</span><span class="cs9C1B1871">来过滤。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">刚刚我们进行</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">注入测试失败而且语句被过滤了，</span><span class="cs8926E06"> addslashes</span><span class="cs9C1B1871">只过滤特殊字符，所以我们肯定是被</span><span class="cs8926E06"> sqlinsert</span><span class="cs9C1B1871">函数给过滤了。导致我们无法</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">注入。至于</span><span class="cs8926E06">sqlinsert</span><span class="cs9C1B1871">函数我就不贴出来了，我们要做的是饶过这个函数，而不是饶过他这个规则。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">defined(&#39;IN_ADMIN&#39;) </span><span class="cs9C1B1871">我们需要找这个常量在哪里定义的。其实写这句话有点多余，看过我之前几篇</span><span class="cs8926E06">Metinfo</span><span class="cs9C1B1871">漏洞的话应该就会发现问题了。我写过一个关于</span><span class="cs8926E06">/admin/index.php</span><span class="cs9C1B1871">文件任意调用带</span><span class="cs8926E06">do</span><span class="cs9C1B1871">方法的问题。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后我们打开这个文件看一下。</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;IN_ADMIN&#39;, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$M_MODULE=&#39;admin&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(@$_GET[&#39;m&#39;])$M_MODULE=$_GET[&#39;m&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(@!$_GET[&#39;n&#39;])$_GET[&#39;n&#39;]=&quot;index&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(@!$_GET[&#39;c&#39;])$_GET[&#39;c&#39;]=&quot;index&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(@!$_GET[&#39;a&#39;])$_GET[&#39;a&#39;]=&quot;doindex&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">@define(&#39;M_NAME&#39;, $_GET[&#39;n&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">@define(&#39;M_MODULE&#39;, $M_MODULE);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">@define(&#39;M_CLASS&#39;, $_GET[&#39;c&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">@define(&#39;M_ACTION&#39;, $_GET[&#39;a&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">require_once &#39;../app/system/entrance.php&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">没错这个常量就是在这个文件定义的。而且他可以调用任意带</span><span class="cs8926E06">do</span><span class="cs9C1B1871">方法。不过问题又来了，漏洞函数是</span><span class="cs8926E06">add</span><span class="cs9C1B1871">并且不带</span><span class="cs8926E06">do</span><span class="cs9C1B1871">，那就找调用白，于是找到</span><span class="cs8926E06"> domessage</span><span class="cs9C1B1871">这个函数。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">domessage</span><span class="cs9C1B1871">方法</span><span class="cs8926E06"> 18-24</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function domessage() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global $_M;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($_M[&#39;form&#39;][&#39;action&#39;] == &#39;add&#39;){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;check_field();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this&rarr;add($_M[&#39;form&#39;]);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里在调用</span><span class="cs8926E06"> add</span><span class="cs9C1B1871">方法之前先调用了</span><span class="cs8926E06"> check_field</span><span class="cs9C1B1871">方法，我们要做的就是保证程序能够顺利执行到</span><span class="cs8926E06">add</span><span class="cs9C1B1871">方法，研究了一会发现只需要正常留言，把它传递的参数拷下来就</span><span class="cs8926E06">ok</span><span class="cs9C1B1871">了。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">然后顺利执行到了</span><span class="cs8926E06">add</span><span class="cs9C1B1871">方法，成功的进行了</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">注入。</span></p><p class="cs3A447A38"><span class="cs9FB05234">payload</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">http:/0-sec.org/metinfo6//admin/index.php?m=web&amp;n=message&amp;c=message&amp;a=domessage&amp;action=add&amp;lang=cn&para;137=1&para;186=1&para;138=1&para;139=1&para;140=1&amp;id=42</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里说一下这个</span><span class="cs8926E06">id=42</span><span class="cs9C1B1871">，这个值</span><span class="cs8926E06">42</span><span class="cs9C1B1871">是不能修改的，目的是让他返回验证码错误，饶过了第一层判断。</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp; &nbsp;&nbsp;if(!$_M[config][met_fd_ok])okinfo(&#39;javascript:history.back();&#39;,&quot;{$_M[word][Feedback5]}&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($_M[config][met_memberlogin_code]){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(!load::sys_class(&#39;pin&#39;, &#39;new&#39;)-&gt;check_pin($_M[&#39;form&#39;][&#39;code&#39;])){</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;okinfo(-1, $_M[&#39;word&#39;][&#39;membercode&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">至于为什么让他饶过第一层判断返回验证码错误，这样的话我们可以布尔盲注，否则只能进行时间注入。这里不多解释，自己研究一下。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MetInfo/Metinfo%206.1.2%20SQL%e6%b3%a8%e5%85%a5_files/image0.png" width="560" height="217" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/MetInfo/Metinfo%206.1.2%20SQL%e6%b3%a8%e5%85%a5_files/image1.png" width="560" height="236" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="解决方法"><span class="csD6CA00D2">解决方法</span></a></h3>
		<p class="cs3A447A38"><span class="cs7FFD2630">修改文件：</span><span class="cs9FB05234">metinfo6.1.2/app/system/message/web/message.class.php</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">修改内容：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$met_fd_ok=DB::get_one(&quot;select * from {$_M[table][config]} where lang =&#39;{$_M[form][lang]}&#39; and &nbsp;name= &#39;met_fd_ok&#39; and columnid = {$_M[form][id]}&quot;);</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">修改为：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$met_fd_ok=DB::get_one(&quot;select * from {$_M[table][config]} where lang =&#39;{$_M[form][lang]}&#39; and &nbsp;name= &#39;met_fd_ok&#39; and columnid = &lsquo;{$_M[form][id]}&rsquo;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">这样就解决了。</span></p><h3 class="cs868C439D">
			<a name="漏洞验证脚本"><span class="csD6CA00D2">漏洞验证脚本</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">https://github.com/ianxtianxt/Metinfo-6.1.2-SQL-inj</span></p></body>
</html>
