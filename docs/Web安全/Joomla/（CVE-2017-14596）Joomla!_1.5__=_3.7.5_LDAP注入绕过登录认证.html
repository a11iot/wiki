<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="Xb0877bfecdbab5f7ba8fcbc7326d10e296d3e8f"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2017-14596</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Joomla! 1.5 &lt;= 3.7.5 LDAP</span><span class="csECDA2D3">注入绕过登录认证</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">通过在登录页面利用该漏洞进行攻击，非特权的远程攻击者可以提取出</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">服务器中所有的用户凭证（用于安装</span><span class="cs8926E06">Joomla!</span><span class="cs9C1B1871">），这些凭证包括特权用户以及</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">！管理员的用户名以及密码。获取到这些凭证之后，攻击者就可以使用这些信息来登录</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">！的管理员控制面板并完全接管</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">！，或者通过上传自定义的</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">！扩展实现远程代码执行并相关的</span><span class="cs8926E06">Web</span><span class="cs9C1B1871">服务器。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Joomla! 1.5 &lt;= 3.7.5</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们的代码分析解决方案</span><span class="cs8926E06">RIPS</span><span class="cs9C1B1871">能够自动化识别出下列代码段中的安全漏洞。首先在</span><span class="cs8926E06">LoginController</span><span class="cs9C1B1871">中，</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">！应用可以从登录表单中接收用户提供的凭证数据。</span></p><h3 class="cs868C439D">
			<a name="X21e421cf29540d33ca1a285be5a37358dd40e88"><span class="csD1E291E2">/administrator/components/com_login/controller.php</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">1.png</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">凭证数据会被传递给</span><span class="cs8926E06">login</span><span class="cs9C1B1871">方法，而</span><span class="cs8926E06">login</span><span class="cs9C1B1871">方法中又会调用</span><span class="cs8926E06">authenticate</span><span class="cs9C1B1871">方法。</span></p><h3 class="cs868C439D">
			<a name="librariescmsapplicationcmsphp"><span class="csD1E291E2">/libraries/cms/application/cms.php</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">2.png</span></p><h3 class="cs868C439D">
			<a name="X911dceabbfb1120b8249fce42405f06123012c0"><span class="csD1E291E2">/libraries/joomla/authentication/authentication.php</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">3.png</span></p><p class="cs40DD2BC9"><span class="cs8926E06">authenticate</span><span class="cs9C1B1871">方法可以向</span><span class="cs8926E06">onUserAuthenticate</span><span class="cs9C1B1871">方法发送用户凭证，具体方法取决于管理员所使用的身份验证插件。如果</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">！在进行身份验证时使用的是</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">，那么这里将需要调用</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">插件的内置方法。</span></p><h3 class="cs868C439D">
			<a name="pluginsauthenticationldapldapphp"><span class="csD1E291E2">/plugins/authentication/ldap/ldap.php</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">4.png</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">插件中，</span><span class="cs8926E06">username</span><span class="cs9C1B1871">嵌入在</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">查询语句（在</span><span class="cs8926E06">search_string</span><span class="cs9C1B1871">选项中指定）中。根据</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">！的官方文档，</span><span class="cs8926E06">search_string</span><span class="cs9C1B1871">配置选项是一个用于搜索用户的查询字符串，其中的</span><span class="cs8926E06">[search]</span><span class="cs9C1B1871">会被登录表单中的搜索文本直接替换，例如</span><span class="cs8926E06">&ldquo;uid=[search]&rdquo;</span><span class="cs9C1B1871">。接下来，</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">查询语句会被传递给</span><span class="cs8926E06">LdapClient</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">simple_search</span><span class="cs9C1B1871">方法，这个函数负责与</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">服务器建立连接并执行</span><span class="cs8926E06">ldap_search</span><span class="cs9C1B1871">方法。</span></p><h3 class="cs868C439D">
			<a name="X472c5e447f9082ca69aad81a00fe6bf0dc971be"><span class="csD1E291E2">/libraries/vendor/joomla/ldap/src/LdapClient.php</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">5.png</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">即使</span><span class="cs8926E06">RIPS</span><span class="cs9C1B1871">没有能够发现</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">查询字符串是从一个外部配置文件加载进来的，但</span><span class="cs8926E06">RIPS</span><span class="cs9C1B1871">仍然能够成功检测并报告这个漏洞的根本原因：传递给</span><span class="cs8926E06">ldap_search</span><span class="cs9C1B1871">函数的用户输入虽然嵌入在了</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">查询语句中，但输入数据并没有经过数据清洗。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">由于没有对</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">查询语句中的</span><span class="cs8926E06">username</span><span class="cs9C1B1871">数据进行过滤，这将导致攻击者能够修改</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">搜索的结果集合。通过使用特殊字符并观察不同的认证错误信息，攻击者将能够通过不断地发送测试</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">来暴力破解出凭证字符。</span></p><p class="cs3A447A38"><span class="cs9FB05234">XXX;(&amp;(uid=Admin)(userPassword=A*))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">XXX;(&amp;(uid=Admin)(userPassword=B*))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">XXX;(&amp;(uid=Admin)(userPassword=C*))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">XXX;(&amp;(uid=Admin)(userPassword=s*))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">XXX;(&amp;(uid=Admin)(userPassword=se*))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">XXX;(&amp;(uid=Admin)(userPassword=sec*))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">XXX;(&amp;(uid=Admin)(userPassword=secretPassword))</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其中的每一行</span><span class="cs8926E06">Payload</span><span class="cs9C1B1871">代码都可以从</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">服务器中提取出目标数据，而这也是一种相对非常高效的</span><span class="cs8926E06">LDAP</span><span class="cs9C1B1871">盲注攻击方式。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可通过一次次爆破尝试出后台账号密码</span><span class="cs8926E06"><br/>6.png<br/>7.png</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://www.freebuf.com/articles/web/149059.html</span></p><p class="cs6FD73CFB"><span class="cs8926E06">https://twitter.com/ripstech/status/1094999251417993216</span></p></body>
</html>
