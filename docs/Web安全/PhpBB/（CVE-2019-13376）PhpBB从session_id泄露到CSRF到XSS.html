<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="Xfbdf5a32b8089aa32273a30176161392c324bef"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-13376</span><span class="csECDA2D3">）</span><span class="csDE05BCC">PhpBB</span><span class="csECDA2D3">从</span><span class="csDE05BCC">session id</span><span class="csECDA2D3">泄露到</span><span class="csDE05BCC">CSRF</span><span class="csECDA2D3">到</span><span class="csDE05BCC">XSS</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">该漏洞源于</span><span class="cs8926E06">WEB</span><span class="cs9C1B1871">应用未充分验证请求是否来自可信用户。攻击者可利用该漏洞通过受影响客户端向服务器发送非预期的请求。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">PhpBB 3.2.7</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先来看一下</span><span class="cs8926E06">phpBB</span><span class="cs9C1B1871">的后台，也就是</span><span class="cs8926E06">ACP</span><span class="cs9C1B1871">页面</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image0.png" width="560" height="277" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以发现所有后台功能的</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中都会携带着</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">（</span><span class="cs8926E06">session id</span><span class="cs9C1B1871">）参数：</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org/phpbb/phpBB/adm/index.php?sid=9c4869b4054e9ff8d4d588c32ffcf7e7&amp;i=1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">值错误，即使已经登录后台也无法正常的访问后台页面</span></p><p class="cs40DD2BC9"><span class="cs8926E06">phpbb</span><span class="cs9C1B1871">程序这样做的确有着这样做的优点，但也存在着很严重的安全隐患</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">优点：</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在后台功能</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中加入</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">，相当于增加了一层安全屏障，降低了后台页面出现</span><span class="cs8926E06">CSRF</span><span class="cs9C1B1871">漏洞的几率，为什么这样说呢？假使因为开发疏忽，一个表单提交页面没有利用随机数对用户提交的表单进行保护，这通常会导致</span><span class="cs8926E06">CSRF</span><span class="cs9C1B1871">漏洞的产生。但是在</span><span class="cs8926E06">phpbb</span><span class="cs9C1B1871">应用中，所有的后台功能</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中都加入了</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">参数且</span><span class="cs8926E06">phpbb</span><span class="cs9C1B1871">对</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">参数值合法性进行校验，即使攻击者在后台发现了一处没有随机数保护的表单提交页面，但在不知道管理</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">员</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">值的情况下，也无法构造出一个有效的恶意表单提交页面地址</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">安全隐患：</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这样的操作相当于在</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中存放了本来只应该出现在</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">session id</span><span class="cs9C1B1871">。如果</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">被泄露，攻击者有机会利用这个值伪造管理员身份进行登录后台操作（但不一定可以直接利用，这里涉及到</span><span class="cs8926E06">phpBB</span><span class="cs9C1B1871">的一个安全机制，后文会讲到）。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">注意看，</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">值与</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中的值完全一样，它们都是此用户的</span><span class="cs8926E06">session id</span><span class="cs9C1B1871">值</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image1.png" width="560" height="233" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">至于</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中</span><span class="cs8926E06">session</span><span class="cs9C1B1871">值的</span><span class="cs8926E06">key </span><span class="cs9C1B1871">：</span><span class="cs8926E06">phpbb3_qnsnz_sid</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image2.png" width="560" height="228" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这个值在系统安装完成之后是固定的，无论什么身份的用户访问都是这个值</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此，如果管理员访问的</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">值被泄露，攻击者可以有机会利用这个值构造</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">以便使用管理员身份登录后台</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是如何获取这个暴露在</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">值呢</span><span class="cs8926E06">?</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">由于</span><span class="cs8926E06">phpbb</span><span class="cs9C1B1871">的设计特色：当管理员使用完后台功能后想要切换到前台，后台页面中提供了一个跳转到前台地址的按钮</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当管理员点击这个按钮切换到前台时，</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中会带有</span><span class="cs8926E06">sid<br/><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image3.png" width="560" height="260" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其实前台页面的访问并不需要在</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中使用</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">，但从后台切换过来后</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中会默认带上这个值。这就导致本应该只在后台功能</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中出现的管理员</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">泄露到了管理员访问的前台功能</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中，而这个存在于</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">值很容易在前台页面加载远程资源时在</span><span class="cs8926E06">HTTP_REFERER</span><span class="cs9C1B1871">中被泄露</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">例如：在一些</span><span class="cs8926E06">phpbb</span><span class="cs9C1B1871">站点中可能会开启远程头像选项</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image4.png" width="560" height="286" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这个功能并不是默认开启的，当此功能开启后，用户可以设置远程头像</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image5.png" width="560" height="289" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image6.png" width="560" height="331" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">程序会在使用这个远程头像的时候将其加载进来</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image7.png" width="560" height="49" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果管理员此时访问的页面在渲染时加载了攻击者的远程头像，且此时管理员访问的</span><span class="cs8926E06">url</span><span class="cs9C1B1871">中带有</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">，</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">将会被泄露</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image8.png" width="560" height="262" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们是否可以构造一个恶意的远程图片链接</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">，用以接收管理员的</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">呢？</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先看一下</span><span class="cs8926E06">phpBB</span><span class="cs9C1B1871">在后台程序如何校验远程图片链接，</span><span class="cs8926E06">phpBB</span><span class="cs9C1B1871">使用</span><span class="cs8926E06">getImageSize</span><span class="cs9C1B1871">对用户添加的远程图片链接进行校验</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image9.png" width="560" height="176" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">因此我们可以构造如下</span><span class="cs8926E06">poc</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image10.png" width="560" height="346" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">poc.php</span><span class="cs9C1B1871">除了需要记录加载该图片请求中的</span><span class="cs8926E06">HTTP_REFERER</span><span class="cs9C1B1871">，同时需要将图片进行返回展示</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image11.png" width="560" height="335" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">构造远程图片链接</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://wwww.0-sec.org/poc.php?avatar.png</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image12.png" width="560" height="286" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">攻击者的头像加载成功</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是如何使得管理员加载这个头像资源呢？</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">只要给管理员留言，或者评论管理员发布的文章即可</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">以评论文章为例：当针对管理员发布的文章发表一条评论之后，管理员在前端页面即可收到一个消息提示</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image13.png" width="560" height="306" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">点看之后可以看到被加载的头像</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image14.png" width="560" height="292" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但无论管理员点开与否，在</span><span class="cs8926E06">phpbb</span><span class="cs9C1B1871">首页加载时，都会远程加载这个资源，</span><span class="cs8926E06">HTTP_REFERER</span><span class="cs9C1B1871">都会被发送到攻击者的服务器上</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image15.png" width="560" height="304" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image16.png" width="560" height="141" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">到此为止，攻击者可以顺利获得</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">值。但为什么上文说获取了</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">值也不一定可以盗用管理员身份登录系统呢？</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">phpBB</span><span class="cs9C1B1871">中有如下的安全策略</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image17.png" width="560" height="178" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">Session IP validation</span><span class="cs9C1B1871">选项用来验证当前用户会话绑定的</span><span class="cs8926E06">IP</span><span class="cs9C1B1871">；</span><span class="cs8926E06">All</span><span class="cs9C1B1871">选项代表匹配完整地址，</span><span class="cs8926E06">A.B.C</span><span class="cs9C1B1871">选项匹配前面的</span><span class="cs8926E06">x.x.x</span><span class="cs9C1B1871">段，</span><span class="cs8926E06">A.B</span><span class="cs9C1B1871">选项匹配</span><span class="cs8926E06">x.x</span><span class="cs9C1B1871">，</span><span class="cs8926E06">None</span><span class="cs9C1B1871">选项关闭</span><span class="cs8926E06">IP</span><span class="cs9C1B1871">检查。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这项安全策略是用来检验用户</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">与</span><span class="cs8926E06">IP</span><span class="cs9C1B1871">的绑定关系，系统默认采用</span><span class="cs8926E06">A.B.C</span><span class="cs9C1B1871">选项，因此攻击者在获取了管理员</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">后，想要冒用身份也是很困难的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然而这也不是无解的：</span></p><p class="cs40DD2BC9"><span class="cs8926E06">phpBB</span><span class="cs9C1B1871">后台管理中包含着编辑</span><span class="cs8926E06">BBCode</span><span class="cs9C1B1871">的功能。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">BBCode</span><span class="cs9C1B1871">是</span><span class="cs8926E06">Bulletin Board Code</span><span class="cs9C1B1871">的缩写，也有译为「</span><span class="cs8926E06">BB</span><span class="cs9C1B1871">代码」的，属于轻量标记语言（</span><span class="cs8926E06">Lightweight Markup Language</span><span class="cs9C1B1871">）的一种，如字面上所显示的，它主要是使用在</span><span class="cs8926E06">BBS</span><span class="cs9C1B1871">、论坛、</span><span class="cs8926E06">Blog</span><span class="cs9C1B1871">等网络应用上。</span><span class="cs8926E06">BBcode</span><span class="cs9C1B1871">的语法通常为</span><span class="cs8926E06"> [</span><span class="cs9C1B1871">标记</span><span class="cs8926E06">] </span><span class="cs9C1B1871">这种形式，即语法左右用两个中括号包围，以作为与正常文字间的区别。系统解译时遇上中括号便知道该处是</span><span class="cs8926E06">BBcode</span><span class="cs9C1B1871">，会在解译结果输出到用户端时转换成最为通用的</span><span class="cs8926E06">HTML</span><span class="cs9C1B1871">语法。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image18.png" width="560" height="237" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当然，作为后台管理功能，访问此处</span><span class="cs8926E06">url</span><span class="cs9C1B1871">也需要</span><span class="cs8926E06">sid</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image19.png" width="560" height="192" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">由于上文的利用，攻击者可以获取</span><span class="cs8926E06">sid</span><span class="cs9C1B1871">，因此这里可以确定管理员此处后台功能的确切</span><span class="cs8926E06">url</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在此页面上，管理员可以添加，删除和编辑自定义</span><span class="cs8926E06">BBCode</span><span class="cs9C1B1871">。假如定义了这样的</span><span class="cs8926E06">BBCode</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image20.png" width="560" height="155" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">用户可以在</span><span class="cs8926E06">PM</span><span class="cs9C1B1871">、话题或者帖子中使用这个</span><span class="cs8926E06">BBCode</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image21.png" width="560" height="300" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">结果如下</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image22.png" width="560" height="356" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然而</span><span class="cs8926E06">phpBB</span><span class="cs9C1B1871">中编辑</span><span class="cs8926E06">BBCode</span><span class="cs9C1B1871">的功能存在</span><span class="cs8926E06">CSRF</span><span class="cs9C1B1871">问题，首先看一下编辑</span><span class="cs8926E06">BBCode</span><span class="cs9C1B1871">功能的后台代码</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image23.png" width="560" height="266" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到，这里的确有对</span><span class="cs8926E06">csrf</span><span class="cs9C1B1871">进行防范</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image24.png" width="560" height="110" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是问题出在了前面的</span><span class="cs8926E06">$submit</span><span class="cs9C1B1871">参数：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image25.png" width="560" height="263" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">只有提交的</span><span class="cs8926E06">POST</span><span class="cs9C1B1871">请求中存在</span><span class="cs8926E06">submit</span><span class="cs9C1B1871">参数，系统才会检查</span><span class="cs8926E06">CSRF nonce</span><span class="cs9C1B1871">。反之不会</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此，只要构造</span><span class="cs8926E06">csrf</span><span class="cs9C1B1871">时，请求中不带</span><span class="cs8926E06">submit</span><span class="cs9C1B1871">参数即可</span></p><p class="cs40DD2BC9"><span class="cs8926E06">$action</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$bbcode_id</span><span class="cs9C1B1871">、</span><span class="cs8926E06">$bbcode_match</span><span class="cs9C1B1871">与</span><span class="cs8926E06">$bbcode_tpl</span><span class="cs9C1B1871">参数均有</span><span class="cs8926E06">$request-&gt;variable</span><span class="cs9C1B1871">方式获取而来</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image26.png" width="560" height="131" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/PhpBB/%ef%bc%88CVE-2019-13376%ef%bc%89PhpBB%e4%bb%8esession%20id%e6%b3%84%e9%9c%b2%e5%88%b0CSRF%e5%88%b0XSS_files/image27.png" width="560" height="141" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">variable</span><span class="cs9C1B1871">方法不仅会获取</span><span class="cs8926E06">POST</span><span class="cs9C1B1871">中提交的变量，也会获取通过</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">提交的变量，这意味着攻击者可以通过</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">参数传参来进行</span><span class="cs8926E06">CSRF</span><span class="cs9C1B1871">攻击。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当</span><span class="cs8926E06">csrf</span><span class="cs9C1B1871">攻击成功后，恶意的</span><span class="cs8926E06">bbcode</span><span class="cs9C1B1871">将会被添加。之后攻击者可以滥用这个</span><span class="cs8926E06">bbcode</span><span class="cs9C1B1871">短代码，在消息、话题、帖子、回复中执行任意</span><span class="cs8926E06">XSS</span><span class="cs9C1B1871">代码。</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7829</span></p></body>
</html>
