<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="pbootcms-v207-前台任意文件包含漏洞"><span class="csDE05BCC">PbootCMS v2.0.7 </span><span class="csECDA2D3">前台任意文件包含漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">PbootCMS v2.0.7</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞发生在</span><span class="cs8926E06">PbootCMS</span><span class="cs9C1B1871">内核的模板解析函数中</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">为了方便看直接上一个完整的</span><span class="cs8926E06">Parser</span><span class="cs9C1B1871">代码吧</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function parser($file)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">设置主题</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$theme = isset($this-&gt;vars[&#39;theme&#39;]) ? $this-&gt;vars[&#39;theme&#39;] : &#39;default&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//file</span><span class="cs7FFD2630">形式</span><span class="cs9FB05234">:xxxxx/../../../</span><span class="cs7FFD2630">可以双写穿越</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$theme = preg_replace(&#39;/\.\.(\/|\\\)/&#39;, &#39;&#39;, $theme); // </span><span class="cs7FFD2630">过滤掉相对路径</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$file = preg_replace(&#39;/\.\.(\/|\\\)/&#39;, &#39;&#39;, $file); // </span><span class="cs7FFD2630">过滤掉相对路径</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (strpos($file, &#39;/&#39;) === 0) { // </span><span class="cs7FFD2630">绝对路径模板</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tpl_file = ROOT_PATH . $file;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elseif (! ! $pos = strpos($file, &#39;@&#39;)) { // </span><span class="cs7FFD2630">跨模块调用</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$path = APP_PATH . &#39;/&#39; . substr($file, 0, $pos) . &#39;/view/&#39; . $theme;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;define(&#39;APP_THEME_DIR&#39;, str_replace(DOC_PATH, &#39;&#39;, $path));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! is_dir($path)) { // </span><span class="cs7FFD2630">检查主题是否存在</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error(&#39;</span><span class="cs7FFD2630">模板主题目录不存在！主题路径：</span><span class="cs9FB05234">&#39; . $path);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;tplPath = $path;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tpl_file = $path . &#39;/&#39; . substr($file, $pos + 1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">定义当前应用主题目录</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;define(&#39;APP_THEME_DIR&#39;, str_replace(DOC_PATH, &#39;&#39;, APP_VIEW_PATH) . &#39;/&#39; . $theme);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! is_dir($this-&gt;tplPath .= &#39;/&#39; . $theme)) { // </span><span class="cs7FFD2630">检查主题是否存在</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error(&#39;</span><span class="cs7FFD2630">模板主题目录不存在！主题路径：</span><span class="cs9FB05234">&#39; . APP_THEME_DIR);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tpl_file = $this-&gt;tplPath . &#39;/&#39; . $file; // </span><span class="cs7FFD2630">模板文件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$note = Config::get(&#39;tpl_html_dir&#39;) ? &#39;&lt;br&gt;</span><span class="cs7FFD2630">同时检测到您系统中启用了模板子目录</span><span class="cs9FB05234">&#39; . Config::get(&#39;tpl_html_dir&#39;) . &#39;</span><span class="cs7FFD2630">，请核对是否是此原因导致！</span><span class="cs9FB05234">&#39; : &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_exists($tpl_file) ?: error(&#39;</span><span class="cs7FFD2630">模板文件</span><span class="cs9FB05234">&#39; . APP_THEME_DIR . &#39;/&#39; . $file . &#39;</span><span class="cs7FFD2630">不存在！</span><span class="cs9FB05234">&#39; . $note);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tpl_c_file = $this-&gt;tplcPath . &#39;/&#39; . md5($tpl_file) . &#39;.php&#39;; // </span><span class="cs7FFD2630">编译文件</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">当编译文件不存在，或者模板文件修改过，则重新生成编译文件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! file_exists($tpl_c_file) || filemtime($tpl_c_file) &lt; filemtime($tpl_file) || ! Config::get(&#39;tpl_parser_cache&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = Parser::compile($this-&gt;tplPath, $tpl_file); // </span><span class="cs7FFD2630">解析模板</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_put_contents($tpl_c_file, $content) ?: error(&#39;</span><span class="cs7FFD2630">编译文件</span><span class="cs9FB05234">&#39; . $tpl_c_file . &#39;</span><span class="cs7FFD2630">生成出错！请检查目录是否有可写权限！</span><span class="cs9FB05234">&#39;); // </span><span class="cs7FFD2630">写入编译文件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$compile = true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//tplPath:PbootCMS/template</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ob_start(); // </span><span class="cs7FFD2630">开启缓冲区</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">引入编译文件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$rs = include $tpl_c_file;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! isset($compile)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ($rs as $value) { // </span><span class="cs7FFD2630">检查包含文件是否更新</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">其中一个包含文件不存在或修改则重新解析模板</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! file_exists($value) || filemtime($tpl_c_file) &lt; filemtime($value) || ! Config::get(&#39;tpl_parser_cache&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = Parser::compile($this-&gt;tplPath, $tpl_file); // </span><span class="cs7FFD2630">解析模板</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_put_contents($tpl_c_file, $content) ?: error(&#39;</span><span class="cs7FFD2630">编译文件</span><span class="cs9FB05234">&#39; . $tpl_c_file . &#39;</span><span class="cs7FFD2630">生成出错！请检查目录是否有可写权限！</span><span class="cs9FB05234">&#39;); // </span><span class="cs7FFD2630">写入编译文件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ob_clean();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include $tpl_c_file;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = ob_get_contents();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ob_end_clean();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $content;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">简单讲一下重点</span><span class="cs8926E06"><br/><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e5%89%8d%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="115" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">这里对传入路径的过滤并不严格，可以双写绕过</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">再往下跟一下</span><span class="cs8926E06"><br/><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e5%89%8d%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="109" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">当模板文件不在缓存中的时候，会读取</span><span class="cs8926E06">$tpl_file</span><span class="cs9C1B1871">中的内容，然后写入缓存文件中并且包含。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">也就是说，当</span><span class="cs8926E06">parser</span><span class="cs9C1B1871">函数的参数可以被控制的时候，就会造成一个任意文件包含。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">所以，要找一个可控参数的</span><span class="cs8926E06">parser</span><span class="cs9C1B1871">调用</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">经过简单寻找，就可以发现前台控制器</span><span class="cs8926E06">TagController</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">index</span><span class="cs9C1B1871">方法，完美符合我们的要求</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">上代码：</span></p><p class="cs3A447A38"><span class="cs9FB05234">public function index()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">在非兼容模式接受地址第二参数值</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (defined(&#39;RVAR&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_GET[&#39;tag&#39;] = RVAR;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! get(&#39;tag&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_404(&#39;</span><span class="cs7FFD2630">您访问的页面不存在，请核对后重试！</span><span class="cs9FB05234">&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$a=get(&#39;tag&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tagstpl = request(&#39;tagstpl&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (! preg_match(&#39;/^[\w\-\.\/]+$/&#39;, $tagstpl)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$tagstpl = &#39;tags.html&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = parent::parser($this-&gt;htmldir . $tagstpl); // </span><span class="cs7FFD2630">框架标签解析</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = $this-&gt;parser-&gt;parserBefore($content); // CMS</span><span class="cs7FFD2630">公共标签前置解析</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = $this-&gt;parser-&gt;parserPositionLabel($content, 0, &#39;</span><span class="cs7FFD2630">相关内容</span><span class="cs9FB05234">&#39;, homeurl(&#39;tag/&#39; . get(&#39;tag&#39;))); // CMS</span><span class="cs7FFD2630">当前位置标签解析</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = $this-&gt;parser-&gt;parserSpecialPageSortLabel($content, - 2, &#39;</span><span class="cs7FFD2630">相关内容</span><span class="cs9FB05234">&#39;, homeurl(&#39;tag/&#39; . get(&#39;tag&#39;))); // </span><span class="cs7FFD2630">解析分类标签</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$content = $this-&gt;parser-&gt;parserAfter($content); // CMS</span><span class="cs7FFD2630">公共标签后置解析</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;cache($content, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">传入</span><span class="cs8926E06">parser</span><span class="cs9C1B1871">的参数，是通过</span><span class="cs8926E06">request</span><span class="cs9C1B1871">接收的参数</span><span class="cs8926E06">$tagstpl</span><span class="cs9C1B1871">和</span><span class="cs8926E06">$this-&gt;htmldir</span><span class="cs9C1B1871">拼接的，因为已经知道在函数内部可以出现目录穿越，所以前面的路径不管怎么拼接都无所谓啦。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">这样就完成了整个攻击链，</span><span class="cs8926E06">TagController-&gt;parser-&gt;</span><span class="cs9C1B1871">双写绕过</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">文件读取</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">文件写入</span><span class="cs8926E06">-&gt;</span><span class="cs9C1B1871">文件包含</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">因为是</span><span class="cs8926E06">windows</span><span class="cs9C1B1871">搭的环境，就不读</span><span class="cs8926E06">/etc/passwd</span><span class="cs9C1B1871">了，读一下</span><span class="cs8926E06">D</span><span class="cs9C1B1871">盘根目录的文件吧</span></p><p class="cs40DD2BC9"><span><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e5%89%8d%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="529" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">成功</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">再包含个</span><span class="cs8926E06">phpinfo</span><span class="cs9C1B1871">试试</span><span class="cs8926E06"><br/><img src="Web安全/PbootCMS/PbootCMS%20v2.0.7%20%e5%89%8d%e5%8f%b0%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%8c%85%e5%90%ab%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="475" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">也是可以的</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">漏洞验证完成</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">本来是想再看看有没有什么组合利用的姿势，毕竟文件包含这种洞本身利用的灵活度还是蛮高的</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">不过既然最新版已经修了</span><span class="cs8926E06"> </span><span class="cs9C1B1871">就不多看了</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7744</span></p></body>
</html>
