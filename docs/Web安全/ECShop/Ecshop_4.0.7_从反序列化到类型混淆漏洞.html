<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="ecshop-从反序列化到类型混淆漏洞"><span class="csDE05BCC">Ecshop </span><span class="csECDA2D3">从反序列化到类型混淆漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞利用条件"><span class="csD6CA00D2">漏洞利用条件</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">&bull;php 5.6.x</span></p><p class="cs40DD2BC9"><span class="cs8926E06">&bull;</span><span class="cs9C1B1871">反序列化入口点</span></p><p class="cs40DD2BC9"><span class="cs8926E06">&bull;</span><span class="cs9C1B1871">可以触发</span><span class="cs8926E06">__wakeup</span><span class="cs9C1B1871">的触发点（在</span><span class="cs8926E06">php &lt; 5.6.11</span><span class="cs9C1B1871">以下，可以使用内置类）</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Ecshop 4.0.7</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先我们需要找到一个反序列化入口点，这里我们可以全局搜索</span><span class="cs9FB05234">unserialize</span><span class="cs9C1B1871">，挨个看一下我们可以找到两个可控的反序列化入口。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其中一个是</span><span class="cs8926E06">search.php line 45</span></p><p class="cs3A447A38"><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$string = base64_decode(trim($_GET[&#39;encode&#39;]));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ($string !== false)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$string = unserialize($string);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($string !== false)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这是一个前台的入口，但可惜的是引入初始化文件在反序列化之后，这也就导致我们没办法找到可以覆盖类变量属性的目标，也就没办法进一步利用。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">还有一个是</span><span class="cs9FB05234">admin/order.php</span><span class="cs8926E06"> line 229</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp; &nbsp;&nbsp;/* </span><span class="cs7FFD2630">取得上一个、下一个订单号</span><span class="cs9FB05234"> */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!empty($_COOKIE[&#39;ECSCP&#39;][&#39;lastfilter&#39;]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$filter = unserialize(urldecode($_COOKIE[&#39;ECSCP&#39;][&#39;lastfilter&#39;]));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">后台的表单页的这个功能就满足我们的要求了，不但可控，还可以用</span><span class="cs8926E06">urlencode</span><span class="cs9C1B1871">来绕过</span><span class="cs8926E06">ecshop</span><span class="cs9C1B1871">对全局变量的过滤。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这样一来我们就找到了一个可控并且合适的反序列化入口点。</span></p><h3 class="cs868C439D">
			<a name="寻找合适的类属性利用链"><span class="csD6CA00D2">寻找合适的类属性利用链</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在寻找利用链之前，我们可以用</span></p><p class="cs3A447A38"><span class="cs9FB05234">get_declared_classes()</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">来确定在反序列化时，已经声明定义过的类。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在我本地环境下，除了</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">内置类以外我一共找到</span><span class="cs8926E06">13</span><span class="cs9C1B1871">个类</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp; [129]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(3) &quot;ECS&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[130]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(9) &quot;ecs_error&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[131]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(8) &quot;exchange&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[132]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(9) &quot;cls_mysql&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[133]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(11) &quot;cls_session&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[134]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(12) &quot;cls_template&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[135]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(11) &quot;certificate&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[136]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(6) &quot;oauth2&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[137]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(15) &quot;oauth2_response&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[138]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(14) &quot;oauth2_request&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[139]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(9) &quot;transport&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[140]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(6) &quot;matrix&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;[141]=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;string(16) &quot;leancloud_client&quot;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从代码中也可以看到在文件头引入了多个库文件</span></p><p class="cs3A447A38"><span class="cs9FB05234">require(dirname(__FILE__) . &#39;/includes/init.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">require_once(ROOT_PATH . &#39;includes/lib_order.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">require_once(ROOT_PATH . &#39;includes/lib_goods.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">require_once(ROOT_PATH . &#39;includes/cls_matrix.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include_once(ROOT_PATH . &#39;includes/cls_certificate.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">require(&#39;leancloud_push.php&#39;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里我们主要关注</span><span class="cs8926E06">init.php</span><span class="cs9C1B1871">，因为在这个文件中声明了</span><span class="cs8926E06">ecshop</span><span class="cs9C1B1871">的大部分通用类。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在逐个看这里面的类变量时，我们可以敏锐的看到一个特殊的变量，由于</span><span class="cs8926E06">ecshop</span><span class="cs9C1B1871">的后台结构特殊，页面内容大多都是由模板编译而成，而这个模板类恰好也在</span><span class="cs8926E06">init.php</span><span class="cs9C1B1871">中声明</span></p><p class="cs3A447A38"><span class="cs9FB05234">require(ROOT_PATH . &#39;includes/cls_template.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$smarty = new cls_template;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">回到</span><span class="cs8926E06">order.php</span><span class="cs9C1B1871">中我们寻找与</span><span class="cs9FB05234">$smarty</span><span class="cs9C1B1871">相关的方法，不难发现，主要集中在两个方法中</span></p><p class="cs3A447A38"><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$smarty-&gt;assign(&#39;shipping&#39;, $shipping);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$smarty-&gt;display(&#39;print.htm&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而这里我们主要把视角集中在</span><span class="cs8926E06">display</span><span class="cs9C1B1871">方法上。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">粗略的浏览下</span><span class="cs8926E06">display</span><span class="cs9C1B1871">方法的逻辑大致是</span></p><p class="cs3A447A38"><span class="cs7FFD2630">请求相应的模板文件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--&gt;</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">经过一系列判断，将相应的模板文件做相应的编译</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">--&gt;</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">输出编译后的文件地址</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">比较重要的代码会在</span><span class="cs9FB05234">make_compiled</span><span class="cs9C1B1871">这个函数中被定义</span></p><p class="cs3A447A38"><span class="cs9FB05234">function make_compiled($filename)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$name = $this-&gt;compile_dir . &#39;/&#39; . basename($filename) . &#39;.php&#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($this-&gt;force_compile || $filestat[&#39;mtime&#39;] &gt; $expires)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_current_file = $filename;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$source = $this-&gt;fetch_str(file_get_contents($filename));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (file_put_contents($name, $source, LOCK_EX) === false)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trigger_error(&#39;can\&#39;t write:&#39; . $name);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$source = $this-&gt;_eval($source);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $source;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当流程走到这一步的时候，我们需要先找到我们的目标是什么？</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">重新审视</span><span class="cs9FB05234">cls_template.php</span><span class="cs9C1B1871">的代码，我们可以发现涉及到代码执行的只有几个函数。</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp; &nbsp;function get_para($val, $type = 1) // </span><span class="cs7FFD2630">处理</span><span class="cs9FB05234">insert</span><span class="cs7FFD2630">外部函数</span><span class="cs9FB05234">/</span><span class="cs7FFD2630">需要</span><span class="cs9FB05234">include</span><span class="cs7FFD2630">运行的函数的调用数据</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pa = $this-&gt;str_trim($val);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach ($pa AS $value)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (strrpos($value, &#39;=&#39;))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list($a, $b) = explode(&#39;=&#39;, str_replace(array(&#39; &#39;, &#39;&quot;&#39;, &quot;&#39;&quot;, &#39;&quot;&#39;), &#39;&#39;, $value));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($b{0} == &#39;$&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($type)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval(&#39;$para[\&#39;&#39; . $a . &#39;\&#39;]=&#39; . $this-&gt;get_val(substr($b, 1)) . &#39;;&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$para[$a] = $this-&gt;get_val(substr($b, 1));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$para[$a] = $b;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $para;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">get_para</span><span class="cs9C1B1871">只在</span><span class="cs8926E06">select</span><span class="cs9C1B1871">中调用，但是没找到能触发</span><span class="cs8926E06">select</span><span class="cs9C1B1871">的地方。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后是</span><span class="cs8926E06">pop_vars</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp; &nbsp;&nbsp;function pop_vars()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$key = array_pop($this-&gt;_temp_key);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$val = array_pop($this-&gt;_temp_val);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!empty($key))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eval($key);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">恰好配合</span><span class="cs8926E06">GMP</span><span class="cs9C1B1871">我们可以控制</span><span class="cs9FB05234">$this-&gt;_temp_key</span><span class="cs9C1B1871">变量，所以我们只要能在上面的流程中找到任意地方调用这个方法，我们就可以配合变量覆盖构造一个代码执行。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在回看刚才的代码流程时，我们从编译后的</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">文件中找到了这样的代码</span></p><p class="cs40DD2BC9"><span class="cs8926E06">order_info.htm.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp; &lt;?php endforeach; endif; unset($_from); ?&gt;&lt;?php $this-&gt;pop_vars();; ?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在遍历完表单之后，正好会触发</span><span class="cs9FB05234">pop_vars</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这样一来，只要我们控制覆盖</span><span class="cs9FB05234">cls_template</span><span class="cs9C1B1871">变量的</span><span class="cs9FB05234">_temp_key</span><span class="cs9C1B1871">属性，我们就可以完成一次</span><span class="cs8926E06">getshell</span></p><h3 class="cs868C439D">
			<a name="最终利用效果"><span class="csD6CA00D2">最终利用效果</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">1.png</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://mp.weixin.qq.com/s/KD0fKbSA9SUGY1lGas1xSA</span></p></body>
</html>
