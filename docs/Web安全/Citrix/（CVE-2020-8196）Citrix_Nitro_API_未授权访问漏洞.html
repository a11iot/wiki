<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2020-8196citrix-nitro-api-未授权访问漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2020-8196</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Citrix Nitro API </span><span class="csECDA2D3">未授权访问漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Citrix ADC</span><span class="cs9C1B1871">和</span><span class="cs8926E06">Citrix NetScaler Gateway</span><span class="cs9C1B1871">存在一个信息泄露漏洞，该漏洞允许经过身份验证的远程恶意用户获取主机上的敏感信息。通过发送特制请求，攻击者可以利用此漏洞获取敏感信息，然后使用此信息对受影响的系统发起进一步的攻击。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Citrix ADC and Citrix Gateway: &lt; 13.0-58.30</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Citrix ADC and NetScaler Gateway: &lt; 12.1-57.18</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Citrix ADC and NetScaler Gateway: &lt; 12.0-63.21</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Citrix ADC and NetScaler Gateway: &lt; 11.1-64.14 </span></p><p class="cs40DD2BC9"><span class="cs8926E06">NetScaler ADC and NetScaler Gateway: &lt; 10.5-70.18</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Citrix SD-WAN WANOP: &lt; 11.1.1a</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Citrix SD-WAN WANOP: &lt; 11.0.3d</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Citrix SD-WAN WANOP: &lt; 10.2.7</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Citrix Gateway Plug-in for Linux: &lt;  1.0.0.137</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Nitro API </span><span class="cs9C1B1871">可以给用户使用，还可以给其他</span><span class="cs8926E06">Citrix</span><span class="cs9C1B1871">组件使用</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">举例，当我们发送</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?xml version=&quot;1.0&quot;?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;server&gt;&lt;/server&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">则会返回</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?xml version=&quot;1.0&quot;?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;nitroResponse&gt;&lt;errorcode&gt;0&lt;/errorcode&gt;&lt;message&gt;Done&lt;/message&gt;&lt;severity&gt;NONE&lt;/severity&gt;&lt;/nitroResponse&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">并且可以在未登陆的使情况进行命令请求</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?xml version=&quot;1.0&quot;?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;nitroResponse&gt;&lt;errorcode&gt;354&lt;/errorcode&gt;&lt;message&gt;Invalid username or password&lt;/message&gt;&lt;severity&gt;ERROR&lt;/severity&gt;&lt;/nitroResponse&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在这里会返回一个错误代码，该代码</span><span class="cs9FB05234">0</span><span class="cs9C1B1871">表示一切正常，</span><span class="cs9FB05234">&gt;0</span><span class="cs9C1B1871">表示失败。</span><span class="cs8926E06">API</span><span class="cs9C1B1871">会检查几个</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">标头，并将它们的值用于事物。其中之一是</span><span class="cs9FB05234">X-NITRO-ONERROR</span><span class="cs9C1B1871">函数中的标头</span><span class="cs9FB05234">get_params()</span><span class="cs9C1B1871">。</span></p><p class="cs3A447A38"><span class="cs9FB05234">// Setting the header X-NITRO-ONERROR for bulk request</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$nitro_error = $this-&gt;get_headervalue($headers, &quot;X-NITRO-ONERROR&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if (isset($nitro_error))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$onerror = $this-&gt;get_headervalue($headers, &quot;X-NITRO-ONERROR&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$saveconfig = $this-&gt;get_headervalue($headers, &quot;X-NITRO-SAVECONFIG&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$enablefeature = $this-&gt;get_headervalue($headers, &quot;X-NITRO-ENABLEFEATURE&quot;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Constructing the params.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$params = $this-&gt;validate_and_post_json_request_params($action, $format, $onerror, $override, $warning, $idempotent, $saveconfig, $enablefeature);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">return $params;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs9FB05234">validate_and_post_json_request_params()</span><span class="cs9C1B1871">函数中，我们的控制值</span><span class="cs9FB05234">into $onerror</span><span class="cs9C1B1871">被添加</span><span class="cs9FB05234">$json_request_params</span><span class="cs9C1B1871">并返回为</span><span class="cs9FB05234">$params</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">// Validating and constructing params in nitro payload.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">private function validate_and_post_json_request_params($action, $format, $onerror, $override, $warning, $idempotent, $saveconfig, $enablefeature)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;[..]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(isset($onerror))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$json_request_params[&quot;onerror&quot;] = $onerror;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$json_request_params[&quot;httpheaders&quot;] = &quot;yes&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $json_request_params;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">$params</span><span class="cs9C1B1871">然后将变量传递给</span><span class="cs9FB05234">get_payload()</span><span class="cs9C1B1871">函数：</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (($post_body = $this-&gt;get_payload($content, $entity_type, $params, null)) === false)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $post_body;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此函数创建</span><span class="cs8926E06">&ldquo;Nitro</span><span class="cs9C1B1871">有效载荷</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">并返回它，以便可以在内部</span><span class="cs8926E06">API</span><span class="cs9C1B1871">调用中使用。该函数</span><span class="cs9FB05234">X-NITRO-ONERROR</span><span class="cs9C1B1871">在返回之前直接将几个参数的值（包括标头）直接粘贴到</span><span class="cs8926E06">XML</span><span class="cs9C1B1871">有效负载中：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp;// Constructing the nitro payload.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">private function get_payload($content, $entity_type, $params, $objectname) {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$error = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$request = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$entity_list = $entity_type . &quot;_list&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (preg_match(&quot;/^&lt;/&quot;, $content)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;libxml_disable_entity_loader(true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$req = simplexml_load_string($content);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;libxml_disable_entity_loader(false);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($req == null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;HTTP/1.1 400 Bad Request&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;print_error_message(&quot;Invalid Xml Input&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isset($objectname)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (strcmp($req-&gt;getName(), $objectname) != 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;HTTP/1.1 400 Bad Request&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;print_error_message(&quot;Invalid Xml Payload. Mismatch between content-type and payload&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$xml = &quot;&lt;nitroRequest&gt;\n&quot; . &quot;&quot; . $content . &quot;&quot; . &nbsp;$this-&gt;arrayToXMLString($params,&quot;params&quot;) . &quot;&lt;/nitroRequest&gt;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return $xml;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这意味着我们可以控制此</span><span class="cs8926E06">XML</span><span class="cs9C1B1871">文档中放置的元素。这个</span><span class="cs8926E06">XML</span><span class="cs9C1B1871">是通过几个函数返回的，最终以一个称为的变量结束，该变量</span><span class="cs9FB05234">$post_body</span><span class="cs9C1B1871">作为该函数的参数给出</span><span class="cs9FB05234">nsrest_exec()</span><span class="cs9C1B1871">。该函数调用的输出发送到该</span><span class="cs9FB05234">send_reponse()</span><span class="cs9C1B1871">函数：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$response = nsrest_exec($is_gui, $this-&gt;request_method, $post_body, $this-&gt;username, $this-&gt;password, $this-&gt;get_client_ip(), $_SERVER[&quot;SERVER_ADDR&quot;], $partid);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($this-&gt;is_direct_invocation)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $response[&quot;response&quot;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$this-&gt;send_response($response, $this-&gt;request_method, $this-&gt;validate_and_get_entity_type($arg_list), $is_gui);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">该</span><span class="cs9FB05234">nsrest_exec()</span><span class="cs9C1B1871">函数是</span><span class="cs8926E06">Citrix</span><span class="cs9C1B1871">随附的自定义</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">函数，位于一个名为的库文件中</span><span class="cs9FB05234">libphp7.so</span><span class="cs9C1B1871">。该函数或者在成功执行时返回</span><span class="cs8926E06">XML</span><span class="cs9C1B1871">对象，或者在执行</span><span class="cs8926E06">FALSE</span><span class="cs9C1B1871">失败时返回</span><span class="cs8926E06">XML</span><span class="cs9C1B1871">对象。沿线的某个地方</span><span class="cs8926E06">FALSE</span><span class="cs9C1B1871">变成，</span><span class="cs8926E06">NULL</span><span class="cs9C1B1871">然后</span><span class="cs8926E06">NULL</span><span class="cs9C1B1871">变成</span><span class="cs8926E06">0</span><span class="cs9C1B1871">。我不知道确切的内部工作原理，</span><span class="cs9FB05234">nsrest_exec</span><span class="cs9C1B1871">但总而言之：无效的</span><span class="cs9FB05234">XML X-NITRO-ONERROR</span><span class="cs9C1B1871">表示一切正常的响应。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">例如，此请求包含无效的</span><span class="cs8926E06">XML</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /nitro/v1/config/server HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: www.0-sec.org</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:68.0) Gecko/20100101 Firefox/68.0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: application/xml</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Language: en-US,en;q=0.5</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Referer: https://citrix.local/menu/neo</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/xml</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">If-Modified-Since: Thu, 01 Jan 1970 05:30:00 GMT</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">DNT: 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 17</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">X-NITRO-ONERROR: exit&lt;/onerror&gt;&lt;idempotent&gt;yes&lt;/idempotent&gt;&lt;format&gt;xml&lt;/format&gt;&lt;rawdata&gt;yes&lt;/rawdata&gt;&lt;/params&gt;&lt;server&gt;&lt;/server&gt;&lt;params&gt;&lt;onerror</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;server&gt;&lt;/server&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">返回值</span></p><p class="cs3A447A38"><span class="cs9FB05234">HTTP/1.1 201 Created</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Date: Tue, 28 Jan 2020 10:52:07 GMT</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Server: Apache</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">X-Frame-Options: SAMEORIGIN</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Set-Cookie: SESSID=deleted; expires=Thu, 01-Jan-1970 00:00:01 GMT; Max-Age=0; path=/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Expires: Thu, 19 Nov 1981 08:52:00 GMT</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Pragma: no-cache</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">X-XSS-Protection: 1; mode=block</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 126</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/xml; charset=utf-8</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">&lt;?xml version=&quot;1.0&quot;?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;nitroResponse&gt;&lt;errorcode&gt;0&lt;/errorcode&gt;&lt;message&gt;Done&lt;/message&gt;&lt;severity&gt;NONE&lt;/severity&gt;&lt;/nitroResponse&gt;**</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如上所示一切正常，并且身份验证已通过。实际上什么也没有发生，但是使用错误代码就可以来验证</span><span class="cs8926E06">API</span><span class="cs9C1B1871">调用是否成功</span></p></body>
</html>
