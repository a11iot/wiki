<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2020-11978apache-airflow-命令注入漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2020-11978</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Apache Airflow </span><span class="csECDA2D3">命令注入漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">默认情况下</span><span class="cs8926E06">Airflow Web UI</span><span class="cs9C1B1871">是未授权访问的，直接可以登录，而登录后，只能查看</span><span class="cs8926E06">DAG</span><span class="cs9C1B1871">的调度状态等，无法进行更多操作。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">但</span><span class="cs8926E06">Airflow Web UI</span><span class="cs9C1B1871">中提供了触发</span><span class="cs8926E06">DAG</span><span class="cs9C1B1871">运行的功能，以便测试</span><span class="cs8926E06">DAG</span><span class="cs9C1B1871">，同时</span><span class="cs8926E06">Airflow</span><span class="cs9C1B1871">为了让使用者可以快速熟悉其</span><span class="cs8926E06">DAG</span><span class="cs9C1B1871">开发流程和功能，为了更好的示例这些</span><span class="cs8926E06">DAG</span><span class="cs9C1B1871">覆盖了大多的执行器。而其中两个</span><span class="cs8926E06">DAG</span><span class="cs9C1B1871">组合起来可触发命令注入导致漏洞产生。</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">要在</span><span class="cs5BEC2C28">WEB UI</span><span class="csE3F655E4">中先执行下启用</span><span class="cs5BEC2C28">DAG</span><span class="csE3F655E4">，然后才可以执行运行，如下所示</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.png</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Apache Airflow &lt; 1.10.11</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先看下下面两个</span><span class="cs8926E06">DAG</span></p><p class="cs3A447A38"><span class="cs9FB05234">#airflow/example_dags/example_trigger_target_dag.py</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from airflow import DAG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from airflow.operators.bash import BashOperator</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from airflow.operators.python import PythonOperator</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from airflow.utils.dates import days_ago</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">dag = DAG(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;dag_id=&quot;example_trigger_target_dag&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;default_args={&quot;start_date&quot;: days_ago(2), &quot;owner&quot;: &quot;airflow&quot;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;schedule_interval=None,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;tags=[&#39;example&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def run_this_func(**context):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Print the payload &quot;message&quot; passed to the DagRun conf attribute.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;:param context: The execution context</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;:type context: dict</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;Remotely received value of {} for key=message&quot;.format(context[&quot;dag_run&quot;].conf[&quot;message&quot;]))</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">run_this = PythonOperator(task_id=&quot;run_this&quot;, python_callable=run_this_func, dag=dag)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">bash_task = BashOperator(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;task_id=&quot;bash_task&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;bash_command=&#39;echo &quot;Here is the message: \&#39;{{ dag_run.conf[&quot;message&quot;] if dag_run else &quot;&quot; }}\&#39;&quot;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;dag=dag,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#airflow/example_dags/example_trigger_controller_dag.py</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from airflow import DAG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from airflow.operators.dagrun_operator import TriggerDagRunOperator</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from airflow.utils.dates import days_ago</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">dag = DAG(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;dag_id=&quot;example_trigger_controller_dag&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;default_args={&quot;owner&quot;: &quot;airflow&quot;, &quot;start_date&quot;: days_ago(2)},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;schedule_interval=&quot;@once&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;tags=[&#39;example&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">trigger = TriggerDagRunOperator(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;task_id=&quot;test_trigger_dagrun&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;trigger_dag_id=&quot;example_trigger_target_dag&quot;, &nbsp;# Ensure this equals the dag_id of the DAG to trigger</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;conf={&quot;message&quot;: &quot;Hello World&quot;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;dag=dag,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">官方对这两个</span><span class="cs8926E06">DAG</span><span class="cs9C1B1871">的说明如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">Example usage of the TriggerDagRunOperator. This example holds 2 DAGs:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">1. 1st DAG (example_trigger_controller_dag) holds a TriggerDagRunOperator, which will trigger the 2nd DAG</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">2. 2nd DAG (example_trigger_target_dag) which will be triggered by the TriggerDagRunOperator in the 1st DAG</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看出</span><span class="cs8926E06">Airflow</span><span class="cs9C1B1871">希望通过这两个</span><span class="cs8926E06">DAG</span><span class="cs9C1B1871">组合来展示如果通过一个</span><span class="cs9FB05234">DAG</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">example_trigger_controller_dag</span><span class="cs7FFD2630">）来动态的调用另外一个</span><span class="cs9FB05234">DAG</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">example_trigger_target_dag</span><span class="cs9C1B1871">）。即通过</span><span class="cs9FB05234">example_trigger_controller_dag</span><span class="cs9C1B1871">内部定义的</span><span class="cs9FB05234">conf={&quot;message&quot;: &quot;Hello World&quot;}</span><span class="cs7FFD2630">来触发</span><span class="cs9FB05234">example_trigger_target_dag</span><span class="cs7FFD2630">中</span><span class="cs9FB05234">bash_command=&#39;echo &quot;Here is the message: \&#39;{{ dag_run.conf[&quot;message&quot;] if dag_run else &quot;&quot; }}\&#39;&quot;&#39;</span><span class="cs9C1B1871">的运行，此处看起来：</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">存在命令执行点</span><span class="cs9FB05234">&#39;echo &quot;Here is the message: \&#39;{{ dag_run.conf[&quot;message&quot;] if dag_run else &quot;&quot; }}\&#39;&quot;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">这边是</span><span class="cs8926E06">Python</span><span class="cs9C1B1871">下面的</span><span class="cs8926E06">Jinja</span><span class="cs9C1B1871">模板，因此会根据后面的</span><span class="cs9FB05234">if...else</span><span class="cs9C1B1871">逻辑来执行</span><span class="cs9FB05234">dag_run.conf[&quot;message&quot;] </span><span class="cs9C1B1871">来动态加载内容，此处如果</span><span class="cs9FB05234">dag_run.conf[&quot;message&quot;]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">可控，则可以通过</span><span class="cs8926E06">Jinja</span><span class="cs9C1B1871">模板注入恶意命令。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但根据上面信息可以看出，输入</span><span class="cs9FB05234">dag_run.conf[&quot;message&quot;]</span><span class="cs9C1B1871">由第一个</span><span class="cs8926E06">DGA</span><span class="cs9C1B1871">传递过来的，看起来无法控制。而实际上熟悉下</span><span class="cs8926E06">Airflow</span><span class="cs9C1B1871">相关代码即可发现，</span><span class="cs8926E06">Airflow</span><span class="cs9C1B1871">中</span><span class="cs9FB05234">A DAG Run is an object representing an instantiation of the DAG in time.</span><span class="cs9C1B1871">而其中</span><span class="cs8926E06">conf </span><span class="cs9C1B1871">正是用于传递参数的方式，</span><span class="cs8926E06"> Airflow</span><span class="cs9C1B1871">提供了多渠道可以修改</span><span class="cs8926E06">conf</span><span class="cs9C1B1871">，包括命令行例如：</span></p><p class="cs3A447A38"><span class="cs9FB05234">airflow dags trigger --conf &#39;{&quot;conf1&quot;: &quot;value1&quot;}&#39; example_parametrized_dag</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">同时也包含</span><span class="cs8926E06">Web UI </span><span class="cs9C1B1871">上直接触发任意</span><span class="cs8926E06">DAG</span><span class="cs9C1B1871">并传递</span><span class="cs9FB05234">dag_run.conf</span><span class="cs9C1B1871">：</span><span class="cs8926E06"><br/>1.png</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">详细信息可以参考</span><span class="cs8926E06">Airflow</span><span class="cs9C1B1871">官方文档中队</span><span class="cs8926E06">dag_run</span><span class="cs9C1B1871">的详细说明：</span></p><p class="cs6FD73CFB"><span class="cs8926E06">http://airflow.apache.org/docs/stable/dag-run.html?highlight=dag_run</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因此可以直接利用此接口触发</span><span class="cs9FB05234">example_trigger_target_dag.py</span><span class="cs9C1B1871">的调度，这样就可以绕过</span><span class="cs9FB05234">example_trigger_controller_dag</span><span class="cs9C1B1871">中写死的配置。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">3.png</span></p><p class="cs40DD2BC9"><span class="cs8926E06">4.png</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/8037#toc-4</span></p></body>
</html>
