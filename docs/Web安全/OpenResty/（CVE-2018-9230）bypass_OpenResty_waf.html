<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cve-2018-9230bypass-openresty-waf"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-9230</span><span class="csECDA2D3">）</span><span class="csDE05BCC">bypass OpenResty waf</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">OpenResty</span><span class="cs9C1B1871">是一款基于</span><span class="cs8926E06">Nginx</span><span class="cs9C1B1871">和</span><span class="cs8926E06">Lua</span><span class="cs9C1B1871">的</span><span class="cs8926E06">Web</span><span class="cs9C1B1871">平台。该平台用于搭建用于处理高并发、高扩展性的动态</span><span class="cs8926E06">Web</span><span class="cs9C1B1871">应用、</span><span class="cs8926E06">Web</span><span class="cs9C1B1871">服务和动态网关。</span><span class="cs8926E06">OpenResty1.13.6.1</span><span class="cs9C1B1871">之前的版本中存在安全漏洞，该漏洞源于程序使用</span><span class="cs9FB05234">ngx.req.get_uri_args</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">ngx.req.get_post_args</span><span class="cs9C1B1871">函数接受参数的数量可以超过</span><span class="cs8926E06">100</span><span class="cs9C1B1871">个。远程攻击者可利用该漏洞绕过访问限制，干预</span><span class="cs8926E06">Web</span><span class="cs9C1B1871">应用程序防火墙</span><span class="cs8926E06">(ngx_lua_waf</span><span class="cs9C1B1871">或</span><span class="cs8926E06">X-WAF)</span><span class="cs9C1B1871">产品。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">OpenResty &lt; 1.13.6.1</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h2 class="cs868C439D">
			<a name="漏洞分析"><span class="cs83F14626">漏洞分析</span></a></h2>
		<h3 class="cs868C439D">
			<a name="auri参数获取"><span class="csD1E291E2">A</span><span class="csD6CA00D2">、</span><span class="csD1E291E2">uri</span><span class="csD6CA00D2">参数获取</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先看一下官方</span><span class="cs8926E06"> API </span><span class="cs9C1B1871">文档，获取一个</span><span class="cs8926E06"> uri </span><span class="cs9C1B1871">有两个方法：</span><span class="cs9FB05234">ngx.req.get_uri_args</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">ngx.req.get_post_args</span><span class="cs9C1B1871">，二者主要的区别是参数来源有区别，</span><span class="cs9FB05234">ngx.req.get_uri_args</span><span class="cs9C1B1871">获取</span><span class="cs8926E06"> uri </span><span class="cs9C1B1871">请求参数，</span><span class="cs9FB05234">ngx.req.get_post_args</span><span class="cs9C1B1871">获取来自</span><span class="cs8926E06"> post </span><span class="cs9C1B1871">请求内容。</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">测试用例：</span></p><p class="cs3A447A38"><span class="cs9FB05234">server {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">listen 80;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">server_name localhost;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">location /test {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">content_by_lua_block {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">local arg = ngx.req.get_uri_args()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for k,v in pairs(arg) do</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ngx.say(&ldquo;[GET ] key:&rdquo;, k, &ldquo; v:&rdquo;, v)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">end</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ngx.req.read_body()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">local arg = ngx.req.get_post_args()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for k,v in pairs(arg) do</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ngx.say(&ldquo;[POST] key:&rdquo;, k, &ldquo; v:&rdquo;, v)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">end</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">输出测试：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OpenResty/%ef%bc%88CVE-2018-9230%ef%bc%89bypass%20OpenResty%20waf_files/image0.png" width="560" height="87" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="b参数大小写"><span class="csD1E291E2">B</span><span class="csD6CA00D2">、参数大小写</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">当提交同一参数</span><span class="cs8926E06">id</span><span class="cs9C1B1871">，根据接收参数的顺序进行排序，</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可是当参数</span><span class="cs8926E06">id</span><span class="cs9C1B1871">，进行大小写变换，如变形为</span><span class="cs8926E06">Id</span><span class="cs9C1B1871">、</span><span class="cs8926E06">iD</span><span class="cs9C1B1871">、</span><span class="cs8926E06">ID</span><span class="cs9C1B1871">，则会被当做不同的参数。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OpenResty/%ef%bc%88CVE-2018-9230%ef%bc%89bypass%20OpenResty%20waf_files/image1.png" width="560" height="121" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里，介绍参数大小写，主要用于进一步构造和理解测试用例。</span></p><h3 class="cs868C439D">
			<a name="c参数溢出"><span class="csD1E291E2">C</span><span class="csD6CA00D2">、参数溢出</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">如果当我们不段填充参数，会发生什么情况呢，为此我构造了一个方便用于展示的测试案例，</span><span class="cs8926E06">a0-a9</span><span class="cs9C1B1871">，</span><span class="cs8926E06">10*10,</span><span class="cs9C1B1871">共</span><span class="cs8926E06">100</span><span class="cs9C1B1871">参数，然后第</span><span class="cs8926E06">101</span><span class="cs9C1B1871">个参数添加</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入</span><span class="cs8926E06"> Payload</span><span class="cs9C1B1871">，我们来看看会发生什么？</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">测试用例：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">curl &#39;www.0-sec.org/test?a0=0&amp;a0=0&amp;a0=0&amp;a0=0&amp;a0=0&amp;a0=0&amp;a0=0&amp;a0=0&amp;a0=0&amp;a0=0&amp;a1=1&amp;a1=1&amp;a1=1&amp;a1=1&amp;a1=1&amp;a1=1&amp;a1=1&amp;a1=1&amp;a1=1&amp;a1=1&amp;a2=2&amp;a2=2&amp;a2=2&amp;a2=2&amp;a2=2&amp;a2=2&amp;a2=2&amp;a2=2&amp;a2=2&amp;a2=2&amp;a3=3&amp;a3=3&amp;a3=3&amp;a3=3&amp;a3=3&amp;a3=3&amp;a3=3&amp;a3=3&amp;a3=3&amp;a3=3&amp;a4=4&amp;a4=4&amp;a4=4&amp;a4=4&amp;a4=4&amp;a4=4&amp;a4=4&amp;a4=4&amp;a4=4&amp;a4=4&amp;a5=5&amp;a5=5&amp;a5=5&amp;a5=5&amp;a5=5&amp;a5=5&amp;a5=5&amp;a5=5&amp;a5=5&amp;a5=5&amp;a6=6&amp;a6=6&amp;a6=6&amp;a6=6&amp;a6=6&amp;a6=6&amp;a6=6&amp;a6=6&amp;a6=6&amp;a6=6&amp;a7=7&amp;a7=7&amp;a7=7&amp;a7=7&amp;a7=7&amp;a7=7&amp;a7=7&amp;a7=7&amp;a7=7&amp;a7=7&amp;a8=8&amp;a8=8&amp;a8=8&amp;a8=8&amp;a8=8&amp;a8=8&amp;a8=8&amp;a8=8&amp;a8=8&amp;a8=8&amp;a9=9&amp;a9=9&amp;a9=9&amp;a9=9&amp;a9=9&amp;a9=9&amp;a9=9&amp;a9=9&amp;a9=9&amp;a9=9&amp;id=1 union select 1,schema_name,3 from INFORMATION_SCHEMA.schemata</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">输出结果：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OpenResty/%ef%bc%88CVE-2018-9230%ef%bc%89bypass%20OpenResty%20waf_files/image2.png" width="560" height="246" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到，使用</span><span class="cs9FB05234">ngx.req.get_uri_args</span><span class="cs9C1B1871">获取</span><span class="cs8926E06">uri </span><span class="cs9C1B1871">请求参数，只获取前</span><span class="cs8926E06">100</span><span class="cs9C1B1871">个参数，第</span><span class="cs8926E06">101</span><span class="cs9C1B1871">个参数并没有获取到。继续构造一个</span><span class="cs8926E06">POST</span><span class="cs9C1B1871">请求，来看一下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OpenResty/%ef%bc%88CVE-2018-9230%ef%bc%89bypass%20OpenResty%20waf_files/image3.png" width="560" height="234" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs9FB05234">ngx.req.get_post_args</span><span class="cs8926E06"> </span><span class="cs9C1B1871">获取的</span><span class="cs8926E06">post</span><span class="cs9C1B1871">请求内容，也同样只获取前</span><span class="cs8926E06">100</span><span class="cs9C1B1871">个参数。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">检查这两个函数的文档，出于安全原因默认的限制是</span><span class="cs8926E06">100</span><span class="cs9C1B1871">，它们接受一个可选参数，最多可以告诉它应该解析多少</span><span class="cs8926E06">GET / POST</span><span class="cs9C1B1871">参数。但只要攻击者构造的参数超过限制数就可以轻易绕过基于</span><span class="cs8926E06">OpenResty</span><span class="cs9C1B1871">的安全防护，这就存在一个</span><span class="cs8926E06">uri</span><span class="cs9C1B1871">参数溢出的问题。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">综上，通过</span><span class="cs9FB05234">ngx.req.get_uri_args</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">ngx.req.get_post_args</span><span class="cs9C1B1871">获取</span><span class="cs8926E06">uri</span><span class="cs9C1B1871">参数，当提交的参数超过限制数（默认限制</span><span class="cs8926E06">100</span><span class="cs9C1B1871">或可选参数限制），</span><span class="cs8926E06">uri</span><span class="cs9C1B1871">参数溢出，无法获取到限制数以后的参数值，更无法对攻击者构造的参数进行有效安全检测，从而绕过基于</span><span class="cs8926E06">OpenResty</span><span class="cs9C1B1871">的</span><span class="cs8926E06">WEB</span><span class="cs9C1B1871">安全防护。</span></p><h2 class="cs868C439D">
			<a name="漏洞复现"><span class="cs83F14626">漏洞复现</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">基于</span><span class="cs8926E06">OpenResty</span><span class="cs9C1B1871">构造的</span><span class="cs8926E06">WEB</span><span class="cs9C1B1871">安全防护，大多数使用</span><span class="cs9FB05234">ngx.req.get_uri_args</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">ngx.req.get_post_args</span><span class="cs9C1B1871">获取</span><span class="cs8926E06">uri</span><span class="cs9C1B1871">参数，即默认限制</span><span class="cs8926E06">100</span><span class="cs9C1B1871">，并没有考虑参数溢出的情况，攻击者可构造超过限制数的参数，轻易的绕过安全防护。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">基于</span><span class="cs8926E06">OpenResty</span><span class="cs9C1B1871">的开源</span><span class="cs8926E06">WAF</span><span class="cs9C1B1871">如：</span><span class="cs8926E06">ngx_lua_waf</span><span class="cs9C1B1871">、</span><span class="cs8926E06">X-WAF</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Openstar</span><span class="cs9C1B1871">等，均受影响。</span></p><h3 class="cs868C439D">
			<a name="angx_lua_waf"><span class="csD1E291E2">A</span><span class="csD6CA00D2">、</span><span class="csD1E291E2">ngx_lua_waf</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">ngx_lua_waf</span><span class="cs9C1B1871">是一个基于</span><span class="cs8926E06">lua-nginx-module(openresty)</span><span class="cs9C1B1871">的</span><span class="cs8926E06">web</span><span class="cs9C1B1871">应用防火墙</span></p><p class="cs40DD2BC9"><span class="cs8926E06">github</span><span class="cs9C1B1871">源码：</span><span class="cs8926E06">https://github.com/loveshell/ngx_lua_waf</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">拦截效果图：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OpenResty/%ef%bc%88CVE-2018-9230%ef%bc%89bypass%20OpenResty%20waf_files/image4.png" width="560" height="284" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="csE3F655E4">利用参数溢出</span><span class="cs5BEC2C28">Bypass</span><span class="csE3F655E4">：</span><span class="cs8926E06"><br/><img src="Web安全/OpenResty/%ef%bc%88CVE-2018-9230%ef%bc%89bypass%20OpenResty%20waf_files/image5.png" width="560" height="207" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="bx-waf"><span class="csD1E291E2">B</span><span class="csD6CA00D2">、</span><span class="csD1E291E2">X-WAF</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">X-WAF</span><span class="cs9C1B1871">是一款适用中、小企业的云</span><span class="cs8926E06">WAF</span><span class="cs9C1B1871">系统，让中、小企业也可以非常方便地拥有自己的免费云</span><span class="cs8926E06">WAF</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">官网：</span><span class="cs8926E06"><a class="cs508254C" href="https://waf.xsec.io/"><span class="cs4B51D5E4">https://waf.xsec.io</span></a></span></p><p class="cs40DD2BC9"><span class="cs8926E06">github</span><span class="cs9C1B1871">源码：</span><span class="cs8926E06">https://github.com/xsec-lab/x-waf</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">拦截效果图：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OpenResty/%ef%bc%88CVE-2018-9230%ef%bc%89bypass%20OpenResty%20waf_files/image6.png" width="560" height="131" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="csE3F655E4">利用参数溢出</span><span class="cs5BEC2C28">Bypass</span><span class="csE3F655E4">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/OpenResty/%ef%bc%88CVE-2018-9230%ef%bc%89bypass%20OpenResty%20waf_files/image7.png" width="560" height="207" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://www.anquanke.com/post/id/103771</span></p></body>
</html>
