<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs2D2816FE{}
			.csC48167EA{padding:0pt 5.4pt 0pt 5.4pt;border-top:none;border-right:none;border-bottom:1pt windowtext solid;border-left:none}
			.csE0FE76B{text-align:left;text-indent:0pt;margin:2pt 0pt 2pt 0pt}
			.csE35A2CA7{padding:0pt 5.4pt 0pt 5.4pt;border-top:none;border-right:none;border-bottom:none;border-left:none}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="memcache未授权访问"><span class="csDE05BCC">Memcache</span><span class="csECDA2D3">未授权访问</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06">memcached</span><span class="cs9C1B1871">是一套分布式的高速缓存系统。它以</span><span class="cs8926E06">Key-Value</span><span class="cs9C1B1871">（键值对）形式将数据存储在内存中，这些数据通常是应用读取频繁的。正因为内存中数据的读取远远大于硬盘，因此可以用来加速应用的访问。</span></p><h2 class="cs868C439D">
			<a name="二、影响范围"><span class="cs83F14626">二、影响范围</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h4 class="cs868C439D">
			<a name="Xdcd1cca472c40dffb13d2f1fa9ff6156ec259ee"><span class="csBF12A472">1.</span><span class="cs6EDCDAE2">扫描探测</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">nmap -sV -p 11211 --script memcached-info 0.0.0.0</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Memcache/Memcache%e6%9c%aa%e6%8e%88%e6%9d%83%e8%ae%bf%e9%97%ae_files/image0.png" width="560" height="246" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">##! /usr/bin/env python</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">## _*_ &nbsp;coding:utf-8 _*_</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def Memcache_check(ip, port=11211, timeout=5):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socket.setdefaulttimeout(timeout)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.connect((ip, int(port)))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.send(&quot;stats\r\n&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result = s.recv(1024)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if &quot;STAT version&quot; in result:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;[+] Memcache Unauthorized: &#39; +ip+&#39;:&#39;+str(port)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except Exception, e:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if __name__ == &#39;__main__&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Elasticsearch_check(&quot;127.0.0.1&quot;)</span></p><h4 class="cs868C439D">
			<a name="Xa4630976b2da343912d0db1cd9f72c7cbb7626f"><span class="csBF12A472">2.</span><span class="cs6EDCDAE2">攻击利用</span></a></h4>
		<h5 class="cs868C439D">
			<a name="X361b757a52ad5c117ba8c9db5235415ab2a86d4"><span class="cs4B51D5E4">2.1 </span><span class="cs1C2E50E7">基础部分</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">通过一个</span><span class="cs8926E06">cheat sheet</span><span class="cs9C1B1871">了解一下</span><span class="cs8926E06">Memcached</span><span class="cs9C1B1871">的协议。</span><span class="cs8926E06">Memcached</span><span class="cs9C1B1871">的语法由如下元素组成</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">{COMMAND}0x20{ARGUMENT}(LF|CRLF)</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs8926E06">command</span><span class="cs9C1B1871">字段有如下几条命令</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">存储操作</span><span class="cs8926E06">(set, add, replace, append, prepend, cas)</span></li><li class="cs24C36B3"><span class="cs9C1B1871">检索操作</span><span class="cs8926E06"> (get, gets)</span></li><li class="cs24C36B3"><span class="cs9C1B1871">删除操作</span><span class="cs8926E06"> (delete)</span></li><li class="cs24C36B3"><span class="cs9C1B1871">增减操作</span><span class="cs8926E06"> (incr, decr)</span></li><li class="cs24C36B3"><span class="cs8926E06">touch</span></li><li class="cs24C36B3"><span class="cs8926E06">slabs reassign</span></li><li class="cs24C36B3"><span class="cs8926E06">slabs automove</span></li><li class="cs24C36B3"><span class="cs8926E06">lru_crawler</span></li><li class="cs24C36B3"><span class="cs9C1B1871">统计操作</span><span class="cs8926E06">(stats items, slabs, cachedump)</span></li><li class="cs24C36B3"><span class="cs9C1B1871">其他操作</span><span class="cs8926E06"> (version, flush_all, quit)</span></li></ul>
		<table class="cs2D2816FE" border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse;">
			<tr>
				<td class="csC48167EA" valign="bottom"><p class="csE0FE76B"><span class="cs8926E06">Command</span></p></td><td class="csC48167EA" valign="bottom"><p class="csE0FE76B"><span class="cs9C1B1871">描述</span></p></td><td class="csC48167EA" valign="bottom"><p class="csE0FE76B"><span class="cs9C1B1871">实例</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">get</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">读某个值</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">get mykey</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">set</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">强制设置某个键值</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">set mykey 0 60 5</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">add</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">添加新键值对</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">add newkey 0 60 5</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">replace</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">覆盖已经存在的</span><span class="cs8926E06">key</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">replace key 0 60 5</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">flush_all</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">让所有条目失效</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">flush_all</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">stats</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">打印当前状态</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">stats</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">stats malloc</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">打印内存状态</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs8926E06">stats malloc</span></p></td></tr>
		</table>
		<p class="cs40DD2BC9"><span class="cs8926E06">version | </span><span class="cs9C1B1871">打印</span><span class="cs8926E06">Memcached</span><span class="cs9C1B1871">版本</span><span class="cs8926E06"> | version</span></p><p class="cs3A447A38"><span class="cs9FB05234">stats &nbsp;//</span><span class="cs7FFD2630">查看</span><span class="cs9FB05234">memcache </span><span class="cs7FFD2630">服务状态</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">stats items &nbsp;//</span><span class="cs7FFD2630">查看所有</span><span class="cs9FB05234">items</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">stats cachedump 32 0 &nbsp;//</span><span class="cs7FFD2630">获得缓存</span><span class="cs9FB05234">key</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">get :state:264861539228401373:261588 &nbsp;&nbsp;//</span><span class="cs7FFD2630">通过</span><span class="cs9FB05234">key</span><span class="cs7FFD2630">读取相应</span><span class="cs9FB05234">value </span><span class="cs7FFD2630">，获得实际缓存内容，造成敏感信息泄露</span></p><h4 class="cs868C439D">
			<a name="Xe50d6d4a83d8643a1b45a731a137170a145bd87"><span class="csBF12A472">2.2 </span><span class="cs6EDCDAE2">建立连接并获取信息</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs8926E06">telnet 11211</span><span class="cs9C1B1871">，或</span><span class="cs8926E06"> nc -vv 11211</span><span class="cs9C1B1871">，无需用户名密码，可以直接连接</span><span class="cs8926E06">memcache </span><span class="cs9C1B1871">服务的</span><span class="cs8926E06">11211</span><span class="cs9C1B1871">端口。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Memcache/Memcache%e6%9c%aa%e6%8e%88%e6%9d%83%e8%ae%bf%e9%97%ae_files/image1.png" width="560" height="336" alt="" style="border-width:0px;" /></span><span class="cs8926E06">&nbsp;</span><span class="cs9C1B1871">附赠大佬写的文章</span><span class="cs8926E06"> <a class="cs508254C" href="https://xz.aliyun.com/t/2018"><span class="cs4B51D5E4">Discuz!</span><span class="cs1C2E50E7">因</span><span class="cs4B51D5E4">Memcached</span><span class="cs1C2E50E7">未授权访问导致的</span><span class="cs4B51D5E4">RCE</span></a></span></p><h4 class="cs868C439D">
			<a name="X6beb735b58726c567c361af98afc21002d02741"><span class="csBF12A472">3.</span><span class="cs6EDCDAE2">防范措施</span></a></h4>
		<h5 class="cs868C439D">
			<a name="X592b0221f1d2dabf2c609c23f64ffba7753c51d"><span class="cs4B51D5E4">1.</span><span class="cs1C2E50E7">限制访问</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">如果</span><span class="cs8926E06">memcache</span><span class="cs9C1B1871">没有对外访问的必要，可在</span><span class="cs8926E06">memcached</span><span class="cs9C1B1871">启动的时候指定绑定的</span><span class="cs8926E06">ip</span><span class="cs9C1B1871">地址为</span><span class="cs8926E06"> 127.0.0.1</span><span class="cs9C1B1871">。其中</span><span class="cs8926E06"> -l </span><span class="cs9C1B1871">参数指定为本机地址。例如：</span><span class="cs8926E06"> memcached -d -m 1024 -u root -l 127.0.0.1 -p 11211 -c 1024 -P /tmp/memcached.pid</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">或者</span><span class="cs8926E06"> vim /etc/sysconfig/memcached</span><span class="cs9C1B1871">，修改配置文件</span><span class="cs8926E06"> OPTIONS=&quot;-l 127.0.0.1&quot;</span><span class="cs9C1B1871">，只能本机访问，不对公网开放，保存退出</span><span class="cs8926E06"> /etc/init.d/memcached reload</span></p><h5 class="cs868C439D">
			<a name="X73558389e766eee209e4b2f023681de6c415c10"><span class="cs4B51D5E4">2.</span><span class="cs1C2E50E7">防火墙</span></a></h5>
		<p class="cs3A447A38"><span class="cs9FB05234">// accept</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">## iptables -A INPUT -p tcp -s 127.0.0.1 --dport 11211 -j ACCEPT</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">## iptables -A INPUT -p udp -s 127.0.0.1 --dport 11211 -j ACCEPT</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// drop</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">## iptables -I INPUT -p tcp --dport 11211 -j DROP</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">## iptables -I INPUT -p udp --dport 11211 -j DROP</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// </span><span class="cs7FFD2630">保存规则并重启</span><span class="cs9FB05234"> iptables</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">## service iptables save</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">## service iptables restart</span></p><h5 class="cs868C439D">
			<a name="Xecdc80195b518da3b25bc38d421904cedece28d"><span class="cs4B51D5E4">3.</span><span class="cs1C2E50E7">使用最小化权限账号运行</span><span class="cs4B51D5E4">Memcached</span><span class="cs1C2E50E7">服务</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">使用普通权限账号运行，指定</span><span class="cs8926E06">Memcached</span><span class="cs9C1B1871">用户。</span></p><p class="cs3A447A38"><span class="cs9FB05234">memcached -d -m 1024 -u memcached -l 127.0.0.1 -p 11211 -c 1024 -P /tmp/memcached.pid</span></p><h5 class="cs868C439D">
			<a name="Xd712db66d94c710f86b54322ecd78fbed25bb80"><span class="cs4B51D5E4">4.</span><span class="cs1C2E50E7">启用认证功能</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs8926E06">Memcached</span><span class="cs9C1B1871">本身没有做验证访问模块</span><span class="cs8926E06">,Memcached</span><span class="cs9C1B1871">从</span><span class="cs8926E06">1.4.3</span><span class="cs9C1B1871">版本开始，能支持</span><span class="cs8926E06">SASL</span><span class="cs9C1B1871">认证。</span><span class="cs8926E06"><a class="cs508254C" href="http://www.postfix.org/SASL_README.html?spm=a2c4g.11186623.2.5.RpKdcX##saslauthd"><span class="cs4B51D5E4">SASL</span><span class="cs1C2E50E7">认证详细配置手册</span></a></span></p><h5 class="cs868C439D">
			<a name="X91036202f25672369fc538655bb6f38a639f9d7"><span class="cs4B51D5E4">5.</span><span class="cs1C2E50E7">修改默认端口</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">修改默认</span><span class="cs8926E06">11211</span><span class="cs9C1B1871">监听端口为</span><span class="cs8926E06">11222</span><span class="cs9C1B1871">端口。在</span><span class="cs8926E06">Linux</span><span class="cs9C1B1871">环境中运行以下命令：</span></p><p class="cs3A447A38"><span class="cs9FB05234">memcached -d -m 1024 -u memcached -l 127.0.0.1 -p 11222 -c 1024 -P /tmp/memcached.pid</span></p><h5 class="cs868C439D">
			<a name="X67db2be3330b8c16bb780b5a9e0f8e533d0daee"><span class="cs4B51D5E4">6.</span><span class="cs1C2E50E7">定期升级</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">参考</span><span class="cs8926E06">:</span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="http://lzone.de/cheat-sheet/memcached"><span class="cs4B51D5E4">http://lzone.de/cheat-sheet/memcached</span></a></span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="https://www.secpulse.com/archives/49659.html"><span class="cs4B51D5E4">https://www.secpulse.com/archives/49659.html</span></a></span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="https://www.sensepost.com/blog/2010/blackhat-write-up-go-derper-and-mining-memcaches/"><span class="cs4B51D5E4">https://www.sensepost.com/blog/2010/blackhat-write-up-go-derper-and-mining-memcaches/</span></a></span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="https://www.blackhat.com/docs/us-14/materials/us-14-Novikov-The-New-Page-Of-Injections-Book-Memcached-Injections-WP.pdf"><span class="cs4B51D5E4">https://www.blackhat.com/docs/us-14/materials/us-14-Novikov-The-New-Page-Of-Injections-Book-Memcached-Injections-WP.pdf</span></a></span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="http://niiconsulting.com/checkmate/2013/05/memcache-exploit/"><span class="cs4B51D5E4">http://niiconsulting.com/checkmate/2013/05/memcache-exploit/</span></a></span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="https://xz.aliyun.com/t/2018"><span class="cs4B51D5E4">https://xz.aliyun.com/t/2018</span></a></span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="http://drops.xmd5.com/static/drops/web-8987.html"><span class="cs4B51D5E4">http://drops.xmd5.com/static/drops/web-8987.html</span></a></span></p><p class="cs40DD2BC9"><span class="cs8926E06">https://blog.csdn.net/microzone/article/details/79262549&lt;</span></p></body>
</html>
