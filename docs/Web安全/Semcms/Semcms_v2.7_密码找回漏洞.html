<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="semcms-v27-密码找回漏洞"><span class="csDE05BCC">Semcms v2.7 </span><span class="csECDA2D3">密码找回漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">SemCMS v2.7</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">先在本地搭建好环境。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">访问后台登录页面如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="396" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">先来看看正常的找回密码的过程。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">首先，查看</span><span class="cs8926E06"> tfmp_Admin/index.html </span><span class="cs9C1B1871">的源码：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="133" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">从代码可以看到，当点击登录按钮旁边的链接</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">如果忘记账号与密码，试试找回？</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">，时，会执行</span><span class="cs8926E06"> js</span><span class="cs9C1B1871">的</span><span class="cs8926E06">views() </span><span class="cs9C1B1871">函数，该函数是弹出一个对话框并向</span><span class="cs8926E06">SEMCMS_Remail.php?type=find </span><span class="cs9C1B1871">发送请求，让用户填写要接收重置后密码的邮箱地址，如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="173" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到，就是构造上面那个要求输入</span><span class="cs8926E06">E-mail</span><span class="cs9C1B1871">的表单，点击</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">确认找回</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">按钮，该表单会提交到</span></p><p class="cs3A447A38"><span class="cs9FB05234">../Include/web_email.php?type=findpassword</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">，再看一下</span><span class="cs8926E06"> web_email.php </span><span class="cs9C1B1871">中</span><span class="cs8926E06"> type=findpassword </span><span class="cs9C1B1871">时的代码：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="330" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">代码会根据用户输入的</span><span class="cs8926E06">E-mail</span><span class="cs9C1B1871">地址，查找</span><span class="cs8926E06"> sc_user </span><span class="cs9C1B1871">表，看是否存在使用该</span><span class="cs8926E06">E-mail</span><span class="cs9C1B1871">地址的用户，如果存在，则随机生成</span><span class="cs8926E06">4</span><span class="cs9C1B1871">位数的认证码，并将其拼接到一个密码重置链接中，最后以邮件的形式发送给用户。用户点击邮件中的密码重置链接即可；但如果不存在，则弹出对话框，提示</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">此邮箱不存在！</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">，如图：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image4.png" width="560" height="334" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里假设知道了管理员的邮箱，由于认证码是随机的</span><span class="cs8926E06">4</span><span class="cs9C1B1871">位数，这里很容易想到暴力破解。但通过</span></p><p class="cs3A447A38"><span class="cs9FB05234">../Include/web_email.php?type=findpassword</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">无法进行暴力破解，因为如上面代码所示，每次进入</span><span class="cs8926E06"> if ($Type == &#39;findpassword&#39;) </span><span class="cs9C1B1871">语句块，认证码会重新生成。所以只能看看有没有别的地方可以利用。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">回头再查看</span><span class="cs8926E06"> index.html </span><span class="cs9C1B1871">的代码：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image5.png" width="560" height="84" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当请求参数</span><span class="cs8926E06"> type=ok </span><span class="cs9C1B1871">时，</span><span class="cs8926E06">SEMCMS_Remail.php</span><span class="cs9C1B1871">后面跟的参数</span><span class="cs8926E06">type</span><span class="cs9C1B1871">也是</span><span class="cs8926E06">ok</span><span class="cs9C1B1871">，而前面提到，这种情况下，</span><span class="cs8926E06">SEMCMS_Remail.php</span><span class="cs9C1B1871">会构造另外一个表单，如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image6.png" width="560" height="398" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">点击</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">确认找回</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">按钮，会提交到</span></p><p class="cs3A447A38"><span class="cs9FB05234">../Include/web_email.php?type=findok</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">，</span><span class="cs8926E06">web_email.php </span><span class="cs9C1B1871">相应部分的代码如下：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image7.png" width="560" height="164" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到，密码会经过</span><span class="cs8926E06">md5</span><span class="cs9C1B1871">加密后再存入数据库中。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">因此，这里可以通过</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/semcms_php_v2.7/tfmp_Admin/index.html?type=ok&amp;umail=41864438@qq.com</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">弹出的表单，提交表单，使用</span><span class="cs8926E06">BurpSuite</span><span class="cs9C1B1871">进行暴力破解从而将密码重置。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">为了本地测试方便，所以将初始密码设置为</span><span class="cs8926E06"> 111111</span><span class="cs9C1B1871">，其</span><span class="cs8926E06">md5</span><span class="cs9C1B1871">的值为：</span><span class="cs8926E06">96e79218965eb72c92a549dd5a330112</span><span class="cs9C1B1871">。重置后密码将变为</span><span class="cs8926E06">123456</span><span class="cs9C1B1871">，</span><span class="cs8926E06">MD5</span><span class="cs9C1B1871">加密后即</span><span class="cs8926E06"> e10adc3949ba59abbe56e057f20f883e</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image8.png" width="560" height="38" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">先用</span><span class="cs8926E06">Python</span><span class="cs9C1B1871">生成一个四位数字的字典：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image9.png" width="560" height="81" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">利用</span><span class="cs8926E06">BurpSuite </span><span class="cs9C1B1871">进行暴力破解：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image10.png" width="560" height="174" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image11.png" width="560" height="505" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image12.png" width="560" height="404" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">结束后，查看数据库，发现密码确实被重置了：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image13.png" width="560" height="28" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06"> Admin/123456 </span><span class="cs9C1B1871">可以成功登陆后台管理页面：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Semcms/Semcms%20v2.7%20%e5%af%86%e7%a0%81%e6%89%be%e5%9b%9e%e6%bc%8f%e6%b4%9e_files/image14.png" width="560" height="266" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">另外，这里涉及到表单提交，所以过程中我也想到过能否使用</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">注入，然而每一次表单的提交，</span><span class="cs8926E06">php</span><span class="cs9C1B1871">代码中都在</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">语句构造前，对用户的表单输入通过</span><span class="cs8926E06"> test_input() </span><span class="cs9C1B1871">函数进行了安全检查和过滤，所以不存在</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入的问题。</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://www.jianshu.com/p/4776cec565c1"><span class="cs4B51D5E4">https://www.jianshu.com/p/4776cec565c1</span></a></span></p></body>
</html>
