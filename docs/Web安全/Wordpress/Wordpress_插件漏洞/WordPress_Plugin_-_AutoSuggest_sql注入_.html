<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="wordpress-plugin---autosuggest-sql注入"><span class="csDE05BCC">WordPress Plugin - AutoSuggest sql</span><span class="csECDA2D3">注入</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">WP AutoSuggest</span><span class="cs9C1B1871">这款插件在访问者输入关键字时，插件会在提交搜索查询之前通过</span><span class="cs8926E06">AJAX</span><span class="cs9C1B1871">请求在网页中显示一些建议。访问者可以通过按</span><span class="cs8926E06">Enter</span><span class="cs9C1B1871">继续搜索，或者访问者可以使用键盘箭头直接访问建议的帖子。</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先我们得进入</span><span class="cs8926E06">exploit-db</span><span class="cs9C1B1871">网站上下载这个存在漏洞的版本的插件原始码和本地构建</span><span class="cs8926E06">WordPress</span><span class="cs9C1B1871">网站（本地构建</span><span class="cs8926E06">WordPress</span><span class="cs9C1B1871">这里就不说了）。下载源码，如下图所示</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_插件漏洞/WordPress%20Plugin%20-%20AutoSuggest%20sql%e6%b3%a8%e5%85%a5%20_files/image0.png" width="560" height="137" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">下载完成之后，把</span><span class="cs8926E06">wp-autosuggest</span><span class="cs9C1B1871">目录直接拖到</span><span class="cs8926E06">Wordpress</span><span class="cs9C1B1871">目录的</span><span class="cs8926E06">\wp-content\plugins\</span><span class="cs9C1B1871">下。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_插件漏洞/WordPress%20Plugin%20-%20AutoSuggest%20sql%e6%b3%a8%e5%85%a5%20_files/image1.png" width="560" height="188" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">接着，登录后台，启用这款插件，如下图所示：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_插件漏洞/WordPress%20Plugin%20-%20AutoSuggest%20sql%e6%b3%a8%e5%85%a5%20_files/image2.png" width="560" height="226" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">启用后，退出后台，如下图所示：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_插件漏洞/WordPress%20Plugin%20-%20AutoSuggest%20sql%e6%b3%a8%e5%85%a5%20_files/image3.png" width="456" height="240" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后根据</span><span class="cs8926E06">exploit-db</span><span class="cs9C1B1871">网站上给出的漏洞详情，我们访问下面的</span><span class="cs8926E06">URL</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://www.0-sec.org/wp-content/plugins/wp-autosuggest/autosuggest.php?wpas_action=query&amp;wpas_keys=1</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">访问后，网页内容如下图所示：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_插件漏洞/WordPress%20Plugin%20-%20AutoSuggest%20sql%e6%b3%a8%e5%85%a5%20_files/image4.png" width="560" height="65" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">根据</span><span class="cs8926E06">exploit-db</span><span class="cs9C1B1871">网站上给出的漏洞详情，我们也知道了</span><span class="cs8926E06">wpas_keys</span><span class="cs9C1B1871">参数存在注入，于是我们可以使用</span><span class="cs8926E06">SQLMAP</span><span class="cs9C1B1871">注入神器，对网站进行注入。</span><span class="cs8926E06">SQLMAP</span><span class="cs9C1B1871">命令如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">sqlmap.py -u &quot;http://www.0-sec.org/wp-content/plugins/wp-autosuggest/autosuggest.php?wpas_action=query&amp;wpas_keys=1*&quot; --technique BT --dbms MYSQL --risk 3 --level 5 --tamper space2comment</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">一开始，笔者使用的时</span><span class="cs8926E06">php5.2.17+Apache</span><span class="cs9C1B1871">的环境，结果复现不了，头疼了半天，如下图：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_插件漏洞/WordPress%20Plugin%20-%20AutoSuggest%20sql%e6%b3%a8%e5%85%a5%20_files/image5.png" width="560" height="279" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">后来笔者换了一个</span><span class="cs8926E06">php-5.4.45+Apache</span><span class="cs9C1B1871">的环境，就解决了。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_插件漏洞/WordPress%20Plugin%20-%20AutoSuggest%20sql%e6%b3%a8%e5%85%a5%20_files/image6.png" width="344" height="653" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过</span><span class="cs8926E06">SQLMAP</span><span class="cs9C1B1871">，成功获取到服务器的一些信息，如下图所示：</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_插件漏洞/WordPress%20Plugin%20-%20AutoSuggest%20sql%e6%b3%a8%e5%85%a5%20_files/image7.png" width="560" height="279" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">下图也成功跑出了当前数据库的名称。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_插件漏洞/WordPress%20Plugin%20-%20AutoSuggest%20sql%e6%b3%a8%e5%85%a5%20_files/image8.png" width="560" height="157" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">分析</span><span class="cs8926E06">WordPress</span><span class="cs9C1B1871">插件的话还是挺容易的。文件和代码也不是很多，用</span><span class="cs8926E06">Notepad++</span><span class="cs9C1B1871">就够用啦。进入插件根目录下面就看到了</span><span class="cs8926E06">autosuggest_functions.php</span><span class="cs9C1B1871">、</span><span class="cs8926E06">autosuggest.php</span><span class="cs9C1B1871">这两个</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_插件漏洞/WordPress%20Plugin%20-%20AutoSuggest%20sql%e6%b3%a8%e5%85%a5%20_files/image9.png" width="560" height="237" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">下面是</span><span class="cs8926E06">autosuggest.php</span><span class="cs9C1B1871">文件所有代码：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include &#39;autosuggest_functions.php&#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">$wpas_action = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$wpas_keys = &#39;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if(isset($_GET[&#39;wpas_action&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$wpas_action = $_GET[&#39;wpas_action&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if (isset($_GET[&#39;wpas_keys&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$wpas_keys = $_GET[&#39;wpas_keys&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if ($wpas_action == &#39;query&#39;) {</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;require_once (&#39;../../../wp-config.php&#39;);</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;header(&#39;Content-Type: text/xml&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo &#39;&lt;results&gt;&#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;global $wpdb;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$wpas_keys = str_replace(&#39; &#39;,&#39;%&#39;,$wpas_keys);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$pageposts = $wpdb-&gt;get_results(&quot;SELECT * FROM $wpdb-&gt;posts WHERE (post_title LIKE &#39;%$wpas_keys%&#39;) AND post_status = &#39;publish&#39; ORDER BY post_date DESC&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;foreach ($pageposts as $post) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setup_postdata($post);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo &quot;&lt;rs id=\&quot;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the_permalink();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo &quot;\&quot; info=\&quot;&quot; . autosuggest_excerpt(apply_filters(&#39;the_title&#39;, get_the_content())) . &quot;\&quot;&gt;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the_title();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo &quot;&lt;/rs&gt;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;echo &#39;&lt;/results&gt;&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;die();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">define(&#39;AUTOSUGGEST_DIR&#39;, get_option(&#39;siteurl&#39;) . &#39;/&#39; . PLUGINDIR.&#39;/&#39;.dirname(plugin_basename(__FILE__)));</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">function add_autosuggest_css() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;wp_register_style(&#39;autosuggestCSS&#39;, AUTOSUGGEST_DIR . &#39;/css/wp_autosuggest.css&#39;, null, &#39;1&#39;, &#39;screen&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;wp_enqueue_style(&#39;autosuggestCSS&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function add_autosuggest_js() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;wp_register_script(&#39;autosuggestJS&#39;, AUTOSUGGEST_DIR . &#39;/js/wp.autosuggest.js&#39;, null, &#39;1&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;wp_enqueue_script(&#39;autosuggestJS&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function add_autosuggest_footer_code() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;script type=&quot;text/javascript&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var autosuggest_options = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;script: &quot;&lt;?php echo AUTOSUGGEST_DIR; ?&gt;/autosuggest.php?wpas_action=query&amp;&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;varname: &quot;wpas_keys&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;shownoresults:true,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;noresults:&quot;&lt;?php echo __(&#39;No results found.&#39;); ?&gt;&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;timeout:15000,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;callback:autosuggestSelected,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;maxresults: &lt;?php echo get_wpas_option(&#39;wpas_maxresults&#39;,&#39;10&#39;); ?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var as = new AutoSuggest(&#39;&lt;?php echo get_wpas_option(&#39;wpas_input_id&#39;,&#39;s&#39;); ?&gt;&#39;, autosuggest_options);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function autosuggestSelected(entry) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;document.location = entry[&#39;id&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;/script&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function add_autosuggest_settings() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;div class=&quot;wrap&quot;&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;?php</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$smsg = &quot;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isset($_POST[&#39;submitoptions&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isset($_POST[&#39;wpas_input_id&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;update_option(&#39;wpas_input_id&#39;,$_POST[&#39;wpas_input_id&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isset($_POST[&#39;wpas_maxresults&#39;])) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;update_option(&#39;wpas_maxresults&#39;,$_POST[&#39;wpas_maxresults&#39;]);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;div id=&quot;message&quot; class=&quot;updated fade&quot;&gt;&lt;p&gt;WP AutoSuggest settings updated.&lt;/p&gt;&lt;/div&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;?php } ?&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;h2&gt;WP AutoSuggest Settings&lt;/h2&gt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;table class=&quot;form-table&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;tr valign=&quot;top&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;th scope=&quot;row&quot;&gt;Search Input ID&lt;/th&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;td&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&quot;text&quot; value=&quot;&lt;?php echo get_wpas_option(&#39;wpas_input_id&#39;,&#39;s&#39;); ?&gt;&quot; id=&quot;wpas_input_id&quot; name=&quot;wpas_input_id&quot;/&gt;&lt;br/&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Default value is &#39;s&#39; which is used with the default WordPress theme. </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/td&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/tr&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;tr valign=&quot;top&quot;&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;th scope=&quot;row&quot;&gt;Max Results&lt;/th&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;td&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;input type=&quot;text&quot; value=&quot;&lt;?php echo get_wpas_option(&#39;wpas_maxresults&#39;,&#39;10&#39;); ?&gt;&quot; id=&quot;wpas_maxresults&quot; name=&quot;wpas_maxresults&quot;/&gt;&lt;br/&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Maximum number of suggested results (10 by default).</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/td&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/tr&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/table&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;p class=&quot;submit&quot;&gt;&lt;input type=&quot;submit&quot; name=&quot;submitoptions&quot; value=&quot;Update Settings&quot; /&gt;&lt;/p&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/form&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&lt;/div&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function add_autosuggest_menu_settings() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if (function_exists(&#39;add_options_page&#39;)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_options_page(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WP AutoSuggest&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, &quot;WP AutoSuggest&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, 7</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, basename(__FILE__)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, &#39;add_autosuggest_settings&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">add_action(&#39;wp_print_scripts&#39;, &#39;add_autosuggest_js&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">add_action(&#39;wp_print_styles&#39;, &#39;add_autosuggest_css&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">add_action(&#39;wp_footer&#39;, &#39;add_autosuggest_footer_code&#39;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">add_action(&#39;admin_menu&#39;, &#39;add_autosuggest_menu_settings&#39;);</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">相信大家没看几行就看出了问题的所在，变量</span><span class="cs8926E06">wpas_keys</span><span class="cs9C1B1871">是直接获取</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">wpas_keys</span><span class="cs9C1B1871">。一点都没过滤，并且在下面代码中，变量</span><span class="cs8926E06">wpas_keys</span><span class="cs9C1B1871">也带入数据库中查询了（</span><span class="cs8926E06">wpdb</span><span class="cs9C1B1871">是</span><span class="cs8926E06">wordpress</span><span class="cs9C1B1871">操作数据库方法），于是</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">注入就产生了。</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_插件漏洞/WordPress%20Plugin%20-%20AutoSuggest%20sql%e6%b3%a8%e5%85%a5%20_files/image10.png" width="560" height="196" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="四、参考链接"><span class="cs83F14626">四、参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://www.exploit-db.com/exploits/45977"><span class="cs4B51D5E4">https://www.exploit-db.com/exploits/45977</span></a></span></p><p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://www.freebuf.com/vuls/191869.html"><span class="cs4B51D5E4">https://www.freebuf.com/vuls/191869.html</span></a></span></p></body>
</html>
