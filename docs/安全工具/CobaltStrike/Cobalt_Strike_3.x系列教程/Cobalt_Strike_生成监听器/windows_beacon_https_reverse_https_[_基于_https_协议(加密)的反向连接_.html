<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h2 class="cs868C439D">
			<a name="Xf4f3fce77ed0032c1999bb1d1329d36b0989388"><span class="csB2D98684">windows/beacon_https/reverse_https [ </span><span class="cs83F14626">基于</span><span class="csB2D98684"> https </span><span class="cs83F14626">协议</span><span class="csB2D98684">(</span><span class="cs83F14626">加密</span><span class="csB2D98684">)</span><span class="cs83F14626">的反向连接</span><span class="csB2D98684"> ]</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">首先</span><span class="cs8926E06">,</span><span class="cs9C1B1871">依然是创建一个</span><span class="cs8926E06"> windows/beacon_https/reverse_https </span><span class="cs9C1B1871">的监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">具体如下</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_beacon_https_reverse_https%20[%20%e5%9f%ba%e4%ba%8e%20https%20%e5%8d%8f%e8%ae%ae(%e5%8a%a0%e5%af%86)%e7%9a%84%e5%8f%8d%e5%90%91%e8%bf%9e%e6%8e%a5%20_files/image0.png" width="560" height="266" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">接着</span><span class="cs8926E06">,</span><span class="cs9C1B1871">再用如上监听器创建</span><span class="cs8926E06"> windows </span><span class="cs9C1B1871">服务</span><span class="cs8926E06"> payload</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_beacon_https_reverse_https%20[%20%e5%9f%ba%e4%ba%8e%20https%20%e5%8d%8f%e8%ae%ae(%e5%8a%a0%e5%af%86)%e7%9a%84%e5%8f%8d%e5%90%91%e8%bf%9e%e6%8e%a5%20_files/image1.png" width="560" height="222" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">从字面意义上不难理解</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所谓</span><span class="cs8926E06"> Windows </span><span class="cs9C1B1871">服务</span><span class="cs8926E06"> payload,</span><span class="cs9C1B1871">顾名思义就是以服务的方式启动的</span><span class="cs8926E06"> payload,</span><span class="cs9C1B1871">它不同于常规的</span><span class="cs8926E06"> exe payload </span><span class="cs9C1B1871">直接双击即可运行</span><span class="cs8926E06">,windows </span><span class="cs9C1B1871">服务</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">需要你先用</span><span class="cs8926E06"> sc </span><span class="cs9C1B1871">把它做成系统服务</span><span class="cs8926E06">,</span><span class="cs9C1B1871">然后再以服务的方式来启动运行</span><span class="cs8926E06"> payload,</span><span class="cs9C1B1871">说白点最终都是在执行某个路径下的</span><span class="cs8926E06"> exe,</span><span class="cs9C1B1871">只是调用的方式不通而已</span><span class="cs8926E06">,</span><span class="cs9C1B1871">具体操作如下</span></p><p class="cs3A447A38"><span class="cs9FB05234"># sc create GoogleUpdate binpath= &quot;C:\Windows\Help\Help\servrcs.exe&quot; start= auto displayname= &quot;Plugins Transfer Service&quot; </span><span class="cs7FFD2630">创建系统服务</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># sc start GoogleUpdate </span><span class="cs7FFD2630">启动该服务</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># sc stop GoogleUpdate </span><span class="cs7FFD2630">停止该服务</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># sc delete GoogleUpdate </span><span class="cs7FFD2630">删除指定服务</span><span class="cs9FB05234">,</span><span class="cs7FFD2630">一定要先停止再删除</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_beacon_https_reverse_https%20[%20%e5%9f%ba%e4%ba%8e%20https%20%e5%8d%8f%e8%ae%ae(%e5%8a%a0%e5%af%86)%e7%9a%84%e5%8f%8d%e5%90%91%e8%bf%9e%e6%8e%a5%20_files/image2.png" width="560" height="414" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">如下</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当我们成功启动服务后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">便会看到一个</span><span class="cs8926E06"> beacon shell </span><span class="cs9C1B1871">被正常弹回</span><span class="cs8926E06">,</span><span class="cs9C1B1871">特别注意下回来的这个</span><span class="cs8926E06"> shell </span><span class="cs9C1B1871">权限</span><span class="cs8926E06">,</span><span class="cs9C1B1871">默认以管理员身份创建启动的服务回来的</span><span class="cs8926E06"> shell </span><span class="cs9C1B1871">一般都直接是</span><span class="cs8926E06"> system </span><span class="cs9C1B1871">权限</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这也是有别于常规</span><span class="cs8926E06"> exe payload </span><span class="cs9C1B1871">的地方</span><span class="cs8926E06">,</span><span class="cs9C1B1871">执行</span><span class="cs8926E06"> exe payload </span><span class="cs9C1B1871">弹回来的</span><span class="cs8926E06"> shell </span><span class="cs9C1B1871">默认只是当前用户的权限</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如果当前用户并不是系统管理员或者是一个未被</span><span class="cs8926E06"> BypassUAC </span><span class="cs9C1B1871">的</span><span class="cs8926E06">&quot;</span><span class="cs9C1B1871">管理员</span><span class="cs8926E06">&quot;,</span><span class="cs9C1B1871">那这个</span><span class="cs8926E06"> shell </span><span class="cs9C1B1871">在目标系统中可操作的范围就很窄了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">后期还要想办法提权才行</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_beacon_https_reverse_https%20[%20%e5%9f%ba%e4%ba%8e%20https%20%e5%8d%8f%e8%ae%ae(%e5%8a%a0%e5%af%86)%e7%9a%84%e5%8f%8d%e5%90%91%e8%bf%9e%e6%8e%a5%20_files/image3.png" width="560" height="220" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">然后我们再来简单看下此时的目标系统进程</span><span class="cs8926E06">,</span><span class="cs9C1B1871">发现它是利用</span><span class="cs8926E06"> rundll32.exe </span><span class="cs9C1B1871">来执行我们的服务</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">相对于那种</span><span class="cs8926E06"> exe payload </span><span class="cs9C1B1871">直接一个进程大摇大摆的在目标系统里挂着</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这种服务启动的方式就要显的隐蔽多了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当然啦</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这也仅仅只是相对隐蔽而已</span><span class="cs8926E06">,</span><span class="cs9C1B1871">还是很容易被一步定位到</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_beacon_https_reverse_https%20[%20%e5%9f%ba%e4%ba%8e%20https%20%e5%8d%8f%e8%ae%ae(%e5%8a%a0%e5%af%86)%e7%9a%84%e5%8f%8d%e5%90%91%e8%bf%9e%e6%8e%a5%20_files/image4.png" width="560" height="326" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">很明显</span><span class="cs8926E06">,</span><span class="cs9C1B1871">由于此处用的是</span><span class="cs8926E06"> https </span><span class="cs9C1B1871">监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">从</span><span class="cs8926E06"> wireshark </span><span class="cs9C1B1871">中我们发现此时的回传数据已被全部加密</span><span class="cs8926E06">,</span><span class="cs9C1B1871">之所以要用</span><span class="cs8926E06"> https,</span><span class="cs9C1B1871">是因为这种方式在某些情况下</span><span class="cs8926E06">,</span><span class="cs9C1B1871">穿透性要比</span><span class="cs8926E06"> http </span><span class="cs9C1B1871">稍好一些</span><span class="cs8926E06">,</span><span class="cs9C1B1871">一定程度上可防止流量被目标的一些防护设备反向解析</span><span class="cs8926E06">,</span><span class="cs9C1B1871">其实</span><span class="cs8926E06">,</span><span class="cs9C1B1871">说实话</span><span class="cs8926E06">,</span><span class="cs9C1B1871">也并好不到哪里去</span><span class="cs8926E06">,</span><span class="cs9C1B1871">另外</span><span class="cs8926E06">,</span><span class="cs9C1B1871">同样还是那个问题</span><span class="cs8926E06">,</span><span class="cs9C1B1871">直接这样生成的服务</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">也几乎也是不可能免杀的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所以</span><span class="cs8926E06">,</span><span class="cs9C1B1871">此处目的也只仅仅只是为了告诉大家</span><span class="cs8926E06">,</span><span class="cs9C1B1871">以后可以用这种方式去执行自己的</span><span class="cs8926E06"> payload,</span><span class="cs9C1B1871">但</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">不一定非要这么生成</span><span class="cs8926E06">,</span><span class="cs9C1B1871">希望弟兄们能明白我的意思</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_beacon_https_reverse_https%20[%20%e5%9f%ba%e4%ba%8e%20https%20%e5%8d%8f%e8%ae%ae(%e5%8a%a0%e5%af%86)%e7%9a%84%e5%8f%8d%e5%90%91%e8%bf%9e%e6%8e%a5%20_files/image5.png" width="560" height="146" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">最后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">服务用完以后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">记得随手删除</span></p><p class="cs40DD2BC9"><span class="cs8926E06">image</span></p></body>
</html>
