<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="尝试将本地-c2-隐匿于-ssh-加密隧道中"><span class="csECDA2D3">尝试将本地</span><span class="csDE05BCC"> C2 </span><span class="csECDA2D3">隐匿于</span><span class="csDE05BCC"> SSH </span><span class="csECDA2D3">加密隧道中</span></a></h1>
		<h2 class="cs868C439D">
			<a name="X0bc3e1c2d5989e37122ef9ffa06d080b0b1b1a2"><span class="csB2D98684">0x01 </span><span class="cs83F14626">大致思路拓扑说明</span></a></h2>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%e6%9c%ac%e5%9c%b0%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%20SSH%20%e5%8a%a0%e5%af%86%e9%9a%a7%e9%81%93%e4%b8%ad_files/image0.png" width="560" height="257" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">思路其实非常简单</span><span class="cs8926E06">,</span><span class="cs9C1B1871">首先</span><span class="cs8926E06">,</span><span class="cs9C1B1871">先在本地把</span><span class="cs8926E06"> CobaltStrike </span><span class="cs9C1B1871">团队服务器</span><span class="cs8926E06"> [ </span><span class="cs9C1B1871">即</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">服务器</span><span class="cs8926E06"> ] </span><span class="cs9C1B1871">起起来</span><span class="cs8926E06">,</span><span class="cs9C1B1871">然后再拿本地的</span><span class="cs8926E06"> CobaltStrike </span><span class="cs9C1B1871">客户端连上去</span><span class="cs8926E06">,</span><span class="cs9C1B1871">接着</span><span class="cs8926E06">,</span><span class="cs9C1B1871">便是整个过程最关键的一步</span><span class="cs8926E06">,</span><span class="cs9C1B1871">建立</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道并执行远程端口转发</span><span class="cs8926E06">,</span><span class="cs9C1B1871">谁和谁建呢</span><span class="cs8926E06">? </span><span class="cs9C1B1871">也就是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">本地的</span><span class="cs8926E06"> linux </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> </span><span class="cs9C1B1871">自己的</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">建</span><span class="cs8926E06">,</span><span class="cs9C1B1871">远程转发的意思其实就是</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当公网访问</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">的某个指定端口时</span><span class="cs8926E06">,</span><span class="cs9C1B1871">就直接把这个端口的流量转到我本地机器的某个端口上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">假如</span><span class="cs8926E06">,</span><span class="cs9C1B1871">本地机器机器的这个端口正好是</span><span class="cs8926E06"> </span><span class="cs9C1B1871">比如</span><span class="cs8926E06">,CobaltStrike </span><span class="cs9C1B1871">类似这种监听器的端口</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这意味着什么就很都清楚了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">也就是所谓的本地</span><span class="cs8926E06"> C2 beacon </span><span class="cs9C1B1871">上线，如果弟兄们真正理解了</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道的远程转发</span><span class="cs8926E06">,</span><span class="cs9C1B1871">其实这些真的都挺简单的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">单单只是作为使用者的我们来讲</span><span class="cs8926E06">,</span><span class="cs9C1B1871">完全不存在什么太多的技术含量在里面</span><span class="cs8926E06">,ok,</span><span class="cs9C1B1871">废话不多讲</span><span class="cs8926E06">,</span><span class="cs9C1B1871">来看实际操作</span></p><h2 class="cs868C439D">
			<a name="Xae3e367143d758a4d90c02c62e7144168ea8a6b"><span class="csB2D98684">0x02 </span><span class="cs83F14626">首先</span><span class="csB2D98684">,</span><span class="cs83F14626">到本地</span><span class="csB2D98684"> linux </span><span class="cs83F14626">机器上启动</span><span class="csB2D98684"> CobaltStrike </span><span class="cs83F14626">团队服务器</span><span class="csB2D98684">[ </span><span class="cs83F14626">即</span><span class="csB2D98684"> C2 </span><span class="cs83F14626">服务器</span><span class="csB2D98684"> ] </span><span class="cs83F14626">和</span><span class="csB2D98684"> CobaltStrike </span><span class="cs83F14626">客户端</span><span class="csB2D98684">,</span><span class="cs83F14626">如下</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">本地启动</span><span class="cs8926E06"> CS </span><span class="cs9C1B1871">团队服务器</span></p><p class="cs3A447A38"><span class="cs9FB05234"># ./teamserver 192.168.3.137 admin</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%e6%9c%ac%e5%9c%b0%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%20SSH%20%e5%8a%a0%e5%af%86%e9%9a%a7%e9%81%93%e4%b8%ad_files/image1.png" width="560" height="73" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">然后启动</span><span class="cs8926E06"> CS </span><span class="cs9C1B1871">客户端连到团队服务器上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">并创建一个常规</span><span class="cs8926E06"> http </span><span class="cs9C1B1871">反向监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">监听</span><span class="cs8926E06"> 80 </span><span class="cs9C1B1871">端口</span><span class="cs8926E06">,</span><span class="cs9C1B1871">注意</span><span class="cs8926E06">,</span><span class="cs9C1B1871">反向监听器是直接监听的本地</span><span class="cs8926E06"> ip</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%e6%9c%ac%e5%9c%b0%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%20SSH%20%e5%8a%a0%e5%af%86%e9%9a%a7%e9%81%93%e4%b8%ad_files/image2.png" width="560" height="118" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">接着</span><span class="cs8926E06">,</span><span class="cs9C1B1871">再创建一个</span><span class="cs8926E06"> CS </span><span class="cs9C1B1871">外部监听器</span><span class="cs8926E06">[</span><span class="cs9C1B1871">协议</span><span class="cs8926E06">,</span><span class="cs9C1B1871">端口要和上面保持一致</span><span class="cs8926E06">],</span><span class="cs9C1B1871">这个外部监听器的主要作用就是把回连的流量先弹到我们公网的</span><span class="cs8926E06"> VPS </span><span class="cs9C1B1871">机器上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">因为此处全部是用域名在操作</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所以</span><span class="cs8926E06">,</span><span class="cs9C1B1871">事先务必先添加一条指向</span><span class="cs8926E06"> VPS </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> A </span><span class="cs9C1B1871">记录</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如下</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%e6%9c%ac%e5%9c%b0%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%20SSH%20%e5%8a%a0%e5%af%86%e9%9a%a7%e9%81%93%e4%b8%ad_files/image3.png" width="560" height="108" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%e6%9c%ac%e5%9c%b0%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%20SSH%20%e5%8a%a0%e5%af%86%e9%9a%a7%e9%81%93%e4%b8%ad_files/image4.png" width="560" height="284" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%e6%9c%ac%e5%9c%b0%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%20SSH%20%e5%8a%a0%e5%af%86%e9%9a%a7%e9%81%93%e4%b8%ad_files/image5.png" width="560" height="88" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">最后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">再用上面创建的外部监听生成一个</span><span class="cs8926E06"> exe payload</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%e6%9c%ac%e5%9c%b0%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%20SSH%20%e5%8a%a0%e5%af%86%e9%9a%a7%e9%81%93%e4%b8%ad_files/image6.png" width="560" height="342" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="Xfb7be6f9e7c17e794a01ebc2e4142bcb889f4e6"><span class="csB2D98684">0x03 </span><span class="cs83F14626">其次</span><span class="csB2D98684">,</span><span class="cs83F14626">开始尝试在</span><span class="csB2D98684"> </span><span class="cs83F14626">本地</span><span class="csB2D98684"> linux </span><span class="cs83F14626">和</span><span class="csB2D98684"> vps </span><span class="cs83F14626">机器</span><span class="csB2D98684"> </span><span class="cs83F14626">之间建立</span><span class="csB2D98684"> ssh </span><span class="cs83F14626">隧道并执行</span><span class="csB2D98684"> </span><span class="cs83F14626">远程端口转发</span><span class="csB2D98684">, </span><span class="cs83F14626">如下</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">先开启</span><span class="cs8926E06"> vps ssh </span><span class="cs9C1B1871">转发</span></p><p class="cs3A447A38"><span class="cs9FB05234"># vi /etc/ssh/sshd_config</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">AllowTcpForwarding yes</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">GatewayPorts yes</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">TCPKeepAlive yes</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">PasswordAuthentication yes</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># systemctl restart sshd.service </span><span class="cs7FFD2630">重启</span><span class="cs9FB05234"> ssh </span><span class="cs7FFD2630">服务</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">建立隧道并执行远程转发</span><span class="cs8926E06">,</span><span class="cs9C1B1871">即把来自外部的</span><span class="cs8926E06"> 80 </span><span class="cs9C1B1871">端口流量全部转到本地</span><span class="cs8926E06"> 192.168.3.137 </span><span class="cs9C1B1871">的</span><span class="cs8926E06"> 80 </span><span class="cs9C1B1871">端口上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而这个端口正好又是上面事先准备好的</span><span class="cs8926E06"> CS </span><span class="cs9C1B1871">的反向监听器端口</span><span class="cs8926E06">,</span><span class="cs9C1B1871">后果就是</span><span class="cs8926E06">, beacon </span><span class="cs9C1B1871">直接上线</span></p><p class="cs3A447A38"><span class="cs9FB05234"># ssh -C -f -N -g -R 0.0.0.0:80:192.168.3.137:80 root@mail.first.com -p 22</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%e6%9c%ac%e5%9c%b0%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%20SSH%20%e5%8a%a0%e5%af%86%e9%9a%a7%e9%81%93%e4%b8%ad_files/image7.png" width="560" height="92" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">平时记得养成习惯</span><span class="cs8926E06">,</span><span class="cs9C1B1871">远程转发建好以后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">就立马就到</span><span class="cs8926E06"> vps </span><span class="cs9C1B1871">上去看看对应端口到底有没有起来</span><span class="cs8926E06">,</span><span class="cs9C1B1871">别等了半天</span><span class="cs8926E06">,</span><span class="cs9C1B1871">一排查发现</span><span class="cs8926E06">,</span><span class="cs9C1B1871">隧道都不通</span><span class="cs8926E06">,</span><span class="cs9C1B1871">岂不尴尬</span><span class="cs8926E06">,</span><span class="cs9C1B1871">尽量别把时间浪费在这种没必要的地方</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%e6%9c%ac%e5%9c%b0%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%20SSH%20%e5%8a%a0%e5%af%86%e9%9a%a7%e9%81%93%e4%b8%ad_files/image8.png" width="560" height="73" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="X18ef040f01e122be2f8530e0365f5b7c6517b90"><span class="csB2D98684">0x04 </span><span class="cs83F14626">最终</span><span class="csB2D98684">,</span><span class="cs83F14626">本地</span><span class="csB2D98684"> C2 beacon </span><span class="cs83F14626">上线效果</span></a></h2>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">如下</span><span class="cs8926E06">,</span><span class="cs9C1B1871">从目标机器的网络连接中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">几乎是看不到任何的连接痕迹</span><span class="cs8926E06">,</span><span class="cs9C1B1871">暂时已经达到了我们的</span><span class="cs8926E06"> &quot;</span><span class="cs9C1B1871">隐蔽需求</span><span class="cs8926E06">&quot;</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%e6%9c%ac%e5%9c%b0%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%20SSH%20%e5%8a%a0%e5%af%86%e9%9a%a7%e9%81%93%e4%b8%ad_files/image9.png" width="560" height="204" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">从</span><span class="cs8926E06"> web log </span><span class="cs9C1B1871">我们也清晰的看到</span><span class="cs8926E06">,</span><span class="cs9C1B1871">走的全部都是本地</span><span class="cs8926E06"> ip</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%e6%9c%ac%e5%9c%b0%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%20SSH%20%e5%8a%a0%e5%af%86%e9%9a%a7%e9%81%93%e4%b8%ad_files/image10.png" width="560" height="87" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="小结"><span class="cs83F14626">小结</span><span class="csB2D98684">:</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">至此为止</span><span class="cs8926E06">,</span><span class="cs9C1B1871">关于如何利用</span><span class="cs8926E06"> ssh </span><span class="cs9C1B1871">隧道的远程端口转发来深度隐藏</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">服务器基本也就说完了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">实战证明</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这种方式的稳定性暂时还是很不错的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">相比之前的</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">隐藏方式</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这种方式的优劣势都非常明显</span><span class="cs8926E06">,</span><span class="cs9C1B1871">优势就在于避免直接把自己的</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">服务器暴露在公网中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而且非常的灵活隐蔽</span><span class="cs8926E06">, </span><span class="cs9C1B1871">灵活在哪儿呢</span><span class="cs8926E06">? </span><span class="cs9C1B1871">一旦发现对方可能在溯源</span><span class="cs8926E06">, </span><span class="cs9C1B1871">我们可以立即切断连接</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不过</span><span class="cs8926E06">,</span><span class="cs9C1B1871">灵活中劣势也同时被凸显了出来</span><span class="cs8926E06">,</span><span class="cs9C1B1871">此方式并不适合拿来做长控</span><span class="cs8926E06">,</span><span class="cs9C1B1871">只适合临时渗透阶段用</span><span class="cs8926E06">[ </span><span class="cs9C1B1871">比如</span><span class="cs8926E06">,</span><span class="cs9C1B1871">你可以暂时拿这种方式渗透</span><span class="cs8926E06">,</span><span class="cs9C1B1871">然后再用其它方式长控</span><span class="cs8926E06"> ],</span><span class="cs9C1B1871">隐蔽又在哪儿呢</span><span class="cs8926E06">? </span><span class="cs9C1B1871">此处我只演示了最简单的单层</span><span class="cs8926E06"> SSH </span><span class="cs9C1B1871">隧道</span><span class="cs8926E06">,</span><span class="cs9C1B1871">其实</span><span class="cs8926E06">,</span><span class="cs9C1B1871">在实战中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">你完全可以将</span><span class="cs8926E06"> SSH </span><span class="cs9C1B1871">隧道的</span><span class="cs8926E06"> </span><span class="cs9C1B1871">远程</span><span class="cs8926E06"> </span><span class="cs9C1B1871">和</span><span class="cs8926E06"> </span><span class="cs9C1B1871">本地端口转发</span><span class="cs8926E06"> </span><span class="cs9C1B1871">灵活配合起来实现多级的</span><span class="cs8926E06"> SSH </span><span class="cs9C1B1871">隧道级联</span><span class="cs8926E06"> </span><span class="cs9C1B1871">隐藏</span><span class="cs8926E06">,</span><span class="cs9C1B1871">说到这儿</span><span class="cs8926E06">,</span><span class="cs9C1B1871">想必弟兄们都已经都很非常了然了</span><span class="cs8926E06">,ok,</span><span class="cs9C1B1871">废话不多讲</span><span class="cs8926E06">,</span><span class="cs9C1B1871">有任何问题</span><span class="cs8926E06">,</span><span class="cs9C1B1871">弟兄们及时反馈</span><span class="cs8926E06">,</span><span class="cs9C1B1871">同时也非常欢迎大家来一起</span></p></body>
</html>
