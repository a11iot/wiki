<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs53B925A8{text-align:left;margin:5pt 24pt 5pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs177011F4{text-align:left;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid;list-style-type:disc;color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="weaponzation"><span class="csDE05BCC">Weaponzation</span></a></h1>
		<h2 class="cs868C439D">
			<a name="介绍"><span class="cs83F14626">介绍</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">首先探讨下</span><span class="cs8926E06">&ldquo;</span><span class="cs9C1B1871">武器化</span><span class="cs8926E06">&rdquo;</span><span class="cs9C1B1871">，按照我个人的理解用一把枪来做类比，一颗子弹或者一把空枪不足以构成威胁，同样的在</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">将</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">和可执行文件（</span><span class="cs8926E06">EXE</span><span class="cs9C1B1871">，</span><span class="cs8926E06">DLL</span><span class="cs9C1B1871">或者</span><span class="cs8926E06">powershell</span><span class="cs9C1B1871">等）结合起来构成了武器化的概念。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">中首先解释几个概念：</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">artifact</span><span class="cs9C1B1871">可以理解为包含了</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">的全功能被控制程序。</span></li><li class="cs24C36B3"><span class="cs8926E06">stage</span><span class="cs9C1B1871">本身是一段尽可能小的手工优化过的汇编程序，连接到主控制端，按照主控制端的要求对大的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">进行下载。</span></li><li class="cs24C36B3"><span class="cs8926E06">payload</span><span class="cs9C1B1871">是指一段任意大小的，与位置无关的代码，被</span><span class="cs8926E06">stage</span><span class="cs9C1B1871">执行。</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">中许多攻击和工作流都将</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">用多个</span><span class="cs8926E06">stage</span><span class="cs9C1B1871">实现投递。</span><span class="cs8926E06"> <br/><br/></span><span class="cs9C1B1871">在上边两个图中表现了两种</span><span class="cs8926E06">artifact</span><span class="cs9C1B1871">的执行方式，一种是将</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">用</span><span class="cs8926E06">stage</span><span class="cs9C1B1871">实现投递，另外一种方式是</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">直接被运行在内存中。</span></li></ul>
		<h2 class="cs868C439D">
			<a name="可执行文件和dlls"><span class="cs83F14626">可执行文件和</span><span class="csB2D98684">DLLs</span></a></h2>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">生成一个可执行文件或者</span><span class="cs8926E06">DLL</span><span class="cs9C1B1871">的方法</span><span class="cs8926E06"><br/>Attacks-&gt;Packages-&gt;Windows EXE(s)</span></li><li class="cs24C36B3"><span class="cs9C1B1871">如何执行</span><span class="cs8926E06">DLL</span><span class="cs9C1B1871">文件</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">首先生成一个和目标机器匹配的</span><span class="cs8926E06">dll</span><span class="cs9C1B1871">文件（</span><span class="cs8926E06">x86</span><span class="cs9C1B1871">或者</span><span class="cs8926E06">x64</span><span class="cs9C1B1871">），然后在目标机器上使用</span><span class="cs8926E06">rundll32.exe </span><span class="cs9C1B1871">启动生成的</span><span class="cs8926E06">dll</span><span class="cs9C1B1871">并运行</span><span class="cs8926E06">startw</span><span class="cs9C1B1871">函数即可。</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs53B925A8"><span class="cs8926E06">rundll32.exe artifact.dll,startw</span></li></ul>
		<h2 class="cs868C439D">
			<a name="托管文件"><span class="cs83F14626">托管文件</span></a></h2>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">托管一个文件</span><span class="cs8926E06"><br/>Attacks-&gt;Web Drive-by-&gt;Host File</span></li><li class="cs24C36B3"><span class="cs9C1B1871">管理或者删除托管文件</span><span class="cs8926E06"><br/>Attacks-&gt;Web Drive-by-&gt;Manage</span></li><li class="cs24C36B3"><span class="cs9C1B1871">查看</span><span class="cs8926E06">web</span><span class="cs9C1B1871">活动</span><span class="cs8926E06"><br/>View-&gt;Web Log</span></li><li class="cs24C36B3"><span class="cs9C1B1871">一些防御措施</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">针对</span><span class="cs8926E06">curl,wget</span><span class="cs9C1B1871">和</span><span class="cs8926E06">lynx</span><span class="cs9C1B1871">返回</span><span class="cs8926E06">404</span></li><li class="cs24C36B3"><span class="cs9C1B1871">以下为托管文件的具体操作</span><span class="cs8926E06"><br/><br/> <br/></span></li></ul>
		<h2 class="cs868C439D">
			<a name="artifact-kit"><span class="csB2D98684">Artifact Kit</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">使用</span><span class="cs8926E06">Artifact Kit</span><span class="cs9C1B1871">生成可执行文件和</span><span class="cs8926E06">DLL</span><span class="cs9C1B1871">，是一款商业框架，用于构建可绕过某些防病毒，具体下载方式</span><span class="cs8926E06"> Help-&gt;Arsenal</span><span class="cs9C1B1871">。</span></p><h3 class="cs868C439D">
			<a name="artifact-kit工作原理"><span class="csD1E291E2">Artifact Kit</span><span class="csD6CA00D2">工作原理</span></a></h3>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">混淆</span><span class="cs8926E06">shellcode</span><span class="cs9C1B1871">并将其嵌套于二进制文件中，这种混淆可以绕过识别恶意代码的杀毒软件。</span></li><li class="cs24C36B3"><span class="cs9C1B1871">突破防病毒沙箱</span><span class="cs8926E06">AV</span><span class="cs9C1B1871">检测，</span><span class="cs8926E06">Artifact Kit</span><span class="cs9C1B1871">是可执行文件和</span><span class="cs8926E06">DLL</span><span class="cs9C1B1871">模板的集合，它依赖于反病毒产品不会模拟的某些行为来恢复二进制文件内的</span><span class="cs8926E06">shellcode</span><span class="cs9C1B1871">。</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/4.Weaponization/weaponzation_files/image0.png" width="560" height="351" alt="" style="border-width:0px;" /></span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs177011F4"><a name="artifact-kit使用步骤"><span class="csD1E291E2">Artifact Kit</span><span class="csD6CA00D2">使用步骤</span></a></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">Help-&gt;Arsenal </span><span class="cs9C1B1871">下载</span><span class="cs8926E06">Artifact Kit</span><span class="cs9C1B1871">，这个是需要授权的。下载完成后解压并执行文件夹中</span><span class="cs8926E06">build.sh</span><span class="cs9C1B1871">，该脚本在</span><span class="cs8926E06">Linux</span><span class="cs9C1B1871">上执行。</span><span class="cs8926E06"><br/></span></li><li class="cs24C36B3"><span class="cs9C1B1871">导入脚本，</span><span class="cs8926E06">Cobalt Strike-&gt;Script Manager,</span><span class="cs9C1B1871">从该文件夹中加载</span><span class="cs8926E06">artifact.cna</span><span class="cs9C1B1871">脚本，然后按照生成可执行文件的步骤操作即可。</span><span class="cs8926E06"> &nbsp;&nbsp;</span></li></ul>
		<h2 class="cs868C439D">
			<a name="scripted-web-delivery"><span class="csB2D98684">Scripted Web Delivery</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">利用</span><span class="cs8926E06">powershell</span><span class="cs9C1B1871">、</span><span class="cs8926E06">bitsadmin</span><span class="cs9C1B1871">、</span><span class="cs8926E06">python</span><span class="cs9C1B1871">、</span><span class="cs8926E06">regsvr32</span><span class="cs9C1B1871">远程下马，提供的单行程序将允许攻击者快速获得目标主机的会话。</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">Attacks-&gt;Web Drive-by-&gt;Scripted Web Delivery<br/></span></li></ul>
		<h2 class="cs868C439D">
			<a name="resource-kit"><span class="csB2D98684">Resource Kit</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Resource Kit</span><span class="cs9C1B1871">是</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">改变</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">在其工作流程中使用的</span><span class="cs8926E06">HTA</span><span class="cs9C1B1871">，</span><span class="cs8926E06">Powershell</span><span class="cs9C1B1871">，</span><span class="cs8926E06">Python</span><span class="cs9C1B1871">，</span><span class="cs8926E06">VBA</span><span class="cs9C1B1871">和</span><span class="cs8926E06">VBS</span><span class="cs9C1B1871">脚本模板的方法。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">下载方法</span><span class="cs8926E06">Help-&gt;Arsenal</span><span class="cs9C1B1871">下载</span><span class="cs8926E06">Resource Kit</span><span class="cs9C1B1871">，这个同样需要授权，下载完成后将</span><span class="cs8926E06">resources.cna</span><span class="cs9C1B1871">脚本加载使用，然后按照生成可执行文件的步骤操作即可。</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/4.Weaponization/weaponzation_files/image1.png" width="560" height="333" alt="" style="border-width:0px;" /> <img src="安全工具/CobaltStrike/CobaltStrike4.0/4.Weaponization/weaponzation_files/image2.png" width="560" height="258" alt="" style="border-width:0px;" /> <img src="安全工具/CobaltStrike/CobaltStrike4.0/4.Weaponization/weaponzation_files/image3.png" width="560" height="320" alt="" style="border-width:0px;" /> <img src="安全工具/CobaltStrike/CobaltStrike4.0/4.Weaponization/weaponzation_files/image4.png" width="560" height="310" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="用户驱动攻击"><span class="cs83F14626">用户驱动攻击</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在用户驱动攻击中包括了</span><span class="cs8926E06">HTML</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Java Signed Applet</span><span class="cs9C1B1871">攻击、</span><span class="cs8926E06">office</span><span class="cs9C1B1871">宏、</span><span class="cs8926E06">windows</span><span class="cs9C1B1871">木马程序，这些攻击方式可以根据实际灵活变更，比如通过</span><span class="cs8926E06">Resource Kit</span><span class="cs9C1B1871">可以修改</span><span class="cs8926E06">HTML</span><span class="cs9C1B1871">以及</span><span class="cs8926E06">office</span><span class="cs9C1B1871">宏，通过</span><span class="cs8926E06">Applet Kit</span><span class="cs9C1B1871">修改</span><span class="cs8926E06">Java Signed Applet</span><span class="cs9C1B1871">攻击，通过</span><span class="cs8926E06">Artifact Kit</span><span class="cs9C1B1871">修改</span><span class="cs8926E06">windows</span><span class="cs9C1B1871">木马等。</span></p><h2 class="cs868C439D">
			<a name="msf运行32位beacon"><span class="csB2D98684">msf</span><span class="cs83F14626">运行</span><span class="csB2D98684">32</span><span class="cs83F14626">位</span><span class="csB2D98684">Beacon</span></a></h2>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">在</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">中新建一个监听</span></li><li class="cs24C36B3"><span class="cs9C1B1871">在</span><span class="cs8926E06">msf</span><span class="cs9C1B1871">中选择一个客户端攻击木马</span></li><li class="cs24C36B3"><span class="cs9C1B1871">将</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">设置为</span><span class="cs8926E06">http</span><span class="cs9C1B1871">或者</span><span class="cs8926E06">https</span></li><li class="cs24C36B3"><span class="cs9C1B1871">将</span><span class="cs8926E06">LHOST</span><span class="cs9C1B1871">和</span><span class="cs8926E06">RHOST</span><span class="cs9C1B1871">设置为</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">监听地址及端口</span></li><li class="cs24C36B3"><span class="cs9C1B1871">设置</span><span class="cs8926E06">DisablePayloadHeadler</span><span class="cs9C1B1871">为</span><span class="cs8926E06">True</span></li><li class="cs24C36B3"><span class="cs9C1B1871">设置</span><span class="cs8926E06">PrependMigrate</span><span class="cs9C1B1871">为</span><span class="cs8926E06">TRUE</span></li><li class="cs24C36B3"><span class="cs9C1B1871">生成一个木马，使用</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">加载生成一个</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">，目标及其访问后获得</span><span class="cs8926E06">Beacon<br/><br/> <br/><br/><br/></span></li></ul>
		<h2 class="cs868C439D">
			<a name="自定义武器化"><span class="cs83F14626">自定义武器化</span></a></h2>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">Attacks-&gt;Packages-&gt;Windows EXE(S) </span><span class="cs9C1B1871">生成一个现成的木马</span></li><li class="cs24C36B3"><span class="cs8926E06">Attacks-&gt;Packages-&gt;Payload Generator </span><span class="cs9C1B1871">生成一个</span><span class="cs8926E06">payload</span></li><li class="cs24C36B3"><span class="cs9C1B1871">使用第三方</span><span class="cs8926E06">artifact</span><span class="cs9C1B1871">或者工具</span></li><li class="cs24C36B3"><span class="cs9C1B1871">自己写脚本集成到</span><span class="cs8926E06">Cobalt Strike</span></li></ul>
		<h2 class="cs868C439D">
			<a name="行为检测与绕过"><span class="cs83F14626">行为检测与绕过</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">回到攻击链，我们现在讨论的目标是代码执行</span><span class="cs8926E06"> <img src="安全工具/CobaltStrike/CobaltStrike4.0/4.Weaponization/weaponzation_files/image5.png" width="560" height="413" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">如下图所示，四个环节都可能被检测到：</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">在攻击链的第一部分依旧是</span><span class="cs8926E06">artifact</span><span class="cs9C1B1871">这样一个包含了</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">的全功能被控制程序，函数或者一些特征码会被检测到；</span></li><li class="cs24C36B3"><span class="cs9C1B1871">一旦我们的</span><span class="cs8926E06">artifact</span><span class="cs9C1B1871">在目标机器上运行，那我们就会看到一些行为，比如我们刚好有个</span><span class="cs8926E06">office</span><span class="cs9C1B1871">宏运行在一个临时的进程中，并且将我们的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">注入到进程中，这个时候会产生的行为可能就会被检测到，比如启动一个程序、注入一个新的或者已经存在的进程、写文件；</span></li><li class="cs24C36B3"><span class="cs9C1B1871">我们成功注入进程后，我们所有的操作会在内存中进行，根据</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">占据内存和线程的属性也可能会被检测到；</span></li><li class="cs24C36B3"><span class="cs9C1B1871">进程行为也会被检测，比如</span><span class="cs8926E06">explorer.exe,notepad.exe</span><span class="cs9C1B1871">等进程做出了一些非常规的动作，或者还有些常见的被滥用应用程序检测。</span><span class="cs8926E06"><br/><br/></span><span class="cs9C1B1871">那么针对以上可能被检测到的点我们应该如何绕过</span></li><li class="cs24C36B3"><span class="cs9C1B1871">对于函数或者特征码以及注入进程的操作一般使用混淆来绕过</span></li><li class="cs24C36B3"><span class="cs9C1B1871">对于写文件、进程行为检测一般采用规避的方式</span></li><li class="cs24C36B3"><span class="cs9C1B1871">对于启动程序应该采用欺骗父进程的方式</span></li><li class="cs24C36B3"><span class="cs9C1B1871">此外对于</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">检测同样应该采用规避的方式</span></li></ul>
		<h2 class="cs868C439D">
			<a name="内存检测及绕过"><span class="cs83F14626">内存检测及绕过</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">检测方式一般如下：</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">查找与内存映射文件没有关联的线程开始地址。</span></li><li class="cs24C36B3"><span class="cs9C1B1871">内存权限，读写权限是攻击工具中常见的模式，有时候内存区域的执行权限与内存映射文件无关，都会被严格检测。</span></li><li class="cs24C36B3"><span class="cs9C1B1871">内存内容也会被检测，比如一个</span><span class="cs8926E06">PE</span><span class="cs9C1B1871">文件或者与常见技术有关系的特征码等。</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">绕过方式</span><span class="cs8926E06">:</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">修改</span><span class="cs8926E06">artifact </span><span class="cs9C1B1871">启动地址</span></li><li class="cs24C36B3"><span class="cs8926E06">artifact</span><span class="cs9C1B1871">避免使用读写执行权限</span></li><li class="cs24C36B3"><span class="cs9C1B1871">避免使用</span><span class="cs8926E06">stagers</span></li><li class="cs24C36B3"><span class="cs9C1B1871">在</span><span class="cs8926E06">Malleable C2</span><span class="cs9C1B1871">的配置文件中设置</span><span class="cs8926E06">userwx</span><span class="cs9C1B1871">为</span><span class="cs8926E06">false</span></li><li class="cs24C36B3"><span class="cs9C1B1871">开启</span><span class="cs8926E06">stomping</span><span class="cs9C1B1871">模块</span></li><li class="cs24C36B3"><span class="cs9C1B1871">设置</span><span class="cs8926E06">image_size_x86</span><span class="cs9C1B1871">以及</span><span class="cs8926E06">image_size_x64</span></li><li class="cs24C36B3"><span class="cs9C1B1871">使用</span><span class="cs8926E06">prepend</span><span class="cs9C1B1871">实现</span><span class="cs8926E06">PE</span><span class="cs9C1B1871">在内存中的偏移量</span></li><li class="cs24C36B3"><span class="cs9C1B1871">设置</span><span class="cs8926E06">obfuscate</span><span class="cs9C1B1871">为</span><span class="cs8926E06">true</span></li><li class="cs24C36B3"><span class="cs9C1B1871">设置</span><span class="cs8926E06">cleanup</span><span class="cs9C1B1871">为</span><span class="cs8926E06">true</span></li><li class="cs24C36B3"><span class="cs9C1B1871">使用</span><span class="cs8926E06">strrep</span><span class="cs9C1B1871">来编辑字符串</span></li><li class="cs24C36B3"><span class="cs9C1B1871">设置</span><span class="cs8926E06">sleep_mask</span><span class="cs9C1B1871">为</span><span class="cs8926E06">true</span></li></ul>
		<h1 class="csAD577193">
			<a name="artifact行为一览表"><span class="csDE05BCC">Artifact</span><span class="csECDA2D3">行为一览表</span></a></h1>
		<p class="cs40DD2BC9"><span class="cs8926E06">&nbsp;</span></p></body>
</html>
