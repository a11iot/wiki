<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>
		</title>
		<style type="text/css">
			.csAD577193{text-align:left;text-indent:0pt;margin:24pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.csDE05BCC{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:16pt;font-weight:bold;font-style:normal;}
			.cs868C439D{text-align:left;text-indent:0pt;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid}
			.cs83F14626{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:14pt;font-weight:bold;font-style:normal;}
			.cs40DD2BC9{text-align:left;text-indent:0pt;margin:9pt 0pt 9pt 0pt}
			.cs9C1B1871{color:#000000;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:normal;font-style:normal;}
			.cs8926E06{color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal;}
			.csB2D98684{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal;}
			.csD1E291E2{color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal;}
			.csD6CA00D2{color:#4F81BD;background-color:transparent;font-family:Microsoft YaHei UI;font-size:12pt;font-weight:bold;font-style:normal;}
			.cs24C36B3{text-align:left;margin:0pt 0pt 10pt 0pt;list-style-type:disc;color:#000000;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:normal;font-style:normal}
			.cs177011F4{text-align:left;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid;list-style-type:disc;color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:12pt;font-weight:bold;font-style:normal}
			.cs9FB05234{color:#000000;background-color:transparent;font-family:Consolas;font-size:11pt;font-weight:normal;font-style:normal;}
			.cs4FFB3A98{text-align:left;margin:10pt 0pt 0pt 0pt;page-break-after:avoid;page-break-inside:avoid;list-style-type:disc;color:#4F81BD;background-color:transparent;font-family:Calibri;font-size:14pt;font-weight:bold;font-style:normal}
		</style>
	</head>
	<body>
		<h1 class="csAD577193">
			<a name="operations"><span class="csDE05BCC">Operations</span></a></h1>
		<h2 class="cs868C439D">
			<a name="从红队角度看渗透难点"><span class="cs83F14626">从红队角度看渗透难点</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在一个红队的典型渗透过程中，一般来说按照顺序有四个目标，分别是：初始访问、代码执行、获取权限、后渗透。</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/1.Opearations/operations_files/image0.png" width="560" height="356" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">在上边流程图中，首先给目标用户发送一份钓鱼邮件，这时候需要考虑绕过防病毒、沙箱技术、反垃圾邮件网关等安全防护设备，这些设备往往会动态监测附件中的恶意程序，此外，</span><span class="cs8926E06">SPF</span><span class="cs9C1B1871">、</span><span class="cs8926E06">DKIM</span><span class="cs9C1B1871">、</span><span class="cs8926E06">Dmarc</span><span class="cs9C1B1871">更是让人感觉越来越头疼。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">当目标用户运行附件中的恶意程序时，终端防护中心可能就要动态的检测判断附件是否为恶意程序，比如附件是一个</span><span class="cs8926E06">Word</span><span class="cs9C1B1871">文档，用户打开以后运行了文档中包含的宏，该宏会产生将</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">注入子进程的操作，这个时候，杀毒软件就会发现异常，并强制终止此操作。</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">获取权限意味着要面对各种防火墙或者代理，甚至发现的代理指向了一个无效的域。即使穿透了代理，仍然需要想办法绕过各种流量安全监控，也许会暂时获得一个</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">，但是安全监控会通过溯源找到子进程，并公布恶意程序形成一个有效的威胁情报广播，导致所有努力付之东流。</span><span class="cs8926E06"> </span><span class="cs9C1B1871">下图是一个攻击链：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/1.Opearations/operations_files/image1.png" width="560" height="431" alt="" style="border-width:0px;" /></span></p><h2 class="cs868C439D">
			<a name="课程设计"><span class="cs83F14626">课程设计</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">第一课到第三课，主要解决以上提到的问题，如何获取目标权限。第一课重点讨论如何规划自己的</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">，第二课主要通过配置监听器来了解</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">的细节，第三课主要讲</span><span class="cs8926E06">malleable c2</span><span class="cs9C1B1871">。第四课和第五课主要从武器化的角度讨论初始访问和代码执行的问题，介绍如何根据目标情况选择合适的</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">。第六课到第九课主要关注后渗透的内容。</span></p><h2 class="cs868C439D">
			<a name="cobalt-strike介绍"><span class="csB2D98684">Cobalt Strike</span><span class="cs83F14626">介绍</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">是针对协作模型达到分布式操作</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">，主要用于团队作战，能让多个攻击者同时连接到</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">，共享攻击资源、目标信息以及</span><span class="cs8926E06">session</span><span class="cs9C1B1871">，提供了选择性和灵活性，通过课程将帮助你了解每一个选项的意义，以便可以正确的使用工具。</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/1.Opearations/operations_files/image2.png" width="560" height="394" alt="" style="border-width:0px;" /> </span><span class="cs9C1B1871">要达到获取权限的目的，首先我们要了解工具特性和作用，这样在使用的时候我们就可以灵活的使用或者优化；其次要评估和理解我们面对的防御；第三是找到最优的方式来解决问题，绕过防御。按照这样的思路，也可以让蓝队的流程和整体的安全得到优化。</span><span class="cs8926E06"><br/>Cobalt Strike</span><span class="cs9C1B1871">的任务是缩小渗透测试工具和高级软件之间的差距，目标是推动安全测试，通过这款软件，不仅可以达到日常练兵模拟，以攻击者思维来规划防护，攻防循环，同时可以培养专业安全人员。</span></p><h3 class="cs868C439D">
			<a name="cobalt-strike特性"><span class="csD1E291E2">Cobalt Strike</span><span class="csD6CA00D2">特性</span></a></h3>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">：</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">是</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">为高级攻击者建模的</span><span class="cs8926E06">Payload</span><span class="cs9C1B1871">。使用</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">通过</span><span class="cs8926E06">HTTP</span><span class="cs9C1B1871">，</span><span class="cs8926E06">HTTPS</span><span class="cs9C1B1871">或</span><span class="cs8926E06">DNS</span><span class="cs9C1B1871">出口网络。而且</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">非常灵活，支持异步和交互式通信。异步通信既低又慢。</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">将通讯本地，下载任务，然后进入睡眠状态。交互式通信实时发生。</span></li><li class="cs24C36B3"><span class="cs8926E06">malleable c2</span><span class="cs9C1B1871">：</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">最有用的功能之一就是可以修改</span><span class="cs8926E06">Beacon payload</span><span class="cs9C1B1871">的行为。通过修改框架内的各种默认值，操作者可以修改</span><span class="cs8926E06">Beacon</span><span class="cs9C1B1871">的内存占用，更改其检入的频率，甚至可以修改</span><span class="cs8926E06"> Beacon</span><span class="cs9C1B1871">的网络流量。所有这些功能都是由</span><span class="cs8926E06">Malleable C2</span><span class="cs9C1B1871">配置文件控制，该配置文件在启动团队服务器时选择。</span></li><li class="cs24C36B3"><span class="cs8926E06">Aggressor Script</span><span class="cs9C1B1871">：加载各种脚本，对客户端可修改可扩展，可以响应事件，横向移动自动化，更改产品生成可执行文件和</span><span class="cs8926E06">dll</span><span class="cs9C1B1871">的方式，甚至可以使用和生成</span><span class="cs8926E06">powershell</span><span class="cs9C1B1871">脚本。</span></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs177011F4"><a name="启动cobalt-strike"><span class="csD6CA00D2">启动</span><span class="csD1E291E2">Cobalt Strike</span></a></li><li class="cs24C36B3"><span class="cs9C1B1871">在</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">的文件夹下包含了一个名为</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">的脚本来启动服务。</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">./ teamserver &lt;ip address&gt; &lt;password&gt; [profile]</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/1.Opearations/operations_files/image3.png" width="560" height="279" alt="" style="border-width:0px;" /> <img src="安全工具/CobaltStrike/CobaltStrike4.0/1.Opearations/operations_files/image4.png" width="560" height="278" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">通过执行文件夹下的</span><span class="cs8926E06">cobaltstrike</span><span class="cs9C1B1871">脚本启动客户端，</span><span class="cs8926E06"><br/></span><span class="cs9FB05234">./cobaltstrike</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/1.Opearations/operations_files/image5.png" width="560" height="240" alt="" style="border-width:0px;" /></span></li><li class="cs4FFB3A98"><a name="客户端连接多个teamserver"><span class="cs83F14626">客户端连接多个</span><span class="csB2D98684">Teamserver</span></a></li><li class="cs24C36B3"><span class="cs9C1B1871">连接多个</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">的好处除了便于操作外，更重要的是可以在多个</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">之间传递权限，比如使用临时服务器做横向移动，获取到了其他权限，但是第一台服务器存在比较高的安全风险，这样就可以有多个</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">来专门用于后渗透，即使第一台机器异常，不影响权限维持。</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/1.Opearations/operations_files/image6.png" width="560" height="357" alt="" style="border-width:0px;" /><br/></span><span class="cs9C1B1871">具体连接多个</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">的方法如下图：</span><span class="cs8926E06"><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/1.Opearations/operations_files/image7.png" width="560" height="331" alt="" style="border-width:0px;" /><br/><img src="安全工具/CobaltStrike/CobaltStrike4.0/1.Opearations/operations_files/image8.png" width="560" height="298" alt="" style="border-width:0px;" /></span></li><li class="cs4FFB3A98"><a name="teamserver模型"><span class="csB2D98684">Teamserver</span><span class="cs83F14626">模型</span></a></li></ul>
		<ul style="margin-top:0;margin-bottom:0;">
			<li class="cs24C36B3"><span class="cs9C1B1871">临时服务器</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">发起对主机攻击以及</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">反弹</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">提权，完成权限维持</span></li><li class="cs24C36B3"><span class="cs9C1B1871">长期服务器</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">低频数据通讯，以持续权限</span><span class="cs8926E06"><br/></span><span class="cs9C1B1871">根据实际需求传递访问权限用于后渗透</span></li><li class="cs24C36B3"><span class="cs9C1B1871">后渗透服务器</span></li></ul>
		<h2 class="cs868C439D">
			<a name="teamserver角色"><span class="csB2D98684">Teamserver</span><span class="cs83F14626">角色</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">在多目标网络的情况下，</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">建议分为目标角色和管理角色。</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">目标角色负责特定网络的目标，突破、后渗透、横向移动、维护当前</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">；</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">管理角色负责管理所有的网络访问权限，突破并接受目标角色的访问，如果有目标角色被删除权限或者需要其他访问权限，管理角色就需要向目标角色提供许可，其次管理角色需要维护全局</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">。</span></p><h2 class="cs868C439D">
			<a name="团队角色"><span class="cs83F14626">团队角色</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs9C1B1871">建议将团队按照角色进行分工</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">一个团队致力于获取访问权限，目的是扩大立足点，这个团队需要考虑武器化、初始访问和横向移动；</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">专注于目标的后渗透组，他们通过文件系统、收集键盘记录、屏幕截图，获得拿下目标的机会；</span></p><p class="cs40DD2BC9"><span class="cs9C1B1871">本地访问管理角色，用户管理和保护</span><span class="cs8926E06">shell</span><span class="cs9C1B1871">，根据需要搭建</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">，并交接</span><span class="cs8926E06">session</span><span class="cs9C1B1871">。</span></p><h2 class="cs868C439D">
			<a name="日志"><span class="cs83F14626">日志</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">可以通过时间或者</span><span class="cs8926E06">IP</span><span class="cs9C1B1871">排序，所有的操作和</span><span class="cs8926E06">payload</span><span class="cs9C1B1871">都会被保存到日志中，</span><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">的</span><span class="cs8926E06">/logs</span><span class="cs9C1B1871">文件夹下保存了相关日志。</span></p><h2 class="cs868C439D">
			<a name="报告"><span class="cs83F14626">报告</span></a></h2>
		<p class="cs40DD2BC9"><span class="cs8926E06">Cobalt Strike</span><span class="cs9C1B1871">可以将多个</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">的数据同步到同一个时间合并到一个日志模型中，这样就可以在不同的</span><span class="cs8926E06">Teamserver</span><span class="cs9C1B1871">上得到一个准确的时间排序。</span></p></body>
</html>
